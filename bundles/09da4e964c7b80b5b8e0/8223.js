"use strict";(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[8223],{"./src/components/views/rooms/wysiwyg_composer/EditWysiwygComposer.tsx":(e,t,s)=>{s.r(t),s.d(t,{default:()=>S});var n=s("./node_modules/@babel/runtime/helpers/esm/extends.js"),o=s("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),r=s("./node_modules/react/index.js"),i=s("./node_modules/classnames/index.js"),a=s.n(i),c=s("./src/components/views/rooms/wysiwyg_composer/components/WysiwygComposer.tsx"),l=s("./src/languageHandler.tsx"),m=s("./src/components/views/elements/AccessibleButton.tsx");function d({onCancelClick:e,onSaveClick:t,isSaveDisabled:s=!1}){return r.createElement("div",{className:"mx_EditWysiwygComposer_buttons"},r.createElement(m.A,{kind:"secondary",onClick:e},(0,l._t)("action|cancel")),r.createElement(m.A,{kind:"primary",onClick:t,disabled:s},(0,l._t)("action|save")))}var u=s("./src/dispatcher/dispatcher.ts"),p=s("./src/dispatcher/actions.ts"),g=s("./src/contexts/RoomContext.ts"),y=s("./src/hooks/useDispatcher.ts"),f=s("./src/components/views/rooms/wysiwyg_composer/hooks/utils.ts"),v=s("./src/dispatcher/payloads/ComposerInsertPayload.ts"),b=s("./src/components/views/rooms/wysiwyg_composer/utils/selection.ts"),w=s("./src/components/views/rooms/wysiwyg_composer/ComposerContext.ts");var h=s("./src/contexts/MatrixClientContext.tsx"),_=s("./src/components/views/rooms/wysiwyg_composer/utils/editing.ts"),C=s("./src/components/views/rooms/wysiwyg_composer/utils/message.ts");var E=s("./src/editor/deserialize.ts"),x=s("./src/editor/parts.ts"),T=s("./src/settings/SettingsStore.ts");function k(e){const t=(0,g.mP)(),s=(0,h.nH)();return(0,r.useMemo)((()=>{if(e&&t.room&&s)return function(e,t,s){const n=new x.dK(t,s);let o=[];if(e.hasEditorState()){const t=e.getSerializedParts();null!==t&&(o=t.map((e=>n.deserializePart(e))))}else{if("org.matrix.custom.html"===e.getEvent().getContent().format)return function(e){var t;return(null===(t=e.getEvent().getContent().formatted_body)||void 0===t?void 0:t.replace(/<mx-reply>.*<\/mx-reply>/,""))||""}(e);o=(0,E.wj)(e.getEvent(),n,{shouldEscape:T.A.getValue("MessageComposerInput.useMarkdown")})}return o.reduce(((e,t)=>e+(null==t?void 0:t.text)),"")}(e,t.room,s)}),[e,t,s])}const A=["editorStateTransfer","className"],P=(0,r.forwardRef)((function({disabled:e=!1,composerFunctions:t},s){return function(e,t,s){const n=(0,g.mP)(),o=(0,w.Hx)(),i=(0,r.useRef)(null),a=(0,r.useCallback)((r=>{var a;if(e||!t.current)return;const c=null!==(a=r.context)&&void 0!==a?a:g.Ae.Room;switch(r.action){case p.r.FocusEditMessageComposer:(0,f.Hj)(t,c,n,i);break;case p.r.ComposerInsert:if(r.timelineRenderingType!==n.timelineRenderingType)break;if(r.composerType!==v.D.Edit)break;r.text&&(0,b.td)(o.selection).then((()=>s.insertText(r.text)))}}),[e,t,s,i,n,o]);(0,y.F)(u.Ay,a)}(e,s,t),null}));function S(e){let{editorStateTransfer:t,className:s}=e,i=(0,o.A)(e,A);const l=(0,r.useRef)((0,w.AP)({editorStateTransfer:t})),m=k(t),u=!t||void 0!==m,{editMessage:p,endEditing:y,onChange:f,isSaveDisabled:v}=function(e,t){const s=(0,g.mP)(),n=(0,h.nH)(),[o,i]=(0,r.useState)(!0),[a,c]=(0,r.useState)(t);return{onChange:(0,r.useCallback)((e=>{c(e),i((s=>s&&e===t))}),[t]),editMessage:(0,r.useCallback)((async()=>{if(void 0!==n&&void 0!==a)return(0,C.editMessage)(a,{roomContext:s,mxClient:n,editorStateTransfer:e})}),[a,s,n,e]),endEditing:(0,r.useCallback)((()=>(0,_.w)(s)),[s]),isSaveDisabled:o}}(t,m);return u?r.createElement(w.EW.Provider,{value:l.current},r.createElement(c.k,(0,n.A)({className:a()("mx_EditWysiwygComposer",s),initialContent:m,onChange:f,onSend:p},i),((e,t)=>r.createElement(r.Fragment,null,r.createElement(P,{disabled:i.disabled,ref:e,composerFunctions:t}),r.createElement(d,{onCancelClick:y,onSaveClick:p,isSaveDisabled:v}))))):r.createElement(r.Fragment,null)}},"./src/components/views/rooms/wysiwyg_composer/utils/message.ts":(e,t,s)=>{s.r(t),s.d(t,{editMessage:()=>M,sendMessage:()=>S});var n=s("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),o=s("./node_modules/matrix-js-sdk/src/matrix.ts"),r=s("./src/PosthogAnalytics.ts"),i=s("./src/settings/SettingsStore.ts"),a=s("./src/sendTimePerformanceMetrics.ts"),c=s("./src/utils/local-room.ts"),l=s("./src/effects/index.ts"),m=s("./src/effects/utils.ts"),d=s("./src/dispatcher/dispatcher.ts"),u=s("./src/components/views/dialogs/ConfirmRedactDialog.tsx"),p=s("./src/components/views/rooms/wysiwyg_composer/utils/editing.ts"),g=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),y=s("./node_modules/@vector-im/matrix-wysiwyg/dist/matrix-wysiwyg.js"),f=s("./src/utils/permalinks/Permalinks.ts"),v=s("./src/utils/Reply.ts"),b=s("./src/Typeguards.ts");function w(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function h(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?w(Object(s),!0).forEach((function(t){(0,g.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):w(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const _="/me ";const C=e=>e instanceof o.MatrixEvent;async function E(e,t,{relation:s,replyToEvent:n,permalinkCreator:r,includeReplyLegacyFallback:a=!0,editedEvent:c}){const l=C(c),m=l?Boolean(c.replyEventId):C(n),d=l&&m,u=e.startsWith(_);u&&(e=e.slice(_.length)),e.startsWith("//")&&(e=e.slice(1));const p=t?await(0,y.richToPlain)(e,!1):function(e){const t=(new DOMParser).parseFromString(e,"text/html");return Array.from(t.querySelectorAll("a[data-mention-type]")).forEach((e=>{switch(e.getAttribute("data-mention-type")){case"at-room":e.replaceWith("@room");break;case"user":{const t=e.innerHTML;e.replaceWith(t);break}case"room":{const t=e.getAttribute("href");if(null===t)break;const s=(0,f.$N)(t);(0,b.P)(s)&&(0,b.P)(s.roomIdOrAlias)&&e.replaceWith(s.roomIdOrAlias);break}}})),t.body.innerHTML}(e),g=d&&function(e){const t=e.getContent().body;if("string"!=typeof t)return"";const s=t.split("\n").map((e=>e.trim()));return s.length>2&&s[0].startsWith("> ")&&0===s[1].length?`${s[0]}\n\n`:""}(c)||"",w=d&&function(e){const t=e.getContent().formatted_body;if(!t)return"";const s=(new DOMParser).parseFromString(t,"text/html").body.querySelector("mx-reply");return s&&s.outerHTML||""}(c)||"",E={msgtype:u?o.MsgType.Emote:o.MsgType.Text,body:l?`${g} * ${p}`:p},x=i.A.getValue("MessageComposerInput.useMarkdown"),T=t?e:x?await(0,y.plainToRich)(e,!0):null;T&&(E.format="org.matrix.custom.html",E.formatted_body=l?`${w} * ${T}`:T),l&&(E["m.new_content"]={msgtype:E.msgtype,body:p},T&&(E["m.new_content"].format="org.matrix.custom.html",E["m.new_content"].formatted_body=T));return function(e,t){t&&(e["m.relates_to"]=h(h({},e["m.relates_to"]||{}),t))}(E,l?h(h({},s),{},{rel_type:"m.replace",event_id:c.getId()}):s),!l&&n&&r&&(0,v.fh)(E,n,{permalinkCreator:r,includeLegacyFallback:a}),E}var x=s("./src/SlashCommands.tsx"),T=s("./src/editor/commands.tsx"),k=s("./src/dispatcher/actions.ts"),A=s("./src/components/views/rooms/SendMessageComposer.tsx");const P=["roomContext","mxClient"];async function S(e,t,s){var u;let{roomContext:p,mxClient:g}=s,y=(0,n.A)(s,P);const{relation:f,replyToEvent:b,permalinkCreator:w}=y,{room:h}=p,C=null==h?void 0:h.roomId;if(!C)return;const S={eventName:"Composer",isEditing:!1,messageType:"Text",isReply:Boolean(b),inThread:(null==f?void 0:f.rel_type)===o.THREAD_RELATION_TYPE.name};r.Vo.instance.trackEvent(S);let M=null;if(e.startsWith("/")&&!e.startsWith("//")&&!e.startsWith(_)){const{cmd:t,args:s}=(0,x.OE)(e);if(t){const e=(null==f?void 0:f.rel_type)===o.THREAD_RELATION_TYPE.name?null==f?void 0:f.event_id:null;let n;if([M,n]=await(0,T.m8)(g,t,s,C,null!=e?e:null),!n)return;if(!M||t.category!==x.ge.messages&&t.category!==x.ge.effects)return;var O,R;(0,A.gV)(M,f),b&&(0,v.fh)(M,b,{permalinkCreator:w,includeLegacyFallback:null===(O=null===(R=M.msgtype)||void 0===R?void 0:R.startsWith("m."))||void 0===O||O})}else{const t=await(0,T.d8)(e);if(d.Ay.dispatch({action:k.r.FocusAComposer,context:p.timelineRenderingType}),!t)return}}if(null!==(u=M)&&void 0!==u||(M=await E(e,t,y)),!M.body.trim())return;i.A.getValue("Performance.addSendMessageTimingMetadata")&&(0,a.H)(M);const j=null!=f&&f.event_id&&(null==f?void 0:f.rel_type)===o.THREAD_RELATION_TYPE.name?f.event_id:null,D=(0,c.Y)(C,(e=>g.sendMessage(e,j,M)),g);return b&&d.Ay.dispatch({action:"reply_to_event",event:null,context:p.timelineRenderingType}),d.Ay.dispatch({action:"message_sent"}),l.y.forEach((e=>{if(M&&(0,m._)(M,e.emojis)){(null==f?void 0:f.rel_type)!==o.THREAD_RELATION_TYPE.name&&d.Ay.dispatch({action:`effects.${e.command}`})}})),i.A.getValue("Performance.addSendMessageTimingMetadata")&&D.then((e=>{(0,a._)(g,C,e.event_id)})),i.A.getValue("scrollToBottomOnMessageSent")&&d.Ay.dispatch({action:"scroll_to_bottom",timelineRenderingType:p.timelineRenderingType}),D}async function M(e,{roomContext:t,mxClient:s,editorStateTransfer:n}){const o=n.getEvent();r.Vo.instance.trackEvent({eventName:"Composer",isEditing:!0,messageType:"Text",inThread:Boolean(null==o?void 0:o.getThread()),isReply:Boolean(o.replyEventId)});const i=await E(e,!0,{editedEvent:o}),a=i["m.new_content"];if(""===(null==a?void 0:a.body))return(0,p.r)(s,n),void(0,u.Q)({mxEvent:o,onCloseDialog:()=>{(0,p.w)(t)}});let c;const l=o.getRoomId();if(function(e,t){const s=t.getEvent().getContent();return s.msgtype!==e.msgtype||s.body!==e.body||s.format!==e.format||s.formatted_body!==e.formatted_body}(a,n)&&l){(0,p.r)(s,n);const e=n.getEvent().threadRootId||null;c=s.sendMessage(l,e,i),d.Ay.dispatch({action:"message_sent"})}return(0,p.w)(t),c}}}]);
//# sourceMappingURL=8223.js.map