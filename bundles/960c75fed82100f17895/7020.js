"use strict";(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[7020],{"./src/components/views/auth/LoginWithQR.tsx":(e,t,n)=>{n.r(t),n.d(t,{LoginWithQRFailureReason:()=>b,default:()=>x});var i=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),o=n("./node_modules/react/index.js"),s=n("./node_modules/matrix-js-sdk/src/rendezvous/index.ts"),r=n("./node_modules/matrix-js-sdk/src/logger.ts"),a=n("./src/components/views/auth/LoginWithQR-types.ts"),c=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/chevron-left.js"),l=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/check-circle-solid.js"),d=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/error.js"),_=n("./node_modules/@vector-im/compound-web/dist/components/Typography/Text.js"),h=n("./node_modules/@vector-im/compound-web/dist/components/Typography/Heading.js"),u=n("./node_modules/@vector-im/compound-web/dist/components/Form/Controls/MFA/MFA.js"),m=n("./node_modules/classnames/index.js"),p=n.n(m),g=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/qr-code.js"),v=n("./src/languageHandler.tsx"),E=n("./src/components/views/elements/AccessibleButton.tsx"),k=n("./src/components/views/elements/QRCode.tsx"),w=n("./src/components/views/elements/Spinner.tsx"),C=n("./src/SdkConfig.ts"),f=n("./src/components/structures/ErrorMessage.tsx");class R extends o.Component{constructor(...e){super(...e),(0,i.A)(this,"checkCodeInput",(0,o.createRef)()),(0,i.A)(this,"handleClick",(e=>async t=>{var n;t.preventDefault(),await this.props.onClick(e,e===a.HY.Approve?null===(n=this.checkCodeInput.current)||void 0===n?void 0:n.value:void 0)})),(0,i.A)(this,"cancelButton",(()=>o.createElement(E.A,{kind:"primary_outline",onClick:this.handleClick(a.HY.Cancel)},(0,v._t)("action|cancel")))),(0,i.A)(this,"simpleSpinner",(e=>o.createElement("div",{className:"mx_LoginWithQR_spinner"},o.createElement("div",null,o.createElement(w.A,null),e&&o.createElement("p",null,e)))))}render(){let e,t,n=!0,i="";switch(this.props.phase){case a.a0.Error:{n=!1;let t,r,a=d.A,c=!1;switch(this.props.failureReason){case s.n$.UnsupportedProtocol:t=(0,v._t)("auth|qr_code_login|error_unsupported_protocol_title"),r=(0,v._t)("auth|qr_code_login|error_unsupported_protocol");break;case s.n$.UserCancelled:t=(0,v._t)("auth|qr_code_login|error_user_cancelled_title"),r=(0,v._t)("auth|qr_code_login|error_user_cancelled");break;case s.n$.AuthorizationExpired:case s.fF.Expired:t=(0,v._t)("auth|qr_code_login|error_expired_title"),r=(0,v._t)("auth|qr_code_login|error_expired");break;case s.fF.InsecureChannelDetected:t=(0,v._t)("auth|qr_code_login|error_insecure_channel_detected_title"),r=o.createElement(o.Fragment,null,(0,v._t)("auth|qr_code_login|error_insecure_channel_detected"),o.createElement(_.E,{as:"h2",size:"lg",weight:"semibold"},(0,v._t)("auth|qr_code_login|error_insecure_channel_detected_instructions")),o.createElement("ol",null,o.createElement("li",null,(0,v._t)("auth|qr_code_login|error_insecure_channel_detected_instructions_1")),o.createElement("li",null,(0,v._t)("auth|qr_code_login|error_insecure_channel_detected_instructions_2")),o.createElement("li",null,(0,v._t)("auth|qr_code_login|error_insecure_channel_detected_instructions_3"))));break;case s.fF.OtherDeviceAlreadySignedIn:c=!0,a=l.A,t=(0,v._t)("auth|qr_code_login|error_other_device_already_signed_in_title"),r=(0,v._t)("auth|qr_code_login|error_other_device_already_signed_in");break;case s.fF.UserDeclined:t=(0,v._t)("auth|qr_code_login|error_user_declined_title"),r=(0,v._t)("auth|qr_code_login|error_user_declined");break;case b.RateLimited:t=(0,v._t)("error|something_went_wrong"),r=(0,v._t)("auth|qr_code_login|error_rate_limited");break;case s.fF.ETagMissing:t=(0,v._t)("error|something_went_wrong"),r=(0,v._t)("auth|qr_code_login|error_etag_missing");break;case s.fF.HomeserverLacksSupport:c=null,a=g.A,n=!0,t=(0,v._t)("auth|qr_code_login|unsupported_heading"),r=(0,v._t)("auth|qr_code_login|unsupported_explainer");break;case s.n$.DeviceAlreadyExists:case s.n$.DeviceNotFound:case s.n$.UnexpectedMessageReceived:case s.fF.OtherDeviceNotSignedIn:case s.fF.Unknown:default:t=(0,v._t)("error|something_went_wrong"),r=(0,v._t)("auth|qr_code_login|error_unexpected")}i="mx_LoginWithQR_error",e=o.createElement(o.Fragment,null,o.createElement("div",{className:p()("mx_LoginWithQR_icon",{"mx_LoginWithQR_icon--critical":!1===c,"mx_LoginWithQR_icon--success":!0===c})},o.createElement(a,{width:"32px",height:"32px"})),o.createElement(h.D,{as:"h1",size:"sm",weight:"semibold"},t),"object"==typeof r?r:o.createElement("p",null,r));break}case a.a0.OutOfBandConfirmation:n=!1,e=o.createElement(o.Fragment,null,o.createElement(h.D,{as:"h1",size:"sm",weight:"semibold"},(0,v._t)("auth|qr_code_login|check_code_heading")),o.createElement(_.E,{size:"md"},(0,v._t)("auth|qr_code_login|check_code_explainer")),o.createElement("label",{htmlFor:"mx_LoginWithQR_checkCode"},(0,v._t)("auth|qr_code_login|check_code_input_label")),o.createElement(u.f,{className:"mx_LoginWithQR_checkCode_input mx_no_textinput",ref:this.checkCodeInput,length:2,autoFocus:!0,id:"mx_LoginWithQR_checkCode","data-invalid":this.props.failureReason===b.CheckCodeMismatch||void 0}),o.createElement(f.K,{message:this.props.failureReason===b.CheckCodeMismatch?(0,v._t)("auth|qr_code_login|check_code_mismatch"):null})),t=o.createElement(o.Fragment,null,o.createElement(E.A,{kind:"primary",onClick:this.handleClick(a.HY.Approve)},(0,v._t)("action|continue")),o.createElement(E.A,{kind:"primary_outline",onClick:this.handleClick(a.HY.Decline)},(0,v._t)("action|cancel")));break;case a.a0.ShowingQR:if(this.props.code){const t=this.props.code;e=o.createElement(o.Fragment,null,o.createElement(h.D,{as:"h1",size:"sm",weight:"semibold"},(0,v._t)("auth|qr_code_login|scan_code_instruction")),o.createElement("div",{className:"mx_LoginWithQR_qrWrapper"},o.createElement(k.A,{data:[{data:t,mode:"byte"}],className:"mx_QRCode"})),o.createElement("ol",null,o.createElement("li",null,(0,v._t)("auth|qr_code_login|open_element_other_device",{brand:C.Ay.get().brand})),o.createElement("li",null,(0,v._t)("auth|qr_code_login|select_qr_code",{scanQRCode:o.createElement("strong",null,(0,v._t)("auth|qr_code_login|scan_qr_code"))})),o.createElement("li",null,(0,v._t)("auth|qr_code_login|point_the_camera")),o.createElement("li",null,(0,v._t)("auth|qr_code_login|follow_remaining_instructions"))))}else e=this.simpleSpinner(),t=this.cancelButton();break;case a.a0.Loading:e=this.simpleSpinner();break;case a.a0.WaitingForDevice:e=o.createElement(o.Fragment,null,this.simpleSpinner((0,v._t)("auth|qr_code_login|waiting_for_device")),this.props.userCode?o.createElement("div",null,o.createElement("p",null,(0,v._t)("auth|qr_code_login|security_code")),o.createElement("p",null,(0,v._t)("auth|qr_code_login|security_code_prompt")),o.createElement("p",null,this.props.userCode)):null),t=this.cancelButton();break;case a.a0.Verifying:e=this.simpleSpinner((0,v._t)("auth|qr_code_login|completing_setup"))}return o.createElement("div",{className:p()("mx_LoginWithQR",i)},n?o.createElement("div",{className:"mx_LoginWithQR_heading"},o.createElement(E.A,{className:"mx_LoginWithQR_BackButton",onClick:this.handleClick(a.HY.Back),title:"Back"},o.createElement(c.A,null)),o.createElement("div",{className:"mx_LoginWithQR_breadcrumbs"},(0,v._t)("settings|sessions|title")," / ",(0,v._t)("settings|sessions|sign_in_with_qr"))):null,o.createElement("div",{className:"mx_LoginWithQR_main"},e),o.createElement("div",{className:"mx_LoginWithQR_buttons"},t))}}let b=function(e){return e.RateLimited="rate_limited",e.CheckCodeMismatch="check_code_mismatch",e}({});class x extends o.Component{constructor(e){super(e),(0,i.A)(this,"finished",!1),(0,i.A)(this,"generateAndShowCode",(async()=>{let e;try{var t;const n=null===(t=this.props.client)||void 0===t||null===(t=t.getClientWellKnown())||void 0===t||null===(t=t["io.element.rendezvous"])||void 0===t?void 0:t.server,i=new s._T({onFailure:this.onFailure,client:this.props.client,fallbackRzServer:n});await i.send("");const o=new s.NF(i,void 0,this.onFailure);e=new s.G_(o,!1,this.props.client,this.onFailure),await e.generateCode(),this.setState({phase:a.a0.ShowingQR,rendezvous:e,failureReason:void 0})}catch(e){return r.v.error("Error whilst generating QR code",e),void this.setState({phase:a.a0.Error,failureReason:s.fF.HomeserverLacksSupport})}try{if(this.ourIntent===s.E$.RECIPROCATE_LOGIN_ON_EXISTING_DEVICE){await e.negotiateProtocols();const{verificationUri:t}=await e.deviceAuthorizationGrant();this.setState({phase:a.a0.OutOfBandConfirmation,verificationUri:t})}}catch(t){var n;r.v.error("Error whilst approving login",t),await(null===(n=e)||void 0===n?void 0:n.cancel(t instanceof s.Qd?t.code:s.fF.Unknown))}})),(0,i.A)(this,"approveLogin",(async e=>{var t;if(!(this.state.rendezvous instanceof s.G_))throw this.setState({phase:a.a0.Error,failureReason:s.fF.Unknown}),new Error("Rendezvous not found");if(this.state.lastScannedCode||(null===(t=this.state.rendezvous)||void 0===t?void 0:t.checkCode)===e)try{if(this.ourIntent!==s.E$.RECIPROCATE_LOGIN_ON_EXISTING_DEVICE)throw this.setState({phase:a.a0.Error,failureReason:s.fF.Unknown}),new Error("New device flows around OIDC are not yet implemented");this.setState({phase:a.a0.Loading}),this.state.verificationUri&&window.open(this.state.verificationUri,"_blank"),this.setState({phase:a.a0.WaitingForDevice}),await this.state.rendezvous.shareSecrets(),this.onFinished(!0)}catch(e){r.v.error("Error whilst approving sign in",e),this.setState({phase:a.a0.Error,failureReason:e instanceof s.Qd?e.code:s.fF.Unknown})}else this.setState({failureReason:b.CheckCodeMismatch})})),(0,i.A)(this,"onFailure",(e=>{this.state.phase!==a.a0.Error&&(r.v.info(`Rendezvous failed: ${e}`),this.setState({phase:a.a0.Error,failureReason:e}))})),(0,i.A)(this,"onClick",(async(e,t)=>{var n,i,o;switch(e){case a.HY.Cancel:await(null===(n=this.state.rendezvous)||void 0===n?void 0:n.cancel(s.n$.UserCancelled)),this.reset(),this.onFinished(!1);break;case a.HY.Approve:await this.approveLogin(t);break;case a.HY.Decline:await(null===(i=this.state.rendezvous)||void 0===i?void 0:i.declineLoginOnExistingDevice()),this.reset(),this.onFinished(!1);break;case a.HY.Back:await(null===(o=this.state.rendezvous)||void 0===o?void 0:o.cancel(s.n$.UserCancelled)),this.onFinished(!1);break;case a.HY.ShowQr:await this.updateMode(a.Kt.Show)}})),this.state={phase:a.a0.Loading}}get ourIntent(){return s.E$.RECIPROCATE_LOGIN_ON_EXISTING_DEVICE}componentDidMount(){this.updateMode(this.props.mode).then((()=>{}))}componentDidUpdate(e){e.mode!==this.props.mode&&this.updateMode(this.props.mode).then((()=>{}))}async updateMode(e){if(this.setState({phase:a.a0.Loading}),this.state.rendezvous){this.state.rendezvous.onFailure=void 0,this.setState({rendezvous:void 0})}e===a.Kt.Show&&await this.generateAndShowCode()}componentWillUnmount(){this.state.rendezvous&&!this.finished&&(this.state.rendezvous.onFailure=void 0,this.state.rendezvous.cancel(s.n$.UserCancelled))}onFinished(e){this.finished=!0,this.props.onFinished(e)}reset(){this.setState({rendezvous:void 0,verificationUri:void 0,failureReason:void 0,userCode:void 0,checkCode:void 0,lastScannedCode:void 0,mediaPermissionError:!1})}render(){var e;return o.createElement(R,{onClick:this.onClick,phase:this.state.phase,code:this.state.phase===a.a0.ShowingQR?null===(e=this.state.rendezvous)||void 0===e?void 0:e.code:void 0,failureReason:this.state.failureReason,userCode:this.state.userCode,checkCode:this.state.checkCode})}}}}]);
//# sourceMappingURL=7020.js.map