(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[2702],{"./res/img/e2e/verified-deprecated.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/e2e/verified-deprecated.9030dfd.svg"},"./res/img/element-icons/brands/apple.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/brands/apple.734de1e.svg"},"./res/img/element-icons/brands/facebook.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/brands/facebook.2061182.svg"},"./res/img/element-icons/brands/github.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/brands/github.a229f06.svg"},"./res/img/element-icons/brands/gitlab.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/brands/gitlab.9958062.svg"},"./res/img/element-icons/brands/google.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/brands/google.1573797.svg"},"./res/img/element-icons/brands/twitter.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/brands/twitter.b825e3c.svg"},"./res/img/element-icons/room/default_app.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/room/default_app.79b63ba.svg"},"./res/img/element-icons/room/default_cal.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/room/default_cal.6bea887.svg"},"./res/img/element-icons/room/default_clock.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/room/default_clock.d7c6411.svg"},"./res/img/element-icons/room/default_doc.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/room/default_doc.a42767c.svg"},"./res/img/element-icons/room/default_video.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/room/default_video.f29df7d.svg"},"./res/img/external-link.svg":(e,t,n)=>{"use strict";n.d(t,{I:()=>a});var i,s=n("./node_modules/react/index.js");function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},o.apply(null,arguments)}var r=function(e,t){return s.createElement("svg",o({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 11 10",role:"presentation","aria-hidden":!0,ref:t},e),i||(i=s.createElement("path",{fill:"none",fillRule:"evenodd",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",d:"M8.5 5.5v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h3M7 .5h3v3M4.5 6 10 .5"})))},a=(0,s.forwardRef)(r)},"./res/img/matrix.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/matrix.9166e4b.svg"},"./src/components/structures/ErrorMessage.tsx":(e,t,n)=>{"use strict";n.d(t,{K:()=>o});var i=n("./node_modules/react/index.js"),s=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/warning.js");const o=({message:e})=>{const t=e?i.createElement(s.A,{className:"mx_Icon mx_Icon_16"}):null;return i.createElement("div",{className:"mx_ErrorMessage"},t,e)}},"./src/components/views/auth/LoginWithQR-types.ts":(e,t,n)=>{"use strict";n.d(t,{HY:()=>o,Kt:()=>i,a0:()=>s});let i=function(e){return e.Show="show",e}({}),s=function(e){return e[e.Loading=0]="Loading",e[e.ShowingQR=1]="ShowingQR",e[e.OutOfBandConfirmation=2]="OutOfBandConfirmation",e[e.WaitingForDevice=3]="WaitingForDevice",e[e.Verifying=4]="Verifying",e[e.Error=5]="Error",e}({}),o=function(e){return e[e.Cancel=0]="Cancel",e[e.Decline=1]="Decline",e[e.Approve=2]="Approve",e[e.Back=3]="Back",e[e.ShowQr=4]="ShowQr",e}({})},"./src/components/views/auth/PassphraseConfirmField.tsx":(e,t,n)=>{"use strict";n.d(t,{A:()=>c});var i=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=n("./node_modules/react/index.js"),o=n("./src/components/views/elements/Field.tsx"),r=n("./src/components/views/elements/Validation.tsx"),a=n("./src/languageHandler.tsx");class l extends s.PureComponent{constructor(...e){super(...e),(0,i.A)(this,"validate",(0,r.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,a._t)(this.props.labelRequired)},{key:"match",test:({value:e})=>!e||e===this.props.password,invalid:()=>(0,a._t)(this.props.labelInvalid)}]})),(0,i.A)(this,"onValidate",(async e=>{const t=await this.validate(e);return this.props.onValidate&&this.props.onValidate(t),t}))}render(){return s.createElement(o.A,{id:this.props.id,ref:this.props.fieldRef,type:"password",label:(0,a._t)(this.props.label),autoComplete:this.props.autoComplete,value:this.props.value,onChange:this.props.onChange,onValidate:this.onValidate,autoFocus:this.props.autoFocus,tooltipAlignment:this.props.tooltipAlignment})}}(0,i.A)(l,"defaultProps",{label:(0,a.AO)("auth|change_password_confirm_label"),labelRequired:(0,a.AO)("auth|change_password_confirm_label"),labelInvalid:(0,a.AO)("auth|change_password_confirm_invalid")});const c=l},"./src/components/views/auth/PassphraseField.tsx":(e,t,n)=>{"use strict";n.d(t,{A:()=>h});var i=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=n("./node_modules/react/index.js"),o=n("./node_modules/classnames/index.js"),r=n.n(o),a=n("./src/SdkConfig.ts"),l=n("./src/components/views/elements/Validation.tsx"),c=n("./src/languageHandler.tsx"),d=n("./src/components/views/elements/Field.tsx"),m=n("./src/MatrixClientPeg.ts");class u extends s.PureComponent{constructor(...e){super(...e),(0,i.A)(this,"validate",(0,l.A)({description:function(e){const t=e?e.score:0;return s.createElement("progress",{className:"mx_PassphraseField_progress",max:4,value:t})},deriveData:async({value:e})=>{if(!e)return null;const{scorePassword:t}=await Promise.all([n.e(2807),n.e(5866)]).then(n.bind(n,"./src/utils/PasswordScorer.ts"));return t(m.J.get(),e,this.props.userInputs)},rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,c._t)(this.props.labelEnterPassword)},{key:"complexity",test:async function({value:e},t){if(!e||!t)return!1;const n=t.score>=this.props.minScore;return a.Ay.get("dangerously_allow_unsafe_and_insecure_passwords")||n},valid:function(e){return e&&e.score>=this.props.minScore?(0,c._t)(this.props.labelStrongPassword):(0,c._t)(this.props.labelAllowedButUnsafe)},invalid:function(e){if(!e)return null;const{feedback:t}=e;return t.warning||t.suggestions[0]||(0,c._t)("auth|password_field_keep_going_prompt")}}],memoize:!0})),(0,i.A)(this,"onValidate",(async e=>{const t=await this.validate(e);return this.props.onValidate&&this.props.onValidate(t),t}))}render(){return s.createElement(d.A,{id:this.props.id,autoFocus:this.props.autoFocus,className:r()("mx_PassphraseField",this.props.className),ref:this.props.fieldRef,type:"password",autoComplete:"new-password",label:(0,c._t)(this.props.label),value:this.props.value,onChange:this.props.onChange,onValidate:this.onValidate,tooltipAlignment:this.props.tooltipAlignment})}}(0,i.A)(u,"defaultProps",{label:(0,c.AO)("common|password"),labelEnterPassword:(0,c.AO)("auth|password_field_label"),labelStrongPassword:(0,c.AO)("auth|password_field_strong_label"),labelAllowedButUnsafe:(0,c.AO)("auth|password_field_weak_label")});const h=u},"./src/components/views/dialogs/security/RestoreKeyBackupDialog.tsx":(e,t,n)=>{"use strict";n.d(t,{A:()=>_});var i=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=n("./node_modules/react/index.js"),o=n("./node_modules/matrix-js-sdk/src/matrix.ts"),r=n("./node_modules/matrix-js-sdk/src/crypto-api/index.ts"),a=n("./node_modules/matrix-js-sdk/src/logger.ts"),l=n("./src/MatrixClientPeg.ts"),c=n("./src/languageHandler.tsx"),d=n("./src/SecurityManager.ts"),m=n("./src/components/views/elements/Spinner.tsx"),u=n("./src/components/views/elements/DialogButtons.tsx"),h=n("./src/components/views/elements/AccessibleButton.tsx"),p=n("./src/components/views/dialogs/BaseDialog.tsx"),g=function(e){return e.Passphrase="passphrase",e.RecoveryKey="recovery_key",e.SecretStorage="secret_storage",e}(g||{}),v=function(e){return e.PreFetch="prefetch",e.Fetch="fetch",e.LoadKeys="load_keys",e}(v||{});class _ extends s.PureComponent{constructor(e){super(e),(0,i.A)(this,"onCancel",(()=>{this.props.onFinished(!1)})),(0,i.A)(this,"onDone",(()=>{this.props.onFinished(!0)})),(0,i.A)(this,"onUseRecoveryKeyClick",(()=>{this.setState({forceRecoveryKey:!0})})),(0,i.A)(this,"progressCallback",(e=>{this.setState({progress:e})})),(0,i.A)(this,"onResetRecoveryClick",(()=>{this.props.onFinished(!1),(0,d.cb)((async()=>{}),{forceReset:!0})})),(0,i.A)(this,"onRecoveryKeyChange",(e=>{this.setState({recoveryKey:e.target.value,recoveryKeyValid:this.isValidRecoveryKey(e.target.value)})})),(0,i.A)(this,"onPassPhraseNext",(async()=>{const e=l.J.safeGet().getCrypto();if(e){this.setState({loading:!0,restoreError:null,restoreType:g.Passphrase});try{const t=await e.restoreKeyBackupWithPassphrase(this.state.passPhrase,{progressCallback:this.progressCallback});if(!this.props.showSummary)return void this.props.onFinished(!0);this.setState({loading:!1,recoverInfo:t})}catch(e){a.v.log("Error restoring backup",e),this.setState({loading:!1,restoreError:e})}}})),(0,i.A)(this,"onRecoveryKeyNext",(async()=>{var e;const t=l.J.safeGet().getCrypto();if(this.state.recoveryKeyValid&&null!==(e=this.state.backupInfo)&&void 0!==e&&e.version&&t){this.setState({loading:!0,restoreError:null,restoreType:g.RecoveryKey});try{await t.storeSessionBackupPrivateKey((0,r.decodeRecoveryKey)(this.state.recoveryKey),this.state.backupInfo.version);const e=await t.restoreKeyBackup({progressCallback:this.progressCallback});if(!this.props.showSummary)return void this.props.onFinished(!0);this.setState({loading:!1,recoverInfo:e})}catch(e){a.v.log("Error restoring backup",e),this.setState({loading:!1,restoreError:e})}}})),(0,i.A)(this,"onPassPhraseChange",(e=>{this.setState({passPhrase:e.target.value})})),this.state={backupInfo:null,loading:!1,loadError:null,restoreError:null,recoveryKey:"",recoverInfo:null,recoveryKeyValid:!1,forceRecoveryKey:!1,passPhrase:"",restoreType:null,progress:{stage:v.PreFetch}}}componentDidMount(){this.loadBackupStatus()}isValidRecoveryKey(e){try{return(0,r.decodeRecoveryKey)(e),!0}catch{return!1}}async restoreWithSecretStorage(){const e=l.J.safeGet().getCrypto();if(!e)return!1;this.setState({restoreError:null,restoreType:g.SecretStorage});try{let t=null;return await(0,d.cb)((async()=>{await e.loadSessionBackupPrivateKeyFromSecretStorage(),t=await e.restoreKeyBackup({progressCallback:this.progressCallback})})),this.setState({loading:!1,recoverInfo:t}),!0}catch(e){return a.v.log("restoreWithSecretStorage failed:",e),this.setState({restoreError:e,loading:!1}),!1}}async restoreWithCachedKey(e){const t=l.J.safeGet().getCrypto();if(!t)return!1;try{const e=await t.restoreKeyBackup({progressCallback:this.progressCallback});return this.setState({recoverInfo:e}),!0}catch(e){return a.v.log("restoreWithCachedKey failed:",e),!1}}async loadBackupStatus(){this.setState({loading:!0,loadError:null});try{var e,t;const n=l.J.safeGet(),i=null!==(e=await(null===(t=n.getCrypto())||void 0===t?void 0:t.getKeyBackupInfo()))&&void 0!==e?e:null,s=await n.secretStorage.hasKey()?await n.isKeyBackupKeyStored():null;this.setState({backupInfo:i});if(await this.restoreWithCachedKey(i))return a.v.log("RestoreKeyBackupDialog: found cached backup key"),void this.setState({loading:!1});if(s&&await this.restoreWithSecretStorage())return a.v.log("RestoreKeyBackupDialog: found backup key in secret storage"),void this.setState({loading:!1});this.setState({loadError:null,loading:!1})}catch(e){a.v.log("Error loading backup status",e),this.setState({loadError:!0,loading:!1})}}render(){const e=this.state.backupInfo&&this.state.backupInfo.auth_data&&this.state.backupInfo.auth_data.private_key_salt&&this.state.backupInfo.auth_data.private_key_iterations;let t,n;if(this.state.loading){let e;if(n=(0,c._t)("encryption|access_secret_storage_dialog|restoring"),this.state.progress.stage===v.Fetch)e=(0,c._t)("restore_key_backup_dialog|key_fetch_in_progress");else if(this.state.progress.stage===v.LoadKeys){const{total:t,successes:n,failures:i}=this.state.progress;e=(0,c._t)("restore_key_backup_dialog|load_keys_progress",{total:t,completed:(null!=n?n:0)+(null!=i?i:0)})}else this.state.progress.stage===v.PreFetch&&(e=(0,c._t)("restore_key_backup_dialog|key_fetch_in_progress"));t=s.createElement("div",null,s.createElement("div",null,e),s.createElement(m.A,null))}else if(this.state.loadError)n=(0,c._t)("common|error"),t=(0,c._t)("restore_key_backup_dialog|load_error_content");else if(this.state.restoreError)this.state.restoreError instanceof o.MatrixError&&this.state.restoreError.errcode===o.MatrixClient.RESTORE_BACKUP_ERROR_BAD_KEY?this.state.restoreType===g.RecoveryKey?(n=(0,c._t)("restore_key_backup_dialog|recovery_key_mismatch_title"),t=s.createElement("div",null,s.createElement("p",null,(0,c._t)("restore_key_backup_dialog|recovery_key_mismatch_description")))):(n=(0,c._t)("restore_key_backup_dialog|incorrect_security_phrase_title"),t=s.createElement("div",null,s.createElement("p",null,(0,c._t)("restore_key_backup_dialog|incorrect_security_phrase_dialog")))):(n=(0,c._t)("common|error"),t=(0,c._t)("restore_key_backup_dialog|restore_failed_error"));else if(null===this.state.backupInfo)n=(0,c._t)("common|error"),t=(0,c._t)("restore_key_backup_dialog|no_backup_error");else if(this.state.recoverInfo){let e;n=(0,c._t)("restore_key_backup_dialog|keys_restored_title"),this.state.recoverInfo.total>this.state.recoverInfo.imported&&(e=s.createElement("p",null,(0,c._t)("restore_key_backup_dialog|count_of_decryption_failures",{failedCount:this.state.recoverInfo.total-this.state.recoverInfo.imported}))),t=s.createElement("div",null,s.createElement("p",null,(0,c._t)("restore_key_backup_dialog|count_of_successfully_restored_keys",{sessionCount:this.state.recoverInfo.imported})),e,s.createElement(u.A,{primaryButton:(0,c._t)("action|ok"),onPrimaryButtonClick:this.onDone,hasCancel:!1,focus:!0}))}else if(e&&!this.state.forceRecoveryKey)n=(0,c._t)("restore_key_backup_dialog|enter_phrase_title"),t=s.createElement("div",null,s.createElement("p",null,(0,c._t)("restore_key_backup_dialog|key_backup_warning",{},{b:e=>s.createElement("strong",null,e)})),s.createElement("p",null,(0,c._t)("restore_key_backup_dialog|enter_phrase_description")),s.createElement("form",{className:"mx_RestoreKeyBackupDialog_primaryContainer"},s.createElement("input",{type:"password",className:"mx_RestoreKeyBackupDialog_passPhraseInput",onChange:this.onPassPhraseChange,value:this.state.passPhrase,autoFocus:!0}),s.createElement(u.A,{primaryButton:(0,c._t)("action|next"),onPrimaryButtonClick:this.onPassPhraseNext,primaryIsSubmit:!0,hasCancel:!0,onCancel:this.onCancel,focus:!1})),(0,c._t)("restore_key_backup_dialog|phrase_forgotten_text",{},{button1:e=>s.createElement(h.A,{kind:"link_inline",onClick:this.onUseRecoveryKeyClick},e),button2:e=>s.createElement(h.A,{kind:"link_inline",onClick:this.onResetRecoveryClick},e)}));else{let e;n=(0,c._t)("restore_key_backup_dialog|enter_key_title"),e=0===this.state.recoveryKey.length?s.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"}):this.state.recoveryKeyValid?s.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"},"👍 ",(0,c._t)("restore_key_backup_dialog|key_is_valid")):s.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"},"👎 ",(0,c._t)("restore_key_backup_dialog|key_is_invalid")),t=s.createElement("div",null,s.createElement("p",null,(0,c._t)("restore_key_backup_dialog|key_backup_warning",{},{b:e=>s.createElement("strong",null,e)})),s.createElement("p",null,(0,c._t)("restore_key_backup_dialog|enter_key_description")),s.createElement("div",{className:"mx_RestoreKeyBackupDialog_primaryContainer"},s.createElement("input",{className:"mx_RestoreKeyBackupDialog_recoveryKeyInput",onChange:this.onRecoveryKeyChange,value:this.state.recoveryKey,autoFocus:!0}),e,s.createElement(u.A,{primaryButton:(0,c._t)("action|next"),onPrimaryButtonClick:this.onRecoveryKeyNext,hasCancel:!0,onCancel:this.onCancel,focus:!1,primaryDisabled:!this.state.recoveryKeyValid})),(0,c._t)("restore_key_backup_dialog|key_forgotten_text",{},{button:e=>s.createElement(h.A,{kind:"link_inline",onClick:this.onResetRecoveryClick},e)}))}return s.createElement(p.A,{className:"mx_RestoreKeyBackupDialog",onFinished:this.props.onFinished,title:n},s.createElement("div",{className:"mx_RestoreKeyBackupDialog_content"},t))}}(0,i.A)(_,"defaultProps",{showSummary:!0})},"./src/components/views/settings/KeyboardShortcut.tsx":(e,t,n)=>{"use strict";n.d(t,{S:()=>l});var i=n("./node_modules/react/index.js"),s=n("./src/accessibility/KeyboardShortcuts.ts"),o=n("./src/Keyboard.ts"),r=n("./src/languageHandler.tsx");const a=({name:e,last:t})=>{const n=s.GA[e],o=s.hm[e];return i.createElement(i.Fragment,null,i.createElement("kbd",null," ",n||o&&(0,r._t)(o)||e," "),!t&&"+")},l=({value:e,className:t="mx_KeyboardShortcut"})=>{if(!e)return null;const n=[];return e.ctrlOrCmdKey?n.push(i.createElement(a,{key:"ctrlOrCmdKey",name:o.vL?o.Uz.META:o.Uz.CONTROL})):e.ctrlKey?n.push(i.createElement(a,{key:"ctrlKey",name:o.Uz.CONTROL})):e.metaKey&&n.push(i.createElement(a,{key:"metaKey",name:o.Uz.META})),e.altKey&&n.push(i.createElement(a,{key:"altKey",name:o.Uz.ALT})),e.shiftKey&&n.push(i.createElement(a,{key:"shiftKey",name:o.Uz.SHIFT})),i.createElement("div",{className:t},n,i.createElement(a,{name:e.key,last:!0}))}},"./src/indexing/EventIndexPeg.ts":(e,t,n)=>{"use strict";n.d(t,{A:()=>v});var i=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=n("./node_modules/matrix-js-sdk/src/logger.ts"),o=n("./src/PlatformPeg.ts"),r=n("./node_modules/events/events.js"),a=n("./node_modules/matrix-js-sdk/src/matrix.ts"),l=n("./node_modules/matrix-js-sdk/src/types.ts"),c=n("./node_modules/matrix-js-sdk/src/utils.ts"),d=n("./src/MatrixClientPeg.ts"),m=n("./src/settings/SettingsStore.ts"),u=n("./src/settings/SettingLevel.ts"),h=n("./src/utils/arrays.ts");class p extends r.EventEmitter{constructor(...e){super(...e),(0,i.A)(this,"crawlerCheckpoints",[]),(0,i.A)(this,"crawler",null),(0,i.A)(this,"currentCheckpoint",null),(0,i.A)(this,"onSync",(async(e,t,n)=>{var i;const s=null===(i=o.A.get())||void 0===i?void 0:i.getEventIndexingManager();if(s){if("PREPARED"===t&&"SYNCING"===e){return await s.isEventIndexEmpty()&&await this.addInitialCheckpoints(),void this.startCrawler()}"SYNCING"===t&&"SYNCING"===e&&await s.commitLiveEvents()}})),(0,i.A)(this,"onRoomTimeline",(async(e,t,n,i,s)=>{if(!t)return;const o=d.J.safeGet();return o.isRoomEncrypted(e.getRoomId())?e.isRedaction()?this.redactEvent(e):void(!n&&s&&s.liveEvent&&!e.isRedacted()&&(await o.decryptEventIfNeeded(e),await this.addLiveEventToIndex(e))):void 0})),(0,i.A)(this,"onRoomStateEvent",(async(e,t)=>{d.J.safeGet().isRoomEncrypted(t.roomId)&&(e.getType()!==a.EventType.RoomEncryption||await this.isRoomIndexed(t.roomId)||(s.v.log("EventIndex: Adding a checkpoint for a newly encrypted room",t.roomId),this.addRoomCheckpoint(t.roomId,!0)))})),(0,i.A)(this,"redactEvent",(async e=>{var t;const n=null===(t=o.A.get())||void 0===t?void 0:t.getEventIndexingManager();if(!n)return;const i=e.getAssociatedId();if(i)try{await n.deleteEvent(i)}catch(e){s.v.log("EventIndex: Error deleting event from index",e)}})),(0,i.A)(this,"onTimelineReset",(async e=>{e&&d.J.safeGet().isRoomEncrypted(e.roomId)&&(s.v.log("EventIndex: Adding a checkpoint because of a limited timeline",e.roomId),this.addRoomCheckpoint(e.roomId,!1))}))}async init(){var e;const t=null===(e=o.A.get())||void 0===e?void 0:e.getEventIndexingManager();t&&(this.crawlerCheckpoints=await t.loadCheckpoints(),s.v.log("EventIndex: Loaded checkpoints",this.crawlerCheckpoints),this.registerListeners())}registerListeners(){const e=d.J.safeGet();e.on(a.ClientEvent.Sync,this.onSync),e.on(a.RoomEvent.Timeline,this.onRoomTimeline),e.on(a.RoomEvent.TimelineReset,this.onTimelineReset),e.on(a.RoomStateEvent.Events,this.onRoomStateEvent)}removeListeners(){const e=d.J.get();null!==e&&(e.removeListener(a.ClientEvent.Sync,this.onSync),e.removeListener(a.RoomEvent.Timeline,this.onRoomTimeline),e.removeListener(a.RoomEvent.TimelineReset,this.onTimelineReset),e.removeListener(a.RoomStateEvent.Events,this.onRoomStateEvent))}async addInitialCheckpoints(){var e;const t=null===(e=o.A.get())||void 0===e?void 0:e.getEventIndexingManager();if(!t)return;const n=d.J.safeGet(),i=n.getRooms(),r=await(0,h.j7)(i,(async e=>{var t;return Boolean(await(null===(t=n.getCrypto())||void 0===t?void 0:t.isEncryptionEnabledInRoom(e.roomId)))}));s.v.log("EventIndex: Adding initial crawler checkpoints"),await Promise.all(r.map((async e=>{const n=e.getLiveTimeline().getPaginationToken(a.Direction.Backward),i={roomId:e.roomId,token:n,direction:a.Direction.Backward,fullCrawl:!0},o={roomId:e.roomId,token:n,direction:a.Direction.Forward};try{i.token&&(await t.addCrawlerCheckpoint(i),this.crawlerCheckpoints.push(i)),o.token&&(await t.addCrawlerCheckpoint(o),this.crawlerCheckpoints.push(o))}catch(t){s.v.log("EventIndex: Error adding initial checkpoints for room",e.roomId,i,o,t)}})))}isValidEvent(e){const t=[a.EventType.RoomMessage,a.EventType.RoomName,a.EventType.RoomTopic].includes(e.getType())&&!e.isRedacted()&&!e.isDecryptionFailure();let n=!0,i=!0;if(e.getType()!==a.EventType.RoomMessage||e.isRedacted())e.getType()!==a.EventType.RoomTopic||e.isRedacted()?e.getType()!==a.EventType.RoomName||e.isRedacted()||e.getContent().name||(i=!1):e.getContent().topic||(i=!1);else{const t=e.getContent().msgtype;n=!!t&&!t.startsWith("m.key.verification"),e.getContent().body||(i=!1)}return t&&n&&i}eventToJson(e){const t=e.getEffectiveEvent();return e.isEncrypted()?(t.curve25519Key=e.getSenderKey(),t.ed25519Key=e.getClaimedEd25519Key(),t.algorithm=e.getWireContent().algorithm,t.forwardingCurve25519KeyChain=e.getForwardingCurve25519KeyChain()):(delete t.curve25519Key,delete t.ed25519Key,delete t.algorithm,delete t.forwardingCurve25519KeyChain),t}async addLiveEventToIndex(e){var t,n,i;const s=null===(t=o.A.get())||void 0===t?void 0:t.getEventIndexingManager();if(!s||!this.isValidEvent(e))return;const r=this.eventToJson(e),a={displayname:null===(n=e.sender)||void 0===n?void 0:n.rawDisplayName,avatar_url:null===(i=e.sender)||void 0===i?void 0:i.getMxcAvatarUrl()};await s.addEventToIndex(r,a)}emitNewCheckpoint(){this.emit("changedCheckpoint",this.currentRoom())}async addEventsFromLiveTimeline(e){const t=e.getEvents();for(let e=0;e<t.length;e++){const n=t[e];await this.addLiveEventToIndex(n)}}async addRoomCheckpoint(e,t=!1){var n;const i=null===(n=o.A.get())||void 0===n?void 0:n.getEventIndexingManager();if(!i)return;const r=d.J.safeGet().getRoom(e);if(!r)return;const l=r.getLiveTimeline(),c=l.getPaginationToken(a.Direction.Backward);if(!c)return void await this.addEventsFromLiveTimeline(l);const m={roomId:r.roomId,token:c,fullCrawl:t,direction:a.Direction.Backward};s.v.log("EventIndex: Adding checkpoint",m);try{await i.addCrawlerCheckpoint(m)}catch(e){s.v.log("EventIndex: Error adding new checkpoint for room",r.roomId,m,e)}this.crawlerCheckpoints.push(m)}async crawlerFunc(){var e;let t=!1;const n=d.J.safeGet(),i=null===(e=o.A.get())||void 0===e?void 0:e.getEventIndexingManager();if(!i)return;this.crawler={cancel:()=>{t=!0}};let r=!1;for(;!t;){let e=m.A.getValueAt(u.p.DEVICE,"crawlerSleepTime");if(e=Math.max(e,100),r&&(e=5e3),null!==this.currentCheckpoint&&(this.currentCheckpoint=null,this.emitNewCheckpoint()),await(0,c.yy)(e),t)break;const o=this.crawlerCheckpoints.shift();if(void 0===o){r=!0;continue}this.currentCheckpoint=o,this.emitNewCheckpoint(),r=!1;const d=n.getEventMapper({preventReEmit:!0});let h;try{h=await n.createMessagesRequest(o.roomId,o.token,100,o.direction)}catch(e){if(e instanceof a.HTTPError&&403===e.httpStatus){s.v.log("EventIndex: Removing checkpoint as we don't have ","permissions to fetch messages from this room.",o);try{await i.removeCrawlerCheckpoint(o)}catch(e){s.v.log("EventIndex: Error removing checkpoint",o,e)}continue}s.v.log("EventIndex: Error crawling using checkpoint:",o,",",e),this.crawlerCheckpoints.push(o);continue}if(t){this.crawlerCheckpoints.push(o);break}if(0===h.chunk.length){s.v.log("EventIndex: Done with the checkpoint",o);try{await i.removeCrawlerCheckpoint(o)}catch(e){s.v.log("EventIndex: Error removing checkpoint",o,e)}continue}const p=h.chunk.map(d);let g=[];void 0!==h.state&&(g=h.state.map(d));const v={};g.forEach((e=>{e.getContent().membership===l.O.Join&&(v[e.getSender()]={displayname:e.getContent().displayname,avatar_url:e.getContent().avatar_url})}));const _=p.filter((e=>e.isEncrypted())).map((e=>n.decryptEventIfNeeded(e,{emit:!1})));await Promise.all(_);const f=p.filter(this.isValidEvent),E=p.filter((e=>e.isRedaction())),y=f.map((e=>{const t=this.eventToJson(e);let n={};t.sender in v&&(n=v[t.sender]);return{event:t,profile:n}}));let b=null;h.end&&(b={roomId:o.roomId,token:h.end,fullCrawl:o.fullCrawl,direction:o.direction});try{for(let e=0;e<E.length;e++){const t=E[e],n=t.getAssociatedId();n?await i.deleteEvent(n):s.v.warn("EventIndex: Redaction event doesn't contain a valid associated event id",t)}const e=await i.addHistoricEvents(y,b,o);if(!b){s.v.log("EventIndex: The server didn't return a valid ","new checkpoint, not continuing the crawl.",o);continue}!0===e&&!0!==b.fullCrawl?(s.v.log("EventIndex: Checkpoint had already all events","added, stopping the crawl",o),await i.removeCrawlerCheckpoint(b)):(!0===e&&s.v.log("EventIndex: Checkpoint had already all events","added, but continuing due to a full crawl",o),this.crawlerCheckpoints.push(b))}catch(e){s.v.log("EventIndex: Error during a crawl",e),this.crawlerCheckpoints.push(o)}}this.crawler=null}startCrawler(){null===this.crawler&&this.crawlerFunc()}stopCrawler(){null!==this.crawler&&this.crawler.cancel()}async close(){var e;const t=null===(e=o.A.get())||void 0===e?void 0:e.getEventIndexingManager();this.removeListeners(),this.stopCrawler(),await(null==t?void 0:t.closeEventIndex())}async search(e){var t;const n=null===(t=o.A.get())||void 0===t?void 0:t.getEventIndexingManager();return null==n?void 0:n.searchEventIndex(e)}async loadFileEvents(e,t=10,n,i=a.EventTimeline.BACKWARDS){var r;const c=d.J.safeGet(),m=null===(r=o.A.get())||void 0===r?void 0:r.getEventIndexingManager();if(!m)return[];const u={roomId:e.roomId,limit:t};let h;n&&(u.fromEvent=n,u.direction=i);try{h=await m.loadFileEvents(u)}catch(e){return s.v.log("EventIndex: Error getting file events",e),[]}const p=c.getEventMapper();return h.map((t=>{const n=p(t.event),i=new a.RoomMember(e.roomId,n.getSender());i.name=t.profile.displayname+" ("+n.getSender()+")";const s=p({content:{membership:l.O.Join,avatar_url:t.profile.avatar_url,displayname:t.profile.displayname},type:a.EventType.RoomMember,event_id:n.getId()+":eventIndex",room_id:n.getRoomId(),sender:n.getSender(),origin_server_ts:n.getTs(),state_key:n.getSender()});return i.events.member=s,n.sender=i,n}))}async populateFileTimeline(e,t,n,i=10,o,r=a.EventTimeline.BACKWARDS){const l=await this.loadFileEvents(n,i,o,r);null===o&&(l.reverse(),r=r==a.EventTimeline.BACKWARDS?a.EventTimeline.FORWARDS:a.EventTimeline.BACKWARDS),l.forEach((n=>{e.eventIdToTimeline(n.getId())||e.addEventToTimeline(n,t,r==a.EventTimeline.BACKWARDS)}));let c=!1,d="";return l.length>0&&(d=l[l.length-1].getId(),c=!0),s.v.log("EventIndex: Populating file panel with",l.length,"events and setting the pagination token to",d),t.setPaginationToken(d,a.EventTimeline.BACKWARDS),c}paginateTimelineWindow(e,t,n,i){const s=t.getTimelineIndex(n);if(!s)return Promise.resolve(!1);if(s.pendingPaginate)return s.pendingPaginate;if(t.extend(n,i))return Promise.resolve(!0);const o=(async(e,t,n,i,s)=>{var o;const r=t.timeline,a=r.getTimelineSet(),l=null!==(o=r.getPaginationToken(i))&&void 0!==o?o:void 0,c=await this.populateFileTimeline(a,r,n,s,l,i);return t.pendingPaginate=void 0,e.extend(i,s),c})(t,s,e,n,i);return s.pendingPaginate=o,o}async getStats(){var e;const t=null===(e=o.A.get())||void 0===e?void 0:e.getEventIndexingManager();return null==t?void 0:t.getStats()}async isRoomIndexed(e){var t;const n=null===(t=o.A.get())||void 0===t?void 0:t.getEventIndexingManager();return null==n?void 0:n.isRoomIndexed(e)}currentRoom(){if(null===this.currentCheckpoint&&0===this.crawlerCheckpoints.length)return null;const e=d.J.safeGet();return null!==this.currentCheckpoint?e.getRoom(this.currentCheckpoint.roomId):e.getRoom(this.crawlerCheckpoints[0].roomId)}crawlingRooms(){const e=new Set,t=new Set;this.crawlerCheckpoints.forEach(((e,n)=>{t.add(e.roomId)})),null!==this.currentCheckpoint&&t.add(this.currentCheckpoint.roomId);const n=d.J.safeGet();return n.getRooms().filter((e=>n.isRoomEncrypted(e.roomId))).forEach(((t,n)=>{e.add(t.roomId)})),{crawlingRooms:t,totalRooms:e}}}class g{constructor(){(0,i.A)(this,"index",null),(0,i.A)(this,"error",void 0),(0,i.A)(this,"_supportIsInstalled",!1)}async init(){var e;const t=null===(e=o.A.get())||void 0===e?void 0:e.getEventIndexingManager();return t?(this._supportIsInstalled=await t.supportsEventIndexing(),this.supportIsInstalled()?m.A.getValueAt(u.p.DEVICE,"enableEventIndexing")?this.initEventIndex():(s.v.log("EventIndex: Event indexing is disabled, not initializing"),!1):(s.v.log("EventIndex: Event indexing isn't installed for the platform, not initializing."),!1)):(s.v.log("EventIndex: Platform doesn't support event indexing, not initializing."),!1)}async initEventIndex(){var e;const t=new p,n=null===(e=o.A.get())||void 0===e?void 0:e.getEventIndexingManager(),i=d.J.get();if(!n||!i)throw new Error("Unable to init event index");const r=i.getUserId(),a=i.getDeviceId();try{await n.initEventIndex(r,a);const e=await n.getUserVersion(),i=await n.isEventIndexEmpty();i?await n.setUserVersion(1):0!==e||i||(await n.closeEventIndex(),await this.deleteEventIndex(),await n.initEventIndex(r,a),await n.setUserVersion(1)),s.v.log("EventIndex: Successfully initialized the event index"),await t.init()}catch(e){return s.v.log("EventIndex: Error initializing the event index",e),this.error=e,!1}return this.index=t,!0}platformHasSupport(){var e;return null!=(null===(e=o.A.get())||void 0===e?void 0:e.getEventIndexingManager())}supportIsInstalled(){return this._supportIsInstalled}get(){return this.index}start(){null!==this.index&&this.index.startCrawler()}stop(){null!==this.index&&this.index.stopCrawler()}async unset(){null!==this.index&&(await this.index.close(),this.index=null)}async deleteEventIndex(){var e;const t=null===(e=o.A.get())||void 0===e?void 0:e.getEventIndexingManager();t&&(await this.unset(),s.v.log("EventIndex: Deleting event index."),await t.deleteEventIndex())}}window.mxEventIndexPeg||(window.mxEventIndexPeg=new g);const v=window.mxEventIndexPeg},"./src/utils/device/dehydration.ts":(e,t,n)=>{"use strict";n.d(t,{b:()=>o});var i=n("./node_modules/matrix-js-sdk/src/logger.ts"),s=n("./src/MatrixClientPeg.ts");async function o(e=!1){const t=s.J.safeGet().getCrypto();await async function(e){if(!e)return!1;if(!await e.isDehydrationSupported())return!1;const t=await s.J.safeGet().waitForClientWellKnown();return!(null==t||!t["org.matrix.msc3814"])}(t)&&(i.v.log("Device dehydration enabled"),await t.startDehydration(e))}},"./src/vector/app.tsx":(e,t,n)=>{"use strict";n.r(t),n.d(t,{loadApp:()=>wk});n("./node_modules/matrix-js-sdk/src/browser-index.ts");var i=n("./node_modules/react/index.js"),s=n("./node_modules/matrix-js-sdk/src/logger.ts"),o=n("./node_modules/matrix-js-sdk/src/matrix.ts"),r=n("./node_modules/@matrix-org/react-sdk-module-api/lib/lifecycles/WrapperLifecycle.js"),a=n("./src/PlatformPeg.ts"),l=n("./src/languageHandler.tsx"),c=n("./src/SdkConfig.ts");const d=[o.AutoDiscovery.ERROR_INVALID_HOMESERVER,o.AutoDiscovery.ERROR_INVALID_IDENTITY_SERVER],m=Object.values(o.AutoDiscoveryError),u=e=>m.includes(e),h=e=>{switch(e){case o.AutoDiscoveryError.GenericFailure:return(0,l.AO)("auth|autodiscovery_invalid");case o.AutoDiscoveryError.Invalid:return(0,l.AO)("auth|autodiscovery_generic_failure");case o.AutoDiscoveryError.InvalidHsBaseUrl:return(0,l.AO)("auth|autodiscovery_invalid_hs_base_url");case o.AutoDiscoveryError.InvalidHomeserver:return(0,l.AO)("auth|autodiscovery_invalid_hs");case o.AutoDiscoveryError.InvalidIsBaseUrl:return(0,l.AO)("auth|autodiscovery_invalid_is_base_url");case o.AutoDiscoveryError.InvalidIdentityServer:return(0,l.AO)("auth|autodiscovery_invalid_is");case o.AutoDiscoveryError.InvalidIs:return(0,l.AO)("auth|autodiscovery_invalid_is_response");case o.AutoDiscoveryError.MissingWellknown:return(0,l.AO)("auth|autodiscovery_no_well_known");case o.AutoDiscoveryError.InvalidJson:return(0,l.AO)("auth|autodiscovery_invalid_json");case o.AutoDiscoveryError.UnsupportedHomeserverSpecVersion:return(0,l.AO)("auth|autodiscovery_hs_incompatible")}};class p{static isLivelinessError(e){if(!e)return!1;let t=e;return e instanceof l.P7?t=e.cause:e instanceof Error&&(t=e.message),d.includes(t)}static authComponentStateForError(e,t="login"){if(!e)return{serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:null};let n=(0,l._t)("cannot_reach_homeserver"),s=(0,l._t)("cannot_reach_homeserver_detail");if(!p.isLivelinessError(e)){const e=c.Ay.get().brand;n=(0,l._t)("auth|misconfigured_title",{brand:e}),s=(0,l._t)("auth|misconfigured_body",{brand:e},{a:e=>i.createElement("a",{href:"https://github.com/vector-im/element-web/blob/master/docs/config.md",target:"_blank",rel:"noreferrer noopener"},e)})}let r=!0;return(e instanceof Error?e.message:e)===o.AutoDiscovery.ERROR_INVALID_IDENTITY_SERVER&&(r=!1,n=(0,l._t)("auth|failed_connect_identity_server"),s="register"===t?(0,l._t)("auth|failed_connect_identity_server_register"):"reset_password"===t?(0,l._t)("auth|failed_connect_identity_server_reset_password"):(0,l._t)("auth|failed_connect_identity_server_other")),{serverIsAlive:!1,serverErrorIsFatal:r,serverDeadError:i.createElement("div",null,i.createElement("strong",null,n),i.createElement("div",null,s))}}static async validateServerConfigWithStaticUrls(e,t,n=!1){if(!e)throw new l.P7("auth|no_hs_url_provided");const i={"m.homeserver":{base_url:e}};t&&(i["m.identity_server"]={base_url:t});const s=await o.AutoDiscovery.fromDiscoveryConfig(i),r=new URL(e).hostname;return p.buildValidatedConfigFromDiscovery(r,s,n,!0)}static async validateServerName(e){const t=await o.AutoDiscovery.findClientConfig(e);return p.buildValidatedConfigFromDiscovery(e,t)}static async buildValidatedConfigFromDiscovery(e,t,n=!1,i=!1){var r,a;if(null==t||!t["m.homeserver"])throw s.v.error("Ended up in a state of not knowing which homeserver to connect to."),new l.P7("auth|autodiscovery_unexpected_error_hs");const d=t["m.homeserver"],m=t["m.identity_server"],g=c.Ay.get("validated_server_config");let v=g&&g.isUrl;var _;if(m&&m.state===o.AutoDiscovery.SUCCESS)v=null!==(_=m.base_url)&&void 0!==_?_:void 0;else if(m&&m.state!==o.AutoDiscovery.PROMPT){if(s.v.error("Error determining preferred identity server URL:",m),m.state===o.AutoDiscovery.FAIL_ERROR){if(u(m.error))throw new l.P7(h(m.error),{cause:d.error});throw new l.P7("auth|autodiscovery_unexpected_error_is")}d.error=o.AutoDiscovery.ERROR_INVALID_IDENTITY_SERVER,m.base_url&&(v=m.base_url)}if(d.state!==o.AutoDiscovery.SUCCESS&&(s.v.error("Error processing homeserver config:",d),!n||!p.isLivelinessError(d.error))){if(u(d.error))throw new l.P7(h(d.error),{cause:d.error});throw new l.P7("auth|autodiscovery_unexpected_error_hs")}const f=d.base_url;if(!f)throw s.v.error("No homeserver URL configured"),new l.P7("auth|autodiscovery_unexpected_error_hs");let E=null!=e?e:d.server_name;const y=new URL(f);if(E||(E=y.hostname),!E)throw s.v.error("Failed to parse homeserver name from homeserver URL"),new l.P7("auth|autodiscovery_unexpected_error_hs");let b,w;try{const e=new o.MatrixClient({baseUrl:f}),{issuer:t}=await e.getAuthIssuer();b=await(0,o.discoverAndValidateOIDCIssuerWellKnown)(t)}catch(e){e instanceof o.MatrixError&&404===e.httpStatus&&"M_UNRECOGNIZED"===e.errcode||(w=e)}return{hsUrl:f,hsName:E,hsNameIsDifferent:y.hostname!==E,isUrl:v,isDefault:!1,warning:null!==(r=null!==(a=d.error)&&void 0!==a?a:w)&&void 0!==r?r:null,isNameResolvable:!i,delegatedAuthentication:b}}}var g=n("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),v=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),_=n("./src/MatrixClientPeg.ts"),f=n("./src/modules/ModuleRunner.ts"),E=n("./src/indexing/EventIndexPeg.ts"),y=n("./src/utils/createMatrixClient.ts"),b=n("./src/Notifier.ts"),w=n("./src/UserActivity.ts"),S=n("./src/dispatcher/dispatcher.ts"),A=n("./src/utils/Timer.ts");const C=new class{constructor(){(0,v.A)(this,"unavailableTimer",void 0),(0,v.A)(this,"dispatcherRef",void 0),(0,v.A)(this,"state",void 0),(0,v.A)(this,"onAction",(e=>{var t;"user_activity"===e.action&&(this.setState(o.SetPresence.Online),null===(t=this.unavailableTimer)||void 0===t||t.restart())}))}async start(){for(this.unavailableTimer=new A.A(18e4),this.dispatcherRef=S.A.register(this.onAction);this.unavailableTimer;)try{await this.unavailableTimer.finished(),this.setState(o.SetPresence.Unavailable)}catch{}}stop(){var e;S.A.unregister(this.dispatcherRef),this.dispatcherRef=void 0,null===(e=this.unavailableTimer)||void 0===e||e.abort(),this.unavailableTimer=void 0}getState(){var e;return null!==(e=this.state)&&void 0!==e?e:null}async setState(e){if(e===this.state)return;const t=this.state;if(this.state=e,!_.J.safeGet().isGuest())try{await _.J.safeGet().setSyncPresence(this.state),s.v.debug("Presence:",e)}catch(e){s.v.error("Failed to set presence:",e),this.state=t}}};var x=n("./src/utils/DMRoomMap.ts"),k=n("./src/Modal.tsx"),R=n("./src/stores/ActiveWidgetStore.ts");class I{constructor(e,t,n,i){(0,v.A)(this,"flows",[]),(0,v.A)(this,"defaultDeviceDisplayName",void 0),(0,v.A)(this,"delegatedAuthentication",void 0),(0,v.A)(this,"tempClient",null),this.hsUrl=e,this.isUrl=t,this.fallbackHsUrl=n,this.defaultDeviceDisplayName=i.defaultDeviceDisplayName,this.delegatedAuthentication=i.delegatedAuthentication}getHomeserverUrl(){return this.hsUrl}getIdentityServerUrl(){return this.isUrl}setHomeserverUrl(e){this.tempClient=null,this.hsUrl=e}setIdentityServerUrl(e){this.tempClient=null,this.isUrl=e}setDelegatedAuthentication(e){this.tempClient=null,this.delegatedAuthentication=e}createTemporaryClient(){return this.tempClient||(this.tempClient=(0,o.createClient)({baseUrl:this.hsUrl,idBaseUrl:this.isUrl})),this.tempClient}async getFlows(e){if(this.delegatedAuthentication)try{return[await T(this.delegatedAuthentication,c.Ay.get().oidc_static_clients,e)]}catch(e){s.v.error(e)}const t=this.createTemporaryClient(),{flows:n}=await t.loginFlows(),i=n.find((e=>"m.login.sso"===e.type&&o.DELEGATED_OIDC_COMPATIBILITY.findIn(e)));return this.flows=i?[i]:n,this.flows}loginViaPassword(e,t,n,i){const o=!!e&&e.indexOf("@")>0;let r;r=t&&n?{type:"m.id.phone",country:t,phone:n,number:n}:o?{type:"m.id.thirdparty",medium:"email",address:e}:{type:"m.id.user",user:e};const a={password:i,identifier:r,initial_device_display_name:this.defaultDeviceDisplayName},l=e=>P(this.fallbackHsUrl,this.isUrl,"m.login.password",a).catch((t=>{throw s.v.log("fallback HS login failed",t),e}));let c=null;return P(this.hsUrl,this.isUrl,"m.login.password",a).catch((e=>{if(c=e,403===e.httpStatus&&this.fallbackHsUrl)return l(c);throw c})).catch((e=>{throw s.v.log("Login failed",e),e}))}}const T=async(e,t,n)=>{if(n&&!(e=>{const t=e.metadata.prompt_values_supported;return Array.isArray(t)&&(null==t?void 0:t.includes("create"))})(e))throw new Error("Registration is not supported by OP");const i=await(async(e,t)=>{const n=((e,t)=>{var n;const i=e.endsWith("/")?e:e+"/";return null==t||null===(n=t[i])||void 0===n?void 0:n.client_id})(e.metadata.issuer,t);return n?(s.v.debug(`Using static clientId for issuer ${e.metadata.issuer}`),n):await(0,o.registerOidcClient)(e,await a.A.get().getOidcClientMetadata())})(e,t);return{type:"oidcNativeFlow",clientId:i}};async function P(e,t,n,i){const r=(0,o.createClient)({baseUrl:e,idBaseUrl:t}),a=await r.login(n,i),l=a.well_known;var c,d;l&&(null!==(c=l["m.homeserver"])&&void 0!==c&&c.base_url&&(e=l["m.homeserver"].base_url,s.v.log(`Overrode homeserver setting with ${e} from login response`)),null!==(d=l["m.identity_server"])&&void 0!==d&&d.base_url&&(t=l["m.identity_server"].base_url,s.v.log(`Overrode IS setting with ${t} from login response`)));const m={homeserverUrl:e,identityServerUrl:t,userId:a.user_id,deviceId:a.device_id,accessToken:a.access_token};return f.r.instance.extensions.cryptoSetup.examineLoginResponse(a,m),m}var N=n("./src/utils/StorageManager.ts"),D=n("./src/utils/StorageAccess.ts"),M=n("./src/settings/SettingsStore.ts"),O=n("./src/settings/SettingLevel.ts"),L=n("./src/stores/ToastStore.ts"),U=n("./src/integrations/IntegrationManagers.ts"),F=n("./src/mjolnir/Mjolnir.ts"),V=n("./node_modules/matrix-js-sdk/src/crypto-api/index.ts"),B=n("./src/PosthogAnalytics.ts"),j=n("./src/components/views/toasts/GenericToast.tsx"),W=n("./src/dispatcher/actions.ts");const z="mx_snooze_bulk_unverified_device_nag",H="reviewsessions",K=e=>{L.A.sharedInstance().addOrReplaceToast({key:H,title:(0,l._t)("encryption|verification|unverified_sessions_toast_title"),icon:"verification_warning",props:{description:(0,l._t)("encryption|verification|unverified_sessions_toast_description"),primaryLabel:(0,l._t)("action|review"),onPrimaryClick:()=>{Je.sharedInstance().dismissUnverifiedSessions(e),S.A.dispatch({action:W.r.ViewUserDeviceSettings})},secondaryLabel:(0,l._t)("encryption|verification|unverified_sessions_toast_reject"),onSecondaryClick:()=>{Je.sharedInstance().dismissUnverifiedSessions(e),(()=>{try{localStorage.setItem(z,String(Date.now()))}catch(e){s.v.error("Failed to persist bulk unverified device nag snooze",e)}})()}},component:j.A,priority:50})};var J=n("./src/components/views/dialogs/BaseDialog.tsx"),G=n("./src/components/views/right_panel/EncryptionPanel.tsx");class $ extends i.Component{constructor(e){super(e),this.state={verificationRequest:this.props.verificationRequest}}componentDidMount(){var e;null===(e=this.props.verificationRequestPromise)||void 0===e||e.then((e=>{this.setState({verificationRequest:e})}))}render(){const e=this.state.verificationRequest,t=null==e?void 0:e.otherUserId,n=this.props.member||(t?_.J.safeGet().getUser(t):null),s=null!=e&&e.isSelfVerification?(0,l._t)("encryption|verification|verification_dialog_title_device"):(0,l._t)("encryption|verification|verification_dialog_title_user");return n?i.createElement(J.A,{className:"mx_InfoDialog",onFinished:this.props.onFinished,contentId:"mx_Dialog_content",title:s,hasCancel:!0},i.createElement(G.A,{layout:"dialog",verificationRequest:this.props.verificationRequest,verificationRequestPromise:this.props.verificationRequestPromise,onClose:this.props.onFinished,member:n,isRoomEncrypted:!1})):null}}var q=n("./node_modules/events/events.js"),Y=n.n(q),Q=n("./src/SecurityManager.ts"),X=n("./src/contexts/SDKContext.ts"),Z=n("./src/utils/arrays.ts"),ee=n("./src/utils/device/dehydration.ts");let te=function(e){return e[e.Loading=0]="Loading",e[e.Intro=1]="Intro",e[e.Busy=2]="Busy",e[e.Done=3]="Done",e[e.ConfirmSkip=4]="ConfirmSkip",e[e.Finished=5]="Finished",e[e.ConfirmReset=6]="ConfirmReset",e}({});class ne extends(Y()){constructor(...e){super(...e),(0,v.A)(this,"started",void 0),(0,v.A)(this,"phase",void 0),(0,v.A)(this,"verificationRequest",null),(0,v.A)(this,"backupInfo",null),(0,v.A)(this,"keyId",null),(0,v.A)(this,"keyInfo",null),(0,v.A)(this,"hasDevicesToVerifyAgainst",void 0),(0,v.A)(this,"onUserTrustStatusChanged",(async e=>{var t;if(e!==_.J.safeGet().getSafeUserId())return;await(null===(t=_.J.safeGet().getCrypto())||void 0===t?void 0:t.getCrossSigningKeyId())&&(this.phase=te.Done,this.emit("update"))})),(0,v.A)(this,"onVerificationRequest",(e=>{this.setActiveVerificationRequest(e)})),(0,v.A)(this,"onVerificationRequestChange",(async()=>{var e,t;if((null===(e=this.verificationRequest)||void 0===e?void 0:e.phase)===V.VerificationPhase.Cancelled)this.verificationRequest.off(V.VerificationRequestEvent.Change,this.onVerificationRequestChange),this.verificationRequest=null,this.emit("update");else if((null===(t=this.verificationRequest)||void 0===t?void 0:t.phase)===V.VerificationPhase.Done){var n;this.verificationRequest.off(V.VerificationRequestEvent.Change,this.onVerificationRequestChange),this.verificationRequest=null;const e=await(null===(n=_.J.safeGet().getCrypto())||void 0===n?void 0:n.getCrossSigningKeyId());this.phase=e?te.Done:te.Busy,this.emit("update")}}))}static sharedInstance(){return window.mxSetupEncryptionStore||(window.mxSetupEncryptionStore=new ne),window.mxSetupEncryptionStore}start(){if(this.started)return;this.started=!0,this.phase=te.Loading;const e=_.J.safeGet();e.on(V.CryptoEvent.VerificationRequestReceived,this.onVerificationRequest),e.on(V.CryptoEvent.UserTrustStatusChanged,this.onUserTrustStatusChanged);const t=e.getCrypto().getVerificationRequestsToDeviceInProgress(e.getUserId());t.length&&this.setActiveVerificationRequest(t[t.length-1]),this.fetchKeyInfo()}stop(){var e;if(!this.started)return;this.started=!1,null===(e=this.verificationRequest)||void 0===e||e.off(V.VerificationRequestEvent.Change,this.onVerificationRequestChange);const t=_.J.get();t&&(t.removeListener(V.CryptoEvent.VerificationRequestReceived,this.onVerificationRequest),t.removeListener(V.CryptoEvent.UserTrustStatusChanged,this.onUserTrustStatusChanged))}async fetchKeyInfo(){var e,t;if(!this.started)return;const n=_.J.safeGet(),i=await n.secretStorage.isStored("m.cross_signing.master");null===i||0===Object.keys(i).length?(this.keyId=null,this.keyInfo=null):(this.keyId=Object.keys(i)[0],this.keyInfo=i[this.keyId]);const s=n.getUserId(),o=n.getCrypto(),r=null!==(e=null===(t=(await o.getUserDeviceInfo([s])).get(s))||void 0===t?void 0:t.values())&&void 0!==e?e:[];this.hasDevicesToVerifyAgainst=await(0,Z.rm)(r,(async e=>{if(e.dehydrated)return!1;if(!e.getIdentityKey())return!1;const t=await o.getDeviceVerificationStatus(s,e.deviceId);return!(null==t||!t.signedByOwner)})),this.phase=te.Intro,this.emit("update")}async usePassPhrase(){s.v.debug("SetupEncryptionStore.usePassphrase"),this.phase=te.Busy,this.emit("update");try{var e,t,n;const i=_.J.safeGet(),o=null!==(e=await(null===(t=i.getCrypto())||void 0===t?void 0:t.getKeyBackupInfo()))&&void 0!==e?e:null;this.backupInfo=o,this.emit("update"),await new Promise(((e,t)=>{(0,Q.cb)((async()=>{var t,n;(s.v.debug("SetupEncryptionStore.usePassphrase: cross-signing and secret storage set up; checking dehydration and backup in the background"),e(),await(0,ee.b)(),o)&&(await(null===(t=i.getCrypto())||void 0===t?void 0:t.loadSessionBackupPrivateKeyFromSecretStorage()),await(null===(n=i.getCrypto())||void 0===n?void 0:n.restoreKeyBackup()))})).catch(t)})),await(null===(n=i.getCrypto())||void 0===n?void 0:n.getCrossSigningKeyId())&&(s.v.debug("SetupEncryptionStore.usePassphrase: done"),this.phase=te.Done,this.emit("update"))}catch(e){e instanceof Q.qQ?s.v.debug("SetupEncryptionStore.usePassphrase: user cancelled access to secret storage"):s.v.log("SetupEncryptionStore.usePassphrase: error",e),this.phase=te.Intro,this.emit("update")}}skip(){this.phase=te.ConfirmSkip,this.emit("update")}skipConfirm(){this.phase=te.Finished,this.emit("update")}returnAfterSkip(){this.phase=te.Intro,this.emit("update")}reset(){this.phase=te.ConfirmReset,this.emit("update")}async resetConfirm(){try{await(0,Q.cb)((async()=>{this.phase=te.Finished}),{forceReset:!0,resetCrossSigning:!0,accountPassword:X.M.instance.accountPasswordStore.getPassword()})}catch(e){s.v.error("Error resetting cross-signing",e),this.phase=te.Intro}this.emit("update")}returnAfterReset(){this.phase=te.Intro,this.emit("update")}done(){this.phase=te.Finished,this.emit("update")}async setActiveVerificationRequest(e){this.started&&e.otherUserId===_.J.safeGet().getUserId()&&(this.verificationRequest&&this.verificationRequest.off(V.VerificationRequestEvent.Change,this.onVerificationRequestChange),this.verificationRequest=e,await e.accept(),e.on(V.VerificationRequestEvent.Change,this.onVerificationRequestChange),this.emit("update"))}lostKeys(){return!this.hasDevicesToVerifyAgainst&&!this.keyInfo}}var ie=n("./src/components/views/elements/AccessibleButton.tsx"),se=n("./src/components/views/elements/Spinner.tsx");class oe extends i.Component{constructor(e){super(e),(0,v.A)(this,"onStoreUpdate",(()=>{const e=ne.sharedInstance();e.phase!==te.Finished?this.setState({phase:e.phase,verificationRequest:e.verificationRequest,backupInfo:e.backupInfo,lostKeys:e.lostKeys()}):this.props.onFinished()})),(0,v.A)(this,"onUsePassphraseClick",(async()=>{ne.sharedInstance().usePassPhrase()})),(0,v.A)(this,"onVerifyClick",(()=>{var e;const t=_.J.safeGet(),n=t.getSafeUserId(),i=t.getCrypto().requestOwnUserVerification();this.props.onFinished(),k.Ay.createDialog($,{verificationRequestPromise:i,member:null!==(e=t.getUser(n))&&void 0!==e?e:void 0,onFinished:async()=>{(await i).cancel(),this.props.onFinished()}})})),(0,v.A)(this,"onSkipConfirmClick",(()=>{ne.sharedInstance().skipConfirm()})),(0,v.A)(this,"onSkipBackClick",(()=>{ne.sharedInstance().returnAfterSkip()})),(0,v.A)(this,"onResetClick",(e=>{e.preventDefault();ne.sharedInstance().reset()})),(0,v.A)(this,"onResetConfirmClick",(()=>{this.props.onFinished();ne.sharedInstance().resetConfirm()})),(0,v.A)(this,"onResetBackClick",(()=>{ne.sharedInstance().returnAfterReset()})),(0,v.A)(this,"onDoneClick",(()=>{ne.sharedInstance().done()})),(0,v.A)(this,"onEncryptionPanelClose",(()=>{this.props.onFinished()}));const t=ne.sharedInstance();t.start(),this.state={phase:t.phase,verificationRequest:t.verificationRequest,backupInfo:t.backupInfo,lostKeys:t.lostKeys()}}componentDidMount(){ne.sharedInstance().on("update",this.onStoreUpdate)}componentWillUnmount(){const e=ne.sharedInstance();e.off("update",this.onStoreUpdate),e.stop()}render(){const e=_.J.safeGet(),{phase:t,lostKeys:n}=this.state;if(this.state.verificationRequest&&e.getUser(this.state.verificationRequest.otherUserId))return i.createElement(G.A,{layout:"dialog",verificationRequest:this.state.verificationRequest,onClose:this.onEncryptionPanelClose,member:e.getUser(this.state.verificationRequest.otherUserId),isRoomEncrypted:!1});if(t===te.Intro){if(n)return i.createElement("div",null,i.createElement("p",null,(0,l._t)("encryption|verification|no_key_or_device")),i.createElement("div",{className:"mx_CompleteSecurity_actionRow"},i.createElement(ie.A,{kind:"primary",onClick:this.onResetConfirmClick},(0,l._t)("encryption|verification|reset_proceed_prompt"))));{const e=ne.sharedInstance();let t,n,s;return e.keyInfo&&(o=e.keyInfo,Boolean(o.passphrase&&o.passphrase.salt&&o.passphrase.iterations))?t=(0,l._t)("encryption|verification|verify_using_key_or_phrase"):e.keyInfo&&(t=(0,l._t)("encryption|verification|verify_using_key")),t&&(n=i.createElement(ie.A,{kind:"primary",onClick:this.onUsePassphraseClick},t)),e.hasDevicesToVerifyAgainst&&(s=i.createElement(ie.A,{kind:"primary",onClick:this.onVerifyClick},(0,l._t)("encryption|verification|verify_using_device"))),i.createElement("div",null,i.createElement("p",null,(0,l._t)("encryption|verification|verification_description")),i.createElement("div",{className:"mx_CompleteSecurity_actionRow"},s,n),i.createElement("div",{className:"mx_SetupEncryptionBody_reset"},(0,l._t)("encryption|reset_all_button",void 0,{a:e=>i.createElement(ie.A,{kind:"link_inline",className:"mx_SetupEncryptionBody_reset_link",onClick:this.onResetClick},e)})))}}if(t===te.Done){let e;return e=this.state.backupInfo?i.createElement("p",null,(0,l._t)("encryption|verification|verification_success_with_backup")):i.createElement("p",null,(0,l._t)("encryption|verification|verification_success_without_backup")),i.createElement("div",null,i.createElement("div",{className:"mx_CompleteSecurity_heroIcon mx_E2EIcon_verified"}),e,i.createElement("div",{className:"mx_CompleteSecurity_actionRow"},i.createElement(ie.A,{kind:"primary",onClick:this.onDoneClick},(0,l._t)("action|done"))))}return t===te.ConfirmSkip?i.createElement("div",null,i.createElement("p",null,(0,l._t)("encryption|verification|verification_skip_warning")),i.createElement("div",{className:"mx_CompleteSecurity_actionRow"},i.createElement(ie.A,{kind:"danger_outline",onClick:this.onSkipConfirmClick},(0,l._t)("encryption|verification|verify_later")),i.createElement(ie.A,{kind:"primary",onClick:this.onSkipBackClick},(0,l._t)("action|go_back")))):t===te.ConfirmReset?i.createElement("div",null,i.createElement("p",null,(0,l._t)("encryption|verification|verify_reset_warning_1")),i.createElement("p",null,(0,l._t)("encryption|verification|verify_reset_warning_2")),i.createElement("div",{className:"mx_CompleteSecurity_actionRow"},i.createElement(ie.A,{kind:"danger_outline",onClick:this.onResetConfirmClick},(0,l._t)("encryption|verification|reset_proceed_prompt")),i.createElement(ie.A,{kind:"primary",onClick:this.onResetBackClick},(0,l._t)("action|go_back")))):t===te.Busy||t===te.Loading?i.createElement(se.A,null):void s.v.log(`SetupEncryptionBody: Unknown phase ${t}`);var o}}function re(e){return e===te.Done?n("./res/img/e2e/verified-deprecated.svg").A:n("./res/img/e2e/warning-deprecated.svg").A}class ae extends i.Component{constructor(e){super(e),(0,v.A)(this,"store",void 0),(0,v.A)(this,"onStoreUpdate",(()=>{this.setState({icon:re(this.store.phase)})})),this.store=ne.sharedInstance(),this.state={icon:re(this.store.phase)}}componentDidMount(){this.store.on("update",this.onStoreUpdate)}componentWillUnmount(){this.store.removeListener("update",this.onStoreUpdate)}render(){return i.createElement(J.A,{headerImage:this.state.icon,onFinished:this.props.onFinished,title:(0,l._t)("encryption|verify_toast_title")},i.createElement(oe,{onFinished:this.props.onFinished}))}}const le="setupencryption",ce=e=>{switch(e){case he.SET_UP_ENCRYPTION:return(0,l._t)("encryption|set_up_toast_title");case he.VERIFY_THIS_SESSION:return(0,l._t)("encryption|verify_toast_title")}},de=e=>{switch(e){case he.SET_UP_ENCRYPTION:return"secure_backup";case he.VERIFY_THIS_SESSION:return"verification_warning"}},me=e=>{switch(e){case he.SET_UP_ENCRYPTION:return(0,l._t)("action|continue");case he.VERIFY_THIS_SESSION:return(0,l._t)("action|verify")}},ue=e=>{switch(e){case he.SET_UP_ENCRYPTION:return(0,l._t)("encryption|set_up_toast_description");case he.VERIFY_THIS_SESSION:return(0,l._t)("encryption|verify_toast_description")}};let he=function(e){return e.SET_UP_ENCRYPTION="set_up_encryption",e.VERIFY_THIS_SESSION="verify_this_session",e}({});const pe=()=>{Je.sharedInstance().dismissEncryptionSetup()},ge=e=>{if(f.r.instance.extensions.cryptoSetup.setupEncryptionNeeded({kind:e,storeProvider:{getInstance:()=>ne.sharedInstance()}}))return;L.A.sharedInstance().addOrReplaceToast({key:le,title:ce(e),icon:de(e),props:{description:ue(e),primaryLabel:me(e),onPrimaryClick:async()=>{if(e===he.VERIFY_THIS_SESSION)k.Ay.createDialog(ae,{},void 0,!1,!0);else{const e=k.Ay.createDialog(se.A,void 0,"mx_Dialog_spinner",!1,!0);try{await(0,Q.cb)()}finally{e.close()}}},secondaryLabel:(0,l._t)("encryption|verification|unverified_sessions_toast_reject"),onSecondaryClick:pe,destructive:"secondary"},component:j.A,priority:e===he.VERIFY_THIS_SESSION?95:40})},ve=()=>{L.A.sharedInstance().dismissToast(le)},_e=async(e,t)=>{var n;const i=await(null===(n=e.getCrypto())||void 0===n?void 0:n.getDeviceVerificationStatus(e.getSafeUserId(),t));return i?i.crossSigningVerified:null};var fe,Ee=n("./src/utils/device/parseUserAgent.ts");function ye(){return ye=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},ye.apply(null,arguments)}var be=function(e,t){return i.createElement("svg",ye({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 8 14",role:"presentation","aria-hidden":!0,ref:t},e),fe||(fe=i.createElement("path",{fill:"currentColor",d:"M1.333.333C.6.333 0 .933 0 1.666l.007 2.12c0 .354.14.687.386.94L2.667 7 .393 9.286a1.33 1.33 0 0 0-.386.94L0 12.333c0 .733.6 1.333 1.333 1.333h5.334c.733 0 1.333-.6 1.333-1.333v-2.107c0-.353-.14-.693-.387-.94L5.333 7l2.274-2.267C7.86 4.48 8 4.14 8 3.786v-2.12C8 .933 7.4.333 6.667.333zm5.334 9.94v1.393c0 .367-.3.667-.667.667H2a.67.67 0 0 1-.667-.667v-1.393c0-.18.074-.347.194-.473L4 7.333l2.473 2.473c.12.12.194.294.194.467"})))},we=(0,i.forwardRef)(be);let Se=function(e){return e.Verified="Verified",e.Unverified="Unverified",e.Inactive="Inactive",e.Unverifiable="Unverifiable",e}({});const Ae=7776e6,Ce=e=>!!e.last_seen_ts&&e.last_seen_ts<Date.now()-Ae,xe={[Se.Verified]:e=>!!e.isVerified,[Se.Unverified]:e=>!e.isVerified,[Se.Inactive]:Ce},ke=(e,t)=>{const n=t.map((e=>xe[e]));return n.length?e.filter((e=>n.every((t=>t(e))))):e};var Re=n("./src/DateUtils.ts");const Ie=(e,t=(new Date).getTime())=>{if(e+5184e5>=t){const t=new Date(e);return(0,Re.Yq)(t)}return(0,Re.fw)(new Date(e))},Te=({value:e,id:t})=>e?i.createElement("span",null,e):null,Pe=({device:e})=>{const t=(e=>{if(Ce(e)&&e.last_seen_ts)return{id:"inactive",value:i.createElement(i.Fragment,null,i.createElement(we,{className:"mx_DeviceTile_inactiveIcon"}),(0,l._t)("settings|sessions|inactive_days",{inactiveAgeDays:90})+` (${Ie(e.last_seen_ts)})`)}})(e),n=e.last_seen_ts&&`${(0,l._t)("settings|sessions|last_activity")} ${Ie(e.last_seen_ts)}`,s=e.isVerified?(0,l._t)("common|verified"):(0,l._t)("common|unverified"),o=t?[t,{id:"lastSeenIp",value:e.last_seen_ip}]:[{id:"isVerified",value:s},{id:"lastActivity",value:n},{id:"lastSeenIp",value:e.last_seen_ip},{id:"deviceId",value:e.device_id}];return i.createElement(i.Fragment,null,o.map((({id:e,value:t},n)=>t?i.createElement(i.Fragment,{key:e},!!n&&" · ",i.createElement(Te,{id:e,value:t})):null)))};function Ne(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function De(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ne(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ne(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Me(e){return"unverified_session_"+e}const Oe=async e=>{const t=_.J.safeGet(),n=await t.getDevice(e),s=De(De({},n),{},{isVerified:await _e(t,e),deviceType:Ee.b.Unknown});L.A.sharedInstance().addOrReplaceToast({key:Me(e),title:(0,l._t)("encryption|verification|unverified_session_toast_title"),icon:"verification_warning",props:{description:n.display_name,detail:i.createElement(Pe,{device:s}),primaryLabel:(0,l._t)("encryption|verification|unverified_session_toast_accept"),onPrimaryClick:()=>{Je.sharedInstance().dismissUnverifiedSessions([e])},secondaryLabel:(0,l._t)("action|no"),onSecondaryClick:()=>{Je.sharedInstance().dismissUnverifiedSessions([e]),S.A.dispatch({action:W.r.ViewUserDeviceSettings})},destructive:"secondary"},component:j.A,priority:80})},Le=e=>{L.A.sharedInstance().dismissToast(Me(e))};var Ue=n("./src/utils/WellKnownUtils.ts"),Fe=n("./src/Views.ts");const Ve="io.element.matrix_client_information.",Be=e=>`${Ve}${e}`,je=async(e,t,n)=>{const i=e.getDeviceId(),{brand:s}=t,o=await(null==n?void 0:n.getAppVersion()),r=Be(i),a=(()=>{if(window.electron)return;const e=new URL(window.location.href);return[e.host,e.pathname.replace(/\/$/,"")].join("")})();await e.setAccountData(r,{name:s,version:o,url:a})},We=e=>e&&"string"==typeof e?e:void 0,ze=(e,t)=>{const n=e.getAccountData(Be(t));if(!n)return{};const{name:i,version:s,url:o}=n.getContent();return{name:We(i),version:We(s),url:We(o)}};var He=n("./src/settings/UIFeature.ts"),Ke=n("./src/utils/crypto/deviceInfo.ts");class Je{constructor(){(0,v.A)(this,"dispatcherRef",void 0),(0,v.A)(this,"dismissed",new Set),(0,v.A)(this,"dismissedThisDeviceToast",!1),(0,v.A)(this,"keyBackupInfo",null),(0,v.A)(this,"keyBackupFetchedAt",null),(0,v.A)(this,"ourDeviceIdsAtStart",null),(0,v.A)(this,"displayingToastsForDeviceIds",new Set),(0,v.A)(this,"running",!1),(0,v.A)(this,"client",void 0),(0,v.A)(this,"shouldRecordClientInformation",!1),(0,v.A)(this,"enableBulkUnverifiedSessionsReminder",!0),(0,v.A)(this,"deviceClientInformationSettingWatcherRef",void 0),(0,v.A)(this,"analyticsVerificationState",void 0),(0,v.A)(this,"analyticsRecoveryState",void 0),(0,v.A)(this,"onDevicesUpdated",(async(e,t)=>{if(!this.client)return;if(t)return;const n=this.client.getSafeUserId();e.includes(n)&&await this.ensureDeviceIdsAtStartPopulated(),this.recheck()})),(0,v.A)(this,"onUserTrustStatusChanged",(e=>{this.client&&e===this.client.getUserId()&&this.recheck()})),(0,v.A)(this,"onCrossSingingKeysChanged",(()=>{this.recheck()})),(0,v.A)(this,"onAccountData",(e=>{(e.getType().startsWith("m.secret_storage.")||e.getType().startsWith("m.cross_signing.")||"m.megolm_backup.v1"===e.getType())&&this.recheck()})),(0,v.A)(this,"onSync",((e,t)=>{"PREPARED"===e&&null===t&&this.recheck()})),(0,v.A)(this,"onRoomStateEvents",(e=>{e.getType()===o.EventType.RoomEncryption&&this.recheck()})),(0,v.A)(this,"onAction",(({action:e})=>{e===W.r.OnLoggedIn&&(this.recheck(),this.updateClientInformation())})),(0,v.A)(this,"checkKeyBackupStatus",(async()=>{var e;if(this.keyBackupStatusChecked||!this.client)return;const t=await(null===(e=this.client.getCrypto())||void 0===e?void 0:e.getActiveSessionBackupVersion());this.keyBackupStatusChecked=!!t,t||S.A.dispatch({action:W.r.ReportKeyBackupNotEnabled})})),(0,v.A)(this,"keyBackupStatusChecked",!1),(0,v.A)(this,"onRecordClientInformationSettingChange",((e,t,n,i,s)=>{const o=this.shouldRecordClientInformation;this.shouldRecordClientInformation=!!s,this.shouldRecordClientInformation!==o&&this.updateClientInformation()})),(0,v.A)(this,"updateClientInformation",(async()=>{if(this.client)try{var e;if(this.shouldRecordClientInformation)await je(this.client,c.Ay.get(),null!==(e=a.A.get())&&void 0!==e?e:void 0);else await(async e=>{const t=e.getDeviceId(),n=Be(t),i=ze(e,t);(i.name||i.version||i.url)&&await e.deleteAccountData(n)})(this.client)}catch(e){s.v.error("Failed to update client information",e)}}))}static sharedInstance(){return window.mxDeviceListener||(window.mxDeviceListener=new Je),window.mxDeviceListener}start(e){this.running=!0,this.client=e,this.client.on(V.CryptoEvent.DevicesUpdated,this.onDevicesUpdated),this.client.on(V.CryptoEvent.UserTrustStatusChanged,this.onUserTrustStatusChanged),this.client.on(V.CryptoEvent.KeysChanged,this.onCrossSingingKeysChanged),this.client.on(o.ClientEvent.AccountData,this.onAccountData),this.client.on(o.ClientEvent.Sync,this.onSync),this.client.on(o.RoomStateEvent.Events,this.onRoomStateEvents),this.shouldRecordClientInformation=M.A.getValue("deviceClientInformationOptIn"),this.enableBulkUnverifiedSessionsReminder=M.A.getValue(He.f.BulkUnverifiedSessionsReminder),this.deviceClientInformationSettingWatcherRef=M.A.watchSetting("deviceClientInformationOptIn",null,this.onRecordClientInformationSettingChange),this.dispatcherRef=S.A.register(this.onAction),this.recheck(),this.updateClientInformation()}stop(){this.running=!1,this.client&&(this.client.removeListener(V.CryptoEvent.DevicesUpdated,this.onDevicesUpdated),this.client.removeListener(V.CryptoEvent.UserTrustStatusChanged,this.onUserTrustStatusChanged),this.client.removeListener(V.CryptoEvent.KeysChanged,this.onCrossSingingKeysChanged),this.client.removeListener(o.ClientEvent.AccountData,this.onAccountData),this.client.removeListener(o.ClientEvent.Sync,this.onSync),this.client.removeListener(o.RoomStateEvent.Events,this.onRoomStateEvents)),M.A.unwatchSetting(this.deviceClientInformationSettingWatcherRef),S.A.unregister(this.dispatcherRef),this.dispatcherRef=void 0,this.dismissed.clear(),this.dismissedThisDeviceToast=!1,this.keyBackupInfo=null,this.keyBackupFetchedAt=null,this.keyBackupStatusChecked=!1,this.ourDeviceIdsAtStart=null,this.displayingToastsForDeviceIds=new Set,this.client=void 0}async dismissUnverifiedSessions(e){s.v.log("Dismissing unverified sessions: "+Array.from(e).join(","));for(const t of e)this.dismissed.add(t);this.recheck()}dismissEncryptionSetup(){this.dismissedThisDeviceToast=!0,this.recheck()}async ensureDeviceIdsAtStartPopulated(){null===this.ourDeviceIdsAtStart&&(this.ourDeviceIdsAtStart=await this.getDeviceIds())}async getDeviceIds(){const e=this.client;return e?await(0,Ke.a)(e,e.getSafeUserId()):new Set}async getKeyBackupInfo(){if(!this.client)return null;const e=(new Date).getTime(),t=this.client.getCrypto();return t?((!this.keyBackupInfo||!this.keyBackupFetchedAt||this.keyBackupFetchedAt<e-3e5)&&(this.keyBackupInfo=await t.getKeyBackupInfo(),this.keyBackupFetchedAt=e),this.keyBackupInfo):null}async shouldShowSetupEncryptionToast(){if((0,Q.kq)())return!1;const e=this.client,t=null==e?void 0:e.getCrypto();return!(!e||!t)&&await(0,Z.qM)(e.getRooms(),(({roomId:e})=>t.isEncryptionEnabledInRoom(e)))}recheck(){this.doRecheck().catch((e=>{e instanceof o.ClientStoppedError||s.v.error("Error during `DeviceListener.recheck`",e)}))}async doRecheck(){var e;if(!this.running||!this.client)return;const t=this.client;if(!await t.isVersionSupported("v1.1"))return;const n=t.getCrypto();if(!n)return;if(!t.isInitialSyncComplete())return;const i=await n.isCrossSigningReady(),o=await n.isSecretStorageReady(),r=i&&o;var a;await this.reportCryptoSessionStateToAnalytics(t),this.dismissedThisDeviceToast||r?(ve(),this.checkKeyBackupStatus()):await this.shouldShowSetupEncryptionToast()&&(await n.getUserDeviceInfo([t.getSafeUserId()]),!await n.getCrossSigningKeyId()&&await n.userHasCrossSigningKeys()?(ge(he.VERIFY_THIS_SESSION),this.checkKeyBackupStatus()):(await t.waitForClientWellKnown(),(0,Ue.R$)(t)&&(null===(a=window.matrixChat)||void 0===a?void 0:a.state.view)===Fe.A.LOGGED_IN?(ve(),(0,Q.cb)()):ge(he.SET_UP_ENCRYPTION))),await this.ensureDeviceIdsAtStartPopulated();const l=new Set,c=new Set,d=i&&Boolean(null===(e=await n.getDeviceVerificationStatus(t.getSafeUserId(),t.deviceId))||void 0===e?void 0:e.crossSigningVerified);if(i){const e=await this.getDeviceIds();for(const i of e){if(i===t.deviceId)continue;const e=await n.getDeviceVerificationStatus(t.getSafeUserId(),i);var m;if(!(null!=e&&e.crossSigningVerified||this.dismissed.has(i)))null!==(m=this.ourDeviceIdsAtStart)&&void 0!==m&&m.has(i)?l.add(i):c.add(i)}}s.v.debug("Old unverified sessions: "+Array.from(l).join(",")),s.v.debug("New unverified sessions: "+Array.from(c).join(",")),s.v.debug("Currently showing toasts for: "+Array.from(this.displayingToastsForDeviceIds).join(","));const u=(()=>{try{const e=localStorage.getItem(z),t=Number.parseInt(e||"",10);return Number.isInteger(t)&&t+6048e5>Date.now()}catch{return!1}})();l.size>0&&d&&this.enableBulkUnverifiedSessionsReminder&&!u?K(l):L.A.sharedInstance().dismissToast(H);for(const e of c)Oe(e);for(const e of this.displayingToastsForDeviceIds)c.has(e)||(s.v.debug("Hiding unverified session toast for "+e),Le(e));this.displayingToastsForDeviceIds=c}async reportCryptoSessionStateToAnalytics(e){const t=e.getCrypto(),n=await t.isSecretStorageReady(),i=await t.getCrossSigningStatus(),s=await this.getKeyBackupInfo(),o=null!=await e.secretStorage.getDefaultKeyId(),r=await t.getDeviceVerificationStatus(e.getUserId(),e.getDeviceId()),a=null!=r&&r.signedByOwner&&null!=r&&r.crossSigningVerified?"Verified":"NotVerified";let l;if(o){const e=i.privateKeysCachedLocally.masterKey&&i.privateKeysCachedLocally.selfSigningKey&&i.privateKeysCachedLocally.userSigningKey;if(null!=s){const i=null!=await t.getSessionBackupPrivateKey();l=n&&e&&i?"Enabled":"Incomplete"}else l=n&&e?"Enabled":"Incomplete"}else l="Disabled";this.analyticsVerificationState===a&&this.analyticsRecoveryState===l||(this.analyticsRecoveryState=l,this.analyticsVerificationState=a,B.Vo.instance.setProperty("recoveryState",l),B.Vo.instance.setProperty("verificationState",a),B.Vo.instance.trackEvent({eventName:"CryptoSessionState",verificationState:a,recoveryState:l}))}}var Ge=n("./src/widgets/Jitsi.ts"),$e=n("./src/BasePlatform.ts"),qe=n("./node_modules/rfc4648/lib/rfc4648.js"),Ye=n("./node_modules/buffer/index.js").hp;function Qe(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}const Xe="mx_threepid_invite_";class Ze extends(Y()){static get instance(){return Ze._instance||(Ze._instance=new Ze),Ze._instance}storeInvite(e,t){const n=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Qe(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Qe(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({roomId:e},t),i=this.generateIdOf(n);return localStorage.setItem(`${Xe}${i}`,JSON.stringify(n)),this.translateInvite(n)}getWireInvites(){const e=[];for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);if(null!=n&&n.startsWith(Xe))try{e.push(JSON.parse(localStorage.getItem(n)))}catch(e){console.warn("Failed to parse 3pid invite",e)}}return e}getInvites(){return this.getWireInvites().map((e=>this.translateInvite(e)))}pickBestInvite(){return this.getInvites()[0]}resolveInvite(e){localStorage.removeItem(`${Xe}${e.id}`)}generateIdOf(e){return qe.RG.stringify(Ye.from(JSON.stringify(e)))}translateInvite(e){return{id:this.generateIdOf(e),roomId:e.roomId,toEmail:e.email,signUrl:e.signurl,roomName:e.room_name,roomAvatarUrl:e.room_avatar_url,inviterName:e.inviter_name}}translateToWireFormat(e){return{email:e.toEmail,signurl:e.signUrl,room_name:e.roomName,room_avatar_url:e.roomAvatarUrl,inviter_name:e.inviterName}}}(0,v.A)(Ze,"_instance",void 0);var et=n("./src/LegacyCallHandler.tsx");const tt={};var nt=n("./src/components/views/dialogs/ErrorDialog.tsx"),it=n("./src/components/views/dialogs/QuestionDialog.tsx"),st=n("./src/components/views/dialogs/BugReportDialog.tsx"),ot=n("./src/components/views/elements/DialogButtons.tsx");class rt extends i.Component{constructor(...e){super(...e),(0,v.A)(this,"sendBugReport",(()=>{k.Ay.createDialog(st.A,{error:this.props.error})})),(0,v.A)(this,"onClearStorageClick",(()=>{k.Ay.createDialog(it.A,{title:(0,l._t)("action|sign_out"),description:i.createElement("div",null,(0,l._t)("error|session_restore|clear_storage_description")),button:(0,l._t)("action|sign_out"),danger:!0,onFinished:this.props.onFinished})})),(0,v.A)(this,"onRefreshClick",(()=>{window.location.reload()}))}render(){const e=c.Ay.get().brand,t=i.createElement("button",{onClick:this.onClearStorageClick,className:"danger"},(0,l._t)("error|session_restore|clear_storage_button"));let n;return n=c.Ay.get().bug_report_endpoint_url?i.createElement(ot.A,{primaryButton:(0,l._t)("bug_reporting|send_logs"),onPrimaryButtonClick:this.sendBugReport,focus:!0,hasCancel:!1},t):i.createElement(ot.A,{primaryButton:(0,l._t)("action|refresh"),onPrimaryButtonClick:this.onRefreshClick,focus:!0,hasCancel:!1},t),i.createElement(J.A,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:(0,l._t)("error|session_restore|title"),contentId:"mx_Dialog_content",hasCancel:!1},i.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},i.createElement("p",null,(0,l._t)("error|session_restore|description_1")),i.createElement("p",null,(0,l._t)("error|session_restore|description_2",{brand:e})),i.createElement("p",null,(0,l._t)("error|session_restore|description_3"))),n)}}class at extends i.Component{constructor(...e){super(...e),(0,v.A)(this,"sendBugReport",(e=>{e.preventDefault(),k.Ay.createDialog(st.A,{})})),(0,v.A)(this,"onSignOutClick",(()=>{this.props.onFinished(!0)}))}render(){let e;return c.Ay.get().bug_report_endpoint_url&&(e=(0,l._t)("bug_reporting|log_request",{},{a:e=>i.createElement(ie.A,{kind:"link_inline",onClick:this.sendBugReport},e)})),i.createElement(J.A,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:(0,l._t)("error|storage_evicted_title"),contentId:"mx_Dialog_content",hasCancel:!1},i.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},i.createElement("p",null,(0,l._t)("error|storage_evicted_description_1")),i.createElement("p",null,(0,l._t)("error|storage_evicted_description_2")," ",e)),i.createElement(ot.A,{primaryButton:(0,l._t)("action|sign_out"),onPrimaryButtonClick:this.onSignOutClick,focus:!0,hasCancel:!1}))}}var lt=n("./src/sentry.ts"),ct=n("./node_modules/classnames/index.js"),dt=n.n(ct),mt=n("./src/components/views/dialogs/RoomSettingsDialog.tsx"),ut=n("./node_modules/matrix-js-sdk/src/types.ts"),ht=n("./node_modules/@vector-im/compound-design-tokens/icons/overflow-horizontal.svg"),pt=n("./src/hooks/useSettings.ts"),gt=n("./src/settings/enums/Layout.ts"),vt=n("./src/Avatar.ts"),_t=n("./node_modules/@babel/runtime/helpers/esm/extends.js"),ft=n("./node_modules/matrix-js-sdk/src/webrtc/call.ts"),Et=n("./node_modules/@vector-im/compound-web/dist/components/Tooltip/Tooltip.js"),yt=n("./src/utils/permalinks/Permalinks.ts"),bt=n("./src/utils/FormattingUtils.ts"),wt=n("./src/customisations/UserIdentifier.ts");class St extends i.Component{render(){const{fallbackName:e,member:t,colored:n,emphasizeDisplayName:s,withTooltip:o,onClick:r}=this.props,a=(null==t?void 0:t.rawDisplayName)||e,c=null==t?void 0:t.userId;let d,m,u;if(n&&(d=(0,bt.yJ)(null!=c?c:"")),c){var h,p;const e=null!==(h=null===(p=wt.A.getDisplayUserIdentifier)||void 0===p?void 0:p.call(wt.A,c,{withDisplayName:!0,roomId:t.roomId}))&&void 0!==h?h:c;null!=t&&t.disambiguate&&(m=i.createElement("span",{className:"mx_DisambiguatedProfile_mxid"},e)),u=(0,l._t)("timeline|disambiguated_profile",{displayName:a,matrixId:e})}const g=dt()(d,{mx_DisambiguatedProfile_displayName:s});return i.createElement("div",{className:"mx_DisambiguatedProfile",title:o?u:void 0,onClick:r},i.createElement("span",{className:g,dir:"auto"},a),m)}}var At=n("./src/hooks/room/useRoomMemberProfile.ts");function Ct({mxEvent:e,onClick:t,withTooltip:n}){var s;const r=(0,At.s)({userId:e.getSender(),member:e.sender});return e.getContent().msgtype!==o.MsgType.Emote?i.createElement(St,{fallbackName:null!==(s=e.getSender())&&void 0!==s?s:"",onClick:t,member:r,colored:!0,emphasizeDisplayName:!0,withTooltip:n}):i.createElement(i.Fragment,null)}var xt=n("./src/components/views/messages/MImageBody.tsx");class kt extends xt.A{constructor(...e){super(...e),(0,v.A)(this,"onClick",(e=>{e.preventDefault()}))}wrapImage(e,t){return t}render(){if(this.state.error)return super.render();const e=this.props.mxEvent.getContent(),t=this.state.contentUrl?this.messageContent(this.state.contentUrl,this.state.thumbUrl,e,44):void 0;return i.createElement("div",{className:"mx_MImageReplyBody"},t)}}var Rt=n("./src/utils/EventUtils.ts"),It=n("./src/events/EventTileFactory.tsx"),Tt=n("./src/models/Call.ts"),Pt=n("./src/voice-broadcast/index.ts");function Nt(e,t,n,i){const s=t.getContent(),r=s.msgtype,a=t.getType();let l=!1;if(M.A.getValue("feature_msc3531_hide_messages_pending_moderation"))switch((0,Rt.$k)(t,e)){case Rt.H3.VISIBLE_FOR_ALL:case Rt.H3.HIDDEN_TO_CURRENT_USER:break;case Rt.H3.SEE_THROUGH_FOR_CURRENT_USER:l=!0}let c=(0,It.Sj)(t,e,n),d=a.startsWith("m.key.verification")||a===o.EventType.RoomMessage&&(null==r?void 0:r.startsWith("m.key.verification"))||a===o.EventType.RoomCreate||a===o.EventType.RoomEncryption||c===It.ur;const m=!d&&(a===o.EventType.CallInvite||Tt.Ho.CALL_EVENT_TYPE.matches(a));let u=((e,t,n,i)=>!(n||i||e===o.EventType.RoomMessage||e===o.EventType.RoomMessageEncrypted||e===o.EventType.Sticker||e===o.EventType.RoomCreate||o.M_POLL_START.matches(e)||o.M_POLL_END.matches(e)||o.M_BEACON_INFO.matches(e)||e===Pt.I$&&(null==t?void 0:t.state)===Pt.HF.Started))(a,s,d,m);const h=a===o.EventType.RoomMessage&&r===o.MsgType.Emote||o.M_POLL_START.matches(a)||o.M_BEACON_INFO.matches(a)||(0,Rt.wq)(t)||a===Pt.I$;return!i&&(0,It.bN)(t,e,n)||(c=(0,It.Sj)(t,e,n,!0),c===It.DD&&(d=!1,u=!0)),{hasRenderer:!!c,isInfoMessage:u,isBubbleMessage:d,isLeftAlignedBubbleMessage:m,noBubbleEvent:h,isSeeingThroughMessageHiddenForModeration:l}}var Dt=n("./src/components/views/messages/MFileBody.tsx"),Mt=n("./src/components/views/avatars/MemberAvatar.tsx"),Ot=n("./src/components/views/messages/MVoiceMessageBody.tsx");function Lt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Ut(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Lt(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Lt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class Ft extends i.PureComponent{constructor(...e){super(...e),(0,v.A)(this,"anchorElement",(0,i.createRef)()),(0,v.A)(this,"onDecrypted",(()=>{this.forceUpdate(),this.props.onHeightChanged&&this.props.onHeightChanged()})),(0,v.A)(this,"onEventRequiresUpdate",(()=>{this.forceUpdate()})),(0,v.A)(this,"onClick",(e=>{const t=e.target;"a"===t.tagName.toLowerCase()&&null!==t.closest("a")&&t!==this.anchorElement.current||(e.preventDefault(),this.props.toggleExpandedQuote&&e.shiftKey?this.props.toggleExpandedQuote():S.A.dispatch({action:W.r.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:void 0}))}))}componentDidMount(){this.props.mxEvent.on(o.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.on(o.MatrixEventEvent.BeforeRedaction,this.onEventRequiresUpdate),this.props.mxEvent.on(o.MatrixEventEvent.Replaced,this.onEventRequiresUpdate)}componentWillUnmount(){this.props.mxEvent.removeListener(o.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.removeListener(o.MatrixEventEvent.BeforeRedaction,this.onEventRequiresUpdate),this.props.mxEvent.removeListener(o.MatrixEventEvent.Replaced,this.onEventRequiresUpdate)}render(){const e=this.props.mxEvent,t=e.getContent().msgtype,n=e.getType(),{hasRenderer:r,isInfoMessage:a,isSeeingThroughMessageHiddenForModeration:c}=Nt(_.J.safeGet(),e,!1);if(!r){const{mxEvent:e}=this.props;return s.v.warn(`Event type not supported: type:${e.getType()} isState:${e.isState()}`),i.createElement("div",{className:"mx_ReplyTile mx_ReplyTile_info mx_MNoticeBody"},(0,l._t)("timeline|error_no_renderer"))}const d=dt()("mx_ReplyTile",{mx_ReplyTile_inline:t===o.MsgType.Emote,mx_ReplyTile_info:a&&!e.isRedacted(),mx_ReplyTile_audio:t===o.MsgType.Audio,mx_ReplyTile_video:t===o.MsgType.Video});let m,u="#";this.props.permalinkCreator&&(u=this.props.permalinkCreator.forEvent(e.getId()));a||n===o.EventType.RoomCreate||(m=i.createElement("div",{className:"mx_ReplyTile_sender"},i.createElement(Mt.A,{member:e.sender,fallbackUserId:e.getSender(),size:"16px"}),i.createElement(Ct,{mxEvent:e})));const h={[o.MsgType.Image]:kt,[o.MsgType.Audio]:(0,Rt.Mp)(e)?Ot.A:Dt.Ay,[o.MsgType.Video]:Dt.Ay},p={[o.EventType.Sticker]:kt};return i.createElement("div",{className:d},i.createElement("a",{href:u,onClick:this.onClick,ref:this.anchorElement},m,(0,It.BP)(Ut(Ut({},this.props),{},{ref:void 0,showUrlPreview:!1,overrideBodyTypes:h,overrideEventTypes:p,maxImageHeight:96,isSeeingThroughMessageHiddenForModeration:c,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),!1)))}}(0,v.A)(Ft,"defaultProps",{onHeightChanged:()=>{}});var Vt=n("./src/components/views/elements/Pill.tsx"),Bt=n("./src/utils/Reply.ts"),jt=n("./src/contexts/RoomContext.ts");class Wt extends i.Component{constructor(e,t){super(e,t),(0,v.A)(this,"unmounted",!1),(0,v.A)(this,"room",void 0),(0,v.A)(this,"blockquoteRef",i.createRef()),(0,v.A)(this,"canCollapse",(()=>this.state.events.length>1)),(0,v.A)(this,"collapse",(()=>{this.initialize()})),(0,v.A)(this,"onQuoteClick",(async()=>{if(!this.state.loadedEv)return;const e=[this.state.loadedEv,...this.state.events];let t=null;e.length>0&&(t=await this.getNextEvent(e[0])),this.setState({loadedEv:t,events:e}),S.A.fire(W.r.FocusSendMessageComposer)})),this.state={events:[],loadedEv:null,loading:!0,err:!1},this.room=this.matrixClient.getRoom(this.props.parentEv.getRoomId())}get matrixClient(){return _.J.safeGet()}componentDidMount(){this.unmounted=!1,this.initialize(),this.trySetExpandableQuotes()}componentDidUpdate(){var e,t;null===(e=(t=this.props).onHeightChanged)||void 0===e||e.call(t),this.trySetExpandableQuotes()}componentWillUnmount(){this.unmounted=!0}trySetExpandableQuotes(){if(void 0===this.props.isQuoteExpanded&&this.blockquoteRef.current){const e=this.blockquoteRef.current.querySelector(".mx_EventTile_body");if(e){const t=e.querySelector("code"),n=!!t&&t.offsetHeight>=60;(e.offsetHeight>=60||n)&&this.props.setQuoteExpanded(!1)}}}async initialize(){const{parentEv:e}=this.props,t=await this.getEvent((0,Bt.Ul)(e));if(!this.unmounted)if(t){const e=await this.getNextEvent(t);this.setState({events:[t],loadedEv:e,loading:!1})}else this.setState({err:!0})}async getNextEvent(e){try{const t=(0,Bt.Ul)(e);return t?await this.getEvent(t):null}catch{return null}}async getEvent(e){var t;if(!e)return null;const n=this.room.findEventById(e);if(n)return n;try{await this.matrixClient.getEventTimeline(this.room.getUnfilteredTimelineSet(),e)}catch{return null}return null!==(t=this.room.findEventById(e))&&void 0!==t?t:null}getReplyChainColorClass(e){return(0,bt.yJ)(e.getSender()).replace("Username","ReplyChain")}render(){let e;if(this.state.err)e=i.createElement("blockquote",{className:"mx_ReplyChain mx_ReplyChain_error"},(0,l._t)("timeline|reply|error_loading"));else if(this.state.loadedEv&&(0,Bt.c$)(this.state.events[0])){const t=this.state.loadedEv,n=this.matrixClient.getRoom(t.getRoomId());e=i.createElement("blockquote",{className:`mx_ReplyChain ${this.getReplyChainColorClass(t)}`},(0,l._t)("timeline|reply|in_reply_to",{},{a:e=>i.createElement(ie.A,{kind:"link_inline",className:"mx_ReplyChain_show",onClick:this.onQuoteClick},e),pill:i.createElement(Vt.ab,{type:Vt.yL.UserMention,room:null!=n?n:void 0,url:(0,yt.Ne)(t.getSender()),shouldShowPillAvatar:M.A.getValue("Pill.shouldShowPillAvatar")})}))}else if(this.props.forExport){const t=(0,Bt.Ul)(this.props.parentEv);e=i.createElement("p",{className:"mx_ReplyChain_Export"},(0,l._t)("timeline|reply|in_reply_to_for_export",{},{a:e=>i.createElement("a",{className:"mx_reply_anchor",href:`#${t}`,"data-scroll-to":t}," ",e," ")}))}else this.state.loading&&(e=i.createElement(se.A,{w:16,h:16}));const{isQuoteExpanded:t}=this.props,n=this.state.events.map((e=>{const n=dt()({mx_ReplyChain:!0,[this.getReplyChainColorClass(e)]:!0,"mx_ReplyChain--expanded":!0===t,"mx_ReplyChain--collapsed":!1===t});return i.createElement("blockquote",{ref:this.blockquoteRef,className:n,key:e.getId()},i.createElement(Ft,{mxEvent:e,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator,toggleExpandedQuote:()=>this.props.setQuoteExpanded(!this.props.isQuoteExpanded),getRelationsForEvent:this.props.getRelationsForEvent}))}));return i.createElement("div",{className:"mx_ReplyChain_wrapper"},i.createElement("div",null,e),i.createElement("div",null,n))}}(0,v.A)(Wt,"contextType",jt.Ay);var zt,Ht=n("./src/components/views/messages/DecryptionFailureBody.tsx"),Kt=n("./src/components/views/avatars/RoomAvatar.tsx"),Jt=n("./src/components/views/context_menus/MessageContextMenu.tsx"),Gt=n("./src/components/structures/ContextMenu.tsx"),$t=n("./src/utils/objects.ts"),qt=n("./src/stores/notifications/StaticNotificationState.ts"),Yt=n("./src/components/views/rooms/NotificationBadge.tsx"),Qt=n("./src/components/views/messages/MessageTimestamp.tsx"),Xt=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/overflow-horizontal.js"),Zt=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/threads.js"),en=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/unpin.js"),tn=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/pin.js"),nn=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/delete.js"),sn=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/restart.js"),on=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/reply.js");function rn(){return rn=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},rn.apply(null,arguments)}var an=function(e,t){return i.createElement("svg",rn({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0,ref:t},e),zt||(zt=i.createElement("path",{stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M3 14h12M5 10.5l7-7"})))},ln=(0,i.forwardRef)(an);var cn;function dn(){return dn=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},dn.apply(null,arguments)}var mn=function(e,t){return i.createElement("svg",dn({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0,ref:t},e),cn||(cn=i.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M20 1a1 1 0 0 0-1 1v2h-2a1 1 0 1 0 0 2h2v2a1 1 0 1 0 2 0V6h2a1 1 0 1 0 0-2h-2V2a1 1 0 0 0-1-1M7 9.5C7 8.67 7.67 8 8.5 8s1.5.67 1.5 1.5S9.33 11 8.5 11 7 10.33 7 9.5m8.5 1.5c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5M12 17.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5M4 12a8 8 0 0 1 9.774-7.803 1 1 0 1 0 .442-1.95A10 10 0 0 0 12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10q0-.318-.02-.632a1 1 0 1 0-1.996.125q.015.25.016.507a8 8 0 1 1-16 0",clipRule:"evenodd"})))},un=(0,i.forwardRef)(mn);var hn;function pn(){return pn=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},pn.apply(null,arguments)}var gn=function(e,t){return i.createElement("svg",pn({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 11 14",role:"presentation","aria-hidden":!0,ref:t},e),hn||(hn=i.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M.22 8.494a.753.753 0 0 1 1.062-.002l3.724 3.7L8.718 8.48a.753.753 0 0 1 1.062-.002.747.747 0 0 1 .002 1.06L5.54 13.78a.753.753 0 0 1-1.063.002L.221 9.552a.747.747 0 0 1-.002-1.058m9.562-2.988a.753.753 0 0 1-1.062.002l-3.724-3.7L1.283 5.52a.753.753 0 0 1-1.062.002.747.747 0 0 1-.002-1.06L4.462.22A.753.753 0 0 1 5.524.218l4.257 4.23a.747.747 0 0 1 .001 1.058",clipRule:"evenodd"})))},vn=(0,i.forwardRef)(gn);var _n;function fn(){return fn=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},fn.apply(null,arguments)}var En=function(e,t){return i.createElement("svg",fn({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 11 14",role:"presentation","aria-hidden":!0,ref:t},e),_n||(_n=i.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M.22.234A.753.753 0 0 1 1.281.232l3.724 3.7L8.718.22A.753.753 0 0 1 9.781.218a.747.747 0 0 1 .001 1.06L5.54 5.52a.753.753 0 0 1-1.063.002L.221 1.292A.747.747 0 0 1 .219.235m9.562 13.532a.753.753 0 0 1-1.062.002l-3.724-3.7-3.713 3.712a.753.753 0 0 1-1.062.002.747.747 0 0 1-.002-1.06L4.462 8.48a.753.753 0 0 1 1.062-.002l4.257 4.23a.747.747 0 0 1 .001 1.058",clipRule:"evenodd"})))},yn=(0,i.forwardRef)(En);var bn=n("./src/accessibility/Toolbar.tsx"),wn=n("./src/accessibility/RovingTabIndex.tsx"),Sn=n("./src/Resend.ts"),An=n("./src/utils/MediaEventHelper.ts"),Cn=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/download.js"),xn=n("./src/utils/FileDownloader.ts");class kn extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,"downloader",new xn.s),(0,v.A)(this,"onDownloadClick",(async()=>{try{await this.doDownload()}catch(e){k.Ay.createDialog(nt.A,{title:(0,l._t)("timeline|download_failed"),description:i.createElement(i.Fragment,null,i.createElement("div",null,(0,l._t)("timeline|download_failed_description")),i.createElement("div",null,e instanceof Error?e.toString():""))}),this.setState({loading:!1})}})),this.state={loading:!1,tooltip:(0,l.AO)("timeline|download_action_downloading")}}async doDownload(){const e=this.props.mediaEventHelperGet();if(this.state.loading||!e)return;if(e.media.isEncrypted&&this.setState({tooltip:(0,l.AO)("timeline|download_action_decrypting")}),this.setState({loading:!0}),this.state.blob)return this.downloadBlob(this.state.blob);const t=await e.sourceBlob.value;this.setState({blob:t}),await this.downloadBlob(t)}async downloadBlob(e){await this.downloader.download({blob:e,name:this.props.mediaEventHelperGet().fileName}),this.setState({loading:!1})}render(){let e;this.state.loading&&(e=i.createElement(se.A,{w:18,h:18}));const t=dt()({mx_MessageActionBar_iconButton:!0,mx_MessageActionBar_downloadButton:!0,mx_MessageActionBar_downloadSpinnerButton:!!e});return i.createElement(wn.k,{className:t,title:e?(0,l._t)(this.state.tooltip):(0,l._t)("action|download"),onClick:this.onDownloadClick,disabled:!!e,placement:"left"},i.createElement(Cn.A,null),e)}}var Rn=n("./src/components/views/emojipicker/ReactionPicker.tsx"),In=n("./src/components/views/right_panel/context.ts"),Tn=n("./src/Keyboard.ts"),Pn=n("./src/accessibility/KeyboardShortcuts.ts"),Nn=n("./src/voice-broadcast/types.ts"),Dn=n("./src/utils/PinningUtils.ts"),Mn=n("./src/PosthogTrackers.ts");const On=({mxEvent:e,getTile:t,getReplyChain:n,permalinkCreator:s,onFocusChange:o,getRelationsForEvent:r})=>{const[a,c,d,m]=(0,Gt.EF)(),[u,h]=(0,wn.A9)(c);(0,i.useEffect)((()=>{o(a)}),[o,a]);const p=(0,i.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),d(),u()}),[d,u]);let g;if(a&&c.current){const o=null==t?void 0:t(),a=n(),l=c.current.getBoundingClientRect();g=i.createElement(Jt.A,(0,_t.A)({},(0,Gt.qv)(l),{mxEvent:e,permalinkCreator:s,eventTileOps:o&&o.getEventTileOps?o.getEventTileOps():void 0,collapseReplyChain:null!=a&&a.canCollapse()?a.collapse:void 0,onFinished:m,getRelationsForEvent:r}))}return i.createElement(i.Fragment,null,i.createElement(Gt.oW,{className:"mx_MessageActionBar_iconButton mx_MessageActionBar_optionsButton",title:(0,l._t)("common|options"),onClick:p,onContextMenu:p,isExpanded:a,ref:c,onFocus:u,tabIndex:h?0:-1,placement:"left"},i.createElement(Xt.A,null)),g)},Ln=({mxEvent:e,reactions:t,onFocusChange:n})=>{const[s,o,r,a]=(0,Gt.EF)(),[c,d]=(0,wn.A9)(o);let m;if((0,i.useEffect)((()=>{n(s)}),[n,s]),s&&o.current){const n=o.current.getBoundingClientRect();m=i.createElement(Gt.Ay,(0,_t.A)({},(0,Gt.qv)(n),{onFinished:a,managed:!1}),i.createElement(Rn.A,{mxEvent:e,reactions:t,onFinished:a}))}const u=(0,i.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),r(),c()}),[r,c]);return i.createElement(i.Fragment,null,i.createElement(Gt.oW,{className:"mx_MessageActionBar_iconButton",title:(0,l._t)("action|react"),onClick:u,onContextMenu:u,isExpanded:s,ref:o,onFocus:c,tabIndex:d?0:-1,placement:"left"},i.createElement(un,null)),m)},Un=({mxEvent:e})=>{var t;const n=(0,i.useContext)(In.E),s=null==e||null===(t=e.getRelation())||void 0===t?void 0:t.rel_type,r=!!s&&s!==o.RelationType.Thread,a=t=>{t.preventDefault(),t.stopPropagation();const i=e.getThread();null!=i&&i.rootEvent&&!e.isThreadRoot?S.A.dispatch({action:W.r.ShowThread,rootEvent:i.rootEvent,initialEvent:e,scroll_into_view:!0,highlighted:!0,push:n.isCard}):S.A.dispatch({action:W.r.ShowThread,rootEvent:e,push:n.isCard})},c=r?(0,l._t)("threads|error_start_thread_existing_relation"):(0,l._t)("action|reply_in_thread");return i.createElement(wn.k,{className:"mx_MessageActionBar_iconButton mx_MessageActionBar_threadButton",disabled:r,title:c,onClick:a,onContextMenu:a,placement:"left"},i.createElement(Zt.A,null))};class Fn extends i.PureComponent{constructor(...e){super(...e),(0,v.A)(this,"onDecrypted",(()=>{this.forceUpdate()})),(0,v.A)(this,"onBeforeRedaction",(()=>{this.forceUpdate()})),(0,v.A)(this,"onRoomEvent",(e=>{e&&e.getType()===o.EventType.RoomPinnedEvents&&this.forceUpdate()})),(0,v.A)(this,"onSent",(()=>{this.forceUpdate()})),(0,v.A)(this,"onFocusChange",(e=>{var t,n;null===(t=(n=this.props).onFocusChange)||void 0===t||t.call(n,e)})),(0,v.A)(this,"onReplyClick",(e=>{e.preventDefault(),e.stopPropagation(),S.A.dispatch({action:"reply_to_event",event:this.props.mxEvent,context:this.context.timelineRenderingType})})),(0,v.A)(this,"onEditClick",(e=>{e.preventDefault(),e.stopPropagation(),(0,Rt.ju)(_.J.safeGet(),this.props.mxEvent,this.context.timelineRenderingType,this.props.getRelationsForEvent)})),(0,v.A)(this,"forbiddenThreadHeadMsgType",[o.MsgType.KeyVerificationRequest]),(0,v.A)(this,"onResendClick",(e=>{e.preventDefault(),e.stopPropagation(),this.runActionOnFailedEv((e=>Sn.A.resend(_.J.safeGet(),e)))})),(0,v.A)(this,"onCancelClick",(e=>{this.runActionOnFailedEv((e=>Sn.A.removeFromQueue(_.J.safeGet(),e)),(e=>(0,Rt.d1)(e.status)))})),(0,v.A)(this,"onPinClick",(async(e,t)=>{e.preventDefault(),e.stopPropagation(),await Dn.A.pinOrUnpinEvent(_.J.safeGet(),this.props.mxEvent),Mn.A.trackPinUnpinMessage(t?"Pin":"Unpin","Timeline")}))}componentDidMount(){var e;this.props.mxEvent.status&&this.props.mxEvent.status!==o.EventStatus.SENT&&this.props.mxEvent.on(o.MatrixEventEvent.Status,this.onSent);_.J.safeGet().decryptEventIfNeeded(this.props.mxEvent),this.props.mxEvent.isBeingDecrypted()&&this.props.mxEvent.once(o.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.on(o.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),null===(e=this.context.room)||void 0===e||null===(e=e.getLiveTimeline().getState(o.EventTimeline.FORWARDS))||void 0===e||e.on(o.RoomStateEvent.Events,this.onRoomEvent)}componentWillUnmount(){var e;this.props.mxEvent.off(o.MatrixEventEvent.Status,this.onSent),this.props.mxEvent.off(o.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.off(o.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),null===(e=this.context.room)||void 0===e||null===(e=e.getLiveTimeline().getState(o.EventTimeline.FORWARDS))||void 0===e||e.off(o.RoomStateEvent.Events,this.onRoomEvent)}get showReplyInThreadAction(){const e=this.context.timelineRenderingType!==jt.Ae.Thread,t=!(this.forbiddenThreadHeadMsgType.includes(this.props.mxEvent.getContent().msgtype)||o.M_BEACON_INFO.matches(this.props.mxEvent.getType())||this.props.mxEvent.getType()===Nn.I$);return e&&t}runActionOnFailedEv(e,t){t||(t=()=>!0);const n=this.props.mxEvent,i=n.replacingEvent(),s=[n.localRedactionEvent(),i,n];for(const n of s)if(n&&t(n)){e(n);break}}render(){var e,t;const n=[];if((0,Rt.wQ)(_.J.safeGet(),this.props.mxEvent)&&n.push(i.createElement(wn.k,{className:"mx_MessageActionBar_iconButton",title:(0,l._t)("action|edit"),onClick:this.onEditClick,onContextMenu:this.onEditClick,key:"edit",placement:"left"},i.createElement(ln,null))),Dn.A.canPin(_.J.safeGet(),this.props.mxEvent)||Dn.A.canUnpin(_.J.safeGet(),this.props.mxEvent)){const e=Dn.A.isPinned(_.J.safeGet(),this.props.mxEvent);n.push(i.createElement(wn.k,{className:"mx_MessageActionBar_iconButton",title:e?(0,l._t)("action|unpin"):(0,l._t)("action|pin"),onClick:t=>this.onPinClick(t,e),onContextMenu:t=>this.onPinClick(t,e),key:"pin",placement:"left"},e?i.createElement(en.A,null):i.createElement(tn.A,null)))}const s=i.createElement(wn.k,{className:"mx_MessageActionBar_iconButton",title:(0,l._t)("action|delete"),onClick:this.onCancelClick,onContextMenu:this.onCancelClick,key:"cancel",placement:"left"},i.createElement(nn.A,null)),r=i.createElement(Un,{mxEvent:this.props.mxEvent,key:"reply_thread"}),a=this.props.mxEvent,c=null===(e=a.replacingEvent())||void 0===e?void 0:e.status,d=null===(t=a.localRedactionEvent())||void 0===t?void 0:t.status,m=(0,Rt.d1)(a.status)||(0,Rt.d1)(c)||(0,Rt.d1)(d),u=[a.status,c,d].includes(o.EventStatus.NOT_SENT);if(m&&u)n.splice(0,0,i.createElement(wn.k,{className:"mx_MessageActionBar_iconButton mx_MessageActionBar_retryButton",title:(0,l._t)("action|retry"),onClick:this.onResendClick,onContextMenu:this.onResendClick,key:"resend",placement:"left"},i.createElement(sn.A,null))),n.push(s);else{if((0,Rt.qe)(this.props.mxEvent)?(this.context.canSendMessages&&(this.showReplyInThreadAction&&n.splice(0,0,r),n.splice(0,0,i.createElement(wn.k,{className:"mx_MessageActionBar_iconButton",title:(0,l._t)("action|reply"),onClick:this.onReplyClick,onContextMenu:this.onReplyClick,key:"reply",placement:"left"},i.createElement(on.A,null)))),this.context.canReact&&!this.context.search&&n.splice(0,0,i.createElement(Ln,{mxEvent:this.props.mxEvent,reactions:this.props.reactions,onFocusChange:this.onFocusChange,key:"react"})),An.j.isEligible(this.props.mxEvent)&&n.splice(0,0,i.createElement(kn,{mxEvent:this.props.mxEvent,mediaEventHelperGet:()=>{var e,t;return null===(e=this.props.getTile())||void 0===e||null===(t=e.getMediaHelper)||void 0===t?void 0:t.call(e)},key:"download"}))):this.context.timelineRenderingType===jt.Ae.Room&&this.props.mxEvent.getThread()&&n.unshift(r),m&&n.push(s),void 0!==this.props.isQuoteExpanded&&(0,Bt.c$)(this.props.mxEvent)){const e=dt()({mx_MessageActionBar_iconButton:!0,mx_MessageActionBar_expandCollapseMessageButton:!0});n.push(i.createElement(wn.k,{className:e,title:this.props.isQuoteExpanded?(0,l._t)("timeline|mab|collapse_reply_chain"):(0,l._t)("timeline|mab|expand_reply_chain"),caption:(0,l._t)(Pn.hm[Tn.Uz.SHIFT])+" + "+(0,l._t)("action|click"),onClick:this.props.toggleThreadExpanded,key:"expand",placement:"left"},this.props.isQuoteExpanded?i.createElement(yn,null):i.createElement(vn,null)))}n.push(i.createElement(On,{mxEvent:this.props.mxEvent,getReplyChain:this.props.getReplyChain,getTile:this.props.getTile,permalinkCreator:this.props.permalinkCreator,onFocusChange:this.onFocusChange,key:"menu",getRelationsForEvent:this.props.getRelationsForEvent}))}return i.createElement(bn.A,{className:"mx_MessageActionBar","aria-label":(0,l._t)("timeline|mab|label"),"aria-live":"off"},n)}}(0,v.A)(Fn,"contextType",jt.Ay);var Vn=n("./node_modules/lodash/lodash.js"),Bn=n("./node_modules/matrix-js-sdk/src/NamespacedValue.ts"),jn=n("./src/accessibility/context_menu/ContextMenuTooltipButton.tsx"),Wn=n("./src/customisations/Media.ts"),zn=n("./src/HtmlUtils.tsx"),Hn=n("./src/contexts/MatrixClientContext.tsx");class Kn extends i.PureComponent{render(){const{content:e,reactionEvents:t,mxEvent:n,children:s}=this.props,o=this.context.getRoom(n.getRoomId());if(o){const n=[];let a;for(const e of t){var r;const t=o.getMember(e.getSender()),i=null!==(r=null==t?void 0:t.name)&&void 0!==r?r:e.getSender();n.push(i),a=this.props.customReactionImagesEnabled&&Gn.findIn(e.getContent())||void 0}const c=(0,zn.aS)(e)||a,d=(0,bt.ki)(n,6),m=c?(0,l._t)("timeline|reactions|tooltip_caption",{shortName:c}):void 0;return i.createElement(Et.m,{description:d,caption:m,placement:"right"},s)}return s}}(0,v.A)(Kn,"contextType",Hn.Ay);class Jn extends i.PureComponent{constructor(...e){super(...e),(0,v.A)(this,"onClick",(()=>{const{mxEvent:e,myReactionEvent:t,content:n}=this.props;t?this.context.redactEvent(e.getRoomId(),t.getId()):(this.context.sendEvent(e.getRoomId(),o.EventType.Reaction,{"m.relates_to":{rel_type:o.RelationType.Annotation,event_id:e.getId(),key:n}}),S.A.dispatch({action:"message_sent"}))}))}render(){const{mxEvent:e,content:t,count:n,reactionEvents:s,myReactionEvent:o}=this.props,r=dt()({mx_ReactionsRowButton:!0,mx_ReactionsRowButton_selected:!!o}),a=this.context.getRoom(e.getRoomId());let c,d;if(a){const e=[];for(const t of s){const n=a.getMember(t.getSender());e.push((null==n?void 0:n.name)||t.getSender()),d=this.props.customReactionImagesEnabled&&Gn.findIn(t.getContent())||void 0}const n=(0,bt.ki)(e,6);c=t?(0,l._t)("timeline|reactions|label",{reactors:n,content:d||t}):n}let m=i.createElement("span",{className:"mx_ReactionsRowButton_content","aria-hidden":"true"},t);if(this.props.customReactionImagesEnabled&&t.startsWith("mxc://")){const e=(0,Wn.lH)(t).srcHttp;e&&(m=i.createElement("img",{className:"mx_ReactionsRowButton_content",alt:d||(0,l._t)("timeline|reactions|custom_reaction_fallback_label"),src:e,width:"16",height:"16"}))}return i.createElement(Kn,{mxEvent:this.props.mxEvent,content:t,reactionEvents:s,customReactionImagesEnabled:this.props.customReactionImagesEnabled},i.createElement(ie.A,{className:r,"aria-label":c,onClick:this.onClick,disabled:this.props.disabled},m,i.createElement("span",{className:"mx_ReactionsRowButton_count","aria-hidden":"true"},n)))}}(0,v.A)(Jn,"contextType",Hn.Ay);const Gn=new Bn.qr("shortcode","com.beeper.reaction.shortcode"),$n=({mxEvent:e,reactions:t})=>{const[n,s,o,r]=(0,Gt.EF)();let a;if(n&&s.current){const n=s.current.getBoundingClientRect();a=i.createElement(Gt.Ay,(0,_t.A)({},(0,Gt.qv)(n),{onFinished:r,managed:!1}),i.createElement(Rn.A,{mxEvent:e,reactions:t,onFinished:r}))}return i.createElement(i.Fragment,null,i.createElement(jn.o,{className:dt()("mx_ReactionsRow_addReactionButton",{mx_ReactionsRow_addReactionButton_active:n}),title:(0,l._t)("timeline|reactions|add_reaction_prompt"),onClick:o,onContextMenu:e=>{e.preventDefault(),o()},isExpanded:n,ref:s}),a)};class qn extends i.PureComponent{constructor(e,t){super(e,t),(0,v.A)(this,"onDecrypted",(()=>{this.forceUpdate()})),(0,v.A)(this,"onReactionsChange",(()=>{this.setState({myReactions:this.getMyReactions()}),this.forceUpdate()})),(0,v.A)(this,"onShowAllClick",(()=>{this.setState({showAll:!0})})),this.state={myReactions:this.getMyReactions(),showAll:!1}}componentDidMount(){const{mxEvent:e,reactions:t}=this.props;(e.isBeingDecrypted()||e.shouldAttemptDecryption())&&e.once(o.MatrixEventEvent.Decrypted,this.onDecrypted),t&&(t.on(o.RelationsEvent.Add,this.onReactionsChange),t.on(o.RelationsEvent.Remove,this.onReactionsChange),t.on(o.RelationsEvent.Redaction,this.onReactionsChange))}componentWillUnmount(){const{mxEvent:e,reactions:t}=this.props;e.off(o.MatrixEventEvent.Decrypted,this.onDecrypted),t&&(t.off(o.RelationsEvent.Add,this.onReactionsChange),t.off(o.RelationsEvent.Remove,this.onReactionsChange),t.off(o.RelationsEvent.Redaction,this.onReactionsChange))}componentDidUpdate(e){this.props.reactions&&e.reactions!==this.props.reactions&&(this.props.reactions.on(o.RelationsEvent.Add,this.onReactionsChange),this.props.reactions.on(o.RelationsEvent.Remove,this.onReactionsChange),this.props.reactions.on(o.RelationsEvent.Redaction,this.onReactionsChange),this.onReactionsChange())}getMyReactions(){var e,t;const n=this.props.reactions;if(!n)return null;const i=null===(e=this.context.room)||void 0===e?void 0:e.client.getUserId();if(!i)return null;const s=null===(t=n.getAnnotationsBySender())||void 0===t?void 0:t[i];return s?[...s.values()]:null}render(){var e,t;const{mxEvent:n,reactions:s}=this.props,{myReactions:o,showAll:r}=this.state;if(!s||!(0,Rt.qe)(n))return null;const a=M.A.getValue("feature_render_reaction_images");let c,d,m=null===(e=s.getSortedAnnotationsByKey())||void 0===e?void 0:e.map((([e,t])=>{if(!t.size)return null;const s=(0,Vn.uniqBy)([...t],(e=>e.getSender())),r=null==o?void 0:o.find((t=>{var n;return!t.isRedacted()&&(null===(n=t.getRelation())||void 0===n?void 0:n.key)===e}));return i.createElement(Jn,{key:e,content:e,count:s.length,mxEvent:n,reactionEvents:s,myReactionEvent:r,customReactionImagesEnabled:a,disabled:!this.context.canReact||r&&!r.isRedacted()&&!this.context.canSelfRedact})})).filter((e=>!!e));return null!==(t=m)&&void 0!==t&&t.length?(m.length>9&&!r&&(m=m.slice(0,8),c=i.createElement(ie.A,{kind:"link_inline",className:"mx_ReactionsRow_showAll",onClick:this.onShowAllClick},(0,l._t)("action|show_all"))),this.context.canReact&&(d=i.createElement($n,{mxEvent:n,reactions:s})),i.createElement("div",{className:"mx_ReactionsRow",role:"toolbar","aria-label":(0,l._t)("common|reactions")},m,c,d)):null}}(0,v.A)(qn,"contextType",jt.Ay);var Yn,Qn=n("./src/utils/strings.ts"),Xn=n("./node_modules/bloom-filters/dist/api.js"),Zn=n("./src/utils/crypto/index.ts");function ei(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}const ti="mx_decryption_failure_event_ids";class ni{constructor(e,t,n,i,s,o){(0,v.A)(this,"timeToDecryptMillis",void 0),this.failedEventId=e,this.errorCode=t,this.ts=n,this.isFederated=i,this.wasVisibleToUser=s,this.userTrustsOwnIdentity=o}}class ii{constructor(e,t,n=!0){if((0,v.A)(this,"failures",new Map),(0,v.A)(this,"visibleEvents",new Set),(0,v.A)(this,"reportedEvents",new Xn.ScalableBloomFilter),(0,v.A)(this,"checkInterval",null),(0,v.A)(this,"trackInterval",null),(0,v.A)(this,"baseProperties",{}),(0,v.A)(this,"userDomain",void 0),(0,v.A)(this,"userTrustsOwnIdentity",void 0),(0,v.A)(this,"checkingVerificationStatus",!1),(0,v.A)(this,"retryVerificationStatus",!1),this.fn=e,this.errorCodeMapFn=t,this.checkReportedEvents=n,!e||"function"!=typeof e)throw new Error("DecryptionFailureTracker requires tracking function");if("function"!=typeof t)throw new Error("DecryptionFailureTracker second constructor argument should be a function")}static get instance(){return ii.internalInstance}loadReportedEvents(){const e=localStorage.getItem(ti);this.reportedEvents=e?Xn.ScalableBloomFilter.fromJSON(JSON.parse(e)):new Xn.ScalableBloomFilter}saveReportedEvents(){localStorage.setItem(ti,JSON.stringify(this.reportedEvents.saveAsJSON()))}eventDecrypted(e,t){if(e.getWireContent().algorithm!=Zn.Q)return;const n=e.decryptionFailureReason;if(null===n)return void this.removeDecryptionFailuresForEvent(e,t);const i=e.getId();if(this.reportedEvents.has(i)&&this.checkReportedEvents)return;const s=this.failures.get(i),o=s?s.ts:t,r=e.getSender(),a=null==r?void 0:r.replace(/^.*?:/,"");let l;void 0!==this.userDomain&&void 0!==a&&(l=this.userDomain!==a);const c=this.visibleEvents.has(i);this.failures.set(i,new ni(i,n,o,l,c,this.userTrustsOwnIdentity))}addVisibleEvent(e){const t=e.getId();if(this.reportedEvents.has(t)&&this.checkReportedEvents)return;const n=this.failures.get(t);n&&(n.wasVisibleToUser=!0),this.visibleEvents.add(t)}removeDecryptionFailuresForEvent(e,t){const n=e.getId(),i=this.failures.get(n);if(i){this.failures.delete(n);const e=t-i.ts;if(e<ii.GRACE_PERIOD_MS)return;e<=ii.MAXIMUM_LATE_DECRYPTION_PERIOD&&(i.timeToDecryptMillis=e),this.reportFailure(i)}}async handleKeysChanged(e){if(this.checkingVerificationStatus)this.retryVerificationStatus=!0;else{this.checkingVerificationStatus=!0;try{do{this.retryVerificationStatus=!1,this.userTrustsOwnIdentity=(await e.getCrypto().getUserVerificationStatus(e.getUserId())).isCrossSigningVerified()}while(this.retryVerificationStatus)}finally{this.checkingVerificationStatus=!1}}}async start(e){this.loadReportedEvents(),await this.calculateClientProperties(e),this.registerHandlers(e),this.checkInterval=window.setInterval((()=>this.checkFailures(Date.now())),ii.CHECK_INTERVAL_MS)}async calculateClientProperties(e){var t;const n={};this.baseProperties=n,this.userDomain=null!==(t=e.getDomain())&&void 0!==t?t:void 0,"matrix.org"===this.userDomain?n.isMatrixDotOrg=!0:void 0!==this.userDomain&&(n.isMatrixDotOrg=!1);const i=e.getCrypto();if(i){i.getVersion().startsWith("Rust SDK")?n.cryptoSDK="Rust":n.cryptoSDK="Legacy",this.userTrustsOwnIdentity=(await i.getUserVerificationStatus(e.getUserId())).isCrossSigningVerified()}}registerHandlers(e){const t=e=>this.eventDecrypted(e,Date.now()),n=()=>{this.handleKeysChanged(e).catch((e=>{console.log("Error handling KeysChanged event",e)}))},i=()=>{e.removeListener(o.MatrixEventEvent.Decrypted,t),e.removeListener(V.CryptoEvent.KeysChanged,n),e.removeListener(o.HttpApiEvent.SessionLoggedOut,i),this.stop()};e.on(o.MatrixEventEvent.Decrypted,t),e.on(V.CryptoEvent.KeysChanged,n),e.on(o.HttpApiEvent.SessionLoggedOut,i)}stop(){this.checkInterval&&clearInterval(this.checkInterval),this.trackInterval&&clearInterval(this.trackInterval),this.userTrustsOwnIdentity=void 0,this.failures=new Map,this.visibleEvents=new Set}checkFailures(e){const t=new Map;for(const[n,i]of this.failures)void 0!==i.timeToDecryptMillis||e>i.ts+ii.MAXIMUM_LATE_DECRYPTION_PERIOD?this.reportFailure(i):t.set(n,i);this.failures=t,this.saveReportedEvents()}reportFailure(e){var t;const n=e.errorCode,i=this.errorCodeMapFn(n),s={timeToDecryptMillis:null!==(t=e.timeToDecryptMillis)&&void 0!==t?t:-1,wasVisibleToUser:e.wasVisibleToUser};void 0!==e.isFederated&&(s.isFederated=e.isFederated),void 0!==e.userTrustsOwnIdentity&&(s.userTrustsOwnIdentity=e.userTrustsOwnIdentity),this.baseProperties&&Object.assign(s,this.baseProperties),this.fn(i,n,s),this.reportedEvents.add(e.failedEventId),this.visibleEvents.delete(e.failedEventId)}}Yn=ii,(0,v.A)(ii,"internalInstance",new Yn(((e,t,n)=>{const i=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ei(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ei(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({eventName:"Error",domain:"E2EE",name:e,context:`mxc_crypto_error_type_${t}`},n);B.Vo.instance.trackEvent(i)}),(e=>{switch(e){case V.DecryptionFailureCode.MEGOLM_UNKNOWN_INBOUND_SESSION_ID:case V.DecryptionFailureCode.MEGOLM_KEY_WITHHELD:return"OlmKeysNotSentError";case V.DecryptionFailureCode.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE:return"RoomKeysWithheldForUnverifiedDevice";case V.DecryptionFailureCode.OLM_UNKNOWN_MESSAGE_INDEX:return"OlmIndexError";case V.DecryptionFailureCode.HISTORICAL_MESSAGE_NO_KEY_BACKUP:case V.DecryptionFailureCode.HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED:case V.DecryptionFailureCode.HISTORICAL_MESSAGE_WORKING_BACKUP:return"HistoricalMessage";case V.DecryptionFailureCode.HISTORICAL_MESSAGE_USER_NOT_JOINED:return"ExpectedDueToMembership";case V.DecryptionFailureCode.SENDER_IDENTITY_PREVIOUSLY_VERIFIED:return"ExpectedVerificationViolation";case V.DecryptionFailureCode.UNSIGNED_SENDER_DEVICE:return"ExpectedSentByInsecureDevice";default:return"UnknownError"}}))),(0,v.A)(ii,"CHECK_INTERVAL_MS",4e4),(0,v.A)(ii,"GRACE_PERIOD_MS",4e3),(0,v.A)(ii,"MAXIMUM_LATE_DECRYPTION_PERIOD",6e4);var si=n("./src/components/views/messages/RedactedBody.tsx"),oi=n("./src/components/structures/ViewSource.tsx");class ri extends i.Component{constructor(e){super(e),(0,v.A)(this,"onBugReport",(()=>{k.Ay.createDialog(st.A,{label:"react-soft-crash-tile",error:this.state.error})})),(0,v.A)(this,"onViewSource",(()=>{k.Ay.createDialog(oi.A,{mxEvent:this.props.mxEvent},"mx_Dialog_viewsource")})),this.state={}}static getDerivedStateFromError(e){return{error:e}}render(){if(this.state.error){const{mxEvent:e}=this.props,t={mx_EventTile:!0,mx_EventTile_info:!0,mx_EventTile_content:!0,mx_EventTile_tileError:!0};let n,s;return c.Ay.get().bug_report_endpoint_url&&(n=i.createElement(i.Fragment,null," ",i.createElement(ie.A,{kind:"link",onClick:this.onBugReport},(0,l._t)("bug_reporting|submit_debug_logs")))),e&&M.A.getValue("developerMode")&&(s=i.createElement(i.Fragment,null," ",i.createElement(ie.A,{onClick:this.onViewSource,kind:"link"},(0,l._t)("action|view_source")))),i.createElement("li",{className:dt()(t),"data-layout":this.props.layout},i.createElement("div",{className:"mx_EventTile_line"},i.createElement("span",null,(0,l._t)("timeline|error_rendering_message"),e&&` (${e.getType()})`,n,s)))}return this.props.children}}var ai=n("./node_modules/@vector-im/compound-web/dist/components/Icon/IndicatorIcon/IndicatorIcon.js"),li=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/threads-solid.js"),ci=n("./src/hooks/useEventEmitter.ts"),di=n("./src/hooks/useUnreadNotifications.ts"),mi=n("./src/utils/notifications.ts"),ui=n("./src/stores/room-list/MessagePreviewStore.ts"),hi=n("./src/hooks/useAsyncMemo.ts");const pi=["mxEvent","className"],gi=["preview","className"];function vi(e){let{mxEvent:t,className:n}=e,s=(0,g.A)(e,pi);const o=fi(t);return o?i.createElement(_i,(0,_t.A)({},s,{preview:o,className:n})):null}function _i(e){let{preview:[t,n],className:s}=e,o=(0,g.A)(e,gi);const r=dt()("mx_EventPreview",s);return n?i.createElement("span",(0,_t.A)({},o,{className:r}),(0,l._t)("event_preview|preview",{prefix:n,preview:t},{bold:e=>i.createElement("span",{className:"mx_EventPreview_prefix"},e)})):i.createElement("span",(0,_t.A)({},o,{className:r,title:t}),t)}function fi(e){const t=(0,i.useContext)(Hn.Ay),[n,s]=(0,i.useState)(null==e?void 0:e.getContent());(0,ci.YK)(null!=e?e:void 0,o.MatrixEventEvent.Replaced,(()=>{s(e.getContent())}));const r=(null==e?void 0:e.shouldAttemptDecryption())||(null==e?void 0:e.isBeingDecrypted());return(0,ci.YK)(r&&null!=e?e:void 0,o.MatrixEventEvent.Decrypted,(()=>{s(e.getContent())})),(0,hi.e)((async()=>!e||e.isRedacted()||e.isDecryptionFailure()?null:(await t.decryptEventIfNeeded(e),[ui.X.instance.generatePreviewForEvent(e),Ei(e.getType(),null==n?void 0:n.msgtype)])),[e,n],null)}function Ei(e,t){if(e===o.M_POLL_START.name)return(0,l._t)("event_preview|prefix|poll");switch(t){case o.MsgType.Audio:return(0,l._t)("event_preview|prefix|audio");case o.MsgType.Image:return(0,l._t)("event_preview|prefix|image");case o.MsgType.Video:return(0,l._t)("event_preview|prefix|video");case o.MsgType.File:return(0,l._t)("event_preview|prefix|file");default:return null}}const yi=["mxEvent","thread"],bi=({thread:e,showDisplayname:t=!1})=>{var n,s,r;const a=null!==(n=(0,ci.DY)(e,o.ThreadEvent.Update,(()=>e.replyToEvent)))&&void 0!==n?n:void 0,c=fi(a);return c&&a?i.createElement(i.Fragment,null,i.createElement(Mt.A,{member:a.sender,fallbackUserId:a.getSender(),size:"24px",className:"mx_ThreadSummary_avatar"}),t&&i.createElement("div",{className:"mx_ThreadSummary_sender"},null!==(s=null===(r=a.sender)||void 0===r?void 0:r.name)&&void 0!==s?s:a.getSender()),a.isDecryptionFailure()?i.createElement("div",{className:"mx_ThreadSummary_content mx_DecryptionFailureBody",title:(0,l._t)("timeline|decryption_failure|unable_to_decrypt")},(0,l._t)("timeline|decryption_failure|unable_to_decrypt")):i.createElement(_i,{preview:c,className:"mx_ThreadSummary_content"})):null},wi=e=>{let{mxEvent:t,thread:n}=e,s=(0,g.A)(e,yi);const r=(0,i.useContext)(jt.Ay),a=(0,i.useContext)(In.E),c=(0,ci.DY)(n,o.ThreadEvent.Update,(()=>n.length)),{level:d}=(0,di.X)(n.room,n.id);if(!c)return null;let m=c;return r.narrow||(m=(0,l._t)("threads|count_of_reply",{count:c})),i.createElement(ie.A,(0,_t.A)({},s,{className:"mx_ThreadSummary",onClick:e=>{S.A.dispatch({action:W.r.ShowThread,rootEvent:t,push:a.isCard}),Mn.A.trackInteraction("WebRoomTimelineThreadSummaryButton",e)},"aria-label":(0,l._t)("threads|open_thread")}),i.createElement(ai.N,{size:"24px",indicator:(0,mi.W7)(d)},i.createElement(li.A,null)),i.createElement("span",{className:"mx_ThreadSummary_replies_amount"},m),i.createElement(bi,{thread:n,showDisplayname:!r.narrow}),i.createElement("div",{className:"mx_ThreadSummary_chevron"}))};class Si extends i.Component{constructor(e){super(e),(0,v.A)(this,"nodes",{}),(0,v.A)(this,"children",{}),this.updateChildren(this.props.children)}componentDidUpdate(){this.updateChildren(this.props.children)}applyStyles(e,t){Object.entries(t).forEach((([t,n])=>{e.style[t]=n}))}updateChildren(e){const t=this.children||{};this.children={},i.Children.toArray(e).forEach((e=>{if(function(e){return"object"==typeof e&&"type"in e}(e))if(t[e.key]){const n=t[e.key],s=this.nodes[n.key];s&&s.style.left!==e.props.style.left&&this.applyStyles(s,{left:e.props.style.left}),this.children[e.key]=i.cloneElement(n,e.props,e.props.children)}else{const t={},n=e.props.style,s=this.props.startStyles;if(s.length>0){const e=s[0];t.style=e}t.ref=t=>this.collectNode(e.key,t,n),this.children[e.key]=i.cloneElement(e,t)}}))}collectNode(e,t,n){const i="bigint"==typeof e?Number(e):e;if(t&&void 0===this.nodes[i]&&this.props.startStyles.length>0){const e=this.props.startStyles;for(let n=1;n<e.length;++n)this.applyStyles(t,e[n]);window.setTimeout((()=>{this.applyStyles(t,n)}),0)}t?this.nodes[i]=t:delete this.nodes[i],this.props.innerRef&&(this.props.innerRef.current=t)}render(){return i.createElement(i.Fragment,null,Object.values(this.children))}}(0,v.A)(Si,"defaultProps",{startStyles:[]});var Ai=n("./src/utils/units.ts");class Ci extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,"avatar",(0,i.createRef)()),this.state={suppressDisplay:!this.props.suppressAnimation}}componentWillUnmount(){const e=this.props.readReceiptPosition;e&&(this.props.checkUnmounting&&this.props.checkUnmounting()||this.buildReadReceiptInfo(e))}componentDidMount(){this.state.suppressDisplay&&this.animateMarker()}componentDidUpdate(e){const t=e.offset!==this.props.offset,n=e.hidden!==this.props.hidden;(t||n)&&this.animateMarker()}buildReadReceiptInfo(e={}){const t=this.avatar.current,n=null==t?void 0:t.offsetParent;if(!n||!n.getBoundingClientRect)return s.v.warn(`ReadReceiptMarker for ${this.props.fallbackUserId} has no valid horizontalContainer`),e.top=0,e.right=0,e;const i=t.getBoundingClientRect();return e.top=i.top,e.right=i.right-n.getBoundingClientRect().right,e}animateMarker(){var e;const t=this.props.readReceiptPosition,n=null!==(e=this.buildReadReceiptInfo().top)&&void 0!==e?e:0,i=t&&void 0!==t.top?t.top:-ki,s=[];null!=t&&t.right&&s.push({top:i-n,right:t.right}),s.push({top:i-n,right:0}),this.setState({suppressDisplay:!1,startStyles:s})}render(){var e;if(this.state.suppressDisplay)return i.createElement("div",{ref:this.avatar});const t={right:(0,Ai.c)(this.props.offset),top:"0px"};return i.createElement(Si,{startStyles:this.state.startStyles,innerRef:this.avatar},i.createElement(Mt.A,{member:null!==(e=this.props.member)&&void 0!==e?e:null,fallbackUserId:this.props.fallbackUserId,"aria-hidden":"true","aria-live":"off",size:"14px",style:t,hideTitle:!0,tabIndex:-1}))}}var xi=n("./src/components/structures/AutoHideScrollbar.tsx");const ki=16;function Ri({readReceipts:e,readReceiptMap:t,checkUnmounting:n,suppressAnimation:s,isTwelveHour:o}){const[r,a,c,d]=(0,Gt.EF)(),m=e.length>4?3:4,u=function(e,t){return(0,bt.ki)(e,t)}(e.map((e=>{var t,n;return null!==(t=null===(n=e.roomMember)||void 0===n?void 0:n.name)&&void 0!==t?t:e.userId})),m);if(0===e.length)return i.createElement("div",{className:"mx_EventTile_msgOption"},i.createElement("div",{className:"mx_ReadReceiptGroup"},i.createElement("div",{className:"mx_ReadReceiptGroup_button"},i.createElement("span",{className:"mx_ReadReceiptGroup_container"}))));const h=e.map(((e,r)=>{const{hidden:a,position:l}=function(e,t){return e<t?{hidden:!1,position:e}:{hidden:!0,position:0}}(r,m),c=e.userId;let d;return t&&(d=t[c],d||(d={},t[c]=d)),i.createElement(Ci,{key:c,member:e.roomMember,fallbackUserId:c,offset:10*l,hidden:a,readReceiptPosition:d,checkUnmounting:n,suppressAnimation:s,timestamp:e.ts,showTwelveHour:o})})).reverse();let p;const g=e.length-m;let v;if(g>0&&(p=i.createElement("span",{className:"mx_ReadReceiptGroup_remainder","aria-live":"off"},"+",g)),r&&a.current){const t=a.current.getBoundingClientRect();v=i.createElement(Gt.Ay,(0,_t.A)({menuClassName:"mx_ReadReceiptGroup_popup",onFinished:d},(0,Gt.qv)(t)),i.createElement(xi.A,null,i.createElement(Ti,{className:"mx_ReadReceiptGroup_title"},(0,l._t)("timeline|read_receipt_title",{count:e.length})),e.map((e=>i.createElement(Ii,(0,_t.A)({key:e.userId},e,{isTwelveHour:o,onAfterClick:d}))))))}return i.createElement("div",{className:"mx_EventTile_msgOption"},i.createElement(Et.m,{label:(0,l._t)("timeline|read_receipt_title",{count:e.length}),caption:u,placement:"top-end"},i.createElement("div",{className:"mx_ReadReceiptGroup",role:"group","aria-label":(0,l._t)("timeline|read_receipts_label")},i.createElement(ie.A,{className:"mx_ReadReceiptGroup_button",ref:a,"aria-label":u,"aria-haspopup":"true",onClick:c},p,i.createElement("span",{className:"mx_ReadReceiptGroup_container",style:{width:10*Math.min(m,e.length)+ki-10}},h)),v)))}function Ii({userId:e,roomMember:t,ts:n,isTwelveHour:s,onAfterClick:o}){var r,a;return i.createElement(Et.m,{description:null!==(r=null==t?void 0:t.rawDisplayName)&&void 0!==r?r:e,caption:e,placement:"top"},i.createElement("div",null,i.createElement(Gt.Dr,{className:"mx_ReadReceiptGroup_person",onClick:()=>{S.A.dispatch({action:W.r.ViewUser,member:null!=t?t:{userId:e},push:!1}),null==o||o()}},i.createElement(Mt.A,{member:t,fallbackUserId:e,size:"24px","aria-hidden":"true","aria-live":"off",resizeMethod:"crop",hideTitle:!0}),i.createElement("div",{className:"mx_ReadReceiptGroup_name"},i.createElement("p",null,null!==(a=null==t?void 0:t.name)&&void 0!==a?a:e),i.createElement("p",{className:"mx_ReadReceiptGroup_secondary"},(0,Re.Yq)(new Date(n),s))))))}function Ti({className:e,children:t}){const[n,,s]=(0,wn.A9)();return i.createElement("h3",{className:e,role:"menuitem",onFocus:n,tabIndex:-1,ref:s},t)}var Pi=n("./src/utils/localRoom/isLocalRoom.ts"),Ni=n("./src/components/views/rooms/NotificationBadge/StatelessNotificationBadge.tsx");function Di({room:e,threadId:t,forceDot:n}){const{symbol:s,count:o,level:r}=(0,di.X)(e,t);return i.createElement(Ni.V,{symbol:s,count:o,level:r,forceDot:n})}var Mi,Oi=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/link.js");function Li(){return Li=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},Li.apply(null,arguments)}var Ui=function(e,t){return i.createElement("svg",Li({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",role:"presentation","aria-hidden":!0,ref:t},e),Mi||(Mi=i.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M1 2.75A.75.75 0 0 1 1.75 2h.005a.75.75 0 0 1 0 1.5H1.75A.75.75 0 0 1 1 2.75m2.495 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.005a.75.75 0 0 1 0 1.5h-.005a.75.75 0 0 1-.75-.75M1 6.75A.75.75 0 0 1 1.75 6h8.5a.75.75 0 0 1 0 1.5h-8.5A.75.75 0 0 1 1 6.75m0 3A.75.75 0 0 1 1.75 9h4.5a.75.75 0 0 1 0 1.5h-4.5A.75.75 0 0 1 1 9.75m0 4a.75.75 0 0 1 .75-.75h.005a.75.75 0 0 1 0 1.5H1.75a.75.75 0 0 1-.75-.75m2.495 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.005a.75.75 0 0 1 0 1.5h-.005a.75.75 0 0 1-.75-.75",clipRule:"evenodd"})))},Fi=(0,i.forwardRef)(Ui);function Vi({viewInRoom:e,copyLinkToThread:t}){return i.createElement(bn.A,{className:"mx_MessageActionBar","aria-label":(0,l._t)("timeline|mab|label"),"aria-live":"off"},i.createElement(wn.k,{className:"mx_MessageActionBar_iconButton",onClick:e,title:(0,l._t)("timeline|mab|view_in_room"),key:"view_in_room"},i.createElement(Fi,null)),i.createElement(wn.k,{className:"mx_MessageActionBar_iconButton",onClick:t,title:(0,l._t)("timeline|mab|copy_link_thread"),key:"copy_link_to_thread"},i.createElement(Oi.A,null)))}function Bi(e){return e.getUnsigned()["io.element.late_event"]}var ji=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/pin-solid.js");function Wi(){return i.createElement("div",{className:"mx_PinnedMessageBadge"},i.createElement(ji.A,{width:"16px",height:"16px"}),(0,l._t)("room|pinned_message_badge"))}function zi(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Hi(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?zi(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):zi(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Ki(e){return!(!(0,It.S8)(e)&&e.getType()!==o.EventType.RoomMessageEncrypted)}class Ji extends i.Component{constructor(e,t){super(e,t),(0,v.A)(this,"suppressReadReceiptAnimation",void 0),(0,v.A)(this,"isListeningForReceipts",void 0),(0,v.A)(this,"tile",(0,i.createRef)()),(0,v.A)(this,"replyChain",(0,i.createRef)()),(0,v.A)(this,"ref",(0,i.createRef)()),(0,v.A)(this,"unmounted",!1),(0,v.A)(this,"updateThread",(e=>{this.setState({thread:e})})),(0,v.A)(this,"onNewThread",(e=>{if(e.id===this.props.mxEvent.getId()){this.updateThread(e);const t=_.J.safeGet().getRoom(this.props.mxEvent.getRoomId());null==t||t.off(o.ThreadEvent.New,this.onNewThread)}})),(0,v.A)(this,"viewInRoom",(e=>{e.preventDefault(),e.stopPropagation(),S.A.dispatch({action:W.r.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:void 0})})),(0,v.A)(this,"copyLinkToThread",(async e=>{e.preventDefault(),e.stopPropagation();const{permalinkCreator:t,mxEvent:n}=this.props;if(!t)return;const i=t.forEvent(n.getId());await(0,Qn.nC)(i)})),(0,v.A)(this,"onRoomReceipt",((e,t)=>{t===_.J.safeGet().getRoom(this.props.mxEvent.getRoomId())&&(this.shouldShowSentReceipt||this.shouldShowSendingReceipt||this.isListeningForReceipts)&&this.forceUpdate((()=>{this.shouldShowSentReceipt||this.shouldShowSendingReceipt||(_.J.safeGet().removeListener(o.RoomEvent.Receipt,this.onRoomReceipt),this.isListeningForReceipts=!1)}))})),(0,v.A)(this,"onDecrypted",(()=>{this.verifyEvent(),this.forceUpdate(this.props.onHeightChanged)})),(0,v.A)(this,"onUserVerificationChanged",((e,t)=>{e===this.props.mxEvent.getSender()&&this.verifyEvent()})),(0,v.A)(this,"onReplaced",(()=>{this.verifyEvent()})),(0,v.A)(this,"onSenderProfileClick",(()=>{S.A.dispatch({action:W.r.ComposerInsert,userId:this.props.mxEvent.getSender(),timelineRenderingType:this.context.timelineRenderingType})})),(0,v.A)(this,"onPermalinkClicked",(e=>{e.preventDefault(),S.A.dispatch({action:W.r.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:this.context.timelineRenderingType===jt.Ae.Search?"MessageSearch":void 0})})),(0,v.A)(this,"onActionBarFocusChange",(e=>{this.setState({actionBarFocused:e})})),(0,v.A)(this,"getTile",(()=>this.tile.current)),(0,v.A)(this,"getReplyChain",(()=>this.replyChain.current)),(0,v.A)(this,"getReactions",(()=>{var e;if(!this.props.showReactions||!this.props.getRelationsForEvent)return null;const t=this.props.mxEvent.getId();return null!==(e=this.props.getRelationsForEvent(t,"m.annotation","m.reaction"))&&void 0!==e?e:null})),(0,v.A)(this,"onReactionsCreated",((e,t)=>{"m.annotation"===e&&"m.reaction"===t&&this.setState({reactions:this.getReactions()})})),(0,v.A)(this,"onContextMenu",(e=>{this.showContextMenu(e)})),(0,v.A)(this,"onTimestampContextMenu",(e=>{var t;this.showContextMenu(e,null===(t=this.props.permalinkCreator)||void 0===t?void 0:t.forEvent(this.props.mxEvent.getId()))})),(0,v.A)(this,"onCloseMenu",(()=>{this.setState({contextMenu:void 0,actionBarFocused:!1})})),(0,v.A)(this,"setQuoteExpanded",(e=>{this.setState({isQuoteExpanded:e})}));const n=this.thread;this.state={actionBarFocused:!1,shieldColour:V.EventShieldColour.NONE,shieldReason:null,reactions:this.getReactions(),hover:!1,thread:n},this.suppressReadReceiptAnimation=!0,this.isListeningForReceipts=!1}get isEligibleForSpecialReceipt(){if(this.props.readReceipts&&this.props.readReceipts.length>0)return!1;if(!this.props.mxEvent)return!1;if(!_.J.safeGet().getRoom(this.props.mxEvent.getRoomId()))return!1;const e=_.J.safeGet().getSafeUserId();return this.props.mxEvent.getSender()===e&&Ki(this.props.mxEvent)}get shouldShowSentReceipt(){if(!this.isEligibleForSpecialReceipt)return!1;if(!this.props.lastSuccessful)return!1;if(this.props.eventSendStatus&&this.props.eventSendStatus!==o.EventStatus.SENT)return!1;const e=this.props.readReceipts||[],t=_.J.safeGet().getUserId();return!e.some((e=>e.userId!==t))}get shouldShowSendingReceipt(){return!!this.isEligibleForSpecialReceipt&&!(!this.props.eventSendStatus||this.props.eventSendStatus===o.EventStatus.SENT)}componentDidMount(){this.unmounted=!1,this.suppressReadReceiptAnimation=!1;const e=_.J.safeGet();this.props.forExport||(e.on(V.CryptoEvent.UserTrustStatusChanged,this.onUserVerificationChanged),this.props.mxEvent.on(o.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.on(o.MatrixEventEvent.Replaced,this.onReplaced),ii.instance.addVisibleEvent(this.props.mxEvent),this.props.showReactions&&this.props.mxEvent.on(o.MatrixEventEvent.RelationsCreated,this.onReactionsCreated),(this.shouldShowSentReceipt||this.shouldShowSendingReceipt)&&(e.on(o.RoomEvent.Receipt,this.onRoomReceipt),this.isListeningForReceipts=!0)),this.props.mxEvent.on(o.ThreadEvent.Update,this.updateThread),e.decryptEventIfNeeded(this.props.mxEvent);const t=e.getRoom(this.props.mxEvent.getRoomId());null==t||t.on(o.ThreadEvent.New,this.onNewThread),this.verifyEvent()}shouldComponentUpdate(e,t){return!!(0,$t.No)(this.state,t)||!this.propsEqual(this.props,e)}componentWillUnmount(){const e=_.J.get();if(e){e.removeListener(V.CryptoEvent.UserTrustStatusChanged,this.onUserVerificationChanged),e.removeListener(o.RoomEvent.Receipt,this.onRoomReceipt);const t=e.getRoom(this.props.mxEvent.getRoomId());null==t||t.off(o.ThreadEvent.New,this.onNewThread)}this.isListeningForReceipts=!1,this.props.mxEvent.removeListener(o.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.removeListener(o.MatrixEventEvent.Replaced,this.onReplaced),this.props.showReactions&&this.props.mxEvent.removeListener(o.MatrixEventEvent.RelationsCreated,this.onReactionsCreated),this.props.mxEvent.off(o.ThreadEvent.Update,this.updateThread),this.unmounted=!1}componentDidUpdate(e,t){t.shieldColour!==this.state.shieldColour&&this.props.onHeightChanged&&this.props.onHeightChanged(),this.isListeningForReceipts||!this.shouldShowSentReceipt&&!this.shouldShowSendingReceipt||(_.J.safeGet().on(o.RoomEvent.Receipt,this.onRoomReceipt),this.isListeningForReceipts=!0),e.eventSendStatus!==this.props.eventSendStatus&&this.verifyEvent()}get thread(){var e;let t=this.props.mxEvent.getThread();if(!t){var n;const e=_.J.safeGet().getRoom(this.props.mxEvent.getRoomId());t=null!==(n=null==e?void 0:e.findThreadForEvent(this.props.mxEvent))&&void 0!==n?n:void 0}return null!==(e=t)&&void 0!==e?e:null}renderThreadPanelSummary(){return this.state.thread?i.createElement("div",{className:"mx_ThreadPanel_replies"},i.createElement("span",{className:"mx_ThreadPanel_replies_amount"},this.state.thread.length),i.createElement(bi,{thread:this.state.thread})):null}renderThreadInfo(){return this.state.thread&&this.state.thread.id===this.props.mxEvent.getId()?i.createElement(wi,{mxEvent:this.props.mxEvent,thread:this.state.thread}):this.context.timelineRenderingType===jt.Ae.Search&&this.props.mxEvent.threadRootId?this.props.highlightLink?i.createElement("a",{className:"mx_ThreadSummary_icon",href:this.props.highlightLink},(0,l._t)("timeline|thread_info_basic")):i.createElement("p",{className:"mx_ThreadSummary_icon"},(0,l._t)("timeline|thread_info_basic")):void 0}verifyEvent(){this.doVerifyEvent().catch((e=>{const t=this.props.mxEvent;s.v.error(`Error getting encryption info on event ${t.getId()} in room ${t.getRoomId()}`,e)}))}async doVerifyEvent(){var e,t,n;const i=null!==(e=this.props.mxEvent.replacingEvent())&&void 0!==e?e:this.props.mxEvent;if(!i.isEncrypted()||i.isRedacted())return void this.setState({shieldColour:V.EventShieldColour.NONE,shieldReason:null});const s=null!==(t=await(null===(n=_.J.safeGet().getCrypto())||void 0===n?void 0:n.getEncryptionInfoForEvent(i)))&&void 0!==t?t:null;this.unmounted||(null!==s?this.setState({shieldColour:s.shieldColour,shieldReason:s.shieldReason}):this.setState({shieldColour:V.EventShieldColour.NONE,shieldReason:null}))}propsEqual(e,t){const n=Object.keys(e),i=Object.keys(t);if(n.length!==i.length)return!1;for(let i=0;i<n.length;i++){const s=n[i];if(!t.hasOwnProperty(s))return!1;if("readReceipts"===s){const n=e[s],i=t[s];if(n===i)continue;if(!n||!i)return!1;if(n.length!==i.length)return!1;for(let e=0;e<n.length;e++){if(n[e].userId!==i[e].userId)return!1;if(n[e].roomMember!==i[e].roomMember)return!1}}else if(e[s]!==t[s])return!1}return!0}shouldHighlight(){if(this.props.forExport)return!1;if(this.context.timelineRenderingType===jt.Ae.Notification)return!1;if(this.context.timelineRenderingType===jt.Ae.ThreadsList)return!1;const e=_.J.safeGet(),t=e.getPushActionsForEvent(this.props.mxEvent.replacingEvent()||this.props.mxEvent),n=this.props.mxEvent.replacingEvent()?e.getPushActionsForEvent(this.props.mxEvent):void 0;return!!(null!=t&&t.tweaks||null!=n&&n.tweaks)&&(this.props.mxEvent.getSender()!==e.credentials.userId&&!!(null!=t&&t.tweaks.highlight||null!=n&&n.tweaks.highlight))}renderE2EPadlock(){var e;const t=null!==(e=this.props.mxEvent.replacingEvent())&&void 0!==e?e:this.props.mxEvent;if((0,Pi.F)(t.getRoomId()))return null;if(t.isDecryptionFailure())switch(t.decryptionFailureReason){case V.DecryptionFailureCode.SENDER_IDENTITY_PREVIOUSLY_VERIFIED:case V.DecryptionFailureCode.UNSIGNED_SENDER_DEVICE:return null;default:return i.createElement(qi,null)}if(this.state.shieldColour!==V.EventShieldColour.NONE){let e;switch(this.state.shieldReason){case null:case V.EventShieldReason.UNKNOWN:e=(0,l._t)("error|unknown");break;case V.EventShieldReason.UNVERIFIED_IDENTITY:e=(0,l._t)("encryption|event_shield_reason_unverified_identity");break;case V.EventShieldReason.UNSIGNED_DEVICE:e=(0,l._t)("encryption|event_shield_reason_unsigned_device");break;case V.EventShieldReason.UNKNOWN_DEVICE:e=(0,l._t)("encryption|event_shield_reason_unknown_device");break;case V.EventShieldReason.AUTHENTICITY_NOT_GUARANTEED:e=(0,l._t)("encryption|event_shield_reason_authenticity_not_guaranteed");break;case V.EventShieldReason.MISMATCHED_SENDER_KEY:e=(0,l._t)("encryption|event_shield_reason_mismatched_sender_key")}return this.state.shieldColour===V.EventShieldColour.GREY?i.createElement(Qi,{icon:Yi.Normal,title:e}):i.createElement(Qi,{icon:Yi.Warning,title:e})}if(_.J.safeGet().isRoomEncrypted(t.getRoomId())){if(t.status===o.EventStatus.ENCRYPTING)return null;if(t.status===o.EventStatus.NOT_SENT)return null;if(t.isState())return null;if(t.isRedacted())return null;if(!t.isEncrypted())return i.createElement($i,null)}return null}showContextMenu(e,t){var n;const i=e.target,s=i instanceof HTMLAnchorElement?i:i.closest("a");i instanceof HTMLImageElement||(null!==(n=a.A.get())&&void 0!==n&&n.allowOverridingNativeContextMenus()||!(0,Qn.j5)()&&!s)&&(this.props.editState||(e.preventDefault(),e.stopPropagation(),this.setState({contextMenu:{position:{left:e.clientX,top:e.clientY,bottom:e.clientY},link:(null==s?void 0:s.href)||t},actionBarFocused:!0})))}shouldHideEvent(){var e;return(null===(e=this.props.callEventGrouper)||void 0===e?void 0:e.hangupReason)===ft.Il.Replaced}renderContextMenu(){if(!this.state.contextMenu)return null;const e=this.getTile(),t=this.getReplyChain(),n=null!=e&&e.getEventTileOps?e.getEventTileOps():void 0,s=null!=t&&t.canCollapse()?t.collapse:void 0;return i.createElement(Jt.A,(0,_t.A)({},(0,Gt.ps)(this.state.contextMenu.position),{mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator,eventTileOps:n,collapseReplyChain:s,onFinished:this.onCloseMenu,rightClick:!0,reactions:this.state.reactions,link:this.state.contextMenu.link,getRelationsForEvent:this.props.getRelationsForEvent}))}render(){var e,t,n;const r=this.props.mxEvent.getContent().msgtype,a=this.props.mxEvent.getType(),{hasRenderer:c,isBubbleMessage:d,isInfoMessage:m,isLeftAlignedBubbleMessage:u,noBubbleEvent:h,isSeeingThroughMessageHiddenForModeration:p}=Nt(_.J.safeGet(),this.props.mxEvent,this.context.showHiddenEvents,this.shouldHideEvent()),{isQuoteExpanded:g}=this.state;if(!c){const{mxEvent:e}=this.props;return s.v.warn(`Event type not supported: type:${a} isState:${e.isState()}`),i.createElement("div",{className:"mx_EventTile mx_EventTile_info mx_MNoticeBody"},i.createElement("div",{className:"mx_EventTile_line"},(0,l._t)("timeline|error_no_renderer")))}const v=An.j.isEligible(this.props.mxEvent),f=dt()("mx_EventTile_line",{mx_EventTile_mediaLine:v,mx_EventTile_image:this.props.mxEvent.getType()===o.EventType.RoomMessage&&this.props.mxEvent.getContent().msgtype===o.MsgType.Image,mx_EventTile_sticker:this.props.mxEvent.getType()===o.EventType.Sticker,mx_EventTile_emote:this.props.mxEvent.getType()===o.EventType.RoomMessage&&this.props.mxEvent.getContent().msgtype===o.MsgType.Emote}),E=["sending","queued","encrypting"].includes(this.props.eventSendStatus),y=(0,It.S8)(this.props.mxEvent)&&this.props.isRedacted,b=this.props.mxEvent.isDecryptionFailure();let w=this.props.continuation;this.context.timelineRenderingType!==jt.Ae.Room&&this.context.timelineRenderingType!==jt.Ae.Search&&this.context.timelineRenderingType!==jt.Ae.Thread&&this.props.layout!==gt.P.Bubble&&(w=!1);const A=this.context.timelineRenderingType===jt.Ae.Notification,C=!!this.props.editState,x=dt()({mx_EventTile_bubbleContainer:d,mx_EventTile_leftAlignedBubble:u,mx_EventTile:!0,mx_EventTile_isEditing:C,mx_EventTile_info:m,mx_EventTile_12hr:this.props.isTwelveHour,mx_EventTile_sending:!C&&E,mx_EventTile_highlight:this.shouldHighlight(),mx_EventTile_selected:this.props.isSelectedEvent||this.state.contextMenu,mx_EventTile_continuation:w||a===o.EventType.CallInvite||Tt.Ho.CALL_EVENT_TYPE.matches(a),mx_EventTile_last:this.props.last,mx_EventTile_lastInSection:this.props.lastInSection,mx_EventTile_contextual:this.props.contextual,mx_EventTile_actionBarFocused:this.state.actionBarFocused,mx_EventTile_bad:b,mx_EventTile_emote:r===o.MsgType.Emote,mx_EventTile_noSender:this.props.hideSender,mx_EventTile_clamp:this.context.timelineRenderingType===jt.Ae.ThreadsList||A,mx_EventTile_noBubble:h}),k=null!==this.props.eventSendStatus?"off":void 0;let R="#";this.props.permalinkCreator&&(R=this.props.permalinkCreator.forEvent(this.props.mxEvent.getId()));const I=this.props.mxEvent.status?void 0:this.props.mxEvent.getId();let T,P,N=null,D=null;if(A?(T="24px",P=!0):m?(T="14px",P=!1):this.context.timelineRenderingType===jt.Ae.ThreadsList||this.context.timelineRenderingType===jt.Ae.Thread&&!this.props.continuation?(T="32px",P=!0):a===o.EventType.RoomCreate||d?(T=null,P=!1):this.props.layout==gt.P.IRC?(T="14px",P=!0):this.props.continuation&&this.context.timelineRenderingType!==jt.Ae.File||a===o.EventType.CallInvite||Tt.Ho.CALL_EVENT_TYPE.matches(a)?(T=null,P=!1):this.context.timelineRenderingType===jt.Ae.File?(T="20px",P=!0):(T="30px",P=!0),this.props.mxEvent.sender&&null!==T){let e=null;e=this.props.mxEvent.getContent().third_party_invite?this.props.mxEvent.target:this.props.mxEvent.sender;const t=!this.props.inhibitInteraction&&![jt.Ae.ThreadsList,jt.Ae.Notification].includes(this.context.timelineRenderingType);N=i.createElement("div",{className:"mx_EventTile_avatar"},i.createElement(Mt.A,{member:e,size:T,viewUserOnClick:t,forceHistorical:this.props.mxEvent.getType()===o.EventType.RoomMember}))}P&&!0!==this.props.hideSender&&(D=this.context.timelineRenderingType===jt.Ae.Room||this.context.timelineRenderingType===jt.Ae.Search||this.context.timelineRenderingType===jt.Ae.Pinned||this.context.timelineRenderingType===jt.Ae.Thread?i.createElement(Ct,{onClick:this.onSenderProfileClick,mxEvent:this.props.mxEvent}):this.context.timelineRenderingType===jt.Ae.ThreadsList?i.createElement(Ct,{mxEvent:this.props.mxEvent,withTooltip:!0}):i.createElement(Ct,{mxEvent:this.props.mxEvent}));const M=!C&&!this.props.forExport?i.createElement(Fn,{mxEvent:this.props.mxEvent,reactions:this.state.reactions,permalinkCreator:this.props.permalinkCreator,getTile:this.getTile,getReplyChain:this.getReplyChain,onFocusChange:this.onActionBarFocusChange,isQuoteExpanded:g,toggleThreadExpanded:()=>this.setQuoteExpanded(!g),getRelationsForEvent:this.props.getRelationsForEvent}):void 0,O=this.props.mxEvent.getTs()&&!this.props.hideTimestamp&&(this.props.alwaysShowTimestamps||this.props.last||this.state.hover||this.state.actionBarFocused||Boolean(this.state.contextMenu));let L=this.context.timelineRenderingType!==jt.Ae.ThreadsList?this.props.mxEvent.getTs():null===(e=this.state.thread)||void 0===e||null===(e=e.replyToEvent)||void 0===e?void 0:e.getTs();"number"!=typeof L&&(L=this.props.mxEvent.getTs());const U=i.createElement(Qt.A,{showRelative:this.context.timelineRenderingType===jt.Ae.ThreadsList,showTwelveHour:this.props.isTwelveHour,ts:L,receivedTs:null===(t=Bi(this.props.mxEvent))||void 0===t?void 0:t.received_ts}),F=O&&L?U:null;let V,B;Dn.A.isPinned(_.J.safeGet(),this.props.mxEvent)&&(V=i.createElement(Wi,null)),y||(B=i.createElement(qn,{mxEvent:this.props.mxEvent,reactions:this.state.reactions,key:"mx_EventTile_reactionsRow"}));const j=Boolean(B&&this.state.reactions||V),z=this.props.hideTimestamp?null:i.createElement("a",{href:R,onClick:this.onPermalinkClicked,"aria-label":(0,Re.fU)(new Date(this.props.mxEvent.getTs()),this.props.isTwelveHour),onContextMenu:this.onTimestampContextMenu},F),H=this.props.layout===gt.P.IRC,K=H?null:z,J=H?z:null,G=this.props.layout===gt.P.Bubble?U:void 0,$=!H&&!d&&this.renderE2EPadlock(),q=H&&!d&&this.renderE2EPadlock();let Y,Q;if(this.shouldShowSentReceipt||this.shouldShowSendingReceipt)Y=i.createElement(Xi,{messageState:this.props.mxEvent.getAssociatedStatus()});else if(this.props.showReadReceipts){var X,Z;Y=i.createElement(Ri,{readReceipts:null!==(X=this.props.readReceipts)&&void 0!==X?X:[],readReceiptMap:null!==(Z=this.props.readReceiptMap)&&void 0!==Z?Z:{},checkUnmounting:this.props.checkUnmounting,suppressAnimation:this.suppressReadReceiptAnimation,isTwelveHour:this.props.isTwelveHour})}(0,It.bN)(this.props.mxEvent,_.J.safeGet(),this.context.showHiddenEvents)&&(0,Bt.c$)(this.props.mxEvent)&&(Q=i.createElement(Wt,{parentEv:this.props.mxEvent,onHeightChanged:this.props.onHeightChanged,ref:this.replyChain,forExport:this.props.forExport,permalinkCreator:this.props.permalinkCreator,layout:this.props.layout,alwaysShowTimestamps:this.props.alwaysShowTimestamps||this.state.hover,isQuoteExpanded:g,setQuoteExpanded:this.setQuoteExpanded,getRelationsForEvent:this.props.getRelationsForEvent}));const ee=(null===(n=this.props.mxEvent)||void 0===n?void 0:n.getSender())===_.J.safeGet().getUserId();switch(this.context.timelineRenderingType){case jt.Ae.Thread:return i.createElement(this.props.as||"li",{ref:this.ref,className:x,"aria-live":k,"aria-atomic":!0,"data-scroll-tokens":I,"data-has-reply":!!Q,"data-layout":this.props.layout,"data-self":ee,"data-event-id":this.props.mxEvent.getId(),onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1})},[i.createElement("div",{className:"mx_EventTile_senderDetails",key:"mx_EventTile_senderDetails"},N,D),i.createElement("div",{className:f,key:"mx_EventTile_line",onContextMenu:this.onContextMenu},this.renderContextMenu(),Q,(0,It.rd)(jt.Ae.Thread,Hi(Hi({},this.props),{},{ref:this.tile,isSeeingThroughMessageHiddenForModeration:p,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:()=>this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),this.context.showHiddenEvents),M,i.createElement("a",{href:R,onClick:this.onPermalinkClicked},F),Y),j&&i.createElement("div",{className:"mx_EventTile_footer",key:"mx_EventTile_footer"},(this.props.layout===gt.P.Group||!ee)&&V,B,this.props.layout===gt.P.Bubble&&ee&&V)]);case jt.Ae.Notification:case jt.Ae.ThreadsList:{const e=_.J.safeGet().getRoom(this.props.mxEvent.getRoomId());return i.createElement(this.props.as||"li",{ref:this.ref,className:x,tabIndex:-1,"aria-live":k,"aria-atomic":"true","data-scroll-tokens":I,"data-layout":this.props.layout,"data-shape":this.context.timelineRenderingType,"data-self":ee,"data-has-reply":!!Q,onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1}),onClick:e=>{var t;const n=e.currentTarget;let i=-1;switch(n.parentElement&&(i=Array.from(n.parentElement.children).indexOf(n)),this.context.timelineRenderingType){case jt.Ae.Notification:this.viewInRoom(e);break;case jt.Ae.ThreadsList:S.A.dispatch({action:W.r.ShowThread,rootEvent:this.props.mxEvent,push:!0}),Mn.A.trackInteraction("WebThreadsPanelThreadItem",e,null!==(t=i)&&void 0!==t?t:-1)}}},i.createElement(i.Fragment,null,i.createElement("div",{className:"mx_EventTile_details"},D,A&&e?i.createElement("span",{className:"mx_EventTile_truncated"}," ",(0,l._t)("timeline|in_room_name",{room:e.name},{strong:e=>i.createElement("strong",null,e)})):"",F,i.createElement(Di,{room:e||void 0,threadId:this.props.mxEvent.getId(),forceDot:!0})),A&&e?i.createElement("div",{className:"mx_EventTile_avatar"},i.createElement(Kt.A,{room:e,size:"28px"})):N,i.createElement("div",{className:f,key:"mx_EventTile_line"},i.createElement("div",{className:"mx_EventTile_body"},this.props.mxEvent.isRedacted()?i.createElement(si.A,{mxEvent:this.props.mxEvent}):this.props.mxEvent.isDecryptionFailure()?i.createElement(Ht.A,{mxEvent:this.props.mxEvent}):i.createElement(vi,{mxEvent:this.props.mxEvent})),this.renderThreadPanelSummary()),this.context.timelineRenderingType===jt.Ae.ThreadsList&&i.createElement(Vi,{viewInRoom:this.viewInRoom,copyLinkToThread:this.copyLinkToThread}),Y))}case jt.Ae.File:return i.createElement(this.props.as||"li",{className:x,"aria-live":k,"aria-atomic":!0,"data-scroll-tokens":I},[i.createElement("a",{className:"mx_EventTile_senderDetailsLink",key:"mx_EventTile_senderDetailsLink",href:R,onClick:this.onPermalinkClicked},i.createElement("div",{className:"mx_EventTile_senderDetails",onContextMenu:this.onTimestampContextMenu},N,D,F)),i.createElement("div",{className:f,key:"mx_EventTile_line",onContextMenu:this.onContextMenu},this.renderContextMenu(),(0,It.rd)(jt.Ae.File,Hi(Hi({},this.props),{},{ref:this.tile,isSeeingThroughMessageHiddenForModeration:p,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),this.context.showHiddenEvents))]);default:return i.createElement(this.props.as||"li",{ref:this.ref,className:x,tabIndex:-1,"aria-live":k,"aria-atomic":"true","data-scroll-tokens":I,"data-layout":this.props.layout,"data-self":ee,"data-event-id":this.props.mxEvent.getId(),"data-has-reply":!!Q,onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1})},i.createElement(i.Fragment,null,J,D,q,N,i.createElement("div",{className:f,key:"mx_EventTile_line",onContextMenu:this.onContextMenu},this.renderContextMenu(),K,$,Q,(0,It.rd)(this.context.timelineRenderingType,Hi(Hi({},this.props),{},{ref:this.tile,isSeeingThroughMessageHiddenForModeration:p,timestamp:G,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),this.context.showHiddenEvents),M,this.props.layout===gt.P.IRC&&i.createElement(i.Fragment,null,j&&i.createElement("div",{className:"mx_EventTile_footer"},V,B),this.renderThreadInfo())),this.props.layout!==gt.P.IRC&&i.createElement(i.Fragment,null,j&&i.createElement("div",{className:"mx_EventTile_footer"},(this.props.layout===gt.P.Group||!ee)&&V,B,this.props.layout===gt.P.Bubble&&ee&&V),this.renderThreadInfo()),Y))}}}(0,v.A)(Ji,"defaultProps",{onHeightChanged:function(){},forExport:!1,layout:gt.P.Group}),(0,v.A)(Ji,"contextType",jt.Ay);const Gi=(0,i.forwardRef)(((e,t)=>{var n;return i.createElement(i.Fragment,null,i.createElement(ri,{mxEvent:e.mxEvent,layout:null!==(n=e.layout)&&void 0!==n?n:gt.P.Group},i.createElement(Ji,(0,_t.A)({ref:t},e))))}));function $i(e){return i.createElement(Qi,(0,_t.A)({title:(0,l._t)("common|unencrypted"),icon:Yi.Warning},e))}function qi(e){return i.createElement(Qi,(0,_t.A)({title:(0,l._t)("timeline|undecryptable_tooltip"),icon:Yi.DecryptionFailure},e))}var Yi=function(e){return e.Normal="normal",e.Warning="warning",e.DecryptionFailure="decryption_failure",e}(Yi||{});class Qi extends i.Component{constructor(e){super(e),this.state={hover:!1}}render(){const e=`mx_EventTile_e2eIcon mx_EventTile_e2eIcon_${this.props.icon}`;return i.createElement(Et.m,{label:this.props.title,isTriggerInteractive:!0},i.createElement("div",{className:e,tabIndex:0,"aria-label":(0,l._t)("timeline|e2e_state")}))}}function Xi({messageState:e}){const t=!e||"sent"===e,n="not_sent"===e,s=dt()({mx_EventTile_receiptSent:t,mx_EventTile_receiptSending:!t&&!n});let o;n&&(o=i.createElement(Yt.A,{notification:qt.d.RED_EXCLAMATION}));let r=(0,l._t)("timeline|send_state_sending");return"encrypting"===e?r=(0,l._t)("timeline|send_state_encrypting"):t?r=(0,l._t)("timeline|send_state_sent"):n&&(r=(0,l._t)("timeline|send_state_failed")),i.createElement("div",{className:"mx_EventTile_msgOption"},i.createElement("div",{className:"mx_ReadReceiptGroup"},i.createElement(Et.m,{label:r,placement:"top-end"},i.createElement("div",{className:"mx_ReadReceiptGroup_button",role:"status"},i.createElement("span",{className:"mx_ReadReceiptGroup_container"},i.createElement("span",{className:s},o))))))}var Zi=n("./src/components/structures/SearchBox.tsx"),es=n("./src/components/views/avatars/DecoratedRoomAvatar.tsx"),ts=n("./src/stores/room-list/algorithms/tag-sorting/RecentAlgorithm.ts"),ns=n("./src/autocomplete/QueryMatcher.ts"),is=n("./src/components/views/elements/TruncatedList.tsx"),ss=n("./src/components/views/rooms/E2EIcon.tsx"),os=n("./src/components/views/avatars/BaseAvatar.tsx"),rs=n("./src/components/views/rooms/PresenceLabel.tsx");let as=function(e){return e.Admin="admin",e.Moderator="moderator",e}({});const ls={[as.Admin]:(0,l.AO)("power_level|admin"),[as.Moderator]:(0,l.AO)("power_level|mod")},cs={offline:"mx_EntityTile_offline",online:"mx_EntityTile_online",unavailable:"mx_EntityTile_unavailable","io.element.unreachable":"mx_EntityTile_unreachable"};class ds extends i.PureComponent{constructor(e){super(e),this.state={hover:!1}}getPresenceLabel(){if(!this.props.showPresence)return;const e=this.props.presenceLastActiveAgo?Date.now()-(this.props.presenceLastTs-this.props.presenceLastActiveAgo):-1;return i.createElement(rs.A,{activeAgo:e,currentlyActive:this.props.presenceCurrentlyActive,presenceState:this.props.presenceState})}render(){const e={mx_EntityTile:!0};this.props.className&&(e[this.props.className]=!0);var t,n;e[(t=this.props.presenceState,n=this.props.presenceLastActiveAgo,!1===this.props.showPresence?"mx_EntityTile_online_beenactive":"offline"===t?n?cs.offline+"_beenactive":cs.offline+"_neveractive":t?cs[t]:cs.offline+"_neveractive")]=!0;const s=this.props.nameJSX||this.props.name,o=i.createElement("div",{className:"mx_EntityTile_details"},i.createElement("div",{className:"mx_EntityTile_name"},s),this.getPresenceLabel());let r;const a=this.props.powerStatus;if(a){const e=(0,l._t)(ls[a]);r=i.createElement("div",{className:"mx_EntityTile_power"},e)}let c;const{e2eStatus:d}=this.props;d&&(c=i.createElement(ss.A,{status:d,isUser:!0,bordered:!0}));const m=this.props.avatarJsx||i.createElement(os.A,{name:this.props.name,size:"36px","aria-hidden":"true"});return i.createElement("div",null,i.createElement(ie.A,{className:dt()(e),title:this.props.title,onClick:this.props.onClick},i.createElement("div",{className:"mx_EntityTile_avatar"},m,c),o,r))}}(0,v.A)(ds,"defaultProps",{onClick:()=>{},presenceState:"offline",presenceLastActiveAgo:0,presenceLastTs:0,showInviteButton:!1,showPresence:!0});var ms=n("./src/utils/location/index.ts"),us=n("./src/stores/spaces/SpaceStore.ts");const hs=["room","component"];function ps(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function gs(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ps(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ps(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function vs(e){let{room:t,component:n}=e,s=(0,g.A)(e,hs);const o=function(e){const t=x.A.shared().getUserIdForRoomId(e.roomId),n=e.getMembers().length>2;if(!e.isSpaceRoom()&&t&&!n)return{details:t};const[i,s,...o]=us.Ay.instance.getKnownParents(e.roomId);if(s&&(null==o||!o.length)){var r,a;const t=null===(r=e.client.getRoom(i))||void 0===r?void 0:r.name,n=null===(a=e.client.getRoom(s))||void 0===a?void 0:a.name;return{details:(0,bt.ki)([null!=t?t:"",null!=n?n:""]),ariaLabel:(0,l._t)("in_space1_and_space2",{space1Name:t,space2Name:n})}}if(i){var c,d;const t=null!==(c=null===(d=e.client.getRoom(i))||void 0===d?void 0:d.name)&&void 0!==c?c:"",n=o.length;return n>0?{details:(0,bt.ki)([t,...o],1),ariaLabel:(0,l._t)("in_space_and_n_other_spaces",{spaceName:t,count:n})}:{details:t,ariaLabel:(0,l._t)("in_space",{spaceName:t})}}return{details:e.getCanonicalAlias()}}(t);return o?i.createElement(null!=n?n:"div",gs(gs({},s),{},{"aria-label":o.ariaLabel}),[o.details]):i.createElement(i.Fragment,null)}var _s=n("./src/KeyBindingsManager.ts");const fs=["m.relates_to"];function Es(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function ys(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Es(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Es(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var bs=function(e){return e[e.CanSend=0]="CanSend",e[e.Sending=1]="Sending",e[e.Sent=2]="Sent",e[e.Failed=3]="Failed",e}(bs||{});const ws=({room:e,type:t,content:n,matrixClient:s,onFinished:o})=>{const[r,a]=(0,i.useState)(bs.CanSend),[c,d,m]=(0,wn.A9)();let u,h,p,g=!1;r===bs.CanSend?(u="mx_ForwardList_canSend",e.maySendMessage()||(g=!0,h=(0,l._t)("forward|no_perms_title"))):r===bs.Sending?(u="mx_ForwardList_sending",g=!0,h=(0,l._t)("forward|sending"),p=i.createElement("div",{className:"mx_ForwardList_sendIcon","aria-label":h})):r===bs.Sent?(u="mx_ForwardList_sent",g=!0,h=(0,l._t)("forward|sent"),p=i.createElement("div",{className:"mx_ForwardList_sendIcon","aria-label":h})):(u="mx_ForwardList_sendFailed",g=!0,h=(0,l._t)("timeline|send_state_failed"),p=i.createElement(Yt.A,{notification:qt.d.RED_EXCLAMATION}));const v=`mx_ForwardDialog_entry_${e.roomId}`;return i.createElement("div",{className:dt()("mx_ForwardList_entry",{mx_ForwardList_entry_active:d}),"aria-labelledby":`${v}_name`,"aria-describedby":`${v}_send`,role:"listitem",ref:m,onFocus:c,id:v},i.createElement(ie.A,{className:"mx_ForwardList_roomButton",onClick:t=>{S.A.dispatch({action:W.r.ViewRoom,room_id:e.roomId,metricsTrigger:"WebForwardShortcut",metricsViaKeyboard:"click"!==t.type}),o(!0)},title:(0,l._t)("forward|open_room"),placement:"top",tabIndex:d?0:-1},i.createElement(es.A,{room:e,size:"32px",tooltipProps:{tabIndex:d?0:-1}}),i.createElement("span",{className:"mx_ForwardList_entry_name",id:`${v}_name`},e.name),i.createElement(vs,{component:"span",className:"mx_ForwardList_entry_detail",room:e})),i.createElement(ie.A,{kind:r===bs.Failed?"danger_outline":"primary_outline",className:`mx_ForwardList_sendButton ${u}`,onClick:async()=>{a(bs.Sending);try{await s.sendEvent(e.roomId,t,n),a(bs.Sent)}catch{a(bs.Failed)}},disabled:g,title:h,placement:"top",tabIndex:d?0:-1,id:`${v}_send`},i.createElement("div",{className:"mx_ForwardList_sendLabel"},(0,l._t)("forward|send_label")),p))},Ss=({matrixClient:e,event:t,permalinkCreator:n,onFinished:s})=>{const r=e.getSafeUserId(),[a,c]=(0,i.useState)({});(0,i.useEffect)((()=>{e.getProfileInfo(r).then((e=>c(e)))}),[e,r]);const{type:d,content:m}=(e=>{const t=e.getContent(),{"m.relates_to":n}=t,i=(0,g.A)(t,fs),s=o.M_BEACON.matches(e.getType())?o.EventType.RoomMessage:e.getType();if((0,Rt.wq)(e)&&(0,ms.qy)(i)||o.M_BEACON.matches(e.getType())){const t=o.M_TIMESTAMP.findIn(i),n=(0,ms.jm)(e);return{type:s,content:ys(ys({},i),o.ContentHelpers.makeLocationContent(void 0,n,t||Date.now(),void 0,o.LocationAssetType.Pin))}}return{type:s,content:i}})(t),u=new o.MatrixEvent({type:"m.room.message",sender:r,content:m,unsigned:{age:97},event_id:"$9999999999999999999999999999999999999999999",room_id:t.getRoomId(),origin_server_ts:t.getTs()});u.sender={name:a.displayname||r,rawDisplayName:a.displayname,userId:r,getAvatarUrl:(...e)=>(0,vt.r4)({avatarUrl:a.avatar_url},30,30,"crop"),getMxcAvatarUrl:()=>a.avatar_url};const[h,p]=(0,i.useState)(""),v=h.toLowerCase(),_=(0,pt.ti)("layout"),f=(0,pt.ti)("feature_dynamic_room_predecessors");let E=(0,i.useMemo)((()=>(0,ts.pP)(e.getVisibleRooms(f).filter((e=>e.getMyMembership()===ut.O.Join&&!e.isSpaceRoom())))),[e,f]);v&&(E=new ns.A(E,{keys:["name"],funcs:[e=>(0,Z.Bo)([e.getCanonicalAlias(),...e.getAltAliases()])],shouldMatchWordsOnly:!1}).match(v));const[y,b]=(0,i.useState)(20);function w(e,t){const n=(0,l._t)("common|and_n_others",{count:e});return i.createElement(ds,{className:"mx_EntityTile_ellipsis",avatarJsx:i.createElement(os.A,{url:ht.A,name:"...",size:"36px"}),name:n,showPresence:!1,onClick:()=>b(t)})}return i.createElement(J.A,{title:(0,l._t)("common|forward_message"),className:"mx_ForwardDialog",contentId:"mx_ForwardList",onFinished:s,fixedWidth:!1},i.createElement("h3",null,(0,l._t)("forward|message_preview_heading")),i.createElement("div",{className:dt()("mx_ForwardDialog_preview",{mx_IRCLayout:_==gt.P.IRC})},i.createElement(Gi,{mxEvent:u,layout:_,permalinkCreator:n,as:"div",inhibitInteraction:!0})),i.createElement("hr",null),i.createElement(wn.Se,{handleUpDown:!0,handleInputFields:!0,onKeyDown:(e,t)=>{let n=!0;var i;(0,_s.zM)().getAccessibilityAction(e)===Pn.bY.Enter?null===(i=t.activeNode)||void 0===i||null===(i=i.querySelector(".mx_ForwardList_sendButton"))||void 0===i||i.click():n=!1;n&&(e.preventDefault(),e.stopPropagation())},scrollIntoView:{block:"center"}},(({onKeyDownHandler:t})=>i.createElement("div",{className:"mx_ForwardList",id:"mx_ForwardList"},i.createElement(wn.ui.Consumer,null,(e=>{var n;return i.createElement(Zi.A,{className:"mx_textinput_icon mx_textinput_search",placeholder:(0,l._t)("forward|filter_placeholder"),onSearch:t=>{p(t),setTimeout((()=>{const t=e.state.nodes[0];var n;t&&(e.dispatch({type:wn.ZU.SetFocus,payload:{node:t}}),null==t||null===(n=t.scrollIntoView)||void 0===n||n.call(t,{block:"nearest"}))}))},autoFocus:!0,onKeyDown:t,"aria-activedescendant":null===(n=e.state.activeNode)||void 0===n?void 0:n.id,"aria-owns":"mx_ForwardDialog_resultsList"})})),i.createElement(xi.A,{className:"mx_ForwardList_content"},E.length>0?i.createElement("div",{className:"mx_ForwardList_results"},i.createElement(is.A,{id:"mx_ForwardDialog_resultsList",className:"mx_ForwardList_resultsList",truncateAt:y,createOverflowElement:w,getChildren:(t,n)=>E.slice(t,n).map((t=>i.createElement(ws,{key:t.roomId,room:t,type:d,content:m,matrixClient:e,onFinished:s}))),getChildCount:()=>E.length})):i.createElement("span",{className:"mx_ForwardList_noResults"},(0,l._t)("common|no_results")))))))};var As=n("./src/createRoom.ts"),Cs=n("./src/Markdown.ts"),xs=n("./src/components/views/elements/StyledRadioButton.tsx"),ks=n("./src/components/views/elements/Field.tsx"),Rs=n("./src/components/views/elements/LabelledCheckbox.tsx");const Is=["org.matrix.msc3215.room.moderation.moderated_by"];var Ts=function(e){return e.Disagreement="org.matrix.msc3215.abuse.nature.disagreement",e.Toxic="org.matrix.msc3215.abuse.nature.toxic",e.Illegal="org.matrix.msc3215.abuse.nature.illegal",e.Spam="org.matrix.msc3215.abuse.nature.spam",e.Other="org.matrix.msc3215.abuse.nature.other",e}(Ts||{}),Ps=function(e){return e.Admin="non-standard.abuse.nature.admin",e}(Ps||{});class Ns extends i.Component{constructor(e){super(e),(0,v.A)(this,"moderation",void 0),(0,v.A)(this,"componentDidMount",(async()=>{const e=_.J.safeGet().getCrypto(),t=this.props.mxEvent.getRoomId();e&&t&&this.setState({isRoomEncrypted:await e.isEncryptionEnabledInRoom(t)})})),(0,v.A)(this,"onIgnoreUserTooChanged",(e=>{this.setState({ignoreUserToo:e})})),(0,v.A)(this,"onReasonChange",(({target:{value:e}})=>{this.setState({reason:e})})),(0,v.A)(this,"onNatureChosen",(e=>{this.setState({nature:e.currentTarget.value})})),(0,v.A)(this,"onCancel",(()=>{this.props.onFinished(!1)})),(0,v.A)(this,"onSubmit",(async()=>{let e=this.state.reason||"";if(e=e.trim(),this.moderation){if(!this.state.nature||(this.state.nature==Ts.Other||this.state.nature==Ps.Admin)&&!e)return void this.setState({err:(0,l._t)("report_content|missing_reason")})}else if(!e)return void this.setState({err:(0,l._t)("report_content|missing_reason")});this.setState({busy:!0,err:void 0});try{const e=_.J.safeGet(),t=this.props.mxEvent;if(this.moderation&&this.state.nature!==Ps.Admin){const n=this.state.nature,i=await(0,As.EP)(e,this.moderation.moderationBotUserId);if(!i)throw new l.P7("report_content|error_create_room_moderation_bot");await e.sendEvent(i,"org.matrix.msc3215.abuse.report",{event_id:t.getId(),room_id:t.getRoomId(),moderated_by_id:this.moderation.moderationRoomId,nature:n,reporter:e.getUserId(),comment:this.state.reason.trim()})}else await e.reportEvent(t.getRoomId(),t.getId(),-100,this.state.reason.trim());this.state.ignoreUserToo&&await e.setIgnoredUsers([...e.getIgnoredUsers(),t.getSender()]),this.props.onFinished(!0)}catch(e){s.v.error(e),this.setState({busy:!1,err:e instanceof Error?e.message:String(e)})}}));let t=null,n=null;if(M.A.getValue("feature_report_to_moderators")){const i=_.J.safeGet().getRoom(e.mxEvent.getRoomId());for(const e of Is){const s=null==i?void 0:i.currentState.getStateEvents(e,e);if(!s)continue;if(Array.isArray(s))throw new TypeError(`getStateEvents(${e}, ${e}) should return at most one state event`);const o=s.event;if(!("content"in o)||"object"!=typeof o.content){console.debug("Moderation error","state event",e,"should have an object field `content`, got",o);continue}const r=o.content;"room_id"in r&&"string"==typeof r.room_id?"user_id"in r&&"string"==typeof r.user_id?(t=r.room_id,n=r.user_id):console.debug("Moderation error","state event",e,"should have a string field `content.user_id`, got",o):console.debug("Moderation error","state event",e,"should have a string field `content.room_id`, got",o)}t&&n&&(this.moderation={moderationRoomId:t,moderationBotUserId:n})}this.state={reason:"",busy:!1,err:void 0,nature:void 0,ignoreUserToo:!1,isRoomEncrypted:!1}}render(){var e;let t,n;this.state.err&&(t=i.createElement("div",{className:"error"},this.state.err)),this.state.busy&&(n=i.createElement("div",{className:"progress"},i.createElement(se.A,null)));const s=i.createElement(Rs.A,{value:this.state.ignoreUserToo,label:(0,l._t)("report_content|ignore_user"),byline:(0,l._t)("report_content|hide_messages_from_user"),onChange:this.onIgnoreUserTooChanged,disabled:this.state.busy}),o=null===(e=c.Ay.getObject("report_event"))||void 0===e?void 0:e.get("admin_message_md","adminMessageMD");let r;if(o){const e=new Cs.A(o).toHTML({externalLinks:!0});r=i.createElement("p",{dangerouslySetInnerHTML:{__html:e}})}if(this.moderation){const e=c.Ay.get("validated_server_config").hsName;let o;switch(this.state.nature){case Ts.Disagreement:o=(0,l._t)("report_content|nature_disagreement");break;case Ts.Toxic:o=(0,l._t)("report_content|nature_toxic");break;case Ts.Illegal:o=(0,l._t)("report_content|nature_illegal");break;case Ts.Spam:o=(0,l._t)("report_content|nature_spam");break;case Ps.Admin:o=this.state.isRoomEncrypted?(0,l._t)("report_content|nature_nonstandard_admin_encrypted",{homeserver:e}):(0,l._t)("report_content|nature_nonstandard_admin",{homeserver:e});break;case Ts.Other:o=(0,l._t)("report_content|nature_other");break;default:o=(0,l._t)("report_content|nature")}return i.createElement(J.A,{className:"mx_ReportEventDialog",onFinished:this.props.onFinished,title:(0,l._t)("action|report_content"),contentId:"mx_ReportEventDialog"},i.createElement("div",null,i.createElement(xs.A,{name:"nature",value:Ts.Disagreement,checked:this.state.nature==Ts.Disagreement,onChange:this.onNatureChosen},(0,l._t)("report_content|disagree")),i.createElement(xs.A,{name:"nature",value:Ts.Toxic,checked:this.state.nature==Ts.Toxic,onChange:this.onNatureChosen},(0,l._t)("report_content|toxic_behaviour")),i.createElement(xs.A,{name:"nature",value:Ts.Illegal,checked:this.state.nature==Ts.Illegal,onChange:this.onNatureChosen},(0,l._t)("report_content|illegal_content")),i.createElement(xs.A,{name:"nature",value:Ts.Spam,checked:this.state.nature==Ts.Spam,onChange:this.onNatureChosen},(0,l._t)("report_content|spam_or_propaganda")),i.createElement(xs.A,{name:"nature",value:Ps.Admin,checked:this.state.nature==Ps.Admin,onChange:this.onNatureChosen},(0,l._t)("report_content|report_entire_room")),i.createElement(xs.A,{name:"nature",value:Ts.Other,checked:this.state.nature==Ts.Other,onChange:this.onNatureChosen},(0,l._t)("report_content|other_label")),i.createElement("p",null,o),i.createElement(ks.A,{className:"mx_ReportEventDialog_reason",element:"textarea",label:(0,l._t)("room_settings|permissions|ban_reason"),rows:5,onChange:this.onReasonChange,value:this.state.reason,disabled:this.state.busy}),n,t,s),i.createElement(ot.A,{primaryButton:(0,l._t)("action|send_report"),onPrimaryButtonClick:this.onSubmit,focus:!0,onCancel:this.onCancel,disabled:this.state.busy}))}return i.createElement(J.A,{className:"mx_ReportEventDialog",onFinished:this.props.onFinished,title:(0,l._t)("report_content|report_content_to_homeserver"),contentId:"mx_ReportEventDialog"},i.createElement("div",{className:"mx_ReportEventDialog",id:"mx_ReportEventDialog"},i.createElement("p",null,(0,l._t)("report_content|description")),r,i.createElement(ks.A,{className:"mx_ReportEventDialog_reason",element:"textarea",label:(0,l._t)("room_settings|permissions|ban_reason"),rows:5,onChange:this.onReasonChange,value:this.state.reason,disabled:this.state.busy}),n,t,s),i.createElement(ot.A,{primaryButton:(0,l._t)("action|send_report"),onPrimaryButtonClick:this.onSubmit,focus:!0,onCancel:this.onCancel,disabled:this.state.busy}))}}var Ds=n("./src/components/structures/TabbedView.tsx"),Ms=n("./src/components/views/elements/StyledCheckbox.tsx");const Os=({room:e,children:t})=>{const[n,s]=(0,i.useState)(null==e?void 0:e.name);return(0,ci.YK)(e,o.RoomEvent.Name,(()=>{s(null==e?void 0:e.name)})),(0,i.useEffect)((()=>{s(null==e?void 0:e.name)}),[e]),t?t(null!=n?n:""):i.createElement(i.Fragment,null,n||"")};let Ls=function(e){return e.Appearance="SPACE_PREFERENCE_APPEARANCE_TAB",e}({});var Us=n("./src/components/views/settings/tabs/SettingsTab.tsx"),Fs=n("./src/components/views/settings/shared/SettingsSection.tsx"),Vs=n("./src/components/views/settings/shared/SettingsSubsection.tsx");const Bs=({space:e})=>{const t=(0,pt.ti)("Spaces.showPeopleInSpace",e.roomId);return i.createElement(Us.A,null,i.createElement(Fs.X,{heading:(0,l._t)("space|preferences|sections_section")},i.createElement(Vs.P,null,i.createElement(Ms.A,{checked:!!t,onChange:n=>{M.A.setValue("Spaces.showPeopleInSpace",e.roomId,O.p.ROOM_ACCOUNT,!t)}},(0,l._t)("common|people")),i.createElement(Vs.s,null,(0,l._t)("space|preferences|show_people_in_space",{spaceName:e.name})))))},js=({space:e,onFinished:t})=>{const n=[new Ds.oz(Ls.Appearance,(0,l.AO)("common|appearance"),"mx_SpacePreferencesDialog_appearanceIcon",i.createElement(Bs,{space:e}))];return i.createElement(J.A,{className:"mx_SpacePreferencesDialog",hasCancel:!0,onFinished:t,title:(0,l._t)("common|preferences"),fixedWidth:!1},i.createElement("h4",null,i.createElement(Os,{room:e})),i.createElement("div",{className:"mx_SettingsDialog_content"},i.createElement(Ds.Ay,{tabs:n,activeTabId:Ls.Appearance,onChange:()=>{}})))};var Ws=n("./src/hooks/useDispatcher.ts"),zs=n("./src/components/views/spaces/SpaceBasicSettings.tsx"),Hs=n("./src/editor/serialize.ts"),Ks=n("./src/utils/leave-behaviour.ts");const Js=e=>{var t;const n=null==e||null===(t=e.currentState)||void 0===t||null===(t=t.getStateEvents(o.EventType.RoomTopic,""))||void 0===t?void 0:t.getContent();return n?o.ContentHelpers.parseTopicContent(n):null};function Gs(e){const[t,n]=(0,i.useState)(Js(e));return(0,ci.YK)(null==e?void 0:e.currentState,o.RoomStateEvent.Events,(t=>{t.getType()===o.EventType.RoomTopic&&n(Js(e))})),(0,i.useEffect)((()=>{n(Js(e))}),[e]),t}const $s=({matrixClient:e,space:t})=>{var n,r,a;const[c,d]=(0,i.useState)(!1),[m,u]=(0,i.useState)(""),h=e.getUserId(),[p,g]=(0,i.useState)(null),v=t.currentState.maySendStateEvent(o.EventType.RoomAvatar,h),_=null!==p,[f,E]=(0,i.useState)(t.name),y=t.currentState.maySendStateEvent(o.EventType.RoomName,h),b=f!==t.name,w=null!==(n=null===(r=Js(t))||void 0===r?void 0:r.text)&&void 0!==n?n:"",[S,A]=(0,i.useState)(w),C=t.currentState.maySendStateEvent(o.EventType.RoomTopic,h),x=S!==w;return i.createElement(Us.A,null,i.createElement(Fs.X,{heading:(0,l._t)("common|general")},i.createElement("div",null,i.createElement("div",null,(0,l._t)("room_settings|general|description_space")),m&&i.createElement("div",{className:"mx_SpaceRoomView_errorText"},m),i.createElement(zs.A,{avatarUrl:null!==(a=(0,vt.ze)(t,80,80,"crop"))&&void 0!==a?a:void 0,avatarDisabled:c||!v,setAvatar:g,name:f,nameDisabled:c||!y,setName:E,topic:S,topicDisabled:c||!C,setTopic:A}),i.createElement(ie.A,{onClick:()=>{g(null),E(t.name),A(w)},disabled:c||!(_||b||x),kind:"link"},(0,l._t)("action|cancel")),i.createElement(ie.A,{onClick:async()=>{d(!0);const n=[];if(_&&(p?n.push((async()=>{const{content_uri:n}=await e.uploadContent(p);await e.sendStateEvent(t.roomId,o.EventType.RoomAvatar,{url:n},"")})()):n.push(e.sendStateEvent(t.roomId,o.EventType.RoomAvatar,{},""))),b&&n.push(e.setRoomName(t.roomId,f)),x){const i=(0,Hs.Ro)(S,{forceHTML:!1});n.push(e.setRoomTopic(t.roomId,S,i))}const i=await Promise.allSettled(n);d(!1);const r=i.filter((e=>"rejected"===e.status));r.length>0&&(s.v.error("Failed to save space settings: ",r),u((0,l._t)("room_settings|general|error_save_space_settings")))},disabled:c,kind:"primary"},c?(0,l._t)("common|saving"):(0,l._t)("room_settings|general|save"))),i.createElement(Vs.P,{heading:(0,l._t)("room_settings|general|leave_space")},i.createElement(ie.A,{kind:"danger",onClick:()=>{(0,Ks.e)(t)}},(0,l._t)("room_settings|general|leave_space")))))};var qs=n("./src/components/views/room_settings/AliasSettings.tsx"),Ys=n("./src/hooks/useStateToggle.ts"),Qs=n("./src/components/views/elements/LabelledToggleSwitch.tsx"),Xs=n("./src/hooks/useLocalEcho.ts"),Zs=n("./src/components/views/settings/JoinRuleSettings.tsx"),eo=n("./src/hooks/useRoomState.ts"),to=n("./src/components/views/settings/SettingsFieldset.tsx");const no=({matrixClient:e,space:t,closeSettingsFn:n})=>{const[s,r]=(0,i.useState)(""),a=(0,hi.e)((async()=>e.isVersionSupported("v1.4").then((t=>t||e.doesServerSupportUnstableFeature("org.matrix.msc3827.stable")))),[e],!1),c=e.getUserId(),d=(0,eo.U)(t,(e=>e.getJoinRule())),[m,u]=(0,Xs.W)((()=>{var e;return(null===(e=t.currentState.getStateEvents(o.EventType.RoomGuestAccess,""))||void 0===e||null===(e=e.getContent())||void 0===e?void 0:e.guest_access)===o.GuestAccess.CanJoin}),(n=>e.sendStateEvent(t.roomId,o.EventType.RoomGuestAccess,{guest_access:n?o.GuestAccess.CanJoin:o.GuestAccess.Forbidden},"")),(()=>r((0,l._t)("room_settings|visibility|error_update_guest_access")))),[h,p]=(0,Xs.W)((()=>{var e;return(null===(e=t.currentState.getStateEvents(o.EventType.RoomHistoryVisibility,""))||void 0===e||null===(e=e.getContent())||void 0===e?void 0:e.history_visibility)||o.HistoryVisibility.Shared}),(n=>e.sendStateEvent(t.roomId,o.EventType.RoomHistoryVisibility,{history_visibility:n},"")),(()=>r((0,l._t)("room_settings|visibility|error_update_history_visibility")))),[g,v]=(0,Ys.X)(),_=t.currentState.maySendStateEvent(o.EventType.RoomGuestAccess,c),f=t.currentState.maySendStateEvent(o.EventType.RoomHistoryVisibility,c),E=t.currentState.mayClientSendStateEvent(o.EventType.RoomCanonicalAlias,e),y=t.currentState.getStateEvents(o.EventType.RoomCanonicalAlias,"");let b,w;return d===o.JoinRule.Public&&(b=i.createElement("div",null,i.createElement(ie.A,{onClick:v,kind:"link",className:"mx_SettingsTab_showAdvanced","aria-expanded":g},g?(0,l._t)("action|hide_advanced"):(0,l._t)("action|show_advanced")),g&&i.createElement("div",{className:"mx_SettingsTab_toggleWithDescription"},i.createElement(Qs.A,{value:m,onChange:u,disabled:!_,label:(0,l._t)("room_settings|visibility|guest_access_label")}),i.createElement("p",null,(0,l._t)("room_settings|visibility|guest_access_explainer"),i.createElement("br",null),(0,l._t)("room_settings|visibility|guest_access_explainer_public_space"))))),t.getJoinRule()===o.JoinRule.Public&&(w=i.createElement(Fs.X,{heading:(0,l._t)("room_settings|visibility|alias_section")},i.createElement(qs.A,{roomId:t.roomId,canSetCanonicalAlias:E,canSetAliases:!0,canonicalAliasEvent:null!=y?y:void 0,hidePublishSetting:!a}))),i.createElement(Us.A,null,i.createElement(Fs.X,{heading:(0,l._t)("room_settings|visibility|title")},s&&i.createElement("div",{className:"mx_SpaceRoomView_errorText"},s),i.createElement(to.A,{legend:(0,l._t)("room_settings|access|title"),description:(0,l._t)("room_settings|access|description_space",{spaceName:t.name})},i.createElement(Zs.A,{room:t,onError:()=>r((0,l._t)("room_settings|visibility|error_failed_save")),closeSettingsFn:n}),b,i.createElement("div",{className:"mx_SettingsTab_toggleWithDescription"},i.createElement(Qs.A,{value:h===o.HistoryVisibility.WorldReadable,onChange:e=>{p(e?o.HistoryVisibility.WorldReadable:o.HistoryVisibility.Shared)},disabled:!f,label:(0,l._t)("room_settings|visibility|history_visibility_anyone_space")}),i.createElement("p",null,(0,l._t)("room_settings|visibility|history_visibility_anyone_space_description"),i.createElement("br",null),i.createElement("strong",null,(0,l._t)("room_settings|visibility|history_visibility_anyone_space_recommendation"))))),w))};var io=n("./src/components/views/settings/tabs/room/AdvancedRoomSettingsTab.tsx"),so=n("./src/components/views/settings/tabs/room/RolesRoomSettingsTab.tsx");let oo=function(e){return e.General="SPACE_GENERAL_TAB",e.Visibility="SPACE_VISIBILITY_TAB",e.Roles="SPACE_ROLES_TAB",e.Advanced="SPACE_ADVANCED_TAB",e}({});const ro=({matrixClient:e,space:t,onFinished:n})=>{(0,Ws.F)(S.A,(e=>{e.action===W.r.AfterLeaveRoom&&e.room_id===t.roomId&&n()}));const s=(0,i.useMemo)((()=>[new Ds.oz(oo.General,(0,l.AO)("common|general"),"mx_SpaceSettingsDialog_generalIcon",i.createElement($s,{matrixClient:e,space:t})),new Ds.oz(oo.Visibility,(0,l.AO)("room_settings|visibility|title"),"mx_SpaceSettingsDialog_visibilityIcon",i.createElement(no,{matrixClient:e,space:t,closeSettingsFn:n})),new Ds.oz(oo.Roles,(0,l.AO)("room_settings|permissions|title"),"mx_RoomSettingsDialog_rolesIcon",i.createElement(so.A,{room:t})),M.A.getValue(He.f.AdvancedSettings)?new Ds.oz(oo.Advanced,(0,l.AO)("common|advanced"),"mx_RoomSettingsDialog_warningIcon",i.createElement(io.A,{room:t,closeSettingsFn:n})):null].filter(Boolean)),[e,t,n]),[o,r]=i.useState(oo.General);return i.createElement(J.A,{title:(0,l._t)("space_settings|title",{spaceName:t.name||(0,l._t)("common|unnamed_space")}),className:"mx_SpaceSettingsDialog",contentId:"mx_SpaceSettingsDialog",onFinished:n,fixedWidth:!1},i.createElement("div",{className:"mx_SpaceSettingsDialog_content",id:"mx_SpaceSettingsDialog"},i.createElement(Ds.Ay,{tabs:s,activeTabId:o,onChange:r})))};var ao,lo=n("./src/components/views/dialogs/InviteDialog.tsx"),co=n("./src/components/views/dialogs/AddExistingToSpaceDialog.tsx"),mo=n("./src/utils/space.tsx");class uo{constructor(){(0,v.A)(this,"isRegistered",!1),(0,v.A)(this,"matrixClient",void 0),(0,v.A)(this,"onDispatch",(e=>{if(this.matrixClient)switch(e.action){case"open_room_settings":k.Ay.createDialog(mt.A,{roomId:e.room_id||X.M.instance.roomViewStore.getRoomId(),initialTabId:e.initial_tab_id},void 0,!1,!0);break;case W.r.OpenForwardDialog:k.Ay.createDialog(Ss,{matrixClient:this.matrixClient,event:e.event,permalinkCreator:e.permalinkCreator});break;case W.r.OpenReportEventDialog:k.Ay.createDialog(Ns,{mxEvent:e.event},"mx_Dialog_reportEvent");break;case W.r.OpenSpacePreferences:k.Ay.createDialog(js,{space:e.space},void 0,!1,!0);break;case W.r.OpenSpaceSettings:k.Ay.createDialog(ro,{matrixClient:e.space.client,space:e.space},void 0,!1,!0);break;case W.r.OpenInviteDialog:k.Ay.createDialog(lo.A,{kind:e.kind,call:e.call,roomId:e.roomId},dt()("mx_InviteDialog_flexWrapper",e.className),!1,!0).finished.then((t=>{var n;null===(n=e.onFinishedCallback)||void 0===n||n.call(e,t)}));break;case W.r.OpenAddToExistingSpaceDialog:{const t=e.space;k.Ay.createDialog(co.Ay,{onCreateRoomClick:e=>{(0,mo.PT)(t),Mn.A.trackInteraction("WebAddExistingToSpaceDialogCreateRoomButton",e)},onAddSubspaceClick:()=>(0,mo.K1)(t),space:t,onFinished:e=>{e&&X.M.instance.roomViewStore.getRoomId()===t.roomId&&S.A.fire(W.r.UpdateSpaceHierarchy)}},"mx_AddExistingToSpaceDialog_wrapper");break}}}))}prepare(e){this.matrixClient=e,this.isRegistered||(S.A.register(this.onDispatch),this.isRegistered=!0)}}ao=uo,(0,v.A)(uo,"instance",new ao);var ho=n("./src/utils/ErrorUtils.tsx"),po=n("./node_modules/matrix-js-sdk/src/oidc/authorize.ts"),go=n("./node_modules/matrix-js-sdk/src/randomstring.ts"),vo=n("./node_modules/matrix-js-sdk/src/oidc/error.ts");let _o=function(e){return e.InvalidQueryParameters="Invalid query parameters for OIDC native login. `code` and `state` are required.",e}({});const fo=async(e,t,n,i,s)=>{var o;const r=a.A.get().getOidcCallbackUrl().href,l=(0,go.DU)(10),c=s?"create":void 0,d=await(0,po.R2)({metadata:e.metadata,redirectUri:r,clientId:t,homeserverUrl:n,identityServerUrl:i,nonce:l,prompt:c,urlState:null===(o=a.A.get())||void 0===o?void 0:o.getOidcClientState()});window.location.href=d},Eo=async e=>{const{code:t,state:n}=(e=>{const t=e.code,n=e.state;if(!t||"string"!=typeof t||!n||"string"!=typeof n)throw new Error(_o.InvalidQueryParameters);return{code:t,state:n}})(e),{homeserverUrl:i,tokenResponse:s,idTokenClaims:o,identityServerUrl:r,oidcClientSettings:a}=await(0,po.SU)(t,n);return{homeserverUrl:i,identityServerUrl:r,accessToken:s.access_token,refreshToken:s.refresh_token,idToken:s.id_token,clientId:a.clientId,issuer:a.issuer,idTokenClaims:o}};var yo=n("./src/utils/oidc/persistOidcSettings.ts"),bo=n("./node_modules/matrix-js-sdk/src/utils/decryptAESSecretStorageItem.ts"),wo=n("./node_modules/matrix-js-sdk/src/utils/encryptAESSecretStorageItem.ts");const So="mx_access_token",Ao="mx_refresh_token",Co="access_token",xo="refresh_token",ko="mx_has_access_token",Ro="mx_has_refresh_token";async function Io(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);const n=await crypto.subtle.importKey("raw",t,"HKDF",!1,["deriveBits"]);return t.fill(0),new Uint8Array(await crypto.subtle.deriveBits({name:"HKDF",hash:"SHA-256",salt:new Uint8Array(32),info:new Uint8Array(0)},n,256))}async function To(e,t,n){if("string"==typeof t)return t;if(!e)throw new Error(`Error decrypting secret ${n}: no pickle key found.`);const i=await Io(e),s=await(0,bo.A)(t,i,n);return i.fill(0),s}async function Po(e,t,n,i,o){if(n?localStorage.setItem(o,"true"):localStorage.removeItem(o),i){let o;if(n)try{const e=await Io(i);o=await(0,wo.A)(n,e,t),e.fill(0)}catch(e){s.v.warn(`Could not encrypt token for ${t}`,e)}try{await D.x7("account",e,o||n)}catch{n?localStorage.setItem(e,n):localStorage.removeItem(e)}}else try{await D.x7("account",e,n)}catch{n?localStorage.setItem(e,n):localStorage.removeItem(e)}}async function No(e,t){return Po(So,Co,e,t,ko)}async function Do(e,t){return Po(Ao,xo,e,t,Ro)}class Mo extends o.OidcTokenRefresher{constructor(e,t,n,i,s,o){super(e,t,i,n,s),(0,v.A)(this,"deviceId",void 0),this.userId=o,this.deviceId=i}async persistTokens({accessToken:e,refreshToken:t}){var n,i;const s=null!==(n=await(null===(i=a.A.get())||void 0===i?void 0:i.getPickleKey(this.userId,this.deviceId)))&&void 0!==n?n:void 0;await No(e,s),await Do(t,s)}}var Oo=n("./src/SupportedBrowser.ts");const Lo=["roomId"];function Uo(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Fo(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Uo(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Uo(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const Vo="mx_hs_url",Bo="mx_is_url";S.A.register((e=>{if(e.action===W.r.TriggerLogout)lr();else if(e.action===W.r.OverwriteLogin){const t=e;dr(!1),er(t.credentials,!0,!0).catch((e=>{s.v.warn("Failed to overwrite login",e)}))}}));let jo=!1;function Wo(){if(jo)throw new zo("session lock has been released")}class zo extends Error{}async function Ho(e={}){try{let t=e.enableGuest||!1;const n=e.guestHsUrl,i=e.guestIsUrl,r=e.fragmentQueryParams||{},a=e.defaultDeviceDisplayName;if(t&&!n&&(s.v.warn("Cannot enable guest access: can't determine HS URL to use"),t=!1),t&&n&&r.guest_user_id&&r.guest_access_token)return s.v.log("Using guest access credentials"),er({userId:r.guest_user_id,accessToken:r.guest_access_token,homeserverUrl:n,identityServerUrl:i,guest:!0},!0,!1).then((()=>!0));return!!await Xo({ignoreGuest:Boolean(e.ignoreGuest)})||!jo&&(!(!t||!n)&&function(e,t,n){s.v.log(`Doing guest login on ${e}`);const i=(0,o.createClient)({baseUrl:e});return i.registerGuest({body:{initial_device_display_name:n}}).then((n=>(s.v.log(`Registered as guest: ${n.user_id}`),er({userId:n.user_id,deviceId:n.device_id,accessToken:n.access_token,homeserverUrl:e,identityServerUrl:t,guest:!0},!0,!0).then((()=>!0)))),(e=>(s.v.error("Failed to register as guest",e),!1)))}(n,i,a))}catch(e){return!(e instanceof tr)&&(!jo&&async function(e){s.v.error("Unable to load session",e);const t=k.Ay.createDialog(rt,{error:e}),[n]=await t.finished;if(n)return await cr(),!1;return Ho()}(e))}}async function Ko(){const{hsUrl:e,userId:t,hasAccessToken:n,isGuest:i}=await Yo();return e&&t&&n?[t,!!i]:[null,null]}async function Jo(e,t,n){return e.code&&e.state?(console.log("We have OIDC params - attempting OIDC login"),async function(e){try{const{accessToken:t,refreshToken:n,homeserverUrl:i,identityServerUrl:r,idToken:a,clientId:l,issuer:c}=await Eo(e),{user_id:d,device_id:m,is_guest:u}=await async function(e,t,n){try{const i=(0,o.createClient)({baseUrl:t,accessToken:e,idBaseUrl:n});return await i.whoami()}catch(e){throw s.v.error("Failed to retrieve userId using accessToken",e),new Error("Failed to retrieve userId using accessToken")}}(t,i,r),h={accessToken:t,refreshToken:n,homeserverUrl:i,identityServerUrl:r,deviceId:m,userId:d,isGuest:u};return s.v.debug("Logged in via OIDC native flow"),await Go(h),(0,yo.UF)(l,c,a),!0}catch(e){return s.v.error("Failed to login via OIDC",e),await $o((e=>{switch(e.message){case vo.u.MissingOrInvalidStoredState:return(0,l._t)("auth|oidc|missing_or_invalid_stored_state");case _o.InvalidQueryParameters:case vo.u.CodeExchangeFailed:case vo.u.InvalidBearerTokenResponse:case vo.u.InvalidIdToken:default:return(0,l._t)("auth|oidc|generic_auth_error")}})(e)),!1}}(e)):function(e,t,n){var i;if(!e.loginToken)return Promise.resolve(!1);console.log("We have token login params - attempting token login");const r=localStorage.getItem($e.FL),c=null!==(i=localStorage.getItem($e.U7))&&void 0!==i?i:void 0;if(!r)return s.v.warn("Cannot log in with token: can't determine HS URL to use"),$o((0,l._t)("auth|sso_failed_missing_storage")),Promise.resolve(!1);return P(r,c,"m.login.token",{token:e.loginToken,initial_device_display_name:t}).then((async function(e){return s.v.log("Logged in with token"),await Go(e),!0})).catch((e=>{const t=()=>{var e;const t=(0,o.createClient)({baseUrl:r,idBaseUrl:c}),i=localStorage.getItem($e.ot)||void 0;null===(e=a.A.get())||void 0===e||e.startSingleSignOn(t,"sso",n,i,o.SSOAction.LOGIN)};return $o((0,ho.Y0)(e,{hsUrl:r,hsName:r}),t),s.v.error("Failed to log in with login token:",e),!1}))}(e,t,n)}async function Go(e){await cr(),await nr(e),sessionStorage.setItem("mx_fresh_login",String(!0))}async function $o(e,t){k.Ay.createDialog(nt.A,{title:(0,l._t)("auth|oidc|error_title"),description:e,button:(0,l._t)("action|try_again"),onFinished:t?e=>e&&t():void 0})}async function qo(e){let t;try{t=await D.Gt("account",e)}catch(t){s.v.error(`StorageManager.idbLoad failed for account:${e}`,t)}var n;if(!t&&(t=null!==(n=localStorage.getItem(e))&&void 0!==n?n:void 0,t))try{await D.x7("account",e,t),localStorage.removeItem(e)}catch(t){s.v.error(`migration of token ${e} to IndexedDB failed`,t)}return t}async function Yo(){var e,t,n,i;const s=null!==(e=localStorage.getItem(Vo))&&void 0!==e?e:void 0,o=null!==(t=localStorage.getItem(Bo))&&void 0!==t?t:void 0,r=await qo(So),a=await qo(Ao),l="true"===localStorage.getItem(ko)||!!r,c="true"===localStorage.getItem(Ro)||!!a,d=null!==(n=localStorage.getItem("mx_user_id"))&&void 0!==n?n:void 0,m=null!==(i=localStorage.getItem("mx_device_id"))&&void 0!==i?i:void 0;let u;return u=null!==localStorage.getItem("mx_is_guest")?"true"===localStorage.getItem("mx_is_guest"):"true"===localStorage.getItem("matrix-is-guest"),{hsUrl:s,isUrl:o,hasAccessToken:l,accessToken:r,refreshToken:a,hasRefreshToken:c,userId:d,deviceId:m,isGuest:u}}async function Qo(){if(await async function(){const{finished:e}=k.Ay.createDialog(at),[t]=await e;return!!t}())throw await cr(),new tr("Aborting login in progress because of storage inconsistency")}async function Xo(e){const t=null==e?void 0:e.ignoreGuest;if(!localStorage)return!1;const{hsUrl:n,isUrl:i,hasAccessToken:o,accessToken:r,refreshToken:l,userId:c,deviceId:d,isGuest:m}=await Yo();if(o&&!r&&await Qo(),r&&c&&n){var u,h;if(t&&m)return s.v.log("Ignoring stored guest account: "+c),!1;const e=null!==(u=await(null===(h=a.A.get())||void 0===h?void 0:h.getPickleKey(c,null!=d?d:"")))&&void 0!==u?u:void 0;e?s.v.log(`Got pickle key for ${c}|${d}`):s.v.log(`No pickle key available for ${c}|${d}`);const o=await To(e,r,Co),p=l&&await To(e,l,xo),g="true"===sessionStorage.getItem("mx_fresh_login");return sessionStorage.removeItem("mx_fresh_login"),s.v.log(`Restoring session for ${c}`),await er({userId:c,deviceId:d,accessToken:o,refreshToken:p,homeserverUrl:n,identityServerUrl:i,guest:m,pickleKey:null!=e?e:void 0,freshLogin:g},!1,!1),!0}return s.v.log("No previous session found."),!1}async function Zo(e){var t;e.freshLogin=!0,dr();const n=e.userId&&e.deviceId?await(null===(t=a.A.get())||void 0===t?void 0:t.createPickleKey(e.userId,e.deviceId)):null;return n?s.v.log(`Created pickle key for ${e.userId}|${e.deviceId}`):s.v.log("Pickle key not created"),er(Fo(Fo({},e),{},{pickleKey:null!=n?n:void 0}),!0,!0)}async function er(e,t,n){Wo(),e.guest=Boolean(e.guest);const i=rr();s.v.log("setLoggedIn: mxid: "+e.userId+" deviceId: "+e.deviceId+" guest: "+e.guest+" hs: "+e.homeserverUrl+" softLogout: "+i," freshLogin: "+e.freshLogin),t&&await cr();const r=await N.zV();r.dataInLocalStorage&&r.cryptoInited&&!r.dataInCryptoStore&&await Qo();const l=await async function(e){if(!e.refreshToken)return;const t=(0,yo.HB)();if(t)try{const n=(0,yo.rW)(),i=(0,yo.ag)(),s=a.A.get().getOidcCallbackUrl().href,o=e.deviceId;if(!o)throw new Error("Expected deviceId in user credentials.");const r=new Mo(t,n,s,o,i,e.userId);return await r.oidcClientReady,r}catch(e){s.v.error("Failed to initialise OIDC token refresher",e)}}(e);Wo(),_.J.replaceUsingCreds(e,null==l?void 0:l.doRefreshAccessToken.bind(l));const c=_.J.safeGet();if((0,lt.Tm)(e.userId),B.Vo.instance.isEnabled()&&B.Vo.instance.startListeningToSettingsChanges(c),localStorage)try{await nr(e),sessionStorage.removeItem("mx_fresh_login")}catch(e){s.v.warn("Error using local storage: can't persist session!",e)}else s.v.warn("No local storage available: can't persist session!");Wo(),S.A.fire(W.r.OnLoggedIn);const d={};e.pickleKey&&(43===e.pickleKey.length?d.rustCryptoStoreKey=(0,o.decodeBase64)(e.pickleKey):d.rustCryptoStorePassword=e.pickleKey);try{await ar(c,!i,d)}finally{var m;null===(m=d.rustCryptoStoreKey)||void 0===m||m.fill(0)}return M.A.runMigrations(n),n&&!e.guest&&localStorage.setItem("must_verify_device","true"),c}class tr extends Error{}async function nr(e){var t;localStorage.setItem(Vo,e.homeserverUrl),e.identityServerUrl&&localStorage.setItem(Bo,e.identityServerUrl),localStorage.setItem("mx_user_id",e.userId),localStorage.setItem("mx_is_guest",JSON.stringify(e.guest)),await No(e.accessToken,e.pickleKey),await Do(e.refreshToken,e.pickleKey),e.pickleKey?localStorage.setItem("mx_has_pickle_key",String(!0)):"true"===localStorage.getItem("mx_has_pickle_key")&&s.v.error("Expected a pickle key, but none provided.  Encryption may not work."),e.deviceId&&localStorage.setItem("mx_device_id",e.deviceId),null===(t=f.r.instance.extensions.cryptoSetup)||void 0===t||t.persistCredentials(e),s.v.log(`Session persisted for ${e.userId}`)}let ir=!1;function sr(e){var t,n;const i=_.J.get();i&&(B.Vo.instance.logout(),i.isGuest()?setTimeout(lr,0):(ir=!0,null===(t=a.A.get())||void 0===t||t.destroyPickleKey(i.getSafeUserId(),null!==(n=i.getDeviceId())&&void 0!==n?n:""),async function(e,t){if(null!=t&&t.isUserAuthenticatedWithOidc){var n,i;const s=null!==(n=e.getAccessToken())&&void 0!==n?n:void 0,o=null!==(i=e.getRefreshToken())&&void 0!==i?i:void 0;await t.revokeTokens(s,o)}else await e.logout(!0)}(i,e).then(lr,(e=>{s.v.warn("Failed to call logout API: token will not be invalidated",e),lr()}))))}function or(){_.J.get()&&(localStorage.setItem("mx_soft_logout","true"),s.v.log("Soft logout initiated"),ir=!0,S.A.dispatch({action:"on_client_not_viable"}),dr(!1))}function rr(){return"true"===localStorage.getItem("mx_soft_logout")}async function ar(e,t,n){s.v.log("Lifecycle: Starting MatrixClient"),S.A.dispatch({action:"will_start_client"},!0),X.M.instance.typingStore.reset(),L.A.sharedInstance().reset(),uo.instance.prepare(e),b.default.start(),w.A.sharedInstance().start(),x.A.makeShared(e).start(),U.J.sharedInstance().startWatching(),R.A.instance.start(),et.Ay.instance.start(),(0,Oo.o7)(),F.u.sharedInstance().start(),t?(await E.A.init(),await _.J.start(n)):(s.v.warn("Caller requested only auxiliary services be started"),await _.J.assign(n)),Wo(),Je.sharedInstance().start(e),M.A.getValue("lowBandwidth")||C.start(),Ge.k.getInstance().start(),S.A.dispatch({action:"client_started"}),rr()&&or()}async function lr(){var e,t;S.A.fire(W.r.OnLoggedOut,!0),dr(),await cr({deleteEverything:!0}),null===(e=tt.onLoggedOutAndStorageCleared)||void 0===e||e.call(tt),await(null===(t=a.A.get())||void 0===t?void 0:t.clearStorage()),M.A.reset(),c.Ay.get().logout_redirect_url&&(s.v.log("Redirecting to external provider to finish logout"),window.setTimeout((()=>{window.location.href=c.Ay.get().logout_redirect_url}),100)),ir=!1}async function cr(e){var t;if(window.localStorage){const t=M.A.getValueAt(O.p.DEVICE,"language",null,!0,!0),n=Ze.instance.getWireInvites(),i=window.localStorage.getItem("mx_registration_time");window.localStorage.clear();try{await D.N6("account",So)}catch(e){s.v.error("idbDelete failed for account:mx_access_token",e)}null!=e&&e.deleteEverything||(t&&await M.A.setValue("language",null,O.p.DEVICE,t),n.forEach((e=>{let{roomId:t}=e,n=(0,g.A)(e,Lo);Ze.instance.storeInvite(t,n)})),i&&window.localStorage.setItem("mx_registration_time",i))}null===(t=window.sessionStorage)||void 0===t||t.clear();const n=(0,y.A)({baseUrl:""});await E.A.deleteEventIndex(),await n.clearStores()}function dr(e=!0){var t;b.default.stop(),et.Ay.instance.stop(),w.A.sharedInstance().stop(),X.M.instance.typingStore.reset(),C.stop(),R.A.instance.stop(),U.J.sharedInstance().stopWatching(),F.u.sharedInstance().stop(),Je.sharedInstance().stop(),null===(t=x.A.shared())||void 0===t||t.stop(),E.A.stop();const n=_.J.get();n&&(n.stopClient(),n.removeAllListeners(),e&&(_.J.unset(),E.A.unset(),n.store.destroy()))}window.mxLoginWithAccessToken=async(e,t)=>{const n=(0,o.createClient)({baseUrl:e,accessToken:t}),{user_id:i}=await n.whoami();await er({homeserverUrl:e,accessToken:t,userId:i},!0,!1)};var mr=n("./src/utils/SnakedObject.ts"),ur=n("./node_modules/matrix-js-sdk/src/utils.ts"),hr=n("./node_modules/@vector-im/compound-web/dist/components/Tooltip/TooltipProvider.js"),pr=(n("./node_modules/what-input/dist/what-input.js"),n("./src/RoomInvite.tsx")),gr=n("./src/Rooms.ts"),vr=n("./node_modules/matrix-js-sdk/src/version-support.ts"),_r=n("./src/stores/AsyncStore.ts");const fr={deferredAction:null};class Er extends _r.y{constructor(){super(S.A,fr)}onDispatch(e){switch(e.action){case W.r.DoAfterSyncPrepared:this.updateState({deferredAction:e.deferred_action});break;case"cancel_after_sync_prepared":this.updateState({deferredAction:null});break;case"MatrixActions.sync":{if(e.state===o.SyncState.Syncing&&e.prevState!==o.SyncState.Syncing&&async function(){try{const e=_.J.get();if(!e)return;for(const t of vr.Hr)if(await e.isVersionSupported(t))return;const t="LEGACY_SERVER";L.A.sharedInstance().addOrReplaceToast({key:t,title:(0,l._t)("unsupported_server_title"),props:{description:(0,l._t)("unsupported_server_description",{version:vr.eD,brand:c.Ay.get().brand}),primaryLabel:(0,l._t)("action|ok"),onPrimaryClick:()=>{L.A.sharedInstance().dismissToast(t)}},component:j.A,priority:98})}catch(e){s.v.warn("Failed to check server versions",e)}}(),"PREPARED"!==e.state)break;if(!this.state.deferredAction)break;const t=Object.assign({},this.state.deferredAction);this.updateState({deferredAction:null}),S.A.dispatch(t);break}case"on_client_not_viable":case W.r.OnLoggedOut:this.reset()}}}let yr=null;yr||(yr=new Er);var br,wr=n("./node_modules/uuid/dist/esm-browser/v4.js"),Sr=n("./src/rageshake/submit-rageshake.ts"),Ar=n("./src/stores/AsyncStoreWithClient.ts");function Cr(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function xr(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Cr(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Cr(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const kr="im.vector.auto_rs_request";class Rr extends Ar.r{constructor(){super(S.A,{reportedSessionIds:new Set,lastRageshakeTime:0,initialSyncCompleted:!1}),this.onDecryptionAttempt=this.onDecryptionAttempt.bind(this),this.onDeviceMessage=this.onDeviceMessage.bind(this),this.onSyncStateChange=this.onSyncStateChange.bind(this)}static get instance(){return Rr.internalInstance}async onAction(e){if(e.action===W.r.ReportKeyBackupNotEnabled)this.onReportKeyBackupNotEnabled()}async onReady(){M.A.getValue("automaticDecryptionErrorReporting")&&this.matrixClient&&(this.matrixClient.on(o.MatrixEventEvent.Decrypted,this.onDecryptionAttempt),this.matrixClient.on(o.ClientEvent.ToDeviceEvent,this.onDeviceMessage),this.matrixClient.on(o.ClientEvent.Sync,this.onSyncStateChange))}async onNotReady(){this.matrixClient&&(this.matrixClient.removeListener(o.ClientEvent.ToDeviceEvent,this.onDeviceMessage),this.matrixClient.removeListener(o.MatrixEventEvent.Decrypted,this.onDecryptionAttempt),this.matrixClient.removeListener(o.ClientEvent.Sync,this.onSyncStateChange))}async onDecryptionAttempt(e){if(!this.state.initialSyncCompleted)return;const t=e.getWireContent(),n=t.session_id;if(e.isDecryptionFailure()&&!this.state.reportedSessionIds.has(n)){var i;if(await(0,ur.yy)(5e3),!e.isDecryptionFailure())return;const r=new Set(this.state.reportedSessionIds);await this.updateState({reportedSessionIds:r.add(n)});const a=(new Date).getTime();if(a-this.state.lastRageshakeTime<6e4)return void s.v.info(`Not sending recipient-side autorageshake for event ${e.getId()}/session ${n}: last rageshake was too recent`);await this.updateState({lastRageshakeTime:a});const l=e.getSender(),d={event_id:e.getId(),room_id:e.getRoomId(),session_id:n,device_id:t.device_id,user_id:l,sender_key:t.sender_key};s.v.info(`Sending recipient-side autorageshake for event ${e.getId()}/session ${n}`);const m=await(0,Sr.Ay)(c.Ay.get().bug_report_endpoint_url,{userText:"Auto-reporting decryption error (recipient)",sendLogs:!0,labels:["Z-UISI","web","uisi-recipient"],customApp:c.Ay.get().uisi_autorageshake_app,customFields:{auto_uisi:JSON.stringify(d)}}),u=xr(xr({},d),{},{recipient_rageshake:m,[o.ToDeviceMessageId]:(0,wr.A)()});null===(i=this.matrixClient)||void 0===i||i.sendToDevice(kr,new Map([[l,new Map([[u.device_id,u]])]]))}}async onSyncStateChange(e,t,n){this.state.initialSyncCompleted||await this.updateState({initialSyncCompleted:!(null==n||!n.nextSyncToken)})}async onDeviceMessage(e){if(e.getType()!==kr)return;const t=e.getContent(),n=t.recipient_rageshake||"",i=(new Date).getTime();i-this.state.lastRageshakeTime>6e4?(await this.updateState({lastRageshakeTime:i}),s.v.info(`Sending sender-side autorageshake for event ${t.event_id}/session ${t.session_id}`),await(0,Sr.Ay)(c.Ay.get().bug_report_endpoint_url,{userText:`Auto-reporting decryption error (sender)\nRecipient rageshake: ${n}`,sendLogs:!0,labels:["Z-UISI","web","uisi-sender"],customApp:c.Ay.get().uisi_autorageshake_app,customFields:{recipient_rageshake:n,auto_uisi:JSON.stringify(t)}})):s.v.info(`Not sending sender-side autorageshake for event ${t.event_id}/session ${t.session_id}: last rageshake was too recent`)}async onReportKeyBackupNotEnabled(){M.A.getValue("automaticKeyBackNotEnabledReporting")&&await(0,Sr.Ay)(c.Ay.get().bug_report_endpoint_url,{userText:"Auto-reporting key backup not enabled",sendLogs:!0,labels:["web",W.r.ReportKeyBackupNotEnabled]})}}br=Rr,(0,v.A)(Rr,"internalInstance",(()=>{const e=new br;return e.start(),e})()),window.mxAutoRageshakeStore=Rr.instance;var Ir=n("./src/PageTypes.ts"),Tr=n("./src/settings/controllers/ThemeController.ts");const Pr=/^[a-z0-9=_\-./]+$/;class Nr extends q.EventEmitter{constructor(...e){super(...e),(0,v.A)(this,"_isResizing",!1),(0,v.A)(this,"throttledMiddlePanel",(0,Vn.throttle)((()=>this.emit("middlePanelResized")),200))}get isResizing(){return this._isResizing}startResizing(){this._isResizing=!0,this.emit("isResizing",!0)}stopResizing(){this._isResizing=!1,this.emit("isResizing",!1)}noisyMiddlePanel(){this.emit("middlePanelResizedNoisy")}updateMiddlePanel(){this.throttledMiddlePanel(),this.noisyMiddlePanel()}notifyLeftHandleResized(){this.updateMiddlePanel()}notifyRightHandleResized(){this.updateMiddlePanel()}notifyTimelineHeightChanged(){this.updateMiddlePanel()}notifyWindowResized(){this.updateMiddlePanel()}}var Dr=n("./src/settings/watchers/ThemeWatcher.ts"),Mr=n("./src/settings/watchers/FontWatcher.ts"),Or=n("./src/RoomAliasCache.ts"),Lr=n("./src/MediaDeviceHandler.ts"),Ur=n("./src/utils/FontManager.ts");const Fr=({vertical:e,reverse:t,id:n,passRef:s})=>{const o=["mx_ResizeHandle"];return e?o.push("mx_ResizeHandle--vertical"):o.push("mx_ResizeHandle--horizontal"),t&&o.push("mx_ResizeHandle_reverse"),i.createElement("div",{ref:s,className:o.join(" "),"data-id":n},i.createElement("div",null))};class Vr{constructor(e,t,n,i){(0,v.A)(this,"domNode",void 0),(0,v.A)(this,"id",void 0),(0,v.A)(this,"reverse",void 0),this.resizer=t,this.sizer=n,this.container=i,this.reverse=t.isReverseResizeHandle(e),this.domNode=i||(this.reverse?e.nextElementSibling:e.previousElementSibling),this.id=e.getAttribute("data-id")}copyWith(e,t,n,i){return new(0,this.constructor)(e,t,n,i)}advance(e){let t=this.reverse?this.domNode.previousElementSibling:this.domNode.nextElementSibling;const n=e!==this.reverse;do{var i,s;if(n)t=null===(i=t)||void 0===i?void 0:i.nextElementSibling;else t=null===(s=t)||void 0===s?void 0:s.previousElementSibling}while(t&&!this.resizer.isResizeHandle(t));if(t){const e=this.copyWith(t,this.resizer,this.sizer);return e.reverse=this.reverse,e}}next(){return this.advance(!0)}previous(){return this.advance(!1)}size(){return this.sizer.getItemSize(this.domNode)}offset(){return this.sizer.getItemOffset(this.domNode)}start(){this.sizer.start(this.domNode)}finish(){this.sizer.finish(this.domNode)}getSize(){return this.sizer.getDesiredItemSize(this.domNode)}setRawSize(e){this.sizer.setItemSize(this.domNode,e)}setSize(e){var t,n;this.setRawSize(`${Math.round(e)}px`),null===(t=this.resizer.config)||void 0===t||null===(n=t.onResized)||void 0===n||n.call(t,e,this.id,this.domNode)}clearSize(){var e,t;this.sizer.clearItemSize(this.domNode),null===(e=this.resizer.config)||void 0===e||null===(t=e.onResized)||void 0===t||t.call(e,null,this.id,this.domNode)}first(){var e;if(null===(e=this.domNode.parentElement)||void 0===e||!e.children)return;const t=Array.from(this.domNode.parentElement.children).find((e=>this.resizer.isResizeHandle(e)));return t?this.copyWith(t,this.resizer,this.sizer):void 0}last(){var e;if(null===(e=this.domNode.parentElement)||void 0===e||!e.children)return;const t=Array.from(this.domNode.parentElement.children).reverse().find((e=>this.resizer.isResizeHandle(e)));return t?this.copyWith(t,this.resizer,this.sizer):void 0}}class Br{constructor(e,t,n){this.container=e,this.vertical=t,this.reverse=n}getItemOffset(e){const t=(this.vertical?e.offsetTop:e.offsetLeft)-this.getOffset();return this.reverse?this.getTotalSize()-(t+this.getItemSize(e)):t}getItemSize(e){return this.vertical?e.offsetHeight:e.offsetWidth}getTotalSize(){return this.vertical?this.container.offsetHeight:this.container.offsetWidth}getOffset(){return this.vertical?this.container.offsetTop:this.container.offsetLeft}getPageOffset(){let e=this.container,t=0;for(;e;){t+=this.vertical?e.offsetTop:e.offsetLeft,e=e.offsetParent}return t}getDesiredItemSize(e){return this.vertical?e.style.height:e.style.width}setItemSize(e,t){this.vertical?e.style.height=t:e.style.width=t}clearItemSize(e){this.vertical?e.style.removeProperty("height"):e.style.removeProperty("width")}start(e){}finish(e){}offsetFromEvent(e){const t=this.vertical?e.pageY:e.pageX;return this.reverse?this.getPageOffset()+this.getTotalSize()-t:t-this.getPageOffset()}}class jr{static createSizer(e,t,n){return new Br(e,t,n)}constructor(e){(0,v.A)(this,"beforeOffset",void 0),this.item=e,this.beforeOffset=e.offset()}get size(){return this.item.getSize()}set size(e){this.item.setRawSize(e)}resize(e){this.item.setSize(e)}resizeFromContainerOffset(e){this.resize(e-this.beforeOffset)}start(){this.item.start()}finish(){this.item.finish()}}class Wr extends jr{static createItem(e,t,n){return new Vr(e,t,n)}}class zr extends Vr{notifyCollapsed(e){var t,n;null===(t=this.resizer.config)||void 0===t||null===(n=t.onCollapsed)||void 0===n||n.call(t,e,this.id,this.domNode)}get isCollapsed(){var e,t,n;return null!==(e=null===(t=this.resizer.config)||void 0===t||null===(n=t.isItemCollapsed)||void 0===n?void 0:n.call(t,this.domNode))&&void 0!==e&&e}}class Hr extends jr{static createItem(e,t,n,i){return new zr(e,t,n,i)}constructor(e){var t;super(e),(0,v.A)(this,"toggleSize",void 0),(0,v.A)(this,"isCollapsed",void 0),this.toggleSize=null===(t=e.resizer)||void 0===t||null===(t=t.config)||void 0===t?void 0:t.toggleSize,this.isCollapsed=e.isCollapsed}resize(e){const t=!!this.toggleSize&&e<this.toggleSize;t!==this.isCollapsed&&(this.isCollapsed=t,this.item.notifyCollapsed(t)),t||super.resize(e)}}class Kr{constructor(e,t,n){(0,v.A)(this,"classNames",void 0),(0,v.A)(this,"onMouseDown",(e=>{var t,n,i;if(0!==e.button)return;const s=e.target&&e.target.closest(`.${this.classNames.handle}`),o=null==this||null===(t=this.config)||void 0===t?void 0:t.handler;if(!s||!o&&s.parentElement!==this.container||o&&s!==o)return;var r;(e.preventDefault(),this.classNames.resizing)&&(null===(r=this.container)||void 0===r||null===(r=r.classList)||void 0===r||r.add(this.classNames.resizing));null===(n=this.config)||void 0===n||null===(i=n.onResizeStart)||void 0===i||i.call(n);const{sizer:a,distributor:l}=this.createSizerAndDistributor(s);l.start();const c=e=>{const t=a.offsetFromEvent(e);l.resizeFromContainerOffset(t)},d=document.body,m=()=>{var e,t,n;this.classNames.resizing&&(null===(n=this.container)||void 0===n||null===(n=n.classList)||void 0===n||n.remove(this.classNames.resizing));l.finish(),null===(e=this.config)||void 0===e||null===(t=e.onResizeStop)||void 0===t||t.call(e),d.removeEventListener("mouseup",m,!1),document.removeEventListener("mouseleave",m,!1),d.removeEventListener("mousemove",c,!1)};d.addEventListener("mouseup",m,!1),document.addEventListener("mouseleave",m,!1),d.addEventListener("mousemove",c,!1)})),(0,v.A)(this,"onResize",(0,Vn.throttle)((()=>{const e=this.getDistributors();e.forEach((e=>e.start())),e.forEach((e=>e.finish()))}),100,{trailing:!0,leading:!0})),(0,v.A)(this,"getDistributors",(()=>this.getResizeHandles().map((e=>{const{distributor:t}=this.createSizerAndDistributor(e);return t})))),this.container=e,this.distributorCtor=t,this.config=n,this.classNames={handle:"resizer-handle",reverse:"resizer-reverse",vertical:"resizer-vertical",resizing:"resizer-resizing"}}setClassNames(e){this.classNames=e}attach(){var e,t;const n=null!==(e=null==this||null===(t=this.config)||void 0===t||null===(t=t.handler)||void 0===t?void 0:t.parentElement)&&void 0!==e?e:this.container;null==n||n.addEventListener("mousedown",this.onMouseDown,!1),window.addEventListener("resize",this.onResize)}detach(){var e,t;const n=null!==(e=null==this||null===(t=this.config)||void 0===t||null===(t=t.handler)||void 0===t?void 0:t.parentElement)&&void 0!==e?e:this.container;null==n||n.removeEventListener("mousedown",this.onMouseDown,!1),window.removeEventListener("resize",this.onResize)}forHandleAt(e){const t=this.getResizeHandles()[e];if(t){const{distributor:e}=this.createSizerAndDistributor(t);return e}}forHandleWithId(e){const t=this.getResizeHandles().find((t=>t.getAttribute("data-id")===e));if(t){const{distributor:e}=this.createSizerAndDistributor(t);return e}}isReverseResizeHandle(e){return e.classList.contains(this.classNames.reverse)}isResizeHandle(e){return e.classList.contains(this.classNames.handle)}createSizerAndDistributor(e){var t;const n=e.classList.contains(this.classNames.vertical),i=this.isReverseResizeHandle(e),s=this.distributorCtor,o=null!==(t=this.config)&&void 0!==t&&t.handler?this.container:void 0,r=s.createSizer(this.container,n,i),a=s.createItem(e,this,r,null!=o?o:void 0);return{sizer:r,distributor:new s(a)}}getResizeHandles(){var e,t;return null!=this&&null!==(e=this.config)&&void 0!==e&&e.handler?[this.config.handler]:null!==(t=this.container)&&void 0!==t&&t.children?Array.from(this.container.querySelectorAll(`.${this.classNames.handle}`)):[]}}var Jr=n("./src/stores/room-list/models.ts");const Gr="serverlimit",$r=()=>{L.A.sharedInstance().dismissToast(Gr)};var qr=n("./src/components/views/rooms/RoomList.tsx"),Yr=n("./src/components/views/rooms/RoomSublist.tsx");class Qr extends i.PureComponent{constructor(...e){super(...e),(0,v.A)(this,"dispatcherRef",void 0),(0,v.A)(this,"onAction",(e=>{"focus_room_filter"===e.action&&this.openSpotlight()}))}componentDidMount(){this.dispatcherRef=S.A.register(this.onAction)}componentWillUnmount(){S.A.unregister(this.dispatcherRef)}openSpotlight(){S.A.fire(W.r.OpenSpotlight)}render(){const e=dt()({mx_RoomSearch:!0,mx_RoomSearch_minimized:this.props.isMinimized},"mx_RoomSearch_spotlightTrigger"),t=i.createElement("div",{className:"mx_RoomSearch_icon"}),n=i.createElement("kbd",{className:"mx_RoomSearch_shortcutPrompt"},Tn.vL?"⌘ K":(0,l._t)(Pn.hm[Tn.Uz.CONTROL])+" K");return i.createElement(ie.A,{onClick:this.openSpotlight,className:e,"aria-label":(0,l._t)("action|search")},t,!this.props.isMinimized&&i.createElement("div",{className:"mx_RoomSearch_spotlightTriggerText"},(0,l._t)("action|search")),n)}}var Xr=n("./src/stores/spaces/index.ts"),Zr=n("./src/stores/UIStore.ts"),ea=n("./src/customisations/helpers/UIComponents.ts"),ta=n("./src/components/views/beta/BetaCard.tsx"),na=n("./src/components/views/context_menus/IconizedContextMenu.tsx");const ia=["space","hideHeader","onFinished"],sa=e=>{let{space:t,hideHeader:n,onFinished:s}=e,r=(0,g.A)(e,ia);const a=(0,i.useContext)(Hn.Ay).getSafeUserId(),c=(0,pt.ny)("feature_video_rooms"),d=(0,pt.ny)("feature_element_call_video_rooms");if(!t)return null;let m=null;if("public"===t.getJoinRule()||t.canInvite(a)){const e=e=>{e.preventDefault(),e.stopPropagation(),(0,mo.Lo)(t),s()};m=i.createElement(na.R$,{className:"mx_SpacePanel_contextMenu_inviteButton",iconClassName:"mx_SpacePanel_iconInvite",label:(0,l._t)("action|invite"),onClick:e})}let u=null,h=null;if((0,mo.Kv)(t)){const e=e=>{e.preventDefault(),e.stopPropagation(),(0,mo.hL)(t),s()};u=i.createElement(na.R$,{iconClassName:"mx_SpacePanel_iconSettings",label:(0,l._t)("common|settings"),onClick:e})}else{const e=e=>{e.preventDefault(),e.stopPropagation(),(0,Ks.e)(t),s()};h=i.createElement(na.R$,{iconClassName:"mx_SpacePanel_iconLeave",className:"mx_IconizedContextMenu_option_red",label:(0,l._t)("space|leave_dialog_action"),onClick:e})}let p=null;if(M.A.getValue("developerMode")){const e=e=>{e.preventDefault(),e.stopPropagation(),S.A.dispatch({action:W.r.ViewRoom,room_id:t.roomId,forceTimeline:!0,metricsTrigger:void 0}),s()};p=i.createElement(na.R$,{iconClassName:"mx_SpacePanel_iconSettings",label:(0,l._t)("space|context_menu|devtools_open_timeline"),onClick:e})}const v=t.currentState.maySendStateEvent(o.EventType.SpaceChild,a),_=v&&(0,ea.g)(He.C.CreateRooms),f=_&&c,E=v&&(0,ea.g)(He.C.CreateSpaces);let y=null;if(_||E){const e=e=>{e.preventDefault(),e.stopPropagation(),Mn.A.trackInteraction("WebSpaceContextMenuNewRoomItem",e),(0,mo.PT)(t),s()},n=e=>{e.preventDefault(),e.stopPropagation(),(0,mo.PT)(t,d?o.RoomType.UnstableCall:o.RoomType.ElementVideo),s()},r=e=>{e.preventDefault(),e.stopPropagation(),(0,mo.Sl)(t),s()};y=i.createElement(i.Fragment,null,i.createElement("div",{className:"mx_SpacePanel_contextMenu_separatorLabel"},(0,l._t)("action|add")),_&&i.createElement(na.R$,{iconClassName:"mx_SpacePanel_iconPlus",label:(0,l._t)("common|room"),onClick:e}),f&&i.createElement(na.R$,{iconClassName:"mx_SpacePanel_iconPlus",label:(0,l._t)("common|video_room"),onClick:n},i.createElement(ta.s,null)),E&&i.createElement(na.R$,{iconClassName:"mx_SpacePanel_iconPlus",label:(0,l._t)("common|space"),onClick:r},i.createElement(ta.s,null)))}const b=e=>{e.preventDefault(),e.stopPropagation(),S.A.dispatch({action:W.r.ViewRoom,room_id:t.roomId,metricsTrigger:void 0}),s()};return i.createElement(na.Ay,(0,_t.A)({},r,{onFinished:s,className:"mx_SpacePanel_contextMenu",compact:!0}),!n&&i.createElement("div",{className:"mx_SpacePanel_contextMenu_header"},t.name),i.createElement(na.tx,{first:!0},i.createElement(na.R$,{iconClassName:"mx_SpacePanel_iconHome",label:(0,l._t)("space|context_menu|home"),onClick:e=>{Mn.A.trackInteraction("WebSpaceContextMenuHomeItem",e),b(e)}}),m,i.createElement(na.R$,{iconClassName:"mx_SpacePanel_iconExplore",label:_?(0,l._t)("space|context_menu|manage_and_explore"):(0,l._t)("space|context_menu|explore"),onClick:e=>{Mn.A.trackInteraction("WebSpaceContextMenuExploreRoomsItem",e),b(e)}}),i.createElement(na.R$,{iconClassName:"mx_SpacePanel_iconPreferences",label:(0,l._t)("common|preferences"),onClick:e=>{e.preventDefault(),e.stopPropagation(),(0,mo.Wi)(t),s()}}),p,u,h,y))};var oa=n("./src/components/views/elements/InlineSpinner.tsx"),ra=n("./node_modules/react-beautiful-dnd/dist/react-beautiful-dnd.cjs.js"),aa=n("./src/components/views/spaces/SpaceCreateMenu.tsx");const la=(e,t)=>{let n="";if(t)for(const e of t.entries())n+=e+"/";return`mx_space_collapsed_${n+e}`};class ca{static get instance(){return ca.internalInstance||(ca.internalInstance=new ca),ca.internalInstance}setSpaceCollapsedState(e,t,n){localStorage.setItem(la(e,t),n.toString())}getSpaceCollapsedState(e,t,n){const i=localStorage.getItem(la(e,t));return i?"true"===i:n}}(0,v.A)(ca,"internalInstance",void 0);var da=n("./src/stores/notifications/NotificationLevel.ts");const ma=["space","spaceKey","className","selected","label","contextMenuTooltip","notificationState","size","isNarrow","children","innerRef","ContextMenuComponent"],ua=["space","activeSpaces","isNested","isPanelCollapsed","onExpand","parents","innerRef","dragHandleProps"],ha=["tabIndex"],pa=e=>{var t;let{space:n,spaceKey:s,className:o,selected:r,label:a,contextMenuTooltip:c,notificationState:d,size:m,isNarrow:u,children:h,innerRef:p,ContextMenuComponent:v}=e,_=(0,g.A)(e,ma);const[f,E,y,b]=(0,Gt.EF)(p),[w,A,C]=(0,wn.A9)(E),x=A?0:-1,k=null!=s?s:null==n?void 0:n.roomId;let R,I,T=i.createElement("div",{className:"mx_SpaceButton_avatarPlaceholder"},i.createElement("div",{className:"mx_SpaceButton_icon"}));if(n&&(T=i.createElement(Kt.A,{size:m,room:n,type:"square"})),k&&d){let e=(0,l._t)("a11y_jump_first_unread_room");(null==n?void 0:n.getMyMembership())===ut.O.Invite&&(e=(0,l._t)("a11y|jump_first_invite"));const t=e=>{e.stopPropagation(),e.preventDefault(),us.Ay.instance.setActiveRoomInSpace(k)};R=i.createElement("div",{className:"mx_SpacePanel_badgeContainer"},i.createElement(Yt.A,{onClick:t,notification:d,"aria-label":e,tabIndex:x,showUnsentTooltip:!0}))}f&&E.current&&v&&(I=i.createElement(v,(0,_t.A)({},(0,Gt.Dq)(E.current.getBoundingClientRect(),0),{space:n,onFinished:b})));const P=null!==(t=_.onClick)&&void 0!==t?t:r&&n?()=>S.A.dispatch({action:W.r.ViewRoom,room_id:n.roomId}):()=>{k&&us.Ay.instance.setActiveSpace(k)};return i.createElement(ie.A,(0,_t.A)({},_,{className:dt()("mx_SpaceButton",o,{mx_SpaceButton_active:r,mx_SpaceButton_hasMenuOpen:f,mx_SpaceButton_narrow:u}),"aria-label":a,title:!u||f?void 0:a,onClick:P,onContextMenu:y,ref:C,tabIndex:x,onFocus:w}),h,i.createElement("div",{className:"mx_SpaceButton_selectionWrapper"},i.createElement("div",{className:"mx_SpaceButton_avatarWrapper"},T,R),!u&&i.createElement("span",{className:"mx_SpaceButton_name"},a),v&&i.createElement(jn.o,{className:"mx_SpaceButton_menuButton",onClick:y,title:c,isExpanded:f}),I))};class ga extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,"buttonRef",(0,i.createRef)()),(0,v.A)(this,"onSpaceUpdate",(()=>{this.setState({childSpaces:this.childSpaces})})),(0,v.A)(this,"onRoomNameChange",(()=>{this.setState({name:this.props.space.name})})),(0,v.A)(this,"toggleCollapse",(e=>{this.props.onExpand&&this.isCollapsed&&this.props.onExpand();const t=!this.isCollapsed;ca.instance.setSpaceCollapsedState(this.props.space.roomId,this.props.parents,t),this.setState({collapsed:t}),e.stopPropagation()})),(0,v.A)(this,"onKeyDown",(e=>{var t;let n=!0;const i=(0,_s.zM)().getRoomListAction(e),s=null===(t=this.state.childSpaces)||void 0===t?void 0:t.length;switch(i){case Pn.bY.CollapseRoomListSection:if(s&&!this.isCollapsed)this.toggleCollapse(e);else{var o;const e=null===(o=this.buttonRef)||void 0===o||null===(o=o.current)||void 0===o||null===(o=o.parentElement)||void 0===o?void 0:o.parentElement,t=null==e?void 0:e.previousElementSibling;null==t||t.focus()}break;case Pn.bY.ExpandRoomListSection:if(s)if(this.isCollapsed)this.toggleCollapse(e);else{var r,a;const e=null===(r=this.buttonRef)||void 0===r||null===(r=r.current)||void 0===r?void 0:r.nextElementSibling,t=null==e?void 0:e.querySelector(".mx_SpaceItem");null==t||null===(a=t.querySelector(".mx_SpaceButton"))||void 0===a||a.focus()}break;default:n=!1}n&&(e.stopPropagation(),e.preventDefault())}));const t=ca.instance.getSpaceCollapsedState(e.space.roomId,this.props.parents,!e.isNested);this.state={name:this.props.space.name,collapsed:t,childSpaces:this.childSpaces}}componentDidMount(){us.Ay.instance.on(this.props.space.roomId,this.onSpaceUpdate),this.props.space.on(o.RoomEvent.Name,this.onRoomNameChange)}componentWillUnmount(){us.Ay.instance.off(this.props.space.roomId,this.onSpaceUpdate),this.props.space.off(o.RoomEvent.Name,this.onRoomNameChange)}get childSpaces(){return us.Ay.instance.getChildSpaces(this.props.space.roomId).filter((e=>{var t;return!(null!==(t=this.props.parents)&&void 0!==t&&t.has(e.roomId))}))}get isCollapsed(){return this.state.collapsed||!!this.props.isPanelCollapsed}render(){var e,t;const n=this.props,{space:s,activeSpaces:o,isNested:r,isPanelCollapsed:a,onExpand:c,parents:d,innerRef:m,dragHandleProps:u}=n,h=(0,g.A)(n,ua),p=this.isCollapsed,v=dt()(this.props.className,{mx_SpaceItem:!0,mx_SpaceItem_narrow:a,collapsed:p,hasSubSpaces:null===(e=this.state.childSpaces)||void 0===e?void 0:e.length}),_=s.getMyMembership()===ut.O.Invite,f=_?qt.d.forSymbol("!",da.S.Highlight):us.Ay.instance.getNotificationState(s.roomId),E=null===(t=this.state.childSpaces)||void 0===t?void 0:t.length;let y;E&&!p&&(y=i.createElement(va,{spaces:this.state.childSpaces,activeSpaces:o,isNested:!0,parents:new Set(d).add(s.roomId)}));const b=E?i.createElement(ie.A,{className:"mx_SpaceButton_toggleCollapse",onClick:this.toggleCollapse,tabIndex:-1,"aria-label":p?(0,l._t)("action|expand"):(0,l._t)("action|collapse")}):null,w=u||{},{tabIndex:S}=w,A=(0,g.A)(w,ha),C=o.includes(s.roomId);return i.createElement("li",(0,_t.A)({},h,{className:v,ref:m,"aria-expanded":E?!p:void 0,"aria-selected":C,role:"treeitem"}),i.createElement(pa,(0,_t.A)({},A,{space:s,className:_?"mx_SpaceButton_invite":void 0,selected:C,label:this.state.name,contextMenuTooltip:(0,l._t)("space|context_menu|options"),notificationState:f,isNarrow:a,size:r?"24px":"32px",onKeyDown:this.onKeyDown,ContextMenuComponent:this.props.space.getMyMembership()===ut.O.Join?sa:void 0}),b),y)}}const va=({spaces:e,activeSpaces:t,isNested:n,parents:s})=>i.createElement("ul",{className:"mx_SpaceTreeLevel",role:"group"},e.map((e=>i.createElement(ga,{key:e.roomId,activeSpaces:t,space:e,isNested:n,parents:s}))));var _a,fa,Ea,ya=n("./src/stores/notifications/RoomNotificationStateStore.ts"),ba=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/favourite-solid.js"),wa=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/user-profile-solid.js"),Sa=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/home-solid.js"),Aa=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/video-call-solid.js");function Ca(){return Ca=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},Ca.apply(null,arguments)}var xa=function(e,t){return i.createElement("svg",Ca({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0,ref:t},e),_a||(_a=i.createElement("mask",{id:"hash-circle_svg__a",fill:"#fff"},i.createElement("path",{fillRule:"evenodd",d:"M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16M8.34 5.156A.75.75 0 0 0 6.848 5l-.16 1.531H5.656a.75.75 0 0 0 0 1.5h.875L6.328 9.97h-.937a.75.75 0 0 0 0 1.5h.78l-.151 1.453a.75.75 0 1 0 1.492.156l.168-1.61H9.5l-.152 1.454a.75.75 0 1 0 1.492.156l.168-1.61h1.289a.75.75 0 0 0 0-1.5h-1.132l.202-1.937h.93a.75.75 0 0 0 0-1.5h-.773l.144-1.375A.75.75 0 1 0 10.176 5l-.16 1.531h-1.82zM9.657 9.97h-1.82l.202-1.938h1.82z",clipRule:"evenodd"}))),fa||(fa=i.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16M8.34 5.156A.75.75 0 0 0 6.848 5l-.16 1.531H5.656a.75.75 0 0 0 0 1.5h.875L6.328 9.97h-.937a.75.75 0 0 0 0 1.5h.78l-.151 1.453a.75.75 0 1 0 1.492.156l.168-1.61H9.5l-.152 1.454a.75.75 0 1 0 1.492.156l.168-1.61h1.289a.75.75 0 0 0 0-1.5h-1.132l.202-1.937h.93a.75.75 0 0 0 0-1.5h-.773l.144-1.375A.75.75 0 1 0 10.176 5l-.16 1.531h-1.82zM9.657 9.97h-1.82l.202-1.938h1.82z",clipRule:"evenodd"})),Ea||(Ea=i.createElement("path",{fill:"currentColor",d:"m7.672 4.332-.139 1.326zm.668.824 1.326.139zM6.848 5l-1.326-.138zm-.16 1.531v1.334h1.201l.125-1.195zm-.157 1.5 1.326.139.154-1.472H6.53zM6.328 9.97v1.333H7.53l.125-1.195zm-.156 1.5 1.326.138.154-1.471h-1.48zm-.152 1.453-1.326-.139zm.668.824.138-1.326zm.824-.668 1.326.139zm.168-1.61v-1.332H6.479l-.125 1.194zm1.82 0 1.326.14.154-1.473H9.5zm-.152 1.454 1.326.139zm.668.824.138-1.326zm.824-.668 1.326.139zm.168-1.61v-1.332H9.807l-.125 1.194zm.157-1.5L9.839 9.83l-.154 1.472h1.48zm.202-1.937V6.698h-1.201l-.125 1.195zm.157-1.5-1.326-.138-.154 1.472h1.48zm.144-1.375-1.326-.138zM11 4.332l.139-1.326zM10.176 5 8.85 4.862zm-.16 1.531v1.334h1.201l.125-1.195zm-1.82 0L6.87 6.393l-.154 1.472h1.48zm-.36 3.438L6.51 9.83l-.153 1.472h1.48zm1.82 0v1.333h1.202l.125-1.195zM8.04 8.03V6.698H6.838l-.125 1.195zm1.82 0 1.326.139.154-1.472H9.86zM15.667 9A6.667 6.667 0 0 1 9 15.667v2.666A9.333 9.333 0 0 0 18.333 9zM9 2.333A6.667 6.667 0 0 1 15.667 9h2.666A9.333 9.333 0 0 0 9-.333zM2.333 9A6.667 6.667 0 0 1 9 2.333V-.333A9.333 9.333 0 0 0-.333 9zM9 15.667A6.667 6.667 0 0 1 2.333 9H-.333A9.333 9.333 0 0 0 9 18.333zM7.533 5.658a.583.583 0 0 1-.52-.64l2.653.277A2.083 2.083 0 0 0 7.81 3.006zm.64-.52a.583.583 0 0 1-.64.52l.277-2.652a2.083 2.083 0 0 0-2.288 1.856zm-.16 1.532.16-1.531-2.651-.277-.16 1.53zM5.657 7.865h1.032V5.198H5.656zm.584-.584a.583.583 0 0 1-.584.584V5.198c-1.15 0-2.083.933-2.083 2.083zm-.584-.583c.322 0 .584.261.584.583H3.573c0 1.15.933 2.084 2.083 2.084zm.875 0h-.875v2.667h.875zm1.124 3.41.202-1.938-2.652-.277-.203 1.937zM5.39 11.301h.937V8.635h-.937zm.583-.583a.583.583 0 0 1-.583.583V8.635c-1.151 0-2.084.933-2.084 2.084zm-.583-.583c.322 0 .583.26.583.583H3.307c0 1.15.933 2.083 2.084 2.083zm.78 0h-.78v2.666h.78zm1.175 2.925.152-1.454-2.652-.277-.152 1.454zm-.52-.641c.32.033.553.32.52.64l-2.652-.277a2.083 2.083 0 0 0 1.855 2.29zm-.64.52a.583.583 0 0 1 .64-.52l-.277 2.652a2.083 2.083 0 0 0 2.289-1.855zm.168-1.61-.169 1.61 2.653.277.168-1.61zM9.5 10.136H7.68v2.666H9.5zm1.174 2.925.152-1.454-2.652-.277-.152 1.454zm-.52-.641c.32.033.553.32.52.64l-2.652-.277a2.083 2.083 0 0 0 1.855 2.29zm-.64.52a.583.583 0 0 1 .64-.52l-.277 2.652a2.083 2.083 0 0 0 2.289-1.855zm.168-1.61-.168 1.61 2.652.277.168-1.61zm2.615-1.194h-1.29v2.666h1.29zm-.584.583c0-.322.262-.583.584-.583v2.666c1.15 0 2.083-.933 2.083-2.083zm.584.583a.583.583 0 0 1-.584-.583h2.667c0-1.15-.933-2.084-2.083-2.084zm-1.132 0h1.132V8.635h-1.132zm-1.124-3.41L9.84 9.83l2.652.277.202-1.937zm2.256-1.194h-.93v2.667h.93zm-.584.583c0-.322.262-.583.584-.583v2.667c1.15 0 2.083-.933 2.083-2.084zm.584.584a.583.583 0 0 1-.584-.584h2.667c0-1.15-.933-2.083-2.083-2.083zm-.773 0h.773V5.198h-.773zm-1.182-2.847-.144 1.375 2.652.277.144-1.375zm.52.64a.583.583 0 0 1-.52-.64l2.652.277a2.083 2.083 0 0 0-1.855-2.289zm.64-.52a.583.583 0 0 1-.64.52l.277-2.652a2.083 2.083 0 0 0-2.29 1.856zm-.16 1.532.16-1.531-2.652-.277-.16 1.53zM8.196 7.865h1.82V5.198h-1.82zM7.014 5.018 6.87 6.393l2.652.277.144-1.375zm.823 6.284h1.82V8.635h-1.82zm-1.124-3.41L6.51 9.83l2.653.277.202-1.937zm3.146-1.194H8.04v2.667h1.82zm1.124 3.41.202-1.938-2.652-.277L8.33 9.83z",mask:"url(#hash-circle_svg__a)"})))},ka=(0,i.forwardRef)(xa);function Ra(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Ia(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ra(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ra(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const Ta=(e,t)=>async n=>{const i=M.A.getValue("Spaces.enabledMetaSpaces");await M.A.setValue("Spaces.enabledMetaSpaces",null,O.p.ACCOUNT,Ia(Ia({},i),{},{[e]:n.target.checked})),Mn.A.trackInteraction(t,n,[Xr._b.Home,null,Xr._b.Favourites,Xr._b.People,Xr._b.Orphans,Xr._b.VideoRooms].indexOf(e))},Pa=()=>{const{[Xr._b.Home]:e,[Xr._b.Favourites]:t,[Xr._b.People]:n,[Xr._b.Orphans]:s,[Xr._b.VideoRooms]:o}=(0,pt.ti)("Spaces.enabledMetaSpaces"),r=(0,pt.ti)("Spaces.allRoomsInHome"),a=(0,i.useMemo)((()=>c.Ay.get("element_call").guest_spa_url),[]),d=(0,l._t)("settings|sidebar|metaspaces_video_rooms_description")+(a?" "+(0,l._t)("settings|sidebar|metaspaces_video_rooms_description_invite_extension"):"");return i.createElement(Us.A,null,i.createElement(Fs.X,null,i.createElement(Vs.P,{heading:(0,l._t)("settings|sidebar|metaspaces_subsection"),description:(0,l._t)("settings|sidebar|spaces_explainer")},i.createElement(Ms.A,{checked:!!e,onChange:Ta(Xr._b.Home,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_checkbox",disabled:e},i.createElement(Vs.s,null,i.createElement(Sa.A,null),(0,l._t)("common|home")),i.createElement(Vs.s,null,(0,l._t)("settings|sidebar|metaspaces_home_description"))),i.createElement(Ms.A,{checked:r,disabled:!e,onChange:async e=>{await M.A.setValue("Spaces.allRoomsInHome",null,O.p.ACCOUNT,e.target.checked),Mn.A.trackInteraction("WebSettingsSidebarTabSpacesCheckbox",e,1)},className:"mx_SidebarUserSettingsTab_checkbox mx_SidebarUserSettingsTab_homeAllRoomsCheckbox"},i.createElement(Vs.s,null,(0,l._t)("settings|sidebar|metaspaces_home_all_rooms")),i.createElement(Vs.s,null,(0,l._t)("settings|sidebar|metaspaces_home_all_rooms_description"))),i.createElement(Ms.A,{checked:!!t,onChange:Ta(Xr._b.Favourites,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_checkbox"},i.createElement(Vs.s,null,i.createElement(ba.A,null),(0,l._t)("common|favourites")),i.createElement(Vs.s,null,(0,l._t)("settings|sidebar|metaspaces_favourites_description"))),i.createElement(Ms.A,{checked:!!n,onChange:Ta(Xr._b.People,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_checkbox"},i.createElement(Vs.s,null,i.createElement(wa.A,null),(0,l._t)("common|people")),i.createElement(Vs.s,null,(0,l._t)("settings|sidebar|metaspaces_people_description"))),i.createElement(Ms.A,{checked:!!s,onChange:Ta(Xr._b.Orphans,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_checkbox"},i.createElement(Vs.s,null,i.createElement(ka,null),(0,l._t)("settings|sidebar|metaspaces_orphans")),i.createElement(Vs.s,null,(0,l._t)("settings|sidebar|metaspaces_orphans_description"))),M.A.getValue("feature_video_rooms")&&i.createElement(Ms.A,{checked:!!o,onChange:Ta(Xr._b.VideoRooms,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_checkbox"},i.createElement(Vs.s,null,i.createElement(Aa.A,null),(0,l._t)("settings|sidebar|metaspaces_video_rooms")),i.createElement(Vs.s,null,d)))))};var Na=n("./src/components/views/dialogs/UserTab.ts"),Da=n("./src/theme.ts"),Ma=n("./src/components/views/elements/Dropdown.tsx");function Oa(){const e=(0,pt.ti)("theme"),t=(0,pt.wL)(O.p.DEVICE,"use_system_theme",null,!1,!0),n=(0,pt.wL)(O.p.DEVICE,"theme",null,!1,!0),i=(0,pt.ti)("use_system_theme");return t?{theme:e,systemThemeActivated:!0}:n?{theme:e,systemThemeActivated:!1}:{theme:e,systemThemeActivated:i}}const La="MATCH_SYSTEM_THEME_ID",Ua=({requestClose:e})=>{const t=(0,i.useMemo)(Da.E0,[]),n=Oa(),s=(0,Da.kZ)(n.theme),o=s||n.theme,{systemThemeActivated:r}=n,a=[{id:La,name:(0,l._t)("theme|match_system")},...t],c=r?La:o;return i.createElement("div",{className:"mx_QuickThemeSwitcher"},i.createElement("h4",{className:"mx_QuickThemeSwitcher_heading"},(0,l._t)("common|theme")),i.createElement(Ma.A,{id:"mx_QuickSettingsButton_themePickerDropdown",onOptionChange:async t=>{Mn.A.trackInteraction("WebQuickSettingsThemeDropdown");try{t===La?await M.A.setValue("use_system_theme",null,O.p.DEVICE,!0):(S.A.dispatch({action:W.r.RecheckTheme,forceTheme:t}),await Promise.all([M.A.setValue("theme",null,O.p.DEVICE,t),M.A.setValue("use_system_theme",null,O.p.DEVICE,!1)]))}catch{S.A.dispatch({action:W.r.RecheckTheme})}e()},value:c,label:(0,l._t)("common|theme")},a.map((e=>i.createElement("div",{key:e.id},e.name)))))};var Fa,Va;function Ba(){return Ba=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},Ba.apply(null,arguments)}var ja=function(e,t){return i.createElement("svg",Ba({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0,ref:t},e),Fa||(Fa=i.createElement("path",{fill:"#000",d:"M11 18.598V15h2v3.598C13 20.5 12.238 22 12 22s-1-1.5-1-3.402M9.5 6c-.325-.167-1.714-.8-2.883-2s-.495-2 .513-2H12v4zM14.5 6c.325-.167 1.714-.8 2.883-2s.495-2-.513-2H12v4zM9.429 6h5.142L15 10H9z"})),Va||(Va=i.createElement("path",{fill:"#000",d:"M12 9c-3.069 0-5.676 1.693-6.621 4.048C4.967 14.073 5.895 15 7 15h10c1.105 0 2.032-.927 1.621-1.952C17.677 10.693 15.07 9 12 9"})))},Wa=(0,i.forwardRef)(ja);var za=n("./src/components/views/dialogs/DevtoolsDialog.tsx");const Ha=({isPanelCollapsed:e=!1})=>{const[t,n,s,o]=(0,Gt.EF)(),{[Xr._b.Favourites]:r,[Xr._b.People]:a}=(0,pt.ti)("Spaces.enabledMetaSpaces"),c=X.M.instance.roomViewStore.getRoomId(),d=(0,pt.ti)("developerMode");let m;return t&&n.current&&(m=i.createElement(Gt.Ay,(0,_t.A)({},(0,Gt.Gi)(n.current.getBoundingClientRect(),Gt.t4.None,16),{wrapperClassName:"mx_QuickSettingsButton_ContextMenuWrapper",onFinished:o,managed:!1,focusLock:!0}),i.createElement("h2",null,(0,l._t)("quick_settings|title")),i.createElement(ie.A,{onClick:()=>{o(),S.A.dispatch({action:W.r.ViewUserSettings})},kind:"primary_outline"},(0,l._t)("quick_settings|all_settings")),c&&d&&i.createElement(ie.A,{onClick:()=>{o(),k.Ay.createDialog(za.A,{roomId:c},"mx_DevtoolsDialog_wrapper")},kind:"danger_outline"},(0,l._t)("devtools|title")),i.createElement("h4",{className:"mx_QuickSettingsButton_pinToSidebarHeading"},i.createElement(Wa,{className:"mx_QuickSettingsButton_icon"}),(0,l._t)("quick_settings|metaspace_section")),i.createElement(Ms.A,{className:"mx_QuickSettingsButton_favouritesCheckbox",checked:!!r,onChange:Ta(Xr._b.Favourites,"WebQuickSettingsPinToSidebarCheckbox")},i.createElement(ba.A,{className:"mx_QuickSettingsButton_icon"}),(0,l._t)("common|favourites")),i.createElement(Ms.A,{className:"mx_QuickSettingsButton_peopleCheckbox",checked:!!a,onChange:Ta(Xr._b.People,"WebQuickSettingsPinToSidebarCheckbox")},i.createElement(wa.A,{className:"mx_QuickSettingsButton_icon"}),(0,l._t)("common|people")),i.createElement(ie.A,{className:"mx_QuickSettingsButton_moreOptionsButton",onClick:()=>{o(),S.A.dispatch({action:W.r.ViewUserSettings,initialTabId:Na.v.Sidebar})}},i.createElement(Xt.A,{className:"mx_QuickSettingsButton_icon"}),(0,l._t)("quick_settings|sidebar_settings")),i.createElement(Ua,{requestClose:o}))),i.createElement(i.Fragment,null,i.createElement(ie.A,{className:dt()("mx_QuickSettingsButton",{expanded:!e}),onClick:s,"aria-label":(0,l._t)("quick_settings|title"),title:e?(0,l._t)("quick_settings|title"):void 0,ref:n,"aria-expanded":!e},e?null:(0,l._t)("common|settings")),m)};var Ka=n("./src/components/views/dialogs/InfoDialog.tsx"),Ja=n("./src/components/views/elements/ExternalLink.tsx");const Ga=e=>{const t=(0,i.useRef)(null),[n,s]=(0,i.useState)(""),[o,r]=(0,Ys.X)(!1);(0,i.useEffect)((()=>{var e;null===(e=t.current)||void 0===e||e.focus()}),[]);const a=()=>{e.onFinished(),k.Ay.createDialog(st.A,{})},d=!!c.Ay.get().bug_report_endpoint_url;let m,u;d&&(m=i.createElement("div",{className:"mx_FeedbackDialog_section mx_FeedbackDialog_rateApp"},i.createElement("h3",null,(0,l._t)("feedback|comment_label")),i.createElement("p",null,(0,l._t)("feedback|platform_username")),i.createElement(ks.A,{id:"feedbackComment",label:(0,l._t)("common|feedback"),type:"text",autoComplete:"off",value:n,element:"textarea",onChange:e=>{s(e.target.value)},ref:t}),i.createElement(Ms.A,{checked:o,onChange:r},(0,l._t)("feedback|may_contact_label")))),d&&(u=i.createElement("p",{className:"mx_FeedbackDialog_section_microcopy"},(0,l._t)("feedback|pro_type",{},{debugLogsLink:e=>i.createElement(ie.A,{kind:"link_inline",onClick:a},e)})));const h=c.Ay.getObject("feedback").get("existing_issues_url"),p=c.Ay.getObject("feedback").get("new_issue_url");return i.createElement(it.A,{className:"mx_FeedbackDialog",hasCancelButton:d,title:(0,l._t)("common|feedback"),description:i.createElement(i.Fragment,null,i.createElement("div",{className:"mx_FeedbackDialog_section mx_FeedbackDialog_reportBug"},i.createElement("h3",null,(0,l._t)("common|report_a_bug")),i.createElement("p",null,(0,l._t)("feedback|existing_issue_link",{},{existingIssuesLink:e=>i.createElement(Ja.A,{target:"_blank",rel:"noreferrer noopener",href:h},e),newIssueLink:e=>i.createElement(Ja.A,{target:"_blank",rel:"noreferrer noopener",href:p},e)})),u),m),button:d?(0,l._t)("feedback|send_feedback_action"):(0,l._t)("action|go_back"),buttonDisabled:d&&!n,onFinished:t=>{if(d&&t){const t=e.feature?`${e.feature}-feedback`:"feedback";(0,Sr.Wz)(t,n,o),k.Ay.createDialog(Ka.A,{title:(0,l._t)("feedback|sent"),description:(0,l._t)("bug_reporting|thank_you")})}e.onFinished()}})};var $a=n("./src/components/views/dialogs/security/RestoreKeyBackupDialog.tsx"),qa=function(e){return e[e.LOADING=0]="LOADING",e[e.NO_CRYPTO=1]="NO_CRYPTO",e[e.BACKUP_ACTIVE=2]="BACKUP_ACTIVE",e[e.SERVER_BACKUP_BUT_DISABLED=3]="SERVER_BACKUP_BUT_DISABLED",e[e.NO_BACKUP=4]="NO_BACKUP",e[e.ERROR=5]="ERROR",e}(qa||{});async function Ya(e){const t=null==e?void 0:e.getCrypto();if(!t)return!1;const n=e.getRooms();for(const e of n){if(await t.isEncryptionEnabledInRoom(e.roomId))return!0}return!1}class Qa extends i.Component{constructor(e){super(e),(0,v.A)(this,"onExportE2eKeysClicked",(()=>{k.Ay.createDialog((0,i.lazy)((()=>n.e(2959).then(n.bind(n,"./src/async-components/views/dialogs/security/ExportE2eKeysDialog.tsx")))),{matrixClient:_.J.safeGet()})})),(0,v.A)(this,"onFinished",(e=>{e&&S.A.dispatch({action:"logout"}),this.props.onFinished(!!e)})),(0,v.A)(this,"onSetRecoveryMethodClick",(()=>{this.state.backupStatus===qa.SERVER_BACKUP_BUT_DISABLED?k.Ay.createDialog($a.A,void 0,void 0,!1,!0):k.Ay.createDialog((0,i.lazy)((()=>n.e(5776).then(n.bind(n,"./src/async-components/views/dialogs/security/CreateKeyBackupDialog.tsx")))),void 0,void 0,!1,!0),this.props.onFinished(!0)})),(0,v.A)(this,"onLogoutConfirm",(()=>{S.A.dispatch({action:"logout"}),this.props.onFinished(!0)})),this.state={backupStatus:qa.LOADING}}componentDidMount(){this.startLoadBackupStatus()}startLoadBackupStatus(){this.loadBackupStatus().catch((e=>{s.v.log("Unable to fetch key backup status",e),this.setState({backupStatus:qa.ERROR})}))}async loadBackupStatus(){const e=_.J.safeGet().getCrypto();if(!e)return void this.setState({backupStatus:qa.NO_CRYPTO});if(null!==await e.getActiveSessionBackupVersion())return void this.setState({backupStatus:qa.BACKUP_ACTIVE});const t=await e.getKeyBackupInfo();this.setState({backupStatus:t?qa.SERVER_BACKUP_BUT_DISABLED:qa.NO_BACKUP})}renderSetupBackupDialog(){const e=i.createElement("div",null,i.createElement("p",null,(0,l._t)("auth|logout_dialog|setup_secure_backup_description_1")),i.createElement("p",null,(0,l._t)("auth|logout_dialog|setup_secure_backup_description_2")),i.createElement("p",null,(0,l._t)("encryption|setup_secure_backup|explainer")));let t;t=this.state.backupStatus===qa.SERVER_BACKUP_BUT_DISABLED?(0,l._t)("settings|security|key_backup_connect"):(0,l._t)("auth|logout_dialog|use_key_backup");const n=i.createElement("div",null,i.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},e),i.createElement(ot.A,{primaryButton:t,hasCancel:!1,onPrimaryButtonClick:this.onSetRecoveryMethodClick,focus:!0},i.createElement("button",{onClick:this.onLogoutConfirm},(0,l._t)("auth|logout_dialog|skip_key_backup"))),i.createElement("details",null,i.createElement("summary",{className:"mx_LogoutDialog_ExportKeyAdvanced"},(0,l._t)("common|advanced")),i.createElement("p",null,i.createElement("button",{onClick:this.onExportE2eKeysClicked},(0,l._t)("auth|logout_dialog|megolm_export")))));return i.createElement(J.A,{title:(0,l._t)("auth|logout_dialog|setup_key_backup_title"),contentId:"mx_Dialog_content",hasCancel:!0,onFinished:this.onFinished},n)}render(){switch(this.state.backupStatus){case qa.LOADING:return i.createElement(J.A,{title:(0,l._t)("action|sign_out"),contentId:"mx_Dialog_content",hasCancel:!0,onFinished:this.onFinished},i.createElement(se.A,null));case qa.NO_CRYPTO:case qa.BACKUP_ACTIVE:return i.createElement(it.A,{hasCancelButton:!0,title:(0,l._t)("action|sign_out"),description:(0,l._t)("auth|logout_dialog|description"),button:(0,l._t)("action|sign_out"),onFinished:this.onFinished});case qa.NO_BACKUP:case qa.SERVER_BACKUP_BUT_DISABLED:case qa.ERROR:return this.renderSetupBackupDialog()}}}function Xa(e,t){const n=new mr.Q(e).get("embedded_pages");let i=n?new mr.Q(n).get("home_url"):null;var o;(i||(i=e.welcomePageUrl,i&&s.v.warn("You are using a deprecated config option: `welcomePageUrl`. Please use `embedded_pages.home_url` instead, per https://github.com/vector-im/element-web/issues/21428")),i)||(i=null===(o=(0,Ue.qh)(t))||void 0===o?void 0:o.home_url);return i}(0,v.A)(Qa,"defaultProps",{onFinished:function(){}});var Za,el,tl,nl,il=n("./src/stores/OwnProfileStore.ts");function sl(){return sl=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},sl.apply(null,arguments)}var ol=function(e,t){return i.createElement("svg",sl({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 8 8",role:"presentation","aria-hidden":!0,ref:t},e),Za||(Za=i.createElement("path",{fill:"currentColor",d:"M6.73 1.395a.333.333 0 0 0-.527.41l.005.006.021.029q.03.04.081.121c.069.108.162.267.255.466.186.4.368.95.368 1.573 0 .622-.182 1.173-.368 1.573a4 4 0 0 1-.357.616l-.004.006h-.001a.333.333 0 0 0 .527.41L6.48 6.41l.249.194v-.001l.001-.002.003-.003.009-.012a2 2 0 0 0 .13-.19c.081-.128.189-.312.296-.542A4.4 4.4 0 0 0 7.599 4a4.4 4.4 0 0 0-.43-1.855 5 5 0 0 0-.426-.732L6.734 1.4l-.003-.004zl-.263.204z"})),el||(el=i.createElement("path",{fill:"currentColor",d:"M5.863 2.595a.333.333 0 0 0-.527.409l.001.001a1 1 0 0 1 .044.065c.032.049.074.122.117.214.087.186.169.437.169.716 0 .28-.082.53-.169.716a2 2 0 0 1-.16.279l-.002.002a.333.333 0 0 0 .527.408L5.6 5.2l.263.205v-.001l.002-.001.002-.003.005-.007a1 1 0 0 0 .072-.105c.044-.07.101-.168.158-.29.114-.243.232-.592.232-.998s-.118-.755-.232-.998a2.6 2.6 0 0 0-.23-.395L5.867 2.6l-.002-.003h-.001zL5.6 2.8zM1.204 6.605a.333.333 0 0 0 .526-.41l-.005-.006-.02-.029-.082-.121a4 4 0 0 1-.254-.466A3.8 3.8 0 0 1 1 4c0-.622.182-1.173.369-1.573a4 4 0 0 1 .356-.616l.005-.006a.333.333 0 0 0-.526-.41l.248.194-.248-.194-.001.001-.001.002L1.2 1.4l-.009.012a2 2 0 0 0-.13.19 5 5 0 0 0-.295.542A4.4 4.4 0 0 0 .333 4c0 .75.218 1.398.432 1.855a5 5 0 0 0 .425.732l.01.012.002.004h.001zl.264-.204z"})),tl||(tl=i.createElement("path",{fill:"currentColor",d:"M2.07 5.405a.333.333 0 0 0 .527-.409l-.001-.001a1 1 0 0 1-.044-.065 2 2 0 0 1-.117-.214A1.7 1.7 0 0 1 2.266 4c0-.28.082-.53.17-.716a2 2 0 0 1 .16-.279l.001-.002a.333.333 0 0 0-.527-.408l.263.205-.263-.205v.001l-.001.001-.002.003-.006.007a1 1 0 0 0-.072.105 3 3 0 0 0-.158.29A2.4 2.4 0 0 0 1.6 4c0 .406.118.755.231.998a2.6 2.6 0 0 0 .23.395l.006.007.002.003zl.264-.204z"})),nl||(nl=i.createElement("circle",{cx:4,cy:4,r:.667,fill:"currentColor"})))},rl=(0,i.forwardRef)(ol);var al=n("./src/utils/Feedback.ts");class ll extends i.Component{constructor(e,t){super(e,t),(0,v.A)(this,"dispatcherRef",void 0),(0,v.A)(this,"themeWatcherRef",void 0),(0,v.A)(this,"dndWatcherRef",void 0),(0,v.A)(this,"buttonRef",(0,i.createRef)()),(0,v.A)(this,"onCurrentVoiceBroadcastRecordingChanged",(e=>{this.setState({showLiveAvatarAddon:null!==e})})),(0,v.A)(this,"onProfileUpdate",(async()=>{this.forceUpdate()})),(0,v.A)(this,"onSelectedSpaceUpdate",(async()=>{this.setState({selectedSpace:us.Ay.instance.activeSpaceRoom})})),(0,v.A)(this,"onThemeChanged",(()=>{this.setState({isDarkTheme:this.isUserOnDarkTheme(),isHighContrast:this.isUserOnHighContrastTheme()})})),(0,v.A)(this,"onAction",(e=>{if(e.action===W.r.ToggleUserMenu)this.state.contextMenuPosition?this.setState({contextMenuPosition:null}):this.buttonRef.current&&this.buttonRef.current.click()})),(0,v.A)(this,"onOpenMenuClick",(e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:e.currentTarget.getBoundingClientRect()})})),(0,v.A)(this,"onContextMenu",(e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:{left:e.clientX,top:e.clientY,width:20,height:0}})})),(0,v.A)(this,"onCloseMenu",(()=>{this.setState({contextMenuPosition:null})})),(0,v.A)(this,"onSwitchThemeClick",(e=>{e.preventDefault(),e.stopPropagation(),Mn.A.trackInteraction("WebUserMenuThemeToggleButton",e),M.A.setValue("use_system_theme",null,O.p.DEVICE,!1);let t=this.state.isDarkTheme?"light":"dark";if(this.state.isHighContrast){const e=(0,Da.TJ)(t);e&&(t=e)}M.A.setValue("theme",null,O.p.DEVICE,t)})),(0,v.A)(this,"onSettingsOpen",((e,t,n)=>{e.preventDefault(),e.stopPropagation();const i={action:W.r.ViewUserSettings,initialTabId:t,props:n};S.A.dispatch(i),this.setState({contextMenuPosition:null})})),(0,v.A)(this,"onProvideFeedback",(e=>{e.preventDefault(),e.stopPropagation(),k.Ay.createDialog(Ga),this.setState({contextMenuPosition:null})})),(0,v.A)(this,"onSignOutClick",(async e=>{e.preventDefault(),e.stopPropagation(),await Ya(_.J.safeGet())?k.Ay.createDialog(Qa):S.A.dispatch({action:"logout"}),this.setState({contextMenuPosition:null})})),(0,v.A)(this,"onSignInClick",(()=>{S.A.dispatch({action:"start_login"}),this.setState({contextMenuPosition:null})})),(0,v.A)(this,"onRegisterClick",(()=>{S.A.dispatch({action:"start_registration"}),this.setState({contextMenuPosition:null})})),(0,v.A)(this,"onHomeClick",(e=>{e.preventDefault(),e.stopPropagation(),S.A.dispatch({action:W.r.ViewHomePage}),this.setState({contextMenuPosition:null})})),(0,v.A)(this,"renderContextMenu",(()=>{if(!this.state.contextMenuPosition)return null;let e,t,n;_.J.safeGet().isGuest()&&(e=i.createElement("div",{className:"mx_UserMenu_contextMenu_header mx_UserMenu_contextMenu_guestPrompts"},(0,l._t)("auth|sign_in_prompt",{},{a:e=>i.createElement(ie.A,{kind:"link_inline",onClick:this.onSignInClick},e)}),M.A.getValue(He.f.Registration)?(0,l._t)("auth|create_account_prompt",{},{a:e=>i.createElement(ie.A,{kind:"link_inline",onClick:this.onRegisterClick},e)}):null)),this.hasHomePage&&(t=i.createElement(na.R$,{iconClassName:"mx_UserMenu_iconHome",label:(0,l._t)("common|home"),onClick:this.onHomeClick})),(0,al.I)()&&(n=i.createElement(na.R$,{iconClassName:"mx_UserMenu_iconMessage",label:(0,l._t)("common|feedback"),onClick:this.onProvideFeedback}));const s=i.createElement(na.R$,{iconClassName:"mx_UserMenu_iconQr",label:(0,l._t)("user_menu|link_new_device"),onClick:e=>this.onSettingsOpen(e,Na.v.SessionManager,{showMsc4108QrCode:!0})});let o=i.createElement(na.tx,null,t,s,i.createElement(na.R$,{iconClassName:"mx_UserMenu_iconBell",label:(0,l._t)("notifications|enable_prompt_toast_title"),onClick:e=>this.onSettingsOpen(e,Na.v.Notifications)}),i.createElement(na.R$,{iconClassName:"mx_UserMenu_iconLock",label:(0,l._t)("room_settings|security|title"),onClick:e=>this.onSettingsOpen(e,Na.v.Security)}),i.createElement(na.R$,{iconClassName:"mx_UserMenu_iconSettings",label:(0,l._t)("user_menu|settings"),onClick:e=>this.onSettingsOpen(e)}),n,i.createElement(na.R$,{className:"mx_IconizedContextMenu_option_red",iconClassName:"mx_UserMenu_iconSignOut",label:(0,l._t)("action|sign_out"),onClick:this.onSignOutClick}));_.J.safeGet().isGuest()&&(o=i.createElement(na.tx,null,t,i.createElement(na.R$,{iconClassName:"mx_UserMenu_iconSettings",label:(0,l._t)("common|settings"),onClick:e=>this.onSettingsOpen(e)}),n));const r=this.props.isPanelCollapsed?{left:(a=this.state.contextMenuPosition).width+a.left+8,top:a.top,chevronFace:Gt.t4.None}:(e=>({left:e.left,top:e.top+e.height,chevronFace:Gt.t4.None}))(this.state.contextMenuPosition);var a;return i.createElement(na.Ay,(0,_t.A)({},r,{onFinished:this.onCloseMenu,className:"mx_UserMenu_contextMenu"}),i.createElement("div",{className:"mx_UserMenu_contextMenu_header"},i.createElement("div",{className:"mx_UserMenu_contextMenu_name"},i.createElement("span",{className:"mx_UserMenu_contextMenu_displayName"},il.V.instance.displayName),i.createElement("span",{className:"mx_UserMenu_contextMenu_userId"},wt.A.getDisplayUserIdentifier(_.J.safeGet().getSafeUserId(),{withDisplayName:!0}))),i.createElement(wn.k,{className:"mx_UserMenu_contextMenu_themeButton",onClick:this.onSwitchThemeClick,title:this.state.isDarkTheme?(0,l._t)("user_menu|switch_theme_light"):(0,l._t)("user_menu|switch_theme_dark")},i.createElement("img",{src:"img/element-icons/roomlist/dark-light-mode.328ce0f.svg",role:"presentation",alt:"",width:16}))),e,o)})),this.state={contextMenuPosition:null,isDarkTheme:this.isUserOnDarkTheme(),isHighContrast:this.isUserOnHighContrastTheme(),selectedSpace:us.Ay.instance.activeSpaceRoom,showLiveAvatarAddon:this.context.voiceBroadcastRecordingsStore.hasCurrent()}}get hasHomePage(){return!!Xa(c.Ay.get(),this.context.client)}componentDidMount(){il.V.instance.on(_r.H,this.onProfileUpdate),us.Ay.instance.on(Xr.tw,this.onSelectedSpaceUpdate),this.context.voiceBroadcastRecordingsStore.on(Pt.Ls.CurrentChanged,this.onCurrentVoiceBroadcastRecordingChanged),this.dispatcherRef=S.A.register(this.onAction),this.themeWatcherRef=M.A.watchSetting("theme",null,this.onThemeChanged)}componentWillUnmount(){M.A.unwatchSetting(this.themeWatcherRef),M.A.unwatchSetting(this.dndWatcherRef),S.A.unregister(this.dispatcherRef),il.V.instance.off(_r.H,this.onProfileUpdate),us.Ay.instance.off(Xr.tw,this.onSelectedSpaceUpdate),this.context.voiceBroadcastRecordingsStore.off(Pt.Ls.CurrentChanged,this.onCurrentVoiceBroadcastRecordingChanged)}isUserOnDarkTheme(){if(M.A.getValue("use_system_theme"))return window.matchMedia("(prefers-color-scheme: dark)").matches;{const e=M.A.getValue("theme");return e.startsWith("custom-")?!!(0,Da.TP)(e.substring(7)).is_dark:"dark"===e}}isUserOnHighContrastTheme(){if(M.A.getValue("use_system_theme"))return window.matchMedia("(prefers-contrast: more)").matches;{const e=M.A.getValue("theme");return!e.startsWith("custom-")&&(0,Da.AZ)(e)}}render(){const e=_.J.safeGet().getSafeUserId(),t=il.V.instance.displayName||e,n=il.V.instance.getHttpAvatarUrl(32);let s;this.props.isPanelCollapsed||(s=i.createElement("div",{className:"mx_UserMenu_name"},t));const o=this.state.showLiveAvatarAddon?i.createElement("div",{className:"mx_UserMenu_userAvatarLive"},i.createElement(rl,{className:"mx_Icon_8"})):null;return i.createElement("div",{className:"mx_UserMenu"},i.createElement(Gt.VJ,{className:"mx_UserMenu_contextMenuButton",onClick:this.onOpenMenuClick,ref:this.buttonRef,label:(0,l._t)("a11y|user_menu"),isExpanded:!!this.state.contextMenuPosition,onContextMenu:this.onContextMenu},i.createElement("div",{className:"mx_UserMenu_userAvatar"},i.createElement(os.A,{idName:e,name:t,url:n,size:"32px",className:"mx_UserMenu_userAvatar_BaseAvatar"}),o),s,this.renderContextMenu()),this.props.children)}}(0,v.A)(ll,"contextType",X.A);const cl=["children","trackHorizontalOverflow","verticalScrollsHorizontally"];class dl extends i.Component{constructor(e){super(e),(0,v.A)(this,"autoHideScrollbar",(0,i.createRef)()),(0,v.A)(this,"scrollElement",void 0),(0,v.A)(this,"likelyTrackpadUser",null),(0,v.A)(this,"checkAgainForTrackpad",0),(0,v.A)(this,"collectScroller",(e=>{var t,n;null===(t=(n=this.props).wrappedRef)||void 0===t||t.call(n,e),e&&!this.scrollElement&&(this.scrollElement=e,this.scrollElement.addEventListener("scroll",this.checkOverflow,{passive:!0}),this.checkOverflow())})),(0,v.A)(this,"checkOverflow",(()=>{if(!this.scrollElement)return;const e=this.scrollElement.scrollTop>0,t=this.scrollElement.scrollHeight>this.scrollElement.scrollTop+this.scrollElement.clientHeight,n=this.scrollElement.scrollLeft>0,i=this.scrollElement.scrollWidth>this.scrollElement.scrollLeft+this.scrollElement.clientWidth;e?this.scrollElement.classList.add("mx_IndicatorScrollbar_topOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_topOverflow"),t?this.scrollElement.classList.add("mx_IndicatorScrollbar_bottomOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_bottomOverflow"),n?this.scrollElement.classList.add("mx_IndicatorScrollbar_leftOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_leftOverflow"),i?this.scrollElement.classList.add("mx_IndicatorScrollbar_rightOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_rightOverflow"),this.props.trackHorizontalOverflow&&this.setState({leftIndicatorOffset:n?`${this.scrollElement.scrollLeft}px`:"0",rightIndicatorOffset:i?`-${this.scrollElement.scrollLeft}px`:"0"})})),(0,v.A)(this,"onMouseWheel",(e=>{if(this.props.verticalScrollsHorizontally&&this.scrollElement){const t=0,n=1,i=(new Date).getTime();if(Math.abs(e.deltaX)>0?(this.likelyTrackpadUser=!0,this.checkAgainForTrackpad=i+6e4):this.likelyTrackpadUser&&i>=this.checkAgainForTrackpad&&(this.likelyTrackpadUser=!1),this.likelyTrackpadUser)return;if(Math.abs(e.deltaX)<=t){const t=e.deltaY<0?-50:50,i=Math.abs(e.deltaY)<25?e.deltaY+t:e.deltaY;this.scrollElement.scrollLeft+=i*n}}})),this.state={leftIndicatorOffset:"0",rightIndicatorOffset:"0"}}componentDidUpdate(e){i.Children.count(e.children)!==i.Children.count(this.props.children)&&this.checkOverflow()}componentDidMount(){this.checkOverflow(),Zr.A.instance.on(Zr.x.Resize,this.checkOverflow)}componentWillUnmount(){var e;null===(e=this.scrollElement)||void 0===e||e.removeEventListener("scroll",this.checkOverflow),Zr.A.instance.off(Zr.x.Resize,this.checkOverflow)}render(){const e=this.props,{children:t,trackHorizontalOverflow:n,verticalScrollsHorizontally:s}=e,o=(0,g.A)(e,cl),r={left:this.state.leftIndicatorOffset},a={right:this.state.rightIndicatorOffset},l=n?i.createElement("div",{className:"mx_IndicatorScrollbar_leftOverflowIndicator",style:r}):null,c=n?i.createElement("div",{className:"mx_IndicatorScrollbar_rightOverflowIndicator",style:a}):null;return i.createElement(xi.A,(0,_t.A)({},o,{ref:this.autoHideScrollbar,wrappedRef:this.collectScroller,onWheel:this.onMouseWheel}),l,t,c)}}var ml=n("./node_modules/@vector-im/compound-web/dist/components/Menu/Menu.js"),ul=n("./node_modules/@vector-im/compound-web/dist/components/Menu/MenuItem.js"),hl=n("./node_modules/@vector-im/compound-web/dist/components/Button/IconButton/IconButton.js"),pl=n("./node_modules/@vector-im/compound-web/dist/components/Typography/Text.js");const gl=["displayLabel","notificationLevel","disableTooltip"],vl=(0,i.forwardRef)((function(e,t){let{displayLabel:n,notificationLevel:s,disableTooltip:o}=e,r=(0,g.A)(e,gl);const a=!o&&!n&&void 0;return i.createElement(Et.m,{label:(0,l._t)("common|threads"),placement:"right",open:a},i.createElement(hl.K,(0,_t.A)({"aria-label":(0,l._t)("common|threads"),className:dt()("mx_ThreadsActivityCentreButton",{expanded:n}),indicator:(0,mi.W7)(s)},r,{ref:t}),i.createElement(i.Fragment,null,i.createElement(li.A,{className:"mx_ThreadsActivityCentreButton_Icon"}),n&&i.createElement(pl.E,{className:"mx_ThreadsActivityCentreButton_Text",as:"span",size:"md",title:(0,l._t)("common|threads")},(0,l._t)("common|threads")))))}));var _l=n("./src/stores/right-panel/RightPanelStore.ts"),fl=n("./src/stores/right-panel/RightPanelStorePhases.ts"),El=n("./src/Unread.ts"),yl=n("./src/stores/room-list/filters/VisibilityProvider.ts");function bl(e){const t=(0,pt.ti)("feature_dynamic_room_predecessors"),n=(0,pt.ti)("Notifications.tac_only_notifications"),s=(0,Hn.nH)(),[r,a]=(0,i.useState)({greatestNotificationLevel:da.S.None,rooms:[]}),l=(0,i.useCallback)((()=>{a(function(e,t,n){const i=e.getVisibleRooms(t);let s=da.S.None;const o=[];for(const e of i)if(yl.W.instance.isRoomVisible(e)&&(0,El.Nb)(e)){const t=(0,mi.gM)(e);if(n&&t<=da.S.Activity)continue;t>s&&(s=t),o.push({room:e,notificationLevel:t})}const r=o.sort(((e,t)=>function(e,t){var n,i;const{notificationLevel:s,room:o}=e,{notificationLevel:r,room:a}=t,l=null===(n=o.getLastThread())||void 0===n||null===(n=n.events.at(-1))||void 0===n?void 0:n.getTs(),c=null===(i=a.getLastThread())||void 0===i||null===(i=i.events.at(-1))||void 0===i?void 0:i.getTs();return s>r?-1:r>s?1:l?c?c-l:-1:1}(e,t)));return{greatestNotificationLevel:s,rooms:r}}(s,t,n))}),[s,t,n]),c=(0,i.useCallback)((0,Vn.throttle)(l,500,{leading:!1,trailing:!0}),[l]);return(0,ci.ml)(s,o.ClientEvent.Sync,c),(0,ci.ml)(s,o.MatrixEventEvent.Decrypted,c),(0,i.useEffect)((()=>{e&&l()}),[l,e]),r}var wl=n("./node_modules/@vector-im/compound-web/dist/components/ReleaseAnnouncement/ReleaseAnnouncement.js"),Sl=n("./src/settings/Settings.tsx");const Al=["threadsActivityCentre","pinningMessageList"];class Cl extends o.TypedEventEmitter{static get instance(){return Cl.internalInstance||(Cl.internalInstance=new Cl),Cl.internalInstance}constructor(){super(),(0,v.A)(this,"index",0),M.A.watchSetting("releaseAnnouncementData",null,(()=>{this.emit("releaseAnnouncementChanged",this.getReleaseAnnouncement())}))}getViewedReleaseAnnouncements(){return(0,Vn.cloneDeep)(M.A.getValue("releaseAnnouncementData"))}isReleaseAnnouncementEnabled(){return M.A.getValue(Sl.O5.ReleaseAnnouncement)}getReleaseAnnouncement(){if(!this.isReleaseAnnouncementEnabled())return null;const e=this.getViewedReleaseAnnouncements();for(let t=this.index;t<Al.length;t++)if(!e[Al[t]])return this.index=t,Al[this.index];return null}async markReleaseAnnouncementAsViewed(){if(!this.isReleaseAnnouncementEnabled())return;const e=this.getViewedReleaseAnnouncements();if(!Al[this.index])return;e[Al[this.index]]=!0,this.index++;if(!M.A.isLevelSupported(O.p.ACCOUNT))return;if(M.A.canSetValue("releaseAnnouncementData",null,O.p.ACCOUNT))try{await M.A.setValue("releaseAnnouncementData",null,O.p.ACCOUNT,e)}catch(e){s.v.log("Failed to set release announcement settings",e)}}async nextReleaseAnnouncement(){await this.markReleaseAnnouncementAsViewed(),this.emit("releaseAnnouncementChanged",this.getReleaseAnnouncement())}}function xl(e){const t=function(){const[e,t]=(0,i.useState)(!1);return(0,ci.YK)(k.Ay,k.XM.Opened,(()=>t(!0))),(0,ci.YK)(k.Ay,k.XM.Closed,(()=>!k.Ay.hasDialogs()&&t(!1))),e}(),n=(0,ci.DY)(Cl.instance,"releaseAnnouncementChanged",(()=>Cl.instance.getReleaseAnnouncement()===e));return!t&&n}(0,v.A)(Cl,"internalInstance",void 0);const kl=["feature","children"];function Rl(e){let{feature:t,children:n}=e,s=(0,g.A)(e,kl);const o=xl(t);return i.createElement(wl.l,(0,_t.A)({open:o,onClick:()=>Cl.instance.nextReleaseAnnouncement()},s),n)}function Il({displayButtonLabel:e}){const[t,n]=(0,i.useState)(!1),s=bl(t),o=xl("threadsActivityCentre"),r=(0,pt.ti)("Notifications.tac_only_notifications")?(0,l._t)("threads_activity_centre|no_rooms_with_threads_notifs"):(0,l._t)("threads_activity_centre|no_rooms_with_unread_threads");return i.createElement("div",{className:"mx_ThreadsActivityCentre_container",onKeyDown:e=>{if(!t)return;(0,_s.zM)().getNavigationAction(e)===Pn.bY.FilterRooms&&e.stopPropagation()}},o?i.createElement(Rl,{feature:"threadsActivityCentre",header:(0,l._t)("threads_activity_centre|release_announcement_header"),description:(0,l._t)("threads_activity_centre|release_announcement_description"),closeLabel:(0,l._t)("action|ok")},i.createElement(vl,{disableTooltip:!0,displayLabel:e,notificationLevel:s.greatestNotificationLevel,onClick:async()=>{n(!0),await Cl.instance.nextReleaseAnnouncement()}})):i.createElement(ml.W,{align:"start",side:"top",open:t,onOpenChange:e=>{e&&Mn.A.trackInteraction("WebThreadsActivityCentreButton"),n(e)},title:(0,l._t)("threads_activity_centre|header"),trigger:i.createElement(vl,{displayLabel:e,notificationLevel:s.greatestNotificationLevel})},i.createElement("div",{className:"mx_ThreadsActivityCentre_rows"},s.rooms.map((({room:e,notificationLevel:t})=>i.createElement(Tl,{key:e.roomId,room:e,notificationLevel:t,onClick:()=>n(!1)}))),0===s.rooms.length&&i.createElement("div",{className:"mx_ThreadsActivityCentre_emptyCaption"},r))))}function Tl({room:e,onClick:t,notificationLevel:n}){return i.createElement(ul.D,{className:"mx_ThreadsActivityCentreRow",onSelect:n=>{t(),_l.A.instance.setCard({phase:fl.n.ThreadPanel},!0,e.roomId),Mn.A.trackInteraction("WebThreadsActivityCentreRoomItem",n),S.A.dispatch({action:W.r.ViewRoom,show_room_tile:!0,room_id:e.roomId,metricsTrigger:"WebThreadsActivityCentre",focusNext:"threadsPanel"})},label:e.name,Icon:i.createElement(es.A,{room:e,size:"32px"})},i.createElement(Ni.V,{level:n,count:0,symbol:null,forceDot:!0}))}var Pl=n("./src/accessibility/LandmarkNavigation.ts"),Nl=n("./src/components/views/settings/KeyboardShortcut.tsx");const Dl=["onFinished","hideHeader"],Ml=["selected","isPanelCollapsed","size"],Ol=["children","isPanelCollapsed","setPanelCollapsed","isDraggingOver","innerRef"],Ll=e=>{let{onFinished:t,hideHeader:n}=e,s=(0,g.A)(e,Dl);const o=(0,pt.ti)("Spaces.allRoomsInHome");return i.createElement(na.Ay,(0,_t.A)({},s,{onFinished:t,className:"mx_SpacePanel_contextMenu",compact:!0}),!n&&i.createElement("div",{className:"mx_SpacePanel_contextMenu_header"},(0,l._t)("common|home")),i.createElement(na.tx,{first:!0},i.createElement(na.LS,{iconClassName:"mx_SpacePanel_noIcon",label:(0,l._t)("settings|sidebar|metaspaces_home_all_rooms"),active:o,onClick:()=>{t(),M.A.setValue("Spaces.allRoomsInHome",null,O.p.ACCOUNT,!o)}})))},Ul=e=>{let{selected:t,isPanelCollapsed:n,size:s="32px"}=e,o=(0,g.A)(e,Ml);return i.createElement("li",{className:dt()("mx_SpaceItem",{collapsed:n}),role:"treeitem","aria-selected":t},i.createElement(pa,(0,_t.A)({},o,{selected:t,isNarrow:n,size:s})))},Fl=()=>us.Ay.instance.allRoomsInHome?ya.n.instance.globalState:us.Ay.instance.getNotificationState(Xr._b.Home),Vl=({isPanelCollapsed:e,setPanelCollapsed:t})=>{const[n,s,o,r]=(0,Gt.EF)();let a;(0,i.useEffect)((()=>{!e&&n&&r()}),[e]),n&&(a=i.createElement(aa.Ay,{onFinished:r}));const c=n?r:()=>{e||t(!0),o()};return i.createElement("li",{className:dt()("mx_SpaceItem mx_SpaceItem_new",{collapsed:e}),role:"treeitem","aria-selected":!1},i.createElement(pa,{className:dt()("mx_SpaceButton_new",{mx_SpaceButton_newCancel:n}),label:n?(0,l._t)("action|cancel"):(0,l._t)("create_space|label"),onClick:c,isNarrow:e,innerRef:s,size:"32px"}),a)},Bl={[Xr._b.Home]:({selected:e,isPanelCollapsed:t})=>{const n=(0,ci.dF)(us.Ay.instance,Xr.EC,(()=>us.Ay.instance.allRoomsInHome)),[s,o]=(0,i.useState)(Fl()),r=(0,i.useCallback)((()=>{o(Fl())}),[]);return(0,i.useEffect)(r,[r,n]),(0,ci.ml)(ya.n.instance,ya.N,r),i.createElement(Ul,{spaceKey:Xr._b.Home,className:"mx_SpaceButton_home",selected:e,isPanelCollapsed:t,label:(0,Xr.Ff)(Xr._b.Home,n),notificationState:s,ContextMenuComponent:Ll,contextMenuTooltip:(0,l._t)("common|options"),size:"32px"})},[Xr._b.Favourites]:({selected:e,isPanelCollapsed:t})=>i.createElement(Ul,{spaceKey:Xr._b.Favourites,className:"mx_SpaceButton_favourites",selected:e,isPanelCollapsed:t,label:(0,Xr.Ff)(Xr._b.Favourites),notificationState:us.Ay.instance.getNotificationState(Xr._b.Favourites),size:"32px"}),[Xr._b.People]:({selected:e,isPanelCollapsed:t})=>i.createElement(Ul,{spaceKey:Xr._b.People,className:"mx_SpaceButton_people",selected:e,isPanelCollapsed:t,label:(0,Xr.Ff)(Xr._b.People),notificationState:us.Ay.instance.getNotificationState(Xr._b.People),size:"32px"}),[Xr._b.Orphans]:({selected:e,isPanelCollapsed:t})=>i.createElement(Ul,{spaceKey:Xr._b.Orphans,className:"mx_SpaceButton_orphans",selected:e,isPanelCollapsed:t,label:(0,Xr.Ff)(Xr._b.Orphans),notificationState:us.Ay.instance.getNotificationState(Xr._b.Orphans),size:"32px"}),[Xr._b.VideoRooms]:({selected:e,isPanelCollapsed:t})=>i.createElement(Ul,{spaceKey:Xr._b.VideoRooms,className:"mx_SpaceButton_videoRooms",selected:e,isPanelCollapsed:t,label:(0,Xr.Ff)(Xr._b.VideoRooms),notificationState:us.Ay.instance.getNotificationState(Xr._b.VideoRooms),size:"32px"})},jl=i.memo((e=>{let{children:t,isPanelCollapsed:n,setPanelCollapsed:s,isDraggingOver:o,innerRef:r}=e,a=(0,g.A)(e,Ol);const[c,d,m,u]=(()=>{const e=(0,ci.dF)(us.Ay.instance,Xr.kQ,(()=>us.Ay.instance.invitedSpaces)),[t,n]=(0,ci.dF)(us.Ay.instance,Xr.bZ,(()=>[us.Ay.instance.enabledMetaSpaces,us.Ay.instance.spacePanelSpaces]));return[e,t,n,(0,ci.dF)(us.Ay.instance,Xr.tw,(()=>us.Ay.instance.activeSpace))]})(),h=u?[u]:[],p=d.filter((e=>!(e===Xr._b.VideoRooms&&!M.A.getValue("feature_video_rooms")))).map((e=>{const t=Bl[e];return i.createElement(t,{key:e,selected:u===e,isPanelCollapsed:n})}));return i.createElement(dl,(0,_t.A)({},a,{wrappedRef:r,className:"mx_SpaceTreeLevel",style:o?{pointerEvents:"none"}:void 0,element:"ul",role:"tree","aria-label":(0,l._t)("common|spaces")}),p,c.map((e=>i.createElement(ga,{key:e.roomId,space:e,activeSpaces:h,isPanelCollapsed:n,onExpand:()=>s(!1)}))),m.map(((e,t)=>i.createElement(ra.sx,{key:e.roomId,draggableId:e.roomId,index:t},((t,o)=>i.createElement(ga,(0,_t.A)({},t.draggableProps,{dragHandleProps:t.dragHandleProps,key:e.roomId,innerRef:t.innerRef,className:o.isDragging?"mx_SpaceItem_dragging":void 0,space:e,activeSpaces:h,isPanelCollapsed:n,onExpand:()=>s(!1)})))))),t,(0,ea.g)(He.C.CreateSpaces)&&i.createElement(Vl,{isPanelCollapsed:n,setPanelCollapsed:s}))})),Wl=()=>{const[e,t]=(0,i.useState)(!1),[n,s]=(0,i.useState)(!0),o=(0,i.useRef)(null);return(0,i.useLayoutEffect)((()=>(o.current&&Zr.A.instance.trackElementDimensions("SpacePanel",o.current),()=>Zr.A.instance.stopTrackingElementDimensions("SpacePanel"))),[]),(0,Ws.F)(S.A,(e=>{e.action===W.r.ToggleSpacePanel&&s(!n)})),i.createElement(wn.Se,{handleHomeEnd:!0,handleUpDown:!e},(({onKeyDownHandler:e,onDragEndHandler:r})=>i.createElement(ra.JY,{onDragStart:()=>{t(!0)},onDragEnd:e=>{t(!1),e.destination&&(us.Ay.instance.moveRootSpace(e.source.index,e.destination.index),r())}},i.createElement("nav",{className:dt()("mx_SpacePanel",{collapsed:n}),onKeyDown:t=>{const n=(0,_s.zM)().getNavigationAction(t);if(n===Pn.bY.NextLandmark||n===Pn.bY.PreviousLandmark)return Pl.r.findAndFocusNextLandmark(Pl.H.ACTIVE_SPACE_BUTTON,n===Pn.bY.PreviousLandmark),t.stopPropagation(),void t.preventDefault();e(t)},ref:o,"aria-label":(0,l._t)("common|spaces")},i.createElement(ll,{isPanelCollapsed:n},i.createElement(ie.A,{className:dt()("mx_SpacePanel_toggleCollapse",{expanded:!n}),onClick:()=>s(!n),title:n?(0,l._t)("action|expand"):(0,l._t)("action|collapse"),caption:i.createElement(Nl.S,{value:{ctrlOrCmdKey:!0,shiftKey:!0,key:"d"},className:"mx_SpacePanel_Tooltip_KeyboardShortcut"})})),i.createElement(ra.gL,{droppableId:"top-level-spaces"},((e,t)=>i.createElement(jl,(0,_t.A)({},e.droppableProps,{isPanelCollapsed:n,setPanelCollapsed:s,isDraggingOver:t.isDraggingOver,innerRef:e.innerRef}),e.placeholder))),i.createElement(Il,{displayButtonLabel:!n}),i.createElement(Ha,{isPanelCollapsed:n})))))},zl=e=>({left:e.left+window.scrollX,top:e.bottom+window.scrollY+12,chevronFace:Gt.t4.None});var Hl=function(e){return e[e.JoinRoom=0]="JoinRoom",e[e.BulkRedact=1]="BulkRedact",e}(Hl||{});const Kl=({onVisibilityChange:e})=>{var t;const n=(0,i.useContext)(Hn.Ay),[s,r,a,c]=(0,Gt.EF)(),[d,m,u,h]=(0,Gt.EF)(),[p,g]=(0,ci.dF)(us.Ay.instance,Xr.tw,(()=>[us.Ay.instance.activeSpace,us.Ay.instance.activeSpaceRoom])),v=(0,ci.dF)(us.Ay.instance,Xr.EC,(()=>us.Ay.instance.allRoomsInHome)),_=(0,pt.ny)("feature_video_rooms"),f=(0,pt.ny)("feature_element_call_video_rooms"),E=(()=>{const e=(0,i.useContext)(Hn.Ay),[t,n]=(0,i.useState)(new Map),s=(e,i)=>{const s=new Set(t.get(e));s.add(i),n(new Map(t).set(e,s))},r=(e,i)=>{const s=new Set(t.get(e));s.delete(i)&&n(new Map(t).set(e,s))};return(0,Ws.F)(S.A,(e=>{switch(e.action){case W.r.JoinRoom:s(Hl.JoinRoom,e.roomId);break;case W.r.JoinRoomReady:case W.r.JoinRoomError:r(Hl.JoinRoom,e.roomId);break;case W.r.BulkRedactStart:s(Hl.BulkRedact,e.roomId);break;case W.r.BulkRedactEnd:r(Hl.BulkRedact,e.roomId)}})),(0,ci.YK)(e,o.ClientEvent.Room,(e=>r(Hl.JoinRoom,e.roomId))),t})(),y=g||p===Xr._b.Home;(0,i.useEffect)((()=>{s&&!y&&c()}),[c,y,s]);const b=(0,ci.DY)(null!=g?g:void 0,o.RoomEvent.Name,(()=>null==g?void 0:g.name));(0,i.useEffect)((()=>{null==e||e()}),[e]);const w=(0,ea.g)(He.C.ExploreRooms),A=(0,ea.g)(He.C.CreateRooms),C=(0,ea.g)(He.C.CreateSpaces),x=null==g||null===(t=g.currentState)||void 0===t?void 0:t.maySendStateEvent(o.EventType.SpaceChild,n.getUserId()),k=x&&A,R=x&&C,I=A||w||C||g;let T,P;if(s&&r.current){let e;e=g?sa:Ll,T=i.createElement(e,(0,_t.A)({},zl(r.current.getBoundingClientRect()),{space:g,onFinished:c,hideHeader:!0}))}else if(d&&g){let e,t;(0,mo.MI)(g)&&(e=i.createElement(na.R$,{label:(0,l._t)("action|invite"),iconClassName:"mx_RoomListHeader_iconInvite",onClick:e=>{e.preventDefault(),e.stopPropagation(),(0,mo.Lo)(g),h()}})),null!=g&&g.currentState.maySendStateEvent(o.EventType.RoomAvatar,n.getUserId())&&(t=i.createElement(i.Fragment,null,i.createElement(na.R$,{iconClassName:"mx_RoomListHeader_iconNewRoom",label:(0,l._t)("action|new_room"),onClick:e=>{e.preventDefault(),e.stopPropagation(),(0,mo.PT)(g),Mn.A.trackInteraction("WebRoomListHeaderPlusMenuCreateRoomItem",e),h()}}),_&&i.createElement(na.R$,{iconClassName:"mx_RoomListHeader_iconNewVideoRoom",label:(0,l._t)("action|new_video_room"),onClick:e=>{e.preventDefault(),e.stopPropagation(),(0,mo.PT)(g,f?o.RoomType.UnstableCall:o.RoomType.ElementVideo),h()}},i.createElement(ta.s,null)))),T=i.createElement(na.Ay,(0,_t.A)({},zl(m.current.getBoundingClientRect()),{onFinished:h,compact:!0}),i.createElement(na.tx,{first:!0},e,t,i.createElement(na.R$,{label:(0,l._t)("action|explore_rooms"),iconClassName:"mx_RoomListHeader_iconExplore",onClick:e=>{e.preventDefault(),e.stopPropagation(),S.A.dispatch({action:W.r.ViewRoom,room_id:g.roomId,metricsTrigger:void 0}),h(),Mn.A.trackInteraction("WebRoomListHeaderPlusMenuExploreRoomsItem",e)}}),i.createElement(na.R$,{label:(0,l._t)("action|add_existing_room"),iconClassName:"mx_RoomListHeader_iconPlus",onClick:e=>{e.preventDefault(),e.stopPropagation(),(0,mo.yV)(g),h()},disabled:!k,title:k?void 0:(0,l._t)("spaces|error_no_permission_add_room")}),C&&i.createElement(na.R$,{label:(0,l._t)("room_list|add_space_label"),iconClassName:"mx_RoomListHeader_iconPlus",onClick:e=>{e.preventDefault(),e.stopPropagation(),(0,mo.Sl)(g),h()},disabled:!R,title:R?void 0:(0,l._t)("spaces|error_no_permission_add_space")},i.createElement(ta.s,null))))}else if(d){let e,t;A&&(e=i.createElement(i.Fragment,null,i.createElement(na.R$,{label:(0,l._t)("action|start_new_chat"),iconClassName:"mx_RoomListHeader_iconStartChat",onClick:e=>{e.preventDefault(),e.stopPropagation(),S.A.dispatch({action:"view_create_chat"}),Mn.A.trackInteraction("WebRoomListHeaderPlusMenuCreateChatItem",e),h()}}),i.createElement(na.R$,{label:(0,l._t)("action|new_room"),iconClassName:"mx_RoomListHeader_iconNewRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),S.A.dispatch({action:"view_create_room"}),Mn.A.trackInteraction("WebRoomListHeaderPlusMenuCreateRoomItem",e),h()}}),_&&i.createElement(na.R$,{label:(0,l._t)("action|new_video_room"),iconClassName:"mx_RoomListHeader_iconNewVideoRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),S.A.dispatch({action:"view_create_room",type:f?o.RoomType.UnstableCall:o.RoomType.ElementVideo}),h()}},i.createElement(ta.s,null)))),w&&(t=i.createElement(na.R$,{label:(0,l._t)("room_list|join_public_room_label"),iconClassName:"mx_RoomListHeader_iconExplore",onClick:e=>{e.preventDefault(),e.stopPropagation(),S.A.dispatch({action:W.r.ViewRoomDirectory}),Mn.A.trackInteraction("WebRoomListHeaderPlusMenuExploreRoomsItem",e),h()}})),T=i.createElement(na.Ay,(0,_t.A)({},zl(m.current.getBoundingClientRect()),{onFinished:h,compact:!0}),i.createElement(na.tx,{first:!0},e,t))}P=g&&b?b:(0,Xr.Ff)(p,v);const N=[...E.entries()].filter((([e,t])=>t.size>0)).map((([e,t])=>{switch(e){case Hl.JoinRoom:return(0,l._t)("room_list|joining_rooms_status",{count:t.size});case Hl.BulkRedact:return(0,l._t)("room_list|redacting_messages_status",{count:t.size})}})).join("\n");let D=i.createElement("div",{className:"mx_RoomListHeader_contextLessTitle"},P);if(y){const e={ref:r,onClick:a,isExpanded:s,className:"mx_RoomListHeader_contextMenuButton",children:P};D=g?i.createElement(Gt.VJ,(0,_t.A)({},e,{label:(0,l._t)("room_list|space_menu_label",{spaceName:null!=b?b:g.name})})):i.createElement(Gt.oW,(0,_t.A)({},e,{title:(0,l._t)("room_list|home_menu_label")}))}return i.createElement("aside",{className:"mx_RoomListHeader","aria-label":(0,l._t)("room|context_menu|title")},D,N?i.createElement(Et.m,{label:N,isTriggerInteractive:!1},i.createElement(oa.A,null)):null,I&&i.createElement(Gt.oW,{ref:m,onClick:u,isExpanded:d,className:"mx_RoomListHeader_plusButton",title:(0,l._t)("action|add")}),T)};var Jl=n("./src/stores/BreadcrumbsStore.ts"),Gl=n("./src/stores/room-list/RoomListStore.ts"),$l=n("./node_modules/react-transition-group/cjs/index.js");const ql=({room:e,onClick:t})=>{const[n,s,o]=(0,wn.A9)();return i.createElement(ie.A,{className:"mx_RoomBreadcrumbs_crumb",onClick:t,"aria-label":(0,l._t)("a11y|room_name",{name:e.name}),title:e.name,onFocus:n,ref:o,tabIndex:s?0:-1,placement:"right"},i.createElement(es.A,{room:e,size:"32px",displayBadge:!0,hideIfDot:!0,tooltipProps:{tabIndex:s?0:-1}}))};class Yl extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,"unmounted",!1),(0,v.A)(this,"toolbar",(0,i.createRef)()),(0,v.A)(this,"onBreadcrumbsUpdate",(()=>{this.unmounted||(this.setState({doAnimation:!1,skipFirst:!0}),window.setTimeout((()=>this.setState({doAnimation:!0,skipFirst:!1})),0))})),(0,v.A)(this,"viewRoom",((e,t,n=!1)=>{S.A.dispatch({action:W.r.ViewRoom,room_id:e.roomId,metricsTrigger:"WebHorizontalBreadcrumbs",metricsViaKeyboard:n})})),this.state={doAnimation:!0,skipFirst:!1}}componentDidMount(){this.unmounted=!1,Jl.Y.instance.on(_r.H,this.onBreadcrumbsUpdate)}componentWillUnmount(){this.unmounted=!0,Jl.Y.instance.off(_r.H,this.onBreadcrumbsUpdate)}render(){const e=Jl.Y.instance.rooms.map(((e,t)=>i.createElement(ql,{key:e.roomId,room:e,onClick:n=>this.viewRoom(e,t,"click"!==n.type)})));return e.length>0?i.createElement($l.B1,{appear:!0,in:this.state.doAnimation,timeout:640,classNames:"mx_RoomBreadcrumbs",nodeRef:this.toolbar},i.createElement(bn.A,{className:"mx_RoomBreadcrumbs","aria-label":(0,l._t)("room_list|breadcrumbs_label"),ref:this.toolbar},e.slice(this.state.skipFirst?1:0))):i.createElement("div",{className:"mx_RoomBreadcrumbs"},i.createElement("div",{className:"mx_RoomBreadcrumbs_placeholder"},(0,l._t)("room_list|breadcrumbs_empty")))}}var Ql=n("./src/components/views/typography/Heading.tsx");function Xl(e,t){const[n,r]=(0,i.useState)(e),a=(0,Hn.nH)(),l=function(e){const t=(0,i.useRef)(e);return t.current=e,(0,i.useCallback)(((...e)=>t.current(...e)),[])}(t);return(0,i.useEffect)((()=>{if(n)return;let e=null,t=!0;const i=async()=>{null!==e&&(clearTimeout(e),e=null),r(await l(a)),t&&(e=window.setTimeout(i,5e3))};return i().catch((e=>s.v.warn("could not update user onboarding context",e))),a.on(o.ClientEvent.AccountData,i),()=>{t=!1,a.off(o.ClientEvent.AccountData,i),null!==e&&(clearTimeout(e),e=null)}}),[a,l,n]),n}function Zl(){const e=Xl(!1,(async e=>{const t=await e.getProfileInfo(e.getUserId());return Boolean(null==t?void 0:t.avatar_url)})),t=Xl(!1,(async e=>{const t=e.getDeviceId(),n=await e.getDevices();return Boolean(n.devices.find((e=>e.device_id!==t)))})),n=Xl(!1,(async()=>{var e;const t=null!==(e=x.A.shared().getUniqueRoomsWithIndividuals())&&void 0!==e?e:{};return Boolean(Object.keys(t).length)})),s=function(){const e=(0,Hn.nH)(),[t,n]=(0,i.useState)(!e.pushRules||b.Notifier.shouldShowPrompt()),s=(0,i.useCallback)((()=>{n(!e.pushRules||b.Notifier.shouldShowPrompt())}),[e]);(0,ci.ml)(b.Notifier,b.NotifierEvent.NotificationHiddenChange,(()=>{s()}));const r=(0,pt.ti)("notificationsEnabled");return(0,i.useEffect)((()=>{s()}),[r,s]),(0,ci.YK)(e,o.ClientEvent.Sync,s),t}();return(0,i.useMemo)((()=>({hasAvatar:e,hasDevices:t,hasDmRooms:n,showNotificationsPrompt:s})),[e,t,n,s])}var ec,tc,nc,ic,sc,oc,rc,ac,lc,cc,dc,mc,uc,hc,pc,gc,vc,_c,fc,Ec,yc,bc,wc,Sc,Ac,Cc,xc;function kc(){return kc=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},kc.apply(null,arguments)}var Rc=function(e,t){return i.createElement("svg",kc({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 564 168",role:"presentation","aria-hidden":!0,ref:t},e),ec||(ec=i.createElement("defs",null,i.createElement("radialGradient",{id:"f-droid_svg__a",cx:113,cy:-12.89,r:59.662,gradientTransform:"matrix(0 1.9611 -1.9778 0 5.51 -198.6)",gradientUnits:"userSpaceOnUse"},i.createElement("stop",{offset:0,stopColor:"#fff",stopOpacity:.098}),i.createElement("stop",{offset:1,stopColor:"#fff",stopOpacity:0})))),tc||(tc=i.createElement("path",{stroke:"#a6a6a6",strokeWidth:4,d:"M22 2h520c11.08 0 20 8.92 20 20v124c0 11.08-8.92 20-20 20H22c-11.08 0-20-8.92-20-20V22C2 10.92 10.92 2 22 2z"})),nc||(nc=i.createElement("path",{fill:"#fff",d:"M199.26 45.46v-6.682h-5.499v-2.766h8.831v10.681q-1.949 1.383-4.299 2.1-2.349.7-5.015.7-5.832 0-9.131-3.4-3.283-3.415-3.283-9.497 0-6.099 3.283-9.498 3.3-3.416 9.131-3.416 2.433 0 4.616.6 2.2.6 4.049 1.766v3.583q-1.867-1.583-3.966-2.383t-4.416-.8q-4.565 0-6.865 2.55-2.283 2.549-2.283 7.598 0 5.032 2.283 7.581 2.3 2.55 6.865 2.55 1.783 0 3.183-.3 1.4-.317 2.516-.967m9.48-21.33h15.729v2.833h-12.364v7.365h11.847v2.832h-11.847v9.015h12.664v2.832H208.74zm18.12 0h21.045v2.833h-8.831v22.045h-3.383V26.963h-8.83zm35.14 0h3.366v24.877H262zm6.61 0h21.045v2.833h-8.831v22.045h-3.383V26.963h-8.83zm45.24 2.28q-3.666 0-5.832 2.733-2.15 2.732-2.15 7.448 0 4.699 2.15 7.431 2.166 2.733 5.832 2.733t5.799-2.733q2.15-2.732 2.15-7.431 0-4.716-2.15-7.448-2.133-2.733-5.799-2.733m0-2.733q5.232 0 8.365 3.516 3.132 3.5 3.132 9.398 0 5.882-3.132 9.397-3.133 3.5-8.365 3.5-5.249 0-8.398-3.5-3.132-3.499-3.132-9.397t3.132-9.398q3.15-3.516 8.398-3.516m16.76.453h4.532l11.031 20.812V24.13h3.266v24.877h-4.532l-11.031-20.812v20.812h-3.266z","aria-label":"GET IT ON"})),ic||(ic=i.createElement("path",{fill:"#fff",d:"M180.81 136v-8.118l7.19-1.391V78.017l-7.19-1.392v-8.164h53.762v18.508h-10.391l-.603-8.071h-22.034v18.6h23.657v10.438h-23.657v18.555l7.236 1.391V136zm62.16-23.66v-10.437h26.162v10.437zM277.29 136v-8.118l7.283-1.53v-48.15l-7.283-1.577v-8.164h29.641q9.045 0 15.957 4.268 6.912 4.221 10.762 11.736 3.897 7.468 3.897 17.163v1.252q0 9.602-3.85 17.117-3.804 7.468-10.67 11.736t-15.91 4.268zm20.828-10.344h8.303q5.613 0 9.51-2.922 3.896-2.97 5.937-8.118 2.087-5.149 2.087-11.736v-1.299q0-6.68-2.087-11.782-2.041-5.149-5.938-8.025-3.896-2.922-9.509-2.922h-8.303zM344.79 136v-8.118l6.494-1.391V95.366l-7.19-1.392V85.81h19.807l.51 6.216.093 1.113q1.856-4.082 4.593-6.17t6.54-2.087q1.206 0 2.644.232 1.438.186 2.551.51l-1.438 12.478-6.726-.37q-2.876-.14-4.685.974-1.763 1.113-3.154 3.2v24.585l6.494 1.392V136zm63.08.98q-7.422 0-12.756-3.247t-8.164-9q-2.83-5.797-2.83-13.312v-.974q0-7.469 2.83-13.22 2.83-5.799 8.118-9.046 5.334-3.293 12.71-3.293 7.468 0 12.756 3.293 5.288 3.247 8.117 9t2.83 13.266v.974q0 7.515-2.83 13.313-2.83 5.752-8.117 9-5.289 3.247-12.664 3.247zm0-10.391q3.525 0 5.752-1.902t3.293-5.288q1.067-3.433 1.067-7.979v-.974q0-4.453-1.067-7.839-1.066-3.433-3.34-5.335-2.226-1.948-5.798-1.948-3.479 0-5.752 1.948-2.273 1.902-3.34 5.335-1.02 3.386-1.02 7.84v.973q0 4.546 1.02 7.979 1.067 3.433 3.34 5.334 2.273 1.856 5.845 1.856M437.1 136v-8.118l6.54-1.391V95.366l-7.236-1.392V85.81h20.781v40.681l6.494 1.392V136zm6.077-60.813v-11.55h14.009v11.55zm44.293 61.793q-5.984 0-10.298-3.062-4.268-3.107-6.54-8.627-2.273-5.567-2.273-12.988v-.975q0-7.932 2.273-13.87 2.319-5.937 6.586-9.23 4.268-3.34 10.205-3.34 4.129 0 7.237 1.67 3.108 1.623 5.38 4.638V73.198l-7.236-1.391v-8.164h20.781v62.854l6.494 1.391v8.118h-18.23l-1.02-6.123q-2.366 3.479-5.66 5.288-3.246 1.81-7.7 1.81zm4.036-10.53q2.83 0 4.963-1.206t3.572-3.479v-21.292q-1.392-2.412-3.526-3.71-2.133-1.346-4.917-1.346-3.386 0-5.566 2.04-2.134 1.995-3.154 5.567-.974 3.572-.974 8.303v.975q0 6.587 2.226 10.39 2.227 3.758 7.376 3.758","aria-label":"F-Droid"})),sc||(sc=i.createElement("path",{fill:"#8ab000",stroke:"#769616",strokeLinecap:"round",strokeWidth:6.579,d:"m146.34 25.898-11.184 14.474"})),oc||(oc=i.createElement("path",{fill:"#fff",fillOpacity:.298,d:"M146.29 22.477c1.192.032 2.003.497 2.579 1.182-5.332 6.34-6.232 7.344-13.513 16.37-2.684 3.472-5.479 1.677-2.795-1.794l11.184-14.474a3.26 3.26 0 0 1 2.545-1.284",color:"#000"})),rc||(rc=i.createElement("path",{fill:"#263238",fillOpacity:.2,d:"M148.89 23.793a3.29 3.29 0 0 1 .058 4.095l-11.184 14.474c-2.684 3.474-3.026-1.61-3.026-1.61s9.829-11.87 14.153-16.959z",color:"#000"})),ac||(ac=i.createElement("path",{fill:"#8ab000",d:"M147 23.003c1.153 0 2.526.374 2.168 2.103-.27 1.318-12.263 15.984-12.263 15.984-2.684 3.47-6.563 1.779-3.879-1.693l11.142-14.4c.685-.763 1.603-1.957 2.832-1.994",color:"#000"})),lc||(lc=i.createElement("path",{fill:"#8ab000",stroke:"#769616",strokeLinecap:"round",strokeWidth:6.579,d:"m33.653 25.898 11.184 14.474"})),cc||(cc=i.createElement("path",{fill:"#fff",fillOpacity:.298,d:"M33.711 22.477c-1.192.032-2.003.497-2.579 1.182 5.332 6.34 6.232 7.344 13.513 16.37 2.684 3.472 5.479 1.677 2.795-1.794L36.256 23.76a3.26 3.26 0 0 0-2.545-1.284z",color:"#000"})),dc||(dc=i.createElement("path",{fill:"#263238",fillOpacity:.2,d:"M31.108 23.793a3.29 3.29 0 0 0-.058 4.095l11.184 14.474c2.684 3.474 3.026-1.61 3.026-1.61s-9.829-11.87-14.153-16.959z",color:"#000"})),mc||(mc=i.createElement("path",{fill:"#8ab000",d:"M32.993 23.003c-1.153 0-2.526.374-2.168 2.103.27 1.318 12.263 15.984 12.263 15.984 2.684 3.47 6.563 1.779 3.879-1.693l-11.142-14.4c-.685-.763-1.603-1.957-2.832-1.994",color:"#000"})),uc||(uc=i.createElement("path",{fill:"#aeea00",d:"M47.893 35.109h84.211a7.88 7.88 0 0 1 7.895 7.894v18.211a7.88 7.88 0 0 1-7.895 7.895H47.893a7.88 7.88 0 0 1-7.895-7.895v-18.21a7.88 7.88 0 0 1 7.895-7.895"})),hc||(hc=i.createElement("path",{fill:"#263238",fillOpacity:.2,d:"M47.893 42.74h84.211a7.88 7.88 0 0 1 7.895 7.895v10.526a7.88 7.88 0 0 1-7.895 7.895H47.893a7.88 7.88 0 0 1-7.895-7.895V50.635a7.88 7.88 0 0 1 7.895-7.895"})),pc||(pc=i.createElement("path",{fill:"#fff",fillOpacity:.298,d:"M47.893 35.109h84.211a7.88 7.88 0 0 1 7.895 7.894V53.53a7.88 7.88 0 0 1-7.895 7.895H47.893a7.88 7.88 0 0 1-7.895-7.895V43.003a7.88 7.88 0 0 1 7.895-7.894"})),gc||(gc=i.createElement("path",{fill:"#aeea00",d:"M47.893 38.003h84.211c4.374 0 7.895 2.883 7.895 6.462v15.079c0 3.58-3.521 6.462-7.895 6.462H47.893c-4.374 0-7.895-2.882-7.895-6.462V44.465c0-3.58 3.521-6.462 7.895-6.462"})),vc||(vc=i.createElement("path",{fill:"#1976d2",d:"M47.893 71.944h84.211a7.88 7.88 0 0 1 7.895 7.895v52.211a7.88 7.88 0 0 1-7.895 7.895H47.893a7.88 7.88 0 0 1-7.895-7.895V79.839a7.88 7.88 0 0 1 7.895-7.895"})),_c||(_c=i.createElement("path",{fill:"#263238",fillOpacity:.2,d:"M47.893 105.89h84.211a7.88 7.88 0 0 1 7.895 7.895v18.42a7.88 7.88 0 0 1-7.895 7.896H47.893a7.88 7.88 0 0 1-7.895-7.895v-18.421a7.88 7.88 0 0 1 7.895-7.895"})),fc||(fc=i.createElement("path",{fill:"#fff",fillOpacity:.2,d:"M47.893 71.681h84.211a7.88 7.88 0 0 1 7.895 7.895v18.421a7.88 7.88 0 0 1-7.895 7.895H47.893a7.88 7.88 0 0 1-7.895-7.895V79.576a7.88 7.88 0 0 1 7.895-7.895"})),Ec||(Ec=i.createElement("path",{fill:"#1976d2",d:"M47.893 75.102h84.211c4.374 0 7.895 3.19 7.895 7.154v47.693c0 3.963-3.521 7.153-7.895 7.153H47.893c-4.374 0-7.895-3.19-7.895-7.153V82.256c0-3.963 3.521-7.154 7.895-7.154"})),yc||(yc=i.createElement("path",{fill:"#0d47a1",d:"M89.998 89.714c-7.579 0-14 5.224-15.876 12.237h8.455a8.46 8.46 0 0 1 7.421-4.342 8.495 8.495 0 0 1 8.553 8.553 8.495 8.495 0 0 1-8.553 8.552 8.47 8.47 0 0 1-7.71-4.868h-8.3c1.69 7.279 8.242 12.763 16.01 12.763 9.038 0 16.449-7.41 16.449-16.448s-7.41-16.448-16.448-16.448z",color:"#000"})),bc||(bc=i.createElement("path",{fill:"none",stroke:"#0d47a1",strokeLinecap:"round",strokeWidth:5,d:"M115.13 106.16a25.13 25.13 0 0 1-25.132 25.132 25.13 25.13 0 0 1-25.131-25.132 25.13 25.13 0 0 1 25.131-25.132 25.13 25.13 0 0 1 25.132 25.132z"})),wc||(wc=i.createElement("path",{fill:"#263238",fillOpacity:.2,d:"M73.55 52.477a8.882 10.197 0 0 1-8.88 10.198 8.882 10.197 0 0 1-8.882-10.198 8.882 10.197 0 0 1 8.881-10.197 8.882 10.197 0 0 1 8.882 10.197z"})),Sc||(Sc=i.createElement("path",{fill:"#fff",d:"M73.55 53.793a8.88 8.88 0 0 1-8.88 8.882 8.88 8.88 0 0 1-8.882-8.882 8.88 8.88 0 0 1 8.881-8.882 8.88 8.88 0 0 1 8.882 8.882z"})),Ac||(Ac=i.createElement("path",{fill:"#263238",fillOpacity:.2,d:"M124.87 52.477a8.882 10.197 0 0 1-8.882 10.198 8.882 10.197 0 0 1-8.881-10.198 8.882 10.197 0 0 1 8.881-10.197 8.882 10.197 0 0 1 8.882 10.197"})),Cc||(Cc=i.createElement("path",{fill:"#fff",d:"M124.87 53.793a8.88 8.88 0 0 1-8.882 8.882 8.88 8.88 0 0 1-8.881-8.882 8.88 8.88 0 0 1 8.881-8.882 8.88 8.88 0 0 1 8.882 8.882"})),xc||(xc=i.createElement("path",{fill:"url(#f-droid_svg__a)",fillRule:"evenodd",d:"M33.71 22.47a3.29 3.29 0 0 0-2.662 5.336l9.474 12.262a7.9 7.9 0 0 0-.527 2.824v18.211a7.877 7.877 0 0 0 7.895 7.895h84.21a7.877 7.877 0 0 0 7.895-7.895v-18.21c0-1-.19-1.95-.525-2.827l9.472-12.26a3.29 3.29 0 0 0-2.433-5.334 3.29 3.29 0 0 0-2.772 1.31l-9.013 11.666a7.9 7.9 0 0 0-2.623-.45H47.89c-.922 0-1.8.163-2.621.45l-9.016-11.666a3.29 3.29 0 0 0-2.543-1.312m14.18 49.527a7.877 7.877 0 0 0-7.894 7.894v52.211a7.877 7.877 0 0 0 7.894 7.895h84.211a7.877 7.877 0 0 0 7.894-7.895v-52.21a7.877 7.877 0 0 0-7.894-7.895z",color:"#000"})))},Ic=(0,i.forwardRef)(Rc);var Tc,Pc,Nc,Dc,Mc,Oc,Lc,Uc,Fc,Vc,Bc,jc,Wc,zc,Hc,Kc,Jc,Gc,$c,qc,Yc,Qc;function Xc(){return Xc=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},Xc.apply(null,arguments)}var Zc=function(e,t){return i.createElement("svg",Xc({xmlns:"http://www.w3.org/2000/svg",xmlSpace:"preserve",viewBox:"0 0 180 53.332",role:"presentation","aria-hidden":!0,ref:t},e),Tc||(Tc=i.createElement("defs",null,i.createElement("linearGradient",{id:"google-play_svg__a",x2:1,gradientTransform:"scale(-31.64 31.64)rotate(45 -.903 -.925)",gradientUnits:"userSpaceOnUse"},i.createElement("stop",{offset:0,stopColor:"#00a0ff"}),i.createElement("stop",{offset:.007,stopColor:"#00a1ff"}),i.createElement("stop",{offset:.26,stopColor:"#00beff"}),i.createElement("stop",{offset:.512,stopColor:"#00d2ff"}),i.createElement("stop",{offset:.76,stopColor:"#00dfff"}),i.createElement("stop",{offset:1,stopColor:"#00e3ff"})),i.createElement("linearGradient",{id:"google-play_svg__b",x2:1,gradientTransform:"matrix(-32.255 0 0 32.255 45.098 26.675)",gradientUnits:"userSpaceOnUse"},i.createElement("stop",{offset:0,stopColor:"#ffe000"}),i.createElement("stop",{offset:.409,stopColor:"#ffbd00"}),i.createElement("stop",{offset:.775,stopColor:"orange"}),i.createElement("stop",{offset:1,stopColor:"#ff9c00"})),i.createElement("linearGradient",{id:"google-play_svg__c",x2:1,gradientTransform:"scale(-42.903 42.903)rotate(45 -1.222 -.585)",gradientUnits:"userSpaceOnUse"},i.createElement("stop",{offset:0,stopColor:"#ff3a44"}),i.createElement("stop",{offset:1,stopColor:"#c31162"})),i.createElement("linearGradient",{id:"google-play_svg__d",x2:1,gradientTransform:"scale(19.156 -19.156)rotate(-44.998 .238 -.62)",gradientUnits:"userSpaceOnUse"},i.createElement("stop",{offset:0,stopColor:"#32a071"}),i.createElement("stop",{offset:.069,stopColor:"#2da771"}),i.createElement("stop",{offset:.476,stopColor:"#15cf74"}),i.createElement("stop",{offset:.801,stopColor:"#06e775"}),i.createElement("stop",{offset:1,stopColor:"#00f076"})),i.createElement("linearGradient",{id:"google-play_svg__e",x2:1,gradientTransform:"matrix(-32.255 0 0 32.255 45.098 26.675)",gradientUnits:"userSpaceOnUse"},i.createElement("stop",{offset:0,stopColor:"#ccb300"}),i.createElement("stop",{offset:.409,stopColor:"#cc9700"}),i.createElement("stop",{offset:.775,stopColor:"#cc8400"}),i.createElement("stop",{offset:1,stopColor:"#cc7d00"})),i.createElement("linearGradient",{id:"google-play_svg__f",x2:1,gradientTransform:"scale(-42.903 42.903)rotate(45 -1.222 -.585)",gradientUnits:"userSpaceOnUse"},i.createElement("stop",{offset:0,stopColor:"#cc2e36"}),i.createElement("stop",{offset:1,stopColor:"#9c0e4e"})),i.createElement("linearGradient",{id:"google-play_svg__g",x2:1,gradientTransform:"scale(-31.64 31.64)rotate(45 -.903 -.925)",gradientUnits:"userSpaceOnUse"},i.createElement("stop",{offset:0,stopColor:"#008de0"}),i.createElement("stop",{offset:.007,stopColor:"#008de0"}),i.createElement("stop",{offset:.26,stopColor:"#00a7e0"}),i.createElement("stop",{offset:.512,stopColor:"#00b8e0"}),i.createElement("stop",{offset:.76,stopColor:"#00c4e0"}),i.createElement("stop",{offset:1,stopColor:"#00c7e0"})),i.createElement("linearGradient",{id:"google-play_svg__h",x2:1,gradientTransform:"scale(-42.903 42.903)rotate(45 -1.222 -.585)",gradientUnits:"userSpaceOnUse"},i.createElement("stop",{offset:0,stopColor:"#e0333c"}),i.createElement("stop",{offset:1,stopColor:"#ab0f56"})),i.createElement("linearGradient",{id:"google-play_svg__i",x2:1,gradientTransform:"matrix(-32.255 0 0 32.255 45.098 26.675)",gradientUnits:"userSpaceOnUse"},i.createElement("stop",{offset:0,stopColor:"#e0c500"}),i.createElement("stop",{offset:.409,stopColor:"#e0a600"}),i.createElement("stop",{offset:.775,stopColor:"#e09100"}),i.createElement("stop",{offset:1,stopColor:"#e08900"})),i.createElement("linearGradient",{id:"google-play_svg__j",x2:1,gradientTransform:"matrix(-32.255 0 0 32.255 45.098 26.675)",gradientUnits:"userSpaceOnUse"},i.createElement("stop",{offset:0,stopColor:"#ffe840"}),i.createElement("stop",{offset:.409,stopColor:"#ffce40"}),i.createElement("stop",{offset:.775,stopColor:"#ffbc40"}),i.createElement("stop",{offset:1,stopColor:"#ffb540"})),i.createElement("linearGradient",{id:"google-play_svg__k",x2:1,gradientTransform:"scale(-31.64 31.64)rotate(45 -.903 -.925)",gradientUnits:"userSpaceOnUse"},i.createElement("stop",{offset:0,stopColor:"#40b8ff"}),i.createElement("stop",{offset:.007,stopColor:"#40b9ff"}),i.createElement("stop",{offset:.26,stopColor:"#40ceff"}),i.createElement("stop",{offset:.512,stopColor:"#40ddff"}),i.createElement("stop",{offset:.76,stopColor:"#40e7ff"}),i.createElement("stop",{offset:1,stopColor:"#40eaff"})),i.createElement("linearGradient",{id:"google-play_svg__l",x2:1,gradientTransform:"scale(19.156 -19.156)rotate(-44.998 .238 -.62)",gradientUnits:"userSpaceOnUse"},i.createElement("stop",{offset:0,stopColor:"#65b895"}),i.createElement("stop",{offset:.069,stopColor:"#62bd95"}),i.createElement("stop",{offset:.476,stopColor:"#50db97"}),i.createElement("stop",{offset:.801,stopColor:"#44ed98"}),i.createElement("stop",{offset:1,stopColor:"#40f498"})))),Pc||(Pc=i.createElement("path",{d:"M173.33 53.332H6.67c-3.667 0-6.667-3-6.667-6.667V6.668c0-3.667 3-6.667 6.667-6.667h166.66c3.667 0 6.667 3 6.667 6.667v39.997c0 3.666-3 6.666-6.667 6.666"})),Nc||(Nc=i.createElement("path",{fill:"#fff",d:"M101.93 17.465v-5.118l-.044-1.544-.202.074 4.107 6.588h1.28V9.199h-1.295v4.816l.044 1.544.202-.074-3.927-6.286h-1.458v8.266"})),Dc||(Dc=i.createElement("path",{fill:"#a6a6a6",d:"M173.33 0H6.67C3.003 0 .003 3 .003 6.666v40c0 3.666 3 6.666 6.667 6.666h166.66c3.667 0 6.667-3 6.667-6.667V6.668c0-3.667-3-6.667-6.667-6.667m0 1.067c3.088 0 5.6 2.512 5.6 5.6v39.997c0 3.087-2.512 5.6-5.6 5.6H6.67a5.607 5.607 0 0 1-5.6-5.6v-40c0-3.087 2.512-5.6 5.6-5.6h166.66"})),Mc||(Mc=i.createElement("path",{fill:"#fff",d:"M63.356 13.657q0-.303-.058-.628l-.02-.11h-4.121v1.229h3.038v-.134l-.133-.011c-.058.67-.272 1.176-.632 1.537-.573.571-1.276.853-2.14.854-.81 0-1.499-.28-2.092-.85-.587-.568-.88-1.294-.881-2.212.001-.917.294-1.643.881-2.21.593-.571 1.281-.85 2.092-.851.902.002 1.582.3 2.088.901l.094.112.806-.807.086-.087-.079-.093c-.327-.39-.764-.7-1.3-.93a4.3 4.3 0 0 0-1.695-.347c-1.185-.001-2.208.416-3.038 1.24-.833.823-1.252 1.857-1.251 3.072-.001 1.215.418 2.25 1.252 3.073.829.824 1.852 1.24 3.037 1.24 1.234 0 2.258-.41 3.036-1.226l-.003.002c.691-.69 1.034-1.622 1.033-2.764M69.502 9.2h-4.937v8.265h4.937v-1.25h-3.643v-2.27h3.286v-1.227h-3.286v-2.27h3.643m4.335 0h2.234v-1.25h-5.764v1.25h2.235v7.017h1.295m7.239 0V9.199h-1.294v8.266m5.853-7.017h2.235v-1.25h-5.764v1.25h2.234v7.017h1.295m6.652-4.132c0-.903.284-1.627.85-2.203.57-.575 1.252-.858 2.078-.86.825.002 1.509.285 2.078.86.566.576.85 1.3.85 2.203s-.284 1.627-.85 2.202c-.57.576-1.253.858-2.078.86-.826-.002-1.508-.284-2.076-.86s-.852-1.3-.852-2.202m5.957 3.058c.808-.83 1.217-1.86 1.216-3.058 0-1.193-.41-2.22-1.221-3.054-.813-.837-1.83-1.26-3.024-1.259-1.2-.001-2.221.42-3.028 1.254-.81.83-1.217 1.86-1.216 3.059-.001 1.199.406 2.228 1.214 3.06s1.83 1.253 3.03 1.251c1.2.002 2.22-.419 3.029-1.253m-7.387 12.612c-3.136 0-5.693 2.384-5.693 5.67 0 3.266 2.557 5.67 5.693 5.67s5.691-2.405 5.691-5.67c0-3.287-2.555-5.67-5.691-5.67m0 2.232c1.719 0 3.2 1.397 3.2 3.438 0 2.019-1.481 3.435-3.2 3.435-1.718 0-3.201-1.416-3.201-3.435 0-2.041 1.483-3.438 3.201-3.438m-12.422-2.232c-3.136 0-5.693 2.384-5.693 5.67 0 3.266 2.557 5.67 5.693 5.67s5.693-2.405 5.693-5.67c0-3.287-2.557-5.67-5.693-5.67m0 2.232c1.718 0 3.201 1.397 3.201 3.438 0 2.019-1.483 3.435-3.201 3.435-1.719 0-3.2-1.416-3.2-3.435 0-2.041 1.481-3.438 3.2-3.438m-14.772-.494v2.407h5.757c-.172 1.353-.623 2.34-1.31 3.028-.838.838-2.148 1.762-4.447 1.762-3.544 0-6.315-2.857-6.315-6.401s2.771-6.402 6.315-6.402c1.912 0 3.308.752 4.34 1.719l1.696-1.697c-1.439-1.375-3.35-2.427-6.036-2.427-4.854 0-8.935 3.952-8.935 8.807s4.08 8.806 8.935 8.806c2.621 0 4.597-.859 6.143-2.47 1.59-1.59 2.084-3.823 2.084-5.627 0-.56-.043-1.074-.129-1.504zm55.554-1.74c-2.921 0-5.348 2.3-5.348 5.672 0 3.179 2.405 5.67 5.627 5.67 2.6 0 4.105-1.59 4.727-2.514l-1.934-1.287c-.644.946-1.525 1.566-2.793 1.566-1.267 0-2.17-.578-2.75-1.716l7.582-3.137-.256-.645c-.472-1.268-1.912-3.609-4.855-3.609m.086 2.191c.989 0 1.826.495 2.105 1.203l-5.068 2.106c-.065-2.191 1.696-3.309 2.963-3.309m-9.126 8.807h2.493V23.332h-2.492zm-7.15-10.996c-2.835 0-5.434 2.49-5.434 5.691 0 3.18 2.599 5.65 5.434 5.65 1.353 0 2.428-.602 2.986-1.29h.086v.816c0 2.17-1.16 3.33-3.03 3.33-1.524 0-2.47-1.095-2.856-2.02l-2.17.903c.624 1.504 2.278 3.352 5.027 3.352 2.921 0 5.39-1.72 5.39-5.908v-10.18h-2.36v.921h-.087c-.558-.666-1.633-1.265-2.986-1.265m.215 2.232c1.697 0 3.03 1.461 3.03 3.46 0 1.975-1.333 3.414-3.03 3.414-1.72 0-3.158-1.439-3.158-3.415 0-1.997 1.44-3.459 3.158-3.459m26.545-7.904v16.668h2.486v-6.315h3.475c2.758 0 5.469-1.997 5.469-5.177s-2.711-5.176-5.47-5.176zm2.486 2.32h3.54c1.86 0 2.915 1.54 2.915 2.858 0 1.29-1.056 2.855-2.916 2.855h-3.539zm18.914 3.321c-1.8 0-3.667.792-4.44 2.55l2.21.923c.472-.922 1.349-1.223 2.273-1.223 1.286 0 2.594.773 2.615 2.144v.172c-.45-.257-1.414-.642-2.594-.642-2.38 0-4.804 1.308-4.804 3.752 0 2.23 1.951 3.668 4.138 3.668 1.673 0 2.596-.751 3.176-1.631h.084v1.287h2.402v-6.39c0-2.96-2.208-4.61-5.06-4.61m.385 5.938c1.095 0 1.608.236 2.273.558-.193 1.544-1.52 2.639-2.957 2.639l-.002-.002c-.815 0-1.951-.405-1.951-1.414 0-1.286 1.416-1.781 2.637-1.781m13.415-5.575-2.852 7.227h-.085l-2.96-7.227h-2.68l4.438 10.1-2.53 5.619h2.596l6.84-15.719zm-22.4 10.664h2.488V23.331h-2.488z"})),Oc||(Oc=i.createElement("path",{fill:"url(#google-play_svg__a)",d:"m14.007 43.191-.099-.095c-.388-.41-.617-1.047-.617-1.873v.194V11.93v.203c0-.894.267-1.567.714-1.97l16.516 16.515-16.515 16.515m-.71-31.48v-.004.003m0-.01"})),Lc||(Lc=i.createElement("path",{fill:"url(#google-play_svg__b)",d:"m36.025 32.378.126-.071 6.522-3.706c.622-.354 1.036-.782 1.243-1.236-.206.454-.621.883-1.243 1.236l-6.522 3.706zm.002-.195-5.506-5.507 5.505-5.506 6.647 3.776c.844.48 1.318 1.098 1.397 1.73v.002c-.08.63-.553 1.248-1.397 1.728z"})),Uc||(Uc=i.createElement("path",{fill:"url(#google-play_svg__c)",d:"M15.184 43.819a1.723 1.723 0 0 0 .002 0zm0-.195c-.46 0-.863-.15-1.177-.433l16.515-16.516 5.506 5.507L16.68 43.176c-.536.304-1.043.447-1.494.447m-1.182-.241-.086-.084z"})),Fc||(Fc=i.createElement("path",{fill:"url(#google-play_svg__d)",d:"M30.52 26.676 14.004 10.16a1.72 1.72 0 0 1 1.177-.433c.452 0 .96.145 1.496.449L36.025 21.17l-5.506 5.506m5.63-5.63L16.677 9.98c-.536-.304-1.044-.448-1.496-.448h-.005.007c.451 0 .959.144 1.494.448z"})),Vc||(Vc=i.createElement("path",{d:"M15.313 43.811c.42-.024.883-.168 1.371-.445l19.353-10.995-19.353 10.994c-.487.277-.952.42-1.371.445m-1.301-.43-.004-.004zm-.09-.088-.009-.008q.005.004.009.008"})),Bc||(Bc=i.createElement("path",{fill:"url(#google-play_svg__e)",d:"m36.025 32.378.126-.071z"})),jc||(jc=i.createElement("path",{fill:"url(#google-play_svg__f)",d:"M15.185 43.819c-.461 0-.864-.15-1.178-.434l-.005-.003-.086-.084-.008-.008.099-.1c.314.284.716.434 1.177.434.451 0 .958-.144 1.494-.448l19.348-10.994.124.124-.126.072L16.677 43.37c-.488.276-.952.42-1.37.444l-.123.004"})),Wc||(Wc=i.createElement("path",{d:"M13.914 43.285c-.388-.411-.617-1.049-.617-1.874 0 .825.23 1.462.617 1.873"})),zc||(zc=i.createElement("path",{fill:"url(#google-play_svg__g)",d:"M13.908 43.29c-.388-.41-.617-1.047-.617-1.873v-.194c0 .825.23 1.462.617 1.873l.099.095z"})),Hc||(Hc=i.createElement("path",{fill:"url(#google-play_svg__h)",d:"m13.908 43.29.099-.1v.001z"})),Kc||(Kc=i.createElement("path",{fill:"url(#google-play_svg__i)",d:"m36.151 32.307-.124-.124 6.646-3.777c.844-.48 1.318-1.098 1.397-1.728q0 .349-.154.688c-.207.453-.62.882-1.243 1.235z"})),Jc||(Jc=i.createElement("path",{fill:"#404040",d:"M44.083 26.667c0-.698-.467-1.395-1.398-1.924l-6.523-3.707 6.523 3.706c.932.53 1.399 1.228 1.398 1.925"})),Gc||(Gc=i.createElement("path",{fill:"url(#google-play_svg__j)",d:"M44.07 26.675c-.08-.632-.553-1.25-1.397-1.73l-6.647-3.775.124-.124 6.523 3.706c.93.529 1.397 1.226 1.397 1.923"})),$c||($c=i.createElement("path",{fill:"#404040",d:"M13.297 11.917v-.002zm.006-.217v-.003zm0-.006v-.006zm0-.008c.077-1.37.822-2.16 1.876-2.165a1.72 1.72 0 0 0-1.166.433l-.004.003q-.049.045-.095.093c-.35.37-.57.925-.61 1.636"})),qc||(qc=i.createElement("path",{fill:"url(#google-play_svg__k)",d:"M13.291 12.132v-.204q0-.11.006-.215V11.7c.04-.71.261-1.265.61-1.635l.098.097c-.447.404-.714 1.077-.714 1.97m.712-2.16.003-.004z"})),Yc||(Yc=i.createElement("path",{fill:"#404040",d:"M15.178 9.521h.004z"})),Qc||(Qc=i.createElement("path",{fill:"url(#google-play_svg__l)",d:"M36.025 21.17 16.677 10.176c-.536-.304-1.044-.448-1.496-.448-.46 0-.863.15-1.177.432l-.097-.097a2 2 0 0 1 .095-.094l.003-.003c.312-.28.71-.43 1.166-.433h.01c.452 0 .96.144 1.496.448l19.472 11.064z"})))},ed=(0,i.forwardRef)(Zc);var td,nd,id;function sd(){return sd=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},sd.apply(null,arguments)}var od=function(e,t){return i.createElement("svg",sd({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 159.55 53.333",role:"presentation","aria-hidden":!0,ref:t},e),td||(td=i.createElement("path",{fill:"#b2b1b1",d:"M146.84.001H12.71c-.489 0-.972 0-1.46.003-.407.002-.812.01-1.224.016-.888.023-1.786.077-2.672.236a8.9 8.9 0 0 0-2.535.836A8.58 8.58 0 0 0 1.09 4.825a8.8 8.8 0 0 0-.833 2.538c-.16.883-.216 1.776-.24 2.669-.012.409-.013.82-.02 1.228v30.818c.007.414.008.815.02 1.23.024.893.08 1.786.24 2.669.155.893.418 1.73.833 2.539a8.3 8.3 0 0 0 1.571 2.152 8.4 8.4 0 0 0 2.158 1.571 9 9 0 0 0 2.535.842c.886.158 1.784.21 2.672.235.412.01.817.015 1.225.015.488.002.97.002 1.46.002h134.13c.48 0 .966 0 1.445-.002.408 0 .824-.006 1.23-.015.894-.025 1.79-.077 2.667-.235a9 9 0 0 0 2.544-.842 8.4 8.4 0 0 0 2.157-1.57 8.6 8.6 0 0 0 1.573-2.153c.41-.809.676-1.646.826-2.54.165-.882.216-1.775.249-2.669.004-.414.004-.815.004-1.229.01-.484.01-.966.01-1.458V12.715c0-.488 0-.972-.01-1.455q.001-.615-.004-1.228c-.033-.893-.084-1.786-.25-2.67a8.8 8.8 0 0 0-.825-2.537 8.6 8.6 0 0 0-1.573-2.162 8.6 8.6 0 0 0-2.157-1.57 9 9 0 0 0-2.544-.837c-.877-.159-1.773-.213-2.667-.236-.406-.006-.822-.014-1.23-.016C147.807 0 147.322 0 146.84 0"})),nd||(nd=i.createElement("path",{fill:"#040403",d:"M11.267 52.166c-.407 0-.803-.005-1.206-.014-.745-.021-1.63-.062-2.492-.217a7.9 7.9 0 0 1-2.21-.731 7.2 7.2 0 0 1-1.862-1.355 7.1 7.1 0 0 1-1.36-1.862 7.6 7.6 0 0 1-.724-2.21c-.163-.897-.205-1.807-.222-2.5-.01-.28-.02-1.217-.02-1.217v-30.8s.012-.922.02-1.193c.017-.698.059-1.607.22-2.495.143-.818.38-1.54.725-2.216.354-.7.808-1.325 1.353-1.864a7.4 7.4 0 0 1 1.87-1.363 7.8 7.8 0 0 1 2.204-.726c.898-.16 1.808-.2 2.5-.219l1.204-.016h137.02l1.217.017c.684.017 1.595.057 2.48.217.802.14 1.53.38 2.227.73.684.35 1.31.808 1.855 1.354a7.4 7.4 0 0 1 1.365 1.873c.344.681.577 1.403.715 2.198.153.841.2 1.705.23 2.517.004.377.004.783.004 1.187.012.5.012.975.012 1.455V40.62c0 .485 0 .957-.012 1.434 0 .434 0 .831-.005 1.24-.028.785-.076 1.648-.228 2.47a7.7 7.7 0 0 1-.72 2.228 7.3 7.3 0 0 1-1.353 1.847 7.3 7.3 0 0 1-1.866 1.363 7.9 7.9 0 0 1-2.225.733c-.853.155-1.737.197-2.492.218-.39.009-.8.014-1.197.014l-1.445.003-135.58-.003"})),id||(id=i.createElement("path",{fill:"#fff",d:"M33.032 27.068c-.034-3.668 3.002-5.452 3.141-5.536-1.72-2.507-4.385-2.85-5.321-2.877-2.239-.235-4.41 1.34-5.551 1.34-1.162 0-2.92-1.317-4.81-1.278-2.436.038-4.715 1.448-5.964 3.638-2.579 4.464-.656 11.026 1.814 14.633 1.236 1.769 2.68 3.742 4.57 3.672 1.85-.077 2.54-1.18 4.773-1.18 2.212 0 2.86 1.18 4.788 1.135 1.984-.032 3.235-1.775 4.427-3.559 1.428-2.026 2.002-4.02 2.024-4.123-.046-.016-3.854-1.469-3.891-5.865m-3.643-10.786c.994-1.244 1.675-2.936 1.486-4.654-1.44.064-3.24.995-4.276 2.213-.918 1.072-1.738 2.83-1.526 4.481 1.618.12 3.278-.816 4.316-2.04m21.362 17.839h5.002l-2.466-7.261h-.068zm5.658 2.066h-6.312l-1.515 4.475h-2.673l5.977-16.557h2.778l5.977 16.557h-2.718zm14.596-1.56c0-2.444-1.263-4.05-3.19-4.05-1.893 0-3.166 1.64-3.166 4.05 0 2.432 1.273 4.061 3.166 4.061 1.927 0 3.19-1.595 3.19-4.061m2.547 0c0 3.751-2.008 6.161-5.038 6.161-1.72 0-3.086-.77-3.798-2.112h-.057v5.98h-2.478V28.591h2.398v2.007h.046c.689-1.295 2.157-2.134 3.844-2.134 3.063 0 5.083 2.422 5.083 6.162m10.738.001c0-2.444-1.263-4.05-3.19-4.05-1.893 0-3.166 1.64-3.166 4.05 0 2.432 1.273 4.061 3.166 4.061 1.927 0 3.19-1.595 3.19-4.061m2.547 0c0 3.751-2.008 6.161-5.038 6.161-1.72 0-3.086-.77-3.798-2.112h-.057v5.98h-2.478V28.591h2.398v2.007h.046c.689-1.295 2.157-2.134 3.844-2.134 3.063 0 5.083 2.422 5.083 6.162m8.78 1.422c.184 1.642 1.78 2.72 3.96 2.72 2.088 0 3.59-1.078 3.59-2.558 0-1.285-.906-2.055-3.052-2.582l-2.146-.517c-3.04-.735-4.451-2.157-4.451-4.463 0-2.857 2.489-4.82 6.024-4.82 3.499 0 5.897 1.963 5.978 4.82h-2.501c-.15-1.653-1.516-2.65-3.512-2.65s-3.362 1.01-3.362 2.477c0 1.171.873 1.86 3.007 2.387l1.824.448c3.397.804 4.808 2.168 4.808 4.59 0 3.097-2.467 5.038-6.392 5.038-3.671 0-6.15-1.895-6.31-4.89zm15.514-10.314v2.857h2.296v1.962h-2.296v6.655c0 1.034.46 1.515 1.469 1.515.253 0 .655-.035.815-.057v1.95c-.274.07-.826.115-1.376.115-2.444 0-3.397-.918-3.397-3.26v-6.918h-1.755V28.59h1.755v-2.857h2.49m12.551 8.894c0-2.605-1.194-4.143-3.202-4.143s-3.2 1.55-3.2 4.143c0 2.616 1.193 4.142 3.2 4.142s3.202-1.526 3.202-4.142m-8.927 0c0-3.798 2.237-6.184 5.725-6.184 3.5 0 5.727 2.386 5.727 6.184 0 3.809-2.215 6.185-5.727 6.185-3.51 0-5.725-2.376-5.725-6.185m13.495-6.036h2.363v2.055h.058c.378-1.367 1.48-2.182 2.903-2.182.356 0 .653.047.85.093v2.318c-.197-.082-.633-.15-1.114-.15-1.595 0-2.582 1.079-2.582 2.777v7.16h-2.478zm9.218 4.922h6.035c-.058-1.847-1.239-3.064-2.96-3.064-1.71 0-2.948 1.24-3.075 3.064m8.376 3.603c-.333 2.192-2.467 3.696-5.197 3.696-3.512 0-5.692-2.353-5.692-6.128 0-3.786 2.192-6.242 5.588-6.242 3.34 0 5.44 2.294 5.44 5.954v.85h-8.527v.15c0 2.064 1.298 3.418 3.248 3.418 1.376 0 2.456-.654 2.788-1.698zM48.803 18.473h1.5c1.664 0 2.623-1.037 2.623-2.862 0-1.797-.975-2.845-2.623-2.845h-1.5zm1.638-6.831c2.36 0 3.744 1.45 3.744 3.953 0 2.542-1.374 4.003-3.744 4.003h-2.873v-7.956zm9.583 4.951c0-1.301-.584-2.062-1.61-2.062-1.03 0-1.61.76-1.61 2.062 0 1.312.58 2.067 1.61 2.067 1.026 0 1.61-.76 1.61-2.067m-4.443 0c0-1.936 1.08-3.115 2.833-3.115 1.748 0 2.829 1.18 2.829 3.115 0 1.946-1.076 3.12-2.83 3.12-1.758 0-2.832-1.174-2.832-3.12m13.188 3.005H67.54l-1.24-4.422h-.095l-1.235 4.422h-1.218l-1.654-6.004h1.201l1.076 4.581h.088l1.234-4.58h1.138l1.234 4.58h.094l1.07-4.58h1.185zm3.042-6.004h1.14v.954h.089c.291-.667.888-1.07 1.791-1.07 1.34 0 2.078.805 2.078 2.233v3.887h-1.184v-3.59c0-.965-.42-1.444-1.296-1.444s-1.434.585-1.434 1.522v3.512h-1.184zm6.986-2.344h1.185v8.347h-1.185zm7.276 5.343c0-1.301-.585-2.062-1.61-2.062-1.03 0-1.61.76-1.61 2.062 0 1.312.58 2.067 1.61 2.067 1.025 0 1.61-.76 1.61-2.067m-4.444 0c0-1.936 1.08-3.115 2.833-3.115 1.749 0 2.83 1.18 2.83 3.115 0 1.946-1.076 3.12-2.83 3.12-1.758 0-2.833-1.174-2.833-3.12m10.769.794v-.501l-1.466.093c-.827.056-1.202.337-1.202.866 0 .54.47.855 1.113.855.894 0 1.555-.569 1.555-1.313m-3.86.513c0-1.08.805-1.703 2.234-1.792l1.626-.094v-.518c0-.634-.42-.992-1.23-.992-.66 0-1.119.243-1.25.667h-1.147c.12-1.031 1.09-1.693 2.453-1.693 1.505 0 2.354.75 2.354 2.018v4.102h-1.14v-.844h-.095c-.357.601-1.014.943-1.803.943-1.158 0-2.001-.7-2.001-1.797m7.82-1.307c0 1.273.6 2.04 1.604 2.04 1 0 1.617-.778 1.617-2.035 0-1.251-.624-2.04-1.617-2.04-.997 0-1.604.772-1.604 2.035m-1.224 0c0-1.897.976-3.1 2.492-3.1.822 0 1.516.392 1.842 1.054h.088V11.25h1.185v8.347h-1.135v-.948h-.094c-.358.656-1.058 1.047-1.886 1.047-1.527 0-2.492-1.201-2.492-3.103m14.953 0c0-1.301-.584-2.062-1.61-2.062-1.03 0-1.61.76-1.61 2.062 0 1.312.58 2.067 1.61 2.067 1.026 0 1.61-.76 1.61-2.067m-4.443 0c0-1.936 1.08-3.115 2.833-3.115 1.748 0 2.829 1.18 2.829 3.115 0 1.946-1.076 3.12-2.83 3.12-1.757 0-2.832-1.174-2.832-3.12m7.252-2.999h1.141v.954h.089c.291-.667.888-1.07 1.791-1.07 1.34 0 2.078.805 2.078 2.233v3.887h-1.184v-3.59c0-.965-.42-1.444-1.296-1.444s-1.434.585-1.434 1.522v3.512h-1.184zm11.793-1.494v1.521h1.3v.999h-1.3v3.087c0 .629.258.904.849.904.182 0 .286-.011.451-.027v.987c-.193.032-.414.06-.644.06-1.318 0-1.843-.464-1.843-1.621v-3.39h-.953v-.999h.953V12.1zm2.919-.85h1.175v3.308h.094c.291-.673.925-1.075 1.83-1.075 1.279 0 2.068.81 2.068 2.238v3.876h-1.186v-3.583c0-.96-.447-1.445-1.284-1.445-.972 0-1.512.612-1.512 1.522v3.506h-1.185zm7.914 4.792h3.033c-.028-.943-.601-1.555-1.479-1.555-.876 0-1.488.617-1.554 1.555m4.168 1.935c-.27 1.075-1.23 1.737-2.602 1.737-1.72 0-2.773-1.18-2.773-3.1 0-1.918 1.076-3.136 2.768-3.136 1.67 0 2.679 1.142 2.679 3.026v.414h-4.24v.067c.04 1.052.652 1.72 1.598 1.72.719 0 1.21-.26 1.43-.728z"})))},rd=(0,i.forwardRef)(od);var ad=n("./src/components/views/elements/QRCode.tsx");const ld=({onFinished:e})=>{const t=c.Ay.get("brand"),n=c.Ay.getObject("desktop_builds"),s=c.Ay.getObject("mobile_builds"),o=null==s?void 0:s.get("ios"),r=null==s?void 0:s.get("android"),a=null==s?void 0:s.get("fdroid"),d=null!=r?r:a;return i.createElement(J.A,{title:(0,l._t)("onboarding|download_brand",{brand:t}),className:"mx_AppDownloadDialog",fixedWidth:!0,onFinished:e},(null==n?void 0:n.get("available"))&&i.createElement("div",{className:"mx_AppDownloadDialog_desktop"},i.createElement(Ql.A,{size:"3"},(0,l._t)("onboarding|download_brand_desktop",{brand:t})),i.createElement(ie.A,{kind:"primary",element:"a",href:null==n?void 0:n.get("url"),target:"_blank",onClick:()=>{}},(0,l._t)("onboarding|download_brand_desktop",{brand:t}))),i.createElement("div",{className:"mx_AppDownloadDialog_mobile"},o&&i.createElement("div",{className:"mx_AppDownloadDialog_app"},i.createElement(Ql.A,{size:"3"},(0,l._t)("common|ios")),i.createElement(ad.A,{data:o,margin:0,width:172}),i.createElement("div",{className:"mx_AppDownloadDialog_info"},(0,l._t)("onboarding|qr_or_app_links",{appLinks:"",qrCode:""})),i.createElement("div",{className:"mx_AppDownloadDialog_links"},i.createElement(ie.A,{element:"a",href:o,target:"_blank","aria-label":(0,l._t)("onboarding|download_app_store"),onClick:()=>{}},i.createElement(rd,null)))),d&&i.createElement("div",{className:"mx_AppDownloadDialog_app"},i.createElement(Ql.A,{size:"3"},(0,l._t)("common|android")),i.createElement(ad.A,{data:d,margin:0,width:172}),i.createElement("div",{className:"mx_AppDownloadDialog_info"},(0,l._t)("onboarding|qr_or_app_links",{appLinks:"",qrCode:""})),i.createElement("div",{className:"mx_AppDownloadDialog_links"},r&&i.createElement(ie.A,{element:"a",href:r,target:"_blank","aria-label":(0,l._t)("onboarding|download_google_play"),onClick:()=>{}},i.createElement(ed,null)),a&&i.createElement(ie.A,{element:"a",href:a,target:"_blank","aria-label":(0,l._t)("onboarding|download_f_droid"),onClick:()=>{}},i.createElement(Ic,null))))),i.createElement("div",{className:"mx_AppDownloadDialog_legal"},i.createElement("p",null,(0,l._t)("onboarding|apple_trademarks")),i.createElement("p",null,(0,l._t)("onboarding|google_trademarks"))))};let cd=function(e){return e.PersonalMessaging="PersonalMessaging",e.WorkMessaging="WorkMessaging",e.CommunityMessaging="CommunityMessaging",e.Skip="Skip",e}({});function dd(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function md(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?dd(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):dd(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const ud=e=>{Mn.A.trackInteraction("WebUserOnboardingTaskSendDm",e),S.A.dispatch({action:"view_create_chat"})},hd=[{id:"create-account",title:(0,l._t)("auth|create_account_title"),description:(0,l._t)("onboarding|you_made_it"),completed:()=>!0},{id:"find-friends",title:(0,l._t)("onboarding|find_friends"),description:(0,l._t)("onboarding|find_friends_description"),completed:e=>e.hasDmRooms,relevant:[cd.PersonalMessaging,cd.Skip],action:{label:(0,l._t)("onboarding|find_friends_action"),onClick:ud}},{id:"find-coworkers",title:(0,l._t)("onboarding|find_coworkers"),description:(0,l._t)("onboarding|get_stuff_done"),completed:e=>e.hasDmRooms,relevant:[cd.WorkMessaging],action:{label:(0,l._t)("onboarding|find_people"),onClick:ud}},{id:"find-community-members",title:(0,l._t)("onboarding|find_community_members"),description:(0,l._t)("onboarding|get_stuff_done"),completed:e=>e.hasDmRooms,relevant:[cd.CommunityMessaging],action:{label:(0,l._t)("onboarding|find_people"),onClick:ud}},{id:"download-apps",title:()=>(0,l._t)("onboarding|download_app",{brand:c.Ay.get("brand")}),description:()=>(0,l._t)("onboarding|download_app_description",{brand:c.Ay.get("brand")}),completed:e=>e.hasDevices,action:{label:(0,l._t)("onboarding|download_app_action"),onClick:e=>{Mn.A.trackInteraction("WebUserOnboardingTaskDownloadApps",e),k.Ay.createDialog(ld,{},"mx_AppDownloadDialog_wrapper",!1,!0)}},disabled:()=>!(()=>{const e=c.Ay.getObject("desktop_builds"),t=c.Ay.getObject("mobile_builds");return!!(null!=e&&e.get("available")||null!=t&&t.get("ios")||null!=t&&t.get("android")||null!=t&&t.get("fdroid"))})()},{id:"setup-profile",title:(0,l._t)("onboarding|set_up_profile"),description:(0,l._t)("onboarding|set_up_profile_description"),completed:e=>e.hasAvatar,action:{label:(0,l._t)("onboarding|set_up_profile_action"),onClick:e=>{Mn.A.trackInteraction("WebUserOnboardingTaskSetupProfile",e),S.A.dispatch({action:W.r.ViewUserSettings,initialTabId:Na.v.Account})}}},{id:"permission-notifications",title:(0,l._t)("onboarding|enable_notifications"),description:(0,l._t)("onboarding|enable_notifications_description"),completed:e=>!e.showNotificationsPrompt,action:{label:(0,l._t)("onboarding|enable_notifications_action"),onClick:e=>{Mn.A.trackInteraction("WebUserOnboardingTaskEnableNotifications",e),S.A.dispatch({action:W.r.ViewUserSettings,initialTabId:Na.v.Notifications}),b.Notifier.setPromptHidden(!0)},hideOnComplete:!b.Notifier.isPossible()}}];function pd(e){var t;const n=null!==(t=(0,pt.ti)("FTUE.useCaseSelection"))&&void 0!==t?t:cd.Skip;return(0,i.useMemo)((()=>hd.filter((e=>{var t;return(null===(t=e.disabled)||void 0===t||!t.call(e))&&(!e.relevant||e.relevant.includes(n))})).map((t=>md(md({},t),{},{completed:t.completed(e)})))),[e,n])}var gd=n("./node_modules/sanitize-html/index.js"),vd=n.n(gd);class _d extends i.PureComponent{constructor(e,t){super(e,t),(0,v.A)(this,"unmounted",!1),(0,v.A)(this,"dispatcherRef",void 0),(0,v.A)(this,"onAction",(e=>{"client_started"===e.action&&this.forceUpdate()})),this.state={page:""}}translate(e){return vd()((0,l._t)(e))}async fetchEmbed(){let e;try{e=await fetch(this.props.url,{method:"GET"})}catch(e){if(this.unmounted)return;return s.v.warn(`Error loading page: ${e}`),void this.setState({page:(0,l._t)("cant_load_page")})}if(this.unmounted)return;if(!e.ok)return s.v.warn(`Error loading page: ${e.status}`),void this.setState({page:(0,l._t)("cant_load_page")});let t=(await e.text()).replace(/_t\(['"]([\s\S]*?)['"]\)/gm,((e,t)=>this.translate(t)));this.props.replaceMap&&Object.keys(this.props.replaceMap).forEach((e=>{t=t.split(e).join(this.props.replaceMap[e])})),this.setState({page:t})}componentDidMount(){this.unmounted=!1,this.props.url&&(this.fetchEmbed(),this.dispatcherRef=S.A.register(this.onAction))}componentWillUnmount(){this.unmounted=!0,S.A.unregister(this.dispatcherRef)}render(){const e=this.context||_.J.get(),t=!e||e.isGuest(),n=this.props.className,s=dt()(n,{[`${n}_guest`]:t,[`${n}_loggedIn`]:!!e}),o=i.createElement("div",{className:`${n}_body`,dangerouslySetInnerHTML:{__html:this.state.page}});return this.props.scrollbar?i.createElement(xi.A,{className:s},o):i.createElement("div",{className:s},o)}}(0,v.A)(_d,"contextType",Hn.Ay);var fd=n("./src/hooks/useTimeout.ts"),Ed=n("./src/utils/BrowserWorkarounds.ts"),yd=n("./src/components/views/settings/AvatarSetting.tsx");const bd="52px",wd=({hasAvatar:e,hasAvatarLabel:t,noAvatarLabel:n,setAvatarUrl:s,isUserAvatar:r,children:a,onClick:l})=>{var c;const d=(0,i.useContext)(Hn.Ay),[m,u]=(0,i.useState)(!1),[h,p]=(0,i.useState)(!1),[g,v]=(0,i.useState)(!1);(0,fd.Z3)((()=>{v(!0)}),3e3),(0,fd.Z3)((()=>{v(!1)}),13e3);const _=(0,i.useRef)(null),f=e||m?t:n,{room:E}=(0,i.useContext)(jt.Ay);if(!(r||(null==E||null===(c=E.currentState)||void 0===c?void 0:c.maySendStateEvent(o.EventType.RoomAvatar,d.getSafeUserId()))))return i.createElement(i.Fragment,null,a);const y=!!f&&(h||g);return i.createElement(i.Fragment,null,i.createElement("input",{type:"file",ref:_,className:"mx_MiniAvatarUploader_input",onClick:e=>{(0,Ed.e)(e),null==l||l(e)},onChange:async e=>{u(!0);const t=(0,yd.B)(e);if(t){const{content_uri:e}=await d.uploadContent(t);await s(e)}u(!1)},accept:"image/*"}),i.createElement(Et.m,{label:f,open:y,onOpenChange:p},i.createElement(ie.A,{className:dt()("mx_MiniAvatarUploader",{mx_MiniAvatarUploader_busy:m,mx_MiniAvatarUploader_hasAvatar:e}),disabled:m,onClick:()=>{var e;null===(e=_.current)||void 0===e||e.click()}},a,i.createElement("div",{className:"mx_MiniAvatarUploader_indicator"},m?i.createElement(se.A,{w:20,h:20}):i.createElement("div",{className:"mx_MiniAvatarUploader_cameraIcon"})))))},Sd=e=>{Mn.A.trackInteraction("WebHomeCreateChatButton",e),S.A.dispatch({action:"view_create_chat"})},Ad=e=>{Mn.A.trackInteraction("WebHomeExploreRoomsButton",e),S.A.fire(W.r.ViewRoomDirectory)},Cd=e=>{Mn.A.trackInteraction("WebHomeCreateRoomButton",e),S.A.dispatch({action:"view_create_room"})},xd=e=>{var t;return{displayName:il.V.instance.displayName||e,avatarUrl:null!==(t=il.V.instance.getHttpAvatarUrl(parseInt(bd,10)))&&void 0!==t?t:void 0}},kd=()=>{const e=(0,i.useContext)(Hn.Ay),t=e.getUserId(),[n,s]=(0,i.useState)(xd(t));return(0,ci.ml)(il.V.instance,_r.H,(()=>{s(xd(t))})),i.createElement("div",null,i.createElement(wd,{hasAvatar:!!n.avatarUrl,hasAvatarLabel:(0,l._t)("onboarding|has_avatar_label"),noAvatarLabel:(0,l._t)("onboarding|no_avatar_label"),setAvatarUrl:t=>e.setAvatarUrl(t),isUserAvatar:!0,onClick:e=>Mn.A.trackInteraction("WebHomeMiniAvatarUploadButton",e)},i.createElement(os.A,{idName:t,name:n.displayName,url:n.avatarUrl,size:bd})),i.createElement("h1",null,(0,l._3)("onboarding|welcome_user",{name:n.displayName})),i.createElement("h2",null,(0,l._3)("onboarding|welcome_detail")))},Rd=({justRegistered:e=!1})=>{const t=(0,Hn.nH)(),n=c.Ay.get(),s=Xa(n,t);if(s)return i.createElement(_d,{className:"mx_HomePage",url:s,scrollbar:!0});let o;if(e||!il.V.instance.getHttpAvatarUrl(parseInt(bd,10)))o=i.createElement(kd,null);else{var r;const e=c.Ay.getObject("branding"),t=null!==(r=null==e?void 0:e.get("auth_header_logo_url"))&&void 0!==r?r:"themes/element/img/logos/element-logo.svg";o=i.createElement(i.Fragment,null,i.createElement("img",{src:t,alt:n.brand}),i.createElement("h1",null,(0,l._3)("onboarding|intro_welcome",{appName:n.brand})),i.createElement("h2",null,(0,l._3)("onboarding|intro_byline")))}return i.createElement(xi.A,{className:"mx_HomePage mx_HomePage_default",element:"main"},i.createElement("div",{className:"mx_HomePage_default_wrapper"},o,i.createElement("div",{className:"mx_HomePage_default_buttons"},i.createElement(ie.A,{onClick:Sd,className:"mx_HomePage_button_sendDm"},(0,l._3)("onboarding|send_dm")),i.createElement(ie.A,{onClick:Ad,className:"mx_HomePage_button_explore"},(0,l._3)("onboarding|explore_rooms")),i.createElement(ie.A,{onClick:Cd,className:"mx_HomePage_button_createGroup"},(0,l._3)("onboarding|create_room")))))},Id=e=>{Mn.A.trackInteraction("WebUserOnboardingHeaderSendDm",e),S.A.dispatch({action:"view_create_chat"})};function Td({useCase:e}){let t,s,o,r=(0,l._t)("onboarding|free_e2ee_messaging_unlimited_voip",{brand:c.Ay.get("brand")});switch(e){case cd.PersonalMessaging:t=(0,l._t)("onboarding|personal_messaging_title"),s=n("./res/img/user-onboarding/PersonalMessaging.png"),o=(0,l._t)("onboarding|personal_messaging_action");break;case cd.WorkMessaging:t=(0,l._t)("onboarding|work_messaging_title"),r=(0,l._t)("onboarding|free_e2ee_messaging_unlimited_voip",{brand:c.Ay.get("brand")}),s=n("./res/img/user-onboarding/WorkMessaging.png"),o=(0,l._t)("onboarding|work_messaging_action");break;case cd.CommunityMessaging:t=(0,l._t)("onboarding|community_messaging_title"),r=(0,l._t)("onboarding|community_messaging_description"),s=n("./res/img/user-onboarding/CommunityMessaging.png"),o=(0,l._t)("onboarding|community_messaging_action");break;default:t=(0,l._t)("onboarding|welcome_to_brand",{brand:c.Ay.get("brand")}),s=n("./res/img/user-onboarding/PersonalMessaging.png"),o=(0,l._t)("onboarding|personal_messaging_action")}return i.createElement("div",{className:"mx_UserOnboardingHeader"},i.createElement("div",{className:"mx_UserOnboardingHeader_content"},i.createElement(Ql.A,{size:"1"},t,i.createElement("span",{className:"mx_UserOnboardingHeader_dot"},".")),i.createElement("p",null,r),i.createElement(ie.A,{onClick:Id,kind:"primary"},o)),i.createElement("img",{className:"mx_UserOnboardingHeader_image",src:s,alt:""}))}var Pd=n("./src/components/views/elements/ProgressBar.tsx");function Nd({task:e,completed:t=!1}){var n;const s="function"==typeof e.title?e.title():e.title,o="function"==typeof e.description?e.description():e.description;return i.createElement("li",{className:dt()("mx_UserOnboardingTask",{mx_UserOnboardingTask_completed:t})},i.createElement("div",{className:"mx_UserOnboardingTask_number",role:"checkbox","aria-disabled":"true","aria-checked":t,"aria-labelledby":`mx_UserOnboardingTask_${e.id}`}),i.createElement("div",{id:`mx_UserOnboardingTask_${e.id}`,className:"mx_UserOnboardingTask_content"},i.createElement(Ql.A,{size:"4",className:"mx_UserOnboardingTask_title"},s),i.createElement("div",{className:"mx_UserOnboardingTask_description"},o)),e.action&&(!e.action.hideOnComplete||!t)&&i.createElement(ie.A,{element:"a",className:"mx_UserOnboardingTask_action",kind:"primary_outline",href:e.action.href,target:"_blank",onClick:null!==(n=e.action.onClick)&&void 0!==n?n:null},e.action.label))}function Dd({tasks:e}){const{completed:t,waiting:n,total:s}=(e=>{const t=e.filter((e=>!0===e.completed)).length,n=e.filter((e=>!1===e.completed)).length;return{completed:t,waiting:n,total:t+n}})(e);return i.createElement("div",{className:"mx_UserOnboardingList"},i.createElement("div",{className:"mx_UserOnboardingList_header"},i.createElement(Ql.A,{size:"3",className:"mx_UserOnboardingList_title"},n>0?(0,l._t)("onboarding|only_n_steps_to_go",{count:n}):(0,l._t)("onboarding|you_did_it")),i.createElement("div",{className:"mx_UserOnboardingList_hint"},(0,l._t)("onboarding|complete_these",{brand:c.Ay.get("brand")}))),i.createElement("div",{className:"mx_UserOnboardingList_progress"},i.createElement(Pd.A,{value:t,max:s,animated:!0})),i.createElement("ol",{className:"mx_UserOnboardingList_list"},e.map((e=>i.createElement(Nd,{key:e.id,completed:e.completed,task:e})))))}const Md=new Date(1656633600);function Od(e){return null!==e||_.J.userRegisteredAfter(Md)}function Ld({justRegistered:e=!1}){const t=(0,Hn.nH)(),n=Xa(c.Ay.get(),t),s=(0,pt.ti)("FTUE.useCaseSelection"),r=pd(Zl()),a=function(){const e=(0,Hn.nH)();return(0,ci.dF)(e,o.ClientEvent.Sync,(()=>e.isInitialSyncComplete()))}(),[l,d]=(0,i.useState)(!1);return(0,i.useEffect)((()=>{if(a){const e=window.setTimeout((()=>{d(!0)}),2800);return()=>{clearTimeout(e)}}d(!1)}),[a,d]),Od(s)?n?i.createElement(_d,{className:"mx_HomePage",url:n,scrollbar:!0}):i.createElement(xi.A,{className:"mx_UserOnboardingPage"},i.createElement(Td,{useCase:s}),l&&i.createElement(Dd,{tasks:r})):i.createElement(Rd,{justRegistered:e})}function Ud({selected:e,minimized:t}){const n=(0,pt.ti)("FTUE.useCaseSelection");return(0,pt.ti)("FTUE.userOnboardingButton")&&!t&&Od(n)?i.createElement(Fd,{selected:e,minimized:t}):i.createElement(i.Fragment,null)}function Fd({selected:e,minimized:t}){const n=(0,i.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),Mn.A.trackInteraction("WebRoomListUserOnboardingIgnoreButton",e),M.A.setValue("FTUE.userOnboardingButton",null,O.p.ACCOUNT,!1)}),[]),s=(0,i.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),Mn.A.trackInteraction("WebRoomListUserOnboardingButton",e),S.A.fire(W.r.ViewHomePage)}),[]);return i.createElement(ie.A,{className:dt()("mx_UserOnboardingButton",{mx_UserOnboardingButton_selected:e,mx_UserOnboardingButton_minimized:t}),onClick:s},!t&&i.createElement(i.Fragment,null,i.createElement("div",{className:"mx_UserOnboardingButton_content"},i.createElement(Ql.A,{size:"4",className:"mx_Heading_h4"},(0,l._t)("common|welcome")),i.createElement(ie.A,{className:"mx_UserOnboardingButton_close",onClick:n,"aria-label":(0,l._t)("action|dismiss")}))))}var Vd=function(e){return e[e.Disabled=0]="Disabled",e[e.Legacy=1]="Legacy",e}(Vd||{});class Bd extends i.Component{constructor(e){super(e),(0,v.A)(this,"listContainerRef",(0,i.createRef)()),(0,v.A)(this,"roomListRef",(0,i.createRef)()),(0,v.A)(this,"focusedElement",null),(0,v.A)(this,"isDoingStickyHeaders",!1),(0,v.A)(this,"updateActiveSpace",(e=>{this.setState({activeSpace:e})})),(0,v.A)(this,"onDialPad",(()=>{S.A.fire(W.r.OpenDialPad)})),(0,v.A)(this,"onExplore",(e=>{S.A.fire(W.r.ViewRoomDirectory),Mn.A.trackInteraction("WebLeftPanelExploreRoomsButton",e)})),(0,v.A)(this,"refreshStickyHeaders",(()=>{this.listContainerRef.current&&this.handleStickyHeaders(this.listContainerRef.current)})),(0,v.A)(this,"onBreadcrumbsUpdate",(()=>{const e=Bd.breadcrumbsMode;if(e!==this.state.showBreadcrumbs){if(this.setState({showBreadcrumbs:e}),!this.listContainerRef.current)return;this.handleStickyHeaders(this.listContainerRef.current)}})),(0,v.A)(this,"onScroll",(e=>{const t=e.target;this.handleStickyHeaders(t)})),(0,v.A)(this,"onFocus",(e=>{this.focusedElement=e.target})),(0,v.A)(this,"onBlur",(()=>{this.focusedElement=null})),(0,v.A)(this,"onKeyDown",((e,t)=>{if(!this.focusedElement)return;var n;(0,_s.zM)().getRoomListAction(e)===Pn.bY.NextRoom&&(t||(e.stopPropagation(),e.preventDefault(),null===(n=this.roomListRef.current)||void 0===n||n.focus()));const i=(0,_s.zM)().getNavigationAction(e);i!==Pn.bY.PreviousLandmark&&i!==Pn.bY.NextLandmark||(e.stopPropagation(),e.preventDefault(),Pl.r.findAndFocusNextLandmark(Pl.H.ROOM_SEARCH,i===Pn.bY.PreviousLandmark))})),this.state={activeSpace:us.Ay.instance.activeSpace,showBreadcrumbs:Bd.breadcrumbsMode}}static get breadcrumbsMode(){return Jl.Y.instance.visible?Vd.Legacy:Vd.Disabled}componentDidMount(){Jl.Y.instance.on(_r.H,this.onBreadcrumbsUpdate),Gl.Ay.instance.on(Gl.lA,this.onBreadcrumbsUpdate),us.Ay.instance.on(Xr.tw,this.updateActiveSpace),this.listContainerRef.current&&(Zr.A.instance.trackElementDimensions("ListContainer",this.listContainerRef.current),this.listContainerRef.current.addEventListener("scroll",this.onScroll,{passive:!0})),Zr.A.instance.on("ListContainer",this.refreshStickyHeaders)}componentWillUnmount(){var e;Jl.Y.instance.off(_r.H,this.onBreadcrumbsUpdate),Gl.Ay.instance.off(Gl.lA,this.onBreadcrumbsUpdate),us.Ay.instance.off(Xr.tw,this.updateActiveSpace),Zr.A.instance.stopTrackingElementDimensions("ListContainer"),Zr.A.instance.removeListener("ListContainer",this.refreshStickyHeaders),null===(e=this.listContainerRef.current)||void 0===e||e.removeEventListener("scroll",this.onScroll)}componentDidUpdate(e,t){t.activeSpace!==this.state.activeSpace&&this.refreshStickyHeaders()}handleStickyHeaders(e){this.isDoingStickyHeaders||(this.isDoingStickyHeaders=!0,window.requestAnimationFrame((()=>{this.doStickyHeaders(e),this.isDoingStickyHeaders=!1})))}doStickyHeaders(e){if(!e.parentElement)return;const t=e.scrollTop,n=e.offsetHeight+e.scrollTop,i=e.querySelectorAll(".mx_RoomSublist:not(.mx_RoomSublist_hidden)"),s=new Map;let o,r;for(const e of i){const a=e.querySelector(".mx_RoomSublist_stickable");if(!a)continue;a.style.removeProperty("display");const l=.4,c=e.offsetTop+l*Yr.u<=t,d=e.offsetTop+l*Yr.u>=n;c||e===i[0]?(s.set(a,{stickyTop:!0}),o&&(o.style.display="none",s.set(o,{makeInvisible:!0})),o=a):d&&!r?(s.set(a,{stickyBottom:!0}),r=a):s.set(a,{})}for(const t of s.keys()){const n=s.get(t);if(n.makeInvisible)t.style.display="none";else{if(n.stickyTop){t.classList.contains("mx_RoomSublist_headerContainer_stickyTop")||t.classList.add("mx_RoomSublist_headerContainer_stickyTop");const n=`${e.parentElement.offsetTop}px`;t.style.top!==n&&(t.style.top=n)}else t.classList.contains("mx_RoomSublist_headerContainer_stickyTop")&&t.classList.remove("mx_RoomSublist_headerContainer_stickyTop"),t.style.top&&t.style.removeProperty("top");if(n.stickyBottom){t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom")||t.classList.add("mx_RoomSublist_headerContainer_stickyBottom");const n=`${Zr.A.instance.windowHeight-(e.parentElement.offsetTop+e.parentElement.offsetHeight)}px`;t.style.bottom!==n&&(t.style.bottom=n)}else t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom")&&t.classList.remove("mx_RoomSublist_headerContainer_stickyBottom"),t.style.bottom&&t.style.removeProperty("bottom");if(n.stickyTop||n.stickyBottom){t.classList.contains("mx_RoomSublist_headerContainer_sticky")||t.classList.add("mx_RoomSublist_headerContainer_sticky");const e=Zr.A.instance.getElementDimensions("ListContainer");if(e){const n=15,i=`${e.width-n}px`;t.style.width!==i&&(t.style.width=i)}}else n.stickyTop||n.stickyBottom||(t.classList.contains("mx_RoomSublist_headerContainer_sticky")&&t.classList.remove("mx_RoomSublist_headerContainer_sticky"),t.style.width&&t.style.removeProperty("width"))}}const a=e.parentElement;a&&(o?a.classList.add("mx_LeftPanel_roomListWrapper_stickyTop"):a.classList.remove("mx_LeftPanel_roomListWrapper_stickyTop"),r?a.classList.add("mx_LeftPanel_roomListWrapper_stickyBottom"):a.classList.remove("mx_LeftPanel_roomListWrapper_stickyBottom"))}renderBreadcrumbs(){if(this.state.showBreadcrumbs===Vd.Legacy&&!this.props.isMinimized)return i.createElement(dl,{role:"navigation","aria-label":(0,l._t)("a11y|recent_rooms"),className:"mx_LeftPanel_breadcrumbsContainer mx_AutoHideScrollbar",verticalScrollsHorizontally:!0},i.createElement(Yl,null))}renderSearchDialExplore(){let e,t;return et.Ay.instance.getSupportsPstnProtocol()&&(e=i.createElement(ie.A,{className:dt()("mx_LeftPanel_dialPadButton",{}),onClick:this.onDialPad,title:(0,l._t)("left_panel|open_dial_pad")})),this.state.activeSpace===Xr._b.Home&&(0,ea.g)(He.C.ExploreRooms)&&(t=i.createElement(ie.A,{className:"mx_LeftPanel_exploreButton",onClick:this.onExplore,title:(0,l._t)("action|explore_rooms")})),i.createElement("div",{className:"mx_LeftPanel_filterContainer",onFocus:this.onFocus,onBlur:this.onBlur,onKeyDown:this.onKeyDown,role:"search"},i.createElement(Qr,{isMinimized:this.props.isMinimized}),e,t)}render(){const e=i.createElement(qr.A,{onKeyDown:this.onKeyDown,resizeNotifier:this.props.resizeNotifier,onFocus:this.onFocus,onBlur:this.onBlur,isMinimized:this.props.isMinimized,activeSpace:this.state.activeSpace,onResize:this.refreshStickyHeaders,onListCollapse:this.refreshStickyHeaders,ref:this.roomListRef}),t=dt()({mx_LeftPanel:!0,mx_LeftPanel_minimized:this.props.isMinimized}),n=dt()("mx_LeftPanel_actualRoomListContainer","mx_AutoHideScrollbar");return i.createElement("div",{className:t},i.createElement("div",{className:"mx_LeftPanel_roomListContainer"},(0,ea.g)(He.C.FilterContainer)&&this.renderSearchDialExplore(),this.renderBreadcrumbs(),!this.props.isMinimized&&i.createElement(Kl,{onVisibilityChange:this.refreshStickyHeaders}),i.createElement(Ud,{selected:this.props.pageType===Ir.A.HomePage,minimized:this.props.isMinimized}),i.createElement("nav",{className:"mx_LeftPanel_roomListWrapper","aria-label":(0,l._t)("common|rooms")},i.createElement("div",{className:n,ref:this.listContainerRef,tabIndex:-1},e))))}}var jd=n("./src/stores/NonUrgentToastStore.ts");class Wd extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,"onUpdateToasts",(()=>{this.setState({toasts:jd.A.instance.components})})),this.state={toasts:jd.A.instance.components}}componentDidMount(){jd.A.instance.on(_r.H,this.onUpdateToasts)}componentWillUnmount(){jd.A.instance.off(_r.H,this.onUpdateToasts)}render(){const e=this.state.toasts.map(((e,t)=>i.createElement("div",{className:"mx_NonUrgentToastContainer_toast",key:`toast-${t}`},i.createElement(e,{}))));return i.createElement("div",{className:"mx_NonUrgentToastContainer",role:"alert"},e)}}var zd=n("./node_modules/matrix-js-sdk/src/webrtc/callFeed.ts");class Hd extends i.Component{constructor(e){super(e),(0,v.A)(this,"element",(0,i.createRef)()),(0,v.A)(this,"onAudioOutputChanged",(e=>{const t=this.element.current;if(e)try{t.setSinkId(e)}catch(e){s.v.error("Couldn't set requested audio output device: using default",e),s.v.warn("Couldn't set requested audio output device: using default",e)}})),(0,v.A)(this,"onNewStream",(()=>{this.setState({audioMuted:this.props.feed.isAudioMuted()}),this.playMedia()})),this.state={audioMuted:this.props.feed.isAudioMuted()}}componentDidMount(){Lr.Ay.instance.addListener(Lr.hW.AudioOutputChanged,this.onAudioOutputChanged),this.props.feed.addListener(zd.BL.NewStream,this.onNewStream),this.playMedia()}componentWillUnmount(){Lr.Ay.instance.removeListener(Lr.hW.AudioOutputChanged,this.onAudioOutputChanged),this.props.feed.removeListener(zd.BL.NewStream,this.onNewStream),this.stopMedia()}async playMedia(){const e=this.element.current;if(e){this.onAudioOutputChanged(Lr.Ay.getAudioOutput()),e.muted=!1,e.srcObject=this.props.feed.stream,e.autoplay=!0;try{await e.load()}catch(e){s.v.info(`Failed to play media element with feed for userId ${this.props.feed.userId} with purpose ${this.props.feed.purpose}`,e)}}}stopMedia(){const e=this.element.current;e&&(e.pause(),e.removeAttribute("src"))}render(){return this.state.audioMuted?null:i.createElement("audio",{ref:this.element})}}class Kd extends i.Component{constructor(e){super(e),(0,v.A)(this,"onFeedsChanged",(()=>{this.setState({feeds:this.props.call.getRemoteFeeds()})})),this.state={feeds:this.props.call.getRemoteFeeds()}}componentDidMount(){this.props.call.addListener(ft.$E.FeedsChanged,this.onFeedsChanged)}componentWillUnmount(){this.props.call.removeListener(ft.$E.FeedsChanged,this.onFeedsChanged)}render(){return this.state.feeds.map(((e,t)=>i.createElement(Hd,{feed:e,key:t})))}}var Jd=n("./src/shouldHideEvent.ts"),Gd=n("./src/TimezoneHandler.ts"),$d=n("./src/ContentMessages.ts"),qd=n("./node_modules/re-resizable/lib/index.es5.js");class Yd extends i.Component{constructor(...e){super(...e),(0,v.A)(this,"onResizeStart",(()=>{this.props.resizeNotifier.startResizing()})),(0,v.A)(this,"onResize",(()=>{this.props.resizeNotifier.notifyRightHandleResized()})),(0,v.A)(this,"onResizeStop",((e,t,n,i)=>{const s=this.loadSidePanelSize().width+i.width;this.props.resizeNotifier.stopResizing(),window.localStorage.setItem(this.sizeSettingStorageKey,s.toString()),B.Vo.instance.trackEvent({eventName:"WebPanelResize",panel:"right",roomType:this.props.analyticsRoomType,size:s})}))}get sizeSettingStorageKey(){let e="mx_rhs_size";return this.props.sizeKey&&(e+=`_${this.props.sizeKey}`),e}loadSidePanelSize(){let e=parseInt(window.localStorage.getItem(this.sizeSettingStorageKey),10);return isNaN(e)&&(e=this.props.defaultSize),{height:"100%",width:e}}render(){const e=i.Children.only(this.props.children),t=this.props.panel;let n;return!this.props.collapsedRhs&&t&&(n=i.createElement(qd.c,{key:this.props.sizeKey,defaultSize:this.loadSidePanelSize(),minWidth:264,maxWidth:"50%",enable:{top:!1,right:!1,bottom:!1,left:!0,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},onResizeStart:this.onResizeStart,onResize:this.onResize,onResizeStop:this.onResizeStop,className:"mx_RightPanel_ResizeWrapper",handleClasses:{left:"mx_ResizeHandle--horizontal"}},t)),i.createElement("div",{className:"mx_MainSplit"},e,n)}}(0,v.A)(Yd,"defaultProps",{defaultSize:320});var Qd=n("./node_modules/@vector-im/compound-web/dist/components/Link/Link.js"),Xd=n("./node_modules/@vector-im/compound-web/dist/components/Typography/Heading.js"),Zd=n("./node_modules/@vector-im/compound-web/dist/components/Badge/Badge.js"),em=n("./node_modules/@vector-im/compound-web/dist/components/Form/Root.js"),tm=n("./node_modules/@vector-im/compound-web/dist/components/Search/Search.js"),nm=n("./node_modules/@vector-im/compound-web/dist/components/Separator/Separator.js"),im=n("./node_modules/@vector-im/compound-web/dist/components/Menu/ToggleMenuItem.js"),sm=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/favourite.js"),om=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/user-add.js"),rm=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/settings.js"),am=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/export-archive.js"),lm=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/leave.js"),cm=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/files.js"),dm=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/extensions.js"),mm=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/user-profile.js"),um=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/polls.js"),hm=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/lock-solid.js"),pm=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/lock-off.js"),gm=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/public.js"),vm=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/error.js"),_m=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/chevron-down.js"),fm=n("./src/hooks/useIsEncrypted.ts"),Em=n("./src/components/views/right_panel/BaseCard.tsx"),ym=n("./src/components/views/dialogs/ShareDialog.tsx"),bm=n("./src/utils/ShieldUtils.ts"),wm=n("./src/components/views/elements/StyledRadioGroup.tsx");let Sm=function(e){return e.Html="Html",e.PlainText="PlainText",e.Json="Json",e}({}),Am=function(e){return e.Timeline="Timeline",e.Beginning="Beginning",e.LastNMessages="LastNMessages",e}({});const Cm=e=>{switch(e){case Sm.Html:return(0,l._t)("export_chat|html");case Sm.Json:return(0,l._t)("export_chat|json");case Sm.PlainText:return(0,l._t)("export_chat|text");default:throw new Error("Unknown format")}};var xm=n("./src/components/views/elements/Validation.tsx"),km=n("./node_modules/react-dom/client.js"),Rm=n("./node_modules/react-dom/server.browser.js"),Im=n("./node_modules/escape-html/index.js"),Tm=n.n(Im),Pm=n("./node_modules/file-saver/dist/FileSaver.min.js"),Nm=n("./node_modules/sanitize-filename/index.js"),Dm=n.n(Nm),Mm=n("./src/utils/DecryptFile.ts");class Om{constructor(e,t,n,i){if((0,v.A)(this,"files",[]),(0,v.A)(this,"cancelled",!1),(0,v.A)(this,"getRelationsForEvent",((e,t,n)=>this.room.getUnfilteredTimelineSet().relations.getChildEventsForEvent(e,t,n))),this.room=e,this.exportType=t,this.exportOptions=n,this.setProgressText=i,n.maxSize<1048576||n.maxSize>8388608e3||n.numberOfMessages&&n.numberOfMessages>10**8||t===Am.LastNMessages&&!n.numberOfMessages)throw new Error("Invalid export options");window.addEventListener("beforeunload",this.onBeforeUnload)}get destinationFileName(){return this.makeFileNameNoExtension(c.Ay.get().brand)+".zip"}onBeforeUnload(e){return e.preventDefault(),e.returnValue=(0,l._t)("export_chat|unload_confirm")}updateProgress(e,t=!0,n=!0){t&&s.v.log(e),n&&this.setProgressText(e)}addFile(e,t){const n={name:e,blob:t};this.files.push(n)}makeFileNameNoExtension(e="matrix"){var t;const n=Dm()(null!==(t=this.room.name)&&void 0!==t?t:(0,l._t)("common|unnamed_room")).trim()||"Unnamed Room",i=(0,Re.td)(new Date).replace(/:/g,"-");return`${Dm()(e)} - ${n} - Chat Export - ${i}`}async downloadZIP(){const e=this.destinationFileName,t=e.substring(0,e.lastIndexOf(".")),{default:i}=await n.e(1710).then(n.t.bind(n,"./node_modules/jszip/dist/jszip.min.js",23)),s=new i;if(this.cancelled)return this.cleanUp();this.updateProgress((0,l._t)("export_chat|generating_zip"));for(const e of this.files)s.file(t+"/"+e.name,e.blob);const o=await s.generateAsync({type:"blob"});(0,Pm.saveAs)(o,t+".zip")}cleanUp(){return s.v.log("Cleaning up..."),window.removeEventListener("beforeunload",this.onBeforeUnload),""}async cancelExport(){s.v.log("Cancelling export..."),this.cancelled=!0}downloadPlainText(e,t){const n=new Blob([t],{type:"text/plain"});(0,Pm.saveAs)(n,e)}setEventMetadata(e){const t=this.room.currentState,n=e.getSender();var i;(e.sender=!!n&&(null==t?void 0:t.getSentinelMember(n))||null,"m.room.member"===e.getType())&&(e.target=null!==(i=null==t?void 0:t.getSentinelMember(e.getStateKey()))&&void 0!==i?i:null);return e}getLimit(){let e;if(this.exportType===Am.LastNMessages)e=this.exportOptions.numberOfMessages;else e=10**8;return e}async getRequiredEvents(){const e=this.room.client.getEventMapper();let t=null,n=[];if(this.exportType===Am.Timeline)n=this.room.getLiveTimeline().getEvents();else{let s=this.getLimit();for(;s;){var i;const r=Math.min(s,1e3),a=await this.room.client.createMessagesRequest(this.room.roomId,t,r,o.Direction.Backward);if(this.cancelled)return this.cleanUp(),[];if(0===a.chunk.length)break;s-=a.chunk.length;const c=a.chunk.map(e);for(const e of c)n.push(e);this.exportType===Am.LastNMessages?this.updateProgress((0,l._t)("export_chat|fetched_n_events_with_total",{count:n.length,total:this.exportOptions.numberOfMessages})):this.updateProgress((0,l._t)("export_chat|fetched_n_events",{count:n.length})),t=null!==(i=a.end)&&void 0!==i?i:null}n.reverse()}const s=n.filter((e=>e.isEncrypted())).map((e=>this.room.client.decryptEventIfNeeded(e,{emit:!1})));await Promise.all(s);for(let e=0;e<n.length;e++)this.setEventMetadata(n[e]);return n}async getMediaBlob(e){let t;try{const n=e.isEncrypted(),i=e.getContent();if(n&&i.hasOwnProperty("file")&&"m.sticker"!==e.getType())t=await(0,Mm.It)(i.file);else{const e=(0,Wn.mA)(i);if(!e.srcHttp)throw new Error("Cannot fetch without srcHttp");const n=await fetch(e.srcHttp);t=await n.blob()}}catch{s.v.log("Error decrypting media")}if(!t)throw new Error("Unable to fetch file");return t}splitFileName(e){const t=e.lastIndexOf(".");if(-1===t)return[e,""];return[e.slice(0,t),"."+e.slice(t+1)]}getFilePath(e){let t;switch(e.getContent().msgtype){case"m.image":t="images";break;case"m.video":t="videos";break;case"m.audio":t="audio";break;default:t="m.sticker"===e.getType()?"stickers":"files"}const n=(0,Re.ej)(new Date(e.getTs()));let[i,s]=this.splitFileName(e.getContent().body);return"m.sticker"===e.getType()&&(s=".png"),(0,Rt.Mp)(e)&&(s=".ogg"),t+"/"+i+"-"+n+s}isReply(e){const t=(e.isEncrypted()?e.event.content:e.getContent())["m.relates_to"];return!(!t||!t["m.in_reply_to"])}isAttachment(e){const t=["m.sticker","m.image","m.file","m.video","m.audio"];return e.getType()===t[0]||t.includes(e.getContent().msgtype)}}class Lm extends i.Component{constructor(e){super(e),(0,v.A)(this,"onMouseDown",(e=>{this.setState({location:{currentX:e.clientX,currentY:e.clientY}}),document.addEventListener("mousemove",this.state.onMouseMove),document.addEventListener("mouseup",this.state.onMouseUp)})),(0,v.A)(this,"onMouseUp",(e=>{document.removeEventListener("mousemove",this.state.onMouseMove),document.removeEventListener("mouseup",this.state.onMouseUp),this.props.onMouseUp(e)})),this.state={onMouseMove:this.onMouseMove.bind(this),onMouseUp:this.onMouseUp.bind(this),location:{currentX:0,currentY:0}}}onMouseMove(e){const t=this.props.dragFunc(this.state.location,e);this.setState({location:t})}render(){return i.createElement("div",{className:this.props.className,onMouseDown:this.onMouseDown})}}class Um extends i.Component{constructor(e){super(e),(0,v.A)(this,"dragFunc",((e,t)=>{const n=t.clientX-e.currentX,i=this.state.width+n;return i<this.props.minWidth||i>this.props.maxWidth?e:(this.setState({width:i}),this.updateCSSWidth.bind(this)(i),{currentX:t.clientX,currentY:e.currentY})})),(0,v.A)(this,"onMoueUp",(()=>{this.props.roomId&&M.A.setValue("ircDisplayNameWidth",this.props.roomId,O.p.ROOM_DEVICE,this.state.width)})),this.state={width:M.A.getValue("ircDisplayNameWidth",this.props.roomId),IRCLayoutRoot:null}}componentDidMount(){this.setState({IRCLayoutRoot:document.querySelector(".mx_IRCLayout")},(()=>this.updateCSSWidth(this.state.width)))}updateCSSWidth(e){var t;null===(t=this.state.IRCLayoutRoot)||void 0===t||t.style.setProperty("--name-width",e+"px")}render(){return i.createElement(Lm,{className:"mx_ProfileResizer",dragFunc:this.dragFunc,onMouseUp:this.onMoueUp})}}function Fm(e){return Vm(e,[e.client.getSafeUserId()].concat(e.client.getIgnoredUsers()))}function Vm(e,t=[]){const n=[],i=Object.keys(e.currentState.members);for(const s of i)e.currentState.members[s].typing&&-1===t.indexOf(s)&&n.push(e.currentState.members[s]);return n}class Bm extends i.Component{constructor(...e){var t;super(...e),(0,v.A)(this,"state",{usersTyping:(t=this.props.room,Vm(t,[t.client.getSafeUserId()])),delayedStopTypingTimers:{}}),(0,v.A)(this,"isVisible",(()=>Bm.isVisible(this.state))),(0,v.A)(this,"onRoomTimeline",((e,t)=>{if((null==t?void 0:t.roomId)===this.props.room.roomId){const t=e.getSender(),n=this.state.usersTyping.filter((e=>e.userId!==t));n.length!==this.state.usersTyping.length&&this.setState({usersTyping:n}),this.abortUserTimer(t)}})),(0,v.A)(this,"onRoomMemberTyping",(()=>{const e=Fm(this.props.room);this.setState({delayedStopTypingTimers:this.updateDelayedStopTypingTimers(e),usersTyping:e})}))}componentDidMount(){_.J.safeGet().on(o.RoomMemberEvent.Typing,this.onRoomMemberTyping),_.J.safeGet().on(o.RoomEvent.Timeline,this.onRoomTimeline)}componentDidUpdate(e,t){const n=Bm.isVisible(t),i=Bm.isVisible(this.state);this.props.onShown&&!n&&i?this.props.onShown():this.props.onHidden&&n&&!i&&this.props.onHidden()}componentWillUnmount(){const e=_.J.get();e&&(e.removeListener(o.RoomMemberEvent.Typing,this.onRoomMemberTyping),e.removeListener(o.RoomEvent.Timeline,this.onRoomTimeline)),Object.values(this.state.delayedStopTypingTimers).forEach((e=>e.abort()))}static isVisible(e){return 0!==e.usersTyping.length||0!==Object.keys(e.delayedStopTypingTimers).length}updateDelayedStopTypingTimers(e){const t=this.state.usersTyping.filter((t=>!e.some((e=>t.userId===e.userId)))),n=e.filter((e=>!this.state.usersTyping.some((t=>e.userId===t.userId))));n.forEach((e=>{const t=this.state.delayedStopTypingTimers[e.userId];t&&t.abort()}));let i=Object.assign({},this.state.delayedStopTypingTimers);return i=n.reduce(((e,t)=>(delete e[t.userId],e)),i),i=t.reduce(((e,t)=>{if(!e[t.userId]){const n=new A.A(5e3);e[t.userId]=n,n.start(),n.finished().then((()=>this.removeUserTimer(t.userId)),(()=>{}))}return e}),i),i}abortUserTimer(e){const t=this.state.delayedStopTypingTimers[e];t&&(t.abort(),this.removeUserTimer(e))}removeUserTimer(e){if(this.state.delayedStopTypingTimers[e]){const t=Object.assign({},this.state.delayedStopTypingTimers);delete t[e],this.setState({delayedStopTypingTimers:t})}}renderTypingIndicatorAvatars(e,t){let n=0;e.length>t&&(n=e.length-t+1,e=e.slice(0,t-1));const s=e.map((e=>i.createElement(Mt.A,{key:e.userId,member:e,size:"24px",resizeMethod:"crop",viewUserOnClick:!0,"aria-live":"off"})));return n>0&&s.push(i.createElement("span",{className:"mx_WhoIsTypingTile_remainingAvatarPlaceholder",key:"others"},"+",n)),s}render(){const e=[...this.state.usersTyping];for(const t in this.state.delayedStopTypingTimers){const n=this.props.room.getMember(t);n&&e.push(n)}const t=new Intl.Collator;e.sort(((e,n)=>t.compare(e.name,n.name)));const n=function(e,t){let n=0;if(e.length>t&&(n=e.length-t+1),0===e.length)return"";if(1===e.length)return(0,l._t)("timeline|typing_indicator|one_user",{displayName:e[0].name});const i=e.map((e=>e.name));if(n>=1)return(0,l._t)("timeline|typing_indicator|more_users",{names:i.slice(0,t-1).join(", "),count:n});{const e=i.pop();return(0,l._t)("timeline|typing_indicator|two_users",{names:i.join(", "),lastPerson:e})}}(e,this.props.whoIsTypingLimit);return n?i.createElement("li",{className:"mx_WhoIsTypingTile","aria-atomic":"true"},i.createElement("div",{className:"mx_WhoIsTypingTile_avatars"},this.renderTypingIndicatorAvatars(e,this.props.whoIsTypingLimit)),i.createElement("div",{className:"mx_WhoIsTypingTile_label"},n)):null}}(0,v.A)(Bm,"defaultProps",{whoIsTypingLimit:3});var jm=n("./src/components/structures/ScrollPanel.tsx"),Wm=n("./src/components/views/messages/DateSeparator.tsx"),zm=n("./src/components/views/messages/TimelineSeparator.tsx"),Hm=n("./src/components/views/elements/ErrorBoundary.tsx"),Km=n("./src/Editing.ts");class Jm{constructor(e,t,n,i,s,o){(0,v.A)(this,"events",[]),(0,v.A)(this,"ejectedEvents",[]),(0,v.A)(this,"readMarker",void 0),this.panel=e,this.firstEventAndShouldShow=t,this.prevEvent=n,this.lastShownEvent=i,this.nextEvent=s,this.nextEventTile=o,this.readMarker=e.readMarkerForEvent(t.event.getId(),t.event===i)}}(0,v.A)(Jm,"canStartGroup",((e,t)=>!0));var Gm=n("./src/TextForEvent.tsx"),$m=n("./src/components/views/messages/EventTileBubble.tsx");const qm=()=>{var e;const{room:t}=(0,i.useContext)(jt.Ay),n=null==t?void 0:t.getLiveTimeline().getState(o.EventTimeline.BACKWARDS),s=null==n||null===(e=n.getStateEvents("m.room.history_visibility")[0])||void 0===e?void 0:e.getContent().history_visibility;let r;return"invited"==s?r=(0,l._t)("timeline|no_permission_messages_before_invite"):"joined"==s&&(r=(0,l._t)("timeline|no_permission_messages_before_join")),i.createElement($m.A,{className:"mx_HistoryTile",title:(0,l._t)("timeline|historical_messages_unavailable"),subtitle:r})},Ym=({events:e,children:t,threshold:n=3,onToggle:o,startExpanded:r=!1,summaryMembers:a=[],summaryText:c,layout:d=gt.P.Group})=>{const[m,u]=(0,Ys.X)(r);(0,i.useEffect)((()=>{o&&o()}),[m]);const h=e.map((e=>e.getId())).join(",");if(e.length<n)return i.createElement("li",{className:"mx_GenericEventListSummary","data-scroll-tokens":h,"data-expanded":!0,"data-layout":d},i.createElement("ol",{className:"mx_GenericEventListSummary_unstyledList"},t));let p;if(m)p=i.createElement(i.Fragment,null,i.createElement("div",{className:"mx_GenericEventListSummary_spacer"}," "),i.createElement("ol",{className:"mx_GenericEventListSummary_unstyledList"},t));else{const e=(0,Vn.uniqBy)(a.filter((e=>!(null==e||!e.getMxcAvatarUrl)||(s.v.error("EventListSummary given null summaryMember, termites may be afoot eating event senders",a),!1))),(e=>e.getMxcAvatarUrl())).map((e=>i.createElement(Mt.A,{key:e.userId,member:e,size:"14px"})));p=i.createElement("div",{className:"mx_EventTile_line"},i.createElement("div",{className:"mx_EventTile_info"},i.createElement("span",{className:"mx_GenericEventListSummary_avatars",onClick:u},e),i.createElement("span",{className:"mx_TextualEvent mx_GenericEventListSummary_summary"},c)))}return i.createElement("li",{className:"mx_GenericEventListSummary","data-scroll-tokens":h,"data-expanded":m+"","data-layout":d},i.createElement(ie.A,{kind:"link_inline",className:"mx_GenericEventListSummary_toggle",onClick:u,"aria-expanded":m},m?(0,l._t)("action|collapse"):(0,l._t)("action|expand")),p)};var Qm=n("./src/utils/ReactUtils.tsx");const Xm=()=>{_l.A.instance.setCard({phase:fl.n.PinnedMessages},!1)},Zm=[o.EventType.RoomMember];var eu=function(e){return e.Joined="joined",e.Left="left",e.JoinedAndLeft="joined_and_left",e.LeftAndJoined="left_and_joined",e.InviteReject="invite_reject",e.InviteWithdrawal="invite_withdrawal",e.Invited="invited",e.Banned="banned",e.Unbanned="unbanned",e.Kicked="kicked",e.ChangedName="changed_name",e.ChangedAvatar="changed_avatar",e.NoChange="no_change",e.ServerAcl="server_acl",e.ChangedPins="pinned_messages",e.MessageRemoved="message_removed",e.HiddenEvent="hidden_event",e}(eu||{});class tu extends i.Component{shouldComponentUpdate(e){return e.events.length!==this.props.events.length||e.events.length<this.props.threshold||e.layout!==this.props.layout}generateSummary(e,t){const n=t.map((t=>{const n=e[t],i=this.renderNameList(n),s=t.split(","),o=tu.getCanonicalTransitions(s),r=tu.coalesceRepeatedTransitions(o).map((e=>tu.getDescriptionForTransition(e.transitionType,n.length,e.repeats))),a=(0,bt.ki)(r);return(0,l._t)("timeline|summary|format",{nameList:i,transitionList:a})}));return n?(0,Qm.i)(n,", "):null}renderNameList(e){return(0,bt.ki)(e,this.props.summaryLength)}static getCanonicalTransitions(e){const t={[eu.Joined]:{after:eu.Left,newTransition:eu.JoinedAndLeft},[eu.Left]:{after:eu.Joined,newTransition:eu.LeftAndJoined}},n=[];for(let i=0;i<e.length;i++){const s=e[i],o=e[i+1];let r=s;i<e.length-1&&t[s]&&t[s].after===o&&(r=t[s].newTransition,i++),n.push(r)}return n}static coalesceRepeatedTransitions(e){const t=[];for(const n of e)t.length>0&&t[t.length-1].transitionType===n?t[t.length-1].repeats+=1:t.push({transitionType:n,repeats:1});return t}static getDescriptionForTransition(e,t,n){var s;let o;switch(e){case eu.Joined:o=t>1?(0,l._t)("timeline|summary|joined_multiple",{severalUsers:"",count:n}):(0,l._t)("timeline|summary|joined",{oneUser:"",count:n});break;case eu.Left:o=t>1?(0,l._t)("timeline|summary|left_multiple",{severalUsers:"",count:n}):(0,l._t)("timeline|summary|left",{oneUser:"",count:n});break;case eu.JoinedAndLeft:o=t>1?(0,l._t)("timeline|summary|joined_and_left_multiple",{severalUsers:"",count:n}):(0,l._t)("timeline|summary|joined_and_left",{oneUser:"",count:n});break;case eu.LeftAndJoined:o=t>1?(0,l._t)("timeline|summary|rejoined_multiple",{severalUsers:"",count:n}):(0,l._t)("timeline|summary|rejoined",{oneUser:"",count:n});break;case eu.InviteReject:o=t>1?(0,l._t)("timeline|summary|rejected_invite_multiple",{severalUsers:"",count:n}):(0,l._t)("timeline|summary|rejected_invite",{oneUser:"",count:n});break;case eu.InviteWithdrawal:o=t>1?(0,l._t)("timeline|summary|invite_withdrawn_multiple",{severalUsers:"",count:n}):(0,l._t)("timeline|summary|invite_withdrawn",{oneUser:"",count:n});break;case eu.Invited:o=t>1?(0,l._t)("timeline|summary|invited_multiple",{count:n}):(0,l._t)("timeline|summary|invited",{count:n});break;case eu.Banned:o=t>1?(0,l._t)("timeline|summary|banned_multiple",{count:n}):(0,l._t)("timeline|summary|banned",{count:n});break;case eu.Unbanned:o=t>1?(0,l._t)("timeline|summary|unbanned_multiple",{count:n}):(0,l._t)("timeline|summary|unbanned",{count:n});break;case eu.Kicked:o=t>1?(0,l._t)("timeline|summary|kicked_multiple",{count:n}):(0,l._t)("timeline|summary|kicked",{count:n});break;case eu.ChangedName:o=t>1?(0,l._t)("timeline|summary|changed_name_multiple",{severalUsers:"",count:n}):(0,l._t)("timeline|summary|changed_name",{oneUser:"",count:n});break;case eu.ChangedAvatar:o=t>1?(0,l._t)("timeline|summary|changed_avatar_multiple",{severalUsers:"",count:n}):(0,l._t)("timeline|summary|changed_avatar",{oneUser:"",count:n});break;case eu.NoChange:o=t>1?(0,l._t)("timeline|summary|no_change_multiple",{severalUsers:"",count:n}):(0,l._t)("timeline|summary|no_change",{oneUser:"",count:n});break;case eu.ServerAcl:o=t>1?(0,l._t)("timeline|summary|server_acls_multiple",{severalUsers:"",count:n}):(0,l._t)("timeline|summary|server_acls",{oneUser:"",count:n});break;case eu.ChangedPins:o=t>1?(0,l._t)("timeline|summary|pinned_events_multiple",{severalUsers:"",count:n},{a:e=>i.createElement(ie.A,{kind:"link_inline",onClick:Xm},e)}):(0,l._t)("timeline|summary|pinned_events",{oneUser:"",count:n},{a:e=>i.createElement(ie.A,{kind:"link_inline",onClick:Xm},e)});break;case eu.MessageRemoved:o=t>1?(0,l._t)("timeline|summary|redacted_multiple",{severalUsers:"",count:n}):(0,l._t)("timeline|summary|redacted",{oneUser:"",count:n});break;case eu.HiddenEvent:o=t>1?(0,l._t)("timeline|summary|hidden_event_multiple",{severalUsers:"",count:n}):(0,l._t)("timeline|summary|hidden_event",{oneUser:"",count:n})}return null!==(s=o)&&void 0!==s?s:null}static getTransitionSequence(e){return e.map(tu.getTransition)}static getTransition(e){if(e.mxEvent.isRedacted())return eu.MessageRemoved;switch(e.mxEvent.getType()){case o.EventType.RoomThirdPartyInvite:return(0,pr.Qo)(e.mxEvent)?eu.Invited:eu.InviteWithdrawal;case o.EventType.RoomServerAcl:return eu.ServerAcl;case o.EventType.RoomPinnedEvents:return eu.ChangedPins;case o.EventType.RoomMember:switch(e.mxEvent.getContent().membership){case ut.O.Invite:return eu.Invited;case ut.O.Ban:return eu.Banned;case ut.O.Join:return e.mxEvent.getPrevContent().membership===ut.O.Join?e.mxEvent.getContent().displayname!==e.mxEvent.getPrevContent().displayname?eu.ChangedName:e.mxEvent.getContent().avatar_url!==e.mxEvent.getPrevContent().avatar_url?eu.ChangedAvatar:eu.NoChange:eu.Joined;case ut.O.Leave:if(e.mxEvent.getSender()===e.mxEvent.getStateKey())return e.mxEvent.getPrevContent().membership===ut.O.Invite?eu.InviteReject:eu.Left;switch(e.mxEvent.getPrevContent().membership){case ut.O.Invite:return eu.InviteWithdrawal;case ut.O.Ban:return eu.Unbanned;default:return eu.Kicked}default:return null}default:return eu.HiddenEvent}}getAggregate(e){const t={},n={};return Object.keys(e).forEach((i=>{const s=e[i][0],o=s.displayName,r=tu.getTransitionSequence(e[i]).join(",");t[r]||(t[r]=[],n[r]=-1),t[r].push(o),(-1===n[r]||s.index<n[r])&&(n[r]=s.index)})),{names:t,indices:n}}render(){const e=this.props.events,t=new Map,n={};e.forEach(((e,i)=>{var s;const r=e.getType();let a=e.getSender();e.isState()&&r===o.EventType.RoomThirdPartyInvite?a=e.getContent().display_name:e.isState()&&r===o.EventType.RoomMember?a=e.getStateKey():e.isRedacted()&&null!==(s=e.getUnsigned())&&void 0!==s&&s.redacted_because&&(a=e.getUnsigned().redacted_because.sender),n[a]||(n[a]=[]);let l=a;if(e.isRedacted()){var c;const e=null===(c=this.context)||void 0===c||null===(c=c.room)||void 0===c?void 0:c.getMember(a);e&&(l=e.name,t.set(a,e))}else e.target&&Zm.includes(r)?(l=e.target.name,t.set(a,e.target)):e.sender&&r!==o.EventType.RoomThirdPartyInvite&&(l=e.sender.name,t.set(a,e.sender));n[a].push({mxEvent:e,displayName:l,index:i})}));const s=this.getAggregate(n),r=Object.keys(s.names).sort(((e,t)=>s.indices[e]-s.indices[t]));return i.createElement(Ym,{events:this.props.events,threshold:this.props.threshold,onToggle:this.props.onToggle,startExpanded:this.props.startExpanded,children:this.props.children,summaryMembers:[...t.values()],layout:this.props.layout,summaryText:this.generateSummary(s.names,r)})}}(0,v.A)(tu,"contextType",jt.Ay),(0,v.A)(tu,"defaultProps",{summaryLength:1,threshold:3,avatarsMaxLength:5,layout:gt.P.Group});const nu=[o.EventType.RoomMember,o.EventType.RoomThirdPartyInvite,o.EventType.RoomServerAcl,o.EventType.RoomPinnedEvents];class iu extends Jm{constructor(e,t,n,i,s,o){super(e,t,n,i,s,o),this.panel=e,this.firstEventAndShouldShow=t,this.prevEvent=n,this.lastShownEvent=i,this.events=[t]}shouldGroup({event:e,shouldShow:t}){return!t||this.panel.wantsSeparator(this.events[0].event,e)!==zm.W.Date&&(!(!e.isState()||!nu.includes(e.getType()))||(!!e.isRedacted()||!(!this.panel.showHiddenEvents||this.panel.shouldShowEvent(e,!0))))}add(e){const{event:t,shouldShow:n}=e;(t.getType()!==o.EventType.RoomMember||(0,Gm.I3)(t,_.J.safeGet(),this.panel.showHiddenEvents))&&(this.readMarker=this.readMarker||this.panel.readMarkerForEvent(t.getId(),t===this.lastShownEvent),(this.panel.showHiddenEvents||n)&&t.getType()!==o.EventType.RoomPinnedEvents&&this.events.push(e))}generateKey(){return"eventlistsummary-"+this.events[0].event.getId()}getTiles(){var e;if(null===(e=this.events)||void 0===e||!e.length)return[];const t=this.panel,n=this.lastShownEvent,s=[];if(t.wantsSeparator(this.prevEvent,this.events[0].event)===zm.W.Date){const e=this.events[0].event.getTs();s.push(i.createElement("li",{key:e+"~"},i.createElement(Wm.A,{roomId:this.events[0].event.getRoomId(),ts:e})))}const o=this.events.find((e=>this.panel.grouperKeyMap.get(e.event))),r=o&&this.panel.grouperKeyMap.has(o.event)?this.panel.grouperKeyMap.get(o.event):this.generateKey();o||this.panel.grouperKeyMap.set(this.events[0].event,r);let a=!1,l=this.events.map(((e,i)=>(e.event.getId()===t.props.highlightedEventId&&(a=!0),t.getTilesForEvent(0===i?this.prevEvent:this.events[i-1].event,e,e.event===n,true,this.nextEvent,this.nextEventTile)))).reduce(((e,t)=>e.concat(t)),[]);return 0===l.length&&(l=null),this.panel.props.canBackPaginate||this.prevEvent||s.push(i.createElement(qm,{key:"historytile"})),s.push(i.createElement(tu,{key:r,events:this.events.map((e=>e.event)),onToggle:t.onHeightChanged,startExpanded:a,layout:this.panel.props.layout},l)),this.readMarker&&s.push(this.readMarker),s}getNewPrevEvent(){return this.events[this.events.length-1].event}}(0,v.A)(iu,"canStartGroup",(function(e,{event:t,shouldShow:n}){return!!n&&(!(!t.isState()||!nu.includes(t.getType()))||(!!t.isRedacted()||!(!e.showHiddenEvents||e.shouldShowEvent(t,!0))))}));var su=n("./src/utils/rooms.ts"),ou=n("./src/models/LocalRoom.ts");const ru=e=>{if(!(0,su.u)(e.client))return{shouldEncrypt:!1};if(!x.A.shared().getRoomIds().has(e.roomId))return{shouldEncrypt:!1};if(1!==e.getInvitedAndJoinedMemberCount())return{shouldEncrypt:!1};const t=e.currentState.getStateEvents("m.room.third_party_invite")||[];return 1===t.length?{shouldEncrypt:!0,inviteEvent:t[0]}:{shouldEncrypt:!1}};const au=()=>{var e;const t=(0,i.useContext)(Hn.Ay),{room:n,roomId:s}=(0,i.useContext)(jt.Ay);if(!n||!s)throw new Error("Unable to create a NewRoomIntro without room and roomId");const r=n instanceof ou.Np,a=r?null===(e=n.targets[0])||void 0===e?void 0:e.userId:x.A.shared().getUserIdForRoomId(s);let c;if(a){const{shouldEncrypt:e}=ru(n),t=((e,t)=>e instanceof ou.Np?(0,l.AO)("room|intro|send_message_start_dm"):t?(0,l.AO)("room|intro|encrypted_3pid_dm_pending_join"):(0,l.AO)("room|intro|start_of_dm_history"))(n,e);let s;n instanceof ou.Np||e||n.getJoinedMemberCount()+n.getInvitedMemberCount()!==2||(s=(0,l._t)("room|intro|dm_caption"));const o=null==n?void 0:n.getMember(a),r=(null==n?void 0:n.name)||(null==o?void 0:o.rawDisplayName)||a;c=i.createElement(i.Fragment,null,i.createElement(Kt.A,{room:n,size:bd,onClick:()=>{S.A.dispatch({action:W.r.ViewUser,member:o||{userId:a}})}}),i.createElement("h2",null,n.name),i.createElement("p",null,(0,l._t)(t,{},{displayName:()=>i.createElement("strong",null,r)})),s&&i.createElement("p",null,s))}else{var d,m,u,h,p;const e=n&&n.getMyMembership()===ut.O.Join,r=null===(d=n.currentState.getStateEvents(o.EventType.RoomTopic,""))||void 0===d||null===(d=d.getContent())||void 0===d?void 0:d.topic,a=e&&n.currentState.maySendStateEvent(o.EventType.RoomTopic,t.getSafeUserId()),g=()=>{S.A.dispatch({action:"open_room_settings",room_id:s},!0),setTimeout((()=>{var e;null===(e=window.document.getElementById("profileTopic"))||void 0===e||e.focus()}))};let v;a&&r?v=(0,l._t)("room|intro|topic_edit",{topic:r},{a:e=>i.createElement(ie.A,{element:"a",kind:"link_inline",onClick:g},e)}):r?v=(0,l._t)("room|intro|topic",{topic:r}):a&&(v=(0,l._t)("room|intro|no_topic",{},{a:e=>i.createElement(ie.A,{element:"a",kind:"link_inline",onClick:g},e)}));const _=null===(m=n.currentState.getStateEvents(o.EventType.RoomCreate,""))||void 0===m?void 0:m.getSender(),f=_&&(null==n||null===(u=n.getMember(_))||void 0===u?void 0:u.rawDisplayName)||_;let E,y,b;E=_===t.getUserId()?(0,l._t)("room|intro|you_created"):(0,l._t)("room|intro|user_created",{displayName:f}),null!==(h=us.Ay.instance.activeSpaceRoom)&&void 0!==h&&h.canInvite(t.getSafeUserId())&&us.Ay.instance.isRoomInSpace(us.Ay.instance.activeSpace,n.roomId)&&(y=us.Ay.instance.activeSpaceRoom),y&&(0,ea.g)(He.C.InviteUsers)?b=i.createElement("div",{className:"mx_NewRoomIntro_buttons"},i.createElement(ie.A,{className:"mx_NewRoomIntro_inviteButton",kind:"primary",onClick:()=>{(0,mo.Lo)(y)}},(0,l._t)("invite|to_space",{spaceName:y.name})),n.canInvite(t.getSafeUserId())&&i.createElement(ie.A,{className:"mx_NewRoomIntro_inviteButton",kind:"primary_outline",onClick:()=>{S.A.dispatch({action:"view_invite",roomId:s})}},(0,l._t)("room|intro|room_invite"))):n.canInvite(t.getSafeUserId())&&(0,ea.g)(He.C.InviteUsers)&&(b=i.createElement("div",{className:"mx_NewRoomIntro_buttons"},i.createElement(ie.A,{className:"mx_NewRoomIntro_inviteButton",kind:"primary",onClick:()=>{S.A.dispatch({action:"view_invite",roomId:s})}},(0,l._t)("room|invite_this_room"))));const w=null===(p=n.currentState.getStateEvents(o.EventType.RoomAvatar,""))||void 0===p||null===(p=p.getContent())||void 0===p?void 0:p.url;let A=i.createElement(Kt.A,{room:n,size:bd,viewAvatarOnClick:!!w});w||(A=i.createElement(wd,{hasAvatar:!1,noAvatarLabel:(0,l._t)("room|intro|no_avatar_label"),setAvatarUrl:e=>t.sendStateEvent(s,o.EventType.RoomAvatar,{url:e},"")},A)),c=i.createElement(i.Fragment,null,A,i.createElement("h2",null,n.name),i.createElement("p",null,E," ",(0,l._t)("room|intro|start_of_room",{},{roomName:()=>i.createElement("strong",null,n.name)})),i.createElement("p",null,v),b)}const g=(0,l._t)("room|intro|private_unencrypted_warning");let v;n.currentState.mayClientSendStateEvent(o.EventType.RoomEncryption,_.J.safeGet())&&!r&&(v=i.createElement(ie.A,{kind:"link_inline",onClick:function(e){e.preventDefault(),S.A.dispatch({action:"open_room_settings",initial_tab_id:mt.e.Security})}},(0,l._t)("room|intro|enable_encryption_prompt")));const f=i.createElement("span",null," ",g," ",v," ");return i.createElement("li",{className:"mx_NewRoomIntro"},!function(e,t){const n=e.isRoomEncrypted(t.roomId);return"public"===t.getJoinRule()||!(0,su.u)(e)||n}(t,n)&&i.createElement($m.A,{className:"mx_cryptoEvent mx_cryptoEvent_icon_warning",title:(0,l._t)("room|intro|unencrypted_warning"),subtitle:f}),c)};class lu extends Jm{shouldGroup({event:e,shouldShow:t}){const n=this.panel,i=this.firstEventAndShouldShow.event;if(!t)return!0;if(n.wantsSeparator(this.firstEventAndShouldShow.event,e)===zm.W.Date)return!1;const s=e.getType();return(s!==o.EventType.RoomMember||e.getStateKey()===i.getSender()&&e.getContent().membership===ut.O.Join)&&(!o.M_BEACON_INFO.matches(s)&&(Pt.I$!==s&&!(!e.isState()||e.getSender()!==i.getSender())))}add(e){const{event:t,shouldShow:n}=e,i=this.panel;this.readMarker=this.readMarker||i.readMarkerForEvent(t.getId(),t===this.lastShownEvent),n&&(t.getType()===o.EventType.RoomEncryption?this.ejectedEvents.push(e):this.events.push(e))}getTiles(){var e,t;if(!this.events||!this.events.length)return[];const n=this.panel,s=[],o=!0,r=this.firstEventAndShouldShow,a=this.lastShownEvent;if(n.wantsSeparator(this.prevEvent,r.event)===zm.W.Date){const e=r.event.getTs();s.push(i.createElement("li",{key:e+"~"},i.createElement(Wm.A,{roomId:r.event.getRoomId(),ts:e})))}r.shouldShow&&s.push(...n.getTilesForEvent(r.event,r));for(const e of this.ejectedEvents)s.push(...n.getTilesForEvent(r.event,e,r.event===a,o));const c=this.events.map((e=>n.getTilesForEvent(e.event,e,e.event===a,o))).reduce(((e,t)=>e.concat(t)),[]),d=this.events[this.events.length-1].event;let m;const u=d.getRoomId(),h=null!==(e=null===(t=d.sender)||void 0===t?void 0:t.name)&&void 0!==e?e:d.getSender();return m=u&&x.A.shared().getUserIdForRoomId(u)?(0,l._t)("timeline|creation_summary_dm",{creator:h}):(0,l._t)("timeline|creation_summary_room",{creator:h}),s.push(i.createElement(au,{key:"newroomintro"})),s.push(i.createElement(Ym,{key:"roomcreationsummary",events:this.events.map((e=>e.event)),onToggle:n.onHeightChanged,summaryMembers:d.sender?[d.sender]:void 0,summaryText:m,layout:this.panel.props.layout},c)),this.readMarker&&s.push(this.readMarker),s}getNewPrevEvent(){return this.firstEventAndShouldShow.event}}(0,v.A)(lu,"canStartGroup",(function(e,{event:t}){return t.getType()===o.EventType.RoomCreate}));const cu=[o.EventType.Sticker,o.EventType.RoomMessage];function du(e,t,n,i,s){return s!==jt.Ae.ThreadsList&&(!(null==e||!e.sender||!t.sender)&&(!(t.getTs()-e.getTs()>3e5)&&(t.isRedacted()===e.isRedacted()&&(!!(t.getType()===e.getType()||cu.includes(t.getType())&&cu.includes(e.getType()))&&(t.sender.userId===e.sender.userId&&t.sender.name===e.sender.name&&t.sender.getMxcAvatarUrl()===e.sender.getMxcAvatarUrl()&&((!(0,Rt.zr)(t)&&!(0,Rt.zr)(e)||s===jt.Ae.Thread)&&!!(0,It.bN)(e,n,i)))))))}class mu extends i.Component{constructor(e,t){super(e,t),(0,v.A)(this,"readReceiptMap",{}),(0,v.A)(this,"readReceiptsByEvent",new Map),(0,v.A)(this,"readReceiptsByUserId",new Map),(0,v.A)(this,"_showHiddenEvents",void 0),(0,v.A)(this,"unmounted",!1),(0,v.A)(this,"readMarkerNode",(0,i.createRef)()),(0,v.A)(this,"whoIsTyping",(0,i.createRef)()),(0,v.A)(this,"scrollPanel",(0,i.createRef)()),(0,v.A)(this,"showTypingNotificationsWatcherRef",void 0),(0,v.A)(this,"eventTiles",{}),(0,v.A)(this,"grouperKeyMap",new WeakMap),(0,v.A)(this,"calculateRoomMembersCount",(()=>{this.setState({hideSender:this.shouldHideSender()})})),(0,v.A)(this,"onShowTypingNotificationsChange",(()=>{this.setState({showTypingNotifications:M.A.getValue("showTypingNotifications")})})),(0,v.A)(this,"isUnmounting",(()=>this.unmounted)),(0,v.A)(this,"collectGhostReadMarker",(e=>{e&&requestAnimationFrame((()=>{e.style.width="10%",e.style.opacity="0"}))})),(0,v.A)(this,"onGhostTransitionEnd",(e=>{const t=e.target.dataset.eventid;this.setState({ghostReadMarkers:this.state.ghostReadMarkers.filter((e=>e!==t))})})),(0,v.A)(this,"collectEventTile",((e,t)=>{this.eventTiles[e]=t})),(0,v.A)(this,"onHeightChanged",(()=>{const e=this.scrollPanel.current;e&&e.checkScroll()})),(0,v.A)(this,"onTypingShown",(()=>{const e=this.scrollPanel.current;null==e||e.checkScroll(),e&&e.getScrollState().stuckAtBottom&&e.preventShrinking()})),(0,v.A)(this,"onTypingHidden",(()=>{const e=this.scrollPanel.current;e&&(e.updatePreventShrinking(),e.checkScroll())})),this.state={ghostReadMarkers:[],showTypingNotifications:M.A.getValue("showTypingNotifications"),hideSender:this.shouldHideSender()},this._showHiddenEvents=M.A.getValue("showHiddenEventsInTimeline")}componentDidMount(){var e;this.unmounted=!1,this.showTypingNotificationsWatcherRef=M.A.watchSetting("showTypingNotifications",null,this.onShowTypingNotificationsChange),this.calculateRoomMembersCount(),null===(e=this.props.room)||void 0===e||e.currentState.on(o.RoomStateEvent.Update,this.calculateRoomMembersCount)}componentWillUnmount(){var e;this.unmounted=!0,null===(e=this.props.room)||void 0===e||e.currentState.off(o.RoomStateEvent.Update,this.calculateRoomMembersCount),M.A.unwatchSetting(this.showTypingNotificationsWatcherRef),this.readReceiptMap={}}componentDidUpdate(e,t){if(e.layout!==this.props.layout&&this.calculateRoomMembersCount(),e.readMarkerVisible&&e.readMarkerEventId&&this.props.readMarkerEventId!==e.readMarkerEventId){const t=this.state.ghostReadMarkers;t.push(e.readMarkerEventId),this.setState({ghostReadMarkers:t})}const n=this.pendingEditItem;if(!this.props.editState&&this.props.room&&n){const e=this.props.room.findEventById(n);S.A.dispatch({action:W.r.EditEvent,event:null!=e&&e.isRedacted()?null:e,timelineRenderingType:this.context.timelineRenderingType})}}shouldHideSender(){return!!this.props.room&&this.props.room.getInvitedAndJoinedMemberCount()<=2&&this.props.layout===gt.P.Bubble}getNodeForEventId(e){var t,n;if(this.eventTiles)return null!==(t=null===(n=this.eventTiles[e])||void 0===n||null===(n=n.ref)||void 0===n?void 0:n.current)&&void 0!==t?t:void 0}getTileForEventId(e){if(this.eventTiles&&e)return this.eventTiles[e]}isAtBottom(){var e;return null===(e=this.scrollPanel.current)||void 0===e?void 0:e.isAtBottom()}getScrollState(){var e,t;return null!==(e=null===(t=this.scrollPanel.current)||void 0===t?void 0:t.getScrollState())&&void 0!==e?e:null}getReadMarkerPosition(){var e;const t=this.readMarkerNode.current,n=null===(e=this.scrollPanel.current)||void 0===e?void 0:e.divScroll;if(!t||!n)return null;const i=n.getBoundingClientRect(),s=t.getBoundingClientRect();return s.bottom+2<i.top?-1:s.top<i.bottom?0:1}scrollToTop(){var e;null===(e=this.scrollPanel.current)||void 0===e||e.scrollToTop()}scrollToBottom(){var e;null===(e=this.scrollPanel.current)||void 0===e||e.scrollToBottom()}handleScrollKey(e){var t;null===(t=this.scrollPanel.current)||void 0===t||t.handleScrollKey(e)}scrollToEvent(e,t,n){var i;null===(i=this.scrollPanel.current)||void 0===i||i.scrollToToken(e,t,n)}scrollToEventIfNeeded(e){const t=this.getNodeForEventId(e);t&&t.scrollIntoView({block:"nearest",behavior:"instant"})}get showHiddenEvents(){var e,t;return null!==(e=null===(t=this.context)||void 0===t?void 0:t.showHiddenEvents)&&void 0!==e?e:this._showHiddenEvents}shouldShowEvent(e,t=!1){if(this.props.hideThreadedMessages&&this.props.room){const{shouldLiveInRoom:t}=this.props.room.eventShouldLiveIn(e,this.props.events);if(!t)return!1}return!_.J.safeGet().isUserIgnored(e.getSender())&&(!(!this.showHiddenEvents||t)||!!(0,It.bN)(e,_.J.safeGet(),this.showHiddenEvents)&&(this.props.highlightedEventId===e.getId()||!(0,Jd.A)(e,this.context)))}readMarkerForEvent(e,t){if(this.context.timelineRenderingType===jt.Ae.File)return null;const n=!t&&this.props.readMarkerVisible;if(this.props.readMarkerEventId===e){let t;return n&&(t=i.createElement("hr",{style:{opacity:1,width:"99%"}})),i.createElement("li",{key:"readMarker_"+e,ref:this.readMarkerNode,className:"mx_MessagePanel_myReadMarker","data-scroll-tokens":e},t)}if(this.state.ghostReadMarkers.includes(e)){const t=i.createElement("hr",{ref:this.collectGhostReadMarker,onTransitionEnd:this.onGhostTransitionEnd,"data-eventid":e});return i.createElement("li",{key:"_readuptoghost_"+e,className:"mx_MessagePanel_myReadMarker"},t)}return null}getNextEventInfo(e,t){const n=t<e.length-1?e[t+1]:null,i=function(e,t){for(let n=e+1;n<t.length;n++){const{event:e,shouldShow:i}=t[n];if(i)return e}return null}(t,e);return{nextEventAndShouldShow:n,nextTile:i}}get pendingEditItem(){if(!this.props.room)return null;try{return localStorage.getItem((0,Km.O)(this.props.room.roomId,this.context.timelineRenderingType))}catch(e){return s.v.error(e),null}}isSentState(e){const t=e.getAssociatedStatus();return!t||t===o.EventStatus.SENT}getEventTiles(){let e;const t=this.props.events.map((e=>({event:e,shouldShow:this.shouldShowEvent(e)}))),n=_.J.safeGet().getSafeUserId();let i=!1,s=-1;for(let o=t.length-1;o>=0;o--){const{event:r,shouldShow:a}=t[o];if(a&&(void 0===e&&(e=r),!i&&this.isSentState(r)&&Ki(r)&&(i=!0,r.getSender()===n&&(t[o].lastSuccessfulWeSent=!0)),s<0&&!r.status&&(s=o),s>=0&&i))break}const o=[];let r=null;this.readReceiptsByEvent=new Map,this.props.showReadReceipts&&(this.readReceiptsByEvent=this.getReadReceiptsByShownEvent(t));let a=null;for(let n=0;n<t.length;n++){const i=t[n],{event:l,shouldShow:c}=i,d=l.getId(),m=l===e,{nextEventAndShouldShow:u,nextTile:h}=this.getNextEventInfo(t,n);if(a){if(a.shouldGroup(i)){a.add(i);continue}o.push(...a.getTiles()),r=a.getNewPrevEvent(),a=null}for(const t of uu)if(t.canStartGroup(this,i)&&!this.props.disableGrouping){a=new t(this,i,r,e,u,h);break}if(!a){c&&(o.push(...this.getTilesForEvent(r,i,m,!1,u,h)),r=l);const e=this.readMarkerForEvent(d,n>=s);e&&o.push(e)}}return a&&o.push(...a.getTiles()),o}getTilesForEvent(e,t,n=!1,s=!1,o=null,r=null){var a,c,d;const m=t.event,u=[],h=(null===(a=this.props.editState)||void 0===a?void 0:a.getEvent().getId())===m.getId(),p=null!==(c=m.getTs())&&void 0!==c?c:Date.now(),g=this.wantsSeparator(e,m);if(!s&&this.props.room)if(g===zm.W.Date)u.push(i.createElement("li",{key:p},i.createElement(Wm.A,{key:p,roomId:this.props.room.roomId,ts:p})));else if(g===zm.W.LateEvent){var v;const e=(0,l._t)("timeline|late_event_separator",{dateTime:(0,Re.Yq)(null!==(v=m.getDate())&&void 0!==v?v:new Date)});u.push(i.createElement("li",{key:p},i.createElement(zm.A,{key:p,label:e},e)))}const f=_.J.safeGet();let E=!0;if(r){const e=r;E=this.wantsSeparator(m,e)===zm.W.Date||m.getSender()!==e.getSender()||Nt(f,e,this.showHiddenEvents).isInfoMessage||!du(m,e,f,this.showHiddenEvents,this.context.timelineRenderingType)}const y=g===zm.W.None&&du(e,m,f,this.showHiddenEvents,this.context.timelineRenderingType),b=m.getId(),w=b===this.props.highlightedEventId,S=this.readReceiptsByEvent.get(b),A=this.props.callEventGroupers.get(m.getContent().call_id);return u.push(i.createElement(Gi,{key:m.getTxnId()||b,as:"li",ref:this.collectEventTile.bind(this,b),alwaysShowTimestamps:this.props.alwaysShowTimestamps,mxEvent:m,continuation:y,isRedacted:m.isRedacted(),replacingEventId:m.replacingEventId(),editState:h?this.props.editState:void 0,onHeightChanged:this.onHeightChanged,readReceipts:S,readReceiptMap:this.readReceiptMap,showUrlPreview:this.props.showUrlPreview,checkUnmounting:this.isUnmounting,eventSendStatus:null!==(d=m.getAssociatedStatus())&&void 0!==d?d:void 0,isTwelveHour:this.props.isTwelveHour,permalinkCreator:this.props.permalinkCreator,last:n,lastInSection:E,lastSuccessful:t.lastSuccessfulWeSent,isSelectedEvent:w,getRelationsForEvent:this.props.getRelationsForEvent,showReactions:this.props.showReactions,layout:this.props.layout,showReadReceipts:this.props.showReadReceipts,callEventGrouper:A,hideSender:this.state.hideSender})),u}wantsSeparator(e,t){var n;if(this.context.timelineRenderingType===jt.Ae.ThreadsList)return zm.W.None;if(null!==e){var i;const n=Bi(t);if((null==n?void 0:n.group_id)!==(null===(i=Bi(e))||void 0===i?void 0:i.group_id))return void 0!==n?zm.W.LateEvent:zm.W.Date}if(null===e&&!this.props.canBackPaginate)return zm.W.Date;const s=null!==(n=t.getDate())&&void 0!==n?n:new Date;return null!==e&&(0,Re.fq)(e.getDate()||void 0,s)?zm.W.Date:zm.W.None}getReadReceiptsForEvent(e){const t=_.J.safeGet().credentials.userId,{room:n}=this.props;if(!n)return null;const i=this.context.threadId?n.getThread(this.context.threadId):n,o=[];return i?(i.getReceiptsForEvent(e).forEach((e=>{if(!e.userId||!(0,ur.ll)(e.type)||e.userId===t)return;if(_.J.safeGet().isUserIgnored(e.userId))return;const i=n.getMember(e.userId);o.push({userId:e.userId,roomMember:i,ts:e.data?e.data.ts:0})})),o):(s.v.debug("Discarding request, could not find the receiptDestination for event: "+this.context.threadId),o)}getReadReceiptsByShownEvent(e){const t=new Map,n=new Map;let i;for(const e of this.props.events){if(this.shouldShowEvent(e)&&(i=e.getId()),!i)continue;const s=t.get(i)||[],o=this.getReadReceiptsForEvent(e);if(o){t.set(i,s.concat(o));for(const e of o)n.set(e.userId,{lastShownEventId:i,receipt:e})}}for(const e of this.readReceiptsByUserId.keys()){if(n.get(e))continue;const{lastShownEventId:i,receipt:s}=this.readReceiptsByUserId.get(e),o=t.get(i)||[];t.set(i,o.concat(s)),n.set(e,{lastShownEventId:i,receipt:s})}this.readReceiptsByUserId=n;for(const e of t.values())e.sort(((e,t)=>t.ts-e.ts));return t}updateTimelineMinHeight(){const e=this.scrollPanel.current;if(e){const t=e.isAtBottom(),n=this.whoIsTyping.current,i=n&&n.isVisible();t&&i&&e.preventShrinking()}}onTimelineReset(){const e=this.scrollPanel.current;e&&e.clearPreventShrinking()}render(){let e,t;this.props.backPaginating&&(e=i.createElement("li",{key:"_topSpinner"},i.createElement(se.A,null))),this.props.forwardPaginating&&(t=i.createElement("li",{key:"_bottomSpinner"},i.createElement(se.A,null)));const n=this.props.hidden?{display:"none"}:{};let s,o;var r,a;(this.props.room&&this.state.showTypingNotifications&&this.context.timelineRenderingType===jt.Ae.Room&&(s=i.createElement(Bm,{room:this.props.room,onShown:this.onTypingShown,onHidden:this.onTypingHidden,ref:this.whoIsTyping})),this.props.layout==gt.P.IRC)&&(o=i.createElement(Um,{minWidth:20,maxWidth:600,roomId:null!==(r=null===(a=this.props.room)||void 0===a?void 0:a.roomId)&&void 0!==r?r:null}));const l=dt()(this.props.className,{mx_MessagePanel_narrow:this.context.narrow});return i.createElement(Hm.A,null,i.createElement(jm.A,{ref:this.scrollPanel,className:l,onScroll:this.props.onScroll,onFillRequest:this.props.onFillRequest,onUnfillRequest:this.props.onUnfillRequest,style:n,stickyBottom:this.props.stickyBottom,resizeNotifier:this.props.resizeNotifier,fixedChildren:o},e,this.getEventTiles(),s,t))}}(0,v.A)(mu,"contextType",jt.Ay),(0,v.A)(mu,"defaultProps",{disableGrouping:!1});const uu=[lu,iu];var hu=n("./node_modules/raw-loader/dist/cjs.js!./src/utils/exportUtils/exportCustomCSS.css");const pu=/\.[\w-]+/g;function gu(e){const t="-apple-system, BlinkMacSystemFont, avenir next,\n            avenir, segoe ui, helvetica neue, helvetica, Ubuntu, roboto, noto, arial, sans-serif";return e.replace(/font-family: ?(Inter|'Inter'|"Inter")/g,`font-family: ${t}`).replace(/--cpd-font-family-sans: ?(Inter|'Inter'|"Inter")/g,`--cpd-font-family-sans: ${t}`).replace(/font-family: ?Inconsolata/g,"font-family: Menlo, Consolas, Monaco, Liberation Mono, Lucida Console, monospace")}function vu(e,t){return"Raw"!==e.prelude.type||!e.block.children.isEmpty&&e.prelude.value.split(",").some((e=>{const n=e.trim().match(pu);return!(n&&!n.every((e=>t.has(e.substring(1)))))}))}const _u=async e=>{const t=await n.e(3815).then(n.bind(n,"./node_modules/css-tree/lib/index.js")),i=["bundle.css","theme-light.css"].map((e=>{var t;return null===(t=document.querySelector(`link[rel="stylesheet"][href$="${e}"]`))||void 0===t?void 0:t.href}));let s="";for(const n of i){if(!n)continue;const i=await fetch(n),o=await i.text(),r=t.parse(o,{context:"stylesheet",parseAtrulePrelude:!1,parseRulePrelude:!1,parseValue:!1,parseCustomProperty:!1});for(const n of r.children)"Atrule"===n.type&&"font-face"===n.name||("Rule"!==n.type||vu(n,e))&&(s+=gu(t.generate(n)))}return s+hu.A};var fu=n("./node_modules/buffer/index.js").hp;class Eu extends Om{constructor(e,t,n,i){super(e,t,n,i),(0,v.A)(this,"avatars",void 0),(0,v.A)(this,"permalinkCreator",void 0),(0,v.A)(this,"totalSize",void 0),(0,v.A)(this,"mediaOmitText",void 0),this.avatars=new Map,this.permalinkCreator=new yt.pE(this.room),this.totalSize=0,this.mediaOmitText=this.exportOptions.attachmentsIncluded?(0,l._t)("export_chat|media_omitted_file_size"):(0,l._t)("export_chat|media_omitted")}async getRoomAvatar(){let e;const t=vt.ze(this.room,32,32,"crop"),n="room.png";if(t)try{const i=await fetch(t);e=await i.blob(),this.totalSize+=e.size,this.addFile(n,e)}catch(e){s.v.log("Failed to fetch room's avatar"+e)}const o=i.createElement(os.A,{size:"32px",name:this.room.name,title:this.room.name,url:e?n:""});return(0,Rm.qV)(o)}async wrapHTML(e,t,n){var s,r,a,c;const d=await this.getRoomAvatar(),m=(0,Re.Ah)(new Date),u=null===(s=this.room.currentState.getStateEvents(o.EventType.RoomCreate,""))||void 0===s?void 0:s.getSender(),h=(u?null===(r=this.room.getMember(u))||void 0===r?void 0:r.rawDisplayName:u)||u,p=this.room.client.getSafeUserId(),g=null===(a=this.room.getMember(p))||void 0===a?void 0:a.rawDisplayName,v=(null===(c=this.room.currentState.getStateEvents(o.EventType.RoomTopic,""))||void 0===c||null===(c=c.getContent())||void 0===c?void 0:c.topic)||"",_=Tm()((0,l._t)("export_chat|creator_summary",{creatorName:h})),f=Tm()(p),E=Tm()(this.room.name),y=Tm()(v),b=(0,Rm.qV)(i.createElement("p",null,(0,l._t)("export_chat|export_info",{exportDate:m},{roomName:()=>i.createElement("strong",null,E),exporterDetails:()=>i.createElement("a",{href:`https://matrix.to/#/${encodeURIComponent(p)}`,target:"_blank",rel:"noopener noreferrer"},g?i.createElement(i.Fragment,null,i.createElement("strong",null,Tm()(g)),"I "," ("+f+")"):i.createElement("strong",null,f))}))),w=v?(0,l._t)("export_chat|topic",{topic:y}):"",S=(0,Rm.qV)(0!==t?i.createElement("div",{style:{textAlign:"center"}},i.createElement("a",{href:`./messages${1===t?"":t}.html`,style:{fontWeight:"bold"}},(0,l._t)("export_chat|previous_page"))):i.createElement(i.Fragment,null)),A=(0,Rm.qV)(t<n-1?i.createElement("div",{style:{textAlign:"center",margin:"10px"}},i.createElement("a",{href:"./messages"+(t+2)+".html",style:{fontWeight:"bold"}},(0,l._t)("export_chat|next_page"))):i.createElement(i.Fragment,null));return`\n          <!DOCTYPE html>\n            <html lang="en">\n            <head>\n                <meta charset="UTF-8" />\n                <meta http-equiv="X-UA-Compatible" content="IE=edge" />\n                <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n                <link href="css/style.css" rel="stylesheet" />\n                <script src="js/script.js"><\/script>\n                <title>${(0,l._t)("export_chat|html_title")}</title>\n            </head>\n            <body style="height: 100vh;" class="cpd-theme-light">\n                <div id="matrixchat" style="height: 100%; overflow: auto">\n                    <div class="mx_MatrixChat_wrapper" aria-hidden="false">\n                        <div class="mx_MatrixChat">\n                        <main class="mx_RoomView">\n                            <div class="mx_Flex mx_RoomHeader light-panel">\n                                ${d}\n                                <div class="mx_RoomHeader_infoWrapper">\n                                    <div\n                                        dir="auto"\n                                        class="mx_RoomHeader_info"\n                                        title="${E}"\n                                    >\n                                        <span class="mx_RoomHeader_truncated mx_lineClamp">\n                                            ${E}\n                                        </span>\n                                    </div>\n                                </div>\n                            </div>\n                            ${S}\n                            <div class="mx_MainSplit">\n                            <div class="mx_RoomView_body">\n                                <div\n                                class="mx_RoomView_timeline mx_RoomView_timeline_rr_enabled"\n                                >\n                                <div\n                                    class="\n                                    mx_AutoHideScrollbar\n                                    mx_ScrollPanel\n                                    mx_RoomView_messagePanel\n                                    "\n                                >\n                                    <div class="mx_RoomView_messageListWrapper">\n                                    <ol\n                                        class="mx_RoomView_MessageList"\n                                        aria-live="polite"\n                                        role="list"\n                                    >\n                                    ${0==t?`<div class="mx_NewRoomIntro">\n                                            ${d}\n                                            <h2> ${E} </h2>\n                                            <p> ${_} <br/><br/> ${b} </p>\n                                            <br/>\n                                            <p> ${w} </p>\n                                        </div>`:""}\n                                    ${e}\n                                    </ol>\n                                    </div>\n                                </div>\n                                </div>\n                                <div class="mx_RoomView_statusArea">\n                                <div class="mx_RoomView_statusAreaBox">\n                                    <div class="mx_RoomView_statusAreaBox_line"></div>\n                                </div>\n                                </div>\n                            </div>\n                            </div>\n                            ${A}\n                        </main>\n                        </div>\n                    </div>\n                </div>\n                <div id="snackbar"/>\n            </body>\n        </html>`}getAvatarURL(e){const t=e.sender,n=null==t?void 0:t.getMxcAvatarUrl();return n?(0,Wn.lH)(n).getThumbnailOfSourceHttp(30,30,"crop"):null}async saveAvatarIfNeeded(e){const t=e.sender;if(!this.avatars.has(t.userId))try{const n=this.getAvatarURL(e);this.avatars.set(t.userId,!0);const i=await fetch(n),s=await i.blob();this.addFile(`users/${t.userId.replace(/:/g,"-")}.png`,s)}catch(e){s.v.log("Failed to fetch user's avatar"+e)}}getDateSeparator(e){const t=e.getTs(),n=i.createElement("li",{key:t},i.createElement(Wm.A,{forExport:!0,key:t,roomId:e.getRoomId(),ts:t}));return(0,Rm.qV)(n)}needsDateSeparator(e,t){return!t||(0,Re.fq)(t.getDate()||void 0,e.getDate()||void 0)}getEventTile(e,t,n){return i.createElement("div",{className:"mx_Export_EventWrapper",id:e.getId()},i.createElement(Hn.Ay.Provider,{value:this.room.client},i.createElement(hr.B,null,i.createElement(Gi,{mxEvent:e,continuation:t,isRedacted:e.isRedacted(),replacingEventId:e.replacingEventId(),forExport:!0,alwaysShowTimestamps:!0,showUrlPreview:!1,checkUnmounting:()=>!1,isTwelveHour:!1,last:!1,lastInSection:!1,permalinkCreator:this.permalinkCreator,lastSuccessful:!1,isSelectedEvent:!1,showReactions:!0,layout:gt.P.Group,showReadReceipts:!1,getRelationsForEvent:this.getRelationsForEvent,ref:n}))))}async getEventTileMarkup(e,t,n){const i=this.getAvatarURL(e),s=!!i;s&&await this.saveAvatarIfNeeded(e);const r=(0,ur.v6)(),a=this.getEventTile(e,t,r.resolve);let l;if(e.getContent().msgtype==o.MsgType.Emote||e.getContent().msgtype==o.MsgType.Notice||e.getContent().msgtype===o.MsgType.Text){const e=document.createElement("div"),t=(0,km.H)(e);t.render(a),await r.promise,l=e.innerHTML,t.unmount()}else l=(0,Rm.qV)(a);if(n){var c,d;const t=null!==(c=e.getContent().url)&&void 0!==c?c:null===(d=e.getContent().file)||void 0===d?void 0:d.url;l=l.split(t).join(n)}return l=l.replace(/<span class="mx_MFileBody_info_icon".*?>.*?<\/span>/,""),s&&(l=l.replace(encodeURI(i).replace(/&/g,"&amp;"),`users/${e.sender.userId.replace(/:/g,"-")}.png`)),l}createModifiedEvent(e,t,n=!0){const i={msgtype:o.MsgType.Text,body:`${e}`,format:"org.matrix.custom.html",formatted_body:`${e}`};n&&(i.formatted_body="<em>"+i.formatted_body+"</em>",i.body="*"+i.body+"*");const s=new o.MatrixEvent;return s.event=t.event,s.sender=t.sender,s.event.type="m.room.message",s.event.content=i,s}async createMessageBody(e,t=!1){let n;try{if(this.isAttachment(e))if(this.exportOptions.attachmentsIncluded)try{const i=await this.getMediaBlob(e);if(this.totalSize+i.size>this.exportOptions.maxSize)n=await this.getEventTileMarkup(this.createModifiedEvent(this.mediaOmitText,e),t);else{this.totalSize+=i.size;const s=this.getFilePath(e);n=await this.getEventTileMarkup(e,t,s),this.totalSize==this.exportOptions.maxSize&&(this.exportOptions.attachmentsIncluded=!1),this.addFile(s,i)}}catch(i){s.v.log("Error while fetching file"+i),n=await this.getEventTileMarkup(this.createModifiedEvent((0,l._t)("export_chat|error_fetching_file"),e),t)}else n=await this.getEventTileMarkup(this.createModifiedEvent(this.mediaOmitText,e),t);else n=await this.getEventTileMarkup(e,t)}catch(i){s.v.error(i),n=await this.getEventTileMarkup(this.createModifiedEvent((0,Gm.Rd)(e,this.room.client),e,!1),t)}return n}async createHTML(e,t,n,i){let s="",o=null;for(let n=t;n<Math.min(t+1e3,e.length);n++){const t=e[n];if(this.updateProgress((0,l._t)("export_chat|processing_event_n",{number:n+1,total:e.length}),!1,!0),this.cancelled)return this.cleanUp();if(!(0,It.bN)(t,this.room.client,!1))continue;s+=this.needsDateSeparator(t,o)?this.getDateSeparator(t):"";const i=!this.needsDateSeparator(t,o)&&du(o,t,this.room.client,!1),r=await this.createMessageBody(t,i);this.totalSize+=fu.byteLength(r),s+=r,o=t}return this.wrapHTML(s,n,i)}async export(){this.updateProgress((0,l._t)("export_chat|starting_export"));const e=performance.now(),t=await this.getRequiredEvents(),n=performance.now();this.updateProgress((0,l._t)("export_chat|fetched_n_events_in_time",{count:t.length,seconds:(n-e)/1e3}),!0,!1),this.updateProgress((0,l._t)("export_chat|creating_html"));const i=new Set;for(let e=0;e<t.length/1e3;e++){const n=await this.createHTML(t,1e3*e,e,t.length/1e3);(new DOMParser).parseFromString(n,"text/html").querySelectorAll("*").forEach((e=>{e.classList.forEach((e=>i.add(e)))})),this.addFile(`messages${e?e+1:""}.html`,new Blob([n]))}const o=await _u(i);this.addFile("css/style.css",new Blob([o])),this.addFile("js/script.js",new Blob(['/*\nCopyright 2024 New Vector Ltd.\nCopyright 2021 The Matrix.org Foundation C.I.C.\n\nSPDX-License-Identifier: AGPL-3.0-only OR GPL-3.0-only\nPlease see LICENSE files in the repository root for full details.\n*/\n\n// This file is raw-imported (imported as plain text) for the export bundle, which is why this is in JS\nfunction showToastIfNeeded(replyId) {\n    const el = document.getElementById(replyId);\n    if (!el) {\n        showToast("The message you\'re looking for wasn\'t exported");\n        return;\n    }\n}\n\nfunction showToast(text) {\n    const el = document.getElementById("snackbar");\n    el.innerHTML = text;\n    el.className = "mx_show";\n    window.setTimeout(() => {\n        el.className = el.className.replace("mx_show", "");\n    }, 2000);\n}\n\nwindow.onload = () => {\n    document.querySelectorAll(".mx_reply_anchor").forEach((element) => {\n        element.addEventListener("click", (event) => {\n            showToastIfNeeded(event.target.dataset.scrollTo);\n        });\n    });\n};\n'])),await this.downloadZIP();const r=performance.now();this.cancelled?s.v.info("Export cancelled successfully"):(this.updateProgress((0,l._t)("export_chat|export_successful")),this.updateProgress((0,l._t)("export_chat|exported_n_events_in_time",{count:t.length,seconds:(r-e)/1e3}))),this.cleanUp()}}class yu extends Om{constructor(e,t,n,i){super(e,t,n,i),(0,v.A)(this,"totalSize",0),(0,v.A)(this,"messages",[])}get destinationFileName(){return this.makeFileNameNoExtension()+".json"}createJSONString(){var e,t,n,i;const s=(0,Re.Ah)(new Date),r=null===(e=this.room.currentState.getStateEvents(o.EventType.RoomCreate,""))||void 0===e?void 0:e.getSender(),a=r&&(null===(t=this.room)||void 0===t||null===(t=t.getMember(r))||void 0===t?void 0:t.rawDisplayName)||r,l=(null===(n=this.room.currentState.getStateEvents(o.EventType.RoomTopic,""))||void 0===n||null===(n=n.getContent())||void 0===n?void 0:n.topic)||"",c=this.room.client.getUserId(),d=(null===(i=this.room)||void 0===i||null===(i=i.getMember(c))||void 0===i?void 0:i.rawDisplayName)||c,m={room_name:this.room.name,room_creator:a,topic:l,export_date:s,exported_by:d,messages:this.messages};return JSON.stringify(m,null,2)}async getJSONString(e){if(this.exportOptions.attachmentsIncluded&&this.isAttachment(e))try{const t=await this.getMediaBlob(e);if(this.totalSize+t.size<this.exportOptions.maxSize){this.totalSize+=t.size;const n=this.getFilePath(e);this.totalSize==this.exportOptions.maxSize&&(this.exportOptions.attachmentsIncluded=!1),this.addFile(n,t)}}catch(e){s.v.log("Error fetching file: "+e)}return e.getEffectiveEvent()}async createOutput(e){for(let t=0;t<e.length;t++){const n=e[t];if(this.updateProgress((0,l._t)("export_chat|processing_event_n",{number:t+1,total:e.length}),!1,!0),this.cancelled)return this.cleanUp();(0,It.bN)(n,this.room.client,!1)&&this.messages.push(await this.getJSONString(n))}return this.createJSONString()}async export(){s.v.info("Starting export process..."),s.v.info("Fetching events...");const e=performance.now(),t=await this.getRequiredEvents(),n=performance.now();s.v.log(`Fetched ${t.length} events in ${(n-e)/1e3}s`),s.v.info("Creating output...");const i=await this.createOutput(t);if(this.files.length)this.addFile("export.json",new Blob([i])),await this.downloadZIP();else{const e=this.destinationFileName;this.downloadPlainText(e,i)}const o=performance.now();this.cancelled?s.v.info("Export cancelled successfully"):(s.v.info("Export successful!"),s.v.log(`Exported ${t.length} events in ${(o-e)/1e3} seconds`)),this.cleanUp()}}class bu extends Om{constructor(e,t,n,i){super(e,t,n,i),(0,v.A)(this,"totalSize",void 0),(0,v.A)(this,"mediaOmitText",void 0),(0,v.A)(this,"textForReplyEvent",(e=>{const t=/> <(.*?)>(.*?)\n\n(.*)/s.exec(e.body);if(!t)return e.body;let n;const i=t[1],s=t[3];n=t[2].substring(1);const o=n.split("\n").filter((e=>!/^\s*$/.test(e)));return o.length>0?(n=o[0].substring(0,32),o[0].length>32&&(n+="..."),n=` "${n}"`):n="",`<${i}${n}> ${s}`})),(0,v.A)(this,"plainTextForEvent",(async e=>{const t=e.sender&&e.sender.name?e.sender.name:e.getSender();let n="";if(this.isAttachment(e))if(this.exportOptions.attachmentsIncluded)try{const t=await this.getMediaBlob(e);if(this.totalSize+t.size>this.exportOptions.maxSize)n=` (${this.mediaOmitText})`;else{this.totalSize+=t.size;const i=this.getFilePath(e);n=" ("+(0,l._t)("export_chat|file_attached")+")",this.addFile(i,t),this.totalSize==this.exportOptions.maxSize&&(this.exportOptions.attachmentsIncluded=!1)}}catch(e){n=" ("+(0,l._t)("export_chat|error_fetching_file")+")",s.v.log("Error fetching file "+e)}else n=` (${this.mediaOmitText})`;return this.isReply(e)?t+": "+this.textForReplyEvent(e.getContent())+n:(0,Gm.Rd)(e,this.room.client)+n})),this.totalSize=0,this.mediaOmitText=this.exportOptions.attachmentsIncluded?(0,l._t)("export_chat|media_omitted_file_size"):(0,l._t)("export_chat|media_omitted")}get destinationFileName(){return this.makeFileNameNoExtension()+".txt"}async createOutput(e){let t="";for(let n=0;n<e.length;n++){const i=e[n];if(this.updateProgress((0,l._t)("export_chat|processing_event_n",{number:n+1,total:e.length}),!1,!0),this.cancelled)return this.cleanUp();if(!(0,It.bN)(i,this.room.client,!1))continue;const s=await this.plainTextForEvent(i);t+=s&&`${(0,Re.Lu)(new Date(i.getTs()),M.A.getValue("showTwelveHourTimestamps"))} - ${s}\n`}return t}async export(){this.updateProgress((0,l._t)("export_chat|starting_export")),this.updateProgress((0,l._t)("export_chat|fetching_events"));const e=performance.now(),t=await this.getRequiredEvents(),n=performance.now();s.v.log(`Fetched ${t.length} events in ${(n-e)/1e3}s`),this.updateProgress((0,l._t)("export_chat|creating_output"));const i=await this.createOutput(t);if(this.files.length)this.addFile("export.txt",new Blob([i])),await this.downloadZIP();else{const e=this.destinationFileName;this.downloadPlainText(e,i)}const o=performance.now();this.cancelled?s.v.info("Export cancelled successfully"):(s.v.info("Export successful!"),s.v.log(`Exported ${t.length} events in ${(o-e)/1e3} seconds`)),this.cleanUp()}}const wu=()=>({}),Su=(e,t)=>n=>"number"==typeof n&&!(isNaN(n)||e>n||n>t),Au=({room:e,onFinished:t})=>{const{exportFormat:n,exportType:o,includeAttachments:r,numberOfMessages:a,sizeLimit:c,setExportFormat:d,setExportType:m,setNumberOfMessages:u,setSizeLimit:h,setAttachments:p}=(()=>{var e,t,n,s,o;const r=wu(),[a,l]=(0,i.useState)(null!==(e=r.format)&&void 0!==e?e:Sm.Html),[c,d]=(0,i.useState)(null!==(t=r.range)&&void 0!==t?t:Am.Timeline),[m,u]=(0,i.useState)(null!==(n=r.includeAttachments)&&void 0!==n&&n),[h,p]=(0,i.useState)(null!==(s=r.numberOfMessages)&&void 0!==s?s:100),[g,v]=(0,i.useState)(null!==(o=r.sizeMb)&&void 0!==o?o:8);return{exportFormat:a,exportType:c,includeAttachments:m,numberOfMessages:h,sizeLimit:g,setExportFormat:r.format?void 0:l,setExportType:r.range?void 0:d,setNumberOfMessages:r.numberOfMessages?void 0:p,setSizeLimit:r.sizeMb?void 0:v,setAttachments:void 0===r.includeAttachments?u:void 0}})(),[g,v]=(0,i.useState)(!1),_=(0,i.useRef)(null),f=(0,i.useRef)(null),[E,y]=(0,i.useState)((0,l._t)("export_chat|processing")),[b,w]=(0,i.useState)(!1),[S,A]=(0,i.useState)(!1),[C,x]=(0,i.useState)(!1),[k,R]=((e,t)=>{const[n,s]=(0,i.useState)(e);return[n,e=>{s(e),t(e)}]})(null,(async e=>{await(null==e?void 0:e.export().then((()=>{S||x(!0)})))})),I=async()=>{var t;if(!h||await(null===(t=_.current)||void 0===t?void 0:t.validate({focused:!1}))){if(o===Am.LastNMessages){var i;var l;if(!await(null===(i=f.current)||void 0===i?void 0:i.validate({focused:!1})))return void(null===(l=f.current)||void 0===l||l.validate({focused:!0}))}v(!0),await(async()=>{const t={numberOfMessages:a,attachmentsIncluded:r,maxSize:1024*c*1024};switch(n){case Sm.Html:R(new Eu(e,Am[o],t,y));break;case Sm.Json:R(new yu(e,Am[o],t,y));break;case Sm.PlainText:R(new bu(e,Am[o],t,y));break;default:return void s.v.error("Unknown export format")}})()}else{var d;null===(d=_.current)||void 0===d||d.validate({focused:!0})}},T=(0,xm.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,l._t)("export_chat|enter_number_between_min_max",{min:1,max:2e3})},{key:"number",test:({value:e})=>{const t=parseInt(e,10);return Su(1,2e3)(t)},invalid:()=>(0,l._t)("export_chat|size_limit_min_max",{min:1,max:2e3})}]}),P=async e=>await T(e),N=(0,xm.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,l._t)("export_chat|enter_number_between_min_max",{min:1,max:10**8})},{key:"number",test:({value:e})=>{const t=parseInt(e,10);return Su(1,10**8)(t)},invalid:()=>(0,l._t)("export_chat|num_messages_min_max",{min:1,max:10**8})}]}),D=async e=>await N(e),M=async()=>{g?w(!0):t(!1)},O=async()=>{await(null==k?void 0:k.cancelExport()),A(!0),v(!1),R(null)},L=Object.values(Sm).map((e=>({value:e,label:Cm(e)}))),U=Object.values(Am).map((e=>i.createElement("option",{key:Am[e],value:e},(e=>{switch(e){case Am.Beginning:return(0,l._t)("export_chat|from_the_beginning");case Am.LastNMessages:return(0,l._t)("export_chat|number_of_messages");case Am.Timeline:return(0,l._t)("export_chat|current_timeline");default:throw new Error("Unknown type: "+e)}})(e))));let F;o===Am.LastNMessages&&u&&(F=i.createElement(ks.A,{id:"message-count",element:"input",type:"number",value:a.toString(),ref:f,onValidate:D,label:(0,l._t)("export_chat|num_messages"),onChange:e=>{u(parseInt(e.target.value))}}));const V=i.createElement("span",null,(0,l._t)("export_chat|size_limit_postfix"));return S?i.createElement(Ka.A,{title:(0,l._t)("export_chat|cancelled"),description:(0,l._t)("export_chat|cancelled_detail"),hasCloseButton:!0,onFinished:t}):C?i.createElement(Ka.A,{title:(0,l._t)("export_chat|successful"),description:(0,l._t)("export_chat|successful_detail"),hasCloseButton:!0,onFinished:t}):b?i.createElement(J.A,{title:(0,l._t)("common|warning"),className:"mx_ExportDialog",contentId:"mx_Dialog_content",onFinished:t,fixedWidth:!0},i.createElement("p",null,(0,l._t)("export_chat|confirm_stop")),i.createElement(ot.A,{primaryButton:(0,l._t)("action|stop"),primaryButtonClass:"danger",hasCancel:!0,cancelButton:(0,l._t)("action|continue"),onCancel:()=>w(!1),onPrimaryButtonClick:O})):i.createElement(J.A,{title:g?(0,l._t)("export_chat|exporting_your_data"):(0,l._t)("export_chat|title"),className:`mx_ExportDialog ${g&&"mx_ExportDialog_Exporting"}`,contentId:"mx_Dialog_content",hasCancel:!0,onFinished:t,fixedWidth:!0},g?null:i.createElement("p",null,(0,l._t)("export_chat|select_option")),i.createElement("div",{className:"mx_ExportDialog_options"},!!d&&i.createElement(i.Fragment,null,i.createElement("span",{className:"mx_ExportDialog_subheading"},(0,l._t)("export_chat|format")),i.createElement(wm.A,{name:"exportFormat",value:n,onChange:e=>d(Sm[e]),definitions:L})),!!m&&i.createElement(i.Fragment,null,i.createElement("span",{className:"mx_ExportDialog_subheading"},(0,l._t)("export_chat|messages")),i.createElement(ks.A,{id:"export-type",element:"select",value:o,onChange:e=>{m(Am[e.target.value])}},U),F),h&&i.createElement(i.Fragment,null,i.createElement("span",{className:"mx_ExportDialog_subheading"},(0,l._t)("export_chat|size_limit")),i.createElement(ks.A,{id:"size-limit",type:"number",autoComplete:"off",onValidate:P,element:"input",ref:_,value:c.toString(),postfixComponent:V,onChange:e=>h(parseInt(e.target.value))})),p&&i.createElement(i.Fragment,null,i.createElement(Ms.A,{className:"mx_ExportDialog_attachments-checkbox",id:"include-attachments",checked:r,onChange:e=>p(e.target.checked)},(0,l._t)("export_chat|include_attachments")))),g?i.createElement("div",{className:"mx_ExportDialog_progress"},i.createElement(se.A,{w:24,h:24}),i.createElement("p",null,E),i.createElement(ot.A,{primaryButton:(0,l._t)("action|cancel"),primaryButtonClass:"danger",hasCancel:!1,onPrimaryButtonClick:M})):i.createElement(ot.A,{primaryButton:(0,l._t)("action|export"),onPrimaryButtonClick:I,onCancel:()=>t(!1)}))};var Cu=n("./src/components/views/polls/pollHistory/PollHistory.tsx");const xu=({room:e,matrixClient:t,permalinkCreator:n,onFinished:s})=>i.createElement(J.A,{onFinished:s},i.createElement(Cu.a,{room:e,matrixClient:t,permalinkCreator:n,onFinished:s}));var ku=n("./src/components/utils/Flex.tsx"),Ru=n("./src/actions/RoomListActions.ts");function Iu(e){const t=e.client;return(!!e.canInvite(t.getSafeUserId())||!(!e.isSpaceRoom()||e.getJoinRule()!==o.JoinRule.Public))&&e.getMyMembership()===ut.O.Join&&(0,ea.g)(He.C.InviteUsers)}function Tu(e){e.client.isGuest()?S.A.dispatch({action:"require_registration"}):S.A.dispatch({action:"view_invite",roomId:e.roomId})}const Pu=["as","flex","shrink","grow","className","children"];function Nu(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Du(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Nu(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Nu(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Mu(e,t,n){const i=e.current.style;n?i.setProperty(t,n):i.removeProperty(t)}function Ou(e){let{as:t="div",flex:n=null,shrink:s=null,grow:o=null,className:r,children:a}=e,l=(0,g.A)(e,Pu);const c=(0,i.useRef)();return(0,i.useEffect)((()=>{Mu(c,"--mx-box-flex",n),Mu(c,"--mx-box-shrink",s),Mu(c,"--mx-box-grow",o)}),[n,o,s]),i.createElement(t,Du(Du({},l),{},{className:dt()("mx_Box",r,{"mx_Box--flex":!!n,"mx_Box--shrink":!!s,"mx_Box--grow":!!o}),ref:c}),a)}const Lu=["room","className"];function Uu(e){const t=e.target,n=(0,yt.uK)(t.href);n!==t.href&&(e.preventDefault(),window.location.hash=n)}function Fu(e){let{room:t,className:n}=e,s=(0,g.A)(e,Lu);const r=(0,i.useContext)(Hn.Ay),[a,c]=(0,i.useState)(!1),d=Gs(t),m=(0,zn.sH)(null==d?void 0:d.text,null==d?void 0:d.html),u=(0,i.useCallback)((e=>{var t;null===(t=s.onClick)||void 0===t||t.call(s,e);"A"===e.target.tagName.toUpperCase()?Uu(e):S.A.fire(W.r.ShowRoomTopic)}),[s]),h=e=>{c("A"===e.target.tagName.toUpperCase())};return(0,Ws.F)(S.A,(e=>{if(e.action===W.r.ShowRoomTopic){const e=t.currentState.maySendStateEvent(o.EventType.RoomTopic,r.getSafeUserId()),n=(0,zn.sH)(null==d?void 0:d.text,null==d?void 0:d.html,void 0,!0),s=k.Ay.createDialog(Ka.A,{title:t.name,description:i.createElement("div",null,i.createElement(zn.XZ,{options:{attributes:{onClick(e){u(e),s.close()}}},as:"p"},n),e&&i.createElement(ie.A,{kind:"primary_outline",onClick:()=>{s.close(),S.A.dispatch({action:"open_room_settings"})}},(0,l._t)("room|edit_topic"))),hasCloseButton:!0,button:!1})}})),m?i.createElement(Et.m,{description:(0,l._t)("room|read_topic"),disabled:a},i.createElement("div",(0,_t.A)({},s,{tabIndex:0,role:"button",onClick:u,className:dt()(n,"mx_RoomTopic"),onMouseOver:h,onFocus:h,"aria-label":(0,l._t)("room|read_topic")}),i.createElement(zn.XZ,null,m))):i.createElement("div",{className:dt()(n,"mx_RoomTopic")})}var Vu=n("./src/utils/video-rooms.ts"),Bu=n("./src/components/views/right_panel/types.ts"),ju=n("./src/utils/promise.ts");function Wu(e){var t,n;return(null!==(t=null==e||null===(n=e.getLiveTimeline().getState(o.EventTimeline.FORWARDS))||void 0===n||null===(n=n.getStateEvents(o.EventType.RoomPinnedEvents,""))||void 0===n||null===(n=n.getContent())||void 0===n?void 0:n.pinned)&&void 0!==t?t:[]).slice(0,100)}const zu=e=>{const[t,n]=(0,i.useState)(Wu(e)),s=(0,i.useCallback)((t=>{t&&t.getType()!==o.EventType.RoomPinnedEvents||n(Wu(e))}),[e]);return(0,ci.YK)(null==e?void 0:e.getLiveTimeline().getState(o.EventTimeline.FORWARDS),o.RoomStateEvent.Events,s),(0,i.useEffect)((()=>(n(Wu(e)),()=>{n([])})),[e]),t};function Hu(e){var t,n;return new Set(null!==(t=null==e||null===(n=e.getAccountData(Bu.M))||void 0===n||null===(n=n.getContent())||void 0===n?void 0:n.event_ids)&&void 0!==t?t:[])}function Ku(e,t){const n=(0,Hn.nH)();return(0,hi.e)((()=>{const i=t.map((t=>()=>async function(e,t,n){var i;const r=e.getUnfilteredTimelineSet(),a=null==r||null===(i=r.getTimelineForEvent(t))||void 0===i?void 0:i.getEvents().find((e=>e.getId()===t));if(null!=a&&a.isEncrypted()&&await n.decryptEventIfNeeded(a,{emit:!1}),a)return Dn.A.isUnpinnable(a)?a:null;try{const[i,{events:[s]}]=await Promise.all([n.fetchRoomEvent(e.roomId,t),n.relations(e.roomId,t,o.RelationType.Replace,null,{limit:1})]),r=new o.MatrixEvent(i);r.isEncrypted()&&await n.decryptEventIfNeeded(r,{emit:!1}),await e.processPollEvents([r]);const a=r.getSender();if(a&&Dn.A.isUnpinnable(r))return r.sender=e.getMember(a),s&&r.makeReplaced(s),r}catch(n){s.v.error(`Error looking up pinned event ${t} in room ${e.roomId}`),s.v.error(n)}return null}(e,t,n)));return(0,ju.vA)(i,10)}),[n,e,t],null)}function Ju(e,t){const n=Ku(e,t);return(0,i.useMemo)((()=>n?n.sort(((e,t)=>e?t?e.getTs()-t.getTs():1:-1)):[]),[n])}const Gu=()=>{_l.A.instance.pushCard({phase:fl.n.RoomMemberList},!0)},$u=()=>{_l.A.instance.pushCard({phase:fl.n.ThreadPanel},!0)},qu=()=>{_l.A.instance.pushCard({phase:fl.n.FilePanel},!0)},Yu=()=>{_l.A.instance.pushCard({phase:fl.n.Extensions},!0)},Qu=()=>{Mn.A.trackInteraction("PinnedMessageRoomInfoButton"),_l.A.instance.pushCard({phase:fl.n.PinnedMessages},!0)},Xu=e=>{S.A.dispatch({action:"open_room_settings"}),Mn.A.trackInteraction("WebRightPanelRoomInfoSettingsButton",e)},Zu=({room:e})=>{const[t,n]=(0,i.useState)(!0),s=Gs(e),r=(0,zn.sH)(null==s?void 0:s.text,null==s?void 0:s.html),a=(0,eo.U)(e,(t=>t.maySendStateEvent(o.EventType.RoomTopic,e.client.getSafeUserId()))),c=e=>{e.preventDefault(),e.stopPropagation(),S.A.dispatch({action:"open_room_settings"})};if(!r&&!a)return null;if(!r)return i.createElement(ku.s,{as:"section",direction:"column",justify:"center",gap:"var(--cpd-space-2x)",className:"mx_RoomSummaryCard_topic"},i.createElement(Ou,{flex:"1"},i.createElement(Qd.N,{kind:"primary",onClick:c},i.createElement(pl.E,{size:"sm",weight:"regular"},(0,l._t)("right_panel|add_topic")))));const d=t?i.createElement(zn.XZ,null,r):r;return i.createElement(ku.s,{as:"section",direction:"column",justify:"center",gap:"var(--cpd-space-2x)",className:dt()("mx_RoomSummaryCard_topic",{mx_RoomSummaryCard_topic_collapsed:!t})},i.createElement(Ou,{flex:"1",className:"mx_RoomSummaryCard_topic_container"},i.createElement(pl.E,{size:"sm",weight:"regular",onClick:e=>{e.target instanceof HTMLAnchorElement&&Uu(e)}},d),i.createElement(hl.K,{className:"mx_RoomSummaryCard_topic_chevron",size:"24px",onClick:()=>n(!t)},i.createElement(_m.A,null))),t&&a&&i.createElement(Ou,{flex:"1",className:"mx_RoomSummaryCard_topic_edit"},i.createElement(Qd.N,{kind:"primary",onClick:c},i.createElement(pl.E,{size:"sm",weight:"regular"},(0,l._t)("action|edit")))))},eh=({room:e,permalinkCreator:t,onSearchChange:n,onSearchCancel:r,focusRoomSearch:a})=>{const c=(0,i.useContext)(Hn.Ay),d=(0,fm.g)(c,e),m=(0,i.useContext)(jt.Ay),u=m.e2eStatus,h=(0,Vu.j)(e),p=(0,eo.U)(e),g=((e,t)=>{const[n,s]=(0,i.useState)((()=>{return null==(n=e.getAccountData(t))?void 0:n.getContent();var n})),r=(0,i.useCallback)((e=>{e.getType()===t&&s(e.getContent())}),[t]);return(0,ci.YK)(e,o.ClientEvent.AccountData,r),n||{}})(e.client,o.EventType.Direct),[v,_]=(0,i.useState)(!1);(0,i.useEffect)((()=>{for(const[,n]of Object.entries(g)){var t;if(n.includes(null!==(t=null==e?void 0:e.roomId)&&void 0!==t?t:"")){_(!0);break}}}),[e,g]);const f=(0,i.useRef)(null);(0,Ws.F)(S.A,(e=>{var t;e.action===W.r.FocusMessageSearch&&(null===(t=f.current)||void 0===t||t.focus())})),((e,t)=>{const n=(0,i.useRef)(e);(0,i.useEffect)((()=>{n.current=e}),[e]);const s=(0,i.useRef)(null);(0,i.useEffect)((()=>{null!==s.current&&n.current(...s.current),s.current=t}),t)})((e=>{e===jt.Ae.Search&&m.timelineRenderingType!==jt.Ae.Search&&f.current&&(f.current.value="")}),[m.timelineRenderingType]);const E=e.getCanonicalAlias()||e.getAltAliases()[0]||"",y=i.createElement("header",{className:"mx_RoomSummaryCard_container"},i.createElement(Kt.A,{room:e,size:"80px",viewAvatarOnClick:!0}),i.createElement(Os,{room:e},(e=>i.createElement(Xd.D,{as:"h1",size:"md",weight:"semibold",className:"mx_RoomSummaryCard_roomName text-primary",title:e},e))),i.createElement(pl.E,{as:"div",size:"sm",weight:"semibold",className:"mx_RoomSummaryCard_alias text-secondary",title:E},E),i.createElement(ku.s,{as:"section",justify:"center",gap:"var(--cpd-space-2x)",className:"mx_RoomSummaryCard_badges"},!v&&p.getJoinRule()===o.JoinRule.Public&&i.createElement(Zd.E,{kind:"grey"},i.createElement(gm.A,{width:"1em"}),(0,l._t)("common|public_room")),d&&u!==bm.z.Warning&&i.createElement(Zd.E,{kind:"green"},i.createElement(hm.A,{width:"1em"}),(0,l._t)("common|encrypted")),!u&&i.createElement(Zd.E,{kind:"grey"},i.createElement(pm.A,{width:"1em"}),(0,l._t)("common|unencrypted")),u===bm.z.Warning&&i.createElement(Zd.E,{kind:"red"},i.createElement(vm.A,{width:"1em"}),(0,l._t)("common|not_trusted"))),i.createElement(Zu,{room:e})),b=zu(e).length,w=(0,ci.dF)(Gl.Ay.instance,Gl.lA,(()=>Gl.Ay.instance.getTagsForRoom(e))),A=(0,ci.dF)(e,o.RoomStateEvent.Update,(()=>Iu(e))),C=w.includes(Jr.zO.Favourite),x=n&&i.createElement(em.b,{className:"mx_RoomSummaryCard_search",onSubmit:e=>e.preventDefault()},i.createElement(tm.v,{placeholder:(0,l._t)("room|search|placeholder"),name:"room_message_search",onChange:n,className:"mx_no_textinput",ref:f,autoFocus:a,onKeyDown:e=>{f.current&&e.key===Tn.Uz.ESCAPE&&(f.current.value="",null==r||r())}}));return i.createElement(Em.A,{id:"room-summary-panel",className:"mx_RoomSummaryCard",ariaLabelledBy:"room-summary-panel-tab",role:"tabpanel",header:x},y,i.createElement(nm.w,null),i.createElement("div",{role:"menubar","aria-orientation":"vertical"},i.createElement(im.X,{Icon:sm.A,label:(0,l._t)("room|context_menu|favourite"),checked:C,onSelect:()=>function(e,t){if(t===Jr.zO.Favourite||t===Jr.zO.LowPriority){const n=t===Jr.zO.Favourite?Jr.zO.LowPriority:Jr.zO.Favourite,i=Gl.Ay.instance.getTagsForRoom(e).includes(t),s=i?t:n,o=i?null:t;S.A.dispatch(Ru.A.tagRoom(e.client,e,s,o,0))}else s.v.warn(`Unexpected tag ${t} applied to ${e.roomId}`)}(e,Jr.zO.Favourite)}),i.createElement(ul.D,{Icon:om.A,label:(0,l._t)("action|invite"),disabled:!A,onSelect:()=>Tu(e)}),i.createElement(nm.w,null),i.createElement(ul.D,{Icon:mm.A,label:(0,l._t)("common|people"),onSelect:Gu}),i.createElement(ul.D,{Icon:Zt.A,label:(0,l._t)("common|threads"),onSelect:$u}),!h&&i.createElement(i.Fragment,null,i.createElement(Rl,{feature:"pinningMessageList",header:(0,l._t)("right_panel|pinned_messages|release_announcement|title"),description:(0,l._t)("right_panel|pinned_messages|release_announcement|description"),closeLabel:(0,l._t)("right_panel|pinned_messages|release_announcement|close"),placement:"top"},i.createElement("div",null,i.createElement(ul.D,{Icon:tn.A,label:(0,l._t)("right_panel|pinned_messages_button"),onSelect:Qu},i.createElement(pl.E,{as:"span",size:"sm"},b)))),i.createElement(ul.D,{Icon:cm.A,label:(0,l._t)("right_panel|files_button"),onSelect:qu}),i.createElement(ul.D,{Icon:dm.A,label:(0,l._t)("right_panel|extensions_button"),onSelect:Yu})),i.createElement(nm.w,null),i.createElement(ul.D,{Icon:Oi.A,label:(0,l._t)("action|copy_link"),onSelect:()=>{k.Ay.createDialog(ym.A,{target:e})}}),!h&&i.createElement(i.Fragment,null,i.createElement(ul.D,{Icon:um.A,label:(0,l._t)("right_panel|polls_button"),onSelect:()=>{k.Ay.createDialog(xu,{room:e,matrixClient:c,permalinkCreator:t})}}),i.createElement(ul.D,{Icon:am.A,label:(0,l._t)("export_chat|title"),onSelect:async()=>{k.Ay.createDialog(Au,{room:e})}})),i.createElement(ul.D,{Icon:rm.A,label:(0,l._t)("common|settings"),onSelect:Xu}),i.createElement(nm.w,null),i.createElement(ul.D,{Icon:lm.A,kind:"critical",label:(0,l._t)("action|leave_room"),onSelect:()=>{S.A.dispatch({action:"leave_room",room_id:e.roomId})}})))};var th=n("./src/utils/WidgetUtils.ts"),nh=n("./node_modules/matrix-widget-api/lib/index.js"),ih=n("./node_modules/@matrix-org/react-sdk-module-api/lib/lifecycles/WidgetLifecycle.js"),sh=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/collapse.js"),oh=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/expand.js"),rh=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/minus.js"),ah=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/help.js"),lh=n("./src/utils/UrlUtils.ts");function ch(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}class dh extends i.Component{constructor(e){super(e);const t=this.parseWidgetUrl(),n=_.J.safeGet().getRoom(this.props.roomId);let i=null;n&&(i=n.getMember(this.props.creatorUserId)),this.state=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ch(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ch(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({roomMember:i},t)}parseWidgetUrl(){const e=(0,lh.Dl)(this.props.url);if(th.A.isScalarUrl(this.props.url)&&e.searchParams.has("url")){const t=(0,lh.Dl)(e.searchParams.get("url"));return{widgetDomain:t.host||t.hostname,isWrapped:!0}}return{widgetDomain:e.host||e.hostname,isWrapped:!1}}render(){const e=c.Ay.get().brand,t=this.state.roomMember?this.state.roomMember.name:this.props.creatorUserId,n=t===this.props.creatorUserId?null:this.props.creatorUserId,s=this.state.roomMember?i.createElement(Mt.A,{member:this.state.roomMember,size:"38px"}):i.createElement(os.A,{name:this.props.creatorUserId,size:"38px"}),o=i.createElement(Et.m,{label:(0,l._t)("analytics|shared_data_heading"),caption:i.createElement("ul",null,i.createElement("li",null,(0,l._t)("widget|shared_data_name")),i.createElement("li",null,(0,l._t)("widget|shared_data_avatar")),i.createElement("li",null,(0,l._t)("widget|shared_data_mxid")),i.createElement("li",null,(0,l._t)("widget|shared_data_device_id")),i.createElement("li",null,(0,l._t)("widget|shared_data_theme")),i.createElement("li",null,(0,l._t)("widget|shared_data_lang")),i.createElement("li",null,(0,l._t)("widget|shared_data_url",{brand:e})),i.createElement("li",null,(0,l._t)("widget|shared_data_room_id")),i.createElement("li",null,(0,l._t)("widget|shared_data_widget_id")))},i.createElement("div",{className:"mx_TextWithTooltip_target mx_TextWithTooltip_target--helpIcon"},i.createElement(ah.A,{className:"mx_Icon mx_Icon_12"}))),r=this.state.isWrapped?(0,l._t)("widget|shared_data_warning_im",{widgetDomain:this.state.widgetDomain},{helpIcon:()=>o}):(0,l._t)("widget|shared_data_warning",{widgetDomain:this.state.widgetDomain},{helpIcon:()=>o}),a=this.props.isRoomEncrypted?(0,l._t)("widget|unencrypted_warning"):null;return i.createElement("div",{className:"mx_AppPermission"},i.createElement("div",{className:"mx_AppPermission_content"},i.createElement("div",{className:"mx_AppPermission_content_bolder"},(0,l._t)("widget|added_by")),i.createElement("div",null,s,i.createElement(Ql.A,{size:"4"},t),i.createElement("div",null,n)),i.createElement("div",null,r),i.createElement("div",null,(0,l._t)("widget|cookie_warning")," ",a),i.createElement("div",null,i.createElement(ie.A,{kind:"primary_sm",onClick:this.props.onPermissionGranted},(0,l._t)("action|continue")))))}}(0,v.A)(dh,"defaultProps",{onPermissionGranted:()=>{}});var mh=n("./res/img/warning.svg");const uh=e=>i.createElement("div",{className:"mx_AppWarning"},i.createElement("div",null,i.createElement("img",{src:mh.A,alt:""})),i.createElement("div",null,i.createElement("span",null,e.errorMsg||"Error")));function hh(e){const t=document.createElement("div");return t.id=e,function(){let e=document.getElementById("mx_PersistedElement_container");return e||(e=document.createElement("div"),e.id="mx_PersistedElement_container",document.body.appendChild(e)),e}().appendChild(t),t}class ph extends i.Component{constructor(e){super(e),(0,v.A)(this,"resizeObserver",void 0),(0,v.A)(this,"dispatcherRef",void 0),(0,v.A)(this,"childContainer",void 0),(0,v.A)(this,"child",void 0),(0,v.A)(this,"collectChildContainer",(e=>{this.childContainer&&this.resizeObserver.unobserve(this.childContainer),this.childContainer=e,e&&this.resizeObserver.observe(e)})),(0,v.A)(this,"collectChild",(e=>{this.child=e,this.updateChild()})),(0,v.A)(this,"onAction",(e=>{"timeline_resize"===e.action?this.repositionChild():"logout"===e.action&&ph.destroyElement(this.props.persistKey)})),(0,v.A)(this,"repositionChild",(()=>{this.updateChildPosition(this.child,this.childContainer)})),this.resizeObserver=new ResizeObserver(this.repositionChild),this.props.moveRef&&(this.props.moveRef.current=this.repositionChild)}static destroyElement(e){const t=ph.rootMap[e];t&&(t[0].unmount(),t[1].remove()),delete ph.rootMap[e]}static isMounted(e){return Boolean(ph.rootMap[e])}componentDidMount(){window.addEventListener("resize",this.repositionChild),this.dispatcherRef=S.A.register(this.onAction),this.updateChild(),this.renderApp()}componentDidUpdate(){this.updateChild(),this.renderApp()}componentWillUnmount(){this.updateChildVisibility(this.child,!1),this.resizeObserver.disconnect(),window.removeEventListener("resize",this.repositionChild),S.A.unregister(this.dispatcherRef)}updateChild(){this.updateChildPosition(this.child,this.childContainer),this.updateChildVisibility(this.child,!0)}renderApp(){const e=i.createElement(i.StrictMode,null,i.createElement(Hn.Ay.Provider,{value:_.J.safeGet()},i.createElement(hr.B,null,i.createElement("div",{ref:this.collectChild,style:this.props.style},this.props.children))));let t=ph.rootMap[this.props.persistKey];if(!t){const e=hh("mx_persistedElement_"+this.props.persistKey);t=[(0,km.H)(e),e],ph.rootMap[this.props.persistKey]=t}t[0].render(e)}updateChildVisibility(e,t=!1){e&&(e.style.display=t?"block":"none")}updateChildPosition(e,t){if(!e||!t)return;const n=t.getBoundingClientRect();Object.assign(e.style,{zIndex:(0,ur.hX)(this.props.zIndex)?9:this.props.zIndex,position:"absolute",top:"0",left:"0",transform:`translateX(${n.left}px) translateY(${n.top}px)`,width:n.width+"px",height:n.height+"px"})}render(){return i.createElement("div",{ref:this.collectChildContainer})}}(0,v.A)(ph,"rootMap",{});var gh=n("./src/widgets/WidgetType.ts");var vh=n("./src/stores/widgets/WidgetPermissionStore.ts");class _h extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,"onAllow",(()=>{this.onPermissionSelection(!0)})),(0,v.A)(this,"onDeny",(()=>{this.onPermissionSelection(!1)})),(0,v.A)(this,"onRememberSelectionChange",(e=>{this.setState({rememberSelection:e})})),this.state={rememberSelection:!1}}onPermissionSelection(e){this.state.rememberSelection&&(s.v.log(`Remembering ${this.props.widget.id} as allowed=${e} for OpenID`),X.M.instance.widgetPermissionStore.setOIDCState(this.props.widget,this.props.widgetKind,this.props.inRoomId,e?vh.R.Allowed:vh.R.Denied)),this.props.onFinished(e)}render(){return i.createElement(J.A,{className:"mx_WidgetOpenIDPermissionsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:(0,l._t)("widget|open_id_permissions_dialog|title")},i.createElement("div",{className:"mx_WidgetOpenIDPermissionsDialog_content"},i.createElement("p",null,(0,l._t)("widget|open_id_permissions_dialog|starting_text")),i.createElement("p",{className:"text-muted"},this.props.widget.templateUrl.split("?")[0].split("#")[0])),i.createElement(ot.A,{primaryButton:(0,l._t)("action|continue"),onPrimaryButtonClick:this.onAllow,onCancel:this.onDeny,additive:i.createElement(Qs.A,{value:this.state.rememberSelection,toggleInFront:!0,onChange:this.onRememberSelectionChange,label:(0,l._t)("widget|open_id_permissions_dialog|remember_selection")})}))}}let fh=function(e){return e.CanChangeViewedRoom="io.element.view_room",e.RequiresClient="io.element.requires_client",e}({});var Eh=n("./src/components/views/elements/TextWithTooltip.tsx");const yh="generic";class bh{static bylineFor(e){return e.kind===nh.EventKind.State?e.keyStr?(0,l._t)("widget|capability|byline_state_key",{stateKey:e.keyStr}):(0,l._t)("widget|capability|byline_empty_state_key"):null}static for(e,t){if(bh.simpleCaps[e]){const n=bh.simpleCaps[e];if(n[t])return{primary:(0,l._t)(n[t])};if(n[yh])return{primary:(0,l._t)(n[yh])}}if((0,nh.isTimelineCapability)(e)){if((0,nh.isTimelineCapabilityFor)(e,nh.Symbols.AnyRoom))return{primary:(0,l._t)("widget|capability|any_room")};{const t=(0,nh.getTimelineRoomIDFromCapability)(e),n=_.J.safeGet().getRoom(t);return{primary:(0,l._t)("widget|capability|specific_room",{},{Room:()=>{var e;return n?i.createElement(Eh.A,{tooltip:null!==(e=n.getCanonicalAlias())&&void 0!==e?e:t},i.createElement("strong",null,n.name)):i.createElement("strong",null,i.createElement("code",null,t))}})}}}const[n]=nh.WidgetEventCapability.findEventCapabilities([e]);if(n){if(n.kind===nh.EventKind.Event&&n.eventType===o.EventType.RoomMessage)return bh.forRoomMessageCap(n,t);const e=n.kind===nh.EventKind.State?bh.stateSendRecvCaps:bh.nonStateSendRecvCaps;if(e[n.eventType]){const i=e[n.eventType],s=(null==i?void 0:i[t])||(null==i?void 0:i[yh]);if(null!=s&&s[n.direction])return{primary:(0,l._t)(s[n.direction])}}return t===nh.WidgetKind.Room?n.direction===nh.EventDirection.Send?{primary:(0,l._t)("widget|capability|send_event_type_this_room",{eventType:n.eventType},{b:e=>i.createElement("strong",null,e)}),byline:bh.bylineFor(n)}:{primary:(0,l._t)("widget|capability|see_event_type_sent_this_room",{eventType:n.eventType},{b:e=>i.createElement("strong",null,e)}),byline:bh.bylineFor(n)}:n.direction===nh.EventDirection.Send?{primary:(0,l._t)("widget|capability|send_event_type_active_room",{eventType:n.eventType},{b:e=>i.createElement("strong",null,e)}),byline:bh.bylineFor(n)}:{primary:(0,l._t)("widget|capability|see_event_type_sent_active_room",{eventType:n.eventType},{b:e=>i.createElement("strong",null,e)}),byline:bh.bylineFor(n)}}return{primary:(0,l._t)("widget|capability|capability",{capability:e},{b:e=>i.createElement("strong",null,e)})}}static forRoomMessageCap(e,t){if(!e.keyStr)return e.direction===nh.EventDirection.Send?{primary:t===nh.WidgetKind.Room?(0,l._t)("widget|capability|send_messages_this_room"):(0,l._t)("widget|capability|send_messages_active_room")}:{primary:t===nh.WidgetKind.Room?(0,l._t)("widget|capability|see_messages_sent_this_room"):(0,l._t)("widget|capability|see_messages_sent_active_room")};switch(e.keyStr){case o.MsgType.Text:return e.direction===nh.EventDirection.Send?{primary:t===nh.WidgetKind.Room?(0,l._t)("widget|capability|send_text_messages_this_room"):(0,l._t)("widget|capability|send_text_messages_active_room")}:{primary:t===nh.WidgetKind.Room?(0,l._t)("widget|capability|see_text_messages_sent_this_room"):(0,l._t)("widget|capability|see_text_messages_sent_active_room")};case o.MsgType.Emote:return e.direction===nh.EventDirection.Send?{primary:t===nh.WidgetKind.Room?(0,l._t)("widget|capability|send_emotes_this_room"):(0,l._t)("widget|capability|send_emotes_active_room")}:{primary:t===nh.WidgetKind.Room?(0,l._t)("widget|capability|see_sent_emotes_this_room"):(0,l._t)("widget|capability|see_sent_emotes_active_room")};case o.MsgType.Image:return e.direction===nh.EventDirection.Send?{primary:t===nh.WidgetKind.Room?(0,l._t)("widget|capability|send_images_this_room"):(0,l._t)("widget|capability|send_images_active_room")}:{primary:t===nh.WidgetKind.Room?(0,l._t)("widget|capability|see_images_sent_this_room"):(0,l._t)("widget|capability|see_images_sent_active_room")};case o.MsgType.Video:return e.direction===nh.EventDirection.Send?{primary:t===nh.WidgetKind.Room?(0,l._t)("widget|capability|send_videos_this_room"):(0,l._t)("widget|capability|send_videos_active_room")}:{primary:t===nh.WidgetKind.Room?(0,l._t)("widget|capability|see_videos_sent_this_room"):(0,l._t)("widget|capability|see_videos_sent_active_room")};case o.MsgType.File:return e.direction===nh.EventDirection.Send?{primary:t===nh.WidgetKind.Room?(0,l._t)("widget|capability|send_files_this_room"):(0,l._t)("widget|capability|send_files_active_room")}:{primary:t===nh.WidgetKind.Room?(0,l._t)("widget|capability|see_sent_files_this_room"):(0,l._t)("widget|capability|see_sent_files_active_room")};default:{let n;return n=e.direction===nh.EventDirection.Send?t===nh.WidgetKind.Room?(0,l._t)("widget|capability|send_msgtype_this_room",{msgtype:e.keyStr},{b:e=>i.createElement("strong",null,e)}):(0,l._t)("widget|capability|send_msgtype_active_room",{msgtype:e.keyStr},{b:e=>i.createElement("strong",null,e)}):t===nh.WidgetKind.Room?(0,l._t)("widget|capability|see_msgtype_sent_this_room",{msgtype:e.keyStr},{b:e=>i.createElement("strong",null,e)}):(0,l._t)("widget|capability|see_msgtype_sent_active_room",{msgtype:e.keyStr},{b:e=>i.createElement("strong",null,e)}),{primary:n}}}}}(0,v.A)(bh,"simpleCaps",{[nh.MatrixCapabilities.AlwaysOnScreen]:{[nh.WidgetKind.Room]:(0,l.AO)("widget|capability|always_on_screen_viewing_another_room"),[yh]:(0,l.AO)("widget|capability|always_on_screen_generic")},[nh.MatrixCapabilities.StickerSending]:{[nh.WidgetKind.Room]:(0,l.AO)("widget|capability|send_stickers_this_room"),[yh]:(0,l.AO)("widget|capability|send_stickers_active_room")},[fh.CanChangeViewedRoom]:{[yh]:(0,l.AO)("widget|capability|switch_room")},[nh.MatrixCapabilities.MSC2931Navigate]:{[yh]:(0,l.AO)("widget|capability|switch_room_message_user")}}),(0,v.A)(bh,"stateSendRecvCaps",{[o.EventType.RoomTopic]:{[nh.WidgetKind.Room]:{[nh.EventDirection.Send]:(0,l.AO)("widget|capability|change_topic_this_room"),[nh.EventDirection.Receive]:(0,l.AO)("widget|capability|see_topic_change_this_room")},[yh]:{[nh.EventDirection.Send]:(0,l.AO)("widget|capability|change_topic_active_room"),[nh.EventDirection.Receive]:(0,l.AO)("widget|capability|see_topic_change_active_room")}},[o.EventType.RoomName]:{[nh.WidgetKind.Room]:{[nh.EventDirection.Send]:(0,l.AO)("widget|capability|change_name_this_room"),[nh.EventDirection.Receive]:(0,l.AO)("widget|capability|see_name_change_this_room")},[yh]:{[nh.EventDirection.Send]:(0,l.AO)("widget|capability|change_name_active_room"),[nh.EventDirection.Receive]:(0,l.AO)("widget|capability|see_name_change_active_room")}},[o.EventType.RoomAvatar]:{[nh.WidgetKind.Room]:{[nh.EventDirection.Send]:(0,l.AO)("widget|capability|change_avatar_this_room"),[nh.EventDirection.Receive]:(0,l.AO)("widget|capability|see_avatar_change_this_room")},[yh]:{[nh.EventDirection.Send]:(0,l.AO)("widget|capability|change_avatar_active_room"),[nh.EventDirection.Receive]:(0,l.AO)("widget|capability|see_avatar_change_active_room")}},[o.EventType.RoomMember]:{[nh.WidgetKind.Room]:{[nh.EventDirection.Send]:(0,l.AO)("widget|capability|remove_ban_invite_leave_this_room"),[nh.EventDirection.Receive]:(0,l.AO)("widget|capability|receive_membership_this_room")},[yh]:{[nh.EventDirection.Send]:(0,l.AO)("widget|capability|remove_ban_invite_leave_active_room"),[nh.EventDirection.Receive]:(0,l.AO)("widget|capability|receive_membership_active_room")}}}),(0,v.A)(bh,"nonStateSendRecvCaps",{[o.EventType.Sticker]:{[nh.WidgetKind.Room]:{[nh.EventDirection.Send]:(0,l.AO)("widget|capability|send_stickers_this_room_as_you"),[nh.EventDirection.Receive]:(0,l.AO)("widget|capability|see_sticker_posted_this_room")},[yh]:{[nh.EventDirection.Send]:(0,l.AO)("widget|capability|send_stickers_active_room_as_you"),[nh.EventDirection.Receive]:(0,l.AO)("widget|capability|see_sticker_posted_active_room")}}});class wh extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,"eventPermissionsMap",new Map),(0,v.A)(this,"onToggle",(e=>{const t=(0,$t.tn)(this.state.booleanStates);t[e]=!t[e],this.setState({booleanStates:t})})),(0,v.A)(this,"onRememberSelectionChange",(e=>{this.setState({rememberSelection:e})})),(0,v.A)(this,"onSubmit",(async()=>{this.closeAndTryRemember(Object.entries(this.state.booleanStates).filter((([e,t])=>t)).map((([e])=>e)))})),(0,v.A)(this,"onReject",(async()=>{this.closeAndTryRemember([])}));nh.WidgetEventCapability.findEventCapabilities(this.props.requestedCapabilities).forEach((e=>this.eventPermissionsMap.set(e.raw,e)));const t={};this.props.requestedCapabilities.forEach((e=>t[e]=!0)),this.state={booleanStates:t,rememberSelection:!0}}closeAndTryRemember(e){this.props.onFinished({approved:e,remember:this.state.rememberSelection})}render(){const e=Object.entries(this.state.booleanStates).sort((([e],[t])=>{const n=(0,nh.isTimelineCapability)(e),i=(0,nh.isTimelineCapability)(t);return n||i?n&&!i?1:!n&&i?-1:n&&i?(0,ur.aw)(e,t):0:(0,ur.aw)(e,t)})).map((([e,t],n)=>{const s=bh.for(e,this.props.widgetKind),o=s.byline?i.createElement("span",{className:"mx_WidgetCapabilitiesPromptDialog_byline"},s.byline):null;return i.createElement("div",{className:"mx_WidgetCapabilitiesPromptDialog_cap",key:e+n},i.createElement(Ms.A,{checked:t,onChange:()=>this.onToggle(e)},s.primary),o)}));return i.createElement(J.A,{className:"mx_WidgetCapabilitiesPromptDialog",onFinished:this.props.onFinished,title:(0,l._t)("widget|capabilities_dialog|title")},i.createElement("form",{onSubmit:this.onSubmit},i.createElement("div",{className:"mx_Dialog_content"},i.createElement("div",{className:"text-muted"},(0,l._t)("widget|capabilities_dialog|content_starting_text")),e,i.createElement(ot.A,{primaryButton:(0,l._t)("action|approve"),cancelButton:(0,l._t)("widget|capabilities_dialog|decline_all_permission"),onPrimaryButtonClick:this.onSubmit,onCancel:this.onReject,additive:i.createElement(Qs.A,{value:this.state.rememberSelection,toggleInFront:!0,onChange:this.onRememberSelectionChange,label:(0,l._t)("widget|capabilities_dialog|remember_Selection")})}))))}}const Sh={};var Ah=n("./src/effects/index.ts"),Ch=n("./src/effects/utils.ts"),xh=n("./src/utils/permalinks/navigator.ts");function kh(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}const Rh=({urls:e,username:t,credential:n})=>({uris:e,username:t,password:n});class Ih extends nh.WidgetDriver{constructor(e,t,n,i,s){var r;if(super(),(0,v.A)(this,"allowedCapabilities",void 0),this.forWidget=t,this.forWidgetKind=n,this.inRoomId=s,this.allowedCapabilities=new Set([...e,nh.MatrixCapabilities.Screenshots,fh.RequiresClient]),gh.x.JITSI.matches(this.forWidget.type)&&n===nh.WidgetKind.Room)this.allowedCapabilities.add(nh.MatrixCapabilities.AlwaysOnScreen);else if(gh.x.STICKERPICKER.matches(this.forWidget.type)&&n===nh.WidgetKind.Account){const e=nh.WidgetEventCapability.forRoomEvent(nh.EventDirection.Send,o.EventType.Sticker).raw;this.allowedCapabilities.add(nh.MatrixCapabilities.StickerSending),this.allowedCapabilities.add(e),this.allowedCapabilities.add("visibility")}else if(i&&new URL(null!==(r=c.Ay.get("element_call").url)&&void 0!==r?r:c.zY.element_call.url).origin===this.forWidget.origin){this.allowedCapabilities.add(nh.MatrixCapabilities.AlwaysOnScreen),this.allowedCapabilities.add(nh.MatrixCapabilities.MSC3846TurnServers),this.allowedCapabilities.add(`org.matrix.msc2762.timeline:${s}`),this.allowedCapabilities.add(nh.MatrixCapabilities.MSC4157SendDelayedEvent),this.allowedCapabilities.add(nh.MatrixCapabilities.MSC4157UpdateDelayedEvent),this.allowedCapabilities.add(nh.WidgetEventCapability.forStateEvent(nh.EventDirection.Receive,o.EventType.RoomMember).raw),this.allowedCapabilities.add(nh.WidgetEventCapability.forStateEvent(nh.EventDirection.Receive,"org.matrix.msc3401.call").raw),this.allowedCapabilities.add(nh.WidgetEventCapability.forStateEvent(nh.EventDirection.Receive,o.EventType.RoomEncryption).raw);const e=_.J.safeGet().getSafeUserId();this.allowedCapabilities.add(nh.WidgetEventCapability.forStateEvent(nh.EventDirection.Send,"org.matrix.msc3401.call.member",e).raw);const i=_.J.safeGet().getDeviceId();null!==i&&(this.allowedCapabilities.add(nh.WidgetEventCapability.forStateEvent(nh.EventDirection.Send,"org.matrix.msc3401.call.member",`_${e}_${i}`).raw),this.allowedCapabilities.add(nh.WidgetEventCapability.forStateEvent(nh.EventDirection.Send,"org.matrix.msc3401.call.member",`${e}_${i}`).raw)),this.allowedCapabilities.add(nh.WidgetEventCapability.forStateEvent(nh.EventDirection.Receive,"org.matrix.msc3401.call.member").raw),this.allowedCapabilities.add(nh.WidgetEventCapability.forStateEvent(nh.EventDirection.Receive,o.EventType.RoomCreate).raw);const r=["io.element.call.encryption_keys","org.matrix.rageshake_request",o.EventType.Reaction,o.EventType.RoomRedaction,"io.element.call.reaction"];for(const e of r)this.allowedCapabilities.add(nh.WidgetEventCapability.forRoomEvent(nh.EventDirection.Send,e).raw),this.allowedCapabilities.add(nh.WidgetEventCapability.forRoomEvent(nh.EventDirection.Receive,e).raw);const a=[o.EventType.CallInvite,o.EventType.CallCandidates,o.EventType.CallAnswer,o.EventType.CallHangup,o.EventType.CallReject,o.EventType.CallSelectAnswer,o.EventType.CallNegotiate,o.EventType.CallSDPStreamMetadataChanged,o.EventType.CallSDPStreamMetadataChangedPrefix,o.EventType.CallReplaces];for(const e of a)this.allowedCapabilities.add(nh.WidgetEventCapability.forToDeviceEvent(nh.EventDirection.Send,e).raw),this.allowedCapabilities.add(nh.WidgetEventCapability.forToDeviceEvent(nh.EventDirection.Receive,e).raw);X.M.instance.widgetPermissionStore.setOIDCState(t,n,s,vh.R.Allowed)}}async validateCapabilities(e){const t=(n=e,i=this.allowedCapabilities,(0,Z.ZQ)(Array.from(n),Array.from(i)));var n,i;const o=new Set(t.removed),r=new Set(this.allowedCapabilities);var a;let l;if((a=this.forWidget,JSON.parse(localStorage.getItem(`widget_${a.id}_approved_caps`)||"[]")).forEach((e=>{r.add(e),o.delete(e)})),Sh.preapproveCapabilities)l=await Sh.preapproveCapabilities(this.forWidget,e);else{const t={approvedCapabilities:void 0};f.r.instance.invoke(ih.Z.CapabilitiesRequest,t,this.forWidget,e),l=t.approvedCapabilities}l&&l.forEach((e=>{r.add(e),o.delete(e)}));let c=!1;if(o.size>0)try{var d;const[e]=await k.Ay.createDialog(wh,{requestedCapabilities:o,widget:this.forWidget,widgetKind:this.forWidgetKind}).finished;null==e||null===(d=e.approved)||void 0===d||d.forEach((e=>r.add(e))),c=!(null==e||!e.remember)}catch(e){s.v.error("Non-fatal error getting capabilities: ",e)}const m=new Set(function(e,t){return(0,Z.LY)(Array.from(e),Array.from(t))}(r,e));return c&&function(e,t){localStorage.setItem(`widget_${e.id}_approved_caps`,JSON.stringify(t))}(this.forWidget,Array.from(m)),m}async sendEvent(e,t,n=null,i=null){const s=_.J.get(),r=i||X.M.instance.roomViewStore.getRoomId();if(!s||!r)throw new Error("Not in a room or not attached to a client");let a;return null!==n?a=await s.sendStateEvent(r,e,t,n):e===o.EventType.RoomRedaction?a=await s.redactEvent(r,t.redacts):(a=await s.sendEvent(r,e,t),e===o.EventType.RoomMessage&&Ah.y.forEach((e=>{if((0,Ch._)(t,e.emojis)){var n;(null===(n=t["m.relates_to"])||void 0===n?void 0:n.rel_type)!==o.THREAD_RELATION_TYPE.name&&S.A.dispatch({action:`effects.${e.command}`})}}))),{roomId:r,eventId:a.event_id}}async sendDelayedEvent(e,t,n,i,s=null,o=null){const r=_.J.get(),a=o||X.M.instance.roomViewStore.getRoomId();if(!r||!a)throw new Error("Not in a room or not attached to a client");let l,c;if(null!==e)l=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?kh(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):kh(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({delay:e},null!==t&&{parent_delay_id:t});else{if(null===t)throw new Error("Must provide at least one of delay or parentDelayId");l={parent_delay_id:t}}return c=null!==s?await r._unstable_sendDelayedStateEvent(a,l,n,i,s):await r._unstable_sendDelayedEvent(a,l,null,n,i),{roomId:a,delayId:c.delay_id}}async updateDelayedEvent(e,t){const n=_.J.get();if(!n)throw new Error("Not in a room or not attached to a client");await n._unstable_updateDelayedEvent(e,t)}async sendToDevice(e,t,n){const i=_.J.safeGet();if(t){const t=i.getCrypto();if(!t)throw new Error("E2EE not enabled");const s={};for(const e of Object.keys(n)){const t=n[e];for(const n of Object.keys(t)){const i=t[n],o=JSON.stringify(i);s[o]=s[o]||[],s[o].push({userId:e,deviceId:n})}}await Promise.all(Object.entries(s).map((async([n,s])=>{const o=await t.encryptToDeviceMessages(e,s,JSON.parse(n));await i.queueToDevice(o)})))}else await i.queueToDevice({eventType:e,batch:Object.entries(n).flatMap((([e,t])=>Object.entries(t).map((([t,n])=>({userId:e,deviceId:t,payload:n})))))})}pickRooms(e){const t=_.J.get();if(!t)throw new Error("Not attached to a client");return(e?e.includes(nh.Symbols.AnyRoom)?t.getVisibleRooms(M.A.getValue("feature_dynamic_room_predecessors")):e.map((e=>t.getRoom(e))):[t.getRoom(X.M.instance.roomViewStore.getRoomId())]).filter((e=>!!e))}async readRoomEvents(e,t,n,i){n=n>0?Math.min(n,Number.MAX_SAFE_INTEGER):Number.MAX_SAFE_INTEGER;const s=this.pickRooms(i),r=[];for(const i of s){const s=[],a=i.getLiveTimeline().getEvents();for(let i=a.length-1;i>0&&!(s.length>=n);i--){const n=a[i];n.getType()!==e||n.isState()||e===o.EventType.RoomMessage&&t&&t!==n.getContent().msgtype||s.push(n)}s.forEach((e=>r.push(e.getEffectiveEvent())))}return r}async readStateEvents(e,t,n,i){n=n>0?Math.min(n,Number.MAX_SAFE_INTEGER):Number.MAX_SAFE_INTEGER;const s=this.pickRooms(i),o=[];for(const i of s){const s=[],r=i.currentState.events.get(e);if(r)if(""===t||t){const e=r.get(t);e&&s.push(e)}else s.push(...Array.from(r.values()));s.slice(0,n).forEach((e=>o.push(e.getEffectiveEvent())))}return o}async askOpenID(e){const t={approved:void 0};if(f.r.instance.invoke(ih.Z.IdentityRequest,t,this.forWidget),t.approved)return e.update({state:nh.OpenIDRequestState.Allowed,token:await _.J.safeGet().getOpenIdToken()});const n=X.M.instance.widgetPermissionStore.getOIDCState(this.forWidget,this.forWidgetKind,this.inRoomId),i=()=>_.J.safeGet().getOpenIdToken();return n===vh.R.Denied?e.update({state:nh.OpenIDRequestState.Blocked}):n===vh.R.Allowed?e.update({state:nh.OpenIDRequestState.Allowed,token:await i()}):(e.update({state:nh.OpenIDRequestState.PendingUserConfirmation}),void k.Ay.createDialog(_h,{widget:this.forWidget,widgetKind:this.forWidgetKind,inRoomId:this.inRoomId,onFinished:async t=>t?e.update({state:nh.OpenIDRequestState.Allowed,token:await i()}):e.update({state:nh.OpenIDRequestState.Blocked})}))}async navigate(e){(0,xh.O)(e)}async*getTurnServers(){const e=_.J.safeGet();if(!e.pollingTurnServers||!e.getTurnServers().length)return;let t,n;const i=([e])=>t(Rh(e)),s=(e,t)=>{t&&n(e)};e.on(o.ClientEvent.TurnServers,i),e.on(o.ClientEvent.TurnServersError,s);try{const i=e.getTurnServers()[0];for(yield Rh(i);;)yield await new Promise(((e,i)=>{t=e,n=i}))}finally{e.off(o.ClientEvent.TurnServers,i),e.off(o.ClientEvent.TurnServersError,s)}}async readEventRelations(e,t,n,i,s,o,r,a){var l,c;const d=_.J.safeGet(),m=a;if("string"!=typeof(t=null!==(l=null!==(c=t)&&void 0!==c?c:X.M.instance.roomViewStore.getRoomId())&&void 0!==l?l:void 0))throw new Error("Error while reading the current room");const{events:u,nextBatch:h,prevBatch:p}=await d.relations(t,e,null!=n?n:null,null!=i?i:null,{from:s,to:o,limit:r,dir:m});return{chunk:u.map((e=>e.getEffectiveEvent())),nextBatch:null!=h?h:void 0,prevBatch:null!=p?p:void 0}}async searchUserDirectory(e,t){const n=_.J.safeGet(),{limited:i,results:s}=await n.searchUserDirectory({term:e,limit:t});return{limited:i,results:s.map((e=>({userId:e.user_id,displayName:e.display_name,avatarUrl:e.avatar_url})))}}async getMediaConfig(){const e=_.J.safeGet();return await e.getMediaConfig()}async uploadFile(e){const t=_.J.safeGet();return{contentUri:(await t.uploadContent(e)).content_uri}}async downloadFile(e){const t=_.J.safeGet(),n=new Wn.$U({mxc:e},t),i=await n.downloadSource();return{file:await i.blob()}}processError(e){return e instanceof o.MatrixError?{matrix_api_error:e.asWidgetApiErrorData()}:void 0}}var Th=n("./src/stores/widgets/WidgetMessagingStore.ts"),Ph=n("./src/stores/widgets/ElementWidgetActions.ts");const Nh="io.element.web";function Dh(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Mh(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Dh(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Dh(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class Oh extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,"widget",void 0),(0,v.A)(this,"possibleButtons",void 0),(0,v.A)(this,"appFrame",i.createRef()),(0,v.A)(this,"state",{disabledButtonIds:(this.props.widgetDefinition.buttons||[]).filter((e=>e.disabled)).map((e=>e.id))}),(0,v.A)(this,"onReady",(()=>{var e;null===(e=this.state.messaging)||void 0===e||e.sendWidgetConfig(this.props.widgetDefinition)})),(0,v.A)(this,"onLoad",(()=>{this.state.messaging&&(this.state.messaging.once("ready",this.onReady),this.state.messaging.on(`action:${nh.WidgetApiFromWidgetAction.CloseModalWidget}`,this.onWidgetClose),this.state.messaging.on(`action:${nh.WidgetApiFromWidgetAction.SetModalButtonEnabled}`,this.onButtonEnableToggle))})),(0,v.A)(this,"onWidgetClose",(e=>{this.props.onFinished(!0,e.detail.data)})),(0,v.A)(this,"onButtonEnableToggle",(e=>{var t;e.preventDefault();var n;if(e.detail.data.button===nh.BuiltInModalButtonID.Close||!this.possibleButtons.includes(e.detail.data.button))return null===(n=this.state.messaging)||void 0===n?void 0:n.transport.reply(e.detail,{error:{message:"Invalid button"}});let i;if(e.detail.data.enabled)i=(0,Z.PF)(this.state.disabledButtonIds).filter((t=>t!==e.detail.data.button));else{const t=new Set(this.state.disabledButtonIds);t.add(e.detail.data.button),i=Array.from(t)}this.setState({disabledButtonIds:i}),null===(t=this.state.messaging)||void 0===t||t.transport.reply(e.detail,{})})),this.widget=new Hh(Mh(Mh({},this.props.widgetDefinition),{},{creatorUserId:_.J.safeGet().getSafeUserId(),id:`modal_${this.props.sourceWidgetId}`})),this.possibleButtons=(this.props.widgetDefinition.buttons||[]).map((e=>e.id))}componentDidMount(){const e=new Ih([],this.widget,nh.WidgetKind.Modal,!1),t=new nh.ClientWidgetApi(this.widget,this.appFrame.current,e);this.setState({messaging:t})}componentWillUnmount(){this.state.messaging&&(this.state.messaging.off("ready",this.onReady),this.state.messaging.off(`action:${nh.WidgetApiFromWidgetAction.CloseModalWidget}`,this.onWidgetClose),this.state.messaging.stop())}render(){var e,t,n;const s=this.widget.getCompleteUrl({widgetRoomId:this.props.widgetRoomId,currentUserId:_.J.safeGet().getSafeUserId(),userDisplayName:null!==(e=il.V.instance.displayName)&&void 0!==e?e:void 0,userHttpAvatarUrl:null!==(t=il.V.instance.getHttpAvatarUrl())&&void 0!==t?t:void 0,clientId:Nh,clientTheme:M.A.getValue("theme"),clientLanguage:(0,l.mf)(),baseUrl:_.J.safeGet().baseUrl}),o=new URL(s);o.searchParams.set("widgetId",this.widget.id),o.searchParams.set("parentUrl",window.location.href.split("#",2)[0]);const r=o.toString().replace(/%24/g,"$");let a;return this.props.widgetDefinition.buttons&&(a=this.props.widgetDefinition.buttons.slice(0,3).reverse().map((e=>{let t="secondary";switch(e.kind){case nh.ModalButtonKind.Primary:t="primary";break;case nh.ModalButtonKind.Secondary:t="primary_outline";break;case nh.ModalButtonKind.Danger:t="danger"}const n=this.state.disabledButtonIds.includes(e.id);return i.createElement(ie.A,{key:e.id,kind:t,onClick:()=>{var t;null===(t=this.state.messaging)||void 0===t||t.notifyModalWidgetButtonClicked(e.id)},disabled:n},e.label)}))),i.createElement(J.A,{title:this.props.widgetDefinition.name||(0,l._t)("widget|modal_title_default"),className:"mx_ModalWidgetDialog",contentId:"mx_Dialog_content",onFinished:this.props.onFinished},i.createElement("div",{className:"mx_ModalWidgetDialog_warning"},i.createElement(vm.A,{width:"16px",height:"16px"}),(0,l._t)("widget|modal_data_warning",{widgetDomain:o.hostname})),i.createElement("div",null,i.createElement("iframe",{title:null!==(n=this.widget.name)&&void 0!==n?n:void 0,ref:this.appFrame,sandbox:"allow-forms allow-scripts allow-same-origin",src:r,onLoad:this.onLoad})),i.createElement("div",{className:"mx_ModalWidgetDialog_buttons"},a))}}var Lh;function Uh(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Fh(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Uh(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Uh(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class Vh extends Ar.r{constructor(){super(S.A,{}),(0,v.A)(this,"modalInstance",null),(0,v.A)(this,"openSourceWidgetId",null),(0,v.A)(this,"openSourceWidgetRoomId",null),(0,v.A)(this,"canOpenModalWidget",(()=>!this.modalInstance)),(0,v.A)(this,"openModalWidget",((e,t,n)=>{this.modalInstance||(this.openSourceWidgetId=t.id,this.openSourceWidgetRoomId=null!=n?n:null,this.modalInstance=k.Ay.createDialog(Oh,{widgetDefinition:Fh({},e),widgetRoomId:n,sourceWidgetId:t.id,onFinished:(e,i)=>{this.closeModalWidget(t,n,e&&i?i:{"m.exited":!0}),this.openSourceWidgetId=null,this.openSourceWidgetRoomId=null,this.modalInstance=null}},void 0,!1,!0))})),(0,v.A)(this,"closeModalWidget",((e,t,n)=>{if(this.modalInstance&&this.openSourceWidgetId===e.id&&this.openSourceWidgetRoomId===t){this.openSourceWidgetId=null,this.openSourceWidgetRoomId=null,this.modalInstance.close(),this.modalInstance=null;const i=Th.c.instance.getMessaging(e,t);if(!i)return void s.v.error("No source widget messaging for modal widget");i.notifyModalWidgetClose(n)}}))}static get instance(){return Vh.internalInstance}async onAction(e){}}Lh=Vh,(0,v.A)(Vh,"internalInstance",(()=>{const e=new Lh;return e.start(),e})()),window.mxModalWidgetStore=Vh.instance;var Bh=n("./src/stores/WidgetStore.ts");const jh={};function Wh(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function zh(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Wh(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Wh(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class Hh extends nh.Widget{constructor(e){super(e),this.rawDefinition=e}get templateUrl(){var e;return gh.x.JITSI.matches(this.type)?th.A.getLocalJitsiWrapperUrl({forLocalRender:!0,auth:null===(e=super.rawData)||void 0===e?void 0:e.auth}):super.templateUrl}get popoutTemplateUrl(){var e;return gh.x.JITSI.matches(this.type)?th.A.getLocalJitsiWrapperUrl({forLocalRender:!1,auth:null===(e=super.rawData)||void 0===e?void 0:e.auth}):this.templateUrl}get rawData(){let e=super.rawData.conferenceId;if(void 0===e){e=new URL(super.templateUrl).searchParams.get("confId")}let t=super.rawData.domain;void 0===t&&(t="meet.element.io");let n=(new Dr.A).getEffectiveTheme();if(n.startsWith("custom-")){const e=(0,Da.TP)(n.slice(7));n=e.is_dark?"dark":"light"}return n=n.includes("light")?"light":"dark",zh(zh({},super.rawData),{},{theme:n,conferenceId:e,domain:t})}getCompleteUrl(e,t=!1){return(0,nh.runTemplate)(t?this.popoutTemplateUrl:this.templateUrl,zh(zh({},this.rawDefinition),{},{data:this.rawData}),e)}}class Kh extends q.EventEmitter{constructor(e){var t;super(),(0,v.A)(this,"client",void 0),(0,v.A)(this,"messaging",null),(0,v.A)(this,"mockWidget",void 0),(0,v.A)(this,"scalarToken",void 0),(0,v.A)(this,"roomId",void 0),(0,v.A)(this,"kind",void 0),(0,v.A)(this,"virtual",void 0),(0,v.A)(this,"readUpToMap",{}),(0,v.A)(this,"stickyPromise",void 0),(0,v.A)(this,"eventsToFeed",new WeakSet),(0,v.A)(this,"onOpenModal",(async e=>{var t,n;(e.preventDefault(),Vh.instance.canOpenModalWidget())?(Vh.instance.openModalWidget(e.detail.data,this.mockWidget,this.roomId),null===(t=this.messaging)||void 0===t||t.transport.reply(e.detail,{})):null===(n=this.messaging)||void 0===n||n.transport.reply(e.detail,{error:{message:"Unable to open modal at this time"}})})),(0,v.A)(this,"onEvent",(e=>{this.client.decryptEventIfNeeded(e),this.feedEvent(e)})),(0,v.A)(this,"onEventDecrypted",(e=>{this.feedEvent(e)})),(0,v.A)(this,"onToDeviceEvent",(async e=>{var t;await this.client.decryptEventIfNeeded(e),e.isDecryptionFailure()||await(null===(t=this.messaging)||void 0===t?void 0:t.feedToDevice(e.getEffectiveEvent(),e.isEncrypted()))})),this.appTileProps=e,this.client=_.J.safeGet();let n=e.app;n.creatorUserId||(n=(0,$t.tn)(n),n.creatorUserId=this.client.getUserId()),this.mockWidget=new Hh(n),this.roomId=null===(t=e.room)||void 0===t?void 0:t.roomId,this.kind=e.userWidget?nh.WidgetKind.Account:nh.WidgetKind.Room,this.virtual=(0,Bh.Sw)(n)&&void 0===n.eventId,this.stickyPromise=e.stickyPromise}get eventListenerRoomId(){return this.roomId?this.roomId:X.M.instance.roomViewStore.getRoomId()}get widgetApi(){return this.messaging}get embedUrl(){return this.runUrlTemplate({asPopout:!1})}get popoutUrl(){return this.runUrlTemplate({asPopout:!0})}runUrlTemplate(e={asPopout:!1}){var t,n,i,s,o;const r=null!==(t=null==jh||null===(n=jh.provideVariables)||void 0===n?void 0:n.call(jh))&&void 0!==t?t:{},a={widgetRoomId:this.roomId,currentUserId:this.client.getUserId(),userDisplayName:null!==(i=il.V.instance.displayName)&&void 0!==i?i:void 0,userHttpAvatarUrl:null!==(s=il.V.instance.getHttpAvatarUrl())&&void 0!==s?s:void 0,clientId:Nh,clientTheme:M.A.getValue("theme"),clientLanguage:(0,l.mf)(),deviceId:null!==(o=this.client.getDeviceId())&&void 0!==o?o:void 0,baseUrl:this.client.baseUrl},c=this.mockWidget.getCompleteUrl(Object.assign(a,r),null==e?void 0:e.asPopout),d=new URL(c);return null!=e&&e.asPopout||(d.searchParams.set("widgetId",this.mockWidget.id),d.searchParams.set("parentUrl",window.location.href.split("#",2)[0]),this.scalarToken&&d.searchParams.set("scalar_token",this.scalarToken)),d.toString().replace(/%24/g,"$")}get started(){return!!this.messaging}startMessaging(e){if(this.started)return;const t=this.appTileProps.whitelistCapabilities||[],n=new Ih(t,this.mockWidget,this.kind,this.virtual,this.roomId);this.messaging=new nh.ClientWidgetApi(this.mockWidget,e,n),this.messaging.on("preparing",(()=>this.emit("preparing"))),this.messaging.on("error:preparing",(e=>this.emit("error:preparing",e))),this.messaging.on("ready",(()=>{Th.c.instance.storeMessaging(this.mockWidget,this.roomId,this.messaging),this.emit("ready")})),this.messaging.on("capabilitiesNotified",(()=>this.emit("capabilitiesNotified"))),this.messaging.on(`action:${nh.WidgetApiFromWidgetAction.OpenModalWidget}`,this.onOpenModal),this.messaging.on(`action:${Ph.k.JoinCall}`,(()=>{var e;null===(e=X.M.instance.voiceBroadcastRecordingsStore.getCurrent())||void 0===e||e.pause()})),this.messaging.on(`action:${Ph.k.ViewRoom}`,(e=>{var t;e.preventDefault();const n=(e.detail.data||{}).room_id;var i,s;return n?null!==(t=this.messaging)&&void 0!==t&&t.hasCapability(fh.CanChangeViewedRoom)?(S.A.dispatch({action:W.r.ViewRoom,room_id:n,metricsTrigger:"Widget"}),void this.messaging.transport.reply(e.detail,{})):null===(s=this.messaging)||void 0===s?void 0:s.transport.reply(e.detail,{error:{message:"This widget does not have permission for this action (denied)."}}):null===(i=this.messaging)||void 0===i?void 0:i.transport.reply(e.detail,{error:{message:"Room ID not supplied."}})}));for(const e of this.client.getRooms()){var i;const t=(null===(i=e.getLiveTimeline())||void 0===i?void 0:i.getEvents())||[],n=t[t.length-1];n&&(this.readUpToMap[e.roomId]=n.getId())}this.client.on(o.ClientEvent.Event,this.onEvent),this.client.on(o.MatrixEventEvent.Decrypted,this.onEventDecrypted),this.client.on(o.ClientEvent.ToDeviceEvent,this.onToDeviceEvent),this.messaging.on(`action:${nh.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen}`,(async e=>{var t,n;null!==(t=this.messaging)&&void 0!==t&&t.hasCapability(nh.MatrixCapabilities.AlwaysOnScreen)&&(e.preventDefault(),e.detail.data.value&&this.stickyPromise&&await this.stickyPromise(),R.A.instance.setWidgetPersistence(this.mockWidget.id,null!==(n=this.roomId)&&void 0!==n?n:null,e.detail.data.value),this.messaging.transport.reply(e.detail,{}))})),this.messaging.on(`action:${nh.WidgetApiFromWidgetAction.SendSticker}`,(e=>{var t;null!==(t=this.messaging)&&void 0!==t&&t.hasCapability(nh.MatrixCapabilities.StickerSending)&&(e.preventDefault(),this.messaging.transport.reply(e.detail,{}),S.A.dispatch({action:"m.sticker",data:e.detail.data,widgetId:this.mockWidget.id}))})),gh.x.STICKERPICKER.matches(this.mockWidget.type)&&this.messaging.on(`action:${Ph.k.OpenIntegrationManager}`,(e=>{var t,n;e.preventDefault(),null===(t=this.messaging)||void 0===t||t.transport.reply(e.detail,{}),S.A.dispatch({action:"stickerpicker_close"});const i=e.detail.data,s=null==i?void 0:i.integType,o=null==i?void 0:i.integId,r=X.M.instance.roomViewStore.getRoomId(),a=r?this.client.getRoom(r):void 0;a&&(null===(n=U.J.sharedInstance())||void 0===n||null===(n=n.getPrimaryManager())||void 0===n||n.open(a,`type_${s}`,o))})),gh.x.JITSI.matches(this.mockWidget.type)&&this.messaging.on(`action:${Ph.k.HangupCall}`,(e=>{var t,n;e.preventDefault(),null!==(t=e.detail.data)&&void 0!==t&&t.errorMessage&&k.Ay.createDialog(nt.A,{title:(0,l._t)("widget|error_hangup_title"),description:(0,l._t)("widget|error_hangup_description",{message:e.detail.data.errorMessage})}),null===(n=this.messaging)||void 0===n||n.transport.reply(e.detail,{})}))}async prepare(){var e,t;if(await(null!==(e=null==jh||null===(t=jh.isReady)||void 0===t?void 0:t.call(jh))&&void 0!==e?e:Promise.resolve()),this.scalarToken)return;const n=Th.c.instance.getMessaging(this.mockWidget,this.roomId);n&&(this.messaging=n);try{if(th.A.isScalarUrl(this.mockWidget.templateUrl)){const e=U.J.sharedInstance();if(e.hasManager()){const t=e.getPrimaryManager();if(t&&th.A.isScalarUrl(t.apiUrl)){const e=t.getScalarClient();this.scalarToken=await e.getScalarToken()}}}}catch(e){s.v.error("Error preparing widget communications: ",e)}}stopMessaging(e={forceDestroy:!1}){var t;null!=e&&e.forceDestroy||!R.A.instance.getWidgetPersistence(this.mockWidget.id,null!==(t=this.roomId)&&void 0!==t?t:null)?this.started&&(Th.c.instance.stopMessaging(this.mockWidget,this.roomId),this.messaging=null,this.client.off(o.ClientEvent.Event,this.onEvent),this.client.off(o.MatrixEventEvent.Decrypted,this.onEventDecrypted),this.client.off(o.ClientEvent.ToDeviceEvent,this.onToDeviceEvent)):s.v.log("Skipping destroy - persistent widget")}relatesToUnknown(e){if(!e.relationEventId||e.replyEventId)return!1;const t=this.client.getRoom(e.getRoomId());return null===t||!t.findEventById(e.relationEventId)}isFromInvite(e){const t=this.client.getRoom(e.getRoomId());return(null==t?void 0:t.getMyMembership())===ut.O.Invite}advanceReadUpToMarker(e){const t=e.getId();if(void 0===t)return!1;const n=e.getRoomId();if(void 0===n)return!1;const i=this.client.getRoom(n);if(null===i)return!1;const s=this.readUpToMap[e.getRoomId()];if(!s)return this.readUpToMap[n]=t,!0;if(s===t)return!1;const o=i.getLiveTimeline(),r=(0,Z.PF)(o.getEvents()).reverse().slice(0,100);for(const i of r){if(i.getId()===s)return!1;if(i.getId()===e.getId())return this.readUpToMap[n]=t,!0}return!1}feedEvent(e){if(null!==this.messaging&&(this.eventsToFeed.delete(e)||this.relatesToUnknown(e)||this.isFromInvite(e)||this.advanceReadUpToMarker(e)))if(e.isBeingDecrypted()||e.isDecryptionFailure())this.eventsToFeed.add(e);else{const t=e.getEffectiveEvent();this.messaging.feedEvent(t,this.eventListenerRoomId).catch((e=>{s.v.error("Error sending event to widget: ",e)}))}}}var Jh=n("./src/stores/widgets/WidgetLayoutStore.ts");function Gh(){return c.Ay.get("audio_stream_url")}async function $h(e,t,n){const i=await async function(e,t){const n=await e.getOpenIdToken(),i=Gh()+"/createStream",s=await window.fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({room_id:t,openid_token:n})});return(await s.json()).stream_id}(e,n);await t.transport.send(Ph.k.StartLiveStream,{rtmpStreamKey:"rtmp://audiostream.dummy/"+i})}const qh=["onFinished","app","userWidget","onDeleteClick","onEditClick","showUnpin"],Yh=e=>!!Gh()&&gh.x.JITSI.matches(e.type),Qh=(e,t)=>t&&th.A.isManagedByManager(e),Xh=(e,t,n,i)=>{var s;const o=(0,Bh.Sw)(n)&&void 0!==n.eventId&&null!==(s=M.A.getValue("allowedWidgets",t)[n.eventId])&&void 0!==s&&s||n.creatorUserId===(null==e?void 0:e.getUserId()),r=gh.x.JITSI.matches(n.type);return!i&&!r&&o},Zh=(e,t)=>!!t||e,ep=e=>M.A.getValue("enableWidgetScreenshots")&&!(null==e||!e.hasCapability(nh.MatrixCapabilities.Screenshots)),tp=(e,t,n)=>{if(!n)return[!1,!1];const i=t?Jh.aK.instance.getContainerWidgets(t,Jh.mc.Top):[],s=i.findIndex((t=>t.id===e.id));return[s>0,s<i.length-1]},np=(e,t,n,i,s,o)=>{const r=i||th.A.canUserModifyWidgets(e,null==t?void 0:t.roomId),a=Th.c.instance.getMessagingForUid(th.A.getWidgetUid(n));return Yh(n)||Qh(n,r)||Xh(e,null==t?void 0:t.roomId,n,i)||Zh(r,o)||ep(a)||tp(n,t,s).some(Boolean)},ip=e=>{let{onFinished:t,app:n,userWidget:o,onDeleteClick:r,onEditClick:a,showUnpin:c}=e,d=(0,g.A)(e,qh);const m=(0,i.useContext)(Hn.Ay),{room:u,roomId:h}=(0,i.useContext)(jt.Ay),p=Th.c.instance.getMessagingForUid(th.A.getWidgetUid(n)),v=o||th.A.canUserModifyWidgets(m,h);let _,E,y,b,w;if(h&&Yh(n)){const e=async()=>{try{await $h(m,p,h)}catch(e){s.v.error("Failed to start livestream",e);const t=e instanceof Error?e.message:(0,l._t)("widget|error_unable_start_audio_stream_description");k.Ay.createDialog(nt.A,{title:(0,l._t)("widget|error_unable_start_audio_stream_title"),description:t})}t()};_=i.createElement(na.R$,{onClick:e,label:(0,l._t)("widget|context_menu|start_audio_stream")})}if(Qh(n,v)){const e=()=>{a?a():u&&th.A.editWidget(u,n),t()};E=i.createElement(na.R$,{onClick:e,label:(0,l._t)("action|edit")})}if(ep(p)){const e=()=>{null==p||p.takeScreenshot().then((e=>{S.A.dispatch({action:"picture_snapshot",file:e.screenshot})})).catch((e=>{s.v.error("Failed to take screenshot: ",e)})),t()};y=i.createElement(na.R$,{onClick:e,label:(0,l._t)("widget|context_menu|screenshot")})}if(Zh(v,r)){const e=()=>{r?r():h&&k.Ay.createDialog(it.A,{title:(0,l._t)("widget|context_menu|delete"),description:(0,l._t)("widget|context_menu|delete_warning"),button:(0,l._t)("widget|context_menu|delete"),onFinished:e=>{e&&th.A.setRoomWidget(m,h,n.id)}}),t()};b=i.createElement(na.R$,{onClick:e,label:o?(0,l._t)("action|remove"):(0,l._t)("widget|context_menu|remove")})}if(Xh(m,h,n,o)){const e={approved:void 0};if(f.r.instance.invoke(ih.Z.PreLoadRequest,e,new Hh(n)),!e.approved){const e=()=>{const e=(0,Bh.Sw)(n)?n.eventId:void 0;s.v.info("Revoking permission for widget to load: "+e);const i=M.A.getValue("allowedWidgets",h);void 0!==e&&(i[e]=!1);const o=M.A.firstSupportedLevel("allowedWidgets");if(!o)throw new Error("level must be defined");M.A.setValue("allowedWidgets",null!=h?h:null,o,i).catch((e=>{s.v.error(e)})),t()};w=i.createElement(na.R$,{onClick:e,label:(0,l._t)("widget|context_menu|revoke")})}}const[A,C]=tp(n,u,c);let x,R;if(A){const e=()=>{if(!u)throw new Error("room must be defined");Jh.aK.instance.moveWithinContainer(u,Jh.mc.Top,n,-1),t()};x=i.createElement(na.R$,{onClick:e,label:(0,l._t)("widget|context_menu|move_left")})}if(C){const e=()=>{if(!u)throw new Error("room must be defined");Jh.aK.instance.moveWithinContainer(u,Jh.mc.Top,n,1),t()};R=i.createElement(na.R$,{onClick:e,label:(0,l._t)("widget|context_menu|move_right")})}return i.createElement(na.Ay,(0,_t.A)({},d,{chevronFace:Gt.t4.None,onFinished:t}),i.createElement(na.tx,null,_,E,w,b,y,x,R))},sp=["app","className","size"],op=e=>{let{app:t,className:s,size:o="20px"}=e,r=(0,g.A)(e,sp),a=[n("./res/img/element-icons/room/default_app.svg").A];return t.type.includes("jitsi")?a=[n("./res/img/element-icons/room/default_video.svg").A]:t.type.includes("meeting")||t.type.includes("calendar")?a=[n("./res/img/element-icons/room/default_cal.svg").A]:t.type.includes("pad")||t.type.includes("doc")||t.type.includes("calc")?a=[n("./res/img/element-icons/room/default_doc.svg").A]:t.type.includes("clock")&&(a=[n("./res/img/element-icons/room/default_clock.svg").A]),i.createElement(os.A,(0,_t.A)({},r,{name:t.id,className:dt()("mx_WidgetAvatar",s),url:(0,Bh.Sw)(t)&&t.avatar_url?(0,Wn.lH)(t.avatar_url).getSquareThumbnailHttp(20):null,urls:a,size:o}))};var rp=n("./res/img/external-link.svg");function ap(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function lp(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ap(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ap(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class cp extends i.Component{constructor(e,t){super(e,t),(0,v.A)(this,"contextMenuButton",(0,i.createRef)()),(0,v.A)(this,"iframe",void 0),(0,v.A)(this,"allowedWidgetsWatchRef",void 0),(0,v.A)(this,"persistKey",void 0),(0,v.A)(this,"sgWidget",void 0),(0,v.A)(this,"dispatcherRef",void 0),(0,v.A)(this,"unmounted",!1),(0,v.A)(this,"watchUserReady",(()=>{il.V.instance.isProfileInfoFetched||il.V.instance.once(_r.H,this.onUserReady)})),(0,v.A)(this,"onUserReady",(()=>{this.setState({isUserProfileReady:!0})})),(0,v.A)(this,"hasPermissionToLoad",(e=>{var t;if(this.usingLocalWidget())return!0;if(!e.room)return!0;const n={approved:void 0};if(f.r.instance.invoke(ih.Z.PreLoadRequest,n,new Hh(this.props.app)),n.approved)return!0;const i=M.A.getValue("allowedWidgets",e.room.roomId);return(0,Bh.Sw)(e.app)&&void 0!==e.app.eventId&&null!==(t=i[e.app.eventId])&&void 0!==t&&t||e.userId===e.creatorUserId})),(0,v.A)(this,"onMyMembership",((e,t)=>{var n;t!==ut.O.Leave&&t!==ut.O.Ban||e.roomId!==(null===(n=this.props.room)||void 0===n?void 0:n.roomId)||this.onUserLeftRoom()})),(0,v.A)(this,"onAllowedWidgetsChange",(()=>{const e=this.hasPermissionToLoad(this.props);var t;this.state.hasPermissionToLoad&&!e&&(R.A.instance.destroyPersistentWidget(this.props.app.id,(0,Bh.Sw)(this.props.app)?this.props.app.roomId:null),ph.destroyElement(this.persistKey),null===(t=this.sgWidget)||void 0===t||t.stopMessaging());this.setState({hasPermissionToLoad:e})})),(0,v.A)(this,"iframeRefChange",(e=>{this.iframe=e,this.unmounted||(e?this.startMessaging():this.resetWidget(this.props))})),(0,v.A)(this,"onWidgetReady",(()=>{this.setState({loading:!1})})),(0,v.A)(this,"updateRequiresClient",(()=>{var e;this.setState({requiresClient:!(null===(e=this.sgWidget)||void 0===e||null===(e=e.widgetApi)||void 0===e||!e.hasCapability(fh.RequiresClient))})})),(0,v.A)(this,"onAction",(e=>{var t,n;switch(e.action){case"m.sticker":e.widgetId===this.props.app.id&&null!==(t=this.sgWidget)&&void 0!==t&&null!==(t=t.widgetApi)&&void 0!==t&&t.hasCapability(nh.MatrixCapabilities.StickerSending)?(S.A.dispatch({action:"post_sticker_message",data:lp(lp({},e.data),{},{threadId:this.props.threadId})}),S.A.dispatch({action:"stickerpicker_close"})):s.v.warn("Ignoring sticker message. Invalid capability");break;case W.r.AfterLeaveRoom:e.room_id===(null===(n=this.props.room)||void 0===n?void 0:n.roomId)&&this.onUserLeftRoom()}})),(0,v.A)(this,"grantWidgetPermission",(()=>{var e;const t=null===(e=this.props.room)||void 0===e?void 0:e.roomId,n=(0,Bh.Sw)(this.props.app)?this.props.app.eventId:void 0;s.v.info("Granting permission for widget to load: "+n);const i=M.A.getValue("allowedWidgets",t);void 0!==n&&(i[n]=!0);const o=M.A.firstSupportedLevel("allowedWidgets");M.A.setValue("allowedWidgets",null!=t?t:null,o,i).then((()=>{this.setState({hasPermissionToLoad:!0}),this.startWidget()})).catch((e=>{s.v.error(e)}))})),(0,v.A)(this,"onPopoutWidgetClick",(()=>{var e;gh.x.JITSI.matches(this.props.app.type)&&this.reload(),Object.assign(document.createElement("a"),{target:"_blank",href:null===(e=this.sgWidget)||void 0===e?void 0:e.popoutUrl,rel:"noreferrer noopener"}).click()})),(0,v.A)(this,"onToggleMaximisedClick",(()=>{if(!this.props.room)return;const e=Jh.aK.instance.isInContainer(this.props.room,this.props.app,Jh.mc.Center)?Jh.mc.Top:Jh.mc.Center;Jh.aK.instance.moveToContainer(this.props.room,this.props.app,e),e===Jh.mc.Top&&this.closeChatCardIfNeeded()})),(0,v.A)(this,"onMinimiseClicked",(()=>{this.props.room&&(Jh.aK.instance.moveToContainer(this.props.room,this.props.app,Jh.mc.Right),this.closeChatCardIfNeeded())})),(0,v.A)(this,"closeChatCardIfNeeded",(()=>{this.props.room&&_l.A.instance.currentCardForRoom(this.props.room.roomId).phase===fl.n.Timeline&&_l.A.instance.popCard(this.props.room.roomId)})),(0,v.A)(this,"onContextMenuClick",(()=>{this.setState({menuDisplayed:!0})})),(0,v.A)(this,"closeContextMenu",(()=>{this.setState({menuDisplayed:!1})})),this.persistKey="widget_"+th.A.getWidgetUid(this.props.app);try{this.sgWidget=new Kh(this.props)}catch(e){s.v.log("Failed to construct widget",e),this.sgWidget=void 0}this.state=this.getNewState(e)}onUserLeftRoom(){R.A.instance.getWidgetPersistence(this.props.app.id,(0,Bh.Sw)(this.props.app)?this.props.app.roomId:null)&&(this.props.room&&X.M.instance.roomViewStore.getRoomId()!==this.props.room.roomId?this.endWidgetActions():gh.x.JITSI.matches(this.props.app.type)?this.reload():R.A.instance.destroyPersistentWidget(this.props.app.id,(0,Bh.Sw)(this.props.app)?this.props.app.roomId:null))}determineInitialRequiresClientState(){try{var e;const t=new Hh(this.props.app),n=Th.c.instance.getMessaging(t,null===(e=this.props.room)||void 0===e?void 0:e.roomId);if(n)return n.hasCapability(fh.RequiresClient)}catch{}return!0}getNewState(e){return{initialising:!0,loading:!this.props.waitForIframeLoad&&!ph.isMounted(this.persistKey),hasPermissionToLoad:this.hasPermissionToLoad(e),isUserProfileReady:il.V.instance.isProfileInfoFetched,error:null,menuDisplayed:!1,requiresClient:this.determineInitialRequiresClientState(),hasContextMenuOptions:np(this.context,this.props.room,e.app,e.userWidget,!e.userWidget,e.onDeleteClick)}}isMixedContent(){const e=window.location.protocol,t=(0,lh.Dl)(this.props.app.url).protocol;return"https:"===e&&"https:"!==t&&(s.v.warn("Refusing to load mixed-content app:",e,t,window.location,this.props.app.url),!0)}componentDidMount(){this.unmounted=!1,this.props.miniMode||R.A.instance.dockWidget(this.props.app.id,(0,Bh.Sw)(this.props.app)?this.props.app.roomId:null),this.sgWidget&&this.setupSgListeners(),this.sgWidget&&this.state.hasPermissionToLoad&&this.startWidget(),this.watchUserReady(),this.props.room&&this.context.on(o.RoomEvent.MyMembership,this.onMyMembership),this.allowedWidgetsWatchRef=M.A.watchSetting("allowedWidgets",null,this.onAllowedWidgetsChange),this.dispatcherRef=S.A.register(this.onAction)}componentWillUnmount(){this.unmounted=!0,this.props.miniMode||R.A.instance.undockWidget(this.props.app.id,(0,Bh.Sw)(this.props.app)?this.props.app.roomId:null),R.A.instance.isLive(this.props.app.id,(0,Bh.Sw)(this.props.app)?this.props.app.roomId:null)||this.endWidgetActions(),S.A.unregister(this.dispatcherRef),this.props.room&&this.context.off(o.RoomEvent.MyMembership,this.onMyMembership),M.A.unwatchSetting(this.allowedWidgetsWatchRef),il.V.instance.removeListener(_r.H,this.onUserReady)}setupSgListeners(){var e,t,n;null===(e=this.sgWidget)||void 0===e||e.on("ready",this.onWidgetReady),null===(t=this.sgWidget)||void 0===t||t.on("error:preparing",this.updateRequiresClient),null===(n=this.sgWidget)||void 0===n||n.on("capabilitiesNotified",this.updateRequiresClient)}stopSgListeners(){var e;this.sgWidget&&(null===(e=this.sgWidget)||void 0===e||e.off("ready",this.onWidgetReady),this.sgWidget.off("error:preparing",this.updateRequiresClient),this.sgWidget.off("capabilitiesNotified",this.updateRequiresClient))}resetWidget(e){var t;null===(t=this.sgWidget)||void 0===t||t.stopMessaging(),this.stopSgListeners();try{this.sgWidget=new Kh(e),this.setupSgListeners(),this.startWidget()}catch(e){s.v.error("Failed to construct widget",e),this.sgWidget=void 0}}startWidget(){var e;null===(e=this.sgWidget)||void 0===e||e.prepare().then((()=>{this.unmounted||this.setState({initialising:!1})}))}startMessaging(){try{var e;null===(e=this.sgWidget)||void 0===e||e.startMessaging(this.iframe)}catch(e){s.v.error("Failed to start widget",e)}}componentDidUpdate(e){e.app.url!==this.props.app.url&&(this.getNewState(this.props),this.state.hasPermissionToLoad&&this.resetWidget(this.props))}async endWidgetActions(){var e;this.iframe&&(this.iframe.src="about:blank"),gh.x.JITSI.matches(this.props.app.type)&&this.props.room&&et.Ay.instance.hangupCallApp(this.props.room.roomId),ph.destroyElement(this.persistKey),R.A.instance.destroyPersistentWidget(this.props.app.id,(0,Bh.Sw)(this.props.app)?this.props.app.roomId:null),null===(e=this.sgWidget)||void 0===e||e.stopMessaging({forceDestroy:!0})}formatAppTileName(){let e="No name";return this.props.app.name&&this.props.app.name.trim()&&(e=this.props.app.name.trim()),e}usingLocalWidget(){return gh.x.JITSI.matches(this.props.app.type)}getTileTitle(){const e=this.formatAppTileName(),t=i.createElement("span",null," - ");let n="";return this.props.widgetPageTitle&&this.props.widgetPageTitle!==this.formatAppTileName()&&(n=this.props.widgetPageTitle),i.createElement("span",null,i.createElement(op,{app:this.props.app,size:"20px"}),i.createElement("h3",null,e),i.createElement("span",null,n?t:"",n))}reload(){this.endWidgetActions().then((()=>{this.resetWidget(this.props),this.startMessaging(),this.iframe&&this.sgWidget&&(this.iframe.src=this.sgWidget.embedUrl)}))}render(){let e;const t=dt()({mx_AppTileBody:!0,"mx_AppTileBody--large":!this.props.miniMode,"mx_AppTileBody--mini":this.props.miniMode,"mx_AppTileBody--loading":this.state.loading,"mx_AppTileBody--call":this.props.app.type===gh.x.CALL.preferred}),n={};this.props.pointerEvents&&(n.pointerEvents=this.props.pointerEvents);const s=i.createElement("div",{className:"mx_AppTileBody_fadeInSpinner"},i.createElement(se.A,{message:(0,l._t)("common|loading")})),o=th.A.getWidgetName(this.props.app);if(null===this.sgWidget)e=i.createElement("div",{className:t,style:n},i.createElement(uh,{errorMsg:(0,l._t)("widget|error_loading")}));else if(!this.state.hasPermissionToLoad&&this.props.room&&this.sgWidget){const s=this.context.isRoomEncrypted(this.props.room.roomId);e=i.createElement("div",{className:t,style:n},i.createElement(dh,{roomId:this.props.room.roomId,creatorUserId:this.props.creatorUserId,url:this.sgWidget.embedUrl,isRoomEncrypted:s,onPermissionGranted:this.grantWidgetPermission}))}else if(this.state.initialising||!this.state.isUserProfileReady)e=i.createElement("div",{className:t,style:n},s);else if(this.isMixedContent())e=i.createElement("div",{className:t,style:n},i.createElement(uh,{errorMsg:(0,l._t)("widget|error_mixed_content")}));else if(this.sgWidget&&(e=i.createElement(i.Fragment,null,i.createElement("div",{className:t,style:n},this.state.loading&&s,i.createElement("iframe",{title:o,allow:"microphone; camera; encrypted-media; autoplay; display-capture; clipboard-write; clipboard-read;",ref:this.iframeRefChange,src:this.sgWidget.embedUrl,allowFullScreen:!0,sandbox:"allow-forms allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-presentation allow-downloads"})),this.props.overlay),!this.props.userWidget)){const t=101;e=i.createElement("div",{className:"mx_AppTile_persistedWrapper"},i.createElement(ph,{zIndex:this.props.miniMode?t:9,persistKey:this.persistKey,moveRef:this.props.movePersistedElement},e))}let r,a;r=this.props.miniMode?{mx_AppTile_mini:!0}:this.props.fullWidth?{mx_AppTileFullWidth:!0}:{mx_AppTile:!0},r=dt()(r),this.state.menuDisplayed&&(a=i.createElement(ip,(0,_t.A)({},(0,Gt.qv)(this.contextMenuButton.current.getBoundingClientRect()),{app:this.props.app,onFinished:this.closeContextMenu,showUnpin:!this.props.userWidget,userWidget:this.props.userWidget,onEditClick:this.props.onEditClick,onDeleteClick:this.props.onDeleteClick})));const c=[];if(this.props.showLayoutButtons){const e=this.props.room&&Jh.aK.instance.isInContainer(this.props.room,this.props.app,Jh.mc.Center);c.push(i.createElement(ie.A,{key:"toggleMaximised",className:"mx_AppTileMenuBar_widgets_button",title:e?(0,l._t)("widget|unmaximise"):(0,l._t)("action|maximise"),onClick:this.onToggleMaximisedClick},e?i.createElement(sh.A,{className:"mx_Icon mx_Icon_12"}):i.createElement(oh.A,{className:"mx_Icon mx_Icon_12"}))),c.push(i.createElement(ie.A,{key:"minimise",className:"mx_AppTileMenuBar_widgets_button",title:(0,l._t)("action|minimise"),onClick:this.onMinimiseClicked},i.createElement(rh.A,{className:"mx_Icon mx_Icon_16"})))}return i.createElement(i.Fragment,null,i.createElement("div",{className:r,id:this.props.app.id},this.props.showMenubar&&i.createElement("div",{className:"mx_AppTileMenuBar"},i.createElement("span",{className:"mx_AppTileMenuBar_title",style:{pointerEvents:this.props.handleMinimisePointerEvents?"all":"none"}},this.props.showTitle&&this.getTileTitle()),i.createElement("span",{className:"mx_AppTileMenuBar_widgets"},c,this.props.showPopout&&!this.state.requiresClient&&i.createElement(ie.A,{className:"mx_AppTileMenuBar_widgets_button",title:(0,l._t)("widget|popout"),onClick:this.onPopoutWidgetClick},i.createElement(rp.I,{className:"mx_Icon mx_Icon_12 mx_Icon--stroke"})),this.state.hasContextMenuOptions&&i.createElement(Gt.VJ,{className:"mx_AppTileMenuBar_widgets_button",label:(0,l._t)("common|options"),isExpanded:this.state.menuDisplayed,ref:this.contextMenuButton,onClick:this.onContextMenuClick},i.createElement(Xt.A,{className:"mx_Icon mx_Icon_12"})))),e),a)}}(0,v.A)(cp,"contextType",Hn.Ay),(0,v.A)(cp,"defaultProps",{waitForIframeLoad:!0,showMenubar:!0,showTitle:!0,showPopout:!0,handleMinimisePointerEvents:!1,userWidget:!1,miniMode:!1,threadId:null,showLayoutButtons:!0});const dp=({room:e,widgetId:t,onClose:n})=>{const s=(0,i.useContext)(Hn.Ay),o=(0,th.X)(e).find((e=>e.id===t)),r=o&&Jh.aK.instance.isInContainer(e,o,Jh.mc.Right),[a,c,d,m]=(0,Gt.EF)();if((0,i.useEffect)((()=>{o&&r||_l.A.instance.popCard()}),[o,r]),!o||!r)return null;let u;if(a){var h;const e=null===(h=c.current)||void 0===h?void 0:h.getBoundingClientRect(),t=e?e.right:0,n=e?e.bottom:0;u=i.createElement(ip,{chevronFace:Gt.t4.None,right:Zr.A.instance.windowWidth-t-12,top:n+12,onFinished:m,app:o})}const p=i.createElement("div",{className:"mx_BaseCard_header_title"},i.createElement(Ql.A,{size:"4",className:"mx_BaseCard_header_title_heading"},th.A.getWidgetName(o)),i.createElement(Gt.VJ,{className:"mx_BaseCard_header_title_button--option",ref:c,onClick:d,isExpanded:a,label:(0,l._t)("common|options")}),u);return i.createElement(Em.A,{header:p,className:"mx_WidgetCard",onClose:n,withoutScrollContainer:!0},i.createElement(cp,{app:o,fullWidth:!0,showMenubar:!1,room:e,userId:s.getSafeUserId(),creatorUserId:o.creatorUserId,widgetPageTitle:th.A.getWidgetDataTitle(o),waitForIframeLoad:o.waitForIframeLoad}))};var mp=n("./node_modules/@vector-im/compound-web/dist/components/Button/Button.js"),up=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/user-add-solid.js");class hp extends i.Component{constructor(e){super(e),(0,v.A)(this,"userLastModifiedTime",void 0),(0,v.A)(this,"memberLastModifiedTime",void 0),(0,v.A)(this,"onRoomStateEvents",(e=>{if(e.getType()!==o.EventType.RoomEncryption)return;const{roomId:t}=this.props.member;if(e.getRoomId()!==t)return;_.J.safeGet().removeListener(o.RoomStateEvent.Events,this.onRoomStateEvents),this.setState({isRoomEncrypted:!0}),this.updateE2EStatus()})),(0,v.A)(this,"onUserTrustStatusChanged",((e,t)=>{e===this.props.member.userId&&this.updateE2EStatus()})),(0,v.A)(this,"onClick",(()=>{S.A.dispatch({action:W.r.ViewUser,member:this.props.member,push:!0})})),this.state={isRoomEncrypted:!1}}componentDidMount(){const e=_.J.safeGet(),{roomId:t}=this.props.member;if(t){const n=e.isRoomEncrypted(t);this.setState({isRoomEncrypted:n}),n?(e.on(V.CryptoEvent.UserTrustStatusChanged,this.onUserTrustStatusChanged),this.updateE2EStatus()):e.on(o.RoomStateEvent.Events,this.onRoomStateEvents)}}componentWillUnmount(){const e=_.J.get();e&&(e.removeListener(o.RoomStateEvent.Events,this.onRoomStateEvents),e.removeListener(V.CryptoEvent.UserTrustStatusChanged,this.onUserTrustStatusChanged))}async updateE2EStatus(){var e;const t=_.J.safeGet(),{userId:n}=this.props.member,i=n===t.getUserId(),s=await(null===(e=t.getCrypto())||void 0===e?void 0:e.getUserVerificationStatus(n));if(null==s||!s.isCrossSigningVerified())return void this.setState({e2eStatus:null!=s&&s.wasCrossSigningVerified()?ss.a.Warning:ss.a.Normal});const o=await(0,Ke.a)(t,n),r=await(0,Z.rm)(o,(async e=>{var s;const o=await(null===(s=t.getCrypto())||void 0===s?void 0:s.getDeviceVerificationStatus(n,e));return!o||(i?!o.crossSigningVerified:!o.isVerified())}));this.setState({e2eStatus:r?ss.a.Warning:ss.a.Verified})}shouldComponentUpdate(e,t){return void 0===this.memberLastModifiedTime||this.memberLastModifiedTime<e.member.getLastModifiedTime()||(!(!e.member.user||!(void 0===this.userLastModifiedTime||this.userLastModifiedTime<e.member.user.getLastModifiedTime()))||(t.isRoomEncrypted!==this.state.isRoomEncrypted||t.e2eStatus!==this.state.e2eStatus))}getDisplayName(){return this.props.member.name}getPowerLabel(){return(0,l._t)("member_list|power_label",{userName:wt.A.getDisplayUserIdentifier(this.props.member.userId,{roomId:this.props.member.roomId}),powerLevelNumber:this.props.member.powerLevel}).trim()}render(){var e;const t=this.props.member,n=this.getDisplayName(),s=null===(e=t.user)||void 0===e?void 0:e.presence,o=i.createElement(Mt.A,{member:t,size:"36px","aria-hidden":"true"});t.user&&(this.userLastModifiedTime=t.user.getLastModifiedTime()),this.memberLastModifiedTime=t.getLastModifiedTime();const r=new Map([[100,as.Admin],[50,as.Moderator]]);let a=this.props.member.powerLevel;for(const[e]of r)if(this.props.member.powerLevel>=e){a=e;break}const l=r.get(a);let c;this.state.isRoomEncrypted&&(c=this.state.e2eStatus);const d=i.createElement(St,{member:t,fallbackName:n||""});return i.createElement(ds,(0,_t.A)({},this.props,{presenceState:s,presenceLastActiveAgo:t.user?t.user.lastActiveAgo:0,presenceLastTs:t.user?t.user.lastPresenceTs:0,presenceCurrentlyActive:!!t.user&&t.user.currentlyActive,avatarJsx:o,title:this.getPowerLabel(),name:n,nameJSX:d,powerStatus:l,showPresence:this.props.showPresence,e2eStatus:c,onClick:this.onClick}))}}(0,v.A)(hp,"defaultProps",{showPresence:!0});class pp extends i.Component{constructor(e,t){var n;super(e,t),(0,v.A)(this,"showPresence",void 0),(0,v.A)(this,"unmounted",!1),(0,v.A)(this,"tiles",new Map),(0,v.A)(this,"onUserPresenceChange",((e,t)=>{this.tiles.get(t.userId)&&this.updateList()})),(0,v.A)(this,"onRoom",(e=>{e.roomId===this.props.roomId&&this.updateListNow(!0)})),(0,v.A)(this,"onMyMembership",((e,t,n)=>{e.roomId===this.props.roomId&&t===ut.O.Join&&n!==ut.O.Join&&this.updateListNow(!0)})),(0,v.A)(this,"onRoomStateUpdate",(e=>{e.roomId===this.props.roomId&&this.updateList()})),(0,v.A)(this,"onRoomMemberName",((e,t)=>{t.roomId===this.props.roomId&&this.updateList()})),(0,v.A)(this,"onRoomStateEvent",(e=>{e.getRoomId()===this.props.roomId&&e.getType()===o.EventType.RoomThirdPartyInvite&&this.updateList(),this.canInvite!==this.state.canInvite&&this.setState({canInvite:this.canInvite})})),(0,v.A)(this,"updateList",(0,Vn.throttle)((()=>{this.updateListNow(!1)}),500,{leading:!0,trailing:!0})),(0,v.A)(this,"createOverflowTileJoined",((e,t)=>this.createOverflowTile(e,t,this.showMoreJoinedMemberList))),(0,v.A)(this,"createOverflowTileInvited",((e,t)=>this.createOverflowTile(e,t,this.showMoreInvitedMemberList))),(0,v.A)(this,"createOverflowTile",((e,t,n)=>{const s=(0,l._t)("common|and_n_others",{count:e});return i.createElement(ds,{className:"mx_EntityTile_ellipsis",avatarJsx:i.createElement(os.A,{url:ht.A,name:"...",size:"36px"}),name:s,showPresence:!1,onClick:n})})),(0,v.A)(this,"showMoreJoinedMemberList",(()=>{this.setState({truncateAtJoined:this.state.truncateAtJoined+100})})),(0,v.A)(this,"showMoreInvitedMemberList",(()=>{this.setState({truncateAtInvited:this.state.truncateAtInvited+100})})),(0,v.A)(this,"onSearchQueryChanged",(e=>{this.props.onSearchQueryChanged(e)})),(0,v.A)(this,"onPending3pidInviteClick",(e=>{S.A.dispatch({action:W.r.View3pidInvite,event:e})})),(0,v.A)(this,"getChildrenJoined",((e,t)=>this.makeMemberTiles(this.state.filteredJoinedMembers.slice(e,t)))),(0,v.A)(this,"getChildCountJoined",(()=>this.state.filteredJoinedMembers.length)),(0,v.A)(this,"getChildrenInvited",((e,t)=>{let n=this.state.filteredInvitedMembers;return t>this.state.filteredInvitedMembers.length&&(n=n.concat(this.getPending3PidInvites())),this.makeMemberTiles(n.slice(e,t))})),(0,v.A)(this,"getChildCountInvited",(()=>this.state.filteredInvitedMembers.length+(this.getPending3PidInvites()||[]).length)),(0,v.A)(this,"onInviteButtonClick",(e=>{Mn.A.trackInteraction("WebRightPanelMemberListInviteButton",e);Tu(_.J.safeGet().getRoom(this.props.roomId))})),this.state=this.getMembersState([],[]),this.showPresence=null===(n=null==t?void 0:t.memberListStore.isPresenceEnabled())||void 0===n||n}listenForMembersChanges(){const e=_.J.safeGet();e.on(o.RoomStateEvent.Update,this.onRoomStateUpdate),e.on(o.RoomMemberEvent.Name,this.onRoomMemberName),e.on(o.RoomStateEvent.Events,this.onRoomStateEvent),e.on(o.UserEvent.LastPresenceTs,this.onUserPresenceChange),e.on(o.UserEvent.Presence,this.onUserPresenceChange),e.on(o.UserEvent.CurrentlyActive,this.onUserPresenceChange),e.on(o.ClientEvent.Room,this.onRoom),e.on(o.RoomEvent.MyMembership,this.onMyMembership)}componentDidMount(){this.unmounted=!1,this.listenForMembersChanges(),this.updateListNow(!0)}componentWillUnmount(){this.unmounted=!0;const e=_.J.get();e&&(e.removeListener(o.RoomStateEvent.Update,this.onRoomStateUpdate),e.removeListener(o.RoomMemberEvent.Name,this.onRoomMemberName),e.removeListener(o.RoomEvent.MyMembership,this.onMyMembership),e.removeListener(o.RoomStateEvent.Events,this.onRoomStateEvent),e.removeListener(o.ClientEvent.Room,this.onRoom),e.removeListener(o.UserEvent.LastPresenceTs,this.onUserPresenceChange),e.removeListener(o.UserEvent.Presence,this.onUserPresenceChange),e.removeListener(o.UserEvent.CurrentlyActive,this.onUserPresenceChange)),this.updateList.cancel()}get canInvite(){const e=_.J.safeGet().getRoom(this.props.roomId);return!!e&&Iu(e)}getMembersState(e,t){return{loading:!1,filteredJoinedMembers:t,filteredInvitedMembers:e,canInvite:this.canInvite,truncateAtJoined:30,truncateAtInvited:5}}async updateListNow(e){if(this.unmounted)return;e&&this.setState({loading:!0});const{joined:t,invited:n}=await this.context.memberListStore.loadMemberList(this.props.roomId,this.props.searchQuery);this.unmounted||this.setState({loading:!1,filteredJoinedMembers:t,filteredInvitedMembers:n})}componentDidUpdate(e,t,n){e.searchQuery!==this.props.searchQuery&&this.updateListNow(!1)}getPending3PidInvites(){const e=_.J.safeGet().getRoom(this.props.roomId);return e?e.currentState.getStateEvents("m.room.third_party_invite").filter((function(t){if(!(0,pr.Qo)(t))return!1;return!e.currentState.getInviteForThreePidToken(t.getStateKey())})):[]}makeMemberTiles(e){return e.map((e=>e instanceof o.RoomMember?i.createElement(hp,{key:e.userId,member:e,ref:t=>{t?this.tiles.set(e.userId,t):this.tiles.delete(e.userId)},showPresence:this.showPresence}):i.createElement(ds,{key:e.getStateKey(),name:e.getContent().display_name,showPresence:!1,onClick:()=>this.onPending3pidInviteClick(e)})))}render(){if(this.state.loading)return i.createElement(Em.A,{id:"memberlist-panel",className:"mx_MemberList",ariaLabelledBy:"memberlist-panel-tab",role:"tabpanel",header:(0,l._t)("common|people"),onClose:this.props.onClose},i.createElement(se.A,null));const e=_.J.safeGet().getRoom(this.props.roomId);let t,n,s;if((null==e?void 0:e.getMyMembership())===ut.O.Join&&(0,ea.g)(He.C.InviteUsers)){const n=e.isSpaceRoom()?(0,l._t)("space|invite_this_space"):(0,l._t)("room|invite_this_room"),s=i.createElement(mp.$,{size:"sm",kind:"secondary",className:"mx_MemberList_invite",onClick:this.onInviteButtonClick,disabled:!this.state.canInvite},i.createElement(up.A,{width:"1em",height:"1em"}),n);t=this.state.canInvite?s:i.createElement(Et.m,{label:(0,l._t)("member_list|invite_button_no_perms_tooltip")},s)}this.getChildCountInvited()>0&&(n=i.createElement("h2",null,(0,l._t)("member_list|invited_list_heading")),s=i.createElement(is.A,{className:"mx_MemberList_section mx_MemberList_invited",truncateAt:this.state.truncateAtInvited,createOverflowElement:this.createOverflowTileInvited,getChildren:this.getChildrenInvited,getChildCount:this.getChildCountInvited}));const o=i.createElement(Zi.A,{className:"mx_MemberList_query mx_textinput_icon mx_textinput_search",placeholder:(0,l._t)("member_list|filter_placeholder"),onSearch:this.onSearchQueryChanged,initialValue:this.props.searchQuery});return i.createElement(Em.A,{id:"memberlist-panel",className:"mx_MemberList",ariaLabelledBy:"memberlist-panel-tab",role:"tabpanel",header:(0,l._t)("common|people"),footer:o,onClose:this.props.onClose},t,i.createElement("div",{className:"mx_MemberList_wrapper"},i.createElement(is.A,{className:"mx_MemberList_section mx_MemberList_joined",truncateAt:this.state.truncateAtJoined,createOverflowElement:this.createOverflowTileJoined,getChildren:this.getChildrenJoined,getChildCount:this.getChildCountJoined}),n,s))}}(0,v.A)(pp,"contextType",X.A);var gp=n("./src/components/views/right_panel/UserInfo.tsx");class vp extends i.Component{constructor(e){var t,n,i,r;super(e),(0,v.A)(this,"room",void 0),(0,v.A)(this,"onRoomStateEvents",(e=>{if(e.getType()===o.EventType.RoomThirdPartyInvite&&e.getStateKey()===this.state.stateKey){const t=e.getContent().display_name,n={invited:(0,pr.Qo)(e)};t&&(n.displayName=t),this.setState(n)}})),(0,v.A)(this,"onCancel",(()=>{S.A.dispatch({action:W.r.View3pidInvite,event:null})})),(0,v.A)(this,"onKickClick",(()=>{_.J.safeGet().sendStateEvent(this.state.roomId,o.EventType.RoomThirdPartyInvite,{},this.state.stateKey).catch((e=>{s.v.error(e),this.setState({invited:!0}),k.Ay.createDialog(nt.A,{title:(0,l._t)("user_info|error_revoke_3pid_invite_title"),description:(0,l._t)("user_info|error_revoke_3pid_invite_description")})})),this.setState({invited:!1})})),this.room=_.J.safeGet().getRoom(this.props.event.getRoomId());const a=null===(t=this.room)||void 0===t?void 0:t.getMember(_.J.safeGet().getSafeUserId()),c=null===(n=this.room)||void 0===n?void 0:n.currentState.getStateEvents("m.room.power_levels",""),d=this.props.event.getSender();let m=c?c.getContent().kick:50;"number"!=typeof m&&(m=50);const u=null===(i=this.room)||void 0===i?void 0:i.getMember(d);this.state={stateKey:this.props.event.getStateKey(),roomId:this.props.event.getRoomId(),displayName:this.props.event.getContent().display_name,invited:!0,canKick:!!a&&a.powerLevel>m,senderName:null!==(r=null==u?void 0:u.name)&&void 0!==r?r:d}}componentDidMount(){_.J.safeGet().on(o.RoomStateEvent.Events,this.onRoomStateEvents)}componentWillUnmount(){const e=_.J.get();e&&e.removeListener(o.RoomStateEvent.Events,this.onRoomStateEvents)}render(){let e;return this.state.canKick&&this.state.invited&&(e=i.createElement(ku.s,{direction:"column",as:"section",justify:"start",gap:"var(--cpd-space-2x)"},i.createElement(pl.E,{as:"span",role:"heading",size:"lg",weight:"semibold"},(0,l._t)("user_info|admin_tools_section")),i.createElement(mp.$,{size:"sm",kind:"destructive",className:"mx_MemberInfo_field",onClick:this.onKickClick},(0,l._t)("user_info|revoke_invite")))),i.createElement(Em.A,{onClose:this.props.onClose,header:(0,l._t)("common|profile")},i.createElement(ku.s,{className:"mx_ThirdPartyMemberInfo",direction:"column",gap:"var(--cpd-space-4x)"},i.createElement(ku.s,{direction:"column",as:"section",justify:"start",gap:"var(--cpd-space-2x)"},i.createElement(pl.E,{as:"span",role:"heading",size:"lg",weight:"semibold"},this.state.displayName),i.createElement(pl.E,{as:"span"},(0,l._t)("user_info|invited_by",{sender:this.state.senderName}))),e))}}let _p=function(e){return e[e.Files=0]="Files",e[e.Search=1]="Search",e}({});function fp({isRoomEncrypted:e,kind:t,showLogo:n=!0}){if(!e)return i.createElement(i.Fragment,null);if(E.A.get())return i.createElement(i.Fragment,null);if(E.A.error)return i.createElement("div",{className:"mx_SearchWarning"},(0,l._t)("seshat|error_initialising",{},{a:e=>i.createElement(ie.A,{kind:"link_inline",onClick:e=>{e.preventDefault(),S.A.dispatch({action:W.r.ViewUserSettings,initialTabId:Na.v.Security})}},e)}));const o=c.Ay.get("brand"),r=c.Ay.getObject("desktop_builds");let a,d;if(null!=r&&r.get("available")){d=i.createElement("img",{alt:"",src:r.get("logo"),width:"32px"});const e=r.get("url");switch(t){case _p.Files:a=(0,l._t)("seshat|warning_kind_files_app",{},{a:t=>i.createElement("a",{href:e,target:"_blank",rel:"noreferrer noopener"},t)});break;case _p.Search:a=(0,l._t)("seshat|warning_kind_search_app",{},{a:t=>i.createElement("a",{href:e,target:"_blank",rel:"noreferrer noopener"},t)})}}else switch(t){case _p.Files:a=(0,l._t)("seshat|warning_kind_files",{brand:o});break;case _p.Search:a=(0,l._t)("seshat|warning_kind_search",{brand:o})}return a?i.createElement("div",{className:"mx_SearchWarning"},n?d:null,i.createElement("span",null,a)):(s.v.warn("Unknown desktop builds warning kind: ",t),i.createElement(i.Fragment,null))}var Ep=n("./src/components/structures/LegacyCallEventGrouper.ts");const yp=(...e)=>{M.A.getValue("debug_timeline_panel")&&s.v.log.call(console,"TimelinePanel debuglog:",...e)},bp=(e,t)=>e.localTimestamp<t.localTimestamp,wp=(e,t)=>e.localTimestamp>=t.localTimestamp;class Sp extends i.Component{constructor(e,t){if(super(e,t),(0,v.A)(this,"lastRRSentEventId",void 0),(0,v.A)(this,"lastRMSentEventId",void 0),(0,v.A)(this,"messagePanel",(0,i.createRef)()),(0,v.A)(this,"dispatcherRef",void 0),(0,v.A)(this,"timelineWindow",void 0),(0,v.A)(this,"overlayTimelineWindow",void 0),(0,v.A)(this,"unmounted",!1),(0,v.A)(this,"readReceiptActivityTimer",null),(0,v.A)(this,"readMarkerActivityTimer",null),(0,v.A)(this,"callEventGroupers",new Map),(0,v.A)(this,"initialReadMarkerId",null),(0,v.A)(this,"onDumpDebugLogs",(()=>{var e,t,n,i,r,a;const l=null===(e=this.props.timelineSet)||void 0===e?void 0:e.room,c=null===(t=this.state)||void 0===t||null===(t=t.events)||void 0===t?void 0:t.map((e=>e.getId()));let d,m,u;try{const e=this.messagePanelDiv;if(e){d=[...e.querySelectorAll("[data-event-id]")].map((e=>e.getAttribute("data-event-id")))}}catch(e){s.v.error("onDumpDebugLogs: Failed to get the actual event ID's in the DOM",e)}const h={};if(l){const e=l.getTimelineSets(),t=l.threadsTimelineSets;try{m=Ap(e),u=Ap(t)}catch(e){s.v.error("onDumpDebugLogs: Failed to serialize event IDs from timelinesets",e)}try{l.getThreads().forEach((e=>{var t,n;h[e.id]={events:e.events.map((e=>e.getId())),numTimelines:e.timelineSet.getTimelines().length,liveTimeline:e.timelineSet.getLiveTimeline().getEvents().length,prevTimeline:null===(t=e.timelineSet.getLiveTimeline().getNeighbouringTimeline(o.Direction.Backward))||void 0===t?void 0:t.getEvents().length,nextTimeline:null===(n=e.timelineSet.getLiveTimeline().getNeighbouringTimeline(o.Direction.Forward))||void 0===n?void 0:n.getEvents().length}}))}catch(e){s.v.error("onDumpDebugLogs: Failed to serialize event IDs from the threads",e)}}let p,g;try{var v;p=null===(v=this.timelineWindow)||void 0===v?void 0:v.getEvents().map((e=>e.getId()))}catch(e){s.v.error("onDumpDebugLogs: Failed to get event IDs from the timelineWindow",e)}try{g=this.props.timelineSet.getPendingEvents().map((e=>e.getId()))}catch(e){s.v.error("onDumpDebugLogs: Failed to get pending event IDs",e)}s.v.debug(`TimelinePanel(${this.context.timelineRenderingType}): Debugging info for ${null==l?void 0:l.roomId}\n\tevents(${c.length})=${JSON.stringify(c)}\n\trenderedEventIds(${null!==(n=null===(i=d)||void 0===i?void 0:i.length)&&void 0!==n?n:0})=${JSON.stringify(d)}\n\tserializedEventIdsFromTimelineSets=${JSON.stringify(m)}\n\tserializedEventIdsFromThreadsTimelineSets=${JSON.stringify(u)}\n\tserializedThreadsMap=${JSON.stringify(h)}\n\ttimelineWindowEventIds(${null===(r=p)||void 0===r?void 0:r.length})=${JSON.stringify(p)}\n\tpendingEventIds(${null===(a=g)||void 0===a?void 0:a.length})=${JSON.stringify(g)}`)})),(0,v.A)(this,"onMessageListUnfillRequest",((e,t)=>{var n,i;const s=e?o.EventTimeline.BACKWARDS:o.EventTimeline.FORWARDS;yp("unpaginating events in direction",s);const r=t,a=this.timelineWindow.getEvents(),l=null!==(n=null===(i=this.overlayTimelineWindow)||void 0===i?void 0:i.getEvents())&&void 0!==n?n:[];let c,d,m,u=a.findIndex((e=>e.getId()===r));-1===u?(c=l.findIndex((e=>e.getId()===r)),u=e?(0,Vn.findLastIndex)(a,(e=>wp(l[c],e))):a.findIndex((e=>bp(l[c],e)))):c=e?(0,Vn.findLastIndex)(l,(e=>bp(e,a[u]))):l.findIndex((e=>wp(e,a[u]))),d=-1===u?0:e?u+1:a.length-u,m=-1===c?0:e?c+1:l.length-c,d>0&&(yp("Unpaginating",d,"in direction",s),this.timelineWindow.unpaginate(d,e)),m>0&&(yp("Unpaginating",d,"from overlay timeline in direction",s),this.overlayTimelineWindow.unpaginate(m,e));const{events:h,liveEvents:p}=this.getEvents();this.buildLegacyCallEventGroupers(h),this.setState({events:h,liveEvents:p}),e?this.setState({canBackPaginate:!0}):this.setState({canForwardPaginate:!0})})),(0,v.A)(this,"onPaginationRequest",((e,t,n)=>this.props.onPaginationRequest?this.props.onPaginationRequest(e,t,n):e.paginate(t,n))),(0,v.A)(this,"onMessageListFillRequest",(e=>{var t;if(!this.shouldPaginate())return Promise.resolve(!1);const n=e?o.EventTimeline.BACKWARDS:o.EventTimeline.FORWARDS,i=e?"canBackPaginate":"canForwardPaginate",s=e?"backPaginating":"forwardPaginating";return this.state[i]?null!==(t=this.timelineWindow)&&void 0!==t&&t.canPaginate(n)?(yp("Initiating paginate; backwards:"+e),this.setState({[s]:!0}),this.onPaginationRequest(this.timelineWindow,n,50).then((async t=>{var n;if(this.unmounted)return!1;this.overlayTimelineWindow&&await this.extendOverlayWindowToCoverMainWindow(),yp("paginate complete backwards:"+e+"; success:"+t);const{events:r,liveEvents:a}=this.getEvents();this.buildLegacyCallEventGroupers(r);const l={[s]:!1,[i]:t,events:r,liveEvents:a},c=e?o.EventTimeline.FORWARDS:o.EventTimeline.BACKWARDS,d=e?"canForwardPaginate":"canBackPaginate";return!this.state[d]&&null!==(n=this.timelineWindow)&&void 0!==n&&n.canPaginate(c)&&(yp("can now",c,"paginate again"),l[d]=!0),new Promise((e=>{this.setState(l,(()=>{e(t)}))}))}))):(yp("can't",n,"paginate any further"),this.setState({[i]:!1}),Promise.resolve(!1)):(yp("have given up",n,"paginating this timeline"),Promise.resolve(!1))})),(0,v.A)(this,"onMessageListScroll",(e=>{var t,n;null===(t=(n=this.props).onScroll)||void 0===t||t.call(n,e),this.props.manageReadMarkers&&this.doManageReadMarkers()})),(0,v.A)(this,"doManageReadMarkers",(0,Vn.debounce)((()=>{var e;const t=this.getReadMarkerPosition();if(null===t)return;t<0&&this.setState({readMarkerVisible:!0});const n=this.readMarkerTimeout(t);null===(e=this.readMarkerActivityTimer)||void 0===e||e.changeTimeout(n)}),100,{leading:!1,trailing:!0})),(0,v.A)(this,"onAction",(e=>{switch(e.action){case"ignore_state_changed":this.forceUpdate();break;case W.r.DumpDebugLogs:this.onDumpDebugLogs()}})),(0,v.A)(this,"onRoomTimeline",((e,t,n,i,s)=>{var r,a;s.timeline.getTimelineSet()!==this.props.timelineSet&&s.timeline.getTimelineSet()!==this.props.overlayTimelineSet||(o.Thread.hasServerSideSupport||this.context.timelineRenderingType!==jt.Ae.Thread||(n&&!this.state.canBackPaginate&&this.setState({canBackPaginate:!0}),n||this.state.canForwardPaginate||this.setState({canForwardPaginate:!0})),!n&&s&&s.liveEvent&&null!==(r=this.messagePanel.current)&&void 0!==r&&r.getScrollState()&&(null!==(a=this.messagePanel.current.getScrollState())&&void 0!==a&&a.stuckAtBottom?this.timelineWindow.paginate(o.EventTimeline.FORWARDS,1,!1).then((()=>{if(this.overlayTimelineWindow)return this.overlayTimelineWindow.paginate(o.EventTimeline.FORWARDS,1,!1)})).then((()=>{if(this.unmounted)return;const{events:t,liveEvents:n}=this.getEvents();this.buildLegacyCallEventGroupers(t);const i=n[n.length-1],s={events:t,liveEvents:n};let o=!1;if(this.props.manageReadMarkers){const t=_.J.safeGet().credentials.userId;if(o=!1,e.getSender()===t||w.A.sharedInstance().userActiveRecently()){if(i&&0===this.getReadMarkerPosition()){var r;this.setReadMarker(null!==(r=i.getId())&&void 0!==r?r:null,i.getTs(),!0),s.readMarkerVisible=!1,s.readMarkerEventId=i.getId(),o=!0}}else s.readMarkerVisible=!0}this.setState(s,(()=>{var e,t,n;(null===(e=this.messagePanel.current)||void 0===e||e.updateTimelineMinHeight(),o)&&(null===(t=(n=this.props).onReadMarkerUpdated)||void 0===t||t.call(n))}))})):this.setState({canForwardPaginate:!0})))})),(0,v.A)(this,"onRoomTimelineReset",((e,t)=>{t!==this.props.timelineSet&&t!==this.props.overlayTimelineSet||this.canResetTimeline()&&this.loadTimeline()})),(0,v.A)(this,"canResetTimeline",(()=>{var e;return!0===(null===(e=this.messagePanel)||void 0===e||null===(e=e.current)||void 0===e?void 0:e.isAtBottom())})),(0,v.A)(this,"onRoomRedaction",((e,t)=>{this.unmounted||this.hasTimelineSetFor(t.roomId)&&this.forceUpdate()})),(0,v.A)(this,"onThreadUpdate",(e=>{var t;if(this.unmounted)return;if(!this.hasTimelineSetFor(e.roomId))return;const n=null===(t=this.messagePanel.current)||void 0===t?void 0:t.getTileForEventId(e.id);n&&n.forceUpdate()})),(0,v.A)(this,"onEventVisibilityChange",(e=>{var t;if(this.unmounted)return;if(!this.hasTimelineSetFor(e.getRoomId()))return;const n=null===(t=this.messagePanel.current)||void 0===t?void 0:t.getTileForEventId(e.getId());n&&n.forceUpdate()})),(0,v.A)(this,"onVisibilityPowerLevelChange",((e,t)=>{var n;if(!this.unmounted&&this.hasTimelineSetFor(t.roomId)&&t.userId==(null===(n=_.J.safeGet().credentials)||void 0===n?void 0:n.userId)){for(const e of this.state.events){var i;const t=null===(i=this.messagePanel.current)||void 0===i?void 0:i.getTileForEventId(e.getId());t&&t.forceUpdate()}this.forceUpdate()}})),(0,v.A)(this,"onEventReplaced",(e=>{this.unmounted||this.hasTimelineSetFor(e.getRoomId())&&this.forceUpdate()})),(0,v.A)(this,"onRoomReceipt",((e,t)=>{this.unmounted||t===this.props.timelineSet.room&&this.forceUpdate()})),(0,v.A)(this,"onLocalEchoUpdated",((e,t,n)=>{this.unmounted||this.hasTimelineSetFor(t.roomId)&&this.reloadEvents()})),(0,v.A)(this,"onAccountData",((e,t)=>{this.unmounted||t===this.props.timelineSet.room&&e.getType()===o.EventType.FullyRead&&this.setState({readMarkerEventId:e.getContent().event_id},this.props.onReadMarkerUpdated)})),(0,v.A)(this,"onEventDecrypted",(e=>{this.props.timelineSet.room&&this.hasTimelineSetFor(e.getRoomId())&&this.state.events.includes(e)&&(this.buildLegacyCallEventGroupers(this.state.events),this.forceUpdate())})),(0,v.A)(this,"onSync",((e,t,n)=>{this.unmounted||this.setState({clientSyncState:e})})),(0,v.A)(this,"sendReadReceipts",(async()=>{var e,t;if(M.A.getValue("lowBandwidth"))return;if(!this.messagePanel.current)return;if(!this.props.manageReadReceipts)return;const n=_.J.get();if(!n||n.isGuest())return;const i=this.getCurrentReadReceipt(!0),s=this.indexForEventId(i),o=this.getLastDisplayedEventIndex({ignoreOwn:!0}),r=null!==(e=this.state.events[null!=o?o:this.state.events.length-1])&&void 0!==e?e:null,a=this.shouldSendReadReceipt(i,s,r,o),l=this.state.readMarkerEventId,c=this.shouldSendFullyReadMarker(l),d=null===(t=this.props.timelineSet.room)||void 0===t?void 0:t.roomId;yp(`Sending Read Markers for ${d}: `,{shouldSendReadReceipt:a,shouldSendFullyReadMarker:c,currentReadReceiptEventId:i,currentReadReceiptEventIndex:s,lastReadEventId:null==r?void 0:r.getId(),lastReadEventIndex:o,readMarkerEventId:this.state.readMarkerEventId});const m=[];if(a&&m.push(this.sendReadReceipt(n,r)),c){this.props.timelineSet.findEventById(l)&&m.push(this.sendFullyReadMarker(n,null!=d?d:"",l))}await Promise.all(m)})),(0,v.A)(this,"updateReadMarker",(async()=>{if(!this.props.manageReadMarkers)return;if(1===this.getReadMarkerPosition())return;const e=this.getLastDisplayedEventIndex({allowPartial:!0});if(null===e)return;const t=this.state.events[e];await this.setReadMarker(t.getId(),t.getTs()),this.state.readMarkerVisible&&this.setState({readMarkerVisible:!1}),await this.sendReadReceipts()})),(0,v.A)(this,"jumpToLiveTimeline",(()=>{var e,t;null!==(e=this.timelineWindow)&&void 0!==e&&e.canPaginate(o.EventTimeline.FORWARDS)?this.loadTimeline():null===(t=this.messagePanel.current)||void 0===t||t.scrollToBottom()})),(0,v.A)(this,"scrollToEventIfNeeded",(e=>{var t;null===(t=this.messagePanel.current)||void 0===t||t.scrollToEventIfNeeded(e)})),(0,v.A)(this,"jumpToReadMarker",(()=>{if(!this.props.manageReadMarkers)return;if(!this.messagePanel.current)return;if(!this.state.readMarkerEventId)return;null===this.messagePanel.current.getReadMarkerPosition()?this.loadTimeline(this.state.readMarkerEventId,0,1/3):this.messagePanel.current.scrollToEvent(this.state.readMarkerEventId,0,1/3)})),(0,v.A)(this,"forgetReadMarker",(async()=>{if(!this.props.manageReadMarkers)return;const e=this.getCurrentReadReceipt(),t=this.props.timelineSet.getTimelineForEvent(null!=e?e:"");let n;if(t){const i=t.getEvents().find((t=>t.getId()==e));i&&(n=i.getTs())}await this.setReadMarker(e,n),await this.sendReadReceipts()})),(0,v.A)(this,"isAtEndOfLiveTimeline",(()=>{var e;return(null===(e=this.messagePanel.current)||void 0===e?void 0:e.isAtBottom())&&this.timelineWindow&&!this.timelineWindow.canPaginate(o.EventTimeline.FORWARDS)})),(0,v.A)(this,"getScrollState",(()=>this.messagePanel.current?this.messagePanel.current.getScrollState():null)),(0,v.A)(this,"getReadMarkerPosition",(()=>{if(!this.props.manageReadMarkers)return null;if(!this.messagePanel.current)return null;if(!this.props.timelineSet.room)return null;const e=this.messagePanel.current.getReadMarkerPosition();if(null!==e)return e;const t=Sp.roomReadMarkerTsMap[this.props.timelineSet.room.roomId];return t&&this.state.events.length>0?t<this.state.events[0].getTs()?-1:1:null})),(0,v.A)(this,"canJumpToReadMarker",(()=>{const e=this.getReadMarkerPosition();return null!==this.state.readMarkerEventId&&(null===e||e<0)})),(0,v.A)(this,"handleScrollKey",(e=>{if(!this.messagePanel.current)return;(0,_s.zM)().getRoomAction(e)===Pn.bY.JumpToLatestMessage?this.jumpToLiveTimeline():this.messagePanel.current.handleScrollKey(e)})),(0,v.A)(this,"getRelationsForEvent",((e,t,n)=>{var i;return null===(i=this.props.timelineSet.relations)||void 0===i?void 0:i.getChildEventsForEvent(e,t,n)})),yp("mounting"),this.props.manageReadMarkers){var n;const e=null===(n=this.props.timelineSet.room)||void 0===n?void 0:n.getAccountData("m.fully_read");this.initialReadMarkerId=e?e.getContent().event_id:this.getCurrentReadReceipt()}this.state={events:[],liveEvents:[],timelineLoading:!0,canBackPaginate:!1,canForwardPaginate:!1,readMarkerVisible:!0,readMarkerEventId:this.initialReadMarkerId,backPaginating:!1,forwardPaginating:!1,clientSyncState:_.J.safeGet().getSyncState(),isTwelveHour:M.A.getValue("showTwelveHourTimestamps"),alwaysShowTimestamps:M.A.getValue("alwaysShowTimestamps"),readMarkerInViewThresholdMs:M.A.getValue("readMarkerInViewThresholdMs"),readMarkerOutOfViewThresholdMs:M.A.getValue("readMarkerOutOfViewThresholdMs")}}componentDidMount(){var e;this.unmounted=!1,this.dispatcherRef=S.A.register(this.onAction);const t=_.J.safeGet();t.on(o.RoomEvent.Timeline,this.onRoomTimeline),t.on(o.RoomEvent.TimelineReset,this.onRoomTimelineReset),t.on(o.RoomEvent.Redaction,this.onRoomRedaction),M.A.getValue("feature_msc3531_hide_messages_pending_moderation")&&(t.on(o.MatrixEventEvent.VisibilityChange,this.onEventVisibilityChange),t.on(o.RoomMemberEvent.PowerLevel,this.onVisibilityPowerLevelChange)),t.on(o.RoomEvent.RedactionCancelled,this.onRoomRedaction),t.on(o.RoomEvent.Receipt,this.onRoomReceipt),t.on(o.RoomEvent.LocalEchoUpdated,this.onLocalEchoUpdated),t.on(o.RoomEvent.AccountData,this.onAccountData),t.on(o.MatrixEventEvent.Decrypted,this.onEventDecrypted),t.on(o.MatrixEventEvent.Replaced,this.onEventReplaced),t.on(o.ClientEvent.Sync,this.onSync),null===(e=this.props.timelineSet.room)||void 0===e||e.on(o.ThreadEvent.Update,this.onThreadUpdate),this.props.manageReadReceipts&&this.updateReadReceiptOnUserActivity(),this.props.manageReadMarkers&&this.updateReadMarkerOnUserActivity(),this.initTimeline(this.props)}componentDidUpdate(e){var t,n;e.timelineSet!==this.props.timelineSet&&s.v.warn("Replacing timelineSet on a TimelinePanel - confusion may ensue"),null===(t=this.props.timelineSet.room)||void 0===t||t.off(o.ThreadEvent.Update,this.onThreadUpdate),null===(n=this.props.timelineSet.room)||void 0===n||n.on(o.ThreadEvent.Update,this.onThreadUpdate);const i=e.eventId!=this.props.eventId,r=e.highlightedEventId!=this.props.highlightedEventId,a=e.eventScrollIntoView&&!this.props.eventScrollIntoView,l=e.overlayTimelineSet!==this.props.overlayTimelineSet;i||r||a?(s.v.log(`TimelinePanel switching to eventId ${this.props.eventId} (was ${e.eventId}), scrollIntoView: ${this.props.eventScrollIntoView} (was ${e.eventScrollIntoView})`),this.initTimeline(this.props)):l&&(s.v.log("TimelinePanel updating overlay timeline."),this.initTimeline(this.props))}componentWillUnmount(){this.unmounted=!0,this.readReceiptActivityTimer&&(this.readReceiptActivityTimer.abort(),this.readReceiptActivityTimer=null),this.readMarkerActivityTimer&&(this.readMarkerActivityTimer.abort(),this.readMarkerActivityTimer=null),S.A.unregister(this.dispatcherRef);const e=_.J.get();var t;e&&(e.removeListener(o.RoomEvent.Timeline,this.onRoomTimeline),e.removeListener(o.RoomEvent.TimelineReset,this.onRoomTimelineReset),e.removeListener(o.RoomEvent.Redaction,this.onRoomRedaction),e.removeListener(o.RoomEvent.RedactionCancelled,this.onRoomRedaction),e.removeListener(o.RoomEvent.Receipt,this.onRoomReceipt),e.removeListener(o.RoomEvent.LocalEchoUpdated,this.onLocalEchoUpdated),e.removeListener(o.RoomEvent.AccountData,this.onAccountData),e.removeListener(o.RoomMemberEvent.PowerLevel,this.onVisibilityPowerLevelChange),e.removeListener(o.MatrixEventEvent.Decrypted,this.onEventDecrypted),e.removeListener(o.MatrixEventEvent.Replaced,this.onEventReplaced),e.removeListener(o.MatrixEventEvent.VisibilityChange,this.onEventVisibilityChange),e.removeListener(o.ClientEvent.Sync,this.onSync),null===(t=this.props.timelineSet.room)||void 0===t||t.removeListener(o.ThreadEvent.Update,this.onThreadUpdate))}get messagePanelDiv(){var e,t;return null!==(e=null===(t=this.messagePanel.current)||void 0===t||null===(t=t.scrollPanel.current)||void 0===t?void 0:t.divScroll)&&void 0!==e?e:null}hasTimelineSetFor(e){var t,n;return void 0!==e&&e===(null===(t=this.props.timelineSet.room)||void 0===t?void 0:t.roomId)||e===(null===(n=this.props.overlayTimelineSet)||void 0===n||null===(n=n.room)||void 0===n?void 0:n.roomId)}readMarkerTimeout(e){var t,n,i,s;return 0===e?null!==(t=null===(n=this.context)||void 0===n?void 0:n.readMarkerInViewThresholdMs)&&void 0!==t?t:this.state.readMarkerInViewThresholdMs:null!==(i=null===(s=this.context)||void 0===s?void 0:s.readMarkerOutOfViewThresholdMs)&&void 0!==i?i:this.state.readMarkerOutOfViewThresholdMs}async updateReadMarkerOnUserActivity(){const e=this.readMarkerTimeout(this.getReadMarkerPosition());for(this.readMarkerActivityTimer=new A.A(e);this.readMarkerActivityTimer;){w.A.sharedInstance().timeWhileActiveRecently(this.readMarkerActivityTimer);try{await this.readMarkerActivityTimer.finished()}catch{continue}await this.updateReadMarker()}}async updateReadReceiptOnUserActivity(){for(this.readReceiptActivityTimer=new A.A(500);this.readReceiptActivityTimer;){w.A.sharedInstance().timeWhileActiveNow(this.readReceiptActivityTimer);try{await this.readReceiptActivityTimer.finished()}catch{continue}await this.sendReadReceipts()}}async determineReceiptType(e){var t,n;const i=null!==(t=null===(n=this.props.timelineSet.room)||void 0===n?void 0:n.roomId)&&void 0!==t?t:null;return M.A.getValue("sendReadReceipts",i)?o.ReceiptType.Read:await e.doesServerSupportUnstableFeature("org.matrix.msc2285.stable")||await e.isVersionSupported("v1.4")?o.ReceiptType.ReadPrivate:(s.v.warn("Falling back to public instead of private receipts because the homeserver does not support them"),o.ReceiptType.Read)}shouldSendFullyReadMarker(e){return!!this.state.readMarkerEventId&&((!this.lastRMSentEventId||this.lastRMSentEventId!==this.state.readMarkerEventId)&&((!this.state.readMarkerEventId||this.state.readMarkerEventId!==this.initialReadMarkerId)&&!this.props.timelineSet.thread))}shouldSendReadReceipt(e,t,n,i){var s;return!!n&&((!e||null!==t||null===(s=this.timelineWindow)||void 0===s||!s.canPaginate(o.EventTimeline.FORWARDS))&&((null===i||null===t||i>t)&&(!this.lastRRSentEventId||this.lastRRSentEventId!==(null==n?void 0:n.getId()))))}async sendReadReceipt(e,t){this.lastRRSentEventId=t.getId();const n=await this.determineReceiptType(e);try{await e.sendReadReceipt(t,n)}catch(e){var i;this.lastRRSentEventId=void 0,s.v.error("Error sending receipt",{room:null===(i=this.props.timelineSet.room)||void 0===i?void 0:i.roomId,error:e})}}async sendFullyReadMarker(e,t,n){this.lastRMSentEventId=this.state.readMarkerEventId;try{await e.setRoomReadMarkers(t,n)}catch(e){this.lastRMSentEventId=void 0,s.v.error("Error sending fully_read",{roomId:t,error:e})}}advanceReadMarkerPastMyEvents(){if(!this.props.manageReadMarkers||!this.timelineWindow)return;const e=this.timelineWindow.getEvents();let t;for(t=0;t<e.length&&e[t].getId()!=this.state.readMarkerEventId;t++);if(t>=e.length)return;const n=_.J.safeGet().credentials.userId;for(t++;t<e.length;t++){if(e[t].getSender()!==n)break}t--;const i=e[t];this.setReadMarker(i.getId(),i.getTs())}initTimeline(e){const t=e.eventId,n=e.eventPixelOffset;let i=1;return null==n&&(i=.5),this.loadTimeline(t,n,i,e.eventScrollIntoView)}scrollIntoView(e,t,n){var i,s;const o=()=>{this.messagePanel.current&&(e?(yp("TimelinePanel scrolling to eventId "+e+" at position "+100*n+"% + "+t),this.messagePanel.current.scrollToEvent(e,t,n)):(yp("TimelinePanel scrolling to bottom"),this.messagePanel.current.scrollToBottom()))};yp("TimelinePanel scheduling scroll to event"),null===(i=(s=this.props).onEventScrolledIntoView)||void 0===i||i.call(s,e),o(),window.requestAnimationFrame((()=>{o()}))}async extendOverlayWindowToCoverMainWindow(){const e=this.timelineWindow,t=this.overlayTimelineWindow,n=e.getEvents();if(n.length>0){let i;do{i=[];const s=t.getEvents();!t.canPaginate(o.EventTimeline.BACKWARDS)||0!==s.length&&!wp(s[0],n[0])&&e.canPaginate(o.EventTimeline.BACKWARDS)||i.push(this.onPaginationRequest(t,o.EventTimeline.BACKWARDS,50)),!t.canPaginate(o.EventTimeline.FORWARDS)||0!==s.length&&!bp(s.at(-1),n.at(-1))&&e.canPaginate(o.EventTimeline.FORWARDS)||i.push(this.onPaginationRequest(t,o.EventTimeline.FORWARDS,50)),await Promise.all(i)}while(i.length>0)}}loadTimeline(e,t,n,i=!0){const r=_.J.safeGet();this.timelineWindow=new o.TimelineWindow(r,this.props.timelineSet,{windowLimit:this.props.timelineCap}),this.overlayTimelineWindow=this.props.overlayTimelineSet?new o.TimelineWindow(r,this.props.overlayTimelineSet,{windowLimit:this.props.timelineCap}):void 0;const a=()=>{var r,a,l,c,d,m,u;this.unmounted||(null===(r=this.messagePanel.current)||void 0===r||r.onTimelineReset(),this.reloadEvents(),this.advanceReadMarkerPastMyEvents(),this.setState({canBackPaginate:null!==(a=(null===(l=this.timelineWindow)||void 0===l?void 0:l.canPaginate(o.EventTimeline.BACKWARDS))||(null===(c=this.overlayTimelineWindow)||void 0===c?void 0:c.canPaginate(o.EventTimeline.BACKWARDS)))&&void 0!==a&&a,canForwardPaginate:null!==(d=(null===(m=this.timelineWindow)||void 0===m?void 0:m.canPaginate(o.EventTimeline.FORWARDS))||(null===(u=this.overlayTimelineWindow)||void 0===u?void 0:u.canPaginate(o.EventTimeline.FORWARDS)))&&void 0!==d&&d,timelineLoading:!1},(()=>{this.messagePanel.current?(i&&this.scrollIntoView(e,t,n),this.props.sendReadReceiptOnLoad&&this.sendReadReceipts().catch((e=>{s.v.warn("Error sending receipts on load",e)}))):s.v.log("can't initialise scroll state because messagePanel didn't load")})))};if(this.props.timelineSet.getTimelineForEvent(e)&&!this.overlayTimelineWindow)return this.timelineWindow.load(e,30),void a();const c=this.timelineWindow.load(e,30).then((async()=>{this.overlayTimelineWindow&&(await this.overlayTimelineWindow.load(void 0,30),await this.extendOverlayWindowToCoverMainWindow())}));this.buildLegacyCallEventGroupers(),this.setState({events:[],liveEvents:[],canBackPaginate:!1,canForwardPaginate:!1,timelineLoading:!0}),c.then(a,(t=>{var n;if(this.unmounted)return;let i,o;this.setState({timelineLoading:!1}),s.v.error(`Error loading timeline panel at ${null===(n=this.props.timelineSet.room)||void 0===n?void 0:n.roomId}/${e}`,t),e&&this.props.timelineSet.room&&(i=()=>{S.A.dispatch({action:W.r.ViewRoom,room_id:this.props.timelineSet.room.roomId,metricsTrigger:void 0})}),o="M_FORBIDDEN"==t.errcode?(0,l._t)("timeline|load_error|no_permission"):(0,l._t)("timeline|load_error|unable_to_find"),k.Ay.createDialog(nt.A,{title:(0,l._t)("timeline|load_error|title"),description:o,onFinished:i})}))}reloadEvents(){if(this.unmounted)return;const e=this.getEvents();this.buildLegacyCallEventGroupers(e.events),this.setState(e)}refreshTimeline(e){this.loadTimeline(e,void 0,void 0,!1),this.reloadEvents()}getEvents(){var e,t;const n=this.timelineWindow.getEvents();let i=null!==(e=null===(t=this.overlayTimelineWindow)||void 0===t?void 0:t.getEvents())&&void 0!==e?e:[];void 0!==this.props.overlayTimelineSetFilter&&(i=i.filter(this.props.overlayTimelineSetFilter));const s=i.reduce(((e,t)=>{const n=e.findIndex((e=>bp(t,e)));return-1===n?this.timelineWindow.canPaginate(o.EventTimeline.FORWARDS)||e.push(t):0===n?this.timelineWindow.canPaginate(o.EventTimeline.BACKWARDS)||e.unshift(t):e.splice(n,0,t),e}),[...n]),r=_.J.safeGet();for(let e=s.length-1;e>=0;--e)r.decryptEventIfNeeded(s[e]);const a=[...s];if(!this.timelineWindow.canPaginate(o.EventTimeline.FORWARDS)){const e=this.props.timelineSet.getPendingEvents();s.push(...e.filter((t=>{const{shouldLiveInRoom:n,threadId:i}=this.props.timelineSet.room.eventShouldLiveIn(t,e);return this.context.timelineRenderingType===jt.Ae.Thread?i===this.context.threadId:n})))}return{events:s,liveEvents:a}}indexForEventId(e){if(null===e)return null;if(this.context.timelineRenderingType===jt.Ae.Thread)return 0;const t=this.state.events.findIndex((t=>t.getId()===e));return t>-1?t:null}getLastDisplayedEventIndex(e={}){const t=e.ignoreOwn||!1,n=e.allowPartial||!1,i=this.messagePanel.current;if(!i)return null;const s=this.messagePanelDiv;if(!s)return null;const o=s.getBoundingClientRect(),r=_.J.safeGet().credentials.userId,a=e=>{if(e){const t=e.getBoundingClientRect();if(n&&t.top<=o.bottom||!n&&t.bottom<=o.bottom)return!0}return!1};let l=0;for(let e=this.state.liveEvents.length-1;e>=0;--e){var c;const n=this.state.liveEvents[e],s=i.getNodeForEventId(n.getId()),o=a(s);if(o&&0!==l)return e+l;s&&!o&&(l=0);const d=!!n.status||t&&n.getSender()===r;if(!(!(0,It.bN)(n,_.J.safeGet(),null===(c=this.context)||void 0===c?void 0:c.showHiddenEvents)||(0,Jd.A)(n,this.context))&&s){if(!d&&o)return e}else(!d||d&&0!==l)&&++l}return null}getCurrentReadReceipt(e=!1){var t,n;const i=_.J.get();if(null==i)return null;const s=i.getSafeUserId(),o=null!==(t=this.props.timelineSet.thread)&&void 0!==t?t:this.props.timelineSet.room;return null!==(n=null==o?void 0:o.getEventReadUpTo(s,e))&&void 0!==n?n:null}async setReadMarker(e,t,n=!1){var i;const s=null===(i=this.props.timelineSet.room)||void 0===i?void 0:i.roomId;e!==this.state.readMarkerEventId&&null!==e&&(void 0!==t?Sp.roomReadMarkerTsMap[null!=s?s:""]=t:delete Sp.roomReadMarkerTsMap[null!=s?s:""],n||await new Promise((t=>{this.setState({readMarkerEventId:e},(()=>{var e,n;null===(e=(n=this.props).onReadMarkerUpdated)||void 0===e||e.call(n),t()}))})))}shouldPaginate(){return!this.state.events.some((e=>e.isBeingDecrypted()))}buildLegacyCallEventGroupers(e){this.callEventGroupers=(0,Ep.fN)(this.callEventGroupers,e)}render(){var e,t,n,s,r,a;if(this.state.timelineLoading)return i.createElement("div",{className:"mx_RoomView_messagePanelSpinner"},i.createElement(se.A,null));if(0==this.state.events.length&&!this.state.canBackPaginate&&this.props.empty)return i.createElement("div",{className:this.props.className+" mx_RoomView_messageListWrapper"},i.createElement("div",{className:"mx_RoomView_empty"},this.props.empty));const l=!(null!==(e=this.timelineWindow)&&void 0!==e&&e.canPaginate(o.EventTimeline.FORWARDS)),c=this.state.forwardPaginating||["PREPARED","CATCHUP"].includes(this.state.clientSyncState),d=this.state.events;return i.createElement(mu,{ref:this.messagePanel,room:this.props.timelineSet.room,permalinkCreator:this.props.permalinkCreator,hidden:this.props.hidden,backPaginating:this.state.backPaginating,forwardPaginating:c,events:d,highlightedEventId:this.props.highlightedEventId,readMarkerEventId:this.state.readMarkerEventId,readMarkerVisible:this.state.readMarkerVisible,canBackPaginate:this.state.canBackPaginate,showUrlPreview:this.props.showUrlPreview,showReadReceipts:this.props.showReadReceipts,ourUserId:_.J.safeGet().getSafeUserId(),stickyBottom:l,onScroll:this.onMessageListScroll,onFillRequest:this.onMessageListFillRequest,onUnfillRequest:this.onMessageListUnfillRequest,isTwelveHour:null!==(t=null===(n=this.context)||void 0===n?void 0:n.showTwelveHourTimestamps)&&void 0!==t?t:this.state.isTwelveHour,alwaysShowTimestamps:null!==(s=null!==(r=this.props.alwaysShowTimestamps)&&void 0!==r?r:null===(a=this.context)||void 0===a?void 0:a.alwaysShowTimestamps)&&void 0!==s?s:this.state.alwaysShowTimestamps,className:this.props.className,resizeNotifier:this.props.resizeNotifier,getRelationsForEvent:this.getRelationsForEvent,editState:this.props.editState,showReactions:this.props.showReactions,layout:this.props.layout,hideThreadedMessages:this.props.hideThreadedMessages,disableGrouping:this.props.disableGrouping,callEventGroupers:this.callEventGroupers})}}function Ap(e){return e.map((e=>{const t={},n=e.getTimelines(),i=e.getLiveTimeline();return n.forEach(((e,n)=>{t[e===i?"liveTimeline":`${n}`]=e.getEvents().map((e=>e.getId()))})),t}))}(0,v.A)(Sp,"contextType",jt.Ay),(0,v.A)(Sp,"roomReadMarkerTsMap",{}),(0,v.A)(Sp,"defaultProps",{timelineCap:Number.MAX_VALUE,className:"mx_RoomView_messagePanel",sendReadReceiptOnLoad:!0,hideThreadedMessages:!0,disableGrouping:!1});const Cp=Sp;class xp extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,"instanceId",void 0),(0,v.A)(this,"onResize",((e,t)=>{e===Zr.x.Resize&&this.props.onMeasurement(t.contentRect.width<=this.props.breakpoint)})),this.instanceId=xp.instanceCount++}componentDidMount(){Zr.A.instance.on(`Measured${this.instanceId}`,this.onResize)}componentDidUpdate(e){const t=e.sensor,n=this.props.sensor;t!==n&&(t&&Zr.A.instance.stopTrackingElementDimensions(`Measured${this.instanceId}`),n&&Zr.A.instance.trackElementDimensions(`Measured${this.instanceId}`,this.props.sensor))}componentWillUnmount(){Zr.A.instance.off(`Measured${this.instanceId}`,this.onResize),Zr.A.instance.stopTrackingElementDimensions(`Measured${this.instanceId}`)}render(){return null}}(0,v.A)(xp,"instanceCount",0),(0,v.A)(xp,"defaultProps",{breakpoint:500});const kp=({Icon:e,title:t,description:n})=>i.createElement(ku.s,{className:"mx_EmptyState",direction:"column",gap:"var(--cpd-space-4x)",align:"center",justify:"center"},i.createElement(e,{width:"32px",height:"32px"}),i.createElement(pl.E,{size:"lg",weight:"semibold"},t),i.createElement(pl.E,{size:"md",weight:"regular"},n));function Rp(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Ip(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Rp(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Rp(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class Tp extends i.Component{constructor(...e){super(...e),(0,v.A)(this,"decryptingEvents",new Set),(0,v.A)(this,"noRoom",!1),(0,v.A)(this,"card",(0,i.createRef)()),(0,v.A)(this,"state",{timelineSet:null,narrow:!1}),(0,v.A)(this,"onRoomTimeline",((e,t,n,i,s)=>{if((null==t?void 0:t.roomId)!==this.props.roomId)return;if(n||!s||!s.liveEvent||e.isRedacted())return;_.J.safeGet().decryptEventIfNeeded(e),e.isBeingDecrypted()?this.decryptingEvents.add(e.getId()):this.addEncryptedLiveEvent(e)})),(0,v.A)(this,"onEventDecrypted",((e,t)=>{if(e.getRoomId()!==this.props.roomId)return;const n=e.getId();this.decryptingEvents.delete(n)&&(t||this.addEncryptedLiveEvent(e))})),(0,v.A)(this,"onPaginationRequest",((e,t,n)=>{const i=_.J.safeGet(),s=E.A.get(),o=this.props.roomId,r=i.getRoom(o);return r&&i.isRoomEncrypted(o)&&null!==s?s.paginateTimelineWindow(r,e,t,n):e.paginate(t,n)})),(0,v.A)(this,"onMeasurement",(e=>{this.setState({narrow:e})}))}addEncryptedLiveEvent(e){if(!this.state.timelineSet)return;const t=this.state.timelineSet.getLiveTimeline();"m.room.message"===e.getType()&&["m.file","m.image","m.video","m.audio"].includes(e.getContent().msgtype)&&(this.state.timelineSet.eventIdToTimeline(e.getId())||this.state.timelineSet.addEventToTimeline(e,t,!1))}async componentDidMount(){const e=_.J.safeGet();await this.updateTimelineSet(this.props.roomId),e.isRoomEncrypted(this.props.roomId)&&null!==E.A.get()&&(e.on(o.RoomEvent.Timeline,this.onRoomTimeline),e.on(o.MatrixEventEvent.Decrypted,this.onEventDecrypted))}componentWillUnmount(){const e=_.J.get();null!==e&&e.isRoomEncrypted(this.props.roomId)&&null!==E.A.get()&&(e.removeListener(o.RoomEvent.Timeline,this.onRoomTimeline),e.removeListener(o.MatrixEventEvent.Decrypted,this.onEventDecrypted))}async fetchFileEventsServer(e){const t=_.J.safeGet(),n=new o.Filter(t.getSafeUserId());return n.setDefinition({room:{timeline:{contains_url:!0,types:["m.room.message"]}}}),n.filterId=await t.getOrCreateFilter("FILTER_FILES_"+t.credentials.userId,n),e.getOrCreateFilteredTimelineSet(n)}async updateTimelineSet(e){const t=_.J.safeGet(),n=t.getRoom(e),i=E.A.get();if(this.noRoom=!n,n){let o;try{if(o=await this.fetchFileEventsServer(n),t.isRoomEncrypted(e)&&null!==i){const e=o.getLiveTimeline();await i.populateFileTimeline(o,e,n,10)}this.setState({timelineSet:o})}catch(e){s.v.error("Failed to get or create file panel filter",e)}}else s.v.error("Failed to add filtered timelineSet for FilePanel as no room!")}render(){if(_.J.safeGet().isGuest())return i.createElement(Em.A,{className:"mx_FilePanel mx_RoomView_messageListWrapper",onClose:this.props.onClose,header:(0,l._t)("right_panel|files_button")},i.createElement("div",{className:"mx_RoomView_empty"},(0,l._t)("file_panel|guest_note",{},{a:e=>i.createElement("a",{href:"#/register",key:"sub"},e)})));if(this.noRoom)return i.createElement(Em.A,{className:"mx_FilePanel mx_RoomView_messageListWrapper",onClose:this.props.onClose,header:(0,l._t)("right_panel|files_button")},i.createElement("div",{className:"mx_RoomView_empty"},(0,l._t)("file_panel|peek_note")));const e=i.createElement(kp,{Icon:cm.A,title:(0,l._t)("file_panel|empty_heading"),description:(0,l._t)("file_panel|empty_description")}),t=!this.noRoom&&_.J.safeGet().isRoomEncrypted(this.props.roomId);return this.state.timelineSet?i.createElement(jt.Ay.Provider,{value:Ip(Ip({},this.context),{},{timelineRenderingType:jt.Ae.File,narrow:this.state.narrow})},i.createElement(Em.A,{className:"mx_FilePanel",onClose:this.props.onClose,withoutScrollContainer:!0,ref:this.card,header:(0,l._t)("right_panel|files_button")},this.card.current&&i.createElement(xp,{sensor:this.card.current,onMeasurement:this.onMeasurement}),i.createElement(fp,{isRoomEncrypted:t,kind:_p.Files}),i.createElement(Cp,{manageReadReceipts:!1,manageReadMarkers:!1,timelineSet:this.state.timelineSet,showUrlPreview:!1,onPaginationRequest:this.onPaginationRequest,resizeNotifier:this.props.resizeNotifier,empty:e,layout:gt.P.Group}))):i.createElement(jt.Ay.Provider,{value:Ip(Ip({},this.context),{},{timelineRenderingType:jt.Ae.File})},i.createElement(Em.A,{className:"mx_FilePanel",onClose:this.props.onClose,header:(0,l._t)("right_panel|files_button")},i.createElement(se.A,null)))}}(0,v.A)(Tp,"contextType",jt.Ay);const Pp=Tp;class Np extends i.Component{constructor(...e){super(...e),(0,v.A)(this,"resize",(()=>{this.props.onResize&&this.props.onResize()}))}componentDidMount(){window.addEventListener("resize",this.resize)}componentWillUnmount(){window.removeEventListener("resize",this.resize)}render(){return i.createElement("div",null,this.props.element)}}const Dp="stickerPicker";class Mp extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,"dispatcherRef",void 0),(0,v.A)(this,"prevSentVisibility",void 0),(0,v.A)(this,"popoverWidth",300),(0,v.A)(this,"popoverHeight",300),(0,v.A)(this,"scalarClient",null),(0,v.A)(this,"removeStickerpickerWidgets",(async()=>{const e=await this.acquireScalarClient();s.v.log("Removing Stickerpicker widgets"),this.state.widgetId?e?e.disableWidgetAssets(gh.x.STICKERPICKER,this.state.widgetId).then((()=>{s.v.log("Assets disabled")})).catch((()=>{s.v.error("Failed to disable assets")})):s.v.error("Cannot disable assets: no scalar client"):s.v.warn("No widget ID specified, not disabling assets"),this.props.setStickerPickerOpen(!1),th.A.removeStickerpickerWidgets(this.props.room.client).then((()=>{this.forceUpdate()})).catch((e=>{s.v.error("Failed to remove sticker picker widget",e)}))})),(0,v.A)(this,"updateWidget",(()=>{var e,t,n,i;const s=th.A.getStickerpickerWidgets(this.props.room.client)[0];if(!s)return Mp.currentWidget=void 0,void this.setState({stickerpickerWidget:null,widgetId:null});const o=Mp.currentWidget,r=null!==(e=null==o||null===(t=o.content)||void 0===t?void 0:t.url)&&void 0!==e?e:null;(null!==(n=null==s||null===(i=s.content)||void 0===i?void 0:i.url)&&void 0!==n?n:null)!==r&&ph.destroyElement(Dp),Mp.currentWidget=s,this.setState({stickerpickerWidget:s,widgetId:s?s.id:null})})),(0,v.A)(this,"onAction",(e=>{switch(e.action){case"user_widget_updated":this.forceUpdate();break;case"stickerpicker_close":case"show_left_panel":case"hide_left_panel":this.props.setStickerPickerOpen(!1)}})),(0,v.A)(this,"onRightPanelStoreUpdate",(()=>{this.props.setStickerPickerOpen(!1)})),(0,v.A)(this,"onResize",(()=>{this.props.isStickerPickerOpen&&this.props.setStickerPickerOpen(!1)})),(0,v.A)(this,"onFinished",(()=>{this.props.isStickerPickerOpen&&this.props.setStickerPickerOpen(!1)})),(0,v.A)(this,"launchManageIntegrations",(()=>{var e,t;null===(e=U.J.sharedInstance())||void 0===e||null===(e=e.getPrimaryManager())||void 0===e||e.open(this.props.room,`type_${gh.x.STICKERPICKER.preferred}`,null!==(t=this.state.widgetId)&&void 0!==t?t:void 0)})),this.state={imError:null,stickerpickerWidget:null,widgetId:null}}async acquireScalarClient(){return this.scalarClient?Promise.resolve(this.scalarClient):U.J.sharedInstance().hasManager()?(this.scalarClient=null!==(e=null===(t=U.J.sharedInstance().getPrimaryManager())||void 0===t?void 0:t.getScalarClient())&&void 0!==e?e:null,null===(n=this.scalarClient)||void 0===n?void 0:n.connect().then((()=>(this.forceUpdate(),this.scalarClient))).catch((e=>{this.imError((0,l.AO)("integration_manager|error_connecting_heading"),e)}))):void U.J.sharedInstance().openNoManagerDialog();var e,t,n}componentDidMount(){window.addEventListener("resize",this.onResize),this.dispatcherRef=S.A.register(this.onAction),_.J.safeGet().on(o.ClientEvent.AccountData,this.updateWidget),_l.A.instance.on(_r.H,this.onRightPanelStoreUpdate),this.updateWidget()}componentWillUnmount(){const e=_.J.get();e&&e.removeListener(o.ClientEvent.AccountData,this.updateWidget),_l.A.instance.off(_r.H,this.onRightPanelStoreUpdate),window.removeEventListener("resize",this.onResize),S.A.unregister(this.dispatcherRef)}componentDidUpdate(){this.sendVisibilityToWidget(this.props.isStickerPickerOpen)}imError(e,t){s.v.error(e,t),this.setState({imError:(0,l._t)(e)}),this.props.setStickerPickerOpen(!1)}defaultStickerpickerContent(){const e=n("./res/img/stickerpack-placeholder.png");return i.createElement(ie.A,{onClick:this.launchManageIntegrations,className:"mx_Stickers_contentPlaceholder"},i.createElement("p",null,(0,l._t)("stickers|empty")),i.createElement("p",{className:"mx_Stickers_addLink"},(0,l._t)("stickers|empty_add_prompt")),i.createElement("img",{src:e,alt:""}))}errorStickerpickerContent(){return i.createElement("div",{style:{textAlign:"center"},className:"error"},i.createElement("p",null," ",this.state.imError," "))}sendVisibilityToWidget(e){if(!this.state.stickerpickerWidget)return;const t=Th.c.instance.getMessagingForUid(th.A.calcWidgetUid(this.state.stickerpickerWidget.id));t&&e!==this.prevSentVisibility&&(t.updateVisibility(e).catch((e=>{s.v.error("Error updating widget visibility: ",e)})),this.prevSentVisibility=e)}getStickerpickerContent(){var e;if(this.state.imError)return this.errorStickerpickerContent();const t=this.state.stickerpickerWidget;let n;if(null!=t&&null!==(e=t.content)&&void 0!==e&&e.url){t.content.name=t.content.name||(0,l._t)("common|stickerpack");const e={id:t.id,url:t.content.url,name:t.content.name,type:t.content.type,data:t.content.data,creatorUserId:t.content.creatorUserId||t.sender};n=i.createElement("div",{className:"mx_Stickers_content_container"},i.createElement("div",{id:"stickersContent",className:"mx_Stickers_content",style:{border:"none",height:this.popoverHeight,width:this.popoverWidth}},i.createElement(ph,{persistKey:Dp,zIndex:3500},i.createElement(cp,{app:e,room:this.props.room,threadId:this.props.threadId,fullWidth:!0,userId:_.J.safeGet().credentials.userId,creatorUserId:t.sender||_.J.safeGet().credentials.userId,waitForIframeLoad:!0,showMenubar:!0,onEditClick:this.launchManageIntegrations,onDeleteClick:this.removeStickerpickerWidgets,showTitle:!1,showPopout:!1,handleMinimisePointerEvents:!0,userWidget:!0,showLayoutButtons:!1}))))}else n=this.defaultStickerpickerContent();return n}render(){return this.props.isStickerPickerOpen?i.createElement(Gt.Ay,(0,_t.A)({chevronFace:Gt.t4.Bottom,menuWidth:this.popoverWidth,menuHeight:this.popoverHeight,onFinished:this.onFinished,menuPaddingTop:0,menuPaddingLeft:0,menuPaddingRight:0,zIndex:3500,mountAsChild:!0},this.props.menuPosition),i.createElement(Np,{element:this.getStickerpickerContent(),onResize:this.onFinished})):null}}(0,v.A)(Mp,"defaultProps",{threadId:null}),(0,v.A)(Mp,"currentWidget",void 0);class Op extends i.Component{render(){return this.props.replyToEvent?i.createElement("div",{className:"mx_ReplyPreview"},i.createElement("div",{className:"mx_ReplyPreview_section"},i.createElement("div",{className:"mx_ReplyPreview_header"},i.createElement("span",null,(0,l._t)("composer|replying_title")),i.createElement(ie.A,{className:"mx_ReplyPreview_header_cancel",onClick:()=>{return e=this.context.timelineRenderingType,void S.A.dispatch({action:"reply_to_event",event:null,context:e});var e}})),i.createElement(Ft,{mxEvent:this.props.replyToEvent,permalinkCreator:this.props.permalinkCreator}))):null}}async function Lp(e,t){return(await e.getUserVerificationStatus(t)).needsUserApproval}(0,v.A)(Op,"contextType",jt.Ay);var Up=function(e){return e[e.Uninitialised=0]="Uninitialised",e[e.Initialising=1]="Initialising",e[e.Completed=2]="Completed",e}(Up||{});const Fp=({room:e})=>{const t=(0,Hn.nH)(),n=t.getCrypto(),[r,a]=(0,i.useState)(void 0),c=(0,i.useRef)(Up.Uninitialised),d=(0,i.useRef)(new Map),m=(0,i.useRef)(new Map),u=e=>{const t=m.current,n=t.get(e),i=void 0===n?1:n+1;return t.set(e,i),i},h=(0,i.useCallback)((()=>{const e=d.current;a((t=>{if(t&&e.has(t.userId))return t;if(0===e.size)return;const n=Array.from(e.keys()).sort(((e,t)=>e.localeCompare(t)));return e.get(n[0])}))}),[]),p=(0,i.useCallback)(((n,i)=>{var s,o;n!==t.getUserId()&&(i=null!==(s=null!==(o=i)&&void 0!==o?o:e.getMember(n))&&void 0!==s?s:void 0)&&(d.current.set(n,i),c.current===Up.Completed&&h())}),[t,e,h]),g=(0,i.useCallback)((async e=>{const t=m.current,i=[];for(const s of e){const e=s.userId,o=u(e);i.push(Lp(n,e).then((n=>{n&&t.get(e)===o&&p(e,s)})))}await Promise.all(i)}),[n,p]),v=(0,i.useCallback)((e=>{d.current.delete(e),h()}),[h]),_=(0,i.useCallback)((async()=>{if(!n||c.current!==Up.Uninitialised)return;if(!await n.isEncryptionEnabledInRoom(e.roomId))return;c.current=Up.Initialising;const t=await e.getEncryptionTargetMembers();await g(t),h(),c.current=Up.Completed}),[n,e,g,h]);_().catch((e=>{s.v.error("Error initialising UserIdentityWarning:",e)}));const f=(0,i.useCallback)(((e,t)=>{c.current!==Up.Uninitialised&&(u(e),t.needsUserApproval?p(e):v(e))}),[p,v]);(0,ci.YK)(t,V.CryptoEvent.UserTrustStatusChanged,f);const E=(0,i.useCallback)((async t=>{if(!n||t.getRoomId()!==e.roomId)return;const i=t.getType();if(i===o.EventType.RoomEncryption&&""===t.getStateKey())return _().catch((e=>{s.v.error("Error initialising UserIdentityWarning:",e)}));if(i!==o.EventType.RoomMember)return;if(c.current===Up.Uninitialised)return;const r=t.getStateKey();if(r)if(t.getContent().membership===o.KnownMembership.Join||t.getContent().membership===o.KnownMembership.Invite&&e.shouldEncryptForInvitedMembers()){const t=e.getMember(r);t&&await g([t]).catch((e=>{s.v.error("Error adding member in UserIdentityWarning:",e)}))}else v(r),u(r)}),[n,e,g,v,_]);if((0,ci.YK)(t,o.RoomStateEvent.Events,E),!n||!r)return null;return i.createElement("div",{className:"mx_UserIdentityWarning"},i.createElement(nm.w,null),i.createElement("div",{className:"mx_UserIdentityWarning_row"},i.createElement(Mt.A,{member:r,title:r.userId,size:"30px"}),i.createElement("span",{className:"mx_UserIdentityWarning_main"},r.rawDisplayName===r.userId?(0,l._t)("encryption|pinned_identity_changed_no_displayname",{userId:r.userId},{a:Vp,b:Bp}):(0,l._t)("encryption|pinned_identity_changed",{displayName:r.rawDisplayName,userId:r.userId},{a:Vp,b:Bp})),i.createElement(mp.$,{kind:"primary",size:"sm",onClick:async()=>{await n.pinCurrentUserIdentity(r.userId)}},(0,l._t)("action|ok"))))};function Vp(e){return i.createElement("a",{href:"https://element.io/help#encryption18",target:"_blank",rel:"noreferrer noopener"},e)}function Bp(e){return i.createElement("b",null,e)}var jp=n("./src/audio/VoiceRecording.ts"),Wp=n("./src/components/views/audio_messages/Waveform.tsx"),zp=n("./src/utils/MarkedExecution.ts");class Hp extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,"waveform",[]),(0,v.A)(this,"scheduledUpdate",new zp.L((()=>this.updateWaveform()),(()=>requestAnimationFrame((()=>this.scheduledUpdate.trigger()))))),this.state={waveform:(0,Z.DG)(0,jp.IZ)}}componentDidMount(){this.props.recorder.liveData.onUpdate((e=>{this.waveform=(0,Z.$S)(Array.from(e.waveform),jp.IZ),this.scheduledUpdate.mark()}))}updateWaveform(){this.setState({waveform:this.waveform})}render(){return i.createElement(Wp.A,{relHeights:this.state.waveform})}}(0,v.A)(Hp,"defaultProps",{progress:1});var Kp=n("./src/components/views/audio_messages/Clock.tsx");class Jp extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,"seconds",0),(0,v.A)(this,"scheduledUpdate",new zp.L((()=>this.updateClock()),(()=>requestAnimationFrame((()=>this.scheduledUpdate.trigger()))))),this.state={seconds:0}}componentDidMount(){this.props.recorder.liveData.onUpdate((e=>{this.seconds=e.timeSeconds,this.scheduledUpdate.mark()}))}updateClock(){this.setState({seconds:this.seconds})}render(){return i.createElement(Kp.A,{seconds:this.state.seconds,"aria-live":"off"})}}var Gp=n("./src/utils/Singleflight.ts"),$p=n("./src/audio/Playback.ts");class qp{constructor(e,t){(0,v.A)(this,"lastUpload",void 0),(0,v.A)(this,"buffer",new Uint8Array(0)),(0,v.A)(this,"playback",void 0),(0,v.A)(this,"onDataAvailable",(e=>{const t=new Uint8Array(e);this.buffer=(0,Z.xW)(this.buffer,t)})),this.matrixClient=e,this.voiceRecording=t,this.voiceRecording.onDataAvailable=this.onDataAvailable}async start(){if(this.lastUpload||this.hasRecording)throw new Error("Recording already prepared");return this.voiceRecording.start()}async stop(){return await this.voiceRecording.stop(),this.audioBuffer}on(e,t){return this.voiceRecording.on(e,t),this}off(e,t){return this.voiceRecording.off(e,t),this}emit(e,...t){return this.voiceRecording.emit(e,...t)}get hasRecording(){return this.buffer.length>0}get isRecording(){return this.voiceRecording.isRecording}getPlayback(){return this.playback=Gp.j.for(this,"playback").do((()=>new $p.Y(this.audioBuffer.buffer,this.voiceRecording.amplitudes))),this.playback}async upload(e){if(!this.hasRecording)throw new Error("No recording available to upload");if(this.lastUpload)return this.lastUpload;try{this.emit(jp.$T.Uploading);const{url:t,file:n}=await(0,$d.QM)(this.matrixClient,e,new Blob([this.audioBuffer],{type:this.contentType}));this.lastUpload={mxc:t,encrypted:n},this.emit(jp.$T.Uploaded)}catch(e){throw this.emit(jp.$T.Ended),e}return this.lastUpload}get durationSeconds(){return this.voiceRecording.durationSeconds}get contentType(){return this.voiceRecording.contentType}get contentLength(){return this.buffer.length}get liveData(){return this.voiceRecording.liveData}get isSupported(){return this.voiceRecording.isSupported}destroy(){var e;null===(e=this.playback)||void 0===e||e.destroy(),this.voiceRecording.destroy()}get audioBuffer(){return this.buffer.slice(0)}}function Yp(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}function Qp(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Xp(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Qp(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Qp(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class Zp extends Ar.r{constructor(){super(S.A,{})}static get instance(){return this.internalInstance||(this.internalInstance=new Zp,this.internalInstance.start()),this.internalInstance}async onAction(e){}static getVoiceRecordingId(e,t){return"io.element.thread"===(null==t?void 0:t.rel_type)||(null==t?void 0:t.rel_type)===o.RelationType.Thread?e.roomId+"|"+t.event_id:e.roomId}getActiveRecording(e){return this.state[e]}startRecording(e){if(!this.matrixClient)throw new Error("Cannot start a recording without a MatrixClient");if(!e)throw new Error("Recording must be associated with a room");if(this.state[e])throw new Error("A recording is already in progress");const t=(n=this.matrixClient,new qp(n,new jp.Qj));var n;return this.updateState(Xp(Xp({},this.state),{},{[e]:t})),t}disposeRecording(e){var t;null===(t=this.state[e])||void 0===t||t.destroy();const n=this.state,{[e]:i}=n,s=(0,g.A)(n,[e].map(Yp));return this.reset(s)}}(0,v.A)(Zp,"internalInstance",void 0),window.mxVoiceRecordingStore=Zp.instance;var eg=n("./src/components/views/audio_messages/RecordingPlayback.tsx"),tg=n("./src/audio/PlaybackManager.ts"),ng=n("./src/utils/local-room.ts"),ig=n("./src/components/views/rooms/SendMessageComposer.tsx"),sg=n("./src/utils/createVoiceMessageContent.ts");class og extends i.PureComponent{constructor(e,t){super(e,t),(0,v.A)(this,"voiceRecordingId",void 0),(0,v.A)(this,"onCancel",(async()=>{await this.disposeRecording()})),(0,v.A)(this,"onRecordStartEndClick",(async()=>{if(this.state.recorder)return void await this.state.recorder.stop();const e=()=>{k.Ay.createDialog(nt.A,{title:(0,l._t)("voip|unable_to_access_audio_input_title"),description:i.createElement(i.Fragment,null,i.createElement("p",null,(0,l._t)("voip|unable_to_access_audio_input_description")))})};try{var t;const e=await Lr.Ay.getDevices();if(null==e||null===(t=e[Lr.cm.AudioInput])||void 0===t||!t.length)return void k.Ay.createDialog(nt.A,{title:(0,l._t)("voip|no_audio_input_title"),description:i.createElement(i.Fragment,null,i.createElement("p",null,(0,l._t)("voip|no_audio_input_description")))})}catch(t){return s.v.error("Error getting devices: ",t),void e()}try{tg.T.instance.pauseAllExcept();const e=Zp.instance.startRecording(this.voiceRecordingId);await e.start(),this.bindNewRecorder(e),this.setState({recorder:e,recordingPhase:jp.$T.Started})}catch(t){s.v.error("Error starting recording: ",t),e(),Zp.instance.disposeRecording(this.voiceRecordingId)}})),(0,v.A)(this,"onRecordingUpdate",(e=>{e!==jp.$T.EndingSoon&&this.setState({recordingPhase:e})})),this.state={},this.voiceRecordingId=Zp.getVoiceRecordingId(this.props.room,this.props.relation)}componentDidMount(){const e=Zp.instance.getActiveRecording(this.voiceRecordingId);e&&(!e.isRecording&&e.hasRecording||s.v.warn("Cached recording hasn't ended yet and might cause issues"),this.bindNewRecorder(e),this.setState({recorder:e,recordingPhase:jp.$T.Ended}))}async componentWillUnmount(){const e=Zp.instance.getActiveRecording(this.voiceRecordingId);await(null==e?void 0:e.stop()),this.bindNewRecorder(null)}async send(){if(!this.state.recorder)throw new Error("No recording started - cannot send anything");const{replyToEvent:e,relation:t}=this.props;let n;await this.state.recorder.stop();try{n=await this.state.recorder.upload(this.voiceRecordingId)}catch(e){return s.v.error("Error uploading voice message:",e),void this.setState({didUploadFail:!0})}try{const i=(0,sg.r)(n.mxc,this.state.recorder.contentType,Math.round(1e3*this.state.recorder.durationSeconds),this.state.recorder.contentLength,n.encrypted,this.state.recorder.getPlayback().thumbnailWaveform.map((e=>Math.round(1024*e))));(0,ig.LO)(_.J.safeGet().getSafeUserId(),i,null,e),(0,ig.gV)(i,t),e&&((0,Bt.fh)(i,e),S.A.dispatch({action:"reply_to_event",event:null,context:this.context.timelineRenderingType})),(0,ng.Y)(this.props.room.roomId,(e=>_.J.safeGet().sendMessage(e,i)),this.props.room.client)}catch(e){s.v.error("Error sending voice message:",e)}await this.disposeRecording()}async disposeRecording(){await Zp.instance.disposeRecording(this.voiceRecordingId),this.setState({recorder:void 0,recordingPhase:void 0,didUploadFail:!1})}bindNewRecorder(e){this.state.recorder&&this.state.recorder.off(_r.H,this.onRecordingUpdate),e&&e.on(_r.H,this.onRecordingUpdate)}renderWaveformArea(){return this.state.recorder?this.state.recordingPhase!==jp.$T.Started?i.createElement(eg.A,{playback:this.state.recorder.getPlayback(),layout:eg._.Composer}):i.createElement("div",{className:"mx_MediaBody mx_VoiceMessagePrimaryContainer mx_VoiceRecordComposerTile_recording"},i.createElement(Jp,{recorder:this.state.recorder}),i.createElement(Hp,{recorder:this.state.recorder})):null}render(){if(!this.state.recordingPhase)return null;let e,t,n;if(this.state.recordingPhase===jp.$T.Started){var s;let t=(0,l._t)("composer|send_voice_message");this.state.recorder&&(t=(0,l._t)("composer|stop_voice_message")),e=i.createElement(ie.A,{className:"mx_VoiceRecordComposerTile_stop",onClick:this.onRecordStartEndClick,title:t}),!this.state.recorder||null!==(s=this.state.recorder)&&void 0!==s&&s.isRecording||(e=null)}return this.state.recorder&&this.state.recordingPhase!==jp.$T.Uploading&&(t=i.createElement(ie.A,{className:"mx_VoiceRecordComposerTile_delete",title:(0,l._t)("action|delete"),onClick:this.onCancel})),this.state.recordingPhase===jp.$T.Uploading?n=i.createElement("span",{className:"mx_VoiceRecordComposerTile_uploadingState"},i.createElement(oa.A,{w:16,h:16})):this.state.didUploadFail&&this.state.recordingPhase===jp.$T.Ended&&(n=i.createElement("span",{className:"mx_VoiceRecordComposerTile_failedState"},i.createElement("span",{className:"mx_VoiceRecordComposerTile_uploadState_badge"},i.createElement(Yt.A,{notification:qt.d.forSymbol("!",da.S.Highlight)})),i.createElement("span",{className:"text-warning"},(0,l._t)("timeline|send_state_failed")))),i.createElement(i.Fragment,null,n,t,e,this.renderWaveformArea())}}(0,v.A)(og,"contextType",jt.Ay);var rg=n("./src/components/views/rooms/MessageComposerButtons.tsx"),ag=n("./src/components/views/rooms/wysiwyg_composer/index.ts");const lg="mx_wysiwyg_state_";let cg=0;function dg(e){var t;return i.createElement(ie.A,{className:"mx_MessageComposer_sendMessage",onClick:e.onClick,title:null!==(t=e.title)&&void 0!==t?t:(0,l._t)("composer|send_button_title")})}class mg extends i.Component{constructor(e,t){var n;super(e,t),(0,v.A)(this,"dispatcherRef",void 0),(0,v.A)(this,"messageComposerInput",(0,i.createRef)()),(0,v.A)(this,"voiceRecordingButton",(0,i.createRef)()),(0,v.A)(this,"ref",(0,i.createRef)()),(0,v.A)(this,"instanceId",void 0),(0,v.A)(this,"_voiceRecording",void 0),(0,v.A)(this,"saveWysiwygEditorState",(()=>{if(this.shouldSaveWysiwygEditorState()){const{isRichTextEnabled:e,composerContent:t}=this.state,n={content:t,isRichText:e,replyEventId:this.props.replyToEvent?this.props.replyToEvent.getId():void 0};localStorage.setItem(this.editorStateKey,JSON.stringify(n))}else this.clearStoredEditorState()})),(0,v.A)(this,"shouldSaveWysiwygEditorState",(()=>{const{isWysiwygLabEnabled:e,isComposerEmpty:t}=this.state;return e&&(!t||!!this.props.replyToEvent)})),(0,v.A)(this,"onResize",((e,t)=>{if(e===Zr.x.Resize){const{narrow:e}=this.context;this.setState({isMenuOpen:!!e&&this.state.isMenuOpen,isStickerPickerOpen:!1})}})),(0,v.A)(this,"onAction",(e=>{switch(e.action){case"reply_to_event":e.context===this.context.timelineRenderingType&&window.setTimeout((()=>{this.props.resizeNotifier.notifyTimelineHeightChanged()}),100);break;case W.r.SettingUpdated:{const t=e;switch(t.settingName){case"MessageComposerInput.showStickersButton":{const e=M.A.getValue("MessageComposerInput.showStickersButton");this.state.showStickersButton!==e&&this.setState({showStickersButton:e});break}case"MessageComposerInput.showPollsButton":{const e=M.A.getValue("MessageComposerInput.showPollsButton");this.state.showPollsButton!==e&&this.setState({showPollsButton:e});break}case Sl.O5.VoiceBroadcast:this.state.showVoiceBroadcastButton!==t.newValue&&this.setState({showVoiceBroadcastButton:!!t.newValue});break;case"feature_wysiwyg_composer":this.state.isWysiwygLabEnabled!==t.newValue&&this.setState({isWysiwygLabEnabled:Boolean(t.newValue)})}}}})),(0,v.A)(this,"onTombstoneClick",(e=>{var t,n;e.preventDefault();const i=null===(t=this.context.tombstone)||void 0===t?void 0:t.getContent().replacement_room,s=_.J.safeGet().getRoom(i);let r;if(s){const e=s.currentState.getStateEvents(o.EventType.RoomCreate,"");null!=e&&e.getId()&&(r=e.getId())}const a=null===(n=this.context.tombstone)||void 0===n?void 0:n.getSender(),l=a?[a.split(":").slice(1).join(":")]:void 0;S.A.dispatch({action:W.r.ViewRoom,highlighted:!0,event_id:r,room_id:i,auto_join:!0,via_servers:l,metricsTrigger:"Tombstone",metricsViaKeyboard:"click"!==e.type})})),(0,v.A)(this,"renderPlaceholderText",(()=>{if(this.props.replyToEvent){var e;const t=(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===o.THREAD_RELATION_TYPE.name;return t&&this.props.e2eStatus?(0,l._t)("composer|placeholder_thread_encrypted"):t?(0,l._t)("composer|placeholder_thread"):this.props.e2eStatus?(0,l._t)("composer|placeholder_reply_encrypted"):(0,l._t)("composer|placeholder_reply")}return this.props.e2eStatus?(0,l._t)("composer|placeholder_encrypted"):(0,l._t)("composer|placeholder")})),(0,v.A)(this,"addEmoji",(e=>(S.A.dispatch({action:W.r.ComposerInsert,text:e,timelineRenderingType:this.context.timelineRenderingType}),!0))),(0,v.A)(this,"sendMessage",(async()=>{var e,t;if(this.state.haveRecording&&this.voiceRecordingButton.current)await(null===(t=this.voiceRecordingButton.current)||void 0===t?void 0:t.send());else if(null===(e=this.messageComposerInput.current)||void 0===e||e.sendMessage(),this.state.isWysiwygLabEnabled){const{relation:e,replyToEvent:t}=this.props,n=this.state.composerContent;this.setState({composerContent:"",initialComposerContent:""}),S.A.dispatch({action:W.r.ClearAndFocusSendMessageComposer,timelineRenderingType:this.context.timelineRenderingType}),await(0,ag._z)(n,this.state.isRichTextEnabled,{mxClient:this.props.mxClient,roomContext:this.context,relation:e,replyToEvent:t})}})),(0,v.A)(this,"onChange",(e=>{this.setState({isComposerEmpty:e.isEmpty})})),(0,v.A)(this,"onWysiwygChange",(e=>{this.setState({composerContent:e,isComposerEmpty:0===(null==e?void 0:e.length)})})),(0,v.A)(this,"onRichTextToggle",(async()=>{const{richToPlain:e,plainToRich:t}=await(0,ag.Os)(),{isRichTextEnabled:n,composerContent:i}=this.state,s=n?await e(i,!1):await t(i,!1);this.setState({isRichTextEnabled:!n,composerContent:s,initialComposerContent:s})})),(0,v.A)(this,"onVoiceStoreUpdate",(()=>{this.updateRecordingState()})),(0,v.A)(this,"onRecordingStarted",(()=>{const e=Zp.getVoiceRecordingId(this.props.room,this.props.relation);this.voiceRecording=Zp.instance.getActiveRecording(e),this.setState({haveRecording:!!this.voiceRecording})})),(0,v.A)(this,"onRecordingEndingSoon",(({secondsLeft:e})=>{this.setState({recordingTimeLeftSeconds:e}),window.setTimeout((()=>this.setState({recordingTimeLeftSeconds:void 0})),3e3)})),(0,v.A)(this,"setStickerPickerOpen",(e=>{this.setState({isStickerPickerOpen:e,isMenuOpen:!1})})),(0,v.A)(this,"toggleStickerPickerOpen",(()=>{this.setStickerPickerOpen(!this.state.isStickerPickerOpen)})),(0,v.A)(this,"toggleButtonMenu",(()=>{this.setState({isMenuOpen:!this.state.isMenuOpen})})),(0,v.A)(this,"onRecordStartEndClick",(()=>{const e=X.M.instance.voiceBroadcastRecordingsStore.getCurrent();var t;e&&e.getState()!==Pt.HF.Stopped?k.Ay.createDialog(Ka.A,{title:(0,l._t)("voice_message|cant_start_broadcast_title"),description:i.createElement("p",null,(0,l._t)("voice_message|cant_start_broadcast_description")),hasCloseButton:!0}):null===(t=this.voiceRecordingButton.current)||void 0===t||t.onRecordStartEndClick();this.context.narrow&&this.toggleButtonMenu()})),this.context=t;const s=M.A.getValue("feature_wysiwyg_composer");let r=!0,a="";if(s){const e=this.restoreWysiwygEditorState();e&&(r=e.isRichText,a=e.content)}this.state={isComposerEmpty:0===(null===(n=a)||void 0===n?void 0:n.length),composerContent:a,haveRecording:!1,recordingTimeLeftSeconds:void 0,isMenuOpen:!1,isStickerPickerOpen:!1,showStickersButton:M.A.getValue("MessageComposerInput.showStickersButton"),showPollsButton:M.A.getValue("MessageComposerInput.showPollsButton"),showVoiceBroadcastButton:M.A.getValue(Sl.O5.VoiceBroadcast),isWysiwygLabEnabled:s,isRichTextEnabled:r,initialComposerContent:a},this.instanceId=cg++}get editorStateKey(){var e;let t=lg+this.props.room.roomId;return(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===o.THREAD_RELATION_TYPE.name&&(t+=`_${this.props.relation.event_id}`),t}restoreWysiwygEditorState(){const e=localStorage.getItem(this.editorStateKey);if(e)try{return JSON.parse(e)}catch(e){s.v.error(e)}}clearStoredEditorState(){localStorage.removeItem(this.editorStateKey)}get voiceRecording(){return this._voiceRecording}set voiceRecording(e){this._voiceRecording&&(this._voiceRecording.off(jp.$T.Started,this.onRecordingStarted),this._voiceRecording.off(jp.$T.EndingSoon,this.onRecordingEndingSoon)),this._voiceRecording=e,e&&(e.on(jp.$T.Started,this.onRecordingStarted),e.on(jp.$T.EndingSoon,this.onRecordingEndingSoon))}componentDidMount(){if(Zp.instance.on(_r.H,this.onVoiceStoreUpdate),window.addEventListener("beforeunload",this.saveWysiwygEditorState),this.state.isWysiwygLabEnabled){const e=this.restoreWysiwygEditorState();null!=e&&e.replyEventId&&S.A.dispatch({action:"reply_to_event",event:this.props.room.findEventById(e.replyEventId),context:this.context.timelineRenderingType})}M.A.monitorSetting("MessageComposerInput.showStickersButton",null),M.A.monitorSetting("MessageComposerInput.showPollsButton",null),M.A.monitorSetting(Sl.O5.VoiceBroadcast,null),M.A.monitorSetting("feature_wysiwyg_composer",null),this.dispatcherRef=S.A.register(this.onAction),this.waitForOwnMember(),Zr.A.instance.trackElementDimensions(`MessageComposer${this.instanceId}`,this.ref.current),Zr.A.instance.on(`MessageComposer${this.instanceId}`,this.onResize),this.updateRecordingState()}waitForOwnMember(){const e=this.props.room.getMember(_.J.safeGet().getUserId());e?this.setState({me:e}):this.props.room.loadMembersIfNeeded().then((()=>{var e;const t=null!==(e=this.props.room.getMember(_.J.safeGet().getSafeUserId()))&&void 0!==e?e:void 0;this.setState({me:t})}))}componentWillUnmount(){Zp.instance.off(_r.H,this.onVoiceStoreUpdate),S.A.unregister(this.dispatcherRef),Zr.A.instance.stopTrackingElementDimensions(`MessageComposer${this.instanceId}`),Zr.A.instance.removeListener(`MessageComposer${this.instanceId}`,this.onResize),window.removeEventListener("beforeunload",this.saveWysiwygEditorState),this.saveWysiwygEditorState(),this.voiceRecording=null}updateRecordingState(){const e=Zp.getVoiceRecordingId(this.props.room,this.props.relation);this.voiceRecording=Zp.instance.getActiveRecording(e),this.voiceRecording?this.voiceRecording.hasRecording&&!this.voiceRecording.isRecording&&this.setState({haveRecording:!0}):this.setState({haveRecording:!1})}get showStickersButton(){return this.state.showStickersButton&&!(0,Pi.F)(this.props.room)}getMenuPosition(){if(this.ref.current){const e=this.state.isWysiwygLabEnabled&&this.state.isRichTextEnabled,t=this.ref.current.getBoundingClientRect(),n=e?36:0,i=new DOMRect(t.x,t.y+n,t.width,t.height-n);return(0,Gt.qv)(i)}}render(){var e;const t=Boolean(!this.state.isWysiwygLabEnabled&&this.props.e2eStatus),n=t&&i.createElement("div",{className:"mx_MessageComposer_e2eIconWrapper"},i.createElement(ss.A,{key:"e2eIcon",status:this.props.e2eStatus,className:"mx_MessageComposer_e2eIcon"})),s=[],r=this.getMenuPosition(),a=this.context.canSendMessages&&!this.context.tombstone;let c;if(a)c=this.state.isWysiwygLabEnabled&&r?i.createElement(ag.W1,{key:"controls_input",disabled:this.state.haveRecording,onChange:this.onWysiwygChange,onSend:this.sendMessage,isRichTextEnabled:this.state.isRichTextEnabled,initialContent:this.state.initialComposerContent,e2eStatus:this.props.e2eStatus,menuPosition:r,placeholder:this.renderPlaceholderText(),eventRelation:this.props.relation}):i.createElement(ig.Ay,{ref:this.messageComposerInput,key:"controls_input",room:this.props.room,placeholder:this.renderPlaceholderText(),relation:this.props.relation,replyToEvent:this.props.replyToEvent,onChange:this.onChange,disabled:this.state.haveRecording,toggleStickerPickerOpen:this.toggleStickerPickerOpen}),s.push(i.createElement(og,{key:"controls_voice_record",ref:this.voiceRecordingButton,room:this.props.room,relation:this.props.relation,replyToEvent:this.props.replyToEvent}));else if(this.context.tombstone){const e=this.context.tombstone.getContent().replacement_room,t=e?i.createElement("a",{href:(0,yt.B4)(_.J.safeGet(),e),className:"mx_MessageComposer_roomReplaced_link",onClick:this.onTombstoneClick},(0,l._t)("composer|room_upgraded_link")):"";s.push(i.createElement("div",{className:"mx_MessageComposer_replaced_wrapper",key:"room_replaced"},i.createElement("div",{className:"mx_MessageComposer_replaced_valign"},i.createElement("img",{"aria-hidden":!0,alt:"",className:"mx_MessageComposer_roomReplaced_icon",src:"img/room_replaced.4ac105f.svg"}),i.createElement("span",{className:"mx_MessageComposer_roomReplaced_header"},(0,l._t)("composer|room_upgraded_notice")),i.createElement("br",null),t)))}else s.push(i.createElement("div",{key:"controls_error",className:"mx_MessageComposer_noperm_error"},(0,l._t)("composer|no_perms_notice")));const d=Boolean(this.state.recordingTimeLeftSeconds),m=this.state.recordingTimeLeftSeconds?Math.round(this.state.recordingTimeLeftSeconds):0,u=(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===o.THREAD_RELATION_TYPE.name?this.props.relation.event_id:null;s.push(i.createElement(Mp,{room:this.props.room,threadId:u,isStickerPickerOpen:this.state.isStickerPickerOpen,setStickerPickerOpen:this.setStickerPickerOpen,menuPosition:r,key:"stickers"}));const h=a&&(!this.state.isComposerEmpty||this.state.haveRecording),p=dt()({mx_MessageComposer:!0,"mx_MessageComposer--compact":this.props.compact,mx_MessageComposer_e2eStatus:t,mx_MessageComposer_wysiwyg:this.state.isWysiwygLabEnabled});return i.createElement(Et.m,{open:d,description:(0,Re.U)(m),placement:"bottom"},i.createElement("div",{className:p,ref:this.ref,role:"region","aria-label":(0,l._t)("a11y|message_composer")},i.createElement("div",{className:"mx_MessageComposer_wrapper"},i.createElement(Fp,{room:this.props.room,key:this.props.room.roomId}),i.createElement(Op,{replyToEvent:this.props.replyToEvent,permalinkCreator:this.props.permalinkCreator}),i.createElement("div",{className:"mx_MessageComposer_row"},n,c,i.createElement("div",{className:"mx_MessageComposer_actions"},s,a&&i.createElement(rg.Ay,{addEmoji:this.addEmoji,haveRecording:this.state.haveRecording,isMenuOpen:this.state.isMenuOpen,isStickerPickerOpen:this.state.isStickerPickerOpen,menuPosition:r,relation:this.props.relation,onRecordStartEndClick:this.onRecordStartEndClick,setStickerPickerOpen:this.setStickerPickerOpen,showLocationButton:!window.electron&&M.A.getValue(He.f.LocationSharing),showPollsButton:this.state.showPollsButton,showStickersButton:this.showStickersButton,isRichTextEnabled:this.state.isRichTextEnabled,onComposerModeClick:this.onRichTextToggle,toggleButtonMenu:this.toggleButtonMenu,showVoiceBroadcastButton:this.state.showVoiceBroadcastButton,onStartVoiceBroadcastClick:()=>{(async(e,t,n,i,s)=>{var o;if(!await(0,Pt.nR)(e,t,i))return null;const r=t.getUserId();if(!r)return null;const a=e.getMember(r);if(!a)return null;null===(o=n.getCurrent())||void 0===o||o.pause(),n.clearCurrent();const l=new Pt.wB(e,a,t,n,i);s.setCurrent(l)})(this.props.room,_.J.safeGet(),X.M.instance.voiceBroadcastPlaybacksStore,X.M.instance.voiceBroadcastRecordingsStore,X.M.instance.voiceBroadcastPreRecordingStore),this.toggleButtonMenu()}}),h&&i.createElement(dg,{key:"controls_send",onClick:this.sendMessage,title:this.state.haveRecording?(0,l._t)("composer|send_button_voice_message"):void 0}))))))}}(0,v.A)(mg,"contextType",jt.Ay),(0,v.A)(mg,"defaultProps",{compact:!1,showVoiceBroadcastButton:!1,isRichTextEnabled:!0});const ug=(0,Hn.dt)(mg);class hg{constructor(e){(0,v.A)(this,"serializedParts",null),(0,v.A)(this,"caret",null),this.event=e}setEditorState(e,t){this.caret=e,this.serializedParts=t}hasEditorState(){return!!this.serializedParts}getSerializedParts(){return this.serializedParts}getCaret(){return this.caret}getEvent(){return this.event}}var pg=n("./src/utils/FileUtils.ts");class gg extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,"dispatcherRef",void 0),(0,v.A)(this,"unmounted",!1),(0,v.A)(this,"onAction",(e=>{this.unmounted||function(e){return[W.r.UploadStarted,W.r.UploadProgress,W.r.UploadFailed,W.r.UploadFinished,W.r.UploadCanceled].includes(e.action)}(e)&&this.setState(this.calculateState())})),(0,v.A)(this,"onCancelClick",(e=>{e.preventDefault(),$d.Ay.sharedInstance().cancelUpload(this.state.currentUpload)})),this.state=this.calculateState()}componentDidMount(){this.unmounted=!1,this.dispatcherRef=S.A.register(this.onAction)}componentWillUnmount(){this.unmounted=!0,S.A.unregister(this.dispatcherRef)}getUploadsInRoom(){return $d.Ay.sharedInstance().getCurrentUploads(this.props.relation).filter((e=>e.roomId===this.props.room.roomId))}calculateState(){const[e,...t]=this.getUploadsInRoom();return{currentUpload:e,currentFile:null==e?void 0:e.fileName,currentLoaded:null==e?void 0:e.loaded,currentTotal:null==e?void 0:e.total,countFiles:t.length+1}}render(){if(!this.state.currentFile)return null;let e;e=this.state.countFiles>1?(0,l._t)("room|upload|uploading_multiple_file",{filename:this.state.currentFile,count:this.state.countFiles-1}):(0,l._t)("room|upload|uploading_single_file",{filename:this.state.currentFile});const t=(0,pg.Ov)(this.state.currentTotal);return i.createElement("div",{className:"mx_UploadBar"},i.createElement("div",{className:"mx_UploadBar_filename"},e," (",t,")"),i.createElement(ie.A,{onClick:this.onCancelClick,className:"mx_UploadBar_cancel"}),i.createElement(Pd.A,{value:this.state.currentLoaded,max:this.state.currentTotal}))}}const vg=["mxEvent","permalinkCreator","onMenuToggle"],_g=e=>{let{mxEvent:t,permalinkCreator:n,onMenuToggle:s}=e,o=(0,g.A)(e,vg);const[r,a,c,d]=(0,Gt.EF)(),m=(0,i.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),S.A.dispatch({action:W.r.ViewRoom,event_id:t.getId(),highlighted:!0,room_id:t.getRoomId(),metricsTrigger:void 0}),d()}),[t,d]),u=(0,i.useCallback)((async e=>{if(n){null==e||e.preventDefault(),null==e||e.stopPropagation();const i=n.forEvent(t.getId());await(0,Qn.nC)(i),d()}}),[t,d,n]);(0,i.useEffect)((()=>{null==s||s(r)}),[r,s]);const h=_.J.safeGet().getRoom(t.getRoomId()),p=!!h&&!Jh.aK.instance.hasMaximisedWidget(h);return i.createElement(i.Fragment,null,i.createElement(Gt.oW,(0,_t.A)({},o,{className:"mx_BaseCard_header_title_button--option",onClick:c,title:(0,l._t)("right_panel|thread_list|context_menu_label"),isExpanded:r,ref:a})),r&&i.createElement(na.Ay,(0,_t.A)({onFinished:d,className:"mx_RoomTile_contextMenu",compact:!0,rightAligned:!0},{left:(v=a.current.getBoundingClientRect()).left+window.scrollX+v.width,top:v.bottom+window.scrollY,chevronFace:Gt.t4.None}),i.createElement(na.tx,null,p&&i.createElement(na.R$,{onClick:e=>m(e),label:(0,l._t)("timeline|mab|view_in_room"),iconClassName:"mx_ThreadPanel_viewInRoom"}),n&&i.createElement(na.R$,{onClick:e=>u(e),label:(0,l._t)("timeline|mab|copy_link_thread"),iconClassName:"mx_ThreadPanel_copyLinkToThread"}))));var v};const fg=({parent:e,onFileDrop:t})=>{const[n,s]=(0,i.useState)({dragging:!1,counter:0});return(0,i.useEffect)((()=>{if(!e||e.ondrop)return;const n=e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer&&s((t=>({counter:t.counter+1,dragging:!(!e.dataTransfer.types.includes("Files")&&!e.dataTransfer.types.includes("application/x-moz-file"))||t.dragging})))},i=e=>{e.stopPropagation(),e.preventDefault(),s((e=>({counter:e.counter-1,dragging:!(e.counter<=1)&&e.dragging})))},o=e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="none",(e.dataTransfer.types.includes("Files")||e.dataTransfer.types.includes("application/x-moz-file"))&&(e.dataTransfer.dropEffect="copy"))},r=e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer&&(t(e.dataTransfer),s((e=>({dragging:!1,counter:e.counter-1}))))};return null==e||e.addEventListener("drop",r),null==e||e.addEventListener("dragover",o),null==e||e.addEventListener("dragenter",n),null==e||e.addEventListener("dragleave",i),()=>{null==e||e.removeEventListener("drop",r),null==e||e.removeEventListener("dragover",o),null==e||e.removeEventListener("dragenter",n),null==e||e.removeEventListener("dragleave",i)}}),[e,t]),n.dragging?i.createElement("div",{className:"mx_FileDropTarget"},i.createElement("img",{src:"img/upload-big.ade34b1.svg",className:"mx_FileDropTarget_image",alt:""}),(0,l._t)("room|drop_file_prompt")):null};var Eg,yg,bg=n("./src/dispatcher/payloads/ComposerInsertPayload.ts");function wg(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Sg(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?wg(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):wg(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class Ag extends i.Component{constructor(e,t){var n;super(e,t),(0,v.A)(this,"dispatcherRef",void 0),(0,v.A)(this,"layoutWatcherRef",void 0),(0,v.A)(this,"timelinePanel",(0,i.createRef)()),(0,v.A)(this,"card",(0,i.createRef)()),(0,v.A)(this,"eventId",void 0),(0,v.A)(this,"onAction",(e=>{switch(e.phase==fl.n.ThreadView&&e.event&&this.setupThread(e.event),e.action){case W.r.ComposerInsert:if(e.composerType)break;if(e.timelineRenderingType!==jt.Ae.Thread)break;S.A.dispatch(Sg(Sg({},e),{},{composerType:this.state.editState?bg.D.Edit:bg.D.Send}));break;case W.r.EditEvent:if(e.timelineRenderingType!==jt.Ae.Thread)return;if(e.event&&!e.event.getThread())return;this.setState({editState:e.event?new hg(e.event):void 0},(()=>{var t;e.event&&(null===(t=this.timelinePanel.current)||void 0===t||t.scrollToEventIfNeeded(e.event.getId()))}));break;case"reply_to_event":e.context===jt.Ae.Thread&&this.setState({replyToEvent:e.event})}})),(0,v.A)(this,"setupThread",(e=>{const t=e.getId();let n=this.props.room.getThread(t);if(!n){const i=[];null===e.status&&i.push(e),n=this.props.room.createThread(t,e,i,!0)}this.updateThread(n)})),(0,v.A)(this,"onNewThread",(e=>{e.id===this.props.mxEvent.getId()&&this.setupThread(this.props.mxEvent)})),(0,v.A)(this,"updateThreadRelation",(()=>{this.setState({lastReply:this.threadLastReply})})),(0,v.A)(this,"updateThread",(e=>{this.state.thread!==e&&(this.setupThreadListeners(e,this.state.thread),e&&this.setState({thread:e,lastReply:this.threadLastReply},(async()=>this.postThreadUpdate(e))))})),(0,v.A)(this,"resetJumpToEvent",(e=>{var t,n;this.props.initialEvent&&this.props.initialEventScrollIntoView&&e===(null===(t=this.props.initialEvent)||void 0===t?void 0:t.getId())&&S.A.dispatch({action:W.r.ViewRoom,room_id:this.props.room.roomId,event_id:null===(n=this.props.initialEvent)||void 0===n?void 0:n.getId(),highlighted:this.props.isInitialEventHighlighted,scroll_into_view:!1,replyingToEvent:this.state.replyToEvent,metricsTrigger:void 0})})),(0,v.A)(this,"onMeasurement",(e=>{this.setState({narrow:e})})),(0,v.A)(this,"onKeyDown",(e=>{let t=!1;if((0,_s.zM)().getRoomAction(e)===Pn.bY.UploadFile)S.A.dispatch({action:"upload_file",context:jt.Ae.Thread},!0),t=!0;t&&(e.stopPropagation(),e.preventDefault())})),(0,v.A)(this,"onFileDrop",(e=>{const t=this.props.mxEvent.getRoomId();t?$d.Ay.sharedInstance().sendContentListToRoom(Array.from(e.files),t,this.threadRelation,_.J.safeGet(),jt.Ae.Thread):console.warn("Unknwon roomId for event",this.props.mxEvent)})),(0,v.A)(this,"renderThreadViewHeader",(()=>i.createElement("div",{className:"mx_BaseCard_header_title"},i.createElement(Ql.A,{size:"4",className:"mx_BaseCard_header_title_heading"},(0,l._t)("common|thread")),i.createElement(_g,{mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator})))),this.setEventId(this.props.mxEvent);const s=null!==(n=this.props.room.getThread(this.eventId))&&void 0!==n?n:void 0;this.state={layout:M.A.getValue("layout"),narrow:!1,thread:s,lastReply:null==s?void 0:s.lastReply((e=>e.isRelation(o.THREAD_RELATION_TYPE.name)&&!e.status))}}componentDidMount(){this.setupThreadListeners(this.state.thread),this.layoutWatcherRef=M.A.watchSetting("layout",null,((...[,,,e])=>this.setState({layout:e}))),this.state.thread&&this.postThreadUpdate(this.state.thread),this.setupThread(this.props.mxEvent),this.dispatcherRef=S.A.register(this.onAction),this.props.room.on(o.ThreadEvent.New,this.onNewThread)}componentWillUnmount(){var e;S.A.unregister(this.dispatcherRef);const t=this.props.mxEvent.getRoomId();M.A.unwatchSetting(this.layoutWatcherRef);const n=X.M.instance.roomViewStore.getRoomId()!==t;this.props.initialEvent&&!n&&S.A.dispatch({action:W.r.ViewRoom,room_id:this.props.room.roomId,metricsTrigger:void 0}),S.A.dispatch({action:W.r.ViewThread,thread_id:null}),null===(e=this.state.thread)||void 0===e||e.off(o.ThreadEvent.NewReply,this.updateThreadRelation),this.props.room.off(o.RoomEvent.LocalEchoUpdated,this.updateThreadRelation),this.props.room.removeListener(o.ThreadEvent.New,this.onNewThread)}componentDidUpdate(e){e.mxEvent!==this.props.mxEvent&&(this.setEventId(this.props.mxEvent),this.setupThread(this.props.mxEvent)),e.room!==this.props.room&&_l.A.instance.setCard({phase:fl.n.RoomSummary})}setEventId(e){if(!e.getId())throw new Error("Got thread event without id");this.eventId=e.getId()}get threadLastReply(){var e,t;return null!==(e=null===(t=this.state.thread)||void 0===t?void 0:t.lastReply((e=>e.isRelation(o.THREAD_RELATION_TYPE.name)&&!e.status)))&&void 0!==e?e:void 0}async postThreadUpdate(e){var t,n;S.A.dispatch({action:W.r.ViewThread,thread_id:e.id}),e.emit(o.ThreadEvent.ViewThread),this.updateThreadRelation(),null===(t=this.timelinePanel.current)||void 0===t||t.refreshTimeline(null===(n=this.props.initialEvent)||void 0===n?void 0:n.getId())}setupThreadListeners(e,t){var n;t&&(null===(n=this.state.thread)||void 0===n||n.off(o.ThreadEvent.NewReply,this.updateThreadRelation),this.props.room.off(o.RoomEvent.LocalEchoUpdated,this.updateThreadRelation));e&&(e.on(o.ThreadEvent.NewReply,this.updateThreadRelation),this.props.room.on(o.RoomEvent.LocalEchoUpdated,this.updateThreadRelation))}get threadRelation(){var e,t,n,i;const s={rel_type:o.THREAD_RELATION_TYPE.name,event_id:null===(e=this.state.thread)||void 0===e?void 0:e.id,is_falling_back:!0},r=null!==(t=null===(n=this.state.lastReply)||void 0===n?void 0:n.getId())&&void 0!==t?t:null===(i=this.state.thread)||void 0===i?void 0:i.id;return r&&(s["m.in_reply_to"]={event_id:r}),s}render(){var e,t,n,o;const r=this.props.isInitialEventHighlighted?null===(e=this.props.initialEvent)||void 0===e?void 0:e.getId():void 0,a=this.threadRelation;let l;var c;this.state.thread?(this.props.initialEvent&&this.props.initialEvent.getRoomId()!==this.state.thread.roomId&&s.v.warn("ThreadView attempting to render TimelinePanel with mismatched initialEvent",this.state.thread.roomId,this.props.initialEvent.getRoomId(),this.props.initialEvent.getId()),l=i.createElement(i.Fragment,null,i.createElement(fg,{parent:this.card.current,onFileDrop:this.onFileDrop}),i.createElement(Cp,{key:this.state.thread.id,ref:this.timelinePanel,showReadReceipts:this.context.showReadReceipts,manageReadReceipts:!0,manageReadMarkers:!0,sendReadReceiptOnLoad:!0,timelineSet:this.state.thread.timelineSet,showUrlPreview:this.context.showUrlPreview,layout:this.state.layout===gt.P.Bubble?gt.P.Bubble:gt.P.Group,hideThreadedMessages:!1,hidden:!1,showReactions:!0,className:"mx_RoomView_messagePanel",permalinkCreator:this.props.permalinkCreator,membersLoaded:!0,editState:this.state.editState,eventId:null===(c=this.props.initialEvent)||void 0===c?void 0:c.getId(),highlightedEventId:r,eventScrollIntoView:this.props.initialEventScrollIntoView,onEventScrolledIntoView:this.resetJumpToEvent}))):l=i.createElement("div",{className:"mx_RoomView_messagePanelSpinner"},i.createElement(se.A,null));return i.createElement(jt.Ay.Provider,{value:Sg(Sg({},this.context),{},{timelineRenderingType:jt.Ae.Thread,threadId:null===(t=this.state.thread)||void 0===t?void 0:t.id,liveTimeline:null===(n=this.state)||void 0===n||null===(n=n.thread)||void 0===n||null===(n=n.timelineSet)||void 0===n?void 0:n.getLiveTimeline(),narrow:this.state.narrow})},i.createElement(Em.A,{className:dt()("mx_ThreadView mx_ThreadPanel",{mx_ThreadView_narrow:this.state.narrow}),onClose:this.props.onClose,withoutScrollContainer:!0,header:this.renderThreadViewHeader(),ref:this.card,onKeyDown:this.onKeyDown,onBack:e=>{Mn.A.trackInteraction("WebThreadViewBackButton",e)}},this.card.current&&i.createElement(xp,{sensor:this.card.current,onMeasurement:this.onMeasurement}),i.createElement("div",{className:"mx_ThreadView_timelinePanelWrapper"},l),$d.Ay.sharedInstance().getCurrentUploads(a).length>0&&i.createElement(gg,{room:this.props.room,relation:a}),(null===(o=this.state.thread)||void 0===o?void 0:o.timelineSet)&&i.createElement(ug,{room:this.props.room,resizeNotifier:this.props.resizeNotifier,relation:a,replyToEvent:this.state.replyToEvent,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus,compact:!0})))}}function Cg(){return Cg=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},Cg.apply(null,arguments)}(0,v.A)(Ag,"contextType",jt.Ay);var xg=function(e,t){return i.createElement("svg",Cg({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",role:"presentation","aria-hidden":!0,ref:t},e),Eg||(Eg=i.createElement("path",{stroke:"#656D77",strokeLinecap:"round",strokeWidth:1.5,d:"M1.75 2h12.5M1.75 6h12.5M1.75 10h6.5"})),yg||(yg=i.createElement("path",{stroke:"#656D77",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"m6.172 13 2.121 2.121 5.657-5.657"})))},kg=(0,i.forwardRef)(xg);var Rg=n("./src/accessibility/context_menu/ContextMenuButton.tsx");function Ig(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Tg(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ig(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ig(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let Pg=function(e){return e[e.My=0]="My",e[e.All=1]="All",e}({});const Ng=({label:e,description:t,onClick:n,isSelected:s})=>i.createElement(Gt.sH,{active:s,className:"mx_ThreadPanel_Header_FilterOptionItem",onClick:n},i.createElement("span",null,e),i.createElement("span",null,t)),Dg=({filterOption:e,setFilterOption:t})=>{const n=(0,Hn.nH)(),o=(0,jt.mP)(),[r,a,c,d]=(0,Gt.EF)(),m=[{label:(0,l._t)("threads|all_threads"),description:(0,l._t)("threads|all_threads_description"),key:Pg.All},{label:(0,l._t)("threads|my_threads"),description:(0,l._t)("threads|my_threads_description"),key:Pg.My}],u=m.find((t=>t.key===e)),h=m.map((e=>i.createElement(Ng,{key:e.key,label:e.label,description:e.description,onClick:()=>{t(e.key),d()},isSelected:e===u}))),p=r?i.createElement(Gt.Ay,{top:108,right:33,onFinished:d,chevronFace:Gt.t4.Top,wrapperClassName:"mx_BaseCard_header_title"},h):null,g=i.useCallback((e=>{Mn.A.trackInteraction("WebThreadsMarkAllReadButton",e),o.room?(0,mi.G9)(o.room,n).catch((e=>{s.v.error("Failed to mark all threads read",e)})):s.v.error("No room in context to mark all threads read")}),[o.room,n]);return i.createElement("div",{className:"mx_BaseCard_header_title"},i.createElement(Et.m,{label:(0,l._t)("threads|mark_all_read")},i.createElement(hl.K,{onClick:g,size:"24px"},i.createElement(kg,null))),i.createElement("div",{className:"mx_ThreadPanel_vertical_separator"}),i.createElement(Rg.V,{className:"mx_ThreadPanel_dropdown",ref:a,isExpanded:r,onClick:e=>{c(),Mn.A.trackInteraction("WebRightPanelThreadPanelFilterDropdown",e)}},`${(0,l._t)("threads|show_thread_filter")} ${null==u?void 0:u.label}`),p)},Mg=({roomId:e,onClose:t,permalinkCreator:n})=>{var s,r,a;const c=(0,i.useContext)(Hn.Ay),d=(0,i.useContext)(jt.Ay),m=(0,i.useRef)(null),u=(0,i.useRef)(null),h=(0,i.useRef)(null),[p,g]=(0,i.useState)(Pg.All),[v,_]=(0,i.useState)(null),[f,E]=(0,i.useState)(!1),y=p===Pg.My?null==v?void 0:v.threadsTimelineSets[1]:null==v?void 0:v.threadsTimelineSets[0],b=Boolean(null==v||null===(s=v.threadsTimelineSets)||void 0===s||null===(s=s[0])||void 0===s||null===(s=s.getLiveTimeline())||void 0===s||null===(s=s.getEvents())||void 0===s?void 0:s.length);return(0,i.useEffect)((()=>{const t=c.getRoom(e);null==t||t.createThreadsTimelineSets().then((()=>t.fetchRoomThreads())).then((()=>{g(Pg.All),_(t)}))}),[c,e]),(0,i.useEffect)((()=>{var e;y&&!o.Thread.hasServerSideSupport&&(null===(e=m.current)||void 0===e||e.refreshTimeline())}),[y,m]),i.createElement(jt.Ay.Provider,{value:Tg(Tg({},d),{},{timelineRenderingType:jt.Ae.ThreadsList,showHiddenEvents:!0,narrow:f})},i.createElement(Em.A,{header:b&&i.createElement(Dg,{filterOption:p,setFilterOption:g}),id:"thread-panel",className:"mx_ThreadPanel",ariaLabelledBy:"thread-panel-tab",role:"tabpanel",onClose:t,withoutScrollContainer:!0,ref:u,closeButtonRef:h},u.current&&i.createElement(xp,{sensor:u.current,onMeasurement:E}),y?i.createElement(Cp,{key:p+":"+(null!==(r=null===(a=y.getFilter())||void 0===a?void 0:a.filterId)&&void 0!==r?r:e),ref:m,showReadReceipts:!1,manageReadReceipts:!1,manageReadMarkers:!1,sendReadReceiptOnLoad:!1,timelineSet:y,showUrlPreview:!1,empty:i.createElement(kp,{Icon:Zt.A,title:(0,l._t)("threads|empty_title"),description:(0,l._t)("threads|empty_description",{replyInThread:(0,l._t)("action|reply_in_thread")})}),alwaysShowTimestamps:!0,layout:gt.P.Group,hideThreadedMessages:!1,hidden:!1,showReactions:!1,className:"mx_RoomView_messagePanel",membersLoaded:!0,permalinkCreator:n,disableGrouping:!0}):i.createElement("div",{className:"mx_AutoHideScrollbar"},i.createElement(se.A,null))))};var Og=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/notifications.js");function Lg(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Ug(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Lg(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Lg(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class Fg extends i.PureComponent{constructor(e,t){super(e,t),(0,v.A)(this,"card",i.createRef()),(0,v.A)(this,"onMeasurement",(e=>{this.setState({narrow:e})})),this.state={narrow:!1}}render(){const e=i.createElement(kp,{Icon:Og.A,title:(0,l._t)("notif_panel|empty_heading"),description:(0,l._t)("notif_panel|empty_description")});let t;const n=_.J.safeGet().getNotifTimelineSet();return n?t=i.createElement(Cp,{manageReadReceipts:!1,manageReadMarkers:!1,timelineSet:n,showUrlPreview:!1,empty:e,alwaysShowTimestamps:!0,layout:gt.P.Group}):(s.v.error("No notifTimelineSet available!"),t=i.createElement(se.A,null)),i.createElement(jt.Ay.Provider,{value:Ug(Ug({},this.context),{},{timelineRenderingType:jt.Ae.Notification,narrow:this.state.narrow})},i.createElement(Em.A,{header:(0,l._t)("notifications|enable_prompt_toast_title"),className:"mx_ThreadPanel",onClose:this.props.onClose,withoutScrollContainer:!0},this.card.current&&i.createElement(xp,{sensor:this.card.current,onMeasurement:this.onMeasurement}),t))}}(0,v.A)(Fg,"contextType",jt.Ay);var Vg=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/visibility-on.js"),Bg=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/forward.js"),jg=n("./src/components/views/messages/MessageEvent.tsx"),Wg=n("./src/events/forward/getForwardableEvent.ts"),zg=(n("./src/events/location/getShareableLocationEvent.ts"),n("./src/components/views/dialogs/ConfirmRedactDialog.tsx"));function Hg({event:e,room:t,permalinkCreator:n}){var s,o;const r=e.getSender();if(!r)throw new Error("Pinned event unexpectedly has no sender");const a=Boolean(e.threadRootId),c=!e.isThreadRoot&&a;return i.createElement("div",{className:"mx_PinnedEventTile",role:"listitem"},i.createElement("div",null,i.createElement(Mt.A,{className:"mx_PinnedEventTile_senderAvatar",member:e.sender,size:"32px",fallbackUserId:r})),i.createElement("div",{className:"mx_PinnedEventTile_wrapper"},i.createElement("div",{className:"mx_PinnedEventTile_top"},i.createElement(Et.m,{label:(null===(s=e.sender)||void 0===s?void 0:s.name)||r},i.createElement("span",{className:dt()("mx_PinnedEventTile_sender",(0,bt.yJ)(r))},(null===(o=e.sender)||void 0===o?void 0:o.name)||r)),i.createElement(Kg,{event:e,room:t,permalinkCreator:n})),i.createElement(jg.A,{mxEvent:e,maxImageHeight:150,onHeightChanged:()=>{},permalinkCreator:n,replacingEventId:e.replacingEventId()}),c&&i.createElement("div",{className:"mx_PinnedEventTile_thread"},i.createElement(Zt.A,null),(0,l._t)("right_panel|pinned_messages|reply_thread",{},{link:n=>i.createElement("button",{type:"button",onClick:()=>{if(!e.threadRootId)return;const n=t.findEventById(e.threadRootId);n&&S.A.dispatch({action:W.r.ShowThread,rootEvent:n,push:!0})}},n)}))))}function Kg({event:e,room:t,permalinkCreator:n}){var s;const[r,a]=(0,i.useState)(!1),c=(0,Hn.nH)(),d=(0,i.useCallback)((()=>{Mn.A.trackInteraction("PinnedMessageListViewTimeline"),S.A.dispatch({action:W.r.ViewRoom,event_id:e.getId(),highlighted:!0,room_id:e.getRoomId(),metricsTrigger:void 0})}),[e]),m=(0,eo.U)(t,(()=>Dn.A.canUnpin(c,e))),u=(0,i.useCallback)((async()=>{await Dn.A.pinOrUnpinEvent(c,e),Mn.A.trackPinUnpinMessage("Unpin","MessagePinningList")}),[e,c]),h=(0,Rt.qe)(e)&&(0,Wg.e)(e,c),p=(0,i.useCallback)((()=>{h&&S.A.dispatch({action:W.r.OpenForwardDialog,event:h,permalinkCreator:n})}),[h,n]),g=(null===(s=t.getLiveTimeline().getState(o.EventTimeline.FORWARDS))||void 0===s?void 0:s.maySendRedactionForEvent(e,c.getSafeUserId()))&&e.getType()!==o.EventType.RoomServerAcl&&e.getType()!==o.EventType.RoomEncryption,v=(0,i.useCallback)((()=>(0,zg.Q)({mxEvent:e})),[e]);return i.createElement(ml.W,{open:r,onOpenChange:a,showTitle:!1,title:(0,l._t)("right_panel|pinned_messages|menu"),side:"right",align:"start",trigger:i.createElement(hl.K,{size:"24px","aria-label":(0,l._t)("right_panel|pinned_messages|menu")},i.createElement(Xt.A,null))},i.createElement(ul.D,{Icon:Vg.A,label:(0,l._t)("right_panel|pinned_messages|view"),onSelect:d}),m&&i.createElement(ul.D,{Icon:en.A,label:(0,l._t)("action|unpin"),onSelect:u}),h&&i.createElement(ul.D,{Icon:Bg.A,label:(0,l._t)("action|forward"),onSelect:p}),g&&i.createElement(i.Fragment,null,i.createElement(nm.w,null),i.createElement(ul.D,{kind:"critical",Icon:nn.A,label:(0,l._t)("action|delete"),onSelect:v})))}function Jg({matrixClient:e,roomId:t,onFinished:n}){return i.createElement(J.A,{hasCancel:!0,title:(0,l._t)("right_panel|pinned_messages|unpin_all|title"),titleClass:"mx_UnpinAllDialog_title",className:"mx_UnpinAllDialog",onFinished:n,fixedWidth:!1},i.createElement(pl.E,{as:"span"},(0,l._t)("right_panel|pinned_messages|unpin_all|content")),i.createElement("div",{className:"mx_UnpinAllDialog_buttons"},i.createElement(mp.$,{destructive:!0,onClick:async()=>{try{await Dn.A.unpinAllEvents(e,t),Mn.A.trackPinUnpinMessage("Unpin","UnpinAll")}catch(e){s.v.error("Failed to unpin all events:",e)}n()}},(0,l._t)("action|continue")),i.createElement(mp.$,{kind:"tertiary",onClick:n},(0,l._t)("action|cancel"))))}function Gg(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function $g(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Gg(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Gg(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function qg({room:e,onClose:t,permalinkCreator:n}){const s=(0,Hn.nH)(),r=(0,jt.mP)(),a=zu(e),c=(e=>{const[t,n]=(0,i.useState)(new Set),s=(0,i.useCallback)((t=>{t&&t.getType()!==Bu.M||n(Hu(e))}),[e]);return(0,ci.YK)(e,o.RoomEvent.AccountData,s),(0,i.useEffect)((()=>(n(Hu(e)),()=>{n(new Set)})),[e]),t})(e),d=Ju(e,a);let m;return(0,i.useEffect)((()=>{if(!s||s.isGuest())return;a.filter((e=>!c.has(e))).length>0&&s.setRoomAccountData(e.roomId,Bu.M,{event_ids:a})}),[s,e.roomId,a,c]),m=a.length?null!=d&&d.length?i.createElement(Yg,{events:(0,Z.Bo)(d),room:e,permalinkCreator:n}):i.createElement(se.A,null):i.createElement(kp,{Icon:tn.A,title:(0,l._t)("right_panel|pinned_messages|empty_title"),description:(0,l._t)("right_panel|pinned_messages|empty_description",{pinAction:(0,l._t)("action|pin")})}),i.createElement(Em.A,{header:(0,l._t)("right_panel|pinned_messages|header",{count:a.length}),className:"mx_PinnedMessagesCard",onClose:t},i.createElement(jt.Ay.Provider,{value:$g($g({},r),{},{timelineRenderingType:jt.Ae.Pinned})},m))}function Yg({events:e,room:t,permalinkCreator:n}){const s=(0,Hn.nH)(),o=(0,eo.U)(t,(()=>Dn.A.userHasPinOrUnpinPermission(s,t))),r=(0,i.useCallback)((async()=>{k.Ay.createDialog(Jg,{roomId:t.roomId,matrixClient:s})}),[t,s]);return i.createElement(i.Fragment,null,i.createElement("div",{className:dt()("mx_PinnedMessagesCard_wrapper",{mx_PinnedMessagesCard_wrapper_unpin_all:o}),role:"list"},e.map(((s,o)=>i.createElement(i.Fragment,null,i.createElement(Hg,{key:s.getId(),event:s,permalinkCreator:n,room:t}),e.length-1!==o&&i.createElement(nm.w,{key:`separator-${s.getId()}`,className:"mx_PinnedMessagesCard_Separator"}))))),o&&i.createElement("div",{className:"mx_PinnedMessagesCard_unpin"},i.createElement(mp.$,{kind:"tertiary",onClick:r},(0,l._t)("right_panel|pinned_messages|unpin_all|button"))))}const Qg=e=>{const t=dt()({mx_JumpToBottomButton:!0,mx_JumpToBottomButton_highlight:e.highlight});let n;return e.numUnreadMessages&&(n=i.createElement("div",{className:"mx_JumpToBottomButton_badge"},e.numUnreadMessages)),i.createElement("div",{className:t},i.createElement(ie.A,{className:"mx_JumpToBottomButton_scrollDown",title:(0,l._t)("room|jump_to_bottom_button"),onClick:e.onScrollToBottomClick}),n)};function Xg(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Zg(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Xg(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Xg(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class ev extends i.Component{constructor(e,t){super(e,t),(0,v.A)(this,"dispatcherRef",void 0),(0,v.A)(this,"layoutWatcherRef",void 0),(0,v.A)(this,"timelinePanel",i.createRef()),(0,v.A)(this,"card",i.createRef()),(0,v.A)(this,"readReceiptsSettingWatcher",void 0),(0,v.A)(this,"onRoomViewStoreUpdate",(async e=>{const t={initialEventId:X.M.instance.roomViewStore.getInitialEventId(),isInitialEventHighlighted:X.M.instance.roomViewStore.isInitialEventHighlighted(),replyToEvent:X.M.instance.roomViewStore.getQuotingEvent()};this.setState(t)})),(0,v.A)(this,"onAction",(e=>{if(e.action===W.r.EditEvent)this.setState({editState:e.event?new hg(e.event):void 0},(()=>{var t;e.event&&(null===(t=this.timelinePanel.current)||void 0===t||t.scrollToEventIfNeeded(e.event.getId()))}))})),(0,v.A)(this,"onScroll",(()=>{const e=this.timelinePanel.current;e&&(e.isAtEndOfLiveTimeline()?this.setState({atEndOfLiveTimeline:!0}):this.setState({atEndOfLiveTimeline:!1}),this.state.initialEventId&&this.state.isInitialEventHighlighted&&S.A.dispatch({action:W.r.ViewRoom,room_id:this.props.room.roomId,event_id:this.state.initialEventId,highlighted:!1,replyingToEvent:this.state.replyToEvent,metricsTrigger:void 0}))})),(0,v.A)(this,"onMeasurement",(e=>{this.setState({narrow:e})})),(0,v.A)(this,"jumpToLiveTimeline",(()=>{var e;this.state.initialEventId&&this.state.isInitialEventHighlighted?S.A.dispatch({action:W.r.ViewRoom,room_id:this.props.room.roomId}):(null===(e=this.timelinePanel.current)||void 0===e||e.jumpToLiveTimeline(),S.A.fire(W.r.FocusSendMessageComposer))})),this.state={showReadReceipts:M.A.getValue("showReadReceipts",e.room.roomId),layout:M.A.getValue("layout"),atEndOfLiveTimeline:!0,narrow:!1}}componentDidMount(){X.M.instance.roomViewStore.addListener(_r.H,this.onRoomViewStoreUpdate),this.dispatcherRef=S.A.register(this.onAction),this.readReceiptsSettingWatcher=M.A.watchSetting("showReadReceipts",null,((...[,,,e])=>this.setState({showReadReceipts:e}))),this.layoutWatcherRef=M.A.watchSetting("layout",null,((...[,,,e])=>this.setState({layout:e})))}componentWillUnmount(){X.M.instance.roomViewStore.removeListener(_r.H,this.onRoomViewStoreUpdate),M.A.unwatchSetting(this.readReceiptsSettingWatcher),M.A.unwatchSetting(this.layoutWatcherRef),S.A.unregister(this.dispatcherRef)}render(){var e,t;const n=this.state.isInitialEventHighlighted?this.state.initialEventId:void 0;let s;this.state.atEndOfLiveTimeline||(s=i.createElement(Qg,{highlight:this.props.room.getUnreadNotificationCount(o.NotificationCountType.Highlight)>0,onScrollToBottomClick:this.jumpToLiveTimeline}));const r=$d.Ay.sharedInstance().getCurrentUploads(this.props.composerRelation).length>0,a=this.props.room.getMyMembership()===ut.O.Join;return i.createElement(jt.Ay.Provider,{value:Zg(Zg({},this.context),{},{timelineRenderingType:null!==(e=this.props.timelineRenderingType)&&void 0!==e?e:this.context.timelineRenderingType,liveTimeline:null===(t=this.props.timelineSet)||void 0===t?void 0:t.getLiveTimeline(),narrow:this.state.narrow})},i.createElement(Em.A,{className:this.props.classNames,onClose:this.props.onClose,withoutScrollContainer:!0,header:(0,l._t)("right_panel|video_room_chat|title"),ref:this.card},this.card.current&&i.createElement(xp,{sensor:this.card.current,onMeasurement:this.onMeasurement}),i.createElement("div",{className:"mx_TimelineCard_timeline"},s,i.createElement(Cp,{ref:this.timelinePanel,showReadReceipts:this.state.showReadReceipts,manageReadReceipts:!0,manageReadMarkers:!1,sendReadReceiptOnLoad:!0,timelineSet:this.props.timelineSet,showUrlPreview:this.context.showUrlPreview,layout:this.state.layout===gt.P.Bubble?gt.P.Bubble:gt.P.Group,hideThreadedMessages:!1,hidden:!1,showReactions:!0,className:"mx_RoomView_messagePanel",permalinkCreator:this.props.permalinkCreator,membersLoaded:!0,editState:this.state.editState,eventId:this.state.initialEventId,resizeNotifier:this.props.resizeNotifier,highlightedEventId:n,onScroll:this.onScroll})),r&&i.createElement(gg,{room:this.props.room,relation:this.props.composerRelation}),a&&i.createElement(ug,{room:this.props.room,relation:this.props.composerRelation,resizeNotifier:this.props.resizeNotifier,replyToEvent:this.state.replyToEvent,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus,compact:!0})))}}(0,v.A)(ev,"contextType",jt.Ay);var tv=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/plus.js");const nv=({app:e,room:t})=>{const n=th.A.getWidgetName(e),[s,o]=(0,i.useState)();(0,i.useEffect)((()=>{o(th.A.canUserModifyWidgets(t.client,t.roomId))}),[t.client,t.roomId]);const r=Jh.aK.instance.isInContainer(t,e,Jh.mc.Top),a=r?()=>{Jh.aK.instance.moveToContainer(t,e,Jh.mc.Right)}:()=>{Jh.aK.instance.moveToContainer(t,e,Jh.mc.Top)},[c,d,m,u]=(0,Gt.EF)();let h;if(c){var p,g,v;const t=null===(p=d.current)||void 0===p?void 0:p.getBoundingClientRect(),n=null!==(g=null==t?void 0:t.right)&&void 0!==g?g:0,s=null!==(v=null==t?void 0:t.top)&&void 0!==v?v:0;h=i.createElement(ip,{chevronFace:Gt.t4.None,right:Zr.A.instance.windowWidth-n,bottom:Zr.A.instance.windowHeight-s,onFinished:u,app:e})}const _=!r&&!Jh.aK.instance.canAddToContainer(t,Jh.mc.Top);let f;f=_?(0,l._t)("right_panel|pinned_messages|limits",{count:Jh.yQ}):r?(0,l._t)("action|unpin"):(0,l._t)("action|pin");const E=Jh.aK.instance.isInContainer(t,e,Jh.mc.Center);let y="";r?y=(0,l._t)("widget|unpin_to_view_right_panel"):E&&(y=(0,l._t)("widget|close_to_view_right_panel"));const b=dt()("mx_BaseCard_Button mx_ExtensionsCard_Button",{mx_ExtensionsCard_Button_pinned:r});return i.createElement("div",{className:b,ref:d},i.createElement(ie.A,{className:"mx_ExtensionsCard_icon_app",onClick:()=>{_l.A.instance.pushCard({phase:fl.n.Widget,state:{widgetId:e.id}})},title:r||E?y:void 0,disabled:r||E},i.createElement(op,{app:e,size:"24px"}),i.createElement(pl.E,{size:"md",weight:"medium",className:"mx_lineClamp"},n)),s&&i.createElement(Gt.oW,{className:"mx_ExtensionsCard_app_options",isExpanded:c,onClick:m,title:(0,l._t)("common|options")}),i.createElement(ie.A,{className:"mx_ExtensionsCard_app_pinToggle",onClick:a,title:f,disabled:_}),h)},iv=({room:e,onClose:t})=>{const n=(0,th.X)(e),s=(0,i.useMemo)((()=>n.filter((e=>void 0!==e.eventId))),[n]);let o;if(s.length<1)o=i.createElement(kp,{Icon:dm.A,title:(0,l._t)("right_panel|extensions_empty_title"),description:(0,l._t)("right_panel|extensions_empty_description",{addIntegrations:(0,l._t)("right_panel|add_integrations")})});else{let t=null;Jh.aK.instance.canCopyLayoutToRoom(e)&&(t=i.createElement(Qd.N,{onClick:()=>Jh.aK.instance.copyLayoutToRoom(e)},(0,l._t)("widget|set_room_layout"))),o=i.createElement(i.Fragment,null,i.createElement(nm.w,null),s.map((t=>i.createElement(nv,{key:t.id,app:t,room:e}))),t)}return i.createElement(Em.A,{header:(0,l._t)("right_panel|extensions_button"),className:"mx_ExtensionsCard",onClose:t},i.createElement(mp.$,{size:"sm",onClick:()=>{const t=U.J.sharedInstance();var n;t.hasManager()?null===(n=t.getPrimaryManager())||void 0===n||n.open(e):t.openNoManagerDialog()},kind:"secondary",Icon:tv.A},(0,l._t)("right_panel|add_integrations")),o)};function sv(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}class ov extends i.Component{constructor(e,t){super(e,t),(0,v.A)(this,"delayedUpdate",(0,Vn.throttle)((()=>{this.forceUpdate()}),500,{leading:!0,trailing:!0})),(0,v.A)(this,"onRoomStateMember",((e,t,n)=>{var i;this.props.room&&n.roomId===this.props.room.roomId&&(this.state.phase===fl.n.RoomMemberList||this.state.phase===fl.n.RoomMemberInfo&&n.userId===(null===(i=this.state.cardState)||void 0===i||null===(i=i.member)||void 0===i?void 0:i.userId))&&this.delayedUpdate()})),(0,v.A)(this,"onRightPanelStoreUpdate",(()=>{this.setState(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?sv(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):sv(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},ov.getDerivedStateFromProps(this.props)))})),(0,v.A)(this,"onClose",(()=>{var e,t;if(null!==(e=this.props.overwriteCard)&&void 0!==e&&null!==(e=e.state)&&void 0!==e&&e.member)S.A.dispatch({action:W.r.ViewHomePage});else if(this.state.phase===fl.n.EncryptionPanel&&null!==(t=this.state.cardState)&&void 0!==t&&null!==(t=t.verificationRequest)&&void 0!==t&&t.pending)this.state.cardState.verificationRequest.cancel();else{var n,i;_l.A.instance.togglePanel(null!==(n=null===(i=this.props.room)||void 0===i?void 0:i.roomId)&&void 0!==n?n:null)}})),(0,v.A)(this,"onSearchQueryChanged",(e=>{this.setState({searchQuery:e})})),this.state={searchQuery:""}}componentDidMount(){this.context.on(o.RoomStateEvent.Members,this.onRoomStateMember),_l.A.instance.on(_r.H,this.onRightPanelStoreUpdate)}componentWillUnmount(){var e;null===(e=this.context)||void 0===e||e.removeListener(o.RoomStateEvent.Members,this.onRoomStateMember),_l.A.instance.off(_r.H,this.onRightPanelStoreUpdate)}static getDerivedStateFromProps(e){var t,n,i;let s;return e.room&&(s=_l.A.instance.currentCardForRoom(e.room.roomId)),{cardState:null===(t=s)||void 0===t?void 0:t.state,phase:null!==(n=null===(i=s)||void 0===i?void 0:i.phase)&&void 0!==n?n:void 0}}render(){var e,t,n,s,r;let a=i.createElement("div",null);const l=null===(e=this.props.room)||void 0===e?void 0:e.roomId,c=null!==(t=null===(n=this.props.overwriteCard)||void 0===n?void 0:n.phase)&&void 0!==t?t:this.state.phase,d=null!==(s=null===(r=this.props.overwriteCard)||void 0===r?void 0:r.state)&&void 0!==s?s:this.state.cardState;switch(c){case fl.n.RoomMemberList:l&&(a=i.createElement(pp,{roomId:l,key:l,onClose:this.onClose,searchQuery:this.state.searchQuery,onSearchQueryChanged:this.onSearchQueryChanged}));break;case fl.n.SpaceMemberList:var m,u;if(null!=d&&d.spaceId||l)a=i.createElement(pp,{roomId:null!==(m=null==d?void 0:d.spaceId)&&void 0!==m?m:l,key:null!==(u=null==d?void 0:d.spaceId)&&void 0!==u?u:l,onClose:this.onClose,searchQuery:this.state.searchQuery,onSearchQueryChanged:this.onSearchQueryChanged});break;case fl.n.RoomMemberInfo:case fl.n.SpaceMemberInfo:case fl.n.EncryptionPanel:if(null!=d&&d.member){var h;const e=d.member instanceof o.RoomMember?d.member:void 0;a=i.createElement(gp.Ay,{user:d.member,room:null!==(h=this.context.getRoom(null==e?void 0:e.roomId))&&void 0!==h?h:this.props.room,key:null!=l?l:d.member.userId,onClose:this.onClose,phase:c,verificationRequest:d.verificationRequest,verificationRequestPromise:d.verificationRequestPromise})}break;case fl.n.Room3pidMemberInfo:case fl.n.Space3pidMemberInfo:null!=d&&d.memberInfoEvent&&(a=i.createElement(vp,{event:d.memberInfoEvent,key:l,onClose:this.onClose}));break;case fl.n.NotificationPanel:a=i.createElement(Fg,{onClose:this.onClose});break;case fl.n.PinnedMessages:this.props.room&&(a=i.createElement(qg,{room:this.props.room,onClose:this.onClose,permalinkCreator:this.props.permalinkCreator}));break;case fl.n.Timeline:this.props.room&&(a=i.createElement(ev,{classNames:"mx_ThreadPanel mx_TimelineCard",room:this.props.room,timelineSet:this.props.room.getUnfilteredTimelineSet(),resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus}));break;case fl.n.FilePanel:l&&(a=i.createElement(Pp,{roomId:l,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose}));break;case fl.n.ThreadView:this.props.room&&null!=d&&d.threadHeadEvent&&(a=i.createElement(Ag,{room:this.props.room,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,mxEvent:d.threadHeadEvent,initialEvent:d.initialEvent,isInitialEventHighlighted:d.isInitialEventHighlighted,initialEventScrollIntoView:d.initialEventScrollIntoView,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus}));break;case fl.n.ThreadPanel:this.props.room&&(a=i.createElement(Mg,{roomId:this.props.room.roomId,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,permalinkCreator:this.props.permalinkCreator}));break;case fl.n.RoomSummary:this.props.room&&(a=i.createElement(eh,{room:this.props.room,permalinkCreator:this.props.permalinkCreator,onSearchChange:this.props.onSearchChange,onSearchCancel:this.props.onSearchCancel,focusRoomSearch:null==d?void 0:d.focusRoomSearch}));break;case fl.n.Extensions:this.props.room&&(a=i.createElement(iv,{room:this.props.room,onClose:this.onClose}));break;case fl.n.Widget:this.props.room&&null!=d&&d.widgetId&&(a=i.createElement(dp,{room:this.props.room,widgetId:d.widgetId,onClose:this.onClose}))}return i.createElement("aside",{className:"mx_RightPanel",id:"mx_RightPanel"},a)}}(0,v.A)(ov,"contextType",Hn.Ay);class rv{constructor(){(0,v.A)(this,"scrollStateMap",new Map)}getScrollState(e){return this.scrollStateMap.get(e)}setScrollState(e,t){null===t?this.scrollStateMap.delete(e):this.scrollStateMap.set(e,t)}}void 0===window.mxRoomScrollStateStore&&(window.mxRoomScrollStateStore=new rv);const av=window.mxRoomScrollStateStore;var lv=n("./src/stores/WidgetEchoStore.ts"),cv=n("./node_modules/@matrix-org/react-sdk-module-api/lib/lifecycles/RoomViewLifecycle.js"),dv=n("./src/IdentityAuthClient.tsx");class mv extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,"onViewClick",(()=>{this.setState({hidden:!1})})),this.state={hidden:!0}}render(){const e=dt()({mx_InviteReason:!0,mx_InviteReason_hidden:this.state.hidden});return i.createElement("div",{className:e},i.createElement("div",{className:"mx_InviteReason_reason"},this.props.htmlReason?(0,zn.bk)(this.props.htmlReason):this.props.reason),i.createElement(ie.A,{kind:"link_inline",className:"mx_InviteReason_view",onClick:this.onViewClick},(0,l._t)("common|view_message")))}}var uv=n("./res/img/element-icons/ask-to-join.svg");var hv=function(e){return e.NotLoggedIn="NotLoggedIn",e.Joining="Joining",e.Loading="Loading",e.Rejecting="Rejecting",e.Kicked="Kicked",e.Banned="Banned",e.OtherThreePIDError="OtherThreePIDError",e.InvitedEmailNotFoundInAccount="InvitedEmailNotFoundInAccount",e.InvitedEmailNoIdentityServer="InvitedEmailNoIdentityServer",e.InvitedEmailMismatch="InvitedEmailMismatch",e.Invite="Invite",e.ViewingRoom="ViewingRoom",e.RoomNotFound="RoomNotFound",e.OtherError="OtherError",e.PromptAskToJoin="PromptAskToJoin",e.Knocked="Knocked",e.RequestDenied="requestDenied",e}(hv||{});class pv extends i.Component{constructor(e){super(e),(0,v.A)(this,"onLoginClick",(()=>{S.A.dispatch({action:"start_login",screenAfterLogin:this.makeScreenAfterLogin()})})),(0,v.A)(this,"onRegisterClick",(()=>{S.A.dispatch({action:"start_registration",screenAfterLogin:this.makeScreenAfterLogin()})})),(0,v.A)(this,"onChangeReason",(e=>{this.setState({reason:e.target.value})})),this.state={busy:!1}}componentDidMount(){this.checkInvitedEmail()}componentDidUpdate(e,t){this.props.invitedEmail===e.invitedEmail&&this.props.inviterName===e.inviterName||this.checkInvitedEmail()}async checkInvitedEmail(){if(this.props.inviterName&&this.props.invitedEmail){this.setState({busy:!0});try{const e=await _.J.safeGet().getThreePids();if(this.setState({accountEmails:e.threepids.filter((e=>"email"===e.medium)).map((e=>e.address))}),!_.J.safeGet().getIdentityServerUrl())return void this.setState({busy:!1});const t=new dv.A,n=await t.getAccessToken(),i=await _.J.safeGet().lookupThreePid("email",this.props.invitedEmail,n);if(!("mxid"in i))throw new l.P7("room|error_3pid_invite_email_lookup");this.setState({invitedEmailMxid:i.mxid})}catch(e){this.setState({threePidFetchError:e})}this.setState({busy:!1})}}getMessageCase(){if(_.J.safeGet().isGuest())return hv.NotLoggedIn;const e=this.getMyMember();if(e){var t;const n=null===(t=e.events.member)||void 0===t?void 0:t.getPrevContent().membership;if(e.isKicked())return n===ut.O.Knock?hv.RequestDenied:this.props.promptAskToJoin?hv.PromptAskToJoin:hv.Kicked;if(e.membership===ut.O.Ban)return hv.Banned}if(this.props.joining)return hv.Joining;if(this.props.rejecting)return hv.Rejecting;if(this.props.loading||this.state.busy)return hv.Loading;if(this.props.knocked)return hv.Knocked;if(this.props.canAskToJoinAndMembershipIsLeave||this.props.promptAskToJoin)return hv.PromptAskToJoin;if(this.props.inviterName){if(this.props.invitedEmail){if(this.state.threePidFetchError)return hv.OtherThreePIDError;if(this.state.accountEmails&&!this.state.accountEmails.includes(this.props.invitedEmail))return hv.InvitedEmailNotFoundInAccount;if(!_.J.safeGet().getIdentityServerUrl())return hv.InvitedEmailNoIdentityServer;if(this.state.invitedEmailMxid!=_.J.safeGet().getUserId())return hv.InvitedEmailMismatch}return hv.Invite}return this.props.error?"M_NOT_FOUND"==this.props.error.errcode?hv.RoomNotFound:hv.OtherError:hv.ViewingRoom}getKickOrBanInfo(){var e,t,n,i;const s=this.getMyMember();if(!s)return{};const o=null===(e=s.events.member)||void 0===e?void 0:e.getSender(),r=o?null===(t=this.props.room)||void 0===t?void 0:t.currentState.getMember(o):void 0;return{memberName:null!==(n=null==r?void 0:r.name)&&void 0!==n?n:o,reason:null===(i=s.events.member)||void 0===i?void 0:i.getContent().reason}}joinRule(){var e,t;return null!==(e=null===(t=this.props.room)||void 0===t||null===(t=t.currentState.getStateEvents(o.EventType.RoomJoinRules,""))||void 0===t?void 0:t.getContent().join_rule)&&void 0!==e?e:null}getMyMember(){var e,t;return null!==(e=null===(t=this.props.room)||void 0===t?void 0:t.getMember(_.J.safeGet().getSafeUserId()))&&void 0!==e?e:null}getInviteMember(){var e;const{room:t}=this.props;if(!t)return null;const n=_.J.safeGet().getSafeUserId(),i=t.currentState.getMember(n);if(!i)return null;const s=null===(e=i.events.member)||void 0===e?void 0:e.getSender();return s?t.currentState.getMember(s):null}isDMInvite(){var e;const t=this.getMyMember();if(!t)return!1;const n=null===(e=t.events.member)||void 0===e?void 0:e.getContent();return(null==n?void 0:n.membership)===ut.O.Invite&&n.is_direct}makeScreenAfterLogin(){var e,t,n,i,s,o;return{screen:"room",params:{email:this.props.invitedEmail,signurl:this.props.signUrl,room_name:null!==(e=null===(t=this.props.oobData)||void 0===t?void 0:t.name)&&void 0!==e?e:null,room_avatar_url:null!==(n=null===(i=this.props.oobData)||void 0===i?void 0:i.avatarUrl)&&void 0!==n?n:null,inviter_name:null!==(s=null===(o=this.props.oobData)||void 0===o?void 0:o.inviterName)&&void 0!==s?s:null}}}render(){var e,t,n,s,r,a;const d=c.Ay.get().brand,m=null!==(e=null!==(t=null===(n=this.props.room)||void 0===n?void 0:n.name)&&void 0!==t?t:this.props.roomAlias)&&void 0!==e?e:"",u=null!==(s=null===(r=this.props.room)||void 0===r?void 0:r.isSpaceRoom())&&void 0!==s?s:(null===(a=this.props.oobData)||void 0===a?void 0:a.roomType)===o.RoomType.Space;let h,p,g,v,E,y,b,w,S=!1;const A=[],C=this.getMessageCase();switch(C){case hv.Joining:var x;h=null!==(x=this.props.oobData)&&void 0!==x&&x.roomType||u?u?(0,l._t)("room|joining_space"):(0,l._t)("room|joining_room"):(0,l._t)("room|joining"),S=!0;break;case hv.Loading:h=(0,l._t)("common|loading"),S=!0;break;case hv.Rejecting:h=(0,l._t)("room|rejecting"),S=!0;break;case hv.NotLoggedIn:{const e={canJoin:!1};this.props.roomId&&f.r.instance.invoke(cv.J.PreviewRoomNotLoggedIn,e,this.props.roomId),e.canJoin?(h=(0,l._t)("room|join_title"),E=(0,l._t)("action|join"),v=()=>{f.r.instance.invoke(cv.J.JoinFromRoomPreview,this.props.roomId)}):(h=(0,l._t)("room|join_title_account"),M.A.getValue(He.f.Registration)&&(E=(0,l._t)("room|join_button_account"),v=this.onRegisterClick),b=(0,l._t)("action|sign_in"),y=this.onLoginClick),this.props.previewLoading&&(w=i.createElement("div",null,i.createElement(se.A,{w:20,h:20}),(0,l._t)("room|loading_preview")));break}case hv.Kicked:{const{memberName:e,reason:t}=this.getKickOrBanInfo();h=m?(0,l._t)("room|kicked_from_room_by",{memberName:e,roomName:m}):(0,l._t)("room|kicked_by",{memberName:e}),p=t?(0,l._t)("room|kick_reason",{reason:t}):void 0,E=u?(0,l._t)("room|forget_space"):(0,l._t)("room|forget_room"),v=this.props.onForgetClick,this.joinRule()!==o.JoinRule.Invite&&(b=E,y=v,E=(0,l._t)("room|rejoin_button"),v=this.props.onJoinClick);break}case hv.RequestDenied:h=(0,l._t)("room|knock_denied_title"),p=(0,l._t)("room|knock_denied_subtitle"),E=u?(0,l._t)("room|forget_space"):(0,l._t)("room|forget_room"),v=this.props.onForgetClick;break;case hv.Banned:{const{memberName:e,reason:t}=this.getKickOrBanInfo();h=m?(0,l._t)("room|banned_from_room_by",{memberName:e,roomName:m}):(0,l._t)("room|banned_by",{memberName:e}),p=t?(0,l._t)("room|kick_reason",{reason:t}):void 0,E=u?(0,l._t)("room|forget_space"):(0,l._t)("room|forget_room"),v=this.props.onForgetClick;break}case hv.OtherThreePIDError:{var k;h=m?(0,l._t)("room|3pid_invite_error_title_room",{roomName:m}):(0,l._t)("room|3pid_invite_error_title");const e=this.joinRule(),t=(0,l._t)("room|3pid_invite_error_description",{errcode:(null===(k=this.state.threePidFetchError)||void 0===k?void 0:k.errcode)||(0,l._t)("error|unknown_error_code")});switch(e){case"invite":p=[(0,l._t)("room|3pid_invite_error_invite_subtitle"),t],E=(0,l._t)("room|3pid_invite_error_invite_action"),v=this.props.onJoinClick;break;case"public":p=(0,l._t)("room|3pid_invite_error_public_subtitle"),E=(0,l._t)("room|join_the_discussion"),v=this.props.onJoinClick;break;default:p=t,E=(0,l._t)("room|3pid_invite_error_invite_action"),v=this.props.onJoinClick}break}case hv.InvitedEmailNotFoundInAccount:h=m?(0,l._t)("room|3pid_invite_email_not_found_account_room",{roomName:m,email:this.props.invitedEmail}):(0,l._t)("room|3pid_invite_email_not_found_account",{email:this.props.invitedEmail}),p=(0,l._t)("room|link_email_to_receive_3pid_invite",{brand:d}),E=(0,l._t)("room|join_the_discussion"),v=this.props.onJoinClick;break;case hv.InvitedEmailNoIdentityServer:h=m?(0,l._t)("room|invite_sent_to_email_room",{roomName:m,email:this.props.invitedEmail}):(0,l._t)("room|invite_sent_to_email",{email:this.props.invitedEmail}),p=(0,l._t)("room|3pid_invite_no_is_subtitle",{brand:d}),E=(0,l._t)("room|join_the_discussion"),v=this.props.onJoinClick;break;case hv.InvitedEmailMismatch:h=m?(0,l._t)("room|invite_sent_to_email_room",{roomName:m,email:this.props.invitedEmail}):(0,l._t)("room|invite_sent_to_email",{email:this.props.invitedEmail}),p=(0,l._t)("room|invite_email_mismatch_suggestion",{brand:d}),E=(0,l._t)("room|join_the_discussion"),v=this.props.onJoinClick;break;case hv.Invite:{var R,I,T;const e=this.isDMInvite(),t=i.createElement(Kt.A,{room:this.props.room,oobData:this.props.oobData}),n=this.getInviteMember(),s=i.createElement("span",{className:"mx_RoomPreviewBar_inviter"},null!==(R=null==n?void 0:n.rawDisplayName)&&void 0!==R?R:this.props.inviterName),o=i.createElement(i.Fragment,null,e?(0,l._t)("room|dm_invite_subtitle",{},{userName:s}):(0,l._t)("room|invite_subtitle",{},{userName:s}),n&&i.createElement(i.Fragment,null,i.createElement("br",null),i.createElement("span",{className:"mx_RoomPreviewBar_inviter_mxid"},n.userId)));var P;if(e)h=(0,l._t)("room|dm_invite_title",{user:null!==(P=null==n?void 0:n.name)&&void 0!==P?P:this.props.inviterName}),E=(0,l._t)("room|dm_invite_action");else h=(0,l._t)("room|invite_title",{roomName:m}),E=(0,l._t)("action|accept");p=[t,o];const r=_.J.safeGet().getSafeUserId(),a=null===(I=this.props.room)||void 0===I?void 0:I.currentState.getMember(r),c=null==a||null===(T=a.events.member)||void 0===T?void 0:T.getContent();null!=c&&c.reason&&(g=i.createElement(mv,{reason:c.reason,htmlReason:c["io.element.html_reason"]})),v=this.props.onJoinClick,b=(0,l._t)("action|reject"),y=this.props.onRejectClick,this.props.onRejectAndIgnoreClick&&A.push(i.createElement(ie.A,{kind:"secondary",onClick:this.props.onRejectAndIgnoreClick,key:"ignore"},(0,l._t)("room|invite_reject_ignore")));break}case hv.ViewingRoom:h=this.props.canPreview?(0,l._t)("room|peek_join_prompt",{roomName:m}):m?(0,l._t)("room|no_peek_join_prompt",{roomName:m}):(0,l._t)("room|no_peek_no_name_join_prompt"),E=(0,l._t)("room|join_the_discussion"),v=this.props.onJoinClick;break;case hv.RoomNotFound:h=m?(0,l._t)("room|not_found_title_name",{roomName:m}):(0,l._t)("room|not_found_title"),p=(0,l._t)("room|not_found_subtitle");break;case hv.OtherError:var N;h=m?(0,l._t)("room|inaccessible_name",{roomName:m}):(0,l._t)("room|inaccessible"),p=[(0,l._t)("room|inaccessible_subtitle_1"),(0,l._t)("room|inaccessible_subtitle_2",{errcode:String(null===(N=this.props.error)||void 0===N?void 0:N.errcode)},{issueLink:e=>i.createElement("a",{href:c.Ay.get().feedback.new_issue_url,target:"_blank",rel:"noreferrer noopener"},e)})];break;case hv.PromptAskToJoin:var D;h=m?(0,l._t)("room|knock_prompt_name",{roomName:m}):(0,l._t)("room|knock_prompt");p=[i.createElement(Kt.A,{room:this.props.room,oobData:this.props.oobData}),(0,l._t)("room|knock_subtitle")],g=i.createElement(ks.A,{autoFocus:!0,className:"mx_RoomPreviewBar_fullWidth",element:"textarea",onChange:this.onChangeReason,placeholder:(0,l._t)("room|knock_message_field_placeholder"),type:"text",value:null!==(D=this.state.reason)&&void 0!==D?D:""}),v=()=>this.props.onSubmitAskToJoin&&this.props.onSubmitAskToJoin(this.state.reason),E=(0,l._t)("room|knock_send_action");break;case hv.Knocked:h=(0,l._t)("room|knock_sent"),p=[i.createElement(i.Fragment,null,i.createElement(uv.I,{className:"mx_Icon mx_Icon_16 mx_RoomPreviewBar_icon"}),(0,l._t)("room|knock_sent_subtitle"))],y=this.props.onCancelAskToJoin,b=(0,l._t)("room|knock_cancel_action")}let O,L,U,F;p&&(Array.isArray(p)||(p=[p]),O=p.map(((e,t)=>i.createElement("p",{key:`subTitle${t}`},e)))),L=S?i.createElement("h3",{className:"mx_RoomPreviewBar_spinnerTitle"},i.createElement(se.A,null),h):i.createElement("h3",null,h),v&&(U=i.createElement(ie.A,{kind:"primary",onClick:v},E)),y&&(F=i.createElement(ie.A,{kind:"secondary",onClick:y},b));const V=this.props.canPreview,B=dt()("mx_RoomPreviewBar",`mx_RoomPreviewBar_${C}`,{mx_RoomPreviewBar_panel:V,mx_RoomPreviewBar_dialog:!V}),j=V?i.createElement(i.Fragment,null,F,A,U):i.createElement(i.Fragment,null,U,A,F);return i.createElement("div",{role:"complementary",className:B},i.createElement("div",{className:"mx_RoomPreviewBar_message"},L,O),g,i.createElement("div",{className:dt()("mx_RoomPreviewBar_actions",{mx_RoomPreviewBar_fullWidth:C===hv.PromptAskToJoin})},j),i.createElement("div",{className:"mx_RoomPreviewBar_footer"},w))}}(0,v.A)(pv,"defaultProps",{onJoinClick(){}});var gv=n("./src/utils/membership.ts");const vv=(e,t=250)=>{const[n,s]=(0,i.useState)(e.getJoinedMembers()),r=(0,i.useMemo)((()=>(0,Vn.throttle)((()=>{s(e.getJoinedMembers())}),t,{leading:!0,trailing:!0})),[e,t]);return(0,ci.YK)(e.currentState,o.RoomStateEvent.Members,r),n},_v=(e,{throttleWait:t}={throttleWait:250})=>{const[n,s]=(0,i.useState)(e.getJoinedMemberCount()),r=(0,i.useMemo)((()=>(0,Vn.throttle)((()=>{s(e.getJoinedMemberCount())}),t,{leading:!0,trailing:!0})),[e,t]);return(0,ci.YK)(e.currentState,o.RoomStateEvent.Members,r),(0,ci.YK)(e,o.RoomEvent.Summary,r),n},fv=e=>{const[t,n]=(0,i.useState)(e.getMyMembership());return(0,ci.YK)(e,o.RoomEvent.MyMembership,(()=>{n(e.getMyMembership())})),t};var Ev=n("./src/components/views/elements/FacePile.tsx");const yv=["room","onlyKnownUsers","numShown"],bv=5,wv=e=>{var t;return!(null===(t=x.A.shared().getDMRoomsForUserId(e.userId))||void 0===t||!t.length)},Sv=e=>{let{room:t,onlyKnownUsers:n=!0,numShown:s=bv}=e,o=(0,g.A)(e,yv);const r=(0,i.useContext)(Hn.Ay),a=t.getMyMembership()===ut.O.Join;let c=vv(t);const d=c.length,m=[e=>e.getMxcAvatarUrl()?0:1];n?c=c.filter(wv):m.unshift((e=>wv(e)?0:1));const u=(0,Vn.sortBy)(c.filter((e=>e.userId!==r.getUserId())),m).slice(0,s);if(u.length<1)return null;const h=u.map((e=>e.name)).reverse().join(", ");return i.createElement(Ev.A,(0,_t.A)({members:u,size:"28px",overflow:c.length>s,tooltipLabel:o.onClick?(0,l._t)("room|face_pile_tooltip_label",{count:d}):(0,l._t)("common|n_members",{count:d}),tooltipShortcut:a?(0,l._t)("room|face_pile_tooltip_shortcut_joined",{commaSeparatedMembers:h}):(0,l._t)("room|face_pile_tooltip_shortcut",{commaSeparatedMembers:h})},o),n&&i.createElement("span",{className:"mx_FacePile_summary"},(0,l._t)("room|face_pile_summary",{count:c.length})))},Av=({room:e})=>{const t=(0,hi.e)((async()=>{if(e.getMyMembership()!==ut.O.Invite)return null;try{return await e.client.getRoomSummary(e.roomId)}catch{return null}}),[e]),n=(0,eo.U)(e,(e=>e.getJoinRule())),s=fv(e),r=_v(e);let a,c,d;if((0,Vu.j)(e)?(a="mx_RoomInfoLine_video",c=(0,l._t)("common|video_room")):n===o.JoinRule.Public?(a="mx_RoomInfoLine_public",c=e.isSpaceRoom()?(0,l._t)("common|public_space"):(0,l._t)("common|public_room")):(a="mx_RoomInfoLine_private",c=e.isSpaceRoom()?(0,l._t)("common|private_space"):(0,l._t)("common|private_room")),s===ut.O.Invite&&t)d=i.createElement("span",{className:"mx_RoomInfoLine_members"},(0,l._t)("common|n_members",{count:t.num_joined_members}));else if(r&&void 0!==t){const t=()=>_l.A.instance.setCard({phase:e.isSpaceRoom()?fl.n.SpaceMemberList:fl.n.RoomMemberList});d=i.createElement(ie.A,{kind:"link",className:"mx_RoomInfoLine_members",onClick:t},(0,l._t)("common|n_members",{count:r}))}return i.createElement("div",{className:`mx_RoomInfoLine ${a}`},c,d)},Cv=({room:e,onJoinButtonClicked:t,onRejectButtonClicked:n})=>{const s=(0,i.useContext)(Hn.Ay),r=(0,Vu.j)(e),a=fv(e);(0,Ws.F)(S.A,(t=>{t.action===W.r.JoinRoomError&&t.roomId===e.roomId&&d(!1)}));const[c,d]=(0,i.useState)(!1),m=(0,eo.U)(e,(e=>e.getJoinRule())),u=(0,gv.Cs)(a)===gv._T.Leave&&m!==o.JoinRule.Public,h=()=>S.A.dispatch({action:W.r.ViewUserSettings,initialTabId:Na.v.Labs});let p,g,v=null;if(a===ut.O.Join)p=i.createElement(ie.A,{kind:"danger_outline",onClick:()=>{S.A.dispatch({action:"leave_room",room_id:e.roomId})}},(0,l._t)("action|leave"));else if(a===ut.O.Invite){var _;const o=null===(_=e.getMember(s.getUserId()))||void 0===_||null===(_=_.events.member)||void 0===_?void 0:_.getSender();if(o){const t=e.getMember(o);v=i.createElement("div",{className:"mx_RoomPreviewCard_inviter"},i.createElement(Mt.A,{member:t,fallbackUserId:o,size:"32px"}),i.createElement("div",null,i.createElement("div",{className:"mx_RoomPreviewCard_inviter_name"},(0,l._t)("room|invites_you_text",{},{inviter:()=>i.createElement("strong",null,(null==t?void 0:t.name)||o)})),t?i.createElement("div",{className:"mx_RoomPreviewCard_inviter_mxid"},o):null))}p=i.createElement(i.Fragment,null,i.createElement(ie.A,{kind:"primary_outline",onClick:()=>{d(!0),n()}},(0,l._t)("action|reject")),i.createElement(ie.A,{kind:"primary",onClick:()=>{d(!0),t()}},(0,l._t)("action|accept")))}else p=i.createElement(ie.A,{kind:"primary",onClick:()=>{t(),s.isGuest()||d(!0)},disabled:u},(0,l._t)("action|join"));return c&&(p=i.createElement(oa.A,null)),g=r?i.createElement(i.Fragment,null,i.createElement(Kt.A,{room:e,size:"50px",viewAvatarOnClick:!0}),i.createElement("div",{className:"mx_RoomPreviewCard_video"}),i.createElement(ta.s,{onClick:h,tooltipTitle:(0,l._t)("labs|video_rooms_beta")})):e.isSpaceRoom()?i.createElement(Kt.A,{room:e,size:"80px",viewAvatarOnClick:!0}):i.createElement(Kt.A,{room:e,size:"50px",viewAvatarOnClick:!0}),i.createElement("div",{className:"mx_RoomPreviewCard"},v,i.createElement("div",{className:"mx_RoomPreviewCard_avatar"},g),i.createElement("h1",{className:"mx_RoomPreviewCard_name"},i.createElement(Os,{room:e})),i.createElement(Av,{room:e}),i.createElement(Fu,{room:e,className:"mx_RoomPreviewCard_topic"}),"public"===e.getJoinRule()&&i.createElement(Sv,{room:e}),u?i.createElement("div",{className:"mx_RoomPreviewCard_notice"},(0,l._t)("room|join_failed_needs_invite",{roomName:e.name})):null,i.createElement("div",{className:"mx_RoomPreviewCard_joinButtons"},p))};var xv=n("./src/components/views/dialogs/RoomUpgradeDialog.tsx");class kv extends i.PureComponent{constructor(e,t){super(e,t),(0,v.A)(this,"onStateEvents",(e=>{if(!this.props.room||e.getRoomId()!==this.props.room.roomId)return;if("m.room.tombstone"!==e.getType())return;const t=this.props.room.currentState.getStateEvents("m.room.tombstone","");this.setState({upgraded:t&&t.getContent().replacement_room})})),(0,v.A)(this,"onUpgradeClick",(()=>{k.Ay.createDialog(xv.A,{room:this.props.room})}));const n=this.props.room.currentState.getStateEvents("m.room.tombstone","");this.state={upgraded:null==n?void 0:n.getContent().replacement_room}}componentDidMount(){this.context.on(o.RoomStateEvent.Events,this.onStateEvents)}componentWillUnmount(){this.context.removeListener(o.RoomStateEvent.Events,this.onStateEvents)}render(){let e=i.createElement("div",null,i.createElement("div",{className:"mx_RoomUpgradeWarningBar_body"},i.createElement("p",null,(0,l._t)("room|upgrade_warning_bar")),i.createElement("p",null,(0,l._t)("room_settings|advanced|room_upgrade_warning",{},{b:e=>i.createElement("strong",null,e),i:e=>i.createElement("i",null,e)}))),i.createElement("p",{className:"mx_RoomUpgradeWarningBar_upgradelink"},i.createElement(ie.A,{onClick:this.onUpgradeClick},(0,l._t)("room_settings|advanced|room_upgrade_button"))));return this.state.upgraded&&(e=i.createElement("div",{className:"mx_RoomUpgradeWarningBar_body"},i.createElement("p",null,(0,l._t)("room|upgrade_warning_bar_upgraded")))),i.createElement("div",{className:"mx_RoomUpgradeWarningBar"},i.createElement("div",{className:"mx_RoomUpgradeWarningBar_wrapped"},i.createElement("div",{className:"mx_RoomUpgradeWarningBar_header"},(0,l._t)("room|upgrade_warning_bar_unstable",{},{roomVersion:()=>i.createElement("code",null,this.props.room.getVersion()),i:e=>i.createElement("i",null,e)})),e,i.createElement("div",{className:"mx_RoomUpgradeWarningBar_small"},(0,l._t)("room|upgrade_warning_bar_admins"))))}}(0,v.A)(kv,"contextType",Hn.Ay);var Rv=function(e){return e.CloseScalar="close_scalar",e.GetWidgets="get_widgets",e.SetWidget="set_widget",e.JoinRulesState="join_rules_state",e.SetPlumbingState="set_plumbing_state",e.GetMembershipCount="get_membership_count",e.GetRoomEncryptionState="get_room_enc_state",e.CanSendEvent="can_send_event",e.MembershipState="membership_state",e.invite="invite",e.Kick="kick",e.BotOptions="bot_options",e.SetBotOptions="set_bot_options",e.SetBotPower="set_bot_power",e.GetOpenIdToken="get_open_id_token",e.SendEvent="send_event",e.ReadEvents="read_events",e}(Rv||{});function Iv(e,t){const n=(0,$t.ZV)(e.data);n.response=t,e.source.postMessage(n,e.origin)}function Tv(e,t,n){s.v.error("Action:"+e.data.action+" failed with message: "+t);const i=(0,$t.ZV)(e.data);i.response={error:{message:t}},n&&(i.response.error._error=n),e.source.postMessage(i,e.origin)}function Pv(e,t){const n=_.J.safeGet(),i=e.data.widget_id;let s=e.data.type;const o=e.data.url,r=e.data.name,a=e.data.data,c=e.data.avatar_url,d=e.data.userWidget;if(i&&void 0!==o){if(null!==o){if(void 0!==r&&"string"!=typeof r)return void Tv(e,(0,l._t)("scalar|error_create"),new Error("Optional field 'name' must be a string."));if(void 0!==a&&!(a instanceof Object))return void Tv(e,(0,l._t)("scalar|error_create"),new Error("Optional field 'data' must be an Object."));if(void 0!==c&&"string"!=typeof c)return void Tv(e,(0,l._t)("scalar|error_create"),new Error("Optional field 'avatar_url' must be a string."));if("string"!=typeof s)return void Tv(e,(0,l._t)("scalar|error_create"),new Error("Field 'type' must be a string."));if("string"!=typeof o)return void Tv(e,(0,l._t)("scalar|error_create"),new Error("Field 'url' must be a string or null."))}if(s=gh.x.fromString(s),d)th.A.setUserWidget(n,i,s,o,r,a).then((()=>{Iv(e,{success:!0}),S.A.dispatch({action:"user_widget_updated"})})).catch((t=>{Tv(e,(0,l._t)("scalar|error_create"),t)}));else{if(!t)return void Tv(e,(0,l._t)("scalar|error_missing_room_id"));th.A.setRoomWidget(n,t,i,s,o,r,a,c).then((()=>{Iv(e,{success:!0})}),(t=>{Tv(e,(0,l._t)("scalar|error_send_request"),t)}))}}else Tv(e,(0,l._t)("scalar|error_create"),new Error("Missing required widget fields."))}function Nv(e,t){const n=_.J.get();if(!n)return void Tv(e,(0,l._t)("widget|error_need_to_be_logged_in"));let i=[];if(t){const s=n.getRoom(t);if(!s)return void Tv(e,(0,l._t)("scalar|error_room_unknown"));i=th.A.getRoomWidgets(s).map((e=>e.event))}const s=th.A.getUserWidgetsArray(n);i=i.concat(s),Iv(e,i)}function Dv(e,t,n,i){const s=_.J.get();if(!s)return void Tv(e,(0,l._t)("widget|error_need_to_be_logged_in"));const o=s.getRoom(t);if(!o)return void Tv(e,(0,l._t)("scalar|error_room_unknown"));const r=o.currentState.getStateEvents(n,i);Iv(e,r?r.getContent():null)}const Mv=function(e){let t,n;e.origin||(e.origin=e.originalEvent.origin);try{var i;Ov||(Ov=null===(i=U.J.sharedInstance().getPrimaryManager())||void 0===i?void 0:i.uiUrl),t=new URL(Ov)}catch{return}try{n=new URL(e.origin)}catch{return}if(t.origin!==n.origin||!e.data.action||e.data.api)return;if(e.data.action===Rv.CloseScalar)return S.A.dispatch({action:Rv.CloseScalar}),void Iv(e,null);const o=e.data.room_id,r=e.data.user_id;if(!o)return e.data.action===Rv.GetWidgets?void Nv(e,null):e.data.action===Rv.SetWidget?void Pv(e,null):e.data.action===Rv.GetOpenIdToken?void async function(e){try{Iv(e,await _.J.safeGet().getOpenIdToken())}catch(t){s.v.warn("Unable to fetch openId token.",t),Tv(e,"Unable to fetch openId token.")}}(e):void Tv(e,(0,l._t)("scalar|error_missing_room_id_request"));if(o===X.M.instance.roomViewStore.getRoomId())if(e.data.action!==Rv.GetWidgets)if(e.data.action!==Rv.SetWidget)if(e.data.action!==Rv.JoinRulesState)if(e.data.action!==Rv.SetPlumbingState)if(e.data.action!==Rv.GetMembershipCount)if(e.data.action!==Rv.GetRoomEncryptionState)if(e.data.action!==Rv.CanSendEvent)if(e.data.action!==Rv.SendEvent)if(e.data.action!==Rv.ReadEvents)if(r)switch(e.data.action){case Rv.MembershipState:!function(e,t,n){s.v.log(`membership_state of ${n} in room ${t} requested.`),Dv(e,t,"m.room.member",n)}(e,o,r);break;case Rv.invite:!function(e,t,n){s.v.log(`Received request to invite ${n} into room ${t}`);const i=_.J.get();if(!i)return void Tv(e,(0,l._t)("widget|error_need_to_be_logged_in"));const o=i.getRoom(t);if(o){const t=o.getMember(n);if(t&&[ut.O.Join,ut.O.Invite].includes(t.membership))return void Iv(e,{success:!0})}i.invite(t,n).then((function(){Iv(e,{success:!0})}),(function(t){Tv(e,(0,l._t)("widget|error_need_invite_permission"),t)}))}(e,o,r);break;case Rv.Kick:!function(e,t,n){s.v.log(`Received request to kick ${n} from room ${t}`);const i=_.J.get();if(!i)return void Tv(e,(0,l._t)("widget|error_need_to_be_logged_in"));const o=i.getRoom(t);if(o){const t=o.getMember(n);if(!t||(0,gv.Cs)(t.membership)===gv._T.Leave)return void Iv(e,{success:!0})}const r=e.data.reason;i.kick(t,n,r).then((()=>{Iv(e,{success:!0})})).catch((t=>{Tv(e,(0,l._t)("widget|error_need_kick_permission"),t)}))}(e,o,r);break;case Rv.BotOptions:!function(e,t,n){s.v.log(`bot_options of ${n} in room ${t} requested.`),Dv(e,t,"m.room.bot.options","_"+n)}(e,o,r);break;case Rv.SetBotOptions:!function(e,t,n){s.v.log(`Received request to set options for bot ${n} in room ${t}`);const i=_.J.get();i?i.sendStateEvent(t,"m.room.bot.options",e.data.content,"_"+n).then((()=>{Iv(e,{success:!0})}),(t=>{Tv(e,t.message?t.message:(0,l._t)("scalar|error_send_request"),t)})):Tv(e,(0,l._t)("widget|error_need_to_be_logged_in"))}(e,o,r);break;case Rv.SetBotPower:!async function(e,t,n,i,o){if(!(Number.isInteger(i)&&i>=0))return void Tv(e,(0,l._t)("scalar|error_power_level_invalid"));s.v.log(`Received request to set power level to ${i} for bot ${n} in room ${t}.`);const r=_.J.get();if(r)try{const s=await r.getStateEvent(t,"m.room.power_levels","");var a,c,d;if(!0===o)if((null!==(a=null!==(c=null===(d=s.users)||void 0===d?void 0:d[n])&&void 0!==c?c:s.users_default)&&void 0!==a?a:0)>=i)return Iv(e,{success:!0});return await r.setPowerLevel(t,n,i),Iv(e,{success:!0})}catch(t){var m;const n=t instanceof Error?t:void 0;Tv(e,null!==(m=null==n?void 0:n.message)&&void 0!==m?m:(0,l._t)("scalar|error_send_request"),n)}else Tv(e,(0,l._t)("widget|error_need_to_be_logged_in"))}(e,o,r,e.data.level,e.data.ignoreIfGreater);break;default:s.v.warn("Unhandled postMessage event with action '"+e.data.action+"'")}else Tv(e,(0,l._t)("scalar|error_missing_user_id_request"));else!async function(e,t){const n=e.data.type,i=e.data.state_key,s=e.data.limit;if("string"!=typeof n)return void Tv(e,(0,l._t)("scalar|failed_read_event"),new Error("Invalid 'type' in request"));if(!["m.room.power_levels","m.room.encryption","m.room.member","m.room.name","m.widgets","im.vector.modular.widgets","io.element.integrations.installations"].includes(n))return void Tv(e,(0,l._t)("scalar|failed_read_event"),new Error("Disallowed 'type' in request"));let o;if(void 0!==s){if("number"!=typeof s||s<0)return void Tv(e,(0,l._t)("scalar|failed_read_event"),new Error("Invalid 'limit' in request"));o=Math.min(s,Number.MAX_SAFE_INTEGER)}else o=Number.MAX_SAFE_INTEGER;const r=_.J.get();if(!r)return void Tv(e,(0,l._t)("widget|error_need_to_be_logged_in"));const a=r.getRoom(t);if(a){if(void 0!==i){if("string"!=typeof i&&!0!==i)return void Tv(e,(0,l._t)("scalar|failed_read_event"),new Error("Invalid 'state_key' in request"));const t=!0===i?void 0:i;let s=[];return s=s.concat(a.currentState.getStateEvents(n,t)||[]),s=s.slice(0,o),void Iv(e,{events:s.map((e=>e.getEffectiveEvent()))})}Tv(e,(0,l._t)("scalar|failed_read_event"),new Error("Reading message events is not implemented"))}else Tv(e,(0,l._t)("scalar|error_room_unknown"))}(e,o);else!async function(e,t){const n=e.data.type,i=e.data.state_key,s=e.data.content;if("string"!=typeof n)return void Tv(e,(0,l._t)("scalar|failed_send_event"),new Error("Invalid 'type' in request"));if(!["m.widgets","im.vector.modular.widgets","io.element.integrations.installations"].includes(n))return void Tv(e,(0,l._t)("scalar|failed_send_event"),new Error("Disallowed 'type' in request"));if(!s||"object"!=typeof s)return void Tv(e,(0,l._t)("scalar|failed_send_event"),new Error("Invalid 'content' in request"));const o=_.J.get();if(!o)return void Tv(e,(0,l._t)("widget|error_need_to_be_logged_in"));if(o.getRoom(t))if(void 0!==i)try{Iv(e,{room_id:t,event_id:(await o.sendStateEvent(t,n,s,i)).event_id})}catch(t){return void Tv(e,(0,l._t)("scalar|failed_send_event"),t)}else Tv(e,(0,l._t)("scalar|failed_send_event"),new Error("Sending message events is not implemented"));else Tv(e,(0,l._t)("scalar|error_room_unknown"))}(e,o);else!function(e,t){const n=""+e.data.event_type,i=Boolean(e.data.is_state),s=_.J.get();if(!s)return void Tv(e,(0,l._t)("widget|error_need_to_be_logged_in"));const o=s.getRoom(t);if(!o)return void Tv(e,(0,l._t)("scalar|error_room_unknown"));if(o.getMyMembership()!==ut.O.Join)return void Tv(e,(0,l._t)("scalar|error_membership"));const r=s.credentials.userId;let a;a=i?o.currentState.maySendStateEvent(n,r):o.currentState.maySendEvent(n,r),a?Iv(e,!0):Tv(e,(0,l._t)("scalar|error_permission"))}(e,o);else!async function(e,t){var n;const i=_.J.get();if(!i)return void Tv(e,(0,l._t)("widget|error_need_to_be_logged_in"));if(!i.getRoom(t))return void Tv(e,(0,l._t)("scalar|error_room_unknown"));Iv(e,Boolean(await(null===(n=i.getCrypto())||void 0===n?void 0:n.isEncryptionEnabledInRoom(t))))}(e,o);else!function(e,t){const n=_.J.get();if(!n)return void Tv(e,(0,l._t)("widget|error_need_to_be_logged_in"));const i=n.getRoom(t);if(!i)return void Tv(e,(0,l._t)("scalar|error_room_unknown"));Iv(e,i.getJoinedMemberCount())}(e,o);else!function(e,t,n){if("string"!=typeof n)throw new Error("Plumbing state status should be a string");s.v.log(`Received request to set plumbing state to status "${n}" in room ${t}`);const i=_.J.get();i?i.sendStateEvent(t,"m.room.plumbing",{status:n}).then((()=>{Iv(e,{success:!0})}),(t=>{Tv(e,t.message?t.message:(0,l._t)("scalar|error_send_request"),t)})):Tv(e,(0,l._t)("widget|error_need_to_be_logged_in"))}(e,o,e.data.status);else!function(e,t){s.v.log(`join_rules of ${t} requested.`),Dv(e,t,"m.room.join_rules","")}(e,o);else Pv(e,o);else Nv(e,o);else Tv(e,(0,l._t)("scalar|error_room_not_visible",{roomId:o}))};let Ov,Lv=0;class Uv extends Br{start(e){this.vertical?e.style.minHeight="":e.style.minWidth=""}finish(e){const t=e.offsetParent;if(t)if(this.vertical){const n=(e.offsetHeight/t.offsetHeight*100).toFixed(2)+"%";e.style.minHeight=n,e.style.height=n}else{const n=(e.offsetWidth/t.offsetWidth*100).toFixed(2)+"%";e.style.minWidth=n,e.style.width=n}}}class Fv extends Wr{static createSizer(e,t,n){return new Uv(e,t,n)}}var Vv=n("./src/utils/numbers.ts");class Bv extends i.Component{constructor(e){super(e),(0,v.A)(this,"unmounted",!1),(0,v.A)(this,"resizeContainer",void 0),(0,v.A)(this,"resizer",void 0),(0,v.A)(this,"dispatcherRef",void 0),(0,v.A)(this,"onIsResizing",(e=>{this.setState({resizingVertical:e}),e||this.relaxResizer()})),(0,v.A)(this,"collectResizer",(e=>{this.resizeContainer&&this.resizer.detach(),e&&(this.resizer.container=e,this.resizer.attach()),this.resizeContainer=e,this.loadResizerPreferences()})),(0,v.A)(this,"getAppsHash",(e=>e.map((e=>e.id)).join("~"))),(0,v.A)(this,"relaxResizer",(()=>{const e=this.resizer.getDistributors();e.forEach((e=>e.start())),e.forEach((e=>e.finish()))})),(0,v.A)(this,"loadResizerPreferences",(()=>{const e=Jh.aK.instance.getResizerDistributions(this.props.room,Jh.mc.Top);if(this.state.apps&&this.topApps().length-1===e.length)e.forEach(((e,t)=>{const n=this.resizer.forHandleAt(t);n&&(n.size=e,n.finish())}));else if(this.state.apps){const e=this.resizer.getDistributors();e.forEach((e=>e.item.clearSize())),e.forEach((e=>e.start())),e.forEach((e=>e.finish()))}})),(0,v.A)(this,"onAction",(e=>{const t=this.props.room.roomId+"_hide_widget_drawer";if("appsDrawer"===e.action)e.show?localStorage.setItem(t,"false"):localStorage.setItem(t,"true")})),(0,v.A)(this,"getApps",(()=>({[Jh.mc.Top]:Jh.aK.instance.getContainerWidgets(this.props.room,Jh.mc.Top),[Jh.mc.Center]:Jh.aK.instance.getContainerWidgets(this.props.room,Jh.mc.Center)}))),(0,v.A)(this,"topApps",(()=>this.state.apps[Jh.mc.Top])),(0,v.A)(this,"centerApps",(()=>this.state.apps[Jh.mc.Center])),(0,v.A)(this,"updateApps",(()=>{this.unmounted||this.setState({apps:this.getApps()})})),this.state={apps:this.getApps(),resizingVertical:!1,resizingHorizontal:!1,resizing:!1},this.resizer=this.createResizer()}componentDidMount(){this.unmounted=!1,this.props.resizeNotifier.on("isResizing",this.onIsResizing),0===Lv&&window.addEventListener("message",Mv,!1),Lv+=1,Jh.aK.instance.on(Jh.aK.emissionForRoom(this.props.room),this.updateApps),this.dispatcherRef=S.A.register(this.onAction)}componentWillUnmount(){this.unmounted=!0,function(){if(Lv-=1,0===Lv&&window.removeEventListener("message",Mv),Lv<0){const e=new Error("ScalarMessaging: mismatched startListening / stopListening detected. Negative count");s.v.error(e)}}(),Jh.aK.instance.off(Jh.aK.emissionForRoom(this.props.room),this.updateApps),S.A.unregister(this.dispatcherRef),this.resizeContainer&&this.resizer.detach(),this.props.resizeNotifier.off("isResizing",this.onIsResizing)}createResizer(){const e=new Kr(null,Fv,{onResizeStart:()=>{var e;null===(e=this.resizeContainer)||void 0===e||e.classList.add("mx_AppsDrawer--resizing"),this.setState({resizingHorizontal:!0})},onResizeStop:()=>{var e;null===(e=this.resizeContainer)||void 0===e||e.classList.remove("mx_AppsDrawer--resizing"),Jh.aK.instance.setResizerDistributions(this.props.room,Jh.mc.Top,this.topApps().slice(1).map(((e,t)=>this.resizer.forHandleAt(t).size))),this.setState({resizingHorizontal:!1})}});return e.setClassNames({handle:"mx_ResizeHandle",vertical:"mx_ResizeHandle--vertical",reverse:"mx_ResizeHandle_reverse"}),e}componentDidUpdate(e,t){e.userId!==this.props.userId||e.room!==this.props.room?this.updateApps():this.getAppsHash(this.topApps())!==this.getAppsHash(t.apps[Jh.mc.Top])&&this.loadResizerPreferences()}isResizing(){return this.state.resizingVertical||this.state.resizingHorizontal}render(){if(!this.props.showApps)return i.createElement("div",null);const e=this.centerApps().length>0,t=(e?this.centerApps():this.topApps()).map(((e,t,n)=>i.createElement(cp,{key:e.id,app:e,fullWidth:n.length<2,room:this.props.room,userId:this.props.userId,creatorUserId:e.creatorUserId,widgetPageTitle:th.A.getWidgetDataTitle(e),waitForIframeLoad:e.waitForIframeLoad,pointerEvents:this.isResizing()?"none":void 0})));if(0===t.length)return i.createElement("div",null);let n;0===t.length&&lv.A.roomHasPendingWidgets(this.props.room.roomId,th.A.getRoomWidgets(this.props.room))&&(n=i.createElement(se.A,null));const s=dt()({mx_AppsDrawer:!0,"mx_AppsDrawer--maximised":e,"mx_AppsDrawer--resizing":this.state.resizing,"mx_AppsDrawer--2apps":2===t.length,"mx_AppsDrawer--3apps":3===t.length}),o=i.createElement("div",{className:"mx_AppsContainer",ref:this.collectResizer},t.map(((e,n)=>n<1?e:i.createElement(i.Fragment,{key:e.key},i.createElement(Fr,{reverse:n>t.length/2}),e))));let r;return r=e?o:i.createElement(jv,{room:this.props.room,minHeight:100,maxHeight:this.props.maxHeight-50,className:"mx_AppsDrawer_resizer",handleWrapperClass:"mx_AppsDrawer_resizer_container",handleClass:"mx_AppsDrawer_resizer_container_handle",resizeNotifier:this.props.resizeNotifier},o),i.createElement("div",{role:this.props.role,className:s},r,n)}}(0,v.A)(Bv,"defaultProps",{showApps:!0});const jv=({room:e,minHeight:t,maxHeight:n,className:s,handleWrapperClass:o,handleClass:r,resizeNotifier:a,children:l})=>{let d=Jh.aK.instance.getContainerHeight(e,Jh.mc.Top);var m;(t||(t=100),n||(n=Zr.A.instance.windowHeight/4*3),d)?(d=(0,Vv.qE)(d,0,100),d=(0,Vv.yj)(d/100,t,n)):d=null!==(m=c.Ay.get().default_widget_container_height)&&void 0!==m?m:280;return i.createElement(qd.c,{size:{height:Math.min(d,n),width:void 0},minHeight:t,maxHeight:n,onResizeStart:()=>{a.startResizing()},onResize:()=>{a.notifyTimelineHeightChanged()},onResizeStop:(i,s,o,r)=>{let l=d+r.height;l=100*(0,Vv.s5)(l,t,n),Jh.aK.instance.setContainerHeight(e,Jh.mc.Top,l),a.stopResizing()},className:s,handleWrapperClass:o,handleClasses:{bottom:r},enable:{bottom:!0}},l)};var Wv=n("./node_modules/matrix-js-sdk/src/webrtc/callEventTypes.ts");class zv extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,"element",void 0),(0,v.A)(this,"setElementRef",(e=>{var t;e?(this.element=e,e.addEventListener("resize",this.onResize)):null===(t=this.element)||void 0===t||t.removeEventListener("resize",this.onResize)})),(0,v.A)(this,"onNewStream",(()=>{this.setState({audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()}),this.playMedia()})),(0,v.A)(this,"onMuteStateChanged",(()=>{this.setState({audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()})})),(0,v.A)(this,"onResize",(e=>{this.props.onResize&&!this.props.feed.isLocal()&&this.props.onResize(e)})),this.state={audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()}}componentDidMount(){this.updateFeed(null,this.props.feed),this.playMedia()}componentWillUnmount(){this.updateFeed(this.props.feed,null)}componentDidUpdate(e,t){this.updateFeed(e.feed,this.props.feed),t.videoMuted===this.state.videoMuted&&e.feed.stream===this.props.feed.stream||this.playMedia()}static getDerivedStateFromProps(e){return{audioMuted:e.feed.isAudioMuted(),videoMuted:e.feed.isVideoMuted()}}updateFeed(e,t){e!==t&&(e&&(this.props.feed.removeListener(zd.BL.NewStream,this.onNewStream),this.props.feed.removeListener(zd.BL.MuteStateChanged,this.onMuteStateChanged),this.props.feed.purpose===Wv.h.Usermedia&&this.props.feed.measureVolumeActivity(!1),this.stopMedia()),t&&(this.props.feed.addListener(zd.BL.NewStream,this.onNewStream),this.props.feed.addListener(zd.BL.MuteStateChanged,this.onMuteStateChanged),this.props.feed.purpose===Wv.h.Usermedia&&this.props.feed.measureVolumeActivity(!0),this.playMedia()))}async playMedia(){const e=this.element;if(e){e.muted=!0,e.srcObject=this.props.feed.stream,e.autoplay=!0;try{await e.play()}catch(e){s.v.info(`Failed to play media element with feed for userId ${this.props.feed.userId} with purpose ${this.props.feed.purpose}`,e)}}}stopMedia(){const e=this.element;e&&(e.pause(),e.removeAttribute("src"))}render(){const{pipMode:e,primary:t,secondary:n,feed:s}=this.props,o=dt()("mx_VideoFeed",{mx_VideoFeed_primary:t,mx_VideoFeed_secondary:n,mx_VideoFeed_voice:this.state.videoMuted}),r=dt()("mx_VideoFeed_mic",{mx_VideoFeed_mic_muted:this.state.audioMuted,mx_VideoFeed_mic_unmuted:!this.state.audioMuted});let a,l;if(s.purpose===Wv.h.Screenshare||e||(a=i.createElement("div",{className:r})),this.state.videoMuted){var c;const n=et.Ay.instance.roomIdForCall(this.props.call),s=null!==(c=n?_.J.safeGet().getRoom(n):void 0)&&void 0!==c?c:void 0;let o;e&&t?o="76px":e&&!t?o="16px":!e&&t&&(o="160px"),l=i.createElement(Kt.A,{room:s,size:o})}else{const e=dt()("mx_VideoFeed_video",{mx_VideoFeed_video_mirror:this.props.feed.isLocal()&&this.props.feed.purpose===Wv.h.Usermedia&&M.A.getValue("VideoView.flipVideoHorizontally")});l=i.createElement("video",{className:e,ref:this.setElementRef})}return i.createElement("div",{className:o},a,l)}}class Hv extends i.Component{render(){const e=this.props.feeds.map((e=>i.createElement(zv,{key:e.stream.id,feed:e,call:this.props.call,primary:!1,pipMode:this.props.pipMode}))),t=dt()("mx_LegacyCallViewSidebar",{mx_LegacyCallViewSidebar_pipMode:this.props.pipMode});return i.createElement("div",{className:t},e)}}const Kv=({onExpand:e,onPin:t,onMaximize:n})=>i.createElement("div",{className:"mx_LegacyCallViewHeader_controls"},n&&i.createElement(ie.A,{className:"mx_LegacyCallViewHeader_button mx_LegacyCallViewHeader_button_fullscreen",onClick:n,title:(0,l._t)("voip|maximise")}),t&&i.createElement(ie.A,{className:"mx_LegacyCallViewHeader_button mx_LegacyCallViewHeader_button_pin",onClick:t,title:(0,l._t)("action|pin")}),e&&i.createElement(ie.A,{className:"mx_LegacyCallViewHeader_button mx_LegacyCallViewHeader_button_expand",onClick:e,title:(0,l._t)("voip|expand")})),Jv=({callRoom:e})=>i.createElement("span",{className:"mx_LegacyCallViewHeader_secondaryCallInfo"},i.createElement(Kt.A,{room:e,size:"16px"}),i.createElement("span",{className:"mx_LegacyCallView_secondaryCall_roomName"},(0,l._t)("voip|on_hold",{name:e.name}))),Gv=({pipMode:e=!1,callRooms:t,onPipMouseDown:n,onExpand:s,onPin:o,onMaximize:r})=>{const[a,c]=t,d=a.name;return e?i.createElement("div",{className:"mx_LegacyCallViewHeader mx_LegacyCallViewHeader_pip",onMouseDown:n},i.createElement(Kt.A,{room:a,size:"32px"}),i.createElement("div",{className:"mx_LegacyCallViewHeader_callInfo"},i.createElement("div",{className:"mx_LegacyCallViewHeader_roomName"},d),c&&i.createElement(Jv,{callRoom:c})),i.createElement(Kv,{onExpand:s,onPin:o,onMaximize:r})):i.createElement("div",{className:"mx_LegacyCallViewHeader"},i.createElement("div",{className:"mx_LegacyCallViewHeader_icon"}),i.createElement("span",{className:"mx_LegacyCallViewHeader_text"},(0,l._t)("action|call")),i.createElement(Kv,{onMaximize:r}))};class $v extends i.Component{constructor(...e){super(...e),(0,v.A)(this,"onHoldClick",(()=>{this.props.call.setRemoteOnHold(!0),this.props.onFinished()})),(0,v.A)(this,"onUnholdClick",(()=>{et.Ay.instance.setActiveCallRoomId(this.props.call.roomId),this.props.onFinished()})),(0,v.A)(this,"onTransferClick",(()=>{et.Ay.instance.showTransferDialog(this.props.call),this.props.onFinished()}))}render(){const e=this.props.call.isRemoteOnHold()?(0,l._t)("action|resume"):(0,l._t)("action|hold"),t=this.props.call.isRemoteOnHold()?this.onUnholdClick:this.onHoldClick;let n;return this.props.call.opponentCanBeTransferred()&&(n=i.createElement(Gt.Dr,{className:"mx_LegacyCallContextMenu_item",onClick:this.onTransferClick},(0,l._t)("action|transfer"))),i.createElement(Gt.Ay,this.props,i.createElement(Gt.Dr,{className:"mx_LegacyCallContextMenu_item",onClick:t},e),n)}}var qv=n("./src/components/views/voip/DialPad.tsx");class Yv extends i.Component{constructor(e){super(e),(0,v.A)(this,"numberEntryFieldRef",(0,i.createRef)()),(0,v.A)(this,"onDigitPress",((e,t)=>{var n;(this.props.call.sendDtmfDigit(e),this.setState({value:this.state.value+e}),"click"===t.type)&&(null===(n=this.numberEntryFieldRef.current)||void 0===n||n.focus())})),(0,v.A)(this,"onCancelClick",(()=>{this.props.onFinished()})),(0,v.A)(this,"onKeyDown",(e=>{"Backspace"!==e.code&&"Delete"!==e.code||e.preventDefault()})),(0,v.A)(this,"onChange",(e=>{this.setState({value:e.target.value})})),this.state={value:""}}render(){return i.createElement(Gt.Ay,this.props,i.createElement("div",{className:"mx_DialPadContextMenuWrapper"},i.createElement("div",null,i.createElement(ie.A,{className:"mx_DialPadContextMenu_cancel",onClick:this.onCancelClick})),i.createElement("div",{className:"mx_DialPadContextMenu_header"},i.createElement(ks.A,{ref:this.numberEntryFieldRef,className:"mx_DialPadContextMenu_dialled",value:this.state.value,autoFocus:!0,onKeyDown:this.onKeyDown,onChange:this.onChange})),i.createElement("div",{className:"mx_DialPadContextMenu_dialPad"},i.createElement(qv.Ay,{onDigitPress:this.onDigitPress,hasDial:!1}))))}}const Qv=["deviceKinds"],Xv={[Lr.cm.AudioInput]:(0,l.AO)("voip|input_devices"),[Lr.cm.AudioOutput]:(0,l.AO)("voip|output_devices"),[Lr.cm.VideoInput]:(0,l.AO)("common|cameras")},Zv=({label:e,selected:t,onClick:n})=>i.createElement(na.h6,{iconClassName:"mx_DeviceContextMenu_device_icon",label:e,active:t,onClick:n}),e_=({deviceKind:e})=>{const[t,n]=(0,i.useState)([]),[s,o]=(0,i.useState)(Lr.Ay.getDevice(e));(0,i.useEffect)((()=>{(async()=>{var t,i;n(null!==(t=null===(i=await Lr.Ay.getDevices())||void 0===i?void 0:i[e])&&void 0!==t?t:[])})()}),[e]);return i.createElement(na.tx,{label:(0,l._t)(Xv[e])},t.map((({label:t,deviceId:n})=>i.createElement(Zv,{key:n,label:t,selected:s===n,onClick:()=>(t=>{Lr.Ay.instance.setDevice(t,e),o(t)})(n)}))))},t_=e=>{let{deviceKinds:t}=e,n=(0,g.A)(e,Qv);return i.createElement(na.Ay,(0,_t.A)({compact:!0,className:"mx_DeviceContextMenu"},n),t.map((e=>i.createElement(e_,{key:e,deviceKind:e}))))},n_=["children","state","className","onLabel","offLabel","forceHide","onHover"],i_=["state","deviceKinds"],s_=(0,i.forwardRef)(((e,t)=>{let{children:n,state:s,className:o,onLabel:r,offLabel:a,forceHide:l,onHover:c}=e,d=(0,g.A)(e,n_);const m=dt()("mx_LegacyCallViewButtons_button",o,{mx_LegacyCallViewButtons_button_on:s,mx_LegacyCallViewButtons_button_off:!s}),u=l?void 0:s?r:a;return i.createElement(ie.A,(0,_t.A)({ref:t,className:m,title:u,placement:"top",onTooltipOpenChange:c},d),n)})),o_=e=>{let{state:t,deviceKinds:n}=e,s=(0,g.A)(e,i_);const[o,r,a,l]=(0,Gt.EF)(),[c,d]=(0,i.useState)(!1),m=dt()("mx_LegacyCallViewButtons_button","mx_LegacyCallViewButtons_dropdownButton",{mx_LegacyCallViewButtons_dropdownButton_collapsed:!o});return i.createElement(s_,(0,_t.A)({ref:r,forceHide:o||c,state:t},s),i.createElement(s_,{className:m,onClick:e=>{e.stopPropagation(),a()},onHover:e=>d(e),state:t}),o&&r.current&&i.createElement(t_,(0,_t.A)({},(0,Gt.Gi)(r.current.getBoundingClientRect()),{onFinished:l,deviceKinds:n})))};class r_ extends i.Component{constructor(e){super(e),(0,v.A)(this,"dialpadButton",(0,i.createRef)()),(0,v.A)(this,"contextMenuButton",(0,i.createRef)()),(0,v.A)(this,"controlsHideTimer",null),(0,v.A)(this,"onControlsHideTimer",(()=>{this.state.hoveringControls||this.state.showDialpad||this.state.showMoreMenu||(this.controlsHideTimer=null,this.setState({visible:!1}))})),(0,v.A)(this,"onMouseEnter",(()=>{this.setState({hoveringControls:!0})})),(0,v.A)(this,"onMouseLeave",(()=>{this.setState({hoveringControls:!1})})),(0,v.A)(this,"onDialpadClick",(()=>{this.state.showDialpad?this.setState({showDialpad:!1}):(this.setState({showDialpad:!0}),this.showControls())})),(0,v.A)(this,"onMoreClick",(()=>{this.setState({showMoreMenu:!0}),this.showControls()})),(0,v.A)(this,"closeDialpad",(()=>{this.setState({showDialpad:!1})})),(0,v.A)(this,"closeContextMenu",(()=>{this.setState({showMoreMenu:!1})})),this.state={showDialpad:!1,hoveringControls:!1,showMoreMenu:!1,visible:!0}}componentDidMount(){this.showControls()}showControls(){this.state.showMoreMenu||this.state.showDialpad||(this.state.visible||this.setState({visible:!0}),null!==this.controlsHideTimer&&clearTimeout(this.controlsHideTimer),this.controlsHideTimer=window.setTimeout(this.onControlsHideTimer,2e3))}render(){const e=dt()("mx_LegacyCallViewButtons",{mx_LegacyCallViewButtons_hidden:!this.state.visible});let t,n;return this.state.showDialpad&&this.dialpadButton.current&&(t=i.createElement(Yv,(0,_t.A)({},(0,Gt.t$)(this.dialpadButton.current.getBoundingClientRect(),Gt.t4.None,8),{mountAsChild:!this.props.pipMode,onFinished:this.closeDialpad,call:this.props.call}))),this.state.showMoreMenu&&this.contextMenuButton.current&&(n=i.createElement($v,(0,_t.A)({},(0,Gt.t$)(this.contextMenuButton.current.getBoundingClientRect(),Gt.t4.None,8),{mountAsChild:!this.props.pipMode,onFinished:this.closeContextMenu,call:this.props.call}))),i.createElement("div",{className:e,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave},t,n,this.props.buttonsVisibility.dialpad&&i.createElement(Gt.oW,{className:"mx_LegacyCallViewButtons_button mx_LegacyCallViewButtons_dialpad",ref:this.dialpadButton,onClick:this.onDialpadClick,isExpanded:this.state.showDialpad,title:(0,l._t)("voip|dialpad"),placement:"top"}),i.createElement(o_,{state:!this.props.buttonsState.micMuted,className:"mx_LegacyCallViewButtons_button_mic",onLabel:(0,l._t)("voip|disable_microphone"),offLabel:(0,l._t)("voip|enable_microphone"),onClick:this.props.handlers.onMicMuteClick,deviceKinds:[Lr.cm.AudioInput,Lr.cm.AudioOutput]}),this.props.buttonsVisibility.vidMute&&i.createElement(o_,{state:!this.props.buttonsState.vidMuted,className:"mx_LegacyCallViewButtons_button_vid",onLabel:(0,l._t)("voip|disable_camera"),offLabel:(0,l._t)("voip|enable_camera"),onClick:this.props.handlers.onVidMuteClick,deviceKinds:[Lr.cm.VideoInput]}),this.props.buttonsVisibility.screensharing&&i.createElement(s_,{state:this.props.buttonsState.screensharing,className:"mx_LegacyCallViewButtons_button_screensharing",onLabel:(0,l._t)("voip|stop_screenshare"),offLabel:(0,l._t)("voip|start_screenshare"),onClick:this.props.handlers.onScreenshareClick}),this.props.buttonsVisibility.sidebar&&i.createElement(s_,{state:this.props.buttonsState.sidebarShown,className:"mx_LegacyCallViewButtons_button_sidebar",onLabel:(0,l._t)("voip|hide_sidebar_button"),offLabel:(0,l._t)("voip|show_sidebar_button"),onClick:this.props.handlers.onToggleSidebarClick}),this.props.buttonsVisibility.contextMenu&&i.createElement(Gt.oW,{className:"mx_LegacyCallViewButtons_button mx_LegacyCallViewButtons_button_more",onClick:this.onMoreClick,ref:this.contextMenuButton,isExpanded:this.state.showMoreMenu,title:(0,l._t)("voip|more_button"),placement:"top"}),i.createElement(ie.A,{className:"mx_LegacyCallViewButtons_button mx_LegacyCallViewButtons_button_hangup",onClick:this.props.handlers.onHangupClick,title:(0,l._t)("voip|hangup"),placement:"top"}))}}function a_(){return document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement}function l_(){const e=document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen;e&&e.call(document)}class c_ extends i.Component{constructor(e){super(e),(0,v.A)(this,"dispatcherRef",void 0),(0,v.A)(this,"contentWrapperRef",(0,i.createRef)()),(0,v.A)(this,"buttonsRef",(0,i.createRef)()),(0,v.A)(this,"onAction",(e=>{if("video_fullscreen"===e.action){if(!this.contentWrapperRef.current)return;e.fullscreen?function(e){const t=e.requestFullscreen||e.webkitRequestFullScreen||e.msRequestFullscreen;t&&t.call(e)}(this.contentWrapperRef.current):a_()&&l_()}})),(0,v.A)(this,"onCallState",(e=>{this.setState({callState:e})})),(0,v.A)(this,"onFeedsChanged",(e=>{const{primary:t,secondary:n,sidebar:i}=c_.getOrderedFeeds(e);this.setState({primaryFeed:t,secondaryFeed:n,sidebarFeeds:i,micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted()})})),(0,v.A)(this,"onCallLocalHoldUnhold",(()=>{this.setState({isLocalOnHold:this.props.call.isLocalOnHold()})})),(0,v.A)(this,"onCallRemoteHoldUnhold",(()=>{this.setState({isRemoteOnHold:this.props.call.isRemoteOnHold(),isLocalOnHold:this.props.call.isLocalOnHold()})})),(0,v.A)(this,"onMouseMove",(()=>{var e;null===(e=this.buttonsRef.current)||void 0===e||e.showControls()})),(0,v.A)(this,"onMaximizeClick",(()=>{S.A.dispatch({action:"video_fullscreen",fullscreen:!0})})),(0,v.A)(this,"onMicMuteClick",(async()=>{const e=!this.state.micMuted;this.setState({micMuted:await this.props.call.setMicrophoneMuted(e)})})),(0,v.A)(this,"onVidMuteClick",(async()=>{const e=!this.state.vidMuted;this.setState({vidMuted:await this.props.call.setLocalVideoMuted(e)})})),(0,v.A)(this,"onScreenshareClick",(async()=>{let e;e=this.state.screensharing?await this.props.call.setScreensharingEnabled(!1):await this.props.call.setScreensharingEnabled(!0),this.setState({sidebarShown:!0,screensharing:e})})),(0,v.A)(this,"onNativeKeyDown",(e=>{var t,n;let i=!1;switch((0,_s.zM)().getCallAction(e)){case Pn.bY.ToggleMicInCall:this.onMicMuteClick(),null===(t=this.buttonsRef.current)||void 0===t||t.showControls(),i=!0;break;case Pn.bY.ToggleWebcamInCall:this.onVidMuteClick(),null===(n=this.buttonsRef.current)||void 0===n||n.showControls(),i=!0}i&&(e.stopPropagation(),e.preventDefault())})),(0,v.A)(this,"onCallResumeClick",(()=>{const e=et.Ay.instance.roomIdForCall(this.props.call);e&&et.Ay.instance.setActiveCallRoomId(e)})),(0,v.A)(this,"onTransferClick",(()=>{const e=et.Ay.instance.getTransfereeForCallId(this.props.call.callId);e&&this.props.call.transferToCall(e)})),(0,v.A)(this,"onHangupClick",(()=>{const e=et.Ay.instance.roomIdForCall(this.props.call);e&&et.Ay.instance.hangupOrReject(e)})),(0,v.A)(this,"onToggleSidebar",(()=>{this.setState({sidebarShown:!this.state.sidebarShown})}));const{primary:t,secondary:n,sidebar:s}=c_.getOrderedFeeds(this.props.call.getFeeds());this.state={isLocalOnHold:this.props.call.isLocalOnHold(),isRemoteOnHold:this.props.call.isRemoteOnHold(),micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted(),screensharing:this.props.call.isScreensharing(),callState:this.props.call.state,primaryFeed:t,secondaryFeed:n,sidebarFeeds:s,sidebarShown:!0}}componentDidMount(){this.updateCallListeners(null,this.props.call),this.dispatcherRef=S.A.register(this.onAction),document.addEventListener("keydown",this.onNativeKeyDown)}componentWillUnmount(){a_()&&l_(),document.removeEventListener("keydown",this.onNativeKeyDown),this.updateCallListeners(this.props.call,null),S.A.unregister(this.dispatcherRef)}static getDerivedStateFromProps(e){const{primary:t,secondary:n,sidebar:i}=c_.getOrderedFeeds(e.call.getFeeds());return{primaryFeed:t,secondaryFeed:n,sidebarFeeds:i}}componentDidUpdate(e){this.props.call!==e.call&&(this.setState({isLocalOnHold:this.props.call.isLocalOnHold(),isRemoteOnHold:this.props.call.isRemoteOnHold(),micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted(),callState:this.props.call.state}),this.updateCallListeners(null,this.props.call))}updateCallListeners(e,t){e!==t&&(e&&(e.removeListener(ft.$E.State,this.onCallState),e.removeListener(ft.$E.LocalHoldUnhold,this.onCallLocalHoldUnhold),e.removeListener(ft.$E.RemoteHoldUnhold,this.onCallRemoteHoldUnhold),e.removeListener(ft.$E.FeedsChanged,this.onFeedsChanged)),t&&(t.on(ft.$E.State,this.onCallState),t.on(ft.$E.LocalHoldUnhold,this.onCallLocalHoldUnhold),t.on(ft.$E.RemoteHoldUnhold,this.onCallRemoteHoldUnhold),t.on(ft.$E.FeedsChanged,this.onFeedsChanged)))}static getOrderedFeeds(e){if(e.length<=2)return{primary:e.find((e=>!e.isLocal())),secondary:e.find((e=>e.isLocal())),sidebar:[]};let t;const n=e.filter((e=>e.purpose===Wv.h.Screenshare));t=n.find((e=>!e.isLocal()))||n[0],t||(t=e.find((e=>!e.isLocal())));const i=[...e];return t&&i.splice(i.indexOf(t),1),i.sort(((e,t)=>e.isLocal()&&!t.isLocal()?-1:!e.isLocal()&&t.isLocal()?1:0)),{primary:t,sidebar:i}}renderCallControls(){const{call:e,pipMode:t}=this.props,{callState:n,micMuted:s,vidMuted:o,screensharing:r,sidebarShown:a,secondaryFeed:l,sidebarFeeds:c}=this.state,d=e.opponentSupportsSDPStreamMetadata()||e.hasLocalUserMediaVideoTrack,m=(e.opponentSupportsSDPStreamMetadata()||e.hasLocalUserMediaVideoTrack)&&e.state===ft.iP.Connected,u=l&&!l.isVideoMuted()||c.length>0,h=n===ft.iP.Connected,p=n===ft.iP.Connected&&e.opponentSupportsDTMF();return i.createElement(r_,{ref:this.buttonsRef,call:e,pipMode:t,handlers:{onToggleSidebarClick:this.onToggleSidebar,onScreenshareClick:this.onScreenshareClick,onHangupClick:this.onHangupClick,onMicMuteClick:this.onMicMuteClick,onVidMuteClick:this.onVidMuteClick},buttonsState:{micMuted:s,vidMuted:o,sidebarShown:a,screensharing:r},buttonsVisibility:{vidMute:d,screensharing:m,sidebar:u,contextMenu:h,dialpad:p}})}renderToast(){var e;const{call:t}=this.props;if(!t.getFeeds().some((e=>e.purpose===Wv.h.Screenshare)))return null;const n=t.isScreensharing(),{primaryFeed:s,sidebarShown:o}=this.state,r=null==s||null===(e=s.getMember())||void 0===e?void 0:e.name;if(!r)return null;let a=n?(0,l._t)("voip|you_are_presenting"):(0,l._t)("voip|user_is_presenting",{sharerName:r});return o||(a+=" • "+(t.isLocalVideoMuted()?(0,l._t)("voip|camera_disabled"):(0,l._t)("voip|camera_enabled"))),i.createElement("div",{className:"mx_LegacyCallView_toast"},a)}renderContent(){var e;const{pipMode:t,call:n,onResize:s}=this.props,{isLocalOnHold:o,isRemoteOnHold:r,sidebarShown:a,primaryFeed:c,secondaryFeed:d,sidebarFeeds:m}=this.state,u=et.Ay.instance.roomIdForCall(n),h=null!==(e=u?_.J.safeGet().getRoom(u):void 0)&&void 0!==e?e:void 0,p=t?"76px":"160px",g=et.Ay.instance.getTransfereeForCallId(n.callId),v=o||r;let f;if(a&&d&&!d.isVideoMuted()&&(f=i.createElement(zv,{feed:d,call:n,pipMode:t,onResize:s,secondary:!0})),g||v){const e=dt()("mx_LegacyCallView_content",{mx_LegacyCallView_content_hold:v}),t=(0,vt._V)(n.getOpponentMember(),1024,1024,"crop");let s;if(g){const e=_.J.safeGet(),t=et.Ay.instance.roomIdForCall(n),o=t?e.getRoom(t):null,r=o?o.name:(0,l._t)("voip|unknown_person"),a=et.Ay.instance.roomIdForCall(g),c=a?e.getRoom(a):null,d=c?c.name:(0,l._t)("voip|unknown_person");s=i.createElement("div",{className:"mx_LegacyCallView_status"},(0,l._t)("voip|consulting",{transferTarget:r,transferee:d},{a:e=>i.createElement(ie.A,{kind:"link_inline",onClick:this.onTransferClick},e)}))}else{let e;if(r)e=(0,l._t)(et.Ay.instance.hasAnyUnheldCall()?(0,l.AO)("voip|call_held_switch"):(0,l.AO)("voip|call_held_resume"),{},{a:e=>i.createElement(ie.A,{kind:"link_inline",onClick:this.onCallResumeClick},e)});else if(o){var E;e=(0,l._t)("voip|call_held",{peerName:null===(E=n.getOpponentMember())||void 0===E?void 0:E.name})}s=i.createElement("div",{className:"mx_LegacyCallView_status"},e)}return i.createElement("div",{className:e,onMouseMove:this.onMouseMove},i.createElement("div",{className:"mx_LegacyCallView_holdBackground",style:{backgroundImage:"url("+t+")"}}),s)}return n.noIncomingFeeds()?i.createElement("div",{className:"mx_LegacyCallView_content",onMouseMove:this.onMouseMove},i.createElement("div",{className:"mx_LegacyCallView_avatarsContainer"},i.createElement("div",{className:"mx_LegacyCallView_avatarContainer",style:{width:p,height:p}},i.createElement(Kt.A,{room:h,size:p}))),i.createElement("div",{className:"mx_LegacyCallView_status"},(0,l._t)("voip|connecting")),f):t?i.createElement("div",{className:"mx_LegacyCallView_content",onMouseMove:this.onMouseMove},i.createElement(zv,{feed:c,call:n,pipMode:t,onResize:s,primary:!0})):d?i.createElement("div",{className:"mx_LegacyCallView_content",onMouseMove:this.onMouseMove},i.createElement(zv,{feed:c,call:n,pipMode:t,onResize:s,primary:!0}),f):i.createElement("div",{className:"mx_LegacyCallView_content",onMouseMove:this.onMouseMove},i.createElement(zv,{feed:c,call:n,pipMode:t,onResize:s,primary:!0}),a&&i.createElement(Hv,{feeds:m,call:n,pipMode:Boolean(t)}))}render(){const{call:e,secondaryCall:t,pipMode:n,showApps:s,onMouseDownOnHeader:o}=this.props,{sidebarShown:r,sidebarFeeds:a}=this.state,l=_.J.safeGet(),c=et.Ay.instance.roomIdForCall(e),d=et.Ay.instance.roomIdForCall(t),m=c?l.getRoom(c):null;if(!m)return null;const u=d?l.getRoom(d):null,h=dt()({mx_LegacyCallView:!0,mx_LegacyCallView_pip:n,mx_LegacyCallView_large:!n,mx_LegacyCallView_sidebar:r&&0!==a.length&&!n,mx_LegacyCallView_belowWidget:s});return i.createElement("div",{className:h},i.createElement(Gv,{onPipMouseDown:o,pipMode:n,callRooms:[m,u],onMaximize:this.onMaximizeClick}),i.createElement("div",{className:"mx_LegacyCallView_content_wrapper",ref:this.contentWrapperRef},this.renderToast(),this.renderContent(),this.renderCallControls()))}}class d_ extends i.Component{constructor(e){super(e),(0,v.A)(this,"updateCall",(()=>{const e=this.getCall();e!==this.state.call&&this.setState({call:e})})),(0,v.A)(this,"onResizeStart",(()=>{this.props.resizeNotifier.startResizing()})),(0,v.A)(this,"onResize",(()=>{this.props.resizeNotifier.notifyTimelineHeightChanged()})),(0,v.A)(this,"onResizeStop",(()=>{this.props.resizeNotifier.stopResizing()})),this.state={call:this.getCall()}}componentDidMount(){et.Ay.instance.addListener(et.uv.CallState,this.updateCall),et.Ay.instance.addListener(et.uv.CallChangeRoom,this.updateCall)}componentWillUnmount(){et.Ay.instance.removeListener(et.uv.CallState,this.updateCall),et.Ay.instance.removeListener(et.uv.CallChangeRoom,this.updateCall)}getCall(){const e=et.Ay.instance.getCallForRoom(this.props.roomId);return e&&[ft.iP.Ended,ft.iP.Ringing].includes(e.state)?null:e}render(){return this.state.call?i.createElement("div",{className:"mx_LegacyCallViewForRoom"},i.createElement(qd.c,{minHeight:380,maxHeight:"80vh",enable:{top:!1,right:!1,bottom:!0,left:!1,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},onResizeStart:this.onResizeStart,onResize:this.onResize,onResizeStop:this.onResizeStop,className:"mx_LegacyCallViewForRoom_ResizeWrapper",handleClasses:{bottom:"mx_LegacyCallViewForRoom_ResizeHandle"}},i.createElement(c_,{call:this.state.call,pipMode:!1,showApps:this.props.showApps}))):null}}class m_ extends i.Component{shouldComponentUpdate(e){return(0,$t.No)(this.props,e)}render(){const e=i.createElement(d_,{roomId:this.props.room.roomId,resizeNotifier:this.props.resizeNotifier,showApps:this.props.showApps});let t;return M.A.getValue(He.f.Widgets)&&(t=i.createElement(Bv,{room:this.props.room,userId:this.props.userId,showApps:this.props.showApps,resizeNotifier:this.props.resizeNotifier})),i.createElement(xi.A,{role:"region",className:"mx_AuxPanel"},this.props.children,t,e)}}(0,v.A)(m_,"defaultProps",{showApps:!0});var u_=n("./node_modules/@vector-im/compound-web/dist/components/Typography/Body.js"),h_=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/voice-call.js"),p_=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/close.js"),g_=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/info-solid.js"),v_=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/notifications-solid.js"),__=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/verified.js");const f_=(e,t="")=>(null==e?void 0:e.name)||t;var E_=n("./src/hooks/useCall.ts");const y_=async(e,t,n,i)=>{const{analyticsName:s}=C_(n);Mn.A.trackInteraction(s),n==A_.LegacyCall||n==A_.JitsiCall?await et.Ay.instance.placeCall(e.roomId,t):n==A_.ElementCall&&S.A.dispatch({action:W.r.ViewRoom,room_id:e.roomId,view_call:!0,skipLobby:i,metricsTrigger:void 0})};var b_=n("./src/widgets/ManagedHybrid.ts"),w_=n("./src/stores/CallStore.ts");const S_=e=>{const t=(0,i.useMemo)((()=>c.Ay.get("element_call").guest_spa_url),[]),{joinRule:n,canInvite:s,canChangeJoinRule:r}=(0,eo.U)(e,(t=>({joinRule:e.getJoinRule(),canInvite:e.canInvite(e.myUserId),canChangeJoinRule:t.maySendStateEvent(o.EventType.RoomJoinRules,e.myUserId)}))),a=(0,i.useMemo)((()=>n===o.JoinRule.Public||n===o.JoinRule.Knock&&s),[s,n]);return{canInviteGuests:(0,i.useMemo)((()=>(r||a)&&void 0!==t),[r,a,t]),guestSpaUrl:t,isRoomJoinable:()=>{const t=e.getJoinRule();return t===o.JoinRule.Public||t===o.JoinRule.Knock&&e.canInvite(e.myUserId)},canInvite:s}};let A_=function(e){return e[e.ElementCall=0]="ElementCall",e[e.JitsiCall=1]="JitsiCall",e[e.LegacyCall=2]="LegacyCall",e}({});const C_=e=>{switch(e){case A_.ElementCall:return{label:(0,l._t)("voip|element_call"),analyticsName:"WebVoipOptionElementCall",children:i.createElement(ta.s,null)};case A_.JitsiCall:return{label:(0,l._t)("voip|jitsi_call"),analyticsName:"WebVoipOptionJitsi"};case A_.LegacyCall:return{label:(0,l._t)("voip|legacy_call"),analyticsName:"WebVoipOptionLegacy"}}};var x_=function(e){return e[e.NoCall=0]="NoCall",e[e.NoOneHere=1]="NoOneHere",e[e.NoPermission=2]="NoPermission",e[e.Unpinned=3]="Unpinned",e[e.Ongoing=4]="Ongoing",e[e.NotJoined=5]="NotJoined",e}(x_||{});var k_=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/chat-solid.js"),R_=n("./src/stores/notifications/NotificationState.ts");const I_=({room:e})=>{const t=(0,i.useContext)(X.A),n=t.roomNotificationStateStore.getRoomState(e),s=(0,ci.dF)(n,R_.ce.Update,(()=>null==n?void 0:n.level)),o=!!s&&[da.S.Activity,da.S.Notification,da.S.Highlight].includes(s);return i.createElement(Et.m,{label:(0,l._t)("right_panel|video_room_chat|title")},i.createElement(hl.K,{"aria-label":(0,l._t)("right_panel|video_room_chat|title"),onClick:e=>{e.stopPropagation(),t.rightPanelStore.showOrHidePhase(fl.n.Timeline)},indicator:o?"default":void 0},i.createElement(k_.A,null)))};var T_=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/check.js");const P_=({room:e})=>{const[t,n]=(0,i.useState)(!1),s=(0,ci.DY)(e,o.RoomStateEvent.Update,(0,i.useCallback)((()=>e.getMembersWithMembership(ut.O.Knock)),[e])),r=s.length;if(e.getJoinRule()!==o.JoinRule.Knock||0===r)return null;const a=e.client,c=a.getUserId()||"",d=e.canInvite(c),m=e.getMember(c),u=e.getLiveTimeline().getState(o.EventTimeline.FORWARDS),h=!(!m||!u)&&u.hasSufficientPowerLevelFor("kick",m.powerLevel);if(!d&&!h)return null;const p=e=>{k.Ay.createDialog(nt.A,{title:e.name,description:e.message})},g=()=>S.A.dispatch({action:"open_room_settings",room_id:e.roomId,initial_tab_id:mt.e.People});let v=i.createElement(ie.A,{className:"mx_RoomKnocksBar_action",kind:"primary",onClick:g,title:(0,l._t)("action|view")},(0,l._t)("action|view")),_=(0,bt.ki)(s.map((e=>e.name)),3,!0),f=null;var E;1===r&&(v=i.createElement(i.Fragment,null,i.createElement(ie.A,{className:"mx_RoomKnocksBar_action",disabled:!h||t,kind:"icon_primary_outline",onClick:()=>(t=>{n(!0),a.kick(e.roomId,t).catch(p).finally((()=>n(!1)))})(s[0].userId),title:(0,l._t)("action|deny")},i.createElement(p_.A,{width:18,height:18})),i.createElement(ie.A,{className:"mx_RoomKnocksBar_action",disabled:!d||t,kind:"icon_primary",onClick:()=>(t=>{n(!0),a.invite(e.roomId,t).catch(p).finally((()=>n(!1)))})(s[0].userId),title:(0,l._t)("action|approve")},i.createElement(T_.A,{width:18,height:18}))),_=`${s[0].name} (${s[0].userId})`,f=(null===(E=s[0].events.member)||void 0===E?void 0:E.getContent().reason)&&i.createElement(ie.A,{className:"mx_RoomKnocksBar_link",element:"a",kind:"link_inline",onClick:g},(0,l._t)("action|view_message")));return i.createElement("div",{className:"mx_RoomKnocksBar"},s.slice(0,2).map((e=>i.createElement(Mt.A,{className:"mx_RoomKnocksBar_avatar",key:e.userId,member:e,size:"32px"}))),i.createElement("div",{className:"mx_RoomKnocksBar_content"},i.createElement(Ql.A,{size:"4"},(0,l._t)("room|header|n_people_asking_to_join",{count:r})),i.createElement("p",{className:"mx_RoomKnocksBar_paragraph"},_,f)),v)},N_=({room:e})=>{const{canInviteGuests:t,guestSpaUrl:n,isRoomJoinable:o,canInvite:r}=S_(e),a=(0,i.useCallback)((()=>{if(!o())throw new Error("Cannot create link for room that users can not join without invite.");if(!n)throw new Error("No guest SPA url for external links provided.");const t=new URL(n);t.pathname="/room/",t.searchParams.set("roomId",e.roomId),e.hasEncryptionStateEvent()&&t.searchParams.set("perParticipantE2EE","true");for(const n of(0,yt.Ex)(e))t.searchParams.set("viaServers",n);return t.hash="/"+e.name+t.search,t.search="",s.v.info("Generated element call external url:",t),t}),[n,o,e]),c=(0,i.useCallback)((()=>{try{const e=a();k.Ay.createDialog(ym.A,{target:e,customTitle:(0,l._t)("share|share_call"),subtitle:(0,l._t)("share|share_call_subtitle")})}catch(e){s.v.error("Could not generate call link.",e)}}),[a]),d=(0,i.useCallback)((()=>{o()?c():k.Ay.createDialog(D_,{room:e,canInvite:r}).finished.then((()=>{o()&&c()}))}),[o,c,e,r]);return i.createElement(i.Fragment,null,t&&i.createElement(Et.m,{label:(0,l._t)("voip|get_call_link")},i.createElement(hl.K,{onClick:d},i.createElement(Oi.A,null))))},D_=({onFinished:e,room:t,canInvite:n})=>{const s=M.A.getValue("feature_ask_to_join"),[r,a]=i.useState(void 0),c=(0,i.useCallback)((async n=>{void 0===r&&(a(n),await t.client.sendStateEvent(t.roomId,o.EventType.RoomJoinRules,{join_rule:n},""),setTimeout((()=>e()),500))}),[r,e,t.client,t.roomId]);return i.createElement(J.A,{title:(0,l._t)("update_room_access_modal|title"),onFinished:e,className:"mx_JoinRuleDialog"},i.createElement("p",null,(0,l._t)("update_room_access_modal|description")),i.createElement("div",{className:"mx_JoinRuleDialogButtons"},s&&n&&i.createElement(mp.$,{kind:"secondary",className:"mx_Dialog_nonDialogButton",disabled:r===o.JoinRule.Knock,onClick:()=>c(o.JoinRule.Knock)},(0,l._t)("action|ask_to_join")),i.createElement(mp.$,{className:"mx_Dialog_nonDialogButton",kind:"destructive",disabled:r===o.JoinRule.Public,onClick:()=>c(o.JoinRule.Public)},(0,l._t)("common|public"))),i.createElement("p",null,(0,l._t)("update_room_access_modal|dont_change_description")),i.createElement("div",{className:"mx_JoinRuleDialogButtons"},i.createElement(mp.$,{kind:"tertiary",className:"mx_Dialog_nonDialogButton",onClick:()=>{void 0===r&&e()}},(0,l._t)("update_room_access_modal|no_change"))))};var M_=n("./src/utils/presence.ts"),O_=n("./src/utils/room/getJoinedNonFunctionalMembers.ts"),L_=function(e){return e.Online="ONLINE",e.Away="AWAY",e.Offline="OFFLINE",e.Busy="BUSY",e}(L_||{});function U_(e){switch(e){case L_.Online:return(0,l._t)("presence|online");case L_.Away:return(0,l._t)("presence|away");case L_.Offline:return(0,l._t)("presence|offline");case L_.Busy:return(0,l._t)("presence|busy")}}function F_(e){const t=x.A.shared().getUserIdForRoomId(e.roomId);return t?e.getMember(t):null}const V_=e=>{const[t,n]=(0,i.useState)(F_(e)),s=()=>{n(F_(e))};return(0,ci.ml)(e.currentState,o.RoomStateEvent.Members,s),(0,ci.ml)(e.client,o.ClientEvent.AccountData,s),(0,i.useEffect)(s,[e]),t};function B_(e){if(null==e||!e.user)return null;const t=e.user.presence,n=e.user.currentlyActive||"online"===t;return rs.I.matches(e.user.presence)?L_.Busy:n?L_.Online:"offline"===t?L_.Offline:"unavailable"===t?L_.Away:null}const j_=({room:e,size:t,tooltipProps:n,children:s})=>{const r=((e,t)=>{const[n,s]=(0,i.useState)(B_(t)),r=()=>{s(B_(t))};return(0,ci.ml)(null==t?void 0:t.user,o.UserEvent.Presence,r),(0,ci.ml)(null==t?void 0:t.user,o.UserEvent.CurrentlyActive,r),(0,i.useEffect)(r,[t]),2===(0,O_.T)(e).length&&(0,M_.T)(e.client)?n:null})(e,V_(e));let a;var l;r&&(a=i.createElement("div",{tabIndex:null!==(l=null==n?void 0:n.tabIndex)&&void 0!==l?l:0,className:`mx_WithPresenceIndicator_icon mx_WithPresenceIndicator_icon_${r.toLowerCase()}`,style:{width:t,height:t}}));return r?i.createElement("div",{className:"mx_WithPresenceIndicator"},s,i.createElement(Et.m,{label:U_(r),placement:"bottom"},a)):i.createElement(i.Fragment,null,s)};function W_({room:e,additionalButtons:t,oobData:n}){const s=(0,Hn.nH)(),r=function(e,t){let n=(0,l._t)("common|unnamed_room");t&&t.name&&(n=t.name);const[s,r]=(0,i.useState)(f_(e,n));return(0,ci.YK)(e,o.RoomEvent.Name,(()=>{r(f_(e,n))})),(0,i.useEffect)((()=>{r(f_(e,n))}),[e,n]),s}(e),a=(0,eo.U)(e,(e=>e.getJoinRule())),d=vv(e,2500),m=_v(e,{throttleWait:2500}),{voiceCallDisabledReason:u,voiceCallClick:h,videoCallDisabledReason:p,videoCallClick:g,toggleCallMaximized:v,isViewingCall:_,isConnectedToCall:f,hasActiveCallSession:E,callOptions:y,showVoiceCallButton:b,showVideoCallButton:w}=(e=>{var t,n;const s=(0,pt.ny)("feature_group_calls"),o=(0,i.useMemo)((()=>c.Ay.get("element_call").use_exclusively),[]),r=(0,ci.dF)(et.Ay.instance,et.uv.CallsChanged,(()=>null!==et.Ay.instance.getCallForRoom(e.roomId))),a=(0,th.X)(e),d=(0,i.useMemo)((()=>a.find((e=>gh.x.JITSI.matches(e.type)))),[a]),m=!!d,u=(0,i.useMemo)((()=>a.find(b_.ec)),[a]),h=!!u,p=(0,E_.Gc)(e.roomId),g=(0,E_.jd)(p)===Tt.KN.Connected,v=null!==p,_=(0,E_.q0)(p)>0,f=(0,ci.dF)(X.M.instance.roomViewStore,_r.H,(()=>X.M.instance.roomViewStore.isViewingCall()||(0,Vu.j)(e))),E=_v(e),[y,b]=(0,eo.U)(e,(()=>[e.currentState.mayClientSendStateEvent("im.vector.modular.widgets",e.client),e.currentState.mayClientSendStateEvent(Tt.Ho.MEMBER_EVENT_TYPE.name,e.client)])),w=(0,i.useMemo)((()=>{const e=[];return E<=2?e.push(A_.LegacyCall):(y||m)&&e.push(A_.JitsiCall),s&&((v||b)&&e.push(A_.ElementCall),o&&!m)||v&&gh.x.CALL.matches(p.widget.type)?[A_.ElementCall]:e}),[E,y,m,s,v,b,o,null==p?void 0:p.widget.type]);let A;var C;(w.includes(A_.JitsiCall)||w.includes(A_.LegacyCall))&&(A=null!=d?d:u),A=w.includes(A_.ElementCall)?null==p?void 0:p.widget:null!==(C=null==p?void 0:p.widget)&&void 0!==C?C:d;const x=(0,i.useCallback)((()=>{R(Jh.aK.instance.canAddToContainer(e,Jh.mc.Top)),T(!!A&&Jh.aK.instance.isInContainer(e,A,Jh.mc.Top))}),[e,A]);(0,ci.ml)(Jh.aK.instance,Jh.aK.emissionForRoom(e),x),(0,i.useEffect)((()=>{x()}),[e,d,p,x]);const[k,R]=(0,i.useState)(!1),[I,T]=(0,i.useState)(!1),P=!gh.x.CALL.matches(null!==(t=null===(n=A)||void 0===n?void 0:n.type)&&void 0!==t?t:"")&&k&&!I,N=(0,ci.dF)(w_.e.instance,w_.s.ConnectedCalls,(()=>Array.from(w_.e.instance.connectedCalls))),{canInviteGuests:D}=S_(e),O=(0,i.useMemo)((()=>N.find((t=>t.roomId!=e.roomId))?x_.Ongoing:v&&(m||h)?P?x_.Unpinned:x_.Ongoing:r?x_.Ongoing:E<=1&&!D?x_.NoOneHere:b||y?x_.NoCall:x_.NoPermission),[N,D,v,m,r,h,b,y,E,P,e.roomId]),L=(0,i.useCallback)(((t,n)=>{var i;null==t||t.stopPropagation(),A&&P?Jh.aK.instance.moveToContainer(e,A,Jh.mc.Top):y_(e,ft.JG.Voice,n,null!==(i=null==t?void 0:t.shiftKey)&&void 0!==i&&i)}),[P,e,A]),U=(0,i.useCallback)(((t,n)=>{var i;null==t||t.stopPropagation(),A&&P?Jh.aK.instance.moveToContainer(e,A,Jh.mc.Top):y_(e,ft.JG.Video,n,null!==(i=null==t?void 0:t.shiftKey)&&void 0!==i&&i)}),[A,P,e]);let F,V;switch(O){case x_.NoPermission:F=(0,l._t)("voip|disabled_no_perms_start_voice_call"),V=(0,l._t)("voip|disabled_no_perms_start_video_call");break;case x_.Ongoing:F=(0,l._t)("voip|disabled_ongoing_call"),V=(0,l._t)("voip|disabled_ongoing_call");break;case x_.NoOneHere:F=(0,l._t)("voip|disabled_no_one_here"),V=(0,l._t)("voip|disabled_no_one_here");break;case x_.Unpinned:case x_.NotJoined:case x_.NoCall:F=null,V=null}const B=(0,i.useCallback)((()=>{S.A.dispatch({action:W.r.ViewRoom,room_id:e.roomId,metricsTrigger:void 0,view_call:!f})}),[f,e.roomId]);let j=(0,b_.dq)(e)||!w.includes(A_.LegacyCall),z=!1;return E>2&&!M.A.getValue(He.f.Widgets)&&(j=!0,z=!0),{voiceCallDisabledReason:F,voiceCallClick:L,videoCallDisabledReason:V,videoCallClick:U,toggleCallMaximized:B,isViewingCall:f,isConnectedToCall:g,hasActiveCallSession:_,callOptions:w,showVoiceCallButton:!j,showVideoCallButton:!z}})(e),A=(0,pt.ny)("feature_group_calls"),C=(0,i.useMemo)((()=>c.Ay.get("element_call").use_exclusively&&A),[A]),x=(e=>{const[t,n]=(0,i.useState)(da.S.None),s=(0,i.useCallback)((()=>{switch(null==e?void 0:e.threadsAggregateNotificationType){case o.NotificationCountType.Highlight:return void n(da.S.Highlight);case o.NotificationCountType.Total:return void n(da.S.Notification)}(0,El.Nb)(e)?n(da.S.Activity):n(da.S.None)}),[e]);return(0,ci.ml)(e,o.RoomEvent.UnreadNotifications,s),(0,ci.ml)(e,o.RoomEvent.Receipt,s),(0,ci.ml)(e,o.RoomEvent.Timeline,s),(0,ci.ml)(e,o.RoomEvent.Redaction,s),(0,ci.ml)(e,o.RoomEvent.LocalEchoUpdated,s),(0,ci.ml)(e,o.RoomEvent.MyMembership,s),(0,ci.ml)(e,o.ThreadEvent.New,s),(0,ci.ml)(e,o.ThreadEvent.Update,s),(0,i.useEffect)((()=>{s()}),[s]),t})(e),k=(()=>{const[e,t]=(0,i.useState)(ya.n.instance.globalState);return(0,ci.ml)(ya.n.instance,ya.N,(e=>{t(e)})),e})(),R=!!V_(e),I=function(e,t){const[n,s]=(0,i.useState)(null),r=(0,i.useMemo)((()=>(0,Vn.throttle)((()=>{e.getCrypto()&&(0,bm.G)(e,t).then((e=>{s(e)}))}),250,{leading:!0,trailing:!0})),[e,t]);return(0,i.useEffect)(r,[r]),(0,ci.YK)(t,o.RoomStateEvent.Members,r),(0,ci.YK)(e,o.CryptoEvent.UserTrustStatusChanged,r),(0,ci.YK)(e,o.CryptoEvent.DevicesUpdated,r),n}(s,e),T=(0,pt.ny)("feature_notifications"),P=(0,pt.ny)("feature_ask_to_join"),N=(0,i.useCallback)((e=>g(e,y[0])),[y,g]),D=i.createElement(Et.m,{label:_?(0,l._t)("voip|minimise_call"):(0,l._t)("voip|maximise_call")},i.createElement(hl.K,{onClick:v},i.createElement(Aa.A,null))),O=i.createElement(Et.m,{label:null!=p?p:(0,l._t)("voip|video_call")},i.createElement(mp.$,{size:"sm",onClick:N,Icon:Aa.A,className:"mx_RoomHeader_join_button",disabled:!!p,color:"primary","aria-label":null!=p?p:(0,l._t)("action|join")},(0,l._t)("action|join"))),L=i.createElement(Et.m,{label:null!=p?p:(0,l._t)("voip|video_call")},i.createElement(Aa.A,null)),[U,F]=(0,i.useState)(!1),V=(0,i.useCallback)((e=>{p||F(e)}),[p]),B=i.createElement(i.Fragment,null,y.length>1?i.createElement(ml.W,{open:U,onOpenChange:V,title:(0,l._t)("voip|video_call_using"),trigger:i.createElement(hl.K,{disabled:!!p,"aria-label":null!=p?p:(0,l._t)("voip|video_call")},L),side:"left",align:"start"},y.map((e=>{const{label:t,children:n}=C_(e);return i.createElement(ul.D,{key:e,label:t,"aria-label":t,children:n,className:"mx_RoomHeader_videoCallOption",onClick:t=>g(t,e),Icon:Aa.A,onSelect:()=>{}})}))):i.createElement(hl.K,{disabled:!!p,"aria-label":null!=p?p:(0,l._t)("voip|video_call"),onClick:N},L));let j=i.createElement(Et.m,{label:null!=u?u:(0,l._t)("voip|voice_call")},i.createElement(hl.K,{disabled:!!u||_||f,"aria-label":null!=u?u:(0,l._t)("voip|voice_call"),onClick:e=>h(e,y[0])},i.createElement(h_.A,null)));const z=i.createElement(Et.m,{label:(0,l._t)("voip|close_lobby")},i.createElement(hl.K,{onClick:v},i.createElement(p_.A,null)));let H=B;f?H=D:_&&(H=z),w||(H=void 0),b||(j=void 0);const K=(0,i.useContext)(jt.Ay),J=(0,Vu.j)(e),G=J||K.mainSplitContentType===jt.DZ.MaximisedWidget||K.mainSplitContentType===jt.DZ.Call;return i.createElement(i.Fragment,null,i.createElement(ku.s,{as:"header",align:"center",gap:"var(--cpd-space-3x)",className:"mx_RoomHeader light-panel"},i.createElement(j_,{room:e,size:"8px"},i.createElement(Kt.A,{room:e,size:"40px",oobData:n,onClick:()=>{S.A.dispatch({action:"open_room_settings",initial_tab_id:mt.e.General})},tabIndex:-1,"aria-label":(0,l._t)("room|header_avatar_open_settings_label")})),i.createElement("button",{"aria-label":(0,l._t)("right_panel|room_summary_card|title"),tabIndex:0,onClick:()=>_l.A.instance.showOrHidePhase(fl.n.RoomSummary),className:"mx_RoomHeader_infoWrapper"},i.createElement(Ou,{flex:"1",className:"mx_RoomHeader_info"},i.createElement(u_.n,{as:"div",size:"lg",weight:"semibold",dir:"auto",role:"heading","aria-level":1,className:"mx_RoomHeader_heading"},i.createElement("span",{className:"mx_RoomHeader_truncated mx_lineClamp"},r),!R&&a===o.JoinRule.Public&&i.createElement(Et.m,{label:(0,l._t)("common|public_room"),placement:"right"},i.createElement(gm.A,{width:"16px",height:"16px",className:"mx_RoomHeader_icon text-secondary","aria-label":(0,l._t)("common|public_room")})),R&&I===bm.z.Verified&&i.createElement(Et.m,{label:(0,l._t)("common|verified"),placement:"right"},i.createElement(__.A,{width:"16px",height:"16px",className:"mx_RoomHeader_icon mx_Verified","aria-label":(0,l._t)("common|verified")})),R&&I===bm.z.Warning&&i.createElement(Et.m,{label:(0,l._t)("room|header_untrusted_label"),placement:"right"},i.createElement(vm.A,{width:"16px",height:"16px",className:"mx_RoomHeader_icon mx_Untrusted","aria-label":(0,l._t)("room|header_untrusted_label")}))))),i.createElement(ku.s,{align:"center",gap:"var(--cpd-space-2x)"},null==t?void 0:t.map((e=>{const t=e.label();return i.createElement(Et.m,{label:t,key:e.id},i.createElement(hl.K,{"aria-label":t,onClick:t=>{t.stopPropagation(),e.onClick()}},"function"==typeof e.icon?e.icon():e.icon))})),_&&i.createElement(N_,{room:e}),!E||f||_?i.createElement(i.Fragment,null,!J&&H,!C&&!J&&j):O,i.createElement(Et.m,{label:(0,l._t)("right_panel|room_summary_card|title")},i.createElement(hl.K,{onClick:e=>{e.stopPropagation(),_l.A.instance.showOrHidePhase(fl.n.RoomSummary)},"aria-label":(0,l._t)("right_panel|room_summary_card|title")},i.createElement(g_.A,null))),G&&i.createElement(I_,{room:e}),i.createElement(Et.m,{label:(0,l._t)("common|threads")},i.createElement(hl.K,{indicator:(0,mi.W7)(x),onClick:e=>{e.stopPropagation(),_l.A.instance.showOrHidePhase(fl.n.ThreadPanel),Mn.A.trackInteraction("WebRoomHeaderButtonsThreadsButton",e)},"aria-label":(0,l._t)("common|threads")},i.createElement(li.A,null))),T&&i.createElement(Et.m,{label:(0,l._t)("notifications|enable_prompt_toast_title")},i.createElement(hl.K,{indicator:(0,mi.W7)(k.level),onClick:e=>{e.stopPropagation(),_l.A.instance.showOrHidePhase(fl.n.NotificationPanel)},"aria-label":(0,l._t)("notifications|enable_prompt_toast_title")},i.createElement(v_.A,null)))),!R&&i.createElement(u_.n,{as:"div",size:"sm",weight:"medium"},i.createElement(Ev.A,{className:"mx_RoomHeader_members",members:d.slice(0,3),size:"20px",overflow:!1,viewUserOnClick:!1,tooltipLabel:(0,l._t)("room|header_face_pile_tooltip"),onClick:e=>{_l.A.instance.showOrHidePhase(fl.n.RoomMemberList),e.stopPropagation()},"aria-label":(0,l._t)("common|n_members",{count:m})},(0,bt.B4)(m)))),P&&i.createElement(P_,{room:e}))}const z_=({roomWidth:e})=>{const t=(0,i.useRef)(null),o=(0,i.useRef)(new Map);return(0,i.useEffect)((()=>{const e=()=>{var e;t.current&&(null===(e=t.current)||void 0===e?void 0:e.height)!==Zr.A.instance.windowHeight&&(t.current.height=Zr.A.instance.windowHeight)},i=S.A.register((e=>{const i="effects.",r=function(e){if(!e)return!1;const t=Date.now(),n=e.getTs();return t-n>H_}(e.event);if(t.current&&e.action.startsWith(i)&&!r){(async e=>{if(!e)return null;let t=o.current.get(e)||null;if(null===t){var i;const r=null===(i=Ah.y.find((t=>t.command===e)))||void 0===i?void 0:i.options;try{const{default:i}=await n("./src/effects lazy recursive ^\\.\\/.*$ referencedExports: default")(`./${e}`);t=new i(r),o.current.set(e,t)}catch(t){s.v.warn(`Unable to load effect module at '../../../effects/${e}.`,t)}}return t})(e.action.slice(8)).then((e=>null==e?void 0:e.start(t.current)))}})),r=t.current;return r&&(r.height=Zr.A.instance.windowHeight),Zr.A.instance.on(Zr.x.Resize,e),()=>{S.A.unregister(i),Zr.A.instance.off(Zr.x.Resize,e);const t=o.current;for(const e in t){const n=t.get(e);n&&n.isRunning&&n.stop()}}}),[]),i.createElement("canvas",{ref:t,width:e,style:{display:"block",zIndex:999999,pointerEvents:"none",position:"fixed",top:0,right:0},"aria-hidden":!0})},H_=1728e5;const K_=({room:e,resizing:t,call:n,skipLobby:s,role:o})=>{const r=(0,i.useContext)(Hn.Ay);(0,i.useEffect)((()=>{n.clean()}),[n]),(0,i.useEffect)((()=>{var e,t;null!==(t=(e=n.widget).data)&&void 0!==t||(e.data={}),n.widget.data.skipLobby=s}),[n.widget,s]),(0,i.useEffect)((()=>(n.connectionState===Tt.KN.Disconnected&&n.start(),()=>{n.connected||n.destroy()})),[n]);const a=(0,i.useCallback)((async()=>{const e=[...w_.e.instance.connectedCalls].filter((e=>X.M.instance.roomViewStore.getRoomId()!==e.roomId));await Promise.all(e.map((async e=>await e.disconnect())))}),[]);return i.createElement("div",{className:"mx_CallView"},i.createElement(cp,{app:n.widget,room:e,userId:r.credentials.userId,creatorUserId:n.widget.creatorUserId,waitForIframeLoad:n.widget.waitForIframeLoad,showMenubar:!1,pointerEvents:t?"none":void 0,stickyPromise:a}))},J_=({room:e,resizing:t,waitForCall:n,skipLobby:s,role:o})=>{const r=(0,E_.Gc)(e.roomId);return(0,i.useEffect)((()=>{null!==r||n||Tt.Ho.create(e,s)}),[r,e,s,n]),null===r?null:i.createElement(K_,{room:e,resizing:t,call:r,skipLobby:s,role:o})};var G_=n("./src/toasts/DesktopNotificationsToast.ts"),$_=n("./src/email.ts");const q_=(e,t)=>{const[n,s]=(0,i.useState)((()=>Array.isArray(t)?t:new Array(e).fill(t)));return[n,(e,t)=>s((n=>{const i=[...n];return i[e]=t,i}))]};var Y_=n("./src/components/views/spaces/SpacePublicShare.tsx"),Q_=n("./node_modules/matrix-js-sdk/src/room-hierarchy.ts"),X_=n("./src/components/views/elements/InfoTooltip.tsx"),Z_=n("./src/utils/RoomUpgrade.ts");function ef(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function tf(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ef(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ef(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const nf=({room:e,suggested:t,selected:n,hasPermissions:s,onToggleClick:r,onViewRoomClick:a,onJoinRoomClick:c,numChildRooms:d,children:m})=>{var u,h;const p=(0,i.useContext)(Hn.Ay),g=(0,ci.DY)(p,o.ClientEvent.Room,(()=>{const t=null==p?void 0:p.getRoom(e.room_id);return(null==t?void 0:t.getMyMembership())===ut.O.Join?t:void 0})),v=(0,ci.DY)(g,o.RoomEvent.Name,(e=>null==e?void 0:e.name)),_=v||e.name||e.canonical_alias||(null===(u=e.aliases)||void 0===u?void 0:u[0])||(e.room_type===o.RoomType.Space?(0,l._t)("common|unnamed_space"):(0,l._t)("common|unnamed_room")),[f,E]=(0,Ys.X)(!0),[y,b,w,S]=(0,wn.A9)(),[A,C]=(0,i.useState)(!1),x=e=>{e.preventDefault(),e.stopPropagation(),a()},k=async t=>{C(!0),t.preventDefault(),t.stopPropagation();try{await c(),await(0,Z_.R)(p,e.room_id)}finally{C(!1)}};let R,I,T;R=A?i.createElement(ie.A,{disabled:!0,onClick:k,kind:"primary_outline",onFocus:y,tabIndex:b?0:-1,title:(0,l._t)("space|joining_space")},i.createElement(se.A,{w:24,h:24})):g||e.join_rule===o.JoinRule.Knock?i.createElement(ie.A,{onClick:x,kind:"primary_outline",onFocus:y,tabIndex:b?0:-1},(0,l._t)("action|view")):i.createElement(ie.A,{onClick:k,kind:"primary",onFocus:y,tabIndex:b?0:-1},(0,l._t)("action|join")),r&&(I=s?i.createElement(Ms.A,{checked:!!n,onChange:r,tabIndex:b?0:-1}):i.createElement(Eh.A,{tooltip:(0,l._t)("space|user_lacks_permission"),onClick:e=>{e.stopPropagation()}},i.createElement(Ms.A,{disabled:!0,tabIndex:b?0:-1}))),T=g?i.createElement(Kt.A,{room:g,size:"20px"}):i.createElement(os.A,{name:_,idName:e.room_id,url:e.avatar_url?(0,Wn.lH)(e.avatar_url).getSquareThumbnailHttp(20):null,size:"20px"});let P,N,D,M,O=(0,l._t)("common|n_members",{count:null!==(h=e.num_joined_members)&&void 0!==h?h:0});if(void 0!==d&&(O+=" · "+(0,l._t)("common|n_rooms",{count:d})),g){const e=Js(g);P=(0,zn.sH)(null==e?void 0:e.text,null==e?void 0:e.html)}else P=e.topic;P&&(N=i.createElement(zn.XZ,{options:{attributes:{onClick(e){e.stopPropagation()}}}}," · ",P)),g&&(D=i.createElement("div",{className:"mx_SpaceHierarchy_roomTile_joined"},(0,l._t)("common|joined"))),!t||g&&!s||(M=i.createElement(X_.A,{tooltip:(0,l._t)("space|suggested_tooltip")},(0,l._t)("space|suggested")));const L=i.createElement(i.Fragment,null,i.createElement("div",{className:"mx_SpaceHierarchy_roomTile_item"},i.createElement("div",{className:"mx_SpaceHierarchy_roomTile_avatar"},T),i.createElement("div",{className:"mx_SpaceHierarchy_roomTile_name"},_,D,M),i.createElement("div",{className:"mx_SpaceHierarchy_roomTile_info"},O,N)),i.createElement("div",{className:"mx_SpaceHierarchy_actions"},R,I));let U,F,V;if(m){if(U=i.createElement("div",{className:dt()("mx_SpaceHierarchy_subspace_toggle",{mx_SpaceHierarchy_subspace_toggle_shown:f}),onClick:e=>{e.stopPropagation(),E()}}),f){const e=e=>{var t;if((0,_s.zM)().getAccessibilityAction(e)===Pn.bY.ArrowLeft)e.preventDefault(),e.stopPropagation(),null===(t=S.current)||void 0===t||t.focus()};F=i.createElement("div",{className:"mx_SpaceHierarchy_subspace_children",onKeyDown:e,role:"group"},m)}V=e=>{let t=!1;switch((0,_s.zM)().getAccessibilityAction(e)){case Pn.bY.ArrowLeft:f&&(t=!0,E());break;case Pn.bY.ArrowRight:if(t=!0,f){var n,i;const e=null===(n=S.current)||void 0===n?void 0:n.nextElementSibling;null==e||null===(i=e.querySelector(".mx_SpaceHierarchy_roomTile"))||void 0===i||i.focus()}else E()}t&&(e.preventDefault(),e.stopPropagation())}}return i.createElement("li",{className:"mx_SpaceHierarchy_roomTileWrapper",role:"treeitem","aria-selected":n,"aria-expanded":m?f:void 0},i.createElement(ie.A,{className:dt()("mx_SpaceHierarchy_roomTile",{mx_SpaceHierarchy_subspace:e.room_type===o.RoomType.Space,mx_SpaceHierarchy_joining:A}),onClick:s&&r?r:x,onKeyDown:V,ref:w,onFocus:y,tabIndex:b?0:-1},L,U),F)},sf=(e,t,n,i)=>{var s,o;const r=t.roomMap.get(n);if(e.isGuest()&&!(null!=r&&r.world_readable||null!=r&&r.guest_can_join))return void S.A.dispatch({action:"require_registration"});const a=(0,gr.iW)(null!==(s=null==r?void 0:r.canonical_alias)&&void 0!==s?s:"",null!==(o=null==r?void 0:r.aliases)&&void 0!==o?o:[])||void 0;S.A.dispatch({action:W.r.ViewRoom,should_peek:!0,room_alias:a,room_id:n,via_servers:Array.from(t.viaMap.get(n)||[]),oob_data:{avatarUrl:null==r?void 0:r.avatar_url,name:(null==r?void 0:r.name)||a||(0,l._t)("common|unnamed_room"),roomType:i},metricsTrigger:"RoomDirectory"})},of=async(e,t,n)=>{if(e.isGuest())S.A.dispatch({action:"require_registration"});else{try{await e.joinRoom(n,{viaServers:Array.from(t.viaMap.get(n)||[])})}catch(e){throw e instanceof o.MatrixError?X.M.instance.roomViewStore.showJoinRoomError(e,n):(s.v.warn("Got a non-MatrixError while joining room",e),X.M.instance.roomViewStore.showJoinRoomError(new o.MatrixError({error:(0,l._t)("error|unknown")}),n)),e}S.A.dispatch({action:W.r.JoinRoomReady,roomId:n,metricsTrigger:"SpaceHierarchy"})}},rf=({root:e,roomSet:t,hierarchy:n,parents:s,selectedMap:r,onViewRoomClick:a,onJoinRoomClick:l,onToggleClick:c})=>{const d=(0,i.useContext)(Hn.Ay),m=d.getRoom(e.room_id),u=null==m?void 0:m.currentState.maySendStateEvent(o.EventType.SpaceChild,d.getSafeUserId()),h=(0,Vn.sortBy)(e.children_state,(e=>(0,us.tK)(e.content.order,e.origin_server_ts,e.state_key))),[p,g]=h.reduce(((e,i)=>{const s=n.roomMap.get(i.state_key);return s&&t.has(s)&&e[s.room_type===o.RoomType.Space?0:1].push(((e,t,n)=>{const i=e.getRoomUpgradeHistory(t.room_id,!0,M.A.getValue("feature_dynamic_room_predecessors"));let s=null;for(let e=i.length-1;e>=0;--e)if(n.roomMap.get(i[e].roomId)){s=i[e];break}var r,a,l,c,d;return s?tf(tf({},t),{},{room_id:s.roomId,room_type:s.getType(),name:s.name,topic:null===(r=s.currentState.getStateEvents(o.EventType.RoomTopic,""))||void 0===r?void 0:r.getContent().topic,avatar_url:null!==(a=s.getMxcAvatarUrl())&&void 0!==a?a:void 0,canonical_alias:null!==(l=s.getCanonicalAlias())&&void 0!==l?l:void 0,aliases:s.getAltAliases(),world_readable:(null===(c=s.currentState.getStateEvents(o.EventType.RoomHistoryVisibility,""))||void 0===c?void 0:c.getContent().history_visibility)===o.HistoryVisibility.WorldReadable,guest_can_join:(null===(d=s.currentState.getStateEvents(o.EventType.RoomGuestAccess,""))||void 0===d?void 0:d.getContent().guest_access)===o.GuestAccess.CanJoin,num_joined_members:s.getJoinedMemberCount()}):t})(d,s,n)),e}),[[],[]]),v=new Set(s).add(e.room_id);return i.createElement(i.Fragment,null,(0,Vn.uniqBy)(g,"room_id").map((t=>{var s;return i.createElement(nf,{key:t.room_id,room:t,suggested:n.isSuggested(e.room_id,t.room_id),selected:null==r||null===(s=r.get(e.room_id))||void 0===s?void 0:s.has(t.room_id),onViewRoomClick:()=>a(t.room_id,t.room_type),onJoinRoomClick:()=>l(t.room_id,v),hasPermissions:u,onToggleClick:c?()=>c(e.room_id,t.room_id):void 0})})),p.filter((e=>!v.has(e.room_id))).map((s=>{var d;return i.createElement(nf,{key:s.room_id,room:s,numChildRooms:s.children_state.filter((e=>{const i=n.roomMap.get(e.state_key);return i&&t.has(i)&&!i.room_type})).length,suggested:n.isSuggested(e.room_id,s.room_id),selected:null==r||null===(d=r.get(e.room_id))||void 0===d?void 0:d.has(s.room_id),onViewRoomClick:()=>a(s.room_id,o.RoomType.Space),onJoinRoomClick:()=>l(s.room_id,v),hasPermissions:u,onToggleClick:c?()=>c(e.room_id,s.room_id):void 0},i.createElement(rf,{root:s,roomSet:t,hierarchy:n,parents:v,selectedMap:r,onViewRoomClick:a,onJoinRoomClick:l,onToggleClick:c}))})))},af=({hierarchy:e,selected:t,setSelected:n,setError:s})=>{const r=(0,i.useContext)(Hn.Ay),[a,c]=(0,i.useState)(!1),[d,m]=(0,i.useState)(!1),u=Array.from(t.keys()).flatMap((e=>[...t.get(e).values()].map((t=>[e,t])))),h=u.every((([t,n])=>e.isSuggested(t,n))),p=!u.length||a||d;let g=(0,l._t)("common|saving");d||(g=h?(0,l._t)("space|unmark_suggested"):(0,l._t)("space|mark_suggested"));const v=u.length?void 0:(0,l._t)("space|select_room_below");return i.createElement(i.Fragment,null,i.createElement(ie.A,{onClick:async()=>{c(!0);try{const t=r.getSafeUserId();for(const[n,i]of u){await r.sendStateEvent(n,o.EventType.SpaceChild,{},i);const s=r.getRoom(i),a=null==s?void 0:s.currentState.getStateEvents(o.EventType.SpaceParent,n);null!=s&&s.currentState.maySendStateEvent(o.EventType.SpaceParent,t)&&Array.isArray(null==a?void 0:a.getContent().via)&&await r.sendStateEvent(i,o.EventType.SpaceParent,{},n),e.removeRelation(n,i)}}catch{s((0,l._t)("space|failed_remove_rooms"))}c(!1),n(new Map)},kind:"danger_outline",disabled:p,"aria-label":a?(0,l._t)("redact|ongoing"):(0,l._t)("action|remove"),title:v,placement:"top"},a?(0,l._t)("redact|ongoing"):(0,l._t)("action|remove")),i.createElement(ie.A,{onClick:async()=>{m(!0);try{for(const[n,i]of u){var t;const s=!h,a=null===(t=e.getRelation(n,i))||void 0===t?void 0:t.content;if(!a||a.suggested===s)continue;const l=tf(tf({},a),{},{suggested:!h});await r.sendStateEvent(n,o.EventType.SpaceChild,l,i),a.suggested=l.suggested}}catch{s("Failed to update some suggestions. Try again later")}m(!1),n(new Map)},kind:"primary_outline",disabled:p,"aria-label":g,title:v,placement:"top"},g))},lf=({space:e,initialText:t="",showRoom:n,additionalButtons:s})=>{const r=(0,i.useContext)(Hn.Ay),[a,c]=(0,i.useState)(t),[d,m]=(0,i.useState)(new Map),{loading:u,rooms:h,hierarchy:p,loadMore:g,error:v}=(e=>{const[t,n]=(0,i.useState)([]),[s,o]=(0,i.useState)(),[r,a]=(0,i.useState)(),l=(0,i.useCallback)((()=>{a(void 0);const t=new Q_.B(e,20);t.load().then((()=>{var i;e===t.root&&n(null!==(i=t.rooms)&&void 0!==i?i:[])}),a),o(t)}),[e]);(0,i.useEffect)(l,[l]),(0,Ws.F)(S.A,(e=>{e.action===W.r.UpdateSpaceHierarchy&&(n([]),l())}));const c=(0,i.useCallback)((async e=>{var t;!s||s.loading||!s.canLoadMore||s.noSupport||r||(await s.load(e).catch(a),n(null!==(t=s.rooms)&&void 0!==t?t:[]))}),[r,s]);return(null==s?void 0:s.root)!==e?{loading:!0,loadMore:c}:{loading:s.loading,rooms:t,hierarchy:s,loadMore:c,error:r}})(e),_=(0,i.useMemo)((()=>{if(null==h||!h.length||!p)return new Set;const e=a.toLowerCase().trim();if(!e)return new Set(h);const t=h.filter((t=>{var n,i;return(null===(n=t.name)||void 0===n?void 0:n.toLowerCase().includes(e))||(null===(i=t.topic)||void 0===i?void 0:i.toLowerCase().includes(e))})),n=new Set,i=[...t.map((e=>e.room_id))];for(;i.length;){var s;const e=i.pop();n.add(e),null===(s=p.backRefs.get(e))||void 0===s||s.forEach((e=>{n.has(e)||i.push(e)}))}return new Set(h.filter((e=>n.has(e.room_id))))}),[h,p,a]),[f,E]=(0,i.useState)("");let y=f;!f&&v&&(y=(0,l._t)("space|failed_load_rooms"));const b=(e=>{const t=t=>{t[0].isIntersecting&&e()},n=(0,i.useRef)();return e=>{n.current?n.current.disconnect():e&&(n.current=new IntersectionObserver(t,{root:e.parentElement,rootMargin:"0px 0px 600px 0px"})),n.current&&e&&n.current.observe(e)}})(g);if(!u&&p.noSupport)return i.createElement("p",null,(0,l._t)("space|incompatible_server_hierarchy"));const w=(e,t)=>{if(E(""),!d.has(e))return void m(new Map(d.set(e,new Set([t]))));const n=d.get(e);n.has(t)?(n.delete(t),m(new Map(d.set(e,new Set(n))))):m(new Map(d.set(e,new Set([...n,t]))))};return i.createElement(wn.Se,{onKeyDown:(e,t)=>{var n;(0,_s.zM)().getAccessibilityAction(e)===Pn.bY.ArrowDown&&e.currentTarget.classList.contains("mx_SpaceHierarchy_search")&&(null===(n=t.nodes[0])||void 0===n||n.focus())},handleHomeEnd:!0,handleUpDown:!0},(({onKeyDownHandler:g})=>{let v;if(p&&(!u||null!=h&&h.length)){const t=(null==e?void 0:e.getMyMembership())===ut.O.Join&&e.currentState.maySendStateEvent(o.EventType.SpaceChild,r.getSafeUserId()),c=p.roomMap.get(e.roomId);let u,h;_.size&&c?u=i.createElement(i.Fragment,null,i.createElement(rf,{root:c,roomSet:_,hierarchy:p,parents:new Set,selectedMap:d,onToggleClick:t?w:void 0,onViewRoomClick:(e,t)=>n(r,p,e,t),onJoinRoomClick:async(e,t)=>{for(const e of t){var n;(null===(n=r.getRoom(e))||void 0===n?void 0:n.getMyMembership())!==ut.O.Join&&await of(r,p,e)}await of(r,p,e)}})):p.canLoadMore||(u=i.createElement("div",{className:"mx_SpaceHierarchy_noResults"},i.createElement("h3",null,(0,l._t)("common|no_results_found")),i.createElement("div",null,(0,l._t)("space|no_search_result_hint")))),p.canLoadMore&&(h=i.createElement("div",{ref:b},i.createElement(se.A,null))),v=i.createElement(i.Fragment,null,i.createElement("div",{className:"mx_SpaceHierarchy_listHeader"},i.createElement("h4",{className:"mx_SpaceHierarchy_listHeader_header"},a.trim()?(0,l._t)("space|title_when_query_available"):(0,l._t)("space|title_when_query_unavailable")),i.createElement("div",{className:"mx_SpaceHierarchy_listHeader_buttons"},s,t&&i.createElement(af,{hierarchy:p,selected:d,setSelected:m,setError:E}))),y&&i.createElement("div",{className:"mx_SpaceHierarchy_error"},y),i.createElement("ul",{className:"mx_SpaceHierarchy_list",onKeyDown:g,role:"tree","aria-label":(0,l._t)("common|space")},u),h)}else v=i.createElement(se.A,null);return i.createElement(i.Fragment,null,i.createElement(Zi.A,{className:"mx_SpaceHierarchy_search mx_textinput_icon mx_textinput_search",placeholder:(0,l._t)("space|search_placeholder"),onSearch:c,autoFocus:!0,initialValue:t,onKeyDown:g}),v)}))};var cf=function(e){return e[e.Landing=0]="Landing",e[e.PublicCreateRooms=1]="PublicCreateRooms",e[e.PublicShare=2]="PublicShare",e[e.PrivateScope=3]="PrivateScope",e[e.PrivateInvite=4]="PrivateInvite",e[e.PrivateCreateRooms=5]="PrivateCreateRooms",e[e.PrivateExistingRooms=6]="PrivateExistingRooms",e}(cf||{});const df=({space:e})=>{const[t,n,s,r]=(0,Gt.EF)(),a=(0,ea.g)(He.C.CreateRooms),c=(0,ea.g)(He.C.CreateSpaces),d=(0,pt.ny)("feature_video_rooms"),m=(0,pt.ny)("feature_element_call_video_rooms");let u=null;if(t){const t=n.current.getBoundingClientRect();u=i.createElement(na.Ay,{left:t.left+window.scrollX+0,top:t.bottom+window.scrollY+8,chevronFace:Gt.t4.None,onFinished:r,className:"mx_RoomTile_contextMenu",compact:!0},i.createElement(na.tx,{first:!0},a&&i.createElement(i.Fragment,null,i.createElement(na.R$,{label:(0,l._t)("action|new_room"),iconClassName:"mx_RoomList_iconNewRoom",onClick:async t=>{t.preventDefault(),t.stopPropagation(),r(),Mn.A.trackInteraction("WebSpaceHomeCreateRoomButton",t),await(0,mo.PT)(e)&&S.A.fire(W.r.UpdateSpaceHierarchy)}}),d&&i.createElement(na.R$,{label:(0,l._t)("action|new_video_room"),iconClassName:"mx_RoomList_iconNewVideoRoom",onClick:async t=>{t.preventDefault(),t.stopPropagation(),r(),await(0,mo.PT)(e,m?o.RoomType.UnstableCall:o.RoomType.ElementVideo)&&S.A.fire(W.r.UpdateSpaceHierarchy)}},i.createElement(ta.s,null))),i.createElement(na.R$,{label:(0,l._t)("action|add_existing_room"),iconClassName:"mx_RoomList_iconAddExistingRoom",onClick:t=>{t.preventDefault(),t.stopPropagation(),r(),(0,mo.yV)(e)}}),c&&i.createElement(na.R$,{label:(0,l._t)("room_list|add_space_label"),iconClassName:"mx_RoomList_iconPlus",onClick:t=>{t.preventDefault(),t.stopPropagation(),r(),(0,mo.Sl)(e)}},i.createElement(ta.s,null))))}return i.createElement(i.Fragment,null,i.createElement(Gt.VJ,{kind:"primary",ref:n,onClick:s,isExpanded:t,label:(0,l._t)("action|add")},(0,l._t)("action|add")),u)},mf=({space:e})=>{const t=(0,i.useContext)(Hn.Ay),n=fv(e),s=t.getSafeUserId(),r=(0,i.useCallback)((()=>{var t;return _l.A.instance.isOpenForRoom(e.roomId)&&(null===(t=_l.A.instance.currentCardForRoom(e.roomId))||void 0===t?void 0:t.phase)===fl.n.SpaceMemberList}),[e.roomId]),a=(0,ci.dF)(_l.A.instance,_r.H,r);let c;(0,mo.MI)(e)&&(0,ea.g)(He.C.InviteUsers)&&(c=i.createElement(ie.A,{kind:"primary",className:"mx_SpaceRoomView_landing_inviteButton",onClick:()=>{(0,mo.Lo)(e)}},(0,l._t)("action|invite")));let d,m;n===ut.O.Join&&e.currentState.maySendStateEvent(o.EventType.SpaceChild,s)&&(d=i.createElement(df,{space:e})),(0,mo.Kv)(e)&&(m=i.createElement(ie.A,{className:"mx_SpaceRoomView_landing_settingsButton",onClick:()=>{(0,mo.hL)(e)},title:(0,l._t)("common|settings"),placement:"bottom"}));return i.createElement("div",{className:"mx_SpaceRoomView_landing"},i.createElement("div",{className:"mx_SpaceRoomView_landing_header"},i.createElement(Kt.A,{room:e,size:"80px",viewAvatarOnClick:!0,type:"square"})),i.createElement("div",{className:"mx_SpaceRoomView_landing_name"},i.createElement(Os,{room:e},(e=>{const t={name:()=>i.createElement("h1",null,e)};return(0,l._t)("space|landing_welcome",{},t)}))),i.createElement("div",{className:"mx_SpaceRoomView_landing_infoBar"},i.createElement(Av,{room:e}),i.createElement("div",{className:"mx_SpaceRoomView_landing_infoBar_interactive"},i.createElement(Sv,{room:e,onlyKnownUsers:!1,numShown:7,onClick:a?void 0:()=>{_l.A.instance.setCard({phase:fl.n.SpaceMemberList})}}),c,m)),i.createElement(Fu,{room:e,className:"mx_SpaceRoomView_landing_topic"}),i.createElement(lf,{space:e,showRoom:sf,additionalButtons:d}))},uf=({space:e,title:t,description:n,onFinished:r})=>{const[a,c]=(0,i.useState)(!1),[d,m]=(0,i.useState)(""),u=[(0,l._t)("common|general"),(0,l._t)("common|random"),(0,l._t)("common|support")],[h,p]=q_(3,[(0,l._t)("common|general"),(0,l._t)("common|random"),""]),g=new Array(3).fill(0).map(((e,t)=>{const n="roomName"+t;return i.createElement(ks.A,{key:n,name:n,type:"text",label:(0,l._t)("common|room_name"),placeholder:u[t],value:h[t],onChange:e=>p(t,e.target.value),autoFocus:2===t,disabled:a,autoComplete:"off"})})),v=async t=>{if(t.preventDefault(),!a){m(""),c(!0);try{var n;const t=e.getJoinRule()===o.JoinRule.Public,i=h.map((e=>e.trim())).filter(Boolean),s=await Promise.all(i.map((n=>(0,As.Ay)(e.client,{createOpts:{preset:t?o.Preset.PublicChat:o.Preset.PrivateChat,name:n},spinner:!1,encryption:!1,andView:!1,inlineErrors:!0,parentSpace:e,joinRule:t?void 0:o.JoinRule.Restricted,suggested:!0}))));r(null!==(n=s[0])&&void 0!==n?n:void 0)}catch(e){s.v.error("Failed to create initial space rooms",e),m((0,l._t)("create_space|failed_create_initial_rooms"))}c(!1)}};let _=e=>{e.preventDefault(),r()},f=(0,l._t)("create_space|skip_action");return h.some((e=>e.trim()))&&(_=v,f=a?(0,l._t)("create_space|creating_rooms"):(0,l._t)("action|continue")),i.createElement("div",null,i.createElement("h1",null,t),i.createElement("div",{className:"mx_SpaceRoomView_description"},n),d&&i.createElement("div",{className:"mx_SpaceRoomView_errorText"},d),i.createElement("form",{onSubmit:_,id:"mx_SpaceSetupFirstRooms"},g),i.createElement("div",{className:"mx_SpaceRoomView_buttons"},i.createElement(ie.A,{kind:"primary",disabled:a,onClick:_,element:"input",type:"submit",form:"mx_SpaceSetupFirstRooms",value:f})))},hf=({space:e,onFinished:t})=>i.createElement("div",null,i.createElement("h1",null,(0,l._t)("create_space|add_existing_rooms_heading")),i.createElement("div",{className:"mx_SpaceRoomView_description"},(0,l._t)("create_space|add_existing_rooms_description")),i.createElement(co.sS,{space:e,emptySelectionButton:i.createElement(ie.A,{kind:"primary",onClick:t},(0,l._t)("create_space|skip_action")),filterPlaceholder:(0,l._t)("space|room_filter_placeholder"),onFinished:t,roomsRenderer:co.FM,dmsRenderer:co.nZ})),pf=({justCreatedOpts:e,space:t,onFinished:n,firstRoomId:s})=>{var o;return i.createElement("div",{className:"mx_SpaceRoomView_publicShare"},i.createElement("h1",null,(0,l._t)("create_space|share_heading",{name:(null==e||null===(o=e.createOpts)||void 0===o?void 0:o.name)||t.name})),i.createElement("div",{className:"mx_SpaceRoomView_description"},(0,l._t)("create_space|share_description")),i.createElement(Y_.A,{space:t}),i.createElement("div",{className:"mx_SpaceRoomView_buttons"},i.createElement(ie.A,{kind:"primary",onClick:n},s?(0,l._t)("create_space|done_action_first_room"):(0,l._t)("create_space|done_action"))))},gf=({space:e,justCreatedOpts:t,onFinished:n})=>{var s;return i.createElement("div",{className:"mx_SpaceRoomView_privateScope"},i.createElement("h1",null,(0,l._t)("create_space|private_personal_heading")),i.createElement("div",{className:"mx_SpaceRoomView_description"},(0,l._t)("create_space|private_personal_description",{name:(null==t||null===(s=t.createOpts)||void 0===s?void 0:s.name)||e.name})),i.createElement(ie.A,{className:"mx_SpaceRoomView_privateScope_justMeButton",onClick:()=>{n(!1)}},(0,l._t)("create_space|personal_space"),i.createElement("div",null,(0,l._t)("create_space|personal_space_description"))),i.createElement(ie.A,{className:"mx_SpaceRoomView_privateScope_meAndMyTeammatesButton",onClick:()=>{n(!0)}},(0,l._t)("create_space|private_space"),i.createElement("div",null,(0,l._t)("create_space|private_space_description"))))},vf=(0,xm.A)({rules:[{key:"email",test:({value:e})=>!e||$_.X(e),invalid:()=>(0,l._t)("auth|email_field_label_invalid")}]}),_f=({space:e,onFinished:t})=>{const[n,o]=(0,i.useState)(!1),[r,a]=(0,i.useState)(""),c=[(0,i.useRef)(null),(0,i.useRef)(null),(0,i.useRef)(null)],[d,m]=q_(3,""),u=new Array(3).fill(0).map(((e,t)=>{const s="emailAddress"+t;return i.createElement(ks.A,{key:s,name:s,type:"text",label:(0,l._t)("common|email_address"),placeholder:(0,l._t)("auth|email_field_label"),value:d[t],onChange:e=>m(t,e.target.value),ref:c[t],onValidate:vf,autoFocus:0===t,disabled:n})})),h=async i=>{if(i.preventDefault(),n)return;a("");for(const e of c){var r;if(!1===await(null===(r=e.current)||void 0===r?void 0:r.validate({allowEmpty:!0})))return e.current.focus(),void e.current.validate({allowEmpty:!0,focused:!0})}o(!0);const m=d.map((e=>e.trim())).filter(Boolean);try{const n=await(0,pr.wq)(e.client,e.roomId,m),i=Object.keys(n.states).filter((e=>"error"===n.states[e]));i.length>0?(s.v.log("Failed to invite users to space: ",n),a((0,l._t)("create_space|failed_invite_users",{csvUsers:i.join(", ")}))):t()}catch(e){s.v.error("Failed to invite users to space: ",e),a((0,l._t)("invite|error_invite"))}o(!1)};let p=e=>{e.preventDefault(),t()},g=(0,l._t)("create_space|skip_action");return d.some((e=>e.trim()))&&(p=h,g=n?(0,l._t)("create_space|inviting_users"):(0,l._t)("action|continue")),i.createElement("div",{className:"mx_SpaceRoomView_inviteTeammates"},i.createElement("h1",null,(0,l._t)("create_space|invite_teammates_heading")),i.createElement("div",{className:"mx_SpaceRoomView_description"},(0,l._t)("create_space|invite_teammates_description")),r&&i.createElement("div",{className:"mx_SpaceRoomView_errorText"},r),i.createElement("form",{onSubmit:p,id:"mx_SpaceSetupPrivateInvite"},u),i.createElement("div",{className:"mx_SpaceRoomView_inviteTeammates_buttons"},i.createElement(ie.A,{className:"mx_SpaceRoomView_inviteTeammates_inviteDialogButton",onClick:()=>(0,pr._7)(e.roomId)},(0,l._t)("create_space|invite_teammates_by_username"))),i.createElement("div",{className:"mx_SpaceRoomView_buttons"},i.createElement(ie.A,{kind:"primary",disabled:n,onClick:p,element:"input",type:"submit",form:"mx_SpaceSetupPrivateInvite",value:g})))};class ff extends i.PureComponent{constructor(e,t){var n;super(e,t),(0,v.A)(this,"dispatcherRef",void 0),(0,v.A)(this,"onMyMembership",((e,t)=>{e.roomId===this.props.space.roomId&&this.setState({myMembership:t})})),(0,v.A)(this,"onRightPanelStoreUpdate",(()=>{this.setState({showRightPanel:_l.A.instance.isOpenForRoom(this.props.space.roomId)})})),(0,v.A)(this,"onAction",(e=>{e.action!==W.r.ViewRoom||e.room_id!==this.props.space.roomId||this.setState({phase:cf.Landing})})),(0,v.A)(this,"goToFirstRoom",(async()=>{this.state.firstRoomId?S.A.dispatch({action:W.r.ViewRoom,room_id:this.state.firstRoomId,metricsTrigger:void 0}):this.setState({phase:cf.Landing})}));let i=cf.Landing;const s=null===(n=this.props.space.currentState.getStateEvents(o.EventType.RoomCreate,""))||void 0===n?void 0:n.getSender();var r;this.props.justCreatedOpts&&t.getSafeUserId()===s&&(i=(null===(r=this.props.justCreatedOpts.createOpts)||void 0===r?void 0:r.preset)===o.Preset.PublicChat?cf.PublicCreateRooms:cf.PrivateScope);this.state={phase:i,showRightPanel:_l.A.instance.isOpenForRoom(this.props.space.roomId),myMembership:this.props.space.getMyMembership()}}componentDidMount(){this.dispatcherRef=S.A.register(this.onAction),_l.A.instance.on(_r.H,this.onRightPanelStoreUpdate),this.context.on(o.RoomEvent.MyMembership,this.onMyMembership)}componentWillUnmount(){S.A.unregister(this.dispatcherRef),_l.A.instance.off(_r.H,this.onRightPanelStoreUpdate),this.context.off(o.RoomEvent.MyMembership,this.onMyMembership)}renderBody(){var e;switch(this.state.phase){case cf.Landing:return this.state.myMembership===ut.O.Join?i.createElement(mf,{space:this.props.space}):i.createElement(Cv,{room:this.props.space,onJoinButtonClicked:this.props.onJoinButtonClicked,onRejectButtonClicked:this.props.onRejectButtonClicked});case cf.PublicCreateRooms:return i.createElement(uf,{space:this.props.space,title:(0,l._t)("create_space|setup_rooms_community_heading",{spaceName:(null===(e=this.props.justCreatedOpts)||void 0===e||null===(e=e.createOpts)||void 0===e?void 0:e.name)||this.props.space.name}),description:i.createElement(i.Fragment,null,(0,l._t)("create_space|setup_rooms_community_description"),i.createElement("br",null),(0,l._t)("create_space|setup_rooms_description")),onFinished:e=>this.setState({phase:cf.PublicShare,firstRoomId:e})});case cf.PublicShare:return i.createElement(pf,{justCreatedOpts:this.props.justCreatedOpts,space:this.props.space,onFinished:this.goToFirstRoom,firstRoomId:this.state.firstRoomId});case cf.PrivateScope:return i.createElement(gf,{space:this.props.space,justCreatedOpts:this.props.justCreatedOpts,onFinished:e=>{this.setState({phase:e?cf.PrivateCreateRooms:cf.PrivateExistingRooms})}});case cf.PrivateInvite:return i.createElement(_f,{space:this.props.space,onFinished:()=>this.setState({phase:cf.Landing})});case cf.PrivateCreateRooms:return i.createElement(uf,{space:this.props.space,title:(0,l._t)("create_space|setup_rooms_private_heading"),description:i.createElement(i.Fragment,null,(0,l._t)("create_space|setup_rooms_private_description"),i.createElement("br",null),(0,l._t)("create_space|setup_rooms_description")),onFinished:e=>this.setState({phase:cf.PrivateInvite,firstRoomId:e})});case cf.PrivateExistingRooms:return i.createElement(hf,{space:this.props.space,onFinished:()=>this.setState({phase:cf.Landing})})}}render(){const e=this.state.showRightPanel&&this.state.phase===cf.Landing?i.createElement(ov,{room:this.props.space,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.props.permalinkCreator}):void 0;return i.createElement("main",{className:"mx_SpaceRoomView"},i.createElement(Hm.A,null,i.createElement(Yd,{panel:e,resizeNotifier:this.props.resizeNotifier,analyticsRoomType:"space"},this.renderBody())))}}(0,v.A)(ff,"contextType",Hn.Ay);var Ef=n("./src/components/structures/RoomStatusBar.tsx");class yf extends i.PureComponent{render(){return i.createElement("div",{className:"mx_TopUnreadMessagesBar"},i.createElement(ie.A,{className:"mx_TopUnreadMessagesBar_scrollUp",title:(0,l._t)("room|jump_read_marker"),onClick:this.props.onScrollUpClick}),i.createElement(ie.A,{className:"mx_TopUnreadMessagesBar_markAsRead",title:(0,l._t)("notifications|mark_all_read"),onClick:this.props.onCloseClick}))}}var bf=n("./src/utils/direct-messages.ts"),wf=n("./src/components/views/messages/EncryptionEvent.tsx"),Sf=n("./src/components/structures/RoomStatusBarUnsentMessages.tsx");const Af=({text:e})=>i.createElement("div",{className:"mx_LargeLoader"},i.createElement(se.A,{w:45,h:45}),i.createElement("div",{className:"mx_LargeLoader_text"},e));class Cf extends i.Component{constructor(e,t){super(e,t),(0,v.A)(this,"callEventGroupers",new Map),this.buildLegacyCallEventGroupers(this.props.timeline)}buildLegacyCallEventGroupers(e){this.callEventGroupers=(0,Ep.fN)(this.callEventGroupers,e)}render(){const e=this.props.timeline,t=e[this.props.ourEventsIndexes[0]],n=t.getId(),s=t.getTs(),o=[i.createElement(Wm.A,{key:s+"-search",roomId:t.getRoomId(),ts:s})],r=M.A.getValue("layout"),a=M.A.getValue("showTwelveHourTimestamps"),l=M.A.getValue("alwaysShowTimestamps"),c=_.J.safeGet();for(let t=0;t<e.length;t++){var d;const s=e[t];let h;const p=!this.props.ourEventsIndexes.includes(t);if(p||(h=this.props.searchHighlights),(0,It.bN)(s,c,null===(d=this.context)||void 0===d?void 0:d.showHiddenEvents)){var m;const d=e[t-1],g=d&&!(0,Re.fq)(d.getDate()||void 0,s.getDate()||void 0)&&du(d,s,c,null===(m=this.context)||void 0===m?void 0:m.showHiddenEvents,jt.Ae.Search);let v=!0;const _=e[t+1];if(_){var u;v=(0,Re.fq)(s.getDate()||void 0,_.getDate()||void 0)||s.getSender()!==_.getSender()||!du(s,_,c,null===(u=this.context)||void 0===u?void 0:u.showHiddenEvents,jt.Ae.Search)}o.push(i.createElement(Gi,{key:`${n}+${t}`,mxEvent:s,layout:r,contextual:p,highlights:h,permalinkCreator:this.props.permalinkCreator,highlightLink:this.props.resultLink,onHeightChanged:this.props.onHeightChanged,isTwelveHour:a,alwaysShowTimestamps:l,lastInSection:v,continuation:g,callEventGrouper:this.callEventGroupers.get(s.getContent().call_id)}))}}return i.createElement("li",{"data-scroll-tokens":n},i.createElement("ol",null,o))}}(0,v.A)(Cf,"contextType",jt.Ay);var xf=n("./src/Typeguards.ts");async function kf(e,t,n,i){const s={limit:10};void 0!==n&&(s.rooms=[n]);const r={search_categories:{room_events:{search_term:t,filter:s,order_by:o.SearchOrderBy.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}};return{response:await e.search({body:r},i),query:r}}async function Rf(e,t,n,i){const s=await kf(e,t,n,i),o={abortSignal:i,_query:s.query,results:[],highlights:[]};return e.processRoomEventsSearch(o,s.response)}function If(e,t){const n=e.result,i=t.result;return n.origin_server_ts>i.origin_server_ts?-1:n.origin_server_ts<i.origin_server_ts?1:0}async function Tf(e,t,n=!0){const i=E.A.get(),s={search_term:e,before_limit:1,after_limit:1,limit:10,order_by_recency:!0,room_id:void 0};void 0!==t&&(s.room_id=t);const o=await i.search(s);if(!o)throw new Error("Local search failed");s.next_batch=o.next_batch;return{response:o,query:s}}function Pf(e,t){try{const n=e[e.length-1].result,i=t[t.length-1].result;return n.origin_server_ts<=i.origin_server_ts?-1:1}catch{return 0}}function Nf(e,t,n,i){const s=n.concat(i).sort(If);t.results=s.slice(0,10),e.cachedEvents=s.slice(10)}function Df(e,t,n){var i;const s=function(e,t,n){var i;const s={},o=null!==(i=e.cachedEvents)&&void 0!==i?i:[];let r=e.oldestEventFrom;var a,l,c,d;if(s.highlights=e.highlights,t&&n&&n.results)Pf(null!==(a=t.results)&&void 0!==a?a:[],n.results)<0&&(r="local"),Nf(e,s,null!==(l=t.results)&&void 0!==l?l:[],n.results),s.highlights=(null!==(c=t.highlights)&&void 0!==c?c:[]).concat(null!==(d=n.highlights)&&void 0!==d?d:[]);else if(t){var m,u;Pf(null!==(m=t.results)&&void 0!==m?m:[],o)<0&&(r="local"),Nf(e,s,null!==(u=t.results)&&void 0!==u?u:[],o)}else n&&n.results?(Pf(n.results,o)<0&&(r="server"),Nf(e,s,n.results,o)):(s.results=o,e.cachedEvents=[]);return e.oldestEventFrom=r,s}(e,t,n);if(e.count)s.count=e.count;else{var o,r;const e=null!==(o=null==t?void 0:t.count)&&void 0!==o?o:0,i=null!==(r=null==n?void 0:n.count)&&void 0!==r?r:0;s.count=e+i}return t&&(0,xf.E)(e.seshatQuery)&&(e.seshatQuery.next_batch=t.next_batch),n&&(e.serverSideNextBatch=n.next_batch),null!==(i=e.seshatQuery)&&void 0!==i&&i.next_batch?s.next_batch=e.seshatQuery.next_batch:e.serverSideNextBatch&&(s.next_batch=e.serverSideNextBatch),!s.next_batch&&(0,xf.E)(e.cachedEvents)&&e.cachedEvents.length>0&&(s.next_batch="cached"),s}function Mf(e=[]){for(const t of e){const e=t.context.getTimeline();for(const t of e){const e=t.event;e.curve25519Key&&(t.makeEncrypted(o.EventType.RoomMessageEncrypted,{algorithm:e.algorithm},e.curve25519Key,e.ed25519Key),t.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain,delete e.curve25519Key,delete e.ed25519Key,delete e.algorithm,delete e.forwardingCurve25519KeyChain)}}}async function Of(e,t,n,i){let s;var o;void 0!==n?s=await(null===(o=e.getCrypto())||void 0===o?void 0:o.isEncryptionEnabledInRoom(n))?async function(e,t,n){const i={results:[],highlights:[]};if(""===t)return i;const s=await Tf(t,n);i.seshatQuery=s.query;const o={search_categories:{room_events:s.response}},r=e.processRoomEventsSearch(i,o);return Mf(r.results),r}(e,t,n):Rf(e,t,n,i):s=async function(e,t,n){const i=kf(e,t,void 0,n),s=Tf(t);await Promise.all([i,s]);const o=await s,r=await i,a=r.query,l=r.response,c=o.query,d=o.response,m={seshatQuery:c,_query:a,serverSideNextBatch:l.search_categories.room_events.next_batch,cachedEvents:[],oldestEventFrom:"server",results:[],highlights:[]},u={search_categories:{room_events:Df(m,d,l.search_categories.room_events)}},h=e.processRoomEventsSearch(m,u);return Mf(h.results),h}(e,t,i);return s}function Lf(e,t){const n=t.seshatQuery,i=t._query;if(n){if(i){const n=async function(e,t){var n;const i=E.A.get(),s=t.seshatQuery,o=t.oldestEventFrom;let r,a;if(null==s||!s.next_batch||t.serverSideNextBatch&&"server"!==o||(r=await i.search(s)),t.serverSideNextBatch&&("local"===o||null==s||!s.next_batch)){const n={body:t._query,next_batch:t.serverSideNextBatch};a=await e.search(n)}const l={search_categories:{room_events:Df(t,r,null===(n=a)||void 0===n?void 0:n.search_categories.room_events)}},c=t.results?t.results.length:0,d=e.processRoomEventsSearch(t,l),m=d.results.length-c;return Mf(d.results.slice(Math.max(d.results.length-m,0))),t.pendingRequest=void 0,d}(e,t);return t.pendingRequest=n,n}{const n=async function(e,t){var n,i;const s=E.A.get();if(!t.seshatQuery)throw new Error("localSearchProcess must be called first");const o=await s.search(t.seshatQuery);if(!o)throw new Error("Local search pagination failed");t.seshatQuery.next_batch=o.next_batch;const r=null!==(n=null===(i=o.results)||void 0===i?void 0:i.length)&&void 0!==n?n:0,a={search_categories:{room_events:o}},l=e.processRoomEventsSearch(t,a);return Mf(l.results.slice(Math.max(l.results.length-r,0))),t.pendingRequest=void 0,l}(e,t);return t.pendingRequest=n,n}}return e.backPaginateRoomEventsSearch(t)}let Uf=function(e){return e.Room="Room",e.All="All",e}({});function Ff(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}let Vf=function(e){};const Bf=(0,i.forwardRef)((({term:e,scope:t,promise:n,abortController:r,resizeNotifier:a,className:c,onUpdate:d,inProgress:m},u)=>{const h=(0,i.useContext)(Hn.Ay),p=(0,i.useContext)(jt.Ay),[g,_]=(0,i.useState)(null),[f,y]=(0,i.useState)(null),b=(0,i.useRef)(!1),w=(0,i.useRef)(new Map).current,S=(0,i.useRef)();(0,i.useEffect)((()=>()=>{w.forEach((e=>e.stop())),w.clear()}),[w]);const A=(0,i.useCallback)((t=>(d(!0,null),t.then((async t=>{if(Vf("search complete"),b.current)return s.v.error("Discarding stale search results"),!1;let n=t.highlights;n.includes(e)||(n=n.concat(e)),n=n.sort((function(e,t){return t.length-e.length}));for(const e of t.results)for(const t of e.context.getTimeline()){if(!t.getServerAggregatedRelation(o.THREAD_RELATION_TYPE.name)||t.getThread())continue;const e=h.getRoom(t.getRoomId()),n=null==e?void 0:e.findThreadForEvent(t);n?t.setThread(n):null==e||e.createThread(t.getId(),t,[],!0)}return _(n),y(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ff(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ff(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},t)),d(!1,t),!1}),(e=>{var t;return b.current?(s.v.error("Discarding stale search results"),!1):(s.v.error("Search failed",e),k.Ay.createDialog(nt.A,{title:(0,l._t)("error_dialog|search_failed|title"),description:null!==(t=null==e?void 0:e.message)&&void 0!==t?t:(0,l._t)("error_dialog|search_failed|server_unavailable")}),d(!1,null),!1)})))),[h,e,d]);if((0,i.useEffect)((()=>(b.current=!1,A(n),()=>{b.current=!0,null==r||r.abort()})),[]),null===f)return i.createElement("div",{className:"mx_RoomView_messagePanel mx_RoomView_messagePanelSearchSpinner"});const C=[];var x;(m&&C.push(i.createElement("li",{key:"search-spinner"},i.createElement(se.A,null))),f.next_batch)||(null!=f&&null!==(x=f.results)&&void 0!==x&&x.length?C.push(i.createElement("li",{key:"search-top-marker"},i.createElement("h2",{className:"mx_RoomView_topMarker"},(0,l._t)("no_more_results")))):C.push(i.createElement("li",{key:"search-top-marker"},i.createElement("h2",{className:"mx_RoomView_topMarker"},(0,l._t)("common|no_results")))));const R=()=>{var e;null===(e=S.current)||void 0===e||e.checkScroll()};let I,T=[],P=[];for(let e=((null==f||null===(N=f.results)||void 0===N?void 0:N.length)||0)-1;e>=0;e--){var N;const n=f.results[e],o=n.context.getEvent(),r=o.getRoomId(),a=h.getRoom(r);if(!a){s.v.log("Hiding search result from an unknown room",r);continue}if(!(0,It.bN)(o,h,p.showHiddenEvents))continue;t===Uf.All&&r!==I&&(C.push(i.createElement("li",{key:o.getId()+"-room"},i.createElement("h2",null,(0,l._t)("common|room"),": ",a.name))),I=r);const c="#/room/"+r+"/"+o.getId(),d=n.context.getTimeline(),m=e>0?f.results[e-1].context.getTimeline():[];if(e>0&&d[d.length-1].getId()==m[0].getId()){if(0==T.length){for(let e=0==T.length?0:1;e<n.context.getTimeline().length;e++)T.push(d[e]);P.push(n.context.getOurEventIndex())}for(let e=1;e<m.length;e++)T.push(m[e]);P.push(P[P.length-1]+f.results[e-1].context.getOurEventIndex()+1);continue}0==T.length&&(T=n.context.getTimeline(),P=[],P.push(n.context.getOurEventIndex()));let u=w.get(r);u||(u=new yt.pE(a),u.start(),w.set(r,u)),C.push(i.createElement(Cf,{key:o.getId(),timeline:T,ourEventsIndexes:P,searchHighlights:null!=g?g:[],resultLink:c,permalinkCreator:u,onHeightChanged:R})),P=[],T=[]}return i.createElement(jm.A,{ref:e=>{"function"==typeof u?u(e):u&&(u.current=e),S.current=e},className:"mx_RoomView_searchResultsPanel "+c,onFillRequest:async e=>{if(!e)return!1;if(!f.next_batch)return Vf("no more search results"),!1;Vf("requesting more search results");const t=function(e,t){const n=E.A.get();return t.pendingRequest?t.pendingRequest:null===n?e.backPaginateRoomEventsSearch(t):Lf(e,t)}(h,f);return A(t)},resizeNotifier:a},i.createElement("li",{className:"mx_RoomView_scrollheader"}),C)}));var jf=n("./src/VoipUserMapper.ts");const Wf=({roomView:e,resizeNotifier:t,inviteEvent:n})=>{const s=(0,jt.mP)(),o=c.Ay.get().brand;return i.createElement("div",{className:"mx_RoomView mx_RoomView--local"},i.createElement(Hm.A,null,i.createElement(W_,{room:s.room}),i.createElement("main",{className:"mx_RoomView_body",ref:e},i.createElement("div",{className:"mx_RoomView_timeline"},i.createElement(jm.A,{className:"mx_RoomView_messagePanel",resizeNotifier:t},i.createElement($m.A,{className:"mx_cryptoEvent mx_cryptoEvent_icon",title:(0,l._t)("room|waiting_for_join_title",{brand:o}),subtitle:(0,l._t)("room|waiting_for_join_subtitle",{brand:o})}),i.createElement(au,null),i.createElement(Ji,{mxEvent:n}))))))};var zf=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/search.js");const Hf=({searchInfo:e,isRoomEncrypted:t,onSearchScopeChange:n,onCancelClick:s})=>{var o;const r=null!==(o=null==e?void 0:e.scope)&&void 0!==o?o:Uf.Room;return i.createElement(i.Fragment,null,i.createElement(Mn.Z,{screenName:"RoomSearch"}),i.createElement("div",{className:"mx_RoomSearchAuxPanel"},i.createElement("div",{className:"mx_RoomSearchAuxPanel_summary"},i.createElement(zf.A,{width:"24px",height:"24px"}),i.createElement("div",{className:"mx_RoomSearchAuxPanel_summary_text"},void 0!==(null==e?void 0:e.count)?(0,l._t)("room|search|summary",{count:e.count},{query:()=>i.createElement("strong",null,e.term)}):i.createElement(oa.A,null),i.createElement(fp,{kind:_p.Search,isRoomEncrypted:t,showLogo:!1}))),i.createElement("div",{className:"mx_RoomSearchAuxPanel_buttons"},i.createElement(Qd.N,{onClick:()=>n(r===Uf.Room?Uf.All:Uf.Room),kind:"primary"},r===Uf.All?(0,l._t)("room|search|this_room_button"):(0,l._t)("room|search|all_rooms_button")),i.createElement(hl.K,{onClick:s,destructive:!0,tooltip:(0,l._t)("action|cancel"),"aria-label":(0,l._t)("action|cancel")},i.createElement(p_.A,{width:"20px",height:"20px"})))))};function Kf({room:e,permalinkCreator:t}){const n=zu(e),s=Ju(e,n),o=s.length,r=1===o,[a,c]=(0,i.useState)(o-1);(0,i.useEffect)((()=>{c((()=>o-1))}),[o]);const d=s[a];if(!d)return null;const m=d.isRedacted()||d.isDecryptionFailure();return i.createElement("div",{className:"mx_PinnedMessageBanner","data-single-message":r,"aria-label":(0,l._t)("room|pinned_message_banner|description")},i.createElement("button",{"aria-label":(0,l._t)("room|pinned_message_banner|go_to_message"),type:"button",className:"mx_PinnedMessageBanner_main",onClick:()=>{Mn.A.trackInteraction("PinnedMessageBannerClick"),S.A.dispatch({action:W.r.ViewRoom,event_id:d.getId(),highlighted:!0,room_id:e.roomId,metricsTrigger:void 0}),c((e=>-1==--e?o-1:e))}},i.createElement("div",{className:"mx_PinnedMessageBanner_content"},i.createElement(Gf,{count:o,currentIndex:a}),i.createElement(ji.A,{width:"20px",height:"20px",className:"mx_PinnedMessageBanner_PinIcon"}),!r&&i.createElement("div",{className:"mx_PinnedMessageBanner_title"},(0,l._t)("room|pinned_message_banner|title",{index:a+1,length:o},{bold:e=>i.createElement("span",{className:"mx_PinnedMessageBanner_title_counter"},e)})),i.createElement(vi,{mxEvent:d,className:"mx_PinnedMessageBanner_message"}),m&&i.createElement("div",{className:"mx_PinnedMessageBanner_redactedMessage"},i.createElement(jg.A,{mxEvent:d,maxImageHeight:20,permalinkCreator:t,replacingEventId:d.replacingEventId()})))),!r&&i.createElement(Yf,{room:e}))}const Jf=3;function Gf({count:e,currentIndex:t}){const n=Math.min(e,Jf),s=t%n,o=Math.ceil(e/n),r=t>=(o-1)*Jf,a=n-(o*n-e);return i.createElement("div",{className:"mx_PinnedMessageBanner_Indicators"},Array.from({length:n}).map(((e,t)=>i.createElement($f,{key:t,active:t===s,hidden:r&&a<=t}))))}function $f({active:e,hidden:t}){return i.createElement("div",{className:dt()("mx_PinnedMessageBanner_Indicator",{"mx_PinnedMessageBanner_Indicator--active":e,"mx_PinnedMessageBanner_Indicator--hidden":t})})}function qf(e){return _l.A.instance.isOpenForRoom(e)?_l.A.instance.currentCard.phase:null}function Yf({room:e}){const[t,n]=(0,i.useState)(qf(e.roomId));(0,ci.ml)(_l.A.instance,_r.H,(()=>n(qf(e.roomId))));const s=t===fl.n.PinnedMessages;return i.createElement(mp.$,{className:"mx_PinnedMessageBanner_actions",kind:"tertiary",onClick:()=>{s?Mn.A.trackInteraction("PinnedMessageBannerCloseListButton"):Mn.A.trackInteraction("PinnedMessageBannerViewAllButton"),_l.A.instance.showOrHidePhase(fl.n.PinnedMessages)}},s?(0,l._t)("room|pinned_message_banner|button_close_list"):(0,l._t)("room|pinned_message_banner|button_view_all"))}const Qf=["upgradeRecommendation"],Xf=["upgradeRecommendation"];function Zf(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function eE(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Zf(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Zf(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let tE=function(e){};const nE="sandbox"in document.createElement("iframe");function iE(e){const t=(0,i.useContext)(jt.Ay).room,n=e.localRoom.currentState.getStateEvents(o.EventType.RoomEncryption)[0];let s;n&&(s=i.createElement(wf.A,{mxEvent:n}));const r=()=>{t.state=ou.cd.NEW,S.A.dispatch({action:"local_room_event",roomId:t.roomId})};let a=null,c=null;if(t.isError){const e=i.createElement(ie.A,{onClick:r,className:"mx_RoomStatusBar_unsentRetry"},(0,l._t)("action|retry"));a=i.createElement(Sf.E,{title:(0,l._t)("room|status_bar|some_messages_not_sent"),notificationState:qt.d.RED_EXCLAMATION,buttons:e})}else c=i.createElement(ug,{room:e.localRoom,resizeNotifier:e.resizeNotifier,permalinkCreator:e.permalinkCreator});return i.createElement("div",{className:"mx_RoomView mx_RoomView--local"},i.createElement(Hm.A,null,i.createElement(W_,{room:t}),i.createElement("main",{className:"mx_RoomView_body",ref:e.roomView},i.createElement(fg,{parent:e.roomView.current,onFileDrop:e.onFileDrop}),i.createElement("div",{className:"mx_RoomView_timeline"},i.createElement(jm.A,{className:"mx_RoomView_messagePanel",resizeNotifier:e.resizeNotifier},s,i.createElement(au,null))),a,c)))}function sE(e){const t=(0,l._t)("room|creating_room_text",{names:e.names});return i.createElement("div",{className:"mx_RoomView mx_RoomView--local"},i.createElement(Hm.A,null,i.createElement(W_,{room:e.localRoom}),i.createElement("div",{className:"mx_RoomView_body"},i.createElement(Af,{text:t}))))}class oE extends i.Component{constructor(e,t){var n;if(super(e,t),(0,v.A)(this,"askToJoinEnabled",void 0),(0,v.A)(this,"dispatcherRef",void 0),(0,v.A)(this,"settingWatchers",[]),(0,v.A)(this,"unmounted",!1),(0,v.A)(this,"permalinkCreators",{}),(0,v.A)(this,"roomView",(0,i.createRef)()),(0,v.A)(this,"searchResultsPanel",(0,i.createRef)()),(0,v.A)(this,"messagePanel",null),(0,v.A)(this,"roomViewBody",(0,i.createRef)()),(0,v.A)(this,"onIsResizing",(e=>{this.setState({resizing:e})})),(0,v.A)(this,"onWidgetStoreUpdate",(()=>{this.state.room&&(this.checkWidgets(this.state.room),this.doMaybeRemoveOwnJitsiWidget())})),(0,v.A)(this,"onWidgetEchoStoreUpdate",(()=>{this.state.room&&this.checkWidgets(this.state.room)})),(0,v.A)(this,"onWidgetLayoutChange",(()=>{this.state.room&&(S.A.dispatch({action:"appsDrawer",show:!0}),this.context.widgetLayoutStore.hasMaximisedWidget(this.state.room)&&this.context.rightPanelStore.setCard({phase:fl.n.Timeline}),this.checkWidgets(this.state.room))})),(0,v.A)(this,"checkWidgets",(e=>{this.setState({hasPinnedWidgets:this.context.widgetLayoutStore.hasPinnedWidgets(e),mainSplitContentType:this.getMainSplitContentType(e),showApps:this.shouldShowApps(e)})})),(0,v.A)(this,"getMainSplitContentType",(e=>this.context.roomViewStore.isViewingCall()||(0,Vu.j)(e)?jt.DZ.Call:this.context.widgetLayoutStore.hasMaximisedWidget(e)?jt.DZ.MaximisedWidget:jt.DZ.Timeline)),(0,v.A)(this,"onRoomViewStoreUpdate",(async e=>{var t,n,i,o,r,a,l;if(this.unmounted)return;const c=null!==(t=this.context.roomViewStore.getRoomLoadError())&&void 0!==t?t:void 0;if(!e&&!c&&this.state.roomId!==this.context.roomViewStore.getRoomId())return;const d=null!==(n=this.context.roomViewStore.getRoomId())&&void 0!==n?n:null,m=null!==(i=null===(o=this.context.client)||void 0===o?void 0:o.getRoom(null!=d?d:void 0))&&void 0!==i?i:void 0,u={roomId:null!=d?d:void 0,roomAlias:null!==(r=this.context.roomViewStore.getRoomAlias())&&void 0!==r?r:void 0,roomLoading:this.context.roomViewStore.isRoomLoading(),roomLoadError:c,joining:this.context.roomViewStore.isJoining(),replyToEvent:null!==(a=this.context.roomViewStore.getQuotingEvent())&&void 0!==a?a:void 0,shouldPeek:this.state.matrixClientIsReady&&this.context.roomViewStore.shouldPeek(),showReadReceipts:M.A.getValue("showReadReceipts",d),showRedactions:M.A.getValue("showRedactions",d),showJoinLeaves:M.A.getValue("showJoinLeaves",d),showAvatarChanges:M.A.getValue("showAvatarChanges",d),showDisplaynameChanges:M.A.getValue("showDisplaynameChanges",d),wasContextSwitch:this.context.roomViewStore.getWasContextSwitch(),mainSplitContentType:m?this.getMainSplitContentType(m):void 0,initialEventId:void 0,showRightPanel:!!d&&this.context.rightPanelStore.isOpenForRoom(d),activeCall:d?w_.e.instance.getActiveCall(d):null,promptAskToJoin:this.context.roomViewStore.promptAskToJoin(),viewRoomOpts:this.context.roomViewStore.getViewRoomOpts()};var h;this.state.mainSplitContentType!==jt.DZ.Timeline&&u.mainSplitContentType===jt.DZ.Timeline&&this.context.rightPanelStore.isOpen&&this.context.rightPanelStore.currentCard.phase===fl.n.Timeline&&this.context.rightPanelStore.roomPhaseHistory.some((e=>e.phase===fl.n.Timeline))&&(this.context.rightPanelStore.setCard({phase:fl.n.RoomSummary}),this.context.rightPanelStore.togglePanel(null!==(h=this.state.roomId)&&void 0!==h?h:null),u.showRightPanel=!1);const p=null!==(l=this.context.roomViewStore.getInitialEventId())&&void 0!==l?l:this.state.initialEventId;if(p){var g,v;let e=null==m?void 0:m.findEventById(p);var _;if(!e&&this.context.client&&d)e=null!==(_=await(0,Rt.$I)(this.context.client,d,p))&&void 0!==_?_:void 0;u.initialEventPixelOffset=void 0;const t=null===(g=e)||void 0===g?void 0:g.getThread();null==t||!t.rootEvent||null!==(v=e)&&void 0!==v&&v.isThreadRoot?(u.initialEventId=p,u.isInitialEventHighlighted=this.context.roomViewStore.isInitialEventHighlighted(),u.initialEventScrollIntoView=this.context.roomViewStore.initialEventScrollIntoView()):S.A.dispatch({action:W.r.ShowThread,rootEvent:t.rootEvent,initialEvent:e,highlighted:this.context.roomViewStore.isInitialEventHighlighted(),scroll_into_view:this.context.roomViewStore.initialEventScrollIntoView()})}var f,E;(this.settingWatchers=this.settingWatchers.concat([M.A.watchSetting("showReadReceipts",d,((...[,,,e])=>this.setState({showReadReceipts:e}))),M.A.watchSetting("showRedactions",d,((...[,,,e])=>this.setState({showRedactions:e}))),M.A.watchSetting("showJoinLeaves",d,((...[,,,e])=>this.setState({showJoinLeaves:e}))),M.A.watchSetting("showAvatarChanges",d,((...[,,,e])=>this.setState({showAvatarChanges:e}))),M.A.watchSetting("showDisplaynameChanges",d,((...[,,,e])=>this.setState({showDisplaynameChanges:e})))]),e||!this.state.shouldPeek||u.shouldPeek)||(null===(f=this.context.client)||void 0===f||f.stopPeeking());if(s.v.log("RVS update:",u.roomId,u.roomAlias,"loading?",u.roomLoading,"joining?",u.joining,"initial?",e,"shouldPeek?",u.shouldPeek),e&&(u.room=this.context.client.getRoom(u.roomId)||void 0,u.room&&(u.showApps=this.shouldShowApps(u.room),this.onRoomLoaded(u.room))),void 0===this.state.roomId&&void 0!==u.roomId&&!u.initialEventId&&u.roomId){const e=av.getScrollState(u.roomId);e&&(u.initialEventId=e.focussedEvent,u.initialEventPixelOffset=e.pixelOffset)}this.state.timelineRenderingType===jt.Ae.Search&&this.state.initialEventId!==u.initialEventId&&(u.timelineRenderingType=jt.Ae.Room,null===(E=this.state.search)||void 0===E||null===(E=E.abortController)||void 0===E||E.abort(),u.search=void 0);this.setState(u),e&&this.setupRoom(u.room,u.roomId,!!u.joining,!!u.shouldPeek)})),(0,v.A)(this,"onConnectedCalls",(()=>{if(void 0===this.state.roomId)return;const e=w_.e.instance.getActiveCall(this.state.roomId);null===e&&S.A.dispatch({action:W.r.ViewRoom,room_id:this.state.roomId,view_call:!1,metricsTrigger:void 0},!0),this.setState({activeCall:e})})),(0,v.A)(this,"getRoomId",(()=>{var e,t;return null!==(e=null===(t=this.state.room)||void 0===t?void 0:t.roomId)&&void 0!==e?e:this.state.roomId})),(0,v.A)(this,"onRightPanelStoreUpdate",(()=>{const{roomId:e}=this.state;this.setState({showRightPanel:!!e&&this.context.rightPanelStore.isOpenForRoom(e)})})),(0,v.A)(this,"onPageUnload",(e=>$d.Ay.sharedInstance().getCurrentUploads().length>0?e.returnValue=(0,l._t)("quit_warning|file_upload_in_progress"):this.getCallForRoom()&&"ended"!==this.state.callState?e.returnValue=(0,l._t)("quit_warning|call_in_progress"):void 0)),(0,v.A)(this,"onReactKeyDown",(e=>{var t;let n=!1;switch((0,_s.zM)().getRoomAction(e)){case Pn.bY.DismissReadMarker:null===(t=this.messagePanel)||void 0===t||t.forgetReadMarker(),this.jumpToLiveTimeline(),n=!0;break;case Pn.bY.JumpToOldestUnread:this.jumpToReadMarker(),n=!0;break;case Pn.bY.UploadFile:S.A.dispatch({action:"upload_file",context:jt.Ae.Room},!0),n=!0}n&&(e.stopPropagation(),e.preventDefault())})),(0,v.A)(this,"onCallState",(e=>{if(!e)return;const t=this.getCallForRoom();this.setState({callState:null==t?void 0:t.state})})),(0,v.A)(this,"onAction",(async e=>{var t;if(this.context.client)switch(e.action){case"message_sent":this.checkDesktopNotifications();break;case"post_sticker_message":this.injectSticker(e.data.content.url,e.data.content.info,e.data.description||e.data.name,e.data.threadId);break;case"picture_snapshot":{const t=this.getRoomId();(0,xf.E)(t)&&$d.Ay.sharedInstance().sendContentListToRoom([e.file],t,void 0,this.context.client);break}case"notifier_enabled":case W.r.UploadStarted:case W.r.UploadFinished:case W.r.UploadCanceled:this.forceUpdate();break;case"appsDrawer":this.setState({showApps:e.show});break;case"reply_to_event":!this.unmounted&&this.state.search&&(null===(t=e.event)||void 0===t?void 0:t.getRoomId())===this.state.roomId&&e.context===jt.Ae.Search&&this.onCancelSearchClick();break;case"MatrixActions.sync":var n;if(!this.state.matrixClientIsReady)this.setState({matrixClientIsReady:!(null===(n=this.context.client)||void 0===n||!n.isInitialSyncComplete())},(()=>{this.onRoomViewStoreUpdate(!0)}));break;case"local_room_event":this.onLocalRoomEvent(e.roomId);break;case W.r.EditEvent:{if(e.timelineRenderingType!==this.state.timelineRenderingType)return;if(e.event&&e.event.getRoomId()!==this.state.roomId)return void S.A.dispatch({action:W.r.ViewRoom,room_id:e.event.getRoomId(),metricsTrigger:void 0,deferred_action:e});const t=e.event?new hg(e.event):void 0;this.setState({editState:t,search:void 0},(()=>{var t;e.event&&(null===(t=this.messagePanel)||void 0===t||t.scrollToEventIfNeeded(e.event.getId()))}));break}case W.r.ComposerInsert:{if(e.composerType)break;let t=e.timelineRenderingType;if(t===jt.Ae.Thread)break;this.state.timelineRenderingType===jt.Ae.Search&&e.timelineRenderingType===jt.Ae.Search&&(await this.onCancelSearchClick(),t=jt.Ae.Room),S.A.dispatch(eE(eE({},e),{},{timelineRenderingType:t,composerType:this.state.editState?bg.D.Edit:bg.D.Send}));break}case W.r.FocusAComposer:S.A.dispatch(eE(eE({},e),{},{action:this.state.editState?W.r.FocusEditMessageComposer:W.r.FocusSendMessageComposer}));break;case"scroll_to_bottom":var i;if(e.timelineRenderingType===jt.Ae.Room)null===(i=this.messagePanel)||void 0===i||i.jumpToLiveTimeline();break;case W.r.ViewUser:e.member?e.push?_l.A.instance.pushCard({phase:fl.n.RoomMemberInfo,state:{member:e.member}}):_l.A.instance.setCards([{phase:fl.n.RoomSummary},{phase:fl.n.RoomMemberList},{phase:fl.n.RoomMemberInfo,state:{member:e.member}}]):_l.A.instance.showOrHidePhase(fl.n.RoomMemberList);break;case W.r.View3pidInvite:((e,t)=>{e.event?t.pushCard({phase:fl.n.Room3pidMemberInfo,state:{memberInfoEvent:e.event}}):t.showOrHidePhase(fl.n.RoomMemberList)})(e,_l.A.instance)}})),(0,v.A)(this,"onRoomTimeline",((e,t,n,i,s)=>{var o;this.unmounted||t&&t.roomId===(null===(o=this.state.room)||void 0===o?void 0:o.roomId)&&s.timeline.getTimelineSet()===t.getUnfilteredTimelineSet()&&("org.matrix.room.preview_urls"===e.getType()&&this.updatePreviewUrlVisibility(t),"m.room.encryption"===e.getType()&&(this.updateE2EStatus(t),this.updatePreviewUrlVisibility(t)),!n&&null!=s&&s.liveEvent&&(this.state.joining||(e.isBeingDecrypted()||e.isDecryptionFailure()||this.handleEffects(e),this.context.client&&e.getSender()!==this.context.client.getSafeUserId()&&(!this.state.search&&this.state.atEndOfLiveTimeline||(0,Jd.A)(e,this.state)||this.setState((e=>({numUnreadMessages:e.numUnreadMessages+1})))))))})),(0,v.A)(this,"onEventDecrypted",(e=>{this.state.room&&this.state.matrixClientIsReady&&e.getRoomId()===this.state.room.roomId&&(e.isDecryptionFailure()||this.handleEffects(e))})),(0,v.A)(this,"handleEffects",(e=>{if(!this.state.room)return;this.context.roomNotificationStateStore.getRoomState(this.state.room).isUnread&&Ah.y.forEach((t=>{((0,Ch._)(e.getContent(),t.emojis)||e.getContent().msgtype===t.msgType)&&(e.isRelation(o.THREAD_RELATION_TYPE.name)||S.A.dispatch({action:`effects.${t.command}`,event:e}))}))})),(0,v.A)(this,"onRoomName",(e=>{this.state.room&&e.roomId==this.state.room.roomId&&this.forceUpdate()})),(0,v.A)(this,"onKeyBackupStatus",(()=>{this.forceUpdate()})),(0,v.A)(this,"canResetTimeline",(()=>!this.messagePanel||this.messagePanel.canResetTimeline())),(0,v.A)(this,"loadVirtualRoom",(async e=>{const t=(null==e?void 0:e.roomId)&&await jf.A.sharedInstance().getVirtualRoomForRoom(null==e?void 0:e.roomId);this.setState({virtualRoom:t||void 0})})),(0,v.A)(this,"onRoomLoaded",(e=>{this.unmounted||(this.context.widgetLayoutStore.on(Jh.aK.emissionForRoom(e),this.onWidgetLayoutChange),this.calculatePeekRules(e),this.updatePreviewUrlVisibility(e),this.loadMembersIfJoined(e),this.calculateRecommendedVersion(e),this.updateE2EStatus(e),this.updatePermissions(e),this.checkWidgets(e),this.loadVirtualRoom(e),this.getMainSplitContentType(e)!==jt.DZ.Timeline&&this.context.roomNotificationStateStore.getRoomState(e).isUnread&&this.context.rightPanelStore.setCard({phase:fl.n.Timeline},!0,e.roomId),this.setState({tombstone:this.getRoomTombstone(e),liveTimeline:e.getLiveTimeline()}),S.A.dispatch({action:W.r.RoomLoaded}))})),(0,v.A)(this,"onRoomTimelineReset",(e=>{var t;e&&e.roomId===(null===(t=this.state.room)||void 0===t?void 0:t.roomId)&&e.getLiveTimeline()!==this.state.liveTimeline&&(s.v.log(`Live timeline of ${e.roomId} was reset`),this.setState({liveTimeline:e.getLiveTimeline()}))})),(0,v.A)(this,"onRoom",(e=>{e&&e.roomId===this.state.roomId&&(this.state.room&&this.context.widgetLayoutStore.off(Jh.aK.emissionForRoom(this.state.room),this.onWidgetLayoutChange),this.setState({room:e},(()=>{this.onRoomLoaded(e)})))})),(0,v.A)(this,"onUserVerificationChanged",(e=>{const t=this.state.room;t&&t.currentState.getMember(e)&&this.updateE2EStatus(t)})),(0,v.A)(this,"onCrossSigningKeysChanged",(()=>{const e=this.state.room;e&&this.updateE2EStatus(e)})),(0,v.A)(this,"onUrlPreviewsEnabledChange",(()=>{this.state.room&&this.updatePreviewUrlVisibility(this.state.room)})),(0,v.A)(this,"onRoomStateEvents",((e,t)=>{if(this.state.room&&this.state.room.roomId===t.roomId)if(e.getType()===o.EventType.RoomTombstone)this.setState({tombstone:this.getRoomTombstone()});else this.updatePermissions(this.state.room)})),(0,v.A)(this,"onRoomStateUpdate",(e=>{var t;e.roomId===(null===(t=this.state.room)||void 0===t?void 0:t.roomId)&&this.updateRoomMembers()})),(0,v.A)(this,"onMyMembership",(e=>{e.roomId===this.state.roomId&&(this.forceUpdate(),this.loadMembersIfJoined(e),this.updatePermissions(e))})),(0,v.A)(this,"updateRoomMembers",(0,Vn.throttle)((()=>{this.state.room&&(this.updateDMState(),this.updateE2EStatus(this.state.room))}),500,{leading:!0,trailing:!0})),(0,v.A)(this,"onInviteClick",(()=>{S.A.dispatch({action:"view_invite",roomId:this.getRoomId()})})),(0,v.A)(this,"onJoinButtonClicked",(()=>{var e;null!==(e=this.context.client)&&void 0!==e&&e.isGuest()?(S.A.dispatch({action:W.r.DoAfterSyncPrepared,deferred_action:{action:W.r.ViewRoom,room_id:this.getRoomId(),metricsTrigger:void 0}}),S.A.dispatch({action:"require_registration"})):Promise.resolve().then((()=>{var e;const t=null===(e=this.props.threepidInvite)||void 0===e?void 0:e.signUrl,n=this.getRoomId();var i;(0,xf.E)(n)&&S.A.dispatch({action:W.r.JoinRoom,roomId:n,opts:{inviteSignUrl:t},metricsTrigger:(null===(i=this.state.room)||void 0===i?void 0:i.getMyMembership())===ut.O.Invite?"Invite":"RoomPreview",canAskToJoin:this.state.canAskToJoin});return Promise.resolve()}))})),(0,v.A)(this,"onMessageListScroll",(()=>{var e;null!==(e=this.messagePanel)&&void 0!==e&&e.isAtEndOfLiveTimeline()?this.setState({numUnreadMessages:0,atEndOfLiveTimeline:!0}):this.setState({atEndOfLiveTimeline:!1}),this.updateTopUnreadMessagesBar()})),(0,v.A)(this,"resetJumpToEvent",(e=>{this.state.initialEventId&&this.state.initialEventScrollIntoView&&this.state.initialEventId===e&&(tE("Removing scroll_into_view flag from initial event"),S.A.dispatch({action:W.r.ViewRoom,room_id:this.getRoomId(),event_id:this.state.initialEventId,highlighted:this.state.isInitialEventHighlighted,scroll_into_view:!1,replyingToEvent:this.state.replyToEvent,metricsTrigger:void 0}))})),(0,v.A)(this,"onSearch",((e,t=Uf.Room)=>{const n=t===Uf.Room?this.getRoomId():void 0;tE("sending search request");const i=new AbortController,s=function(e,t,n,i){return null===E.A.get()?Rf(e,t,n,i):Of(e,t,n,i)}(this.context.client,e,n,i.signal);this.setState({timelineRenderingType:jt.Ae.Search,search:{searchId:(new Date).getTime(),roomId:n,term:e,scope:t,promise:s,abortController:i}})})),(0,v.A)(this,"onSearchScopeChange",(e=>{var t,n;this.onSearch(null!==(t=null===(n=this.state.search)||void 0===n?void 0:n.term)&&void 0!==t?t:"",e)})),(0,v.A)(this,"onSearchUpdate",((e,t)=>{this.setState({search:eE(eE({},this.state.search),{},{count:null==t?void 0:t.count,inProgress:e})})})),(0,v.A)(this,"onForgetClick",(()=>{S.A.dispatch({action:"forget_room",room_id:this.getRoomId()})})),(0,v.A)(this,"onRejectButtonClicked",(()=>{var e;const t=this.getRoomId();t&&(this.setState({rejecting:!0}),null===(e=this.context.client)||void 0===e||e.leave(t).then((()=>{S.A.dispatch({action:W.r.ViewHomePage}),this.setState({rejecting:!1})}),(e=>{s.v.error(`Failed to reject invite: ${e}`);const t=e.message?e.message:JSON.stringify(e);k.Ay.createDialog(nt.A,{title:(0,l._t)("room|failed_reject_invite"),description:t}),this.setState({rejecting:!1})})))})),(0,v.A)(this,"onRejectAndIgnoreClick",(async()=>{this.setState({rejecting:!0});try{const e=this.state.room.getMember(this.context.client.getSafeUserId()).events.member,t=this.context.client.getIgnoredUsers();t.push(e.getSender()),await this.context.client.setIgnoredUsers(t),await this.context.client.leave(this.state.roomId),S.A.dispatch({action:W.r.ViewHomePage}),this.setState({rejecting:!1})}catch(e){s.v.error(`Failed to reject invite: ${e}`);const t=e instanceof Error?e.message:JSON.stringify(e);k.Ay.createDialog(nt.A,{title:(0,l._t)("room|failed_reject_invite"),description:t}),this.setState({rejecting:!1})}})),(0,v.A)(this,"onRejectThreepidInviteButtonClicked",(()=>{S.A.fire(W.r.ViewRoomDirectory)})),(0,v.A)(this,"onSearchChange",(0,Vn.debounce)((e=>{const t=e.target.value;this.onSearch(t)}),300)),(0,v.A)(this,"onCancelSearchClick",(()=>new Promise((e=>{this.setState({timelineRenderingType:jt.Ae.Room,search:void 0},e)})))),(0,v.A)(this,"jumpToLiveTimeline",(()=>{var e;this.state.initialEventId&&this.state.isInitialEventHighlighted?S.A.dispatch({action:W.r.ViewRoom,room_id:this.getRoomId(),metricsTrigger:void 0}):(null===(e=this.messagePanel)||void 0===e||e.jumpToLiveTimeline(),S.A.fire(W.r.FocusSendMessageComposer))})),(0,v.A)(this,"jumpToReadMarker",(()=>{var e;null===(e=this.messagePanel)||void 0===e||e.jumpToReadMarker()})),(0,v.A)(this,"forgetReadMarker",(e=>{var t;e.stopPropagation(),null===(t=this.messagePanel)||void 0===t||t.forgetReadMarker()})),(0,v.A)(this,"updateTopUnreadMessagesBar",(()=>{if(!this.messagePanel)return;const e=this.messagePanel.canJumpToReadMarker();this.state.showTopUnreadMessagesBar!=e&&this.setState({showTopUnreadMessagesBar:e})})),(0,v.A)(this,"onStatusBarVisible",(()=>{this.unmounted||this.state.statusBarVisible||this.setState({statusBarVisible:!0})})),(0,v.A)(this,"onStatusBarHidden",(()=>{!this.unmounted&&this.state.statusBarVisible&&this.setState({statusBarVisible:!1})})),(0,v.A)(this,"handleScrollKey",(e=>{var t;let n;this.searchResultsPanel.current?n=this.searchResultsPanel.current:this.messagePanel&&(n=this.messagePanel),null===(t=n)||void 0===t||t.handleScrollKey(e)})),(0,v.A)(this,"gatherTimelinePanelRef",(e=>{this.messagePanel=e})),(0,v.A)(this,"onHiddenHighlightsClick",(()=>{const e=this.getOldRoom();e&&S.A.dispatch({action:W.r.ViewRoom,room_id:e.roomId,metricsTrigger:"Predecessor"})})),(0,v.A)(this,"onFileDrop",(async e=>{const t=this.getRoomId();t&&this.context.client&&await $d.Ay.sharedInstance().sendContentListToRoom(Array.from(e.files),t,void 0,this.context.client,jt.Ae.Room)})),(0,v.A)(this,"onMeasurement",(e=>{this.setState({narrow:e})})),(0,v.A)(this,"onSubmitAskToJoin",(e=>{const t=this.getRoomId();(0,xf.E)(t)&&S.A.dispatch({action:W.r.SubmitAskToJoin,roomId:t,opts:{reason:e}})})),(0,v.A)(this,"onCancelAskToJoin",(()=>{const e=this.getRoomId();(0,xf.E)(e)&&S.A.dispatch({action:W.r.CancelAskToJoin,roomId:e})})),this.askToJoinEnabled=M.A.getValue("feature_ask_to_join"),!t.client)throw new Error("Unable to create RoomView without MatrixClient");const r=t.client.hasLazyLoadMembersEnabled();this.state={roomId:void 0,roomLoading:!0,peekLoading:!1,shouldPeek:!0,membersLoaded:!r,numUnreadMessages:0,callState:void 0,activeCall:null,canPeek:!1,canSelfRedact:!1,showApps:!1,isPeeking:!1,showRightPanel:!1,joining:!1,showTopUnreadMessagesBar:!1,statusBarVisible:!1,canReact:!1,canSendMessages:!1,resizing:!1,layout:M.A.getValue("layout"),lowBandwidth:M.A.getValue("lowBandwidth"),alwaysShowTimestamps:M.A.getValue("alwaysShowTimestamps"),showTwelveHourTimestamps:M.A.getValue("showTwelveHourTimestamps"),userTimezone:Gd.dB(),readMarkerInViewThresholdMs:M.A.getValue("readMarkerInViewThresholdMs"),readMarkerOutOfViewThresholdMs:M.A.getValue("readMarkerOutOfViewThresholdMs"),showHiddenEvents:M.A.getValue("showHiddenEventsInTimeline"),showReadReceipts:!0,showRedactions:!0,showJoinLeaves:!0,showAvatarChanges:!0,showDisplaynameChanges:!0,matrixClientIsReady:null===(n=t.client)||void 0===n?void 0:n.isInitialSyncComplete(),mainSplitContentType:jt.DZ.Timeline,timelineRenderingType:jt.Ae.Room,liveTimeline:void 0,narrow:!1,msc3946ProcessDynamicPredecessor:M.A.getValue("feature_dynamic_room_predecessors"),canAskToJoin:this.askToJoinEnabled,promptAskToJoin:!1,viewRoomOpts:{buttons:[]}}}doMaybeRemoveOwnJitsiWidget(){if(!this.state.roomId||!this.state.room||!this.context.client)return;const e=this.context.widgetStore.getApps(this.state.roomId).filter((e=>e.eventId&&gh.x.JITSI.matches(e.type)));if(e.length<2)return;const t=this.context.client.getSafeUserId(),n=e.find((e=>e.creatorUserId===t));if(!n)return;const i=this.state.room.findEventById(n.eventId);if(!i)return;const s=i.getTs();if(!s)return;const o=e.reduce(((e,t)=>{var i;if(t.eventId===n.eventId)return e;const s=(null===(i=this.state.room.findEventById(t.eventId))||void 0===i?void 0:i.getTs())||0;return Math.max(e,s)}),0);o&&s>o&&s-o<3e4&&th.A.setRoomWidget(this.context.client,this.state.roomId,n.id)}getPermalinkCreatorForRoom(){const{room:e,roomId:t}=this.state;if(void 0===e){if((0,xf.E)(t)){const e=new yt.pE(null,t);return this.permalinkCreators[t]=e,e}throw new Error("Cannot get a permalink creator without a roomId")}return this.permalinkCreators[e.roomId]||(this.permalinkCreators[e.roomId]=new yt.pE(e),this.state.room&&e.roomId===this.state.room.roomId?this.permalinkCreators[e.roomId].start():this.permalinkCreators[e.roomId].load()),this.permalinkCreators[e.roomId]}stopAllPermalinkCreators(){if(this.permalinkCreators)for(const e of Object.keys(this.permalinkCreators))this.permalinkCreators[e].stop()}setupRoom(e,t,n,i){var r;if(!n&&t)if(!e&&i)s.v.info(`Attempting to peek into room ${t}`),this.setState({peekLoading:!0,isPeeking:!0}),null===(r=this.context.client)||void 0===r||r.peekInRoom(t).then((e=>{this.unmounted||(this.setState({room:e,peekLoading:!1,canAskToJoin:this.askToJoinEnabled&&e.getJoinRule()===o.JoinRule.Knock}),this.onRoomLoaded(e))})).catch((e=>{if(!this.unmounted){if(this.setState({isPeeking:!1}),"M_GUEST_ACCESS_FORBIDDEN"!==e.errcode&&"M_FORBIDDEN"!==e.errcode)throw e;this.setState({peekLoading:!1})}}));else if(e){var a;null===(a=this.context.client)||void 0===a||a.stopPeeking(),this.setState({isPeeking:!1,canAskToJoin:this.askToJoinEnabled&&e.getJoinRule()===o.JoinRule.Knock})}}shouldShowApps(e){if(!nE||!e)return!1;const t=e.roomId+"_hide_widget_drawer",n=localStorage.getItem(t),i=!n||"false"===n,s=this.context.widgetLayoutStore.getContainerWidgets(e,Jh.mc.Top);return i&&s.length>0}componentDidMount(){this.unmounted=!1,this.dispatcherRef=S.A.register(this.onAction),this.context.client&&(this.context.client.on(o.ClientEvent.Room,this.onRoom),this.context.client.on(o.RoomEvent.Timeline,this.onRoomTimeline),this.context.client.on(o.RoomEvent.TimelineReset,this.onRoomTimelineReset),this.context.client.on(o.RoomEvent.Name,this.onRoomName),this.context.client.on(o.RoomStateEvent.Events,this.onRoomStateEvents),this.context.client.on(o.RoomStateEvent.Update,this.onRoomStateUpdate),this.context.client.on(o.RoomEvent.MyMembership,this.onMyMembership),this.context.client.on(V.CryptoEvent.KeyBackupStatus,this.onKeyBackupStatus),this.context.client.on(V.CryptoEvent.UserTrustStatusChanged,this.onUserVerificationChanged),this.context.client.on(V.CryptoEvent.KeysChanged,this.onCrossSigningKeysChanged),this.context.client.on(o.MatrixEventEvent.Decrypted,this.onEventDecrypted)),this.context.roomViewStore.on(_r.H,this.onRoomViewStoreUpdate),this.context.rightPanelStore.on(_r.H,this.onRightPanelStoreUpdate),lv.A.on(_r.H,this.onWidgetEchoStoreUpdate),this.context.widgetStore.on(_r.H,this.onWidgetStoreUpdate),w_.e.instance.on(w_.s.ConnectedCalls,this.onConnectedCalls),this.props.resizeNotifier.on("isResizing",this.onIsResizing),this.settingWatchers=[M.A.watchSetting("layout",null,((...[,,,e])=>this.setState({layout:e}))),M.A.watchSetting("lowBandwidth",null,((...[,,,e])=>this.setState({lowBandwidth:e}))),M.A.watchSetting("alwaysShowTimestamps",null,((...[,,,e])=>this.setState({alwaysShowTimestamps:e}))),M.A.watchSetting("showTwelveHourTimestamps",null,((...[,,,e])=>this.setState({showTwelveHourTimestamps:e}))),M.A.watchSetting(Gd.cd,null,((...[,,,e])=>this.setState({userTimezone:e}))),M.A.watchSetting("readMarkerInViewThresholdMs",null,((...[,,,e])=>this.setState({readMarkerInViewThresholdMs:e}))),M.A.watchSetting("readMarkerOutOfViewThresholdMs",null,((...[,,,e])=>this.setState({readMarkerOutOfViewThresholdMs:e}))),M.A.watchSetting("showHiddenEventsInTimeline",null,((...[,,,e])=>this.setState({showHiddenEvents:e}))),M.A.watchSetting("urlPreviewsEnabled",null,this.onUrlPreviewsEnabledChange),M.A.watchSetting("urlPreviewsEnabled_e2ee",null,this.onUrlPreviewsEnabledChange),M.A.watchSetting("feature_dynamic_room_predecessors",null,((...[,,,e])=>this.setState({msc3946ProcessDynamicPredecessor:e})))],this.onRoomViewStoreUpdate(!0);const e=this.getCallForRoom(),t=null==e?void 0:e.state;this.setState({callState:t}),this.context.legacyCallHandler.on(et.uv.CallState,this.onCallState),window.addEventListener("beforeunload",this.onPageUnload)}shouldComponentUpdate(e,t){const n=(0,$t.No)(this.props,e),i=this.state,{upgradeRecommendation:s}=i,o=(0,g.A)(i,Qf),{upgradeRecommendation:r}=t,a=(0,g.A)(t,Xf),l=(null==r?void 0:r.needsUpgrade)!==(null==s?void 0:s.needsUpgrade)||(0,$t.No)(o,a);return n||l}componentDidUpdate(){this.messagePanel&&void 0===this.state.atEndOfLiveTimeline&&this.setState({atEndOfLiveTimeline:this.messagePanel.isAtEndOfLiveTimeline()})}componentWillUnmount(){var e,t;(this.unmounted=!0,this.context.legacyCallHandler.removeListener(et.uv.CallState,this.onCallState),this.state.roomId&&av.setScrollState(this.state.roomId,this.getScrollState()),this.state.shouldPeek)&&(null===(e=this.context.client)||void 0===e||e.stopPeeking());this.stopAllPermalinkCreators(),S.A.unregister(this.dispatcherRef),this.context.client&&(this.context.client.removeListener(o.ClientEvent.Room,this.onRoom),this.context.client.removeListener(o.RoomEvent.Timeline,this.onRoomTimeline),this.context.client.removeListener(o.RoomEvent.TimelineReset,this.onRoomTimelineReset),this.context.client.removeListener(o.RoomEvent.Name,this.onRoomName),this.context.client.removeListener(o.RoomStateEvent.Events,this.onRoomStateEvents),this.context.client.removeListener(o.RoomEvent.MyMembership,this.onMyMembership),this.context.client.removeListener(o.RoomStateEvent.Update,this.onRoomStateUpdate),this.context.client.removeListener(V.CryptoEvent.KeyBackupStatus,this.onKeyBackupStatus),this.context.client.removeListener(V.CryptoEvent.UserTrustStatusChanged,this.onUserVerificationChanged),this.context.client.removeListener(V.CryptoEvent.KeysChanged,this.onCrossSigningKeysChanged),this.context.client.removeListener(o.MatrixEventEvent.Decrypted,this.onEventDecrypted)),window.removeEventListener("beforeunload",this.onPageUnload),this.context.roomViewStore.off(_r.H,this.onRoomViewStoreUpdate),this.context.rightPanelStore.off(_r.H,this.onRightPanelStoreUpdate),lv.A.removeListener(_r.H,this.onWidgetEchoStoreUpdate),this.context.widgetStore.removeListener(_r.H,this.onWidgetStoreUpdate),this.props.resizeNotifier.off("isResizing",this.onIsResizing),this.state.room&&this.context.widgetLayoutStore.off(Jh.aK.emissionForRoom(this.state.room),this.onWidgetLayoutChange),w_.e.instance.off(w_.s.ConnectedCalls,this.onConnectedCalls),this.context.legacyCallHandler.off(et.uv.CallState,this.onCallState),this.updateRoomMembers.cancel();for(const e of this.settingWatchers)M.A.unwatchSetting(e);this.viewsLocalRoom&&this.state.room&&(null===(t=this.context.client)||void 0===t||t.store.removeRoom(this.state.room.roomId))}onLocalRoomEvent(e){this.context.client&&this.state.room&&e===this.state.room.roomId&&(0,bf.Cp)(this.context.client,this.state.room)}getRoomTombstone(e=this.state.room){var t;return null!==(t=null==e?void 0:e.currentState.getStateEvents(o.EventType.RoomTombstone,""))&&void 0!==t?t:void 0}async calculateRecommendedVersion(e){const t=await e.getRecommendedVersion();this.unmounted||this.setState({upgradeRecommendation:t})}async loadMembersIfJoined(e){var t;if(null!==(t=this.context.client)&&void 0!==t&&t.hasLazyLoadMembersEnabled()&&e&&e.getMyMembership()===ut.O.Join)try{await e.loadMembersIfNeeded(),this.unmounted||this.setState({membersLoaded:!0})}catch(t){const n=`Fetching room members for ${e.roomId} failed. Room members will appear incomplete.`;s.v.error(n),s.v.error(t)}}calculatePeekRules(e){const t=e.currentState.getStateEvents(o.EventType.RoomHistoryVisibility,"");this.setState({canPeek:(null==t?void 0:t.getContent().history_visibility)===o.HistoryVisibility.WorldReadable})}updatePreviewUrlVisibility({roomId:e}){var t;const n=null!==(t=this.context.client)&&void 0!==t&&t.isRoomEncrypted(e)?"urlPreviewsEnabled_e2ee":"urlPreviewsEnabled";this.setState({showUrlPreview:M.A.getValue(n,e)})}async updateE2EStatus(e){var t,n;if(null===(t=this.context.client)||void 0===t||!t.isRoomEncrypted(e.roomId))return;let i=null!==(n=oE.e2eStatusCache.get(e.roomId))&&void 0!==n?n:bm.z.Warning;if(this.setState({e2eStatus:i}),this.context.client.getCrypto()){if(i=await(0,bm.G)(this.context.client,e),oE.e2eStatusCache.set(e.roomId,i),this.unmounted)return;this.setState({e2eStatus:i})}}updatePermissions(e){if(e&&this.context.client){const t=this.context.client.getSafeUserId(),n=e.getMyMembership()===ut.O.Join&&e.currentState.maySendEvent(o.EventType.Reaction,t),i=e.maySendMessage(),s=e.currentState.maySendEvent(o.EventType.RoomRedaction,t);this.setState({canReact:n,canSendMessages:i,canSelfRedact:s})}}checkDesktopNotifications(){if(!this.state.room)return;this.state.room.getJoinedMemberCount()+this.state.room.getInvitedMemberCount()>1&&b.default.shouldShowPrompt()&&(0,G_.P)(!0)}updateDMState(){const e=this.state.room;if((null==e?void 0:e.getMyMembership())!=ut.O.Join)return;const t=null==e?void 0:e.getDMInviter();t&&gr.FZ(e.client,e.roomId,t)}injectSticker(e,t,n,i){const s=this.getRoomId();this.context.client&&s&&(this.context.client.isGuest()?S.A.dispatch({action:"require_registration"}):$d.Ay.sharedInstance().sendStickerContentToRoom(e,s,i,t,n,this.context.client).then(void 0,(e=>{e.name})))}getScrollState(){const e=this.messagePanel;if(!e)return null;if(this.state.atEndOfLiveTimeline)return null;const t=e.getScrollState();return!t||t.stuckAtBottom?null:{focussedEvent:t.trackedScrollToken,pixelOffset:t.pixelOffset}}getCallForRoom(){return this.state.room?this.context.legacyCallHandler.getCallForRoom(this.state.room.roomId):null}getOldRoom(){var e,t;const{roomId:n}=(null===(e=this.state.room)||void 0===e?void 0:e.findPredecessor(this.state.msc3946ProcessDynamicPredecessor))||{};return(null===(t=this.context.client)||void 0===t?void 0:t.getRoom(n))||null}getHiddenHighlightCount(){const e=this.getOldRoom();return e?e.getUnreadNotificationCount(o.NotificationCountType.Highlight):0}get messagePanelClassNames(){return dt()("mx_RoomView_messagePanel",{mx_IRCLayout:this.state.layout===gt.P.IRC})}get viewsLocalRoom(){return(0,Pi.F)(this.state.room)}get permalinkCreator(){return this.getPermalinkCreatorForRoom()}renderLocalRoomCreateLoader(e){var t;if(!this.state.room||null===(t=this.context)||void 0===t||!t.client)return null;const n=this.state.room.getDefaultRoomName(this.context.client.getSafeUserId());return i.createElement(jt.Ay.Provider,{value:this.state},i.createElement(sE,{localRoom:e,names:n,resizeNotifier:this.props.resizeNotifier}))}renderLocalRoomView(e){return i.createElement(jt.Ay.Provider,{value:this.state},i.createElement(iE,{localRoom:e,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.permalinkCreator,roomView:this.roomView,onFileDrop:this.onFileDrop}))}renderWaitingForThirdPartyRoomView(e){return i.createElement(jt.Ay.Provider,{value:this.state},i.createElement(Wf,{resizeNotifier:this.props.resizeNotifier,roomView:this.roomView,inviteEvent:e}))}render(){var e,t;if(!this.context.client)return null;if(this.state.room instanceof ou.Np)return this.state.room.state===ou.cd.CREATING?this.renderLocalRoomCreateLoader(this.state.room):this.renderLocalRoomView(this.state.room);if(this.state.room){const{shouldEncrypt:e,inviteEvent:t}=ru(this.state.room);if(e)return this.renderWaitingForThirdPartyRoomView(t)}if(!this.state.room){const e=!this.state.matrixClientIsReady||this.state.roomLoading||this.state.peekLoading;if(e){const t=!this.state.matrixClientIsReady||!this.state.roomId||this.state.peekLoading;return i.createElement("div",{className:"mx_RoomView"},i.createElement(Hm.A,null,i.createElement(pv,{canPreview:!1,previewLoading:t&&!this.state.roomLoadError,error:this.state.roomLoadError,loading:e,joining:this.state.joining,oobData:this.props.oobData,roomId:this.state.roomId})))}{var n,s;let e;this.props.oobData&&(e=this.props.oobData.inviterName);const t=null===(n=this.props.threepidInvite)||void 0===n?void 0:n.toEmail,o=this.state.roomAlias;return i.createElement("div",{className:"mx_RoomView"},i.createElement(Hm.A,null,i.createElement(pv,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectThreepidInviteButtonClicked,canPreview:!1,error:this.state.roomLoadError,roomAlias:o,joining:this.state.joining,inviterName:e,invitedEmail:t,oobData:this.props.oobData,signUrl:null===(s=this.props.threepidInvite)||void 0===s?void 0:s.signUrl,roomId:this.state.roomId,promptAskToJoin:this.state.promptAskToJoin,onSubmitAskToJoin:this.onSubmitAskToJoin,onCancelAskToJoin:this.onCancelAskToJoin})))}}const r=this.state.room.getMyMembership();if((0,Vu.j)(this.state.room)&&r!==ut.O.Join)return i.createElement(Hm.A,null,i.createElement("div",{className:"mx_MainSplit"},i.createElement(Cv,{room:this.state.room,onJoinButtonClicked:this.onJoinButtonClicked,onRejectButtonClicked:this.onRejectButtonClicked})),";");if(r===ut.O.Invite&&!this.state.room.isSpaceRoom()){if(this.state.joining||this.state.rejecting)return i.createElement(Hm.A,null,i.createElement(pv,{canPreview:!1,error:this.state.roomLoadError,joining:this.state.joining,rejecting:this.state.rejecting,roomId:this.state.roomId}));{const e=this.context.client.getSafeUserId(),t=this.state.room.getMember(e),n=t?t.events.member:null;let s=(0,l._t)("room|inviter_unknown");var a,c;if(n)s=null!==(a=null===(c=n.sender)||void 0===c?void 0:c.name)&&void 0!==a?a:n.getSender();return i.createElement("div",{className:"mx_RoomView"},i.createElement(Hm.A,null,i.createElement(pv,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectButtonClicked,onRejectAndIgnoreClick:this.onRejectAndIgnoreClick,inviterName:s,canPreview:!1,joining:this.state.joining,room:this.state.room,roomId:this.state.roomId})))}}if(this.state.canAskToJoin&&[ut.O.Knock,ut.O.Leave].includes(r))return i.createElement("div",{className:"mx_RoomView"},i.createElement(Hm.A,null,i.createElement(pv,{onJoinClick:this.onJoinButtonClicked,room:this.state.room,canAskToJoinAndMembershipIsLeave:r===ut.O.Leave,promptAskToJoin:this.state.promptAskToJoin,knocked:r===ut.O.Knock,onSubmitAskToJoin:this.onSubmitAskToJoin,onCancelAskToJoin:this.onCancelAskToJoin,onForgetClick:this.onForgetClick})));let d,m=null;{const e=this.getCallForRoom();e&&"ended"!==this.state.callState&&"ringing"!==this.state.callState&&(m=e)}let u=!0;$d.Ay.sharedInstance().getCurrentUploads().length>0?d=i.createElement(gg,{room:this.state.room}):this.state.search||(u=this.state.statusBarVisible,d=i.createElement(Ef.A,{room:this.state.room,isPeeking:r!==ut.O.Join,onInviteClick:this.onInviteClick,onVisible:this.onStatusBarVisible,onHidden:this.onStatusBarHidden}));const h=dt()("mx_RoomView_statusArea",{mx_RoomView_statusArea_expanded:u}),p=d&&i.createElement("div",{role:"region",className:h,"aria-label":(0,l._t)("a11y|room_status_bar")},i.createElement("div",{className:"mx_RoomView_statusAreaBox"},i.createElement("div",{className:"mx_RoomView_statusAreaBox_line"}),d)),g=this.state.upgradeRecommendation,v=g&&g.needsUpgrade&&this.state.room.userMayUpgradeRoom(this.context.client.getSafeUserId()),_=this.getHiddenHighlightCount();let f,E;if(this.state.timelineRenderingType===jt.Ae.Search)f=i.createElement(Hf,{searchInfo:this.state.search,onCancelClick:this.onCancelSearchClick,onSearchScopeChange:this.onSearchScopeChange,isRoomEncrypted:this.context.client.isRoomEncrypted(this.state.room.roomId)});else if(v)f=i.createElement(kv,{room:this.state.room});else if(r!==ut.O.Join){var y,b;let e;this.props.oobData&&(e=this.props.oobData.inviterName);const t=null===(y=this.props.threepidInvite)||void 0===y?void 0:y.toEmail;if(E=i.createElement(pv,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectThreepidInviteButtonClicked,joining:this.state.joining,inviterName:e,invitedEmail:t,oobData:this.props.oobData,canPreview:this.state.canPeek,room:this.state.room,roomId:this.state.roomId}),!(this.state.canPeek||null!==(b=this.state.room)&&void 0!==b&&b.isSpaceRoom()))return i.createElement("div",{className:"mx_RoomView"},E)}else _>0&&(f=i.createElement(ie.A,{element:"div",className:"mx_RoomView_auxPanel_hiddenHighlights",onClick:this.onHiddenHighlightsClick},(0,l._t)("room|unread_notifications_predecessor",{count:_})));if(null!==(e=this.state.room)&&void 0!==e&&e.isSpaceRoom()&&!this.props.forceTimeline)return i.createElement(ff,{space:this.state.room,justCreatedOpts:this.props.justCreatedOpts,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.permalinkCreator,onJoinButtonClicked:this.onJoinButtonClicked,onRejectButtonClicked:this.props.threepidInvite?this.onRejectThreepidInviteButtonClicked:this.onRejectButtonClicked});const w=i.createElement(m_,{room:this.state.room,userId:this.context.client.getSafeUserId(),showApps:this.state.showApps,resizeNotifier:this.props.resizeNotifier},f),S=i.createElement(Kf,{room:this.state.room,permalinkCreator:this.permalinkCreator});let A;let C;r===ut.O.Join&&!this.state.search&&(A=i.createElement(ug,{room:this.state.room,e2eStatus:this.state.e2eStatus,resizeNotifier:this.props.resizeNotifier,replyToEvent:this.state.replyToEvent,permalinkCreator:this.permalinkCreator}));let x,k=!1;this.state.search&&(C=i.createElement(Bf,{key:this.state.search.searchId,ref:this.searchResultsPanel,term:this.state.search.term,scope:this.state.search.scope,promise:this.state.search.promise,abortController:this.state.search.abortController,inProgress:!!this.state.search.inProgress,resizeNotifier:this.props.resizeNotifier,className:this.messagePanelClassNames,onUpdate:this.onSearchUpdate}),k=!0),this.state.isInitialEventHighlighted&&(x=this.state.initialEventId);const R=i.createElement(Cp,{ref:this.gatherTimelinePanelRef,timelineSet:this.state.room.getUnfilteredTimelineSet(),overlayTimelineSet:null===(t=this.state.virtualRoom)||void 0===t?void 0:t.getUnfilteredTimelineSet(),overlayTimelineSetFilter:Ep.Xm,showReadReceipts:this.state.showReadReceipts,manageReadReceipts:!this.state.isPeeking,sendReadReceiptOnLoad:!this.state.wasContextSwitch,manageReadMarkers:!this.state.isPeeking,hidden:k,highlightedEventId:x,eventId:this.state.initialEventId,eventScrollIntoView:this.state.initialEventScrollIntoView,eventPixelOffset:this.state.initialEventPixelOffset,onScroll:this.onMessageListScroll,onEventScrolledIntoView:this.resetJumpToEvent,onReadMarkerUpdated:this.updateTopUnreadMessagesBar,showUrlPreview:this.state.showUrlPreview,className:this.messagePanelClassNames,membersLoaded:this.state.membersLoaded,permalinkCreator:this.permalinkCreator,resizeNotifier:this.props.resizeNotifier,showReactions:!0,layout:this.state.layout,editState:this.state.editState});let I,T;this.state.showTopUnreadMessagesBar&&!this.state.search&&(I=i.createElement(yf,{onScrollUpClick:this.jumpToReadMarker,onCloseClick:this.forgetReadMarker})),!1!==this.state.atEndOfLiveTimeline||this.state.search||(T=i.createElement(Qg,{highlight:this.state.room.getUnreadNotificationCount(o.NotificationCountType.Highlight)>0,numUnreadMessages:this.state.numUnreadMessages,onScrollToBottomClick:this.jumpToLiveTimeline}));const P=this.state.room&&this.state.showRightPanel?i.createElement(ov,{room:this.state.room,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.permalinkCreator,e2eStatus:this.state.e2eStatus,onSearchChange:this.onSearchChange,onSearchCancel:this.onCancelSearchClick}):void 0,N=dt()("mx_RoomView_timeline",{mx_RoomView_timeline_rr_enabled:this.state.showReadReceipts});let{mainSplitContentType:D}=this.state;this.state.search&&(D=jt.DZ.Timeline);const O=dt()("mx_RoomView",{mx_RoomView_inCall:Boolean(m),mx_RoomView_immersive:D!==jt.DZ.Timeline}),L=M.A.getValue("showChatEffects");let U,F;switch(D){case jt.DZ.Timeline:F="mx_MainSplit_timeline",U=i.createElement(i.Fragment,null,this.roomViewBody.current&&i.createElement(xp,{sensor:this.roomViewBody.current,onMeasurement:this.onMeasurement}),w,S,i.createElement("main",{className:N},i.createElement(fg,{parent:this.roomView.current,onFileDrop:this.onFileDrop}),I,T,R,C),p,E,A);break;case jt.DZ.MaximisedWidget:F="mx_MainSplit_maximisedWidget",U=i.createElement(i.Fragment,null,i.createElement(Bv,{room:this.state.room,userId:this.context.client.getSafeUserId(),resizeNotifier:this.props.resizeNotifier,showApps:!0,role:"main"}),E);break;case jt.DZ.Call:var V;F="mx_MainSplit_call",U=i.createElement(i.Fragment,null,i.createElement(J_,{room:this.state.room,resizing:this.state.resizing,waitForCall:(0,Vu.j)(this.state.room),skipLobby:null!==(V=this.context.roomViewStore.skipCallLobby())&&void 0!==V&&V,role:"main"}),E)}const B=dt()("mx_RoomView_body",F);let j,W,z="other_room";return this.state.mainSplitContentType!==jt.DZ.Timeline&&(j="wide",W=420,z=this.state.mainSplitContentType===jt.DZ.Call?"video_room":"maximised_widget"),i.createElement(jt.Ay.Provider,{value:this.state},i.createElement("div",{className:O,ref:this.roomView,onKeyDown:this.onReactKeyDown},L&&this.roomView.current&&i.createElement(z_,{roomWidth:this.roomView.current.offsetWidth}),i.createElement(Hm.A,null,i.createElement(Yd,{panel:P,resizeNotifier:this.props.resizeNotifier,sizeKey:j,defaultSize:W,analyticsRoomType:z},i.createElement("div",{className:B,ref:this.roomViewBody,"data-layout":this.state.layout},i.createElement(W_,{room:this.state.room,additionalButtons:this.state.viewRoomOpts.buttons}),U)))))}}(0,v.A)(oE,"e2eStatusCache",new Map),(0,v.A)(oE,"contextType",X.A);class rE extends i.Component{constructor(e){super(e),(0,v.A)(this,"onToastStoreUpdate",(()=>{this.setState({toasts:L.A.sharedInstance().getToasts(),countSeen:L.A.sharedInstance().getCountSeen()})})),this.state={toasts:L.A.sharedInstance().getToasts(),countSeen:L.A.sharedInstance().getCountSeen()}}componentDidMount(){L.A.sharedInstance().on("update",this.onToastStoreUpdate),this.onToastStoreUpdate()}componentWillUnmount(){L.A.sharedInstance().removeListener("update",this.onToastStoreUpdate)}render(){const e=this.state.toasts.length,t=e>1;let n,s;if(0!==e){const o=this.state.toasts[0],{title:r,icon:a,key:l,component:c,className:d,bodyClassName:m,props:u}=o,h=dt()("mx_Toast_body",m),p=dt()("mx_Toast_toast",d,{mx_Toast_hasIcon:a,[`mx_Toast_icon_${a}`]:a}),g=Object.assign({},u,{key:l,toastKey:l}),v=i.createElement(c,g);let _,f;(r&&t||this.state.countSeen>0)&&(_=` (${this.state.countSeen+1}/${this.state.countSeen+e})`),r&&(f=i.createElement("div",{className:"mx_Toast_title"},i.createElement(pl.E,{size:"lg",weight:"semibold",as:"h2"},r),i.createElement("span",{className:"mx_Toast_title_countIndicator"},_))),n=i.createElement("div",{className:p},f,i.createElement("div",{className:h},v)),s=dt()("mx_ToastContainer",{mx_ToastContainer_stacked:t})}return n?i.createElement("div",{className:s,role:"alert"},n):null}}class aE extends i.Component{constructor(e,t){super(e,t),this.state={loading:!0}}componentDidMount(){this.props.userId&&this.loadProfileInfo()}componentDidUpdate(e){e.userId!==this.props.userId&&this.props.userId&&this.loadProfileInfo()}async loadProfileInfo(){let e;this.setState({loading:!0});try{e=await this.context.getProfileInfo(this.props.userId)}catch(e){return k.Ay.createDialog(nt.A,{title:(0,l._t)("error_dialog|error_loading_user_profile"),description:e instanceof Error?e.message:(0,l._t)("invite|failed_generic")}),void this.setState({loading:!1})}const t=new o.MatrixEvent({type:"m.room.member",content:e}),n=new o.RoomMember("",this.props.userId);n.setMembershipEvent(t),this.setState({member:n,loading:!1})}render(){if(this.state.loading)return i.createElement(se.A,null);if(this.state.member){const e=i.createElement(ov,{overwriteCard:{phase:fl.n.RoomMemberInfo,state:{member:this.state.member}},resizeNotifier:this.props.resizeNotifier});return i.createElement(Yd,{panel:e,resizeNotifier:this.props.resizeNotifier,defaultSize:420,analyticsRoomType:"user_profile"},i.createElement(Ld,null))}return i.createElement("div",null)}}(0,v.A)(aE,"contextType",Hn.Ay);const lE=({backgroundImage:e,blurMultiplier:t})=>{if(!e)return null;const n={};if(t){const e=getComputedStyle(document.documentElement).getPropertyValue("--lp-background-blur").replace("px",""),i=parseInt(e,10);isNaN(i)||(n.filter=`blur(${i*t}px)`)}return i.createElement("div",{className:"mx_BackdropPanel"},i.createElement("img",{role:"presentation",alt:"",style:n,className:"mx_BackdropPanel--image",src:e}))};var cE=n("./src/stores/OwnBeaconStore.ts"),dE=n("./res/img/location/live-location.svg");const mE=({isMinimized:e})=>{const t=(0,ci.dF)(cE.g.instance,cE.q.MonitoringLivePosition,(()=>cE.g.instance.isMonitoringLiveLocation)),n=(0,ci.dF)(cE.g.instance,cE.q.LocationPublishError,(()=>cE.g.instance.getLiveBeaconIdsWithLocationPublishError())),s=(0,ci.dF)(cE.g.instance,cE.q.BeaconUpdateError,(()=>cE.g.instance.getLiveBeaconIds().filter((e=>cE.g.instance.beaconUpdateErrors.has(e))))),o=(0,ci.dF)(cE.g.instance,cE.q.LivenessChange,(()=>cE.g.instance.getLiveBeaconIds())),r=!!n.length,a=!!s.length;if(((e,t)=>{(0,i.useEffect)((()=>{const n=()=>{"visible"===document.visibilityState&&e.forEach((e=>{var n;return null===(n=t.get(e))||void 0===n?void 0:n.monitorLiveness()}))};return e.length&&document.addEventListener("visibilitychange",n),()=>{document.removeEventListener("visibilitychange",n)}}),[e,t])})(o,cE.g.instance.beacons),!t)return null;const c=((e,t,n)=>{var i,s;const o=null!==(i=null!==(s=null==t?void 0:t[0])&&void 0!==s?s:null==n?void 0:n[0])&&void 0!==i?i:null==e?void 0:e[0];if(!o)return;return cE.g.instance.getBeaconById(o)})(o,s,n),d=c?e=>{S.A.dispatch({action:W.r.ViewRoom,room_id:c.roomId,metricsTrigger:void 0,event_id:c.beaconInfoId,scroll_into_view:!0,highlighted:!0})}:null,m=((e,t)=>e?(0,l._t)("location_sharing|error_stopping_live_location"):t?(0,l._t)("location_sharing|error_sharing_live_location"):(0,l._t)("location_sharing|live_location_active"))(a,r);return i.createElement(ie.A,{className:dt()("mx_LeftPanelLiveShareWarning",{mx_LeftPanelLiveShareWarning__minimized:e,mx_LeftPanelLiveShareWarning__error:r||a}),title:e?m:void 0,onClick:d},e?i.createElement(dE.I,{height:10}):m)};function uE(e,t,n){return(1-(n=(0,Vn.clamp)(n,0,1)))*e+n*t}const hE=58,pE=58,gE=76,vE=8;class _E extends i.Component{constructor(...e){super(...e),(0,v.A)(this,"callViewWrapper",(0,i.createRef)()),(0,v.A)(this,"initX",0),(0,v.A)(this,"initY",0),(0,v.A)(this,"desiredTranslationX",Zr.A.instance.windowWidth-vE-336),(0,v.A)(this,"desiredTranslationY",Zr.A.instance.windowHeight-pE-232),(0,v.A)(this,"translationX",this.desiredTranslationX),(0,v.A)(this,"translationY",this.desiredTranslationY),(0,v.A)(this,"mouseHeld",!1),(0,v.A)(this,"scheduledUpdate",new zp.L((()=>this.animationCallback()),(()=>requestAnimationFrame((()=>this.scheduledUpdate.trigger()))))),(0,v.A)(this,"startingPositionX",0),(0,v.A)(this,"startingPositionY",0),(0,v.A)(this,"_moving",!1),(0,v.A)(this,"animationCallback",(()=>{var e,t;if(!this.moving&&Math.abs(this.translationX-this.desiredTranslationX)<=1&&Math.abs(this.translationY-this.desiredTranslationY)<=1)this.translationX=this.desiredTranslationX,this.translationY=this.desiredTranslationY,this.setStyle();else{const e=this.moving?.2:.1;this.translationX=uE(this.translationX,this.desiredTranslationX,e),this.translationY=uE(this.translationY,this.desiredTranslationY,e),this.setStyle(),this.scheduledUpdate.mark()}null===(e=(t=this.props).onMove)||void 0===e||e.call(t)})),(0,v.A)(this,"setStyle",(()=>{this.callViewWrapper.current&&(this.callViewWrapper.current.style.transform=`translateX(${this.translationX}px) translateY(${this.translationY}px)`)})),(0,v.A)(this,"onResize",(()=>{this.snap(!1)})),(0,v.A)(this,"snap",((e=!1)=>{var t,n;const i=this.desiredTranslationX,s=this.desiredTranslationY,o=Zr.A.instance.windowWidth-((null===(t=this.callViewWrapper.current)||void 0===t?void 0:t.clientWidth)||336),r=Zr.A.instance.windowHeight-((null===(n=this.callViewWrapper.current)||void 0===n?void 0:n.clientHeight)||232);i>=o/2&&s>=r/2?(this.desiredTranslationX=o-vE,this.desiredTranslationY=r-pE):i>=o/2&&s<=r/2?(this.desiredTranslationX=o-vE,this.desiredTranslationY=hE):i<=o/2&&s>=r/2?(this.desiredTranslationX=gE,this.desiredTranslationY=r-pE):(this.desiredTranslationX=gE,this.desiredTranslationY=hE),e||(this.translationX=this.desiredTranslationX,this.translationY=this.desiredTranslationY),this.scheduledUpdate.mark()})),(0,v.A)(this,"onStartMoving",(e=>{e.preventDefault(),e.stopPropagation(),this.mouseHeld=!0,this.startingPositionX=e.clientX,this.startingPositionY=e.clientY})),(0,v.A)(this,"onMoving",(e=>{this.mouseHeld&&(Math.abs(this.startingPositionX-e.clientX)<5&&Math.abs(this.startingPositionY-e.clientY)<5||(e.preventDefault(),e.stopPropagation(),this.moving||(this.moving=!0,this.initX=e.pageX-this.desiredTranslationX,this.initY=e.pageY-this.desiredTranslationY,this.scheduledUpdate.mark()),this.setTranslation(e.pageX-this.initX,e.pageY-this.initY)))})),(0,v.A)(this,"onEndMoving",(e=>{this.mouseHeld&&(e.preventDefault(),e.stopPropagation(),this.mouseHeld=!1,setTimeout((()=>this.moving=!1)),this.snap(!0))})),(0,v.A)(this,"onClickCapture",(e=>{this.moving&&(e.preventDefault(),e.stopPropagation())}))}get moving(){return this._moving}set moving(e){this._moving=e}componentDidMount(){document.addEventListener("mousemove",this.onMoving),document.addEventListener("mouseup",this.onEndMoving),Zr.A.instance.on(Zr.x.Resize,this.onResize),this.snap()}componentWillUnmount(){document.removeEventListener("mousemove",this.onMoving),document.removeEventListener("mouseup",this.onEndMoving),Zr.A.instance.off(Zr.x.Resize,this.onResize)}componentDidUpdate(e){e.children!==this.props.children&&this.snap(!0)}setTranslation(e,t){var n,i;const s=(null===(n=this.callViewWrapper.current)||void 0===n?void 0:n.clientWidth)||336,o=(null===(i=this.callViewWrapper.current)||void 0===i?void 0:i.clientHeight)||232;e+s>=Zr.A.instance.windowWidth?this.desiredTranslationX=Zr.A.instance.windowWidth-s:this.desiredTranslationX=e<=0?0:e,t+o>=Zr.A.instance.windowHeight?this.desiredTranslationY=Zr.A.instance.windowHeight-o:this.desiredTranslationY=t<=0?0:t}render(){const e={transform:`translateX(${this.translationX}px) translateY(${this.translationY}px)`},t=this.props.children.map((e=>e({onStartMoving:this.onStartMoving,onResize:this.onResize})));return i.createElement("aside",{className:this.props.className,style:e,ref:this.callViewWrapper,onClickCapture:this.onClickCapture,onDoubleClick:this.props.onDoubleClick},t)}}var fE=n("./src/voice-broadcast/stores/VoiceBroadcastPlaybacksStore.ts");var EE,yE,bE=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/arrow-left.js");class wE extends i.Component{constructor(e,t){super(e,t),(0,v.A)(this,"room",void 0),this.room=t.getRoom(this.props.persistentRoomId)}render(){const e=Bh.Ay.instance.get(this.props.persistentWidgetId,this.props.persistentRoomId);return e?i.createElement(cp,{key:e.id,app:e,fullWidth:!0,room:this.room,userId:this.context.getSafeUserId(),creatorUserId:e.creatorUserId,widgetPageTitle:th.A.getWidgetDataTitle(e),waitForIframeLoad:e.waitForIframeLoad,miniMode:!0,showMenubar:!1,pointerEvents:this.props.pointerEvents,movePersistedElement:this.props.movePersistedElement,overlay:this.props.children}):null}}function SE(){return SE=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},SE.apply(null,arguments)}(0,v.A)(wE,"contextType",Hn.Ay);var AE=function(e,t){return i.createElement("svg",SE({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0,ref:t},e),EE||(EE=i.createElement("path",{fill:"currentColor",d:"M8.027 15.961c1.141 1.232 3.888 3.365 4.637 3.803l.151.09c1.143.679 4.722 2.807 7.33.815 2.021-1.542 1.364-3.278.684-3.794-.466-.362-1.838-1.36-3.128-2.26-1.268-.883-1.974-.175-2.452.303l-.026.026-.96.961c-.246.245-.618.156-.974-.125a26 26 0 0 1-2.692-2.385l-.004-.004c-.47-.47-1.4-1.4-2.373-2.68-.28-.356-.37-.728-.125-.973l.96-.961.027-.026c.478-.478 1.186-1.184.303-2.452-.9-1.29-1.898-2.662-2.26-3.128-.516-.68-2.252-1.337-3.794.684-1.992 2.608.136 6.187.815 7.33l.09.151c.438.75 2.56 3.484 3.791 4.625"})),yE||(yE=i.createElement("path",{fill:"currentColor",d:"M20.697 3.078a.64.64 0 0 0 0-.893.615.615 0 0 0-.88 0L17 5.045l-2.817-2.86a.615.615 0 0 0-.88 0 .64.64 0 0 0 0 .893l2.817 2.86-2.938 2.984a.64.64 0 0 0 0 .893.615.615 0 0 0 .88 0L17 6.832l2.938 2.983a.615.615 0 0 0 .88 0 .64.64 0 0 0 0-.893L17.88 5.939z"})))},CE=(0,i.forwardRef)(AE);const xE=({widgetId:e,room:t,viewingRoom:n,onStartMoving:s,movePersistedElement:r})=>{const a=(0,i.useMemo)((()=>Bh.Ay.instance.getApps(t.roomId).find((t=>t.id===e))),[t,e]),c=(0,ci.DY)(t,o.RoomEvent.Name,(0,i.useCallback)((()=>t.name),[t])),d=(0,E_.Jf)(e,t.roomId),m=(0,i.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),null!==d?S.A.dispatch({action:W.r.ViewRoom,room_id:t.roomId,view_call:!0,metricsTrigger:"WebFloatingCallWindow"}):n?Jh.aK.instance.moveToContainer(t,a,Jh.mc.Center):S.A.dispatch({action:W.r.ViewRoom,room_id:t.roomId,metricsTrigger:"WebFloatingCallWindow"})}),[t,d,a,n]),u=(0,i.useCallback)((e=>{var t;(e.preventDefault(),e.stopPropagation(),null!==d)?d.disconnect().catch((e=>console.error("Failed to leave call",e))):null===(t=Th.c.instance.getMessagingForUid(th.A.getWidgetUid(a)))||void 0===t||t.transport.send(Ph.k.HangupCall,{}).catch((e=>console.error("Failed to leave Jitsi",e)))}),[d,a]);return i.createElement("div",{className:"mx_WidgetPip",onMouseDown:s,onClick:m},i.createElement(wE,{persistentWidgetId:e,persistentRoomId:t.roomId,pointerEvents:"none",movePersistedElement:r},i.createElement("div",{onMouseDown:s,className:"mx_WidgetPip_overlay"},i.createElement(bn.A,{className:"mx_WidgetPip_header"},i.createElement(wn.k,{onClick:m,className:"mx_WidgetPip_backButton","aria-label":(0,l._t)("action|back")},i.createElement(bE.A,{className:"mx_Icon mx_Icon_16"}),c)),(null!==d||gh.x.JITSI.matches(null==a?void 0:a.type))&&i.createElement(bn.A,{className:"mx_WidgetPip_footer"},i.createElement(wn.k,{onClick:u,title:(0,l._t)("action|leave"),"aria-label":(0,l._t)("action|leave"),placement:"top"},i.createElement(CE,{className:"mx_Icon mx_Icon_24"}))))))},kE=[ft.iP.Connected,ft.iP.InviteSent,ft.iP.Connecting,ft.iP.CreateAnswer,ft.iP.CreateOffer,ft.iP.WaitLocalMedia];function RE(e){if(!e)return[null,[]];const t=et.Ay.instance.getAllActiveCallsForPip(e);let n=null,i=[];for(const e of t)kE.includes(e.state)&&(e.isRemoteOnHold()||null!==n?i.push(e):n=e);return null===n&&i.length>0&&(n=i[0],i=i.slice(1)),i.length>1&&s.v.log("Found more than 1 secondary call! Other calls will not be shown."),[n,i]}class IE extends i.Component{constructor(e){super(e),(0,v.A)(this,"onMove",(()=>{var e,t;return null===(e=(t=this.props.movePersistedElement).current)||void 0===e?void 0:e.call(t)})),(0,v.A)(this,"onRoomViewStoreUpdate",(()=>{var e,t;const n=X.M.instance.roomViewStore.getRoomId(),i=this.state.viewedRoomId;if(n===i)return;const s=null===(e=_.J.get())||void 0===e?void 0:e.getRoom(i);s&&Jh.aK.instance.off(Jh.aK.emissionForRoom(s),this.updateCalls);const o=null===(t=_.J.get())||void 0===t?void 0:t.getRoom(n||void 0);if(o&&Jh.aK.instance.on(Jh.aK.emissionForRoom(o),this.updateCalls),!n)return;const[r,a]=RE(n);this.setState({viewedRoomId:n,primaryCall:r,secondaryCall:a[0]}),this.updateShowWidgetInPip()})),(0,v.A)(this,"onWidgetPersistence",(()=>{this.updateShowWidgetInPip()})),(0,v.A)(this,"onWidgetDockChanges",(()=>{this.updateShowWidgetInPip()})),(0,v.A)(this,"updateCalls",(()=>{if(!this.state.viewedRoomId)return;const[e,t]=RE(this.state.viewedRoomId);this.setState({primaryCall:e,secondaryCall:t[0]}),this.updateShowWidgetInPip()})),(0,v.A)(this,"onCallRemoteHold",(()=>{if(!this.state.viewedRoomId)return;const[e,t]=RE(this.state.viewedRoomId);this.setState({primaryCall:e,secondaryCall:t[0]})})),(0,v.A)(this,"onDoubleClick",(()=>{var e;const t=null===(e=this.state.primaryCall)||void 0===e?void 0:e.roomId;var n;(null!=t?t:this.state.persistentRoomId)&&S.A.dispatch({action:W.r.ViewRoom,room_id:null!==(n=null!=t?t:this.state.persistentRoomId)&&void 0!==n?n:void 0,metricsTrigger:"WebFloatingCallWindow"})}));const t=X.M.instance.roomViewStore.getRoomId(),[n,i]=RE(t);this.state={viewedRoomId:t||void 0,primaryCall:n||null,secondaryCall:i[0],persistentWidgetId:R.A.instance.getPersistentWidgetId(),persistentRoomId:R.A.instance.getPersistentRoomId(),showWidgetInPip:!1}}componentDidMount(){et.Ay.instance.addListener(et.uv.CallChangeRoom,this.updateCalls),et.Ay.instance.addListener(et.uv.CallState,this.updateCalls),X.M.instance.roomViewStore.addListener(_r.H,this.onRoomViewStoreUpdate),_.J.safeGet().on(ft.$E.RemoteHoldUnhold,this.onCallRemoteHold);const e=_.J.safeGet().getRoom(this.state.viewedRoomId);e&&Jh.aK.instance.on(Jh.aK.emissionForRoom(e),this.updateCalls),R.A.instance.on(R.y.Persistence,this.onWidgetPersistence),R.A.instance.on(R.y.Dock,this.onWidgetDockChanges),R.A.instance.on(R.y.Undock,this.onWidgetDockChanges)}componentWillUnmount(){et.Ay.instance.removeListener(et.uv.CallChangeRoom,this.updateCalls),et.Ay.instance.removeListener(et.uv.CallState,this.updateCalls);const e=_.J.get();null==e||e.removeListener(ft.$E.RemoteHoldUnhold,this.onCallRemoteHold),X.M.instance.roomViewStore.removeListener(_r.H,this.onRoomViewStoreUpdate);const t=null==e?void 0:e.getRoom(this.state.viewedRoomId);t&&Jh.aK.instance.off(Jh.aK.emissionForRoom(t),this.updateCalls),R.A.instance.off(R.y.Persistence,this.onWidgetPersistence),R.A.instance.off(R.y.Dock,this.onWidgetDockChanges),R.A.instance.off(R.y.Undock,this.onWidgetDockChanges)}updateShowWidgetInPip(){const e=R.A.instance.getPersistentWidgetId(),t=R.A.instance.getPersistentRoomId();let n=!1,i=!1;e&&t&&_.J.safeGet().getRoom(t)&&(i=!R.A.instance.isDocked(e,t),n=this.state.viewedRoomId!==t);const s=n||i;this.setState({showWidgetInPip:s,persistentWidgetId:e,persistentRoomId:t})}createVoiceBroadcastPlaybackPipContent(e){const t=this.state.viewedRoomId===e.infoEvent.getRoomId()?i.createElement(Pt.DL,{playback:e,pip:!0}):i.createElement(Pt.iB,{playback:e});return({onStartMoving:n})=>i.createElement("div",{key:`vb-playback-${e.infoEvent.getId()}`,onMouseDown:n},t)}createVoiceBroadcastPreRecordingPipContent(e){return({onStartMoving:t})=>i.createElement("div",{key:"vb-pre-recording",onMouseDown:t},i.createElement(Pt.lG,{voiceBroadcastPreRecording:e}))}createVoiceBroadcastRecordingPipContent(e){return({onStartMoving:t})=>i.createElement("div",{key:`vb-recording-${e.infoEvent.getId()}`,onMouseDown:t},i.createElement(Pt.G4,{recording:e}))}render(){const e=!0;let t=[];if(this.props.voiceBroadcastRecording?t=[this.createVoiceBroadcastRecordingPipContent(this.props.voiceBroadcastRecording)]:this.props.voiceBroadcastPreRecording?t=[this.createVoiceBroadcastPreRecordingPipContent(this.props.voiceBroadcastPreRecording)]:this.props.voiceBroadcastPlayback&&(t=[this.createVoiceBroadcastPlaybackPipContent(this.props.voiceBroadcastPlayback)]),this.state.primaryCall){const n=this.state.primaryCall;t.push((({onStartMoving:t,onResize:s})=>i.createElement(c_,{key:"call-view",onMouseDownOnHeader:t,call:n,secondaryCall:this.state.secondaryCall,pipMode:e,onResize:s})))}return this.state.showWidgetInPip&&this.state.persistentWidgetId&&t.push((({onStartMoving:e})=>{var t;return i.createElement(xE,{key:"widget-pip",widgetId:this.state.persistentWidgetId,room:_.J.safeGet().getRoom(null!==(t=this.state.persistentRoomId)&&void 0!==t?t:void 0),viewingRoom:this.state.viewedRoomId===this.state.persistentRoomId,onStartMoving:e,movePersistedElement:this.props.movePersistedElement})})),t.length?i.createElement(_E,{className:"mx_LegacyCallPreview",draggable:e,onDoubleClick:this.onDoubleClick,onMove:this.onMove},t):null}}const TE=()=>{const e=(0,i.useContext)(X.A),t=e.voiceBroadcastPreRecordingStore,{currentVoiceBroadcastPreRecording:n}=(0,Pt.mW)(t),s=e.voiceBroadcastRecordingsStore,{currentVoiceBroadcastRecording:o}=(0,Pt.PE)(s),r=e.voiceBroadcastPlaybacksStore,{currentVoiceBroadcastPlayback:a}=(l=r,{currentVoiceBroadcastPlayback:(0,ci.DY)(l,fE.n.CurrentChanged,(e=>null!=e?e:l.getCurrent()))});var l;const c=(0,i.useRef)();return i.createElement(IE,{voiceBroadcastPlayback:a,voiceBroadcastPreRecording:n,voiceBroadcastRecording:o,movePersistedElement:c})};var PE=n("./node_modules/matrix-js-sdk/src/pushprocessor.ts");class NE{static encodeActions(e){const t=e.notify,n=e.sound,i=e.highlight;if(t){const e=[o.PushRuleActionName.Notify];return n&&e.push({set_tweak:"sound",value:n}),i?e.push({set_tweak:"highlight"}):e.push({set_tweak:"highlight",value:!1}),e}return[o.PushRuleActionName.DontNotify]}static decodeActions(e){let t,n=!1,i=!1;for(const s of e)if(s===o.PushRuleActionName.Notify)n=!0;else if(s===o.PushRuleActionName.DontNotify)n=!1;else{if("object"!=typeof s)return null;if("sound"===s.set_tweak)t=s.value;else{if("highlight"!==s.set_tweak)return null;i=s.value}}void 0===i&&(i=!0);const s={notify:n,highlight:i};return void 0!==t&&(s.sound=t),s}}const DE=NE.encodeActions;class ME{}(0,v.A)(ME,"ACTION_NOTIFY",DE({notify:!0})),(0,v.A)(ME,"ACTION_NOTIFY_DEFAULT_SOUND",DE({notify:!0,sound:"default"})),(0,v.A)(ME,"ACTION_NOTIFY_RING_SOUND",DE({notify:!0,sound:"ring"})),(0,v.A)(ME,"ACTION_HIGHLIGHT",DE({notify:!0,highlight:!0})),(0,v.A)(ME,"ACTION_HIGHLIGHT_DEFAULT_SOUND",DE({notify:!0,sound:"default",highlight:!0})),(0,v.A)(ME,"ACTION_DONT_NOTIFY",DE({notify:!1})),(0,v.A)(ME,"ACTION_DISABLED",void 0);let OE=function(e){return e.Off="off",e.On="on",e.Loud="loud",e}({});class LE{static actionsFor(e){return e===OE.On?ME.ACTION_NOTIFY:e===OE.Loud?ME.ACTION_HIGHLIGHT_DEFAULT_SOUND:[]}static contentRuleVectorStateKind(e){const t=NE.decodeActions(e.actions);if(!t)return null;let n=0;t.sound&&n++,t.highlight&&n++;let i=null;switch(n){case 0:i=OE.On;break;case 2:i=OE.Loud}return i}}(0,v.A)(LE,"OFF",OE.Off),(0,v.A)(LE,"ON",OE.On),(0,v.A)(LE,"LOUD",OE.Loud),(0,v.A)(LE,"states",OE);class UE{constructor(e){(0,v.A)(this,"description",void 0),(0,v.A)(this,"vectorStateToActions",void 0),(0,v.A)(this,"syncedRuleIds",void 0),this.description=e.description,this.vectorStateToActions=e.vectorStateToActions,this.syncedRuleIds=e.syncedRuleIds}ruleToVectorState(e){let t=!1;e&&(t=e.enabled);for(const n of Object.values(LE.states)){const i=this.vectorStateToActions[n];if(i){if(t&&JSON.stringify(NE.decodeActions(e.actions))===JSON.stringify(NE.decodeActions(i)))return n}else if(!t)return n}s.v.error(`Cannot translate rule actions into Vector rule state. Rule: ${JSON.stringify(e)}, Expected: ${JSON.stringify(this.vectorStateToActions)}`)}}const FE={".m.rule.contains_display_name":new UE({description:(0,l.AO)("settings|notifications|rule_contains_display_name"),vectorStateToActions:{[OE.On]:ME.ACTION_NOTIFY,[OE.Loud]:ME.ACTION_HIGHLIGHT_DEFAULT_SOUND,[OE.Off]:ME.ACTION_DISABLED}}),".m.rule.contains_user_name":new UE({description:(0,l.AO)("settings|notifications|rule_contains_user_name"),vectorStateToActions:{[OE.On]:ME.ACTION_NOTIFY,[OE.Loud]:ME.ACTION_HIGHLIGHT_DEFAULT_SOUND,[OE.Off]:ME.ACTION_DISABLED},syncedRuleIds:[o.RuleId.IsUserMention]}),".m.rule.roomnotif":new UE({description:(0,l.AO)("settings|notifications|rule_roomnotif"),vectorStateToActions:{[OE.On]:ME.ACTION_NOTIFY,[OE.Loud]:ME.ACTION_HIGHLIGHT,[OE.Off]:ME.ACTION_DISABLED},syncedRuleIds:[o.RuleId.IsRoomMention]}),".m.rule.room_one_to_one":new UE({description:(0,l.AO)("settings|notifications|rule_room_one_to_one"),vectorStateToActions:{[OE.On]:ME.ACTION_NOTIFY,[OE.Loud]:ME.ACTION_NOTIFY_DEFAULT_SOUND,[OE.Off]:ME.ACTION_DONT_NOTIFY},syncedRuleIds:[o.RuleId.PollStartOneToOne,o.RuleId.PollStartOneToOneUnstable,o.RuleId.PollEndOneToOne,o.RuleId.PollEndOneToOneUnstable]}),".m.rule.encrypted_room_one_to_one":new UE({description:(0,l.AO)("settings|notifications|rule_encrypted_room_one_to_one"),vectorStateToActions:{[OE.On]:ME.ACTION_NOTIFY,[OE.Loud]:ME.ACTION_NOTIFY_DEFAULT_SOUND,[OE.Off]:ME.ACTION_DONT_NOTIFY}}),".m.rule.message":new UE({description:(0,l.AO)("settings|notifications|rule_message"),vectorStateToActions:{[OE.On]:ME.ACTION_NOTIFY,[OE.Loud]:ME.ACTION_NOTIFY_DEFAULT_SOUND,[OE.Off]:ME.ACTION_DONT_NOTIFY},syncedRuleIds:[o.RuleId.PollStart,o.RuleId.PollStartUnstable,o.RuleId.PollEnd,o.RuleId.PollEndUnstable]}),".m.rule.encrypted":new UE({description:(0,l.AO)("settings|notifications|rule_encrypted"),vectorStateToActions:{[OE.On]:ME.ACTION_NOTIFY,[OE.Loud]:ME.ACTION_NOTIFY_DEFAULT_SOUND,[OE.Off]:ME.ACTION_DONT_NOTIFY}}),".m.rule.invite_for_me":new UE({description:(0,l.AO)("settings|notifications|rule_invite_for_me"),vectorStateToActions:{[OE.On]:ME.ACTION_NOTIFY,[OE.Loud]:ME.ACTION_NOTIFY_DEFAULT_SOUND,[OE.Off]:ME.ACTION_DISABLED}}),".m.rule.call":new UE({description:(0,l.AO)("settings|notifications|rule_call"),vectorStateToActions:{[OE.On]:ME.ACTION_NOTIFY,[OE.Loud]:ME.ACTION_NOTIFY_RING_SOUND,[OE.Off]:ME.ACTION_DISABLED}}),".m.rule.suppress_notices":new UE({description:(0,l.AO)("settings|notifications|rule_suppress_notices"),vectorStateToActions:{[OE.On]:ME.ACTION_DISABLED,[OE.Loud]:ME.ACTION_NOTIFY_DEFAULT_SOUND,[OE.Off]:ME.ACTION_DONT_NOTIFY}}),".m.rule.tombstone":new UE({description:(0,l.AO)("settings|notifications|rule_tombstone"),vectorStateToActions:{[OE.On]:ME.ACTION_NOTIFY,[OE.Loud]:ME.ACTION_HIGHLIGHT,[OE.Off]:ME.ACTION_DISABLED}})};class VE{static parseContentRules(e){const t=VE.categoriseContentRules(e);return t.loud.length?{vectorState:OE.Loud,rules:t.loud,externalRules:[...t.loud_but_disabled,...t.on,...t.on_but_disabled,...t.other]}:t.loud_but_disabled.length?{vectorState:OE.Off,rules:t.loud_but_disabled,externalRules:[...t.on,...t.on_but_disabled,...t.other]}:t.on.length?{vectorState:OE.On,rules:t.on,externalRules:[...t.on_but_disabled,...t.other]}:t.on_but_disabled.length?{vectorState:OE.Off,rules:t.on_but_disabled,externalRules:t.other}:{vectorState:OE.On,rules:[],externalRules:t.other}}static categoriseContentRules(e){const t={on:[],on_but_disabled:[],loud:[],loud_but_disabled:[],other:[]};for(const n in e.global)for(let i=0;i<Object.keys(e.global[n]).length;++i){const s=e.global[n][i];if("."!==s.rule_id[0]&&n===o.PushRuleKind.ContentSpecific)switch(s.kind=n,LE.contentRuleVectorStateKind(s)){case OE.On:s.enabled?t.on.push(s):t.on_but_disabled.push(s);break;case OE.Loud:s.enabled?t.loud.push(s):t.loud_but_disabled.push(s);break;default:t.other.push(s)}}return t}}const BE=async(e,t,n,i)=>{i?(await e.setPushRuleActions("global",n,t,i),await e.setPushRuleEnabled("global",n,t,!0)):await e.setPushRuleEnabled("global",n,t,!1)},jE=async(e,t,n)=>{const i=new PE.j(e),s=null==t?void 0:t.map((e=>i.getPushRuleAndKindById(e))).filter((e=>Boolean(e)));if(null!=s&&s.length)for(const{kind:t,rule:i}of s)await BE(e,i.rule_id,t,n)};function WE(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function zE(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?WE(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):WE(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const HE=e=>e?zE(zE({},e.rule),{},{kind:e.kind}):void 0,KE=async(e,t)=>{if((null==e?void 0:e.getType())!==o.EventType.PushRules)return;const n=new PE.j(t);Object.entries(FE).forEach((async([e,i])=>{try{await(async(e,t,n,i)=>{var s;const o=HE(t.getPushRuleAndKindById(n));if(!o)return;const r=null===(s=i.syncedRuleIds)||void 0===s?void 0:s.map((e=>HE(t.getPushRuleAndKindById(e)))).filter((e=>Boolean(e)));if(null==r||!r.length)return;const a=i.ruleToVectorState(o),l=r.filter((e=>e.enabled!==o.enabled||i.ruleToVectorState(e)!==a));l.length&&await jE(e,l.map((({rule_id:e})=>e)),o.enabled?o.actions:void 0)})(t,n,e,i)}catch(t){s.v.error(`Failed to fully synchronise push rules for ${e}`,t)}}))};var JE=n("./src/contexts/LocalDeviceVerificationStateContext.ts");function GE(e){const t=function(e){const[t,n]=(0,i.useState)(!1);return(0,i.useEffect)((()=>{const t=e.getUserId();if(!t)return;const i=e.getCrypto();null==i||i.getUserVerificationStatus(t).then((e=>n(e.isCrossSigningVerified())),(e=>s.v.error("Error fetching verification status",e)))}),[e]),(0,ci.ml)(e,V.CryptoEvent.UserTrustStatusChanged,((t,i)=>{t===e.getUserId()&&n(i.isCrossSigningVerified())})),t}(e.client);return i.createElement(Hn.Ay.Provider,{value:e.client},i.createElement(JE.f.Provider,{value:t},e.children))}function $E(e){return e.closest("input, textarea, select, [contenteditable=true]")}class qE extends i.Component{constructor(e){super(e),(0,v.A)(this,"_matrixClient",void 0),(0,v.A)(this,"_roomView",void 0),(0,v.A)(this,"_resizeContainer",void 0),(0,v.A)(this,"resizeHandler",void 0),(0,v.A)(this,"layoutWatcherRef",void 0),(0,v.A)(this,"compactLayoutWatcherRef",void 0),(0,v.A)(this,"backgroundImageWatcherRef",void 0),(0,v.A)(this,"timezoneProfileUpdateRef",void 0),(0,v.A)(this,"resizer",void 0),(0,v.A)(this,"onTimezoneUpdate",(async()=>{if(!M.A.getValue("userTimezonePublish")){try{await this._matrixClient.deleteExtendedProfileProperty("us.cloke.msc4175.tz")}catch(e){console.warn("Failed to delete timezone from user profile",e)}return}const e=M.A.getValue("userTimezone")||Intl.DateTimeFormat().resolvedOptions().timeZone;if(e&&"string"==typeof e)try{await this._matrixClient.setExtendedProfileProperty("us.cloke.msc4175.tz",e)}catch(e){console.warn("Failed to update user profile with current timezone",e)}})),(0,v.A)(this,"onCallState",(()=>{const e=et.Ay.instance.getAllActiveCalls();e!==this.state.activeCalls&&this.setState({activeCalls:e})})),(0,v.A)(this,"refreshBackgroundImage",(async()=>{let e=M.A.getValue("RoomList.backgroundImage");e=e?(0,Wn.lH)(e).srcHttp:il.V.instance.getHttpAvatarUrl(),this.setState({backgroundImage:e})})),(0,v.A)(this,"canResetTimelineInRoom",(e=>!this._roomView.current||this._roomView.current.canResetTimeline())),(0,v.A)(this,"onAccountData",(e=>{"m.ignored_user_list"===e.getType()&&S.A.dispatch({action:"ignore_state_changed"}),KE(e,this._matrixClient)})),(0,v.A)(this,"onCompactLayoutChanged",(()=>{this.setState({useCompactLayout:M.A.getValue("useCompactLayout")})})),(0,v.A)(this,"onSync",((e,t,n)=>{var i,s;const r=null===(i=this.state.syncErrorData)||void 0===i||null===(i=i.error)||void 0===i?void 0:i.errcode,a=null==n||null===(s=n.error)||void 0===s?void 0:s.errcode;e===t&&r===a||(this.setState({syncErrorData:e===o.SyncState.Error?n:void 0}),t===o.SyncState.Prepared&&e===o.SyncState.Syncing?this.updateServerNoticeEvents():this.calculateServerLimitToast(this.state.syncErrorData,this.state.usageLimitEventContent))})),(0,v.A)(this,"onRoomStateEvents",(e=>{const t=Gl.Ay.instance.orderedLists[Jr.zO.ServerNotice];null!=t&&t.some((t=>t.roomId===e.getRoomId()))&&this.updateServerNoticeEvents()})),(0,v.A)(this,"onUsageLimitDismissed",(()=>{this.setState({usageLimitDismissed:!0})})),(0,v.A)(this,"updateServerNoticeEvents",(async()=>{const e=Gl.Ay.instance.orderedLists[Jr.zO.ServerNotice];if(!e)return;const t=[];let n=0;for(const i of e){const e=i.currentState.getStateEvents("m.room.pinned_events","");if(!e||!e.getContent().pinned)continue;n=e.getTs();const s=e.getContent().pinned.slice(0,2);for(const e of s){const n=await this._matrixClient.getEventTimeline(i.getUnfilteredTimelineSet(),e),s=null==n?void 0:n.getEvents().find((t=>t.getId()===e));s&&t.push(s)}}if(n&&this.state.usageLimitEventTs&&this.state.usageLimitEventTs>n)return;const i=t.find((e=>e&&"m.room.message"===e.getType()&&"m.server_notice.usage_limit_reached"===e.getContent().server_notice_type)),s=null==i?void 0:i.getContent();this.calculateServerLimitToast(this.state.syncErrorData,s),this.setState({usageLimitEventContent:s,usageLimitEventTs:n,usageLimitDismissed:!1})})),(0,v.A)(this,"onPaste",(e=>{const t=$E(e.target);if(t!==document.activeElement)if(null!=t&&t.focus)t.focus();else{var n;const e=!(null===(n=document.activeElement)||void 0===n||!n.closest(".mx_ThreadView"));S.A.dispatch({action:W.r.FocusSendMessageComposer,context:e?jt.Ae.Thread:jt.Ae.Room},!0)}})),(0,v.A)(this,"onReactKeyDown",(e=>{this.onKeyDown(e)})),(0,v.A)(this,"onNativeKeyDown",(e=>{e.target===document.body&&this.onKeyDown(e)})),(0,v.A)(this,"onKeyDown",(e=>{var t,n,i;let s=!1;switch((0,_s.zM)().getRoomAction(e)){case Pn.bY.ScrollUp:case Pn.bY.ScrollDown:case Pn.bY.JumpToFirstMessage:case Pn.bY.JumpToLatestMessage:this.onScrollKeyPressed(e),s=!0;break;case Pn.bY.SearchInRoom:S.A.fire(W.r.FocusMessageSearch),s=!0}if(s)return e.stopPropagation(),void e.preventDefault();const o=(0,_s.zM)().getNavigationAction(e);switch(o){case Pn.bY.NextLandmark:case Pn.bY.PreviousLandmark:Pl.r.findAndFocusNextLandmark(Pl.H.MESSAGE_COMPOSER_OR_HOME,o===Pn.bY.PreviousLandmark),s=!0;break;case Pn.bY.FilterRooms:S.A.dispatch({action:"focus_room_filter"}),s=!0;break;case Pn.bY.ToggleUserMenu:S.A.fire(W.r.ToggleUserMenu),s=!0;break;case Pn.bY.ShowKeyboardSettings:S.A.dispatch({action:W.r.ViewUserSettings,initialTabId:Na.v.Keyboard}),s=!0;break;case Pn.bY.GoToHome:if(s=!0,k.Ay.hasDialogs())return;S.A.dispatch({action:W.r.ViewHomePage});break;case Pn.bY.ToggleSpacePanel:S.A.fire(W.r.ToggleSpacePanel),s=!0;break;case Pn.bY.ToggleRoomSidePanel:"room_view"===this.props.page_type&&(_l.A.instance.togglePanel(null),s=!0);break;case Pn.bY.SelectPrevRoom:S.A.dispatch({action:W.r.ViewRoomDelta,delta:-1,unread:!1}),s=!0;break;case Pn.bY.SelectNextRoom:S.A.dispatch({action:W.r.ViewRoomDelta,delta:1,unread:!1}),s=!0;break;case Pn.bY.SelectPrevUnreadRoom:S.A.dispatch({action:W.r.ViewRoomDelta,delta:-1,unread:!0});break;case Pn.bY.SelectNextUnreadRoom:S.A.dispatch({action:W.r.ViewRoomDelta,delta:1,unread:!0});break;case Pn.bY.PreviousVisitedRoomOrSpace:null===(t=a.A.get())||void 0===t||t.navigateForwardBack(!0),s=!0;break;case Pn.bY.NextVisitedRoomOrSpace:null===(n=a.A.get())||void 0===n||n.navigateForwardBack(!1),s=!0}if(!s){switch((0,_s.zM)().getLabsAction(e)){case Pn.bY.ToggleHiddenEventVisibility:{const e=M.A.getValueAt(O.p.DEVICE,"showHiddenEventsInTimeline",void 0,!1);M.A.setValue("showHiddenEventsInTimeline",null,O.p.DEVICE,!e),s=!0;break}}}if(!s&&null!==(i=a.A.get())&&void 0!==i&&i.overrideBrowserShortcuts()&&e.code.startsWith("Digit")&&"Digit0"!==e.code&&(0,Tn.Et)(e)&&(S.A.dispatch({action:W.r.SwitchSpace,num:parseInt(e.code.slice(5),10)}),s=!0),s)return e.stopPropagation(),void e.preventDefault();if(!(e.key===Tn.Uz.ALT||e.key===Tn.Uz.CONTROL||e.key===Tn.Uz.META||e.key===Tn.Uz.SHIFT)&&!e.ctrlKey&&!e.metaKey){const t=e.target!==document.body&&(e.key===Tn.Uz.SPACE||e.key===Tn.Uz.ENTER),n=1===e.key.length||"Dead"===e.key;if(!t&&n&&!$E(e.target)){var r;const t=!(null===(r=document.activeElement)||void 0===r||!r.closest(".mx_ThreadView"));S.A.dispatch({action:W.r.FocusSendMessageComposer,context:t?jt.Ae.Thread:jt.Ae.Room},!0),e.stopPropagation()}}})),(0,v.A)(this,"onScrollKeyPressed",(e=>{var t;null===(t=this._roomView.current)||void 0===t||t.handleScrollKey(e)})),this.state={syncErrorData:void 0,useCompactLayout:M.A.getValue("useCompactLayout"),usageLimitDismissed:!1,activeCalls:et.Ay.instance.getAllActiveCalls()},this._matrixClient=this.props.matrixClient,Lr.Ay.loadDevices(),(0,Ur.Q)(),this._roomView=i.createRef(),this._resizeContainer=i.createRef(),this.resizeHandler=i.createRef()}componentDidMount(){var e;document.addEventListener("keydown",this.onNativeKeyDown,!1),et.Ay.instance.addListener(et.uv.CallState,this.onCallState),this.updateServerNoticeEvents(),this._matrixClient.on(o.ClientEvent.AccountData,this.onAccountData),KE(this._matrixClient.getAccountData("m.push_rules"),this._matrixClient),this._matrixClient.on(o.ClientEvent.Sync,this.onSync),this.onSync(this._matrixClient.getSyncState(),null,null!==(e=this._matrixClient.getSyncStateData())&&void 0!==e?e:void 0),this._matrixClient.on(o.RoomStateEvent.Events,this.onRoomStateEvents),this.layoutWatcherRef=M.A.watchSetting("layout",null,this.onCompactLayoutChanged),this.compactLayoutWatcherRef=M.A.watchSetting("useCompactLayout",null,this.onCompactLayoutChanged),this.backgroundImageWatcherRef=M.A.watchSetting("RoomList.backgroundImage",null,this.refreshBackgroundImage),this.timezoneProfileUpdateRef=[M.A.watchSetting("userTimezonePublish",null,this.onTimezoneUpdate),M.A.watchSetting("userTimezone",null,this.onTimezoneUpdate)],this.resizer=this.createResizer(),this.resizer.attach(),il.V.instance.on(_r.H,this.refreshBackgroundImage),this.loadResizerPreferences(),this.refreshBackgroundImage()}componentWillUnmount(){var e,t;document.removeEventListener("keydown",this.onNativeKeyDown,!1),et.Ay.instance.removeListener(et.uv.CallState,this.onCallState),this._matrixClient.removeListener(o.ClientEvent.AccountData,this.onAccountData),this._matrixClient.removeListener(o.ClientEvent.Sync,this.onSync),this._matrixClient.removeListener(o.RoomStateEvent.Events,this.onRoomStateEvents),il.V.instance.off(_r.H,this.refreshBackgroundImage),M.A.unwatchSetting(this.layoutWatcherRef),M.A.unwatchSetting(this.compactLayoutWatcherRef),M.A.unwatchSetting(this.backgroundImageWatcherRef),null===(e=this.timezoneProfileUpdateRef)||void 0===e||e.forEach((e=>M.A.unwatchSetting(e))),null===(t=this.resizer)||void 0===t||t.detach()}createResizer(){var e;let t,n;const i={toggleSize:156,onCollapsed:e=>{n=e,e?(S.A.dispatch({action:"hide_left_panel"}),window.localStorage.setItem("mx_lhs_size","0")):S.A.dispatch({action:"show_left_panel"})},onResized:e=>{t=e,this.props.resizeNotifier.notifyLeftHandleResized()},onResizeStart:()=>{this.props.resizeNotifier.startResizing()},onResizeStop:()=>{n||window.localStorage.setItem("mx_lhs_size",""+t),this.props.resizeNotifier.stopResizing()},isItemCollapsed:e=>e.classList.contains("mx_LeftPanel_minimized"),handler:null!==(e=this.resizeHandler.current)&&void 0!==e?e:void 0},s=new Kr(this._resizeContainer.current,Hr,i);return s.setClassNames({handle:"mx_ResizeHandle",vertical:"mx_ResizeHandle--vertical",reverse:"mx_ResizeHandle_reverse"}),s}loadResizerPreferences(){var e;let t=parseInt(window.localStorage.getItem("mx_lhs_size"),10);isNaN(t)&&(t=350),null===(e=this.resizer)||void 0===e||null===(e=e.forHandleWithId("lp-resizer"))||void 0===e||e.resize(t)}calculateServerLimitToast(e,t){var n;const s="M_RESOURCE_LIMIT_EXCEEDED"===(null==e||null===(n=e.error)||void 0===n?void 0:n.errcode);s&&(t=(null==e?void 0:e.error).data),t&&this.state.usageLimitDismissed?((e,t,n)=>{const s=(0,ho.AB)(e,n,{monthly_active_user:(0,l.AO)("error|mau"),hs_blocked:(0,l.AO)("error|hs_blocked"),"":(0,l.AO)("error|resource_limits")}),o=(0,ho.AB)(e,n,{"":(0,l.AO)("error|admin_contact_short")});L.A.sharedInstance().addOrReplaceToast({key:Gr,title:(0,l._t)("common|warning"),props:{description:i.createElement(i.Fragment,null,s," ",o),primaryLabel:(0,l._t)("action|ok"),onPrimaryClick:()=>{$r(),t&&t()}},component:j.A,priority:70})})(t.limit_type,this.onUsageLimitDismissed,t.admin_contact):$r()}render(){let e;switch(this.props.page_type){case Ir.A.RoomView:e=i.createElement(oE,{ref:this._roomView,onRegistered:this.props.onRegistered,threepidInvite:this.props.threepidInvite,oobData:this.props.roomOobData,key:this.props.currentRoomId||"roomview",resizeNotifier:this.props.resizeNotifier,justCreatedOpts:this.props.roomJustCreatedOpts,forceTimeline:this.props.forceTimeline});break;case Ir.A.HomePage:e=i.createElement(Ld,{justRegistered:this.props.justRegistered});break;case Ir.A.UserView:this.props.currentUserId&&(e=i.createElement(aE,{userId:this.props.currentUserId,resizeNotifier:this.props.resizeNotifier}))}const t=dt()({mx_MatrixChat_wrapper:!0,mx_MatrixChat_useCompactLayout:this.state.useCompactLayout}),n=dt()({mx_MatrixChat:!0,"mx_MatrixChat--with-avatar":this.state.backgroundImage}),s=this.state.activeCalls.map((e=>i.createElement(Kd,{call:e,key:e.callId})));return i.createElement(GE,{client:this._matrixClient},i.createElement("div",{onPaste:this.onPaste,onKeyDown:this.onReactKeyDown,className:t,"aria-hidden":this.props.hideToSRUsers},i.createElement(rE,null),i.createElement("div",{className:n},i.createElement("div",{className:"mx_LeftPanel_outerWrapper"},i.createElement(mE,{isMinimized:this.props.collapseLhs||!1}),i.createElement("div",{className:"mx_LeftPanel_wrapper"},i.createElement(lE,{blurMultiplier:.5,backgroundImage:this.state.backgroundImage}),i.createElement(Wl,null),i.createElement(lE,{backgroundImage:this.state.backgroundImage}),i.createElement("div",{className:"mx_LeftPanel_wrapper--user",ref:this._resizeContainer,"data-collapsed":!!this.props.collapseLhs||void 0},i.createElement(Bd,{pageType:this.props.page_type,isMinimized:this.props.collapseLhs||!1,resizeNotifier:this.props.resizeNotifier})))),i.createElement(Fr,{passRef:this.resizeHandler,id:"lp-resizer"}),i.createElement("div",{className:"mx_RoomView_wrapper"},e))),i.createElement(TE,null),i.createElement(Wd,null),s)}}(0,v.A)(qE,"displayName","LoggedInView");const YE=qE;function QE(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}let XE=function(e){return e[e.Primary=0]="Primary",e[e.Cancel=1]="Cancel",e}({});const ZE=({onFinished:e,analyticsOwner:t,privacyPolicyUrl:n,primaryButton:s,cancelButton:o,hasCancel:r})=>{const a=n?i.createElement("span",null,(0,l._t)("analytics|privacy_policy",{},{PrivacyPolicyUrl:e=>i.createElement(Ja.A,{href:n,rel:"norefferer noopener",target:"_blank"},e)})):"";return i.createElement(J.A,{className:"mx_AnalyticsLearnMoreDialog",contentId:"mx_AnalyticsLearnMore",title:(0,l._t)("analytics|enable_prompt",{analyticsOwner:t}),onFinished:e},i.createElement("div",{className:"mx_Dialog_content"},i.createElement("div",{className:"mx_AnalyticsLearnMore_image_holder"}),i.createElement("div",{className:"mx_AnalyticsLearnMore_copy"},(0,l._t)("analytics|pseudonymous_usage_data",{analyticsOwner:t})),i.createElement("ul",{className:"mx_AnalyticsLearnMore_bullets"},i.createElement("li",null,(0,l._t)("analytics|bullet_1",{},{Bold:e=>i.createElement("strong",null,e)})),i.createElement("li",null,(0,l._t)("analytics|bullet_2",{},{Bold:e=>i.createElement("strong",null,e)})),i.createElement("li",null,(0,l._t)("analytics|disable_prompt"))),a),i.createElement(ot.A,{primaryButton:s,cancelButton:o,onPrimaryButtonClick:()=>e(XE.Primary),onCancel:()=>e(XE.Cancel),hasCancel:r}))},ey=e=>{var t;const n=c.Ay.get("privacy_policy_url"),i=null!==(t=c.Ay.get("analytics_owner"))&&void 0!==t?t:c.Ay.get("brand");k.Ay.createDialog(ZE,function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?QE(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):QE(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({privacyPolicyUrl:n,analyticsOwner:i},e),"mx_AnalyticsLearnMoreDialog_wrapper")},ty=()=>{S.A.dispatch({action:W.r.PseudonymousAnalyticsAccept})},ny=()=>{S.A.dispatch({action:W.r.PseudonymousAnalyticsReject})},iy=()=>{ey({onFinished:e=>{e===XE.Primary&&ty()},primaryButton:(0,l._t)("action|enable")})},sy=()=>{ey({onFinished:e=>{e===XE.Primary?ty():e===XE.Cancel&&ny()},primaryButton:(0,l._t)("analytics|accept_button"),cancelButton:(0,l._t)("action|stop")})},oy="analytics";const ry=()=>{var e;const t=M.A.getValue("analyticsOptIn",null,!0);let n;if(t)n={description:(0,l._t)("analytics|consent_migration"),primaryLabel:(0,l._t)("analytics|accept_button"),onPrimaryClick:ty,secondaryLabel:(0,l._t)("action|learn_more"),onSecondaryClick:sy};else{if(null!=t)return;{const e=e=>i.createElement(ie.A,{kind:"link_inline",onClick:iy},e);n={description:(0,l._t)("analytics|learn_more",{},{LearnMoreLink:e}),primaryLabel:(0,l._t)("action|yes"),onPrimaryClick:ty,secondaryLabel:(0,l._t)("action|no"),onSecondaryClick:ny}}}const s=null!==(e=c.Ay.get("analytics_owner"))&&void 0!==e?e:c.Ay.get().brand;L.A.sharedInstance().addOrReplaceToast({key:oy,title:(0,l._t)("analytics|enable_prompt",{analyticsOwner:s}),props:n,component:j.A,className:"mx_AnalyticsToast",priority:10})},ay=()=>{L.A.sharedInstance().dismissToast(oy)};var ly=n("./src/components/views/elements/DialPadBackspaceButton.tsx");class cy extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,"numberEntryFieldRef",(0,i.createRef)()),(0,v.A)(this,"onCancelClick",(()=>{this.props.onFinished(!1)})),(0,v.A)(this,"onChange",(e=>{this.setState({value:e.target.value})})),(0,v.A)(this,"onFormSubmit",(e=>{e.preventDefault(),this.onDialPress()})),(0,v.A)(this,"onDigitPress",((e,t)=>{var n;(this.setState({value:this.state.value+e}),"click"===t.type)&&(null===(n=this.numberEntryFieldRef.current)||void 0===n||n.focus())})),(0,v.A)(this,"onDeletePress",(e=>{var t;0!==this.state.value.length&&(this.setState({value:this.state.value.slice(0,-1)}),"click"===e.type&&(null===(t=this.numberEntryFieldRef.current)||void 0===t||t.focus()))})),(0,v.A)(this,"onDialPress",(async()=>{et.Ay.instance.dialNumber(this.state.value),this.props.onFinished(!0)})),this.state={value:""}}render(){const e=i.createElement(ly.A,{onBackspacePress:this.onDeletePress});let t;return t=0!==this.state.value.length?i.createElement(ks.A,{ref:this.numberEntryFieldRef,className:"mx_DialPadModal_field",id:"dialpad_number",value:this.state.value,autoFocus:!0,onChange:this.onChange,postfixComponent:e}):i.createElement(ks.A,{ref:this.numberEntryFieldRef,className:"mx_DialPadModal_field",id:"dialpad_number",value:this.state.value,autoFocus:!0,onChange:this.onChange}),i.createElement("div",{className:"mx_DialPadModal"},i.createElement("div",null,i.createElement(ie.A,{className:"mx_DialPadModal_cancel",onClick:this.onCancelClick})),i.createElement("div",{className:"mx_DialPadModal_header"},i.createElement("form",{onSubmit:this.onFormSubmit},t)),i.createElement("div",{className:"mx_DialPadModal_dialPad"},i.createElement(qv.Ay,{hasDial:!0,onDigitPress:this.onDigitPress,onDeletePress:this.onDeletePress,onDialPress:this.onDialPress})))}}const dy=()=>{window.location.href="mobile_guide/"},my=()=>{document.cookie="element_mobile_redirect_to_guide=false;path=/;max-age=14400",hy()},uy="mobileguide",hy=()=>{L.A.sharedInstance().dismissToast(uy)};var py=n("./node_modules/@vector-im/compound-web/dist/components/Toast/Toast.js"),gy=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/devices.js"),vy=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/preferences.js"),_y=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/keyboard.js"),fy=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/sidebar.js"),Ey=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/mic-on.js"),yy=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/lock.js"),by=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/labs.js"),wy=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/block.js"),Sy=n("./node_modules/@vector-im/compound-web/dist/components/Form/Controls/EditInPlace/EditInPlace.js"),Ay=n("./node_modules/@vector-im/compound-web/dist/components/Form/Message.js"),Cy=n("./node_modules/@vector-im/compound-web/dist/components/Alert/Alert.js"),xy=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/pop-out.js"),ky=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/sign-out.js");const Ry=(0,i.createContext)(null);Ry.displayName="ToastContext";class Iy{constructor(){(0,v.A)(this,"currentToast",void 0),(0,v.A)(this,"updateCallback",void 0),(0,v.A)(this,"idSeq",0)}setCallback(e){this.updateCallback=e}displayToast(e){var t;const n=++this.idSeq;this.currentToast={id:n,contents:e},null===(t=this.updateCallback)||void 0===t||t.call(this);return()=>{var e,t;(null===(e=this.currentToast)||void 0===e?void 0:e.id)===n&&(this.currentToast=void 0,null===(t=this.updateCallback)||void 0===t||t.call(this))}}getActiveToast(){var e;return null===(e=this.currentToast)||void 0===e?void 0:e.contents}}var Ty=n("./src/utils/useId.ts"),Py=n("./src/components/views/elements/CopyableText.tsx");const Ny=({children:e})=>i.createElement(i.Fragment,null,i.createElement(oa.A,null),e),Dy=({username:e})=>{const t=(0,Ty.B)();return i.createElement("div",{className:"mx_UserProfileSettings_profile_controls_userId"},i.createElement("div",{className:"mx_UserProfileSettings_profile_controls_userId_label",id:t},(0,l._t)("settings|general|username")),i.createElement(Py.A,{getTextToCopy:()=>e,"aria-labelledby":t},e))},My=({externalAccountManagementUrl:e})=>i.createElement(ie.A,{onClick:null,element:"a",kind:"primary",target:"_blank",rel:"noreferrer noopener",href:e},i.createElement(xy.A,{className:"mx_UserProfileSettings_accountmanageIcon",width:"24",height:"24"}),(0,l._t)("settings|general|oidc_manage_button")),Oy=()=>{const e=(0,Hn.nH)(),t=(0,i.useCallback)((async()=>{await Ya(e)?k.Ay.createDialog(Qa):S.A.dispatch({action:"logout"})}),[e]);return i.createElement(ie.A,{onClick:t,kind:"danger_outline"},i.createElement(ky.A,{className:"mx_UserProfileSettings_accountmanageIcon",width:"24",height:"24"}),(0,l._t)("action|sign_out"))},Ly=({externalAccountManagementUrl:e,canSetDisplayName:t,canSetAvatar:n})=>{var o,r;const[a,c]=(0,i.useState)(il.V.instance.avatarMxc),[d,m]=(0,i.useState)(null!==(o=il.V.instance.displayName)&&void 0!==o?o:""),[u,h]=(0,i.useState)(!1),[p,g]=(0,i.useState)(),[v,_]=(0,i.useState)(!1),f=(0,i.useContext)(Ry),E=(0,Hn.nH)();(0,i.useEffect)((()=>{(async()=>{try{const e=await E.getMediaConfig();g(e["m.upload.size"])}catch(e){s.v.warn("Failed to get media config",e)}})()}),[E]);const y=(0,i.useCallback)((async()=>{const e=f.displayToast(i.createElement(Ny,null,(0,l._t)("settings|general|avatar_remove_progress")));try{await E.setAvatarUrl(""),c("")}finally{e()}}),[f,E]),b=(0,i.useCallback)((async e=>{Mn.A.trackInteraction("WebProfileSettingsAvatarUploadButton"),s.v.log(`Uploading new avatar, ${e.name} of type ${e.type}, (${e.size}) bytes`);const t=f.displayToast(i.createElement(Ny,null,(0,l._t)("settings|general|avatar_save_progress")));try{h(!1);const{content_uri:t}=await E.uploadContent(e);await E.setAvatarUrl(t),c(t)}catch{h(!0)}finally{t()}}),[f,E]),w=(0,i.useCallback)((e=>{m(e.target.value)}),[]),S=(0,i.useCallback)((()=>{var e;m(null!==(e=il.V.instance.displayName)&&void 0!==e?e:"")}),[]),A=(0,i.useCallback)((async()=>{try{_(!1),await E.setDisplayName(d)}catch(e){throw _(!0),e}}),[d,E]),C=(0,i.useMemo)((()=>wt.A.getDisplayUserIdentifier(E.getSafeUserId(),{withDisplayName:!0})),[E]),x=!t||!n;return i.createElement("div",{className:"mx_UserProfileSettings"},i.createElement("h2",null,(0,l._t)("common|profile")),i.createElement("div",null,x?(0,l._t)("settings|general|profile_subtitle_oidc"):(0,l._t)("settings|general|profile_subtitle")),i.createElement("div",{className:"mx_UserProfileSettings_profile"},i.createElement(yd.A,{avatar:null!=a?a:void 0,avatarAltText:(0,l._t)("common|user_avatar"),onChange:b,removeAvatar:a?y:void 0,placeholderName:d,placeholderId:null!==(r=E.getUserId())&&void 0!==r?r:"",disabled:!n}),i.createElement(Sy.d,{className:"mx_UserProfileSettings_profile_displayName",label:(0,l._t)("settings|general|display_name"),value:d,saveButtonLabel:(0,l._t)("common|save"),cancelButtonLabel:(0,l._t)("common|cancel"),savedLabel:(0,l._t)("common|saved"),savingLabel:(0,l._t)("common|updating"),onChange:w,onCancel:S,onSave:A,disabled:!t},v&&i.createElement(Ay.Kw,null,(0,l._t)("settings|general|display_name_error")))),u&&i.createElement(Cy.F,{title:(0,l._t)("settings|general|avatar_upload_error_title"),type:"critical"},void 0===p?(0,l._t)("settings|general|avatar_upload_error_text_generic"):(0,l._t)("settings|general|avatar_upload_error_text",{size:(0,bt.z3)(p)})),C&&i.createElement(Dy,{username:C}),i.createElement(ku.s,{gap:"var(--cpd-space-4x)",className:"mx_UserProfileSettings_profile_buttons"},e&&i.createElement(My,{externalAccountManagementUrl:e}),i.createElement(Oy,null)))};var Uy=n("./src/components/structures/InteractiveAuth.tsx"),Fy=n("./src/components/views/auth/InteractiveAuthEntryComponents.tsx");class Vy extends i.Component{constructor(e){super(e),(0,v.A)(this,"onStagePhaseChange",((e,t)=>{const n={[Fy.av.PHASE_PREAUTH]:{body:(0,l._t)("settings|general|deactivate_confirm_body_sso"),continueText:(0,l._t)("auth|sso"),continueKind:"danger"},[Fy.av.PHASE_POSTAUTH]:{body:(0,l._t)("settings|general|deactivate_confirm_body"),continueText:(0,l._t)("settings|general|deactivate_confirm_continue"),continueKind:"danger"}},i={[Fy.av.LOGIN_TYPE]:n,[Fy.av.UNSTABLE_LOGIN_TYPE]:n}[e];let s,o,r;if(i){const e=i[t];e&&(e.body&&(s=e.body),e.continueText&&(o=e.continueText),e.continueKind&&(r=e.continueKind))}this.setState({bodyText:s,continueText:o,continueKind:r})})),(0,v.A)(this,"onUIAuthFinished",(async(e,t)=>{e||(t!==Uy.R?(s.v.error("Error during UI Auth:",{result:t}),this.setState({errStr:(0,l._t)("settings|general|error_deactivate_communication")})):this.onCancel())})),(0,v.A)(this,"onUIAuthComplete",(e=>{_.J.safeGet().deactivateAccount(null!=e?e:void 0,this.state.shouldErase).then((e=>{S.A.fire(W.r.TriggerLogout),this.props.onFinished(!0)})).catch((e=>{s.v.error(e),this.setState({errStr:(0,l._t)("settings|general|error_deactivate_communication")})}))})),(0,v.A)(this,"onEraseFieldChange",(e=>{this.setState({shouldErase:e.currentTarget.checked,authEnabled:!1}),this.initAuth(e.currentTarget.checked)})),this.state={shouldErase:!1,errStr:null,authData:null,authEnabled:!0}}componentDidMount(){this.initAuth(!1)}onCancel(){this.props.onFinished(!1)}initAuth(e){_.J.safeGet().deactivateAccount(void 0,e).then((e=>{s.v.warn("User's account got deactivated without confirmation: Server had no auth"),this.setState({errStr:(0,l._t)("settings|general|error_deactivate_no_auth")})})).catch((e=>{e&&401===e.httpStatus&&e.data?this.setState({authData:e.data,authEnabled:!0}):this.setState({errStr:(0,l._t)("settings|general|error_deactivate_invalid_auth")})}))}render(){let e;this.state.errStr&&(e=i.createElement("div",{className:"error"},this.state.errStr));let t=i.createElement("div",null,(0,l._t)("common|loading"));return this.state.authData&&this.state.authEnabled&&(t=i.createElement("div",null,this.state.bodyText,i.createElement(Uy.A,{matrixClient:_.J.safeGet(),authData:this.state.authData,makeRequest:this.onUIAuthComplete,onAuthFinished:this.onUIAuthFinished,onStagePhaseChange:this.onStagePhaseChange,continueText:this.state.continueText,continueKind:this.state.continueKind}))),i.createElement(J.A,{className:"mx_DeactivateAccountDialog",onFinished:this.props.onFinished,titleClass:"danger",title:(0,l._t)("settings|general|deactivate_section"),screenName:"DeactivateAccount"},i.createElement("div",{className:"mx_Dialog_content"},i.createElement("p",null,(0,l._t)("settings|general|deactivate_confirm_content")),i.createElement("ul",null,i.createElement("li",null,(0,l._t)("settings|general|deactivate_confirm_content_1")),i.createElement("li",null,(0,l._t)("settings|general|deactivate_confirm_content_2")),i.createElement("li",null,(0,l._t)("settings|general|deactivate_confirm_content_3")),i.createElement("li",null,(0,l._t)("settings|general|deactivate_confirm_content_4")),i.createElement("li",null,(0,l._t)("settings|general|deactivate_confirm_content_5"))),i.createElement("p",null,(0,l._t)("settings|general|deactivate_confirm_content_6")),i.createElement("div",{className:"mx_DeactivateAccountDialog_input_section"},i.createElement("p",null,i.createElement(Ms.A,{checked:this.state.shouldErase,onChange:this.onEraseFieldChange},(0,l._t)("settings|general|deactivate_confirm_erase_label"))),e,t)))}}var By=n("./src/components/views/auth/PassphraseField.tsx");const jy=/^[0-9 -.]+$/;const Wy=127462-"A".charCodeAt(0),zy=/^[A-Z]{2}$/,Hy=[{iso2:"GB",prefix:"44"},{iso2:"US",prefix:"1"},{iso2:"AF",prefix:"93"},{iso2:"AX",prefix:"358"},{iso2:"AL",prefix:"355"},{iso2:"DZ",prefix:"213"},{iso2:"AS",prefix:"1"},{iso2:"AD",prefix:"376"},{iso2:"AO",prefix:"244"},{iso2:"AI",prefix:"1"},{iso2:"AQ",prefix:"672"},{iso2:"AG",prefix:"1"},{iso2:"AR",prefix:"54"},{iso2:"AM",prefix:"374"},{iso2:"AW",prefix:"297"},{iso2:"AU",prefix:"61"},{iso2:"AT",prefix:"43"},{iso2:"AZ",prefix:"994"},{iso2:"BS",prefix:"1"},{iso2:"BH",prefix:"973"},{iso2:"BD",prefix:"880"},{iso2:"BB",prefix:"1"},{iso2:"BY",prefix:"375"},{iso2:"BE",prefix:"32"},{iso2:"BZ",prefix:"501"},{iso2:"BJ",prefix:"229"},{iso2:"BM",prefix:"1"},{iso2:"BT",prefix:"975"},{iso2:"BO",prefix:"591"},{iso2:"BA",prefix:"387"},{iso2:"BW",prefix:"267"},{iso2:"BV",prefix:"47"},{iso2:"BR",prefix:"55"},{iso2:"IO",prefix:"246"},{iso2:"VG",prefix:"1"},{iso2:"BN",prefix:"673"},{iso2:"BG",prefix:"359"},{iso2:"BF",prefix:"226"},{iso2:"BI",prefix:"257"},{iso2:"KH",prefix:"855"},{iso2:"CM",prefix:"237"},{iso2:"CA",prefix:"1"},{iso2:"CV",prefix:"238"},{iso2:"BQ",prefix:"599"},{iso2:"KY",prefix:"1"},{iso2:"CF",prefix:"236"},{iso2:"TD",prefix:"235"},{iso2:"CL",prefix:"56"},{iso2:"CN",prefix:"86"},{iso2:"CX",prefix:"61"},{iso2:"CC",prefix:"61"},{iso2:"CO",prefix:"57"},{iso2:"KM",prefix:"269"},{iso2:"CG",prefix:"242"},{iso2:"CD",prefix:"243"},{iso2:"CK",prefix:"682"},{iso2:"CR",prefix:"506"},{iso2:"HR",prefix:"385"},{iso2:"CU",prefix:"53"},{iso2:"CW",prefix:"599"},{iso2:"CY",prefix:"357"},{iso2:"CZ",prefix:"420"},{iso2:"CI",prefix:"225"},{iso2:"DK",prefix:"45"},{iso2:"DJ",prefix:"253"},{iso2:"DM",prefix:"1"},{iso2:"DO",prefix:"1"},{iso2:"EC",prefix:"593"},{iso2:"EG",prefix:"20"},{iso2:"SV",prefix:"503"},{iso2:"GQ",prefix:"240"},{iso2:"ER",prefix:"291"},{iso2:"EE",prefix:"372"},{iso2:"ET",prefix:"251"},{iso2:"FK",prefix:"500"},{iso2:"FO",prefix:"298"},{iso2:"FJ",prefix:"679"},{iso2:"FI",prefix:"358"},{iso2:"FR",prefix:"33"},{iso2:"GF",prefix:"594"},{iso2:"PF",prefix:"689"},{iso2:"TF",prefix:"262"},{iso2:"GA",prefix:"241"},{iso2:"GM",prefix:"220"},{iso2:"GE",prefix:"995"},{iso2:"DE",prefix:"49"},{iso2:"GH",prefix:"233"},{iso2:"GI",prefix:"350"},{iso2:"GR",prefix:"30"},{iso2:"GL",prefix:"299"},{iso2:"GD",prefix:"1"},{iso2:"GP",prefix:"590"},{iso2:"GU",prefix:"1"},{iso2:"GT",prefix:"502"},{iso2:"GG",prefix:"44"},{iso2:"GN",prefix:"224"},{iso2:"GW",prefix:"245"},{iso2:"GY",prefix:"592"},{iso2:"HT",prefix:"509"},{iso2:"HM",prefix:"672"},{iso2:"HN",prefix:"504"},{iso2:"HK",prefix:"852"},{iso2:"HU",prefix:"36"},{iso2:"IS",prefix:"354"},{iso2:"IN",prefix:"91"},{iso2:"ID",prefix:"62"},{iso2:"IR",prefix:"98"},{iso2:"IQ",prefix:"964"},{iso2:"IE",prefix:"353"},{iso2:"IM",prefix:"44"},{iso2:"IL",prefix:"972"},{iso2:"IT",prefix:"39"},{iso2:"JM",prefix:"1"},{iso2:"JP",prefix:"81"},{iso2:"JE",prefix:"44"},{iso2:"JO",prefix:"962"},{iso2:"KZ",prefix:"7"},{iso2:"KE",prefix:"254"},{iso2:"KI",prefix:"686"},{iso2:"XK",prefix:"383"},{iso2:"KW",prefix:"965"},{iso2:"KG",prefix:"996"},{iso2:"LA",prefix:"856"},{iso2:"LV",prefix:"371"},{iso2:"LB",prefix:"961"},{iso2:"LS",prefix:"266"},{iso2:"LR",prefix:"231"},{iso2:"LY",prefix:"218"},{iso2:"LI",prefix:"423"},{iso2:"LT",prefix:"370"},{iso2:"LU",prefix:"352"},{iso2:"MO",prefix:"853"},{iso2:"MK",prefix:"389"},{iso2:"MG",prefix:"261"},{iso2:"MW",prefix:"265"},{iso2:"MY",prefix:"60"},{iso2:"MV",prefix:"960"},{iso2:"ML",prefix:"223"},{iso2:"MT",prefix:"356"},{iso2:"MH",prefix:"692"},{iso2:"MQ",prefix:"596"},{iso2:"MR",prefix:"222"},{iso2:"MU",prefix:"230"},{iso2:"YT",prefix:"262"},{iso2:"MX",prefix:"52"},{iso2:"FM",prefix:"691"},{iso2:"MD",prefix:"373"},{iso2:"MC",prefix:"377"},{iso2:"MN",prefix:"976"},{iso2:"ME",prefix:"382"},{iso2:"MS",prefix:"1"},{iso2:"MA",prefix:"212"},{iso2:"MZ",prefix:"258"},{iso2:"MM",prefix:"95"},{iso2:"NA",prefix:"264"},{iso2:"NR",prefix:"674"},{iso2:"NP",prefix:"977"},{iso2:"NL",prefix:"31"},{iso2:"NC",prefix:"687"},{iso2:"NZ",prefix:"64"},{iso2:"NI",prefix:"505"},{iso2:"NE",prefix:"227"},{iso2:"NG",prefix:"234"},{iso2:"NU",prefix:"683"},{iso2:"NF",prefix:"672"},{iso2:"KP",prefix:"850"},{iso2:"MP",prefix:"1"},{iso2:"NO",prefix:"47"},{iso2:"OM",prefix:"968"},{iso2:"PK",prefix:"92"},{iso2:"PW",prefix:"680"},{iso2:"PS",prefix:"970"},{iso2:"PA",prefix:"507"},{iso2:"PG",prefix:"675"},{iso2:"PY",prefix:"595"},{iso2:"PE",prefix:"51"},{iso2:"PH",prefix:"63"},{iso2:"PN",prefix:"870"},{iso2:"PL",prefix:"48"},{iso2:"PT",prefix:"351"},{iso2:"PR",prefix:"1"},{iso2:"QA",prefix:"974"},{iso2:"RO",prefix:"40"},{iso2:"RU",prefix:"7"},{iso2:"RW",prefix:"250"},{iso2:"RE",prefix:"262"},{iso2:"WS",prefix:"685"},{iso2:"SM",prefix:"378"},{iso2:"SA",prefix:"966"},{iso2:"SN",prefix:"221"},{iso2:"RS",prefix:"381 p"},{iso2:"SC",prefix:"248"},{iso2:"SL",prefix:"232"},{iso2:"SG",prefix:"65"},{iso2:"SX",prefix:"1"},{iso2:"SK",prefix:"421"},{iso2:"SI",prefix:"386"},{iso2:"SB",prefix:"677"},{iso2:"SO",prefix:"252"},{iso2:"ZA",prefix:"27"},{iso2:"GS",prefix:"500"},{iso2:"KR",prefix:"82"},{iso2:"SS",prefix:"211"},{iso2:"ES",prefix:"34"},{iso2:"LK",prefix:"94"},{iso2:"BL",prefix:"590"},{iso2:"SH",prefix:"290 n"},{iso2:"KN",prefix:"1"},{iso2:"LC",prefix:"1"},{iso2:"MF",prefix:"590"},{iso2:"PM",prefix:"508"},{iso2:"VC",prefix:"1"},{iso2:"SD",prefix:"249"},{iso2:"SR",prefix:"597"},{iso2:"SJ",prefix:"47"},{iso2:"SZ",prefix:"268"},{iso2:"SE",prefix:"46"},{iso2:"CH",prefix:"41"},{iso2:"SY",prefix:"963"},{iso2:"ST",prefix:"239"},{iso2:"TW",prefix:"886"},{iso2:"TJ",prefix:"992"},{iso2:"TZ",prefix:"255"},{iso2:"TH",prefix:"66"},{iso2:"TL",prefix:"670"},{iso2:"TG",prefix:"228"},{iso2:"TK",prefix:"690"},{iso2:"TO",prefix:"676"},{iso2:"TT",prefix:"1"},{iso2:"TN",prefix:"216"},{iso2:"TR",prefix:"90"},{iso2:"TM",prefix:"993"},{iso2:"TC",prefix:"1"},{iso2:"TV",prefix:"688"},{iso2:"VI",prefix:"1"},{iso2:"UG",prefix:"256"},{iso2:"UA",prefix:"380"},{iso2:"AE",prefix:"971"},{iso2:"UY",prefix:"598"},{iso2:"UZ",prefix:"998"},{iso2:"VU",prefix:"678"},{iso2:"VA",prefix:"39"},{iso2:"VE",prefix:"58"},{iso2:"VN",prefix:"84"},{iso2:"WF",prefix:"681"},{iso2:"EH",prefix:"212"},{iso2:"YE",prefix:"967"},{iso2:"ZM",prefix:"260"},{iso2:"ZW",prefix:"263"}];class Ky extends i.PureComponent{constructor(...e){super(...e),(0,v.A)(this,"validate",(0,xm.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,l._t)(this.props.labelRequired)},{key:"email",test:({value:e})=>!e||$_.X(e),invalid:()=>(0,l._t)(this.props.labelInvalid)}]})),(0,v.A)(this,"onValidate",(async e=>{let t=this.validate;this.props.validationRules&&(t=this.props.validationRules);const n=await t(e);return this.props.onValidate&&this.props.onValidate(n),n}))}render(){return i.createElement(ks.A,{id:this.props.id,ref:this.props.fieldRef,type:"text",label:(0,l._t)(this.props.label),value:this.props.value,autoFocus:this.props.autoFocus,onChange:this.props.onChange,onValidate:this.onValidate,tooltipAlignment:this.props.tooltipAlignment})}}(0,v.A)(Ky,"defaultProps",{label:(0,l.AO)("auth|email_field_label"),labelRequired:(0,l.AO)("auth|email_field_label_required"),labelInvalid:(0,l.AO)("auth|email_field_label_invalid")});const Jy=Ky,Gy=({onFinished:e})=>{const[t,n]=(0,i.useState)(""),s=(0,i.useRef)(null),o=async n=>{if(n.preventDefault(),s.current){if(t){if(!await s.current.validate({}))return s.current.focus(),void s.current.validate({focused:!0})}e(!0,t)}};return i.createElement(J.A,{title:(0,l._t)("auth|registration|continue_without_email_title"),className:"mx_RegistrationEmailPromptDialog",contentId:"mx_RegistrationEmailPromptDialog",onFinished:()=>e(!1),fixedWidth:!1},i.createElement("div",{className:"mx_Dialog_content",id:"mx_RegistrationEmailPromptDialog"},i.createElement("p",null,(0,l._t)("auth|registration|continue_without_email_description",{},{b:e=>i.createElement("strong",null,e)})),i.createElement("form",{onSubmit:o},i.createElement(Jy,{fieldRef:s,autoFocus:!0,label:(0,l.AO)("auth|registration|continue_without_email_field_label"),value:t,onChange:e=>{const t=e.target;n(t.value)}}))),i.createElement(ot.A,{primaryButton:(0,l._t)("action|continue"),onPrimaryButtonClick:o,hasCancel:!1}))};function $y(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}class qy extends i.Component{constructor(e){var t;super(e),(0,v.A)(this,"defaultCountry",void 0),(0,v.A)(this,"countries",void 0),(0,v.A)(this,"countryMap",void 0),(0,v.A)(this,"onSearchChange",(e=>{this.setState({searchQuery:e})})),(0,v.A)(this,"onOptionChange",(e=>{this.props.onOptionChange(this.countryMap.get(e))})),(0,v.A)(this,"getShortOption",(e=>{if(!this.props.isSmall)return;let t;return this.props.showPrefix&&(t="+"+this.countryMap.get(e).prefix),i.createElement("span",{className:"mx_CountryDropdown_shortOption"},this.flagImgForIso2(e),t)}));const n=new Intl.DisplayNames([(0,l.mf)()],{type:"region"});let s;this.countries=Hy.map((e=>{var t;return function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?$y(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):$y(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({name:null!==(t=n.of(e.iso2))&&void 0!==t?t:e.iso2},e)})),this.countryMap=new Map(this.countries.map((e=>[e.iso2,e])));const o=c.Ay.get("default_country_code");if(o){const e=this.countries.find((e=>e.iso2===o.toUpperCase()));e&&(s=e)}if(!s)try{var r,a,d;const e=new Intl.Locale(null!==(r=navigator.language)&&void 0!==r?r:navigator.languages[0]),t=null!==(a=null!==(d=e.region)&&void 0!==d?d:e.language)&&void 0!==a?a:e.baseName,i=n.of(t).toUpperCase();s=this.countries.find((e=>e.iso2===t.toUpperCase()||e.name.toUpperCase()===i))}catch(e){console.warn("Failed to detect default locale",e)}this.defaultCountry=null!==(t=s)&&void 0!==t?t:this.countries[0],this.state={searchQuery:""}}componentDidMount(){this.props.value||this.props.onOptionChange(this.defaultCountry)}flagImgForIso2(e){return i.createElement("div",{className:"mx_Dropdown_option_emoji"},(t=e,zy.test(t)?String.fromCodePoint(...t.split("").map((e=>Wy+e.charCodeAt(0)))):""));var t}render(){let e;if(this.state.searchQuery){if(e=this.countries.filter((e=>function(e,t){return"+"===e[0]&&(e=e.slice(1)),0==t.name.toUpperCase().indexOf(e.toUpperCase())||t.iso2==e.toUpperCase()||-1!==t.prefix.indexOf(e)}(this.state.searchQuery,e))),2==this.state.searchQuery.length&&this.countryMap.has(this.state.searchQuery.toUpperCase())){const t=this.countryMap.get(this.state.searchQuery.toUpperCase());e=e.filter((e=>e.iso2!=t.iso2)),e.unshift(t)}}else e=this.countries;const t=e.map((e=>i.createElement("div",{className:"mx_CountryDropdown_option",key:e.iso2},this.flagImgForIso2(e.iso2),e.name," (+",e.prefix,")"))),n=this.props.value||this.defaultCountry.iso2;return i.createElement(Ma.A,{id:"mx_CountryDropdown",className:this.props.className+" mx_CountryDropdown",onOptionChange:this.onOptionChange,onSearchChange:this.onSearchChange,menuWidth:298,getShortOption:this.getShortOption,value:n,searchEnabled:!0,disabled:this.props.disabled,label:(0,l._t)("auth|country_dropdown"),autoComplete:"tel-country-code"},t)}}var Yy=n("./src/components/views/auth/PassphraseConfirmField.tsx");let Qy,Xy,Zy,eb,tb;var nb=function(e){return e.Email="field_email",e.PhoneNumber="field_phone_number",e.Username="field_username",e.Password="field_password",e.PasswordConfirm="field_password_confirm",e}(nb||{}),ib=function(e){return e[e.Unknown=0]="Unknown",e[e.Available=1]="Available",e[e.Unavailable=2]="Unavailable",e[e.Error=3]="Error",e[e.Invalid=4]="Invalid",e}(ib||{});Qy=nb.Email,Xy=nb.Password,Zy=nb.PasswordConfirm,eb=nb.Username,tb=nb.PhoneNumber;class sb extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,Qy,null),(0,v.A)(this,Xy,null),(0,v.A)(this,Zy,null),(0,v.A)(this,eb,null),(0,v.A)(this,tb,null),(0,v.A)(this,"onSubmit",(async e=>{if(e.preventDefault(),e.persist(),!this.props.canSubmit)return;if(await this.verifyFieldsBeforeSubmit())if(""===this.state.email){if(!this.showEmail())return void this.doSubmit(e);k.Ay.createDialog(Gy,{onFinished:async(t,n)=>{t&&void 0!==n&&this.setState({email:n},(()=>{this.doSubmit(e)}))}})}else this.doSubmit(e)})),(0,v.A)(this,"onEmailChange",(e=>{this.setState({email:e.target.value.trim()})})),(0,v.A)(this,"onEmailValidate",(e=>{this.markFieldValid(nb.Email,!!e.valid)})),(0,v.A)(this,"validateEmailRules",(0,xm.A)({description:()=>(0,l._t)("auth|reset_password_email_field_description"),hideDescriptionIfValid:!0,rules:[{key:"required",test({value:e,allowEmpty:t}){return t||!this.authStepIsRequired("m.login.email.identity")||!!e},invalid:()=>(0,l._t)("auth|reset_password_email_field_required_invalid")},{key:"email",test:({value:e})=>!e||$_.X(e),invalid:()=>(0,l._t)("auth|email_field_label_invalid")}]})),(0,v.A)(this,"onPasswordChange",(e=>{this.setState({password:e.target.value})})),(0,v.A)(this,"onPasswordValidate",(e=>{this.markFieldValid(nb.Password,!!e.valid)})),(0,v.A)(this,"onPasswordConfirmChange",(e=>{this.setState({passwordConfirm:e.target.value})})),(0,v.A)(this,"onPasswordConfirmValidate",(e=>{this.markFieldValid(nb.PasswordConfirm,!!e.valid)})),(0,v.A)(this,"onPhoneCountryChange",(e=>{this.setState({phoneCountry:e.iso2})})),(0,v.A)(this,"onPhoneNumberChange",(e=>{this.setState({phoneNumber:e.target.value})})),(0,v.A)(this,"onPhoneNumberValidate",(async e=>{const t=await this.validatePhoneNumberRules(e);return this.markFieldValid(nb.PhoneNumber,!!t.valid),t})),(0,v.A)(this,"validatePhoneNumberRules",(0,xm.A)({description:()=>(0,l._t)("auth|msisdn_field_description"),hideDescriptionIfValid:!0,rules:[{key:"required",test({value:e,allowEmpty:t}){return t||!this.authStepIsRequired("m.login.msisdn")||!!e},invalid:()=>(0,l._t)("auth|registration_msisdn_field_required_invalid")},{key:"email",test:({value:e})=>{return!e||(t=e,jy.test(t));var t},invalid:()=>(0,l._t)("auth|msisdn_field_number_invalid")}]})),(0,v.A)(this,"onUsernameChange",(e=>{this.setState({username:e.target.value})})),(0,v.A)(this,"onUsernameValidate",(async e=>{const t=await this.validateUsernameRules(e);return this.markFieldValid(nb.Username,!!t.valid),t})),(0,v.A)(this,"validateUsernameRules",(0,xm.A)({description:(e,t)=>t.every((({key:e,valid:t})=>"available"===e||t))?null:(0,l._t)("auth|registration_username_validation"),hideDescriptionIfValid:!0,async deriveData({value:e}){if(!e)return ib.Unknown;try{return await this.props.matrixClient.isUsernameAvailable(e)?ib.Available:ib.Unavailable}catch(e){return e instanceof o.MatrixError&&"M_INVALID_USERNAME"===e.errcode?ib.Invalid:ib.Error}},rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,l._t)("auth|username_field_required_invalid")},{key:"safeLocalpart",test:({value:e},t)=>(!e||Pr.test(e))&&t!==ib.Invalid,invalid:()=>(0,l._t)("room_settings|general|alias_field_safe_localpart_invalid")},{key:"available",final:!0,test:async({value:e},t)=>!e||t===ib.Available,invalid:e=>e===ib.Error?(0,l._t)("auth|registration_username_unable_check"):(0,l._t)("auth|registration_username_in_use")}]})),this.state={fieldValid:{},phoneCountry:this.props.defaultPhoneCountry,username:this.props.defaultUsername||"",email:this.props.defaultEmail||"",phoneNumber:this.props.defaultPhoneNumber||"",password:this.props.defaultPassword||"",passwordConfirm:this.props.defaultPassword||""}}doSubmit(e){B.Vo.instance.setAuthenticationType("Password");const t=this.state.email.trim(),n=this.props.onRegisterClick({username:this.state.username.trim(),password:this.state.password.trim(),email:t,phoneCountry:this.state.phoneCountry,phoneNumber:this.state.phoneNumber});n&&(e.target.disabled=!0,n.finally((function(){e.target.disabled=!1})))}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[nb.Username,nb.Password,nb.PasswordConfirm,nb.Email,nb.PhoneNumber];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise((e=>this.setState({},e))),this.allFieldsValid())return!0;const n=this.findFirstInvalidField(t);return!n||(n.focus(),n.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){return Object.values(this.state.fieldValid).every(Boolean)}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}markFieldValid(e,t){const{fieldValid:n}=this.state;n[e]=t,this.setState({fieldValid:n})}authStepIsRequired(e){return this.props.flows.every((t=>t.stages.includes(e)))}authStepIsUsed(e){return this.props.flows.some((t=>t.stages.includes(e)))}showEmail(){return!(c.Ay.get().disable_3pid_login||!this.authStepIsUsed("m.login.email.identity"))}showPhoneNumber(){return!(c.Ay.get().disable_3pid_login||!this.authStepIsUsed("m.login.msisdn"))}tooltipAlignment(){if(this.props.mobileRegister)return"bottom"}renderEmail(){if(!this.showEmail())return null;const e=this.authStepIsRequired("m.login.email.identity")?(0,l.AO)("auth|email_field_label"):(0,l.AO)("auth|registration|continue_without_email_field_label");return i.createElement(Jy,{fieldRef:e=>this[nb.Email]=e,label:e,value:this.state.email,validationRules:this.validateEmailRules.bind(this),onChange:this.onEmailChange,onValidate:this.onEmailValidate,tooltipAlignment:this.tooltipAlignment()})}renderPassword(){return i.createElement(By.A,{id:"mx_RegistrationForm_password",fieldRef:e=>this[nb.Password]=e,minScore:3,value:this.state.password,onChange:this.onPasswordChange,onValidate:this.onPasswordValidate,userInputs:[this.state.username],tooltipAlignment:this.tooltipAlignment()})}renderPasswordConfirm(){return i.createElement(Yy.A,{id:"mx_RegistrationForm_passwordConfirm",fieldRef:e=>this[nb.PasswordConfirm]=e,autoComplete:"new-password",value:this.state.passwordConfirm,password:this.state.password,onChange:this.onPasswordConfirmChange,onValidate:this.onPasswordConfirmValidate,tooltipAlignment:this.tooltipAlignment()})}renderPhoneNumber(){if(!this.showPhoneNumber())return null;const e=this.authStepIsRequired("m.login.msisdn")?(0,l._t)("auth|phone_label"):(0,l._t)("auth|phone_optional_label"),t=i.createElement(qy,{value:this.state.phoneCountry,isSmall:!0,showPrefix:!0,onOptionChange:this.onPhoneCountryChange});return i.createElement(ks.A,{ref:e=>this[nb.PhoneNumber]=e,type:"text",label:e,value:this.state.phoneNumber,prefixComponent:t,onChange:this.onPhoneNumberChange,onValidate:this.onPhoneNumberValidate})}renderUsername(){return i.createElement(ks.A,{id:"mx_RegistrationForm_username",ref:e=>this[nb.Username]=e,type:"text",autoFocus:!0,label:(0,l._t)("common|username"),placeholder:(0,l._t)("common|username"),value:this.state.username,onChange:this.onUsernameChange,onValidate:this.onUsernameValidate,tooltipAlignment:this.tooltipAlignment(),autoCorrect:"off",autoCapitalize:"none"})}render(){const e=i.createElement("input",{className:"mx_Login_submit",type:"submit",value:(0,l._t)("action|register"),disabled:!this.props.canSubmit});let t,n;return this.showEmail()&&(t=this.showPhoneNumber()?i.createElement("div",null,(0,l._t)("auth|email_help_text")," ",(0,l._t)("auth|email_phone_discovery_text")):i.createElement("div",null,(0,l._t)("auth|email_help_text")," ",(0,l._t)("auth|email_discovery_text"))),n=this.props.mobileRegister?i.createElement(i.Fragment,null,i.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderPassword()),i.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderPasswordConfirm())):i.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderPassword(),this.renderPasswordConfirm()),i.createElement("div",null,i.createElement("form",{onSubmit:this.onSubmit},i.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderUsername()),n,i.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderEmail(),this.renderPhoneNumber()),t,e))}}(0,v.A)(sb,"defaultProps",{onValidationChange:s.v.error,canSubmit:!0});var ob=n("./src/components/views/dialogs/InteractiveAuthDialog.tsx");function rb(e){const t=e.getIdentityServerUrl(!0);if(!t)throw new l.P7("settings|general|identity_server_not_set");return t}class ab{constructor(e){(0,v.A)(this,"sessionId",void 0),(0,v.A)(this,"submitUrl",void 0),(0,v.A)(this,"bind",!1),(0,v.A)(this,"clientSecret",void 0),(0,v.A)(this,"makeAddThreepidOnlyRequest",(e=>this.matrixClient.addThreePidOnly({sid:this.sessionId,client_secret:this.clientSecret,auth:null!=e?e:void 0}))),this.matrixClient=e,this.clientSecret=e.generateClientSecret()}async addEmailAddress(e){try{const t=await this.matrixClient.requestAdd3pidEmailToken(e,this.clientSecret,1);return this.sessionId=t.sid,t}catch(e){if(e instanceof o.MatrixError&&"M_THREEPID_IN_USE"===e.errcode)throw new l.P7("settings|general|email_address_in_use",{cause:e});throw e}}async bindEmailAddress(e){var t;this.bind=!0;const n=new dv.A,i=null!==(t=await n.getAccessToken())&&void 0!==t?t:void 0;try{const t=await this.matrixClient.requestEmailToken(e,this.clientSecret,1,void 0,i);return this.sessionId=t.sid,t}catch(e){if(e instanceof o.MatrixError&&"M_THREEPID_IN_USE"===e.errcode)throw new l.P7("settings|general|email_address_in_use",{cause:e});throw e}}async addMsisdn(e,t){try{const n=await this.matrixClient.requestAdd3pidMsisdnToken(e,t,this.clientSecret,1);return this.sessionId=n.sid,this.submitUrl=n.submit_url,n}catch(e){if(e instanceof o.MatrixError&&"M_THREEPID_IN_USE"===e.errcode)throw new l.P7("settings|general|msisdn_in_use",{cause:e});throw e}}async bindMsisdn(e,t){var n;this.bind=!0;const i=new dv.A,s=null!==(n=await i.getAccessToken())&&void 0!==n?n:void 0;try{const n=await this.matrixClient.requestMsisdnToken(e,t,this.clientSecret,1,void 0,s);return this.sessionId=n.sid,n}catch(e){if(e instanceof o.MatrixError&&"M_THREEPID_IN_USE"===e.errcode)throw new l.P7("settings|general|msisdn_in_use",{cause:e});throw e}}async checkEmailLinkClicked(){try{if(this.bind){const e=new dv.A,t=await e.getAccessToken();if(!t)throw new l.P7("settings|general|identity_server_no_token");await this.matrixClient.bindThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:rb(this.matrixClient),id_access_token:t})}else try{return await this.makeAddThreepidOnlyRequest(),[!0]}catch(t){var e;if(!(t instanceof o.MatrixError&&401===t.httpStatus&&null!==(e=t.data)&&void 0!==e&&e.flows))throw t;const n={[Fy.av.PHASE_PREAUTH]:{title:(0,l._t)("auth|uia|sso_title"),body:(0,l._t)("auth|uia|sso_body"),continueText:(0,l._t)("auth|sso"),continueKind:"primary"},[Fy.av.PHASE_POSTAUTH]:{title:(0,l._t)("settings|general|confirm_adding_email_title"),body:(0,l._t)("settings|general|confirm_adding_email_body"),continueText:(0,l._t)("action|confirm"),continueKind:"primary"}},{finished:i}=k.Ay.createDialog(ob.A,{title:(0,l._t)("settings|general|add_email_dialog_title"),matrixClient:this.matrixClient,authData:t.data,makeRequest:this.makeAddThreepidOnlyRequest,aestheticsForStagePhases:{[Fy.av.LOGIN_TYPE]:n,[Fy.av.UNSTABLE_LOGIN_TYPE]:n}});return i}}catch(e){if(e instanceof o.HTTPError&&401===e.httpStatus)throw new l.P7("settings|general|add_email_failed_verification",{cause:e});throw e}return[]}async haveMsisdnToken(e){const t=new dv.A;if(this.submitUrl)await this.matrixClient.submitMsisdnTokenOtherUrl(this.submitUrl,this.sessionId,this.clientSecret,e);else{if(!this.bind)throw new l.P7("settings|general|add_msisdn_misconfigured");await this.matrixClient.submitMsisdnToken(this.sessionId,this.clientSecret,e,await t.getAccessToken())}if(this.bind)return await this.matrixClient.bindThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:rb(this.matrixClient),id_access_token:await t.getAccessToken()}),[!0];try{return await this.makeAddThreepidOnlyRequest(),[!0]}catch(e){var n;if(!(e instanceof o.MatrixError&&401===e.httpStatus&&null!==(n=e.data)&&void 0!==n&&n.flows))throw e;const t={[Fy.av.PHASE_PREAUTH]:{title:(0,l._t)("auth|uia|sso_title"),body:(0,l._t)("settings|general|add_msisdn_confirm_sso_button"),continueText:(0,l._t)("auth|sso"),continueKind:"primary"},[Fy.av.PHASE_POSTAUTH]:{title:(0,l._t)("settings|general|add_msisdn_confirm_button"),body:(0,l._t)("settings|general|add_msisdn_confirm_body"),continueText:(0,l._t)("action|confirm"),continueKind:"primary"}},{finished:i}=k.Ay.createDialog(ob.A,{title:(0,l._t)("settings|general|add_msisdn_dialog_title"),matrixClient:this.matrixClient,authData:e.data,makeRequest:this.makeAddThreepidOnlyRequest,aestheticsForStagePhases:{[Fy.av.LOGIN_TYPE]:t,[Fy.av.UNSTABLE_LOGIN_TYPE]:t}});return i}}}var lb=function(e){return e.Display="display",e.Edit="edit",e}(lb||{});class cb extends i.Component{constructor(e){super(e),(0,v.A)(this,"value",""),(0,v.A)(this,"placeholder",!1),(0,v.A)(this,"editableDiv",(0,i.createRef)()),(0,v.A)(this,"showPlaceholder",(e=>{this.editableDiv.current&&(e?(this.editableDiv.current.textContent=this.props.placeholder,this.editableDiv.current.setAttribute("class",this.props.className+" "+this.props.placeholderClassName),this.placeholder=!0,this.value=""):(this.editableDiv.current.textContent=this.value,this.editableDiv.current.setAttribute("class",this.props.className),this.placeholder=!1))})),(0,v.A)(this,"cancelEdit",(()=>{var e;this.setState({phase:lb.Display}),this.value=this.props.initialValue,this.showPlaceholder(!this.value),this.onValueChanged(!1),null===(e=this.editableDiv.current)||void 0===e||e.blur()})),(0,v.A)(this,"onValueChanged",(e=>{var t,n;null===(t=(n=this.props).onValueChanged)||void 0===t||t.call(n,this.value,e)})),(0,v.A)(this,"onKeyDown",(e=>{this.placeholder&&this.showPlaceholder(!1);if((0,_s.zM)().getAccessibilityAction(e)===Pn.bY.Enter)e.stopPropagation(),e.preventDefault()})),(0,v.A)(this,"onKeyUp",(e=>{if(e.target.textContent){if(!this.placeholder){var t;this.value=null!==(t=e.target.textContent)&&void 0!==t?t:""}}else this.showPlaceholder(!0);switch((0,_s.zM)().getAccessibilityAction(e)){case Pn.bY.Escape:this.cancelEdit();break;case Pn.bY.Enter:this.onFinish(e)}})),(0,v.A)(this,"onClickDiv",(()=>{this.props.editable&&this.setState({phase:lb.Edit})})),(0,v.A)(this,"onFocus",(e=>{const t=e.target.childNodes[0];if(t){const n=document.createRange();n.setStart(t,0),n.setEnd(t,e.target.childNodes.length);const i=window.getSelection();i.removeAllRanges(),i.addRange(n)}})),(0,v.A)(this,"onFinish",((e,t=!1)=>{const n=this,i=(0,_s.zM)().getAccessibilityAction(e)===Pn.bY.Enter||t;this.setState({phase:lb.Display},(()=>{this.value!==this.props.initialValue&&n.onValueChanged(i)}))})),(0,v.A)(this,"onBlur",(e=>{window.getSelection().removeAllRanges(),this.props.blurToCancel?this.cancelEdit():this.onFinish(e,this.props.blurToSubmit),this.showPlaceholder(!this.value)})),this.state={phase:lb.Display}}componentDidUpdate(e){e.initialValue!==this.props.initialValue&&(this.value=this.props.initialValue,this.editableDiv.current&&this.showPlaceholder(!this.value))}componentDidMount(){this.value=this.props.initialValue,this.editableDiv.current&&this.showPlaceholder(!this.value)}render(){const{className:e,editable:t,initialValue:n,label:s,labelClassName:o}=this.props;let r;return r=!t||this.state.phase===lb.Display&&(s||o)&&!this.value?i.createElement("div",{className:e+" "+o,onClick:this.onClickDiv},s||n):i.createElement("div",{ref:this.editableDiv,contentEditable:!0,className:e,onKeyDown:this.onKeyDown,onKeyUp:this.onKeyUp,onFocus:this.onFocus,onBlur:this.onBlur}),r}}(0,v.A)(cb,"defaultProps",{onValueChanged(){},initialValue:"",label:"",placeholder:"",editable:!0,className:"mx_EditableText",placeholderClassName:"mx_EditableText_placeholder",blurToSubmit:!1});class db extends i.Component{constructor(e){super(e),(0,v.A)(this,"addThreepid",void 0),(0,v.A)(this,"onEmailAddressChanged",(e=>{this.setState({emailAddress:e})})),(0,v.A)(this,"onSubmit",(()=>{const e=this.state.emailAddress;$_.X(e)?(this.addThreepid=new ab(_.J.safeGet()),this.addThreepid.addEmailAddress(e).then((()=>{k.Ay.createDialog(it.A,{title:(0,l._t)("auth|set_email|verification_pending_title"),description:(0,l._t)("auth|set_email|verification_pending_description"),button:(0,l._t)("action|continue"),onFinished:this.onEmailDialogFinished})}),(t=>{this.setState({emailBusy:!1}),s.v.error("Unable to add email address "+e+" "+t),k.Ay.createDialog(nt.A,{title:(0,l._t)("settings|general|error_add_email"),description:(0,nt.$)(t,(0,l._t)("invite|failed_generic"))})})),this.setState({emailBusy:!0})):k.Ay.createDialog(nt.A,{title:(0,l._t)("settings|general|error_invalid_email"),description:(0,l._t)("settings|general|error_invalid_email_detail")})})),(0,v.A)(this,"onCancelled",(()=>{this.props.onFinished(!1)})),(0,v.A)(this,"onEmailDialogFinished",(e=>{e?this.verifyEmailAddress():this.setState({emailBusy:!1})})),this.state={emailAddress:"",emailBusy:!1}}verifyEmailAddress(){var e;null===(e=this.addThreepid)||void 0===e||e.checkEmailLinkClicked().then((()=>{this.props.onFinished(!0)}),(e=>{this.setState({emailBusy:!1});let t=e;if(e instanceof l.P7&&(t=e.cause),t instanceof o.MatrixError&&"M_THREEPID_AUTH_FAILED"===t.errcode){const e=(0,l._t)("settings|general|error_email_verification")+" "+(0,l._t)("auth|set_email|verification_pending_description");k.Ay.createDialog(it.A,{title:(0,l._t)("auth|set_email|verification_pending_title"),description:e,button:(0,l._t)("action|continue"),onFinished:this.onEmailDialogFinished})}else s.v.error("Unable to verify email address: "+e),k.Ay.createDialog(nt.A,{title:(0,l._t)("settings|general|error_email_verification"),description:(0,nt.$)(e,(0,l._t)("invite|failed_generic"))})}))}render(){const e=this.state.emailBusy?i.createElement(se.A,null):i.createElement(cb,{initialValue:this.state.emailAddress,className:"mx_SetEmailDialog_email_input",placeholder:(0,l._t)("common|email_address"),placeholderClassName:"mx_SetEmailDialog_email_input_placeholder",blurToCancel:!1,onValueChanged:this.onEmailAddressChanged});return i.createElement(J.A,{className:"mx_SetEmailDialog",onFinished:this.onCancelled,title:this.props.title,contentId:"mx_Dialog_content"},i.createElement("div",{className:"mx_Dialog_content"},i.createElement("p",{id:"mx_Dialog_content"},(0,l._t)("auth|set_email|description")),e),i.createElement("div",{className:"mx_Dialog_buttons"},i.createElement("input",{className:"mx_Dialog_primary",type:"submit",value:(0,l._t)("action|continue"),onClick:this.onSubmit}),i.createElement("input",{type:"submit",value:(0,l._t)("action|skip"),onClick:this.onCancelled})))}}const mb="field_old_password",ub="field_new_password",hb="field_new_password_confirm";var pb=function(e){return e.Edit="edit",e.Uploading="uploading",e.Error="error",e}(pb||{});class gb extends i.Component{constructor(e){super(e),(0,v.A)(this,mb,null),(0,v.A)(this,ub,null),(0,v.A)(this,hb,null),(0,v.A)(this,"onChangeOldPassword",(e=>{this.setState({oldPassword:e.target.value})})),(0,v.A)(this,"onOldPasswordValidate",(async e=>{const t=await this.validateOldPasswordRules(e);return this.markFieldValid(mb,t.valid),t})),(0,v.A)(this,"validateOldPasswordRules",(0,xm.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,l._t)("auth|change_password_empty")}]})),(0,v.A)(this,"onChangeNewPassword",(e=>{this.setState({newPassword:e.target.value})})),(0,v.A)(this,"onNewPasswordValidate",(e=>{this.markFieldValid(ub,e.valid)})),(0,v.A)(this,"onChangeNewPasswordConfirm",(e=>{this.setState({newPasswordConfirm:e.target.value})})),(0,v.A)(this,"onNewPasswordConfirmValidate",(async e=>{const t=await this.validatePasswordConfirmRules(e);return this.markFieldValid(hb,t.valid),t})),(0,v.A)(this,"validatePasswordConfirmRules",(0,xm.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,l._t)("auth|change_password_confirm_label")},{key:"match",test({value:e}){return!e||e===this.state.newPassword},invalid:()=>(0,l._t)("auth|change_password_confirm_invalid")}]})),(0,v.A)(this,"onClickChange",(async e=>{e.preventDefault();if(!await this.verifyFieldsBeforeSubmit())return;const t=this.state.oldPassword,n=this.state.newPassword,i=this.state.newPasswordConfirm;try{return this.checkPassword(t,n,i),this.onChangePassword(t,n)}catch(e){e instanceof Error?this.props.onError(e):this.props.onError(new l.P7("auth|change_password_error",{error:String(e),cause:void 0}))}})),this.state={fieldValid:{},phase:pb.Edit,oldPassword:"",newPassword:"",newPasswordConfirm:""}}async onChangePassword(e,t){const n=_.J.safeGet();this.changePassword(n,e,t)}changePassword(e,t,n){const i={type:"m.login.password",identifier:{type:"m.id.user",user:e.credentials.userId},password:t};this.setState({phase:pb.Uploading}),e.setPassword(i,n,!1).then((()=>{if(this.props.shouldAskForEmail)return this.optionallySetEmail().then((e=>{this.props.onFinished({didSetEmail:e})}));this.props.onFinished({})}),(e=>{e instanceof Error?this.props.onError(e):this.props.onError(new l.P7("auth|change_password_error",{error:String(e),cause:void 0}))})).finally((()=>{this.setState({phase:pb.Edit,oldPassword:"",newPassword:"",newPasswordConfirm:""})}))}checkPassword(e,t,n){if(t!==n)throw new l.P7("auth|change_password_mismatch");if(!t||0===t.length)throw new l.P7("auth|change_password_empty")}optionallySetEmail(){return k.Ay.createDialog(db,{title:(0,l._t)("auth|set_email_prompt")}).finished.then((([e])=>!!e))}markFieldValid(e,t){const{fieldValid:n}=this.state;n[e]=t,this.setState({fieldValid:n})}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[mb,ub,hb];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise((e=>this.setState({},e))),this.allFieldsValid())return!0;const n=this.findFirstInvalidField(t);return!n||(n.focus(),n.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){return Object.values(this.state.fieldValid).every(Boolean)}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}render(){const e=this.props.rowClassName,t=this.props.buttonClassName;switch(this.state.phase){case pb.Edit:return i.createElement("form",{className:this.props.className,onSubmit:this.onClickChange},i.createElement("div",{className:e},i.createElement(ks.A,{ref:e=>this[mb]=e,type:"password",label:(0,l._t)("auth|change_password_current_label"),value:this.state.oldPassword,onChange:this.onChangeOldPassword,onValidate:this.onOldPasswordValidate})),i.createElement("div",{className:e},i.createElement(By.A,{fieldRef:e=>this[ub]=e,type:"password",label:(0,l.AO)("auth|change_password_new_label"),minScore:3,value:this.state.newPassword,autoFocus:this.props.autoFocusNewPasswordInput,onChange:this.onChangeNewPassword,onValidate:this.onNewPasswordValidate,autoComplete:"new-password"})),i.createElement("div",{className:e},i.createElement(ks.A,{ref:e=>this[hb]=e,type:"password",label:(0,l._t)("auth|change_password_confirm_label"),value:this.state.newPasswordConfirm,onChange:this.onChangeNewPasswordConfirm,onValidate:this.onNewPasswordConfirmValidate,autoComplete:"new-password"})),i.createElement(ie.A,{className:t,kind:this.props.buttonKind,onClick:this.onClickChange},this.props.buttonLabel||(0,l._t)("auth|change_password_action")));case pb.Uploading:return i.createElement("div",{className:"mx_Dialog_content"},i.createElement(se.A,null))}}}(0,v.A)(gb,"defaultProps",{onFinished(){},onError(){},confirm:!0});const vb=({mode:e,threepid:t,onChange:n,disabled:r})=>{const[a,c]=(0,i.useState)(!1),d=(0,Hn.nH)(),m=(0,i.useRef)(),[u,h]=(0,i.useState)(!1),[p,g]=(0,i.useState)(!1),[v,_]=(0,i.useState)(""),f=(0,i.useCallback)((e=>{e.stopPropagation(),e.preventDefault(),c(!0)}),[]),E=(0,i.useCallback)((e=>{e.stopPropagation(),e.preventDefault(),c(!1)}),[]),y=(0,i.useCallback)((e=>{e.stopPropagation(),e.preventDefault(),d.deleteThreePid(t.medium,t.address).then((()=>n(t))).catch((e=>{var t;s.v.error("Unable to remove contact information: "+e),k.Ay.createDialog(nt.A,{title:(0,l._t)("settings|general|error_remove_3pid"),description:null!==(t=null==e?void 0:e.message)&&void 0!==t?t:(0,l._t)("invite|failed_generic")})}))}),[d,t,n]),b=(0,i.useCallback)((async({bind:e,label:i,errorTitle:r})=>{try{e?(m.current=new ab(d),g(!0),t.medium===o.ThreepidMedium.Email?await m.current.bindEmailAddress(t.address):await m.current.bindMsisdn(null,`+${t.address}`),g(!1),h(!0)):(await d.unbindThreePid(t.medium,t.address),n(t))}catch(e){s.v.error(`changeBinding: Unable to ${i} email address ${t.address}`,e),h(!1),g(!1),m.current=void 0,k.Ay.createDialog(nt.A,{title:r,description:(0,nt.$)(e,(0,l._t)("invite|failed_generic"))})}}),[d,t,n]),w=(0,i.useCallback)((e=>{e.stopPropagation(),e.preventDefault(),b({bind:!1,label:"revoke",errorTitle:"email"===t.medium?(0,l._t)("settings|general|error_revoke_email_discovery"):(0,l._t)("settings|general|error_revoke_msisdn_discovery")}).then()}),[b,t.medium]),S=(0,i.useCallback)((e=>{e.stopPropagation(),e.preventDefault(),b({bind:!0,label:"share",errorTitle:"email"===t.medium?(0,l._t)("settings|general|error_share_email_discovery"):(0,l._t)("settings|general|error_share_msisdn_discovery")}).then()}),[b,t.medium]),A=(0,i.useCallback)((async e=>{e.stopPropagation(),e.preventDefault(),g(!0);try{var i,r;if(t.medium===o.ThreepidMedium.Email)await(null===(i=m.current)||void 0===i?void 0:i.checkEmailLinkClicked());else await(null===(r=m.current)||void 0===r?void 0:r.haveMsisdnToken(v));h(!1),n(t),m.current=void 0}catch(e){s.v.error("Unable to verify threepid:",e);let n=e;e instanceof l.P7&&(n=e.cause),n instanceof o.MatrixError&&"M_THREEPID_AUTH_FAILED"===n.errcode?k.Ay.createDialog(nt.A,{title:"email"===t.medium?(0,l._t)("settings|general|email_not_verified"):(0,l._t)("settings|general|error_msisdn_verification"),description:"email"===t.medium?(0,l._t)("settings|general|email_verification_instructions"):(0,nt.$)(e,(0,l._t)("invite|failed_generic"))}):(s.v.error("Unable to verify email address: "+e),k.Ay.createDialog(nt.A,{title:(0,l._t)("settings|general|error_email_verification"),description:(0,nt.$)(e,(0,l._t)("invite|failed_generic"))}))}finally{g(!1)}}),[v,n,t]),C=(0,i.useCallback)((e=>{_(e.target.value)}),[]);return a?i.createElement("div",{className:"mx_AddRemoveThreepids_existing"},i.createElement("span",{className:"mx_AddRemoveThreepids_existing_promptText"},t.medium===o.ThreepidMedium.Email?(0,l._t)("settings|general|remove_email_prompt",{email:t.address}):(0,l._t)("settings|general|remove_msisdn_prompt",{phone:t.address})),i.createElement(ie.A,{onClick:y,kind:"danger_sm",className:"mx_AddRemoveThreepids_existing_button"},(0,l._t)("action|remove")),i.createElement(ie.A,{onClick:E,kind:"link_sm",className:"mx_AddRemoveThreepids_existing_button"},(0,l._t)("action|cancel"))):u?t.medium===o.ThreepidMedium.Email?i.createElement("div",{className:"mx_EmailAddressesPhoneNumbers_verify"},i.createElement("span",{className:"mx_EmailAddressesPhoneNumbers_verify_instructions"},(0,l._t)("settings|general|discovery_email_verification_instructions")),i.createElement(ie.A,{className:"mx_EmailAddressesPhoneNumbers_existing_button",kind:"primary_sm",onClick:A,disabled:p},(0,l._t)("action|complete"))):i.createElement("div",{className:"mx_EmailAddressesPhoneNumbers_verify"},i.createElement("span",{className:"mx_EmailAddressesPhoneNumbers_verify_instructions"},(0,l._t)("settings|general|msisdn_verification_instructions")),i.createElement("form",{onSubmit:A,autoComplete:"off",noValidate:!0},i.createElement(ks.A,{type:"text",label:(0,l._t)("settings|general|msisdn_verification_field_label"),autoComplete:"off",disabled:p,value:v,onChange:C}))):i.createElement("div",{className:"mx_AddRemoveThreepids_existing"},i.createElement("span",{className:"mx_AddRemoveThreepids_existing_address"},t.address),i.createElement(ie.A,{onClick:"hs"===e?f:t.bound?w:S,kind:"hs"===e||t.bound?"danger_sm":"primary_sm",disabled:r},"hs"===e?(0,l._t)("action|remove"):t.bound?(0,l._t)("action|revoke"):(0,l._t)("action|share")))};const _b=({medium:e,disabled:t,onChange:n})=>{const r=(0,i.useRef)(),[a,c]=(0,i.useState)(""),[d,m]=(0,i.useState)(""),[u,h]=(0,i.useState)(""),[p,g]=(0,i.useState)(!1),[v,_]=(0,i.useState)(!1),[f,E]=(0,i.useState)(""),y=(0,Hn.nH)(),b=(0,i.useCallback)((e=>{m(e.iso2)}),[]),w=(0,i.useCallback)((t=>{var i,a;if(t.stopPropagation(),t.preventDefault(),!r.current)return;_(!0);("email"===e?null===(i=r.current)||void 0===i?void 0:i.checkEmailLinkClicked():null===(a=r.current)||void 0===a?void 0:a.haveMsisdnToken(u)).then((([e])=>{e&&(r.current=void 0,g(!1),c(""),n()),_(!1)})).catch((t=>{s.v.error("Unable to verify 3pid: ",t),_(!1);let n=t;t instanceof l.P7&&(n=t.cause),n instanceof o.MatrixError&&"M_THREEPID_AUTH_FAILED"===n.errcode?k.Ay.createDialog(nt.A,{title:"email"===e?(0,l._t)("settings|general|email_not_verified"):(0,l._t)("settings|general|error_msisdn_verification"),description:(0,l._t)("settings|general|email_verification_instructions")}):k.Ay.createDialog(nt.A,{title:"email"==e?(0,l._t)("settings|general|error_email_verification"):(0,l._t)("settings|general|error_msisdn_verification"),description:(0,nt.$)(t,(0,l._t)("invite|failed_generic"))})}))}),[n,e,u]),S=(0,i.useCallback)((e=>{c(e.target.value)}),[]),A=(0,i.useCallback)((t=>{if(t.stopPropagation(),t.preventDefault(),!a)return;if("email"===e&&!(0,$_.X)(a))return void k.Ay.createDialog(nt.A,{title:(0,l._t)("settings|general|error_invalid_email"),description:(0,l._t)("settings|general|error_invalid_email_detail")});r.current=new ab(y),g(!0),_(!0);("email"===e?r.current.addEmailAddress(a):r.current.addMsisdn(d,a)).then((e=>{_(!1),function(e){return void 0!==e.msisdn}(e)&&E(e.msisdn)})).catch((t=>{s.v.error(`Unable to add threepid ${a}`,t),g(!1),_(!1),r.current=void 0,k.Ay.createDialog(nt.A,{title:"email"===e?(0,l._t)("settings|general|error_add_email"):(0,l._t)("common|error"),description:(0,nt.$)(t,(0,l._t)("invite|failed_generic"))})}))}),[y,d,a,e]),C=(0,i.useCallback)((e=>{h(e.target.value)}),[]);if(p&&"email"===e)return i.createElement("div",null,i.createElement("div",null,(0,l._t)("settings|general|add_email_instructions")),i.createElement(ie.A,{onClick:w,kind:"primary",disabled:v},(0,l._t)("action|continue")));if(p)return i.createElement("div",null,i.createElement("div",null,(0,l._t)("settings|general|add_msisdn_instructions",{msisdn:f}),i.createElement("br",null)),i.createElement("form",{onSubmit:w,autoComplete:"off",noValidate:!0},i.createElement(ks.A,{type:"text",label:(0,l._t)("settings|general|msisdn_verification_field_label"),autoComplete:"off",disabled:t||v,value:u,onChange:C}),i.createElement(ie.A,{onClick:w,kind:"primary",disabled:t||v||0===u.length},(0,l._t)("action|continue"))));const x="msisdn"===e?i.createElement(qy,{onOptionChange:b,className:"mx_PhoneNumbers_country",value:d,disabled:p,isSmall:!0,showPrefix:!0}):void 0;return i.createElement("form",{onSubmit:A,autoComplete:"off",noValidate:!0},i.createElement(ks.A,{type:"text",label:"email"===e?(0,l._t)("settings|general|email_address_label"):(0,l._t)("settings|general|msisdn_label"),autoComplete:"email"===e?"email":"tel-national",disabled:t||p,value:a,onChange:S,prefixComponent:x}),i.createElement(ie.A,{onClick:A,kind:"primary",disabled:t},(0,l._t)("action|add")))},fb=({mode:e,medium:t,threepids:n,disabled:s,onChange:o,isLoading:r})=>{if(r)return i.createElement(oa.A,null);const a=n.map((t=>i.createElement(vb,{mode:e,threepid:t,onChange:o,key:t.address,disabled:s})));return i.createElement(i.Fragment,null,a,"hs"===e&&i.createElement(_b,{medium:t,disabled:s,onChange:o}))},Eb=({error:e,loadingState:t,children:n})=>"loading"===t?i.createElement(oa.A,null):"error"===t?i.createElement(Cy.F,{type:"critical",title:(0,l._t)("common|error")},e):i.createElement(i.Fragment,null,n),yb=({canMake3pidChanges:e})=>{const[t,n]=(0,i.useState)(),[s,r]=(0,i.useState)(),[a,c]=(0,i.useState)("loading"),d=(0,Hn.nH)(),m=(0,i.useCallback)((async()=>{try{const e=await d.getThreePids();n(e.threepids.filter((e=>e.medium===o.ThreepidMedium.Email))),r(e.threepids.filter((e=>e.medium===o.ThreepidMedium.Phone))),c("loaded")}catch{c("error")}}),[d]);(0,i.useEffect)((()=>{m().then()}),[m]);const u=(0,i.useCallback)((()=>{m().then()}),[m]),h=(0,i.useCallback)((()=>{m().then()}),[m]);return M.A.getValue(He.f.ThirdPartyID)?i.createElement("div",null,i.createElement("h2",null,(0,l._t)("settings|general|personal_info")),i.createElement(Vs.P,{heading:(0,l._t)("settings|general|emails_heading"),stretchContent:!0},i.createElement(Eb,{error:(0,l._t)("settings|general|unable_to_load_emails"),loadingState:a},i.createElement(fb,{mode:"hs",medium:o.ThreepidMedium.Email,threepids:t,onChange:u,disabled:!e,isLoading:"loading"===a}))),i.createElement(Vs.P,{heading:(0,l._t)("settings|general|msisdns_heading"),stretchContent:!0},i.createElement(Eb,{error:(0,l._t)("settings|general|unable_to_load_msisdns"),loadingState:a},i.createElement(fb,{mode:"hs",medium:o.ThreepidMedium.Phone,threepids:s,onChange:h,disabled:!e,isLoading:"loading"===a})))):null},bb=({canChangePassword:e,onPasswordChangeError:t,onPasswordChanged:n})=>e?i.createElement(i.Fragment,null,i.createElement(Vs.P,{heading:(0,l._t)("settings|general|account_section"),stretchContent:!0},i.createElement(Vs.s,null,(0,l._t)("settings|general|password_change_section")),i.createElement(gb,{rowClassName:"",buttonKind:"primary",onError:t,onFinished:n}))):i.createElement(i.Fragment,null),wb=({onDeactivateClicked:e})=>i.createElement(Fs.X,{heading:(0,l._t)("settings|general|deactivate_section")},i.createElement(Vs.P,{heading:(0,l._t)("settings|general|account_management_section"),description:(0,l._t)("settings|general|deactivate_warning")},i.createElement(ie.A,{onClick:e,kind:"danger"},(0,l._t)("settings|general|deactivate_section")))),Sb=({closeSettingsFn:e})=>{const[t,n]=i.useState(),[r,a]=i.useState(!1),[c,d]=i.useState(!1),[m,u]=i.useState(!1),[h,p]=i.useState(!1),g=(0,Hn.nH)(),v=(0,i.useContext)(X.A);(0,i.useEffect)((()=>{(async e=>{const t=null!==(e=await g.getCapabilities())&&void 0!==e?e:{},i=t["m.change_password"],s=!i||!1!==i.enabled;await v.oidcClientStore.readyPromise;const o=v.oidcClientStore.accountManagementEndpoint,r=!t["m.3pid_changes"]||!0===t["m.3pid_changes"].enabled,l=!t["m.set_displayname"]||!0===t["m.set_displayname"].enabled,c=!t["m.set_avatar_url"]||!0===t["m.set_avatar_url"].enabled;a(r),d(l),u(c),n(o),p(s)})()}),[g,v.oidcClientStore]);const _=(0,i.useCallback)((e=>{s.v.error("Failed to change password: "+e);let t=e;e instanceof l.P7&&e.cause instanceof Error&&(t=e.cause);const n=(0,nt.$)(e,(0,l._t)("settings|general|error_password_change_unknown",{stringifiedError:String(e)}));let i=n;t instanceof o.HTTPError&&403===t.httpStatus?i=(0,l._t)("settings|general|error_password_change_403"):t instanceof o.HTTPError&&(i=(0,l._t)("settings|general|error_password_change_http",{errorMessage:n,httpStatus:t.httpStatus})),k.Ay.createDialog(nt.A,{title:(0,l._t)("settings|general|error_password_change_title"),description:i})}),[]),f=(0,i.useCallback)((()=>{const e=(0,l._t)("settings|general|password_change_success");k.Ay.createDialog(nt.A,{title:(0,l._t)("common|success"),description:e})}),[]),E=(0,i.useCallback)((()=>{k.Ay.createDialog(Vy,{onFinished:t=>{t&&e()}})}),[e]);let y;const b=Boolean(t);return M.A.getValue(He.f.Deactivate)&&!b&&(y=i.createElement(wb,{onDeactivateClicked:E})),i.createElement(Us.A,null,i.createElement(Fs.X,null,i.createElement(Ly,{externalAccountManagementUrl:t,canSetDisplayName:c,canSetAvatar:m}),i.createElement(yb,{canMake3pidChanges:r}),i.createElement(bb,{canChangePassword:h,onPasswordChanged:f,onPasswordChangeError:_})),y)};var Ab=n("./src/components/views/elements/SettingsFlag.tsx"),Cb=n("./src/utils/maps.ts");const xb=()=>c.Ay.get("show_labs_settings")||M.A.getValue("developerMode");class kb extends i.Component{constructor(e){super(e),(0,v.A)(this,"labs",void 0),(0,v.A)(this,"betas",void 0);const t=M.A.getFeatureSettingNames(),[n,i]=t.reduce(((e,t)=>(e[M.A.getBetaInfo(t)?1:0].push(t),e)),[[],[]]);this.labs=n,this.betas=i,xb()||(this.labs=[])}render(){let e,t;if(this.betas.length&&(e=i.createElement(i.Fragment,null,this.betas.map((e=>i.createElement(ta.A,{key:e,featureId:e}))))),this.labs.length){const e=new Cb.h;this.labs.forEach((t=>{e.getOrCreate(M.A.getLabGroup(t),[]).push(i.createElement(Ab.A,{level:O.p.DEVICE,name:t,key:t}))})),e.getOrCreate(Sl.$q.Experimental,[]).push(i.createElement(Ab.A,{key:"lowBandwidth",name:"lowBandwidth",level:O.p.DEVICE})),e.getOrCreate(Sl.$q.Analytics,[]).push(i.createElement(Ab.A,{key:"automaticErrorReporting",name:"automaticErrorReporting",level:O.p.DEVICE}),i.createElement(Ab.A,{key:"automaticDecryptionErrorReporting",name:"automaticDecryptionErrorReporting",level:O.p.DEVICE})),t=i.createElement(i.Fragment,null,(0,Vn.sortBy)(Array.from(e.entries()),"0").map((([e,t])=>i.createElement(Vs.P,{key:e,heading:(0,l._t)(Sl.B2[e])},t))))}return i.createElement(Us.A,null,i.createElement(Fs.X,{heading:(0,l._t)("labs|beta_section")},i.createElement(Vs.s,null,(0,l._t)("labs|beta_description",{brand:c.Ay.get("brand")})),e),t&&i.createElement(Fs.X,{heading:(0,l._t)("labs|experimental_section")},i.createElement(Vs.s,null,(0,l._t)("labs|experimental_description",{},{a:e=>i.createElement("a",{href:"https://github.com/vector-im/element-web/blob/develop/docs/labs.md",rel:"noreferrer noopener",target:"_blank"},e)})),t))}}var Rb=n("./node_modules/@vector-im/compound-web/dist/components/Form/Field.js"),Ib=n("./node_modules/@vector-im/compound-web/dist/components/Form/Label.js"),Tb=n("./node_modules/@vector-im/compound-web/dist/components/Form/Controls/Radio/Radio.js"),Pb=n("./node_modules/@vector-im/compound-web/dist/components/Form/InlineField.js"),Nb=n("./node_modules/@vector-im/compound-web/dist/components/Form/Controls/Toggle/Toggle.js");class Db extends i.Component{constructor(e){super(e),this.state={message:e.message}}fakeEvent({message:e}){const t={type:"m.room.message",sender:this.props.userId,content:{"m.new_content":{msgtype:o.MsgType.Text,body:e,displayname:this.props.displayName,avatar_url:this.props.avatarUrl},msgtype:o.MsgType.Text,body:e,displayname:this.props.displayName,avatar_url:this.props.avatarUrl},unsigned:{age:97},event_id:"$9999999999999999999999999999999999999999999",room_id:"!999999999999999999:example.org"},n=new o.MatrixEvent(t);return n.sender={name:this.props.displayName||this.props.userId,rawDisplayName:this.props.displayName,userId:this.props.userId,getAvatarUrl:(...e)=>vt.r4({avatarUrl:this.props.avatarUrl},32,32,"crop"),getMxcAvatarUrl:()=>this.props.avatarUrl},n}render(){const e=dt()(this.props.className,{mx_IRCLayout:this.props.layout==gt.P.IRC,mx_EventTilePreview_loader:!this.props.userId});if(!this.props.userId)return i.createElement("div",{className:e},i.createElement(se.A,null));const t=this.fakeEvent(this.state);return i.createElement("div",{className:e,role:"presentation"},i.createElement(Gi,{mxEvent:t,layout:this.props.layout,as:"div",hideTimestamp:!0,inhibitInteraction:!0}))}}function Mb(){return i.createElement(Vs.P,{heading:(0,l._t)("common|message_layout"),legacy:!1},i.createElement(Ob,null),i.createElement(Ub,null))}function Ob(){return i.createElement(em.b,{className:"mx_LayoutSwitcher_LayoutSelector",onChange:async e=>{const t=new FormData(e.currentTarget).get("layout");await M.A.setValue("layout",null,O.p.DEVICE,t)}},i.createElement(Lb,{layout:gt.P.Group,label:(0,l._t)("common|modern")}),i.createElement(Lb,{layout:gt.P.Bubble,label:(0,l._t)("settings|appearance|layout_bubbles")}),i.createElement(Lb,{layout:gt.P.IRC,label:(0,l._t)("settings|appearance|layout_irc")}))}function Lb({layout:e,label:t}){const n=(0,pt.ti)("layout"),s=function(){const e=(0,Hn.nH)(),t=e.getSafeUserId(),[n,s]=(0,i.useState)({userId:t});return(0,i.useEffect)((()=>{(async()=>{const n=await e.getProfileInfo(t);s({userId:t,displayName:n.displayname,avatarUrl:n.avatar_url})})()}),[t,e,s]),n}();return i.createElement(Rb.D,{name:"layout",className:"mxLayoutSwitcher_LayoutSelector_LayoutRadio"},i.createElement(Ib.J,{"aria-label":t},i.createElement("div",{className:"mxLayoutSwitcher_LayoutSelector_LayoutRadio_inline"},i.createElement(Tb.b,{name:"layout",value:e,defaultChecked:n===e}),i.createElement("span",null,t)),i.createElement("hr",{className:"mxLayoutSwitcher_LayoutSelector_LayoutRadio_separator"}),i.createElement(Db,(0,_t.A)({message:(0,l._t)("common|preview_message"),layout:e,className:"mxLayoutSwitcher_LayoutSelector_LayoutRadio_EventTilePreview"},s))))}function Ub(){const e=(0,pt.ti)("useCompactLayout"),t=(0,pt.ti)("layout");return i.createElement(em.b,{onChange:async e=>{const t="on"===new FormData(e.currentTarget).get("compactLayout");await M.A.setValue("useCompactLayout",null,O.p.DEVICE,t)}},i.createElement(Pb.I,{name:"compactLayout",control:i.createElement(Nb._,{disabled:t!==gt.P.Group,name:"compactLayout",defaultChecked:e})},i.createElement(Ib.J,null,(0,l._t)("settings|appearance|compact_layout")),i.createElement(Ay.po,null,(0,l._t)("settings|appearance|compact_layout_description"))))}class Fb extends i.Component{constructor(e){super(e),(0,v.A)(this,"MESSAGE_PREVIEW_TEXT",(0,l._t)("common|preview_message")),(0,v.A)(this,"sizes",[9,10,11,12,13,14,15,16,17,18,20,22,24,26,28,30,32,34,36]),(0,v.A)(this,"layoutWatcherRef",void 0),(0,v.A)(this,"unmounted",!1),(0,v.A)(this,"onFontSizeChanged",(async e=>{const t=parseInt(e,10)||0;this.setState({fontSizeDelta:t}),await M.A.setValue("fontSizeDelta",null,O.p.DEVICE,t)})),(0,v.A)(this,"computeDeltaFontSize",(e=>e-this.state.browserFontSize)),this.state={fontSizeDelta:M.A.getValue("fontSizeDelta",null),browserFontSize:Mr.g.getBrowserDefaultFontSize(),useCustomFontSize:M.A.getValue("useCustomFontSize"),layout:M.A.getValue("layout")}}async componentDidMount(){this.unmounted=!1;const e=_.J.safeGet(),t=e.getSafeUserId(),n=await e.getProfileInfo(t);this.layoutWatcherRef=M.A.watchSetting("layout",null,(()=>{const e=M.A.getValue("layout");this.state.layout!==e&&this.setState({layout:e})})),this.unmounted||this.setState({userId:t,displayName:n.displayname,avatarUrl:n.avatar_url})}componentWillUnmount(){this.unmounted=!0,M.A.unwatchSetting(this.layoutWatcherRef)}render(){return i.createElement(Vs.P,{heading:(0,l._t)("settings|appearance|font_size"),stretchContent:!0},i.createElement(ks.A,{element:"select",className:"mx_FontScalingPanel_Dropdown",label:(0,l._t)("settings|appearance|font_size"),value:this.state.fontSizeDelta.toString(),onChange:e=>this.onFontSizeChanged(e.target.value)},this.sizes.map((e=>i.createElement("option",{key:e,value:this.computeDeltaFontSize(e)},e===this.state.browserFontSize?(0,l._t)("settings|appearance|font_size_default",{fontSize:e}):e)))),i.createElement(Db,{className:"mx_FontScalingPanel_preview",message:this.MESSAGE_PREVIEW_TEXT,layout:this.state.layout,userId:this.state.userId,displayName:this.state.displayName,avatarUrl:this.state.avatarUrl}))}}function Vb(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Bb(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Vb(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Vb(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function jb(){const e=Oa(),t=(0,i.useRef)(new Dr.A),n=(0,pt.ti)("feature_custom_themes");return i.createElement(Vs.P,{heading:(0,l._t)("common|theme"),legacy:!1},t.current.isSystemThemeSupported()&&i.createElement(Wb,{systemThemeActivated:e.systemThemeActivated}),i.createElement(zb,{theme:e.theme,disabled:e.systemThemeActivated}),n&&i.createElement(Hb,{theme:e.theme}))}function Wb({systemThemeActivated:e}){return i.createElement(em.b,{onChange:async e=>{const t="on"===new FormData(e.currentTarget).get("systemTheme");await M.A.setValue("use_system_theme",null,O.p.DEVICE,t),S.A.dispatch({action:W.r.RecheckTheme})}},i.createElement(Pb.I,{name:"systemTheme",control:i.createElement(Nb._,{name:"systemTheme",defaultChecked:e})},i.createElement(Ib.J,null,M.A.getDisplayName("use_system_theme"))))}function zb({theme:e,disabled:t}){const n=function(){const e=(0,pt.ti)("custom_themes");return(0,i.useMemo)((()=>{const t=(e||[]).reduce(((e,t)=>e.set(t.name,t)),new Map),n=(0,Da.E0)(),i=n.filter((e=>!t.has(e.name))),s=n.filter((e=>t.has(e.name))),o=function(){const e=(0,Da.TJ)("light");if(e)return{name:(0,l._t)("settings|appearance|high_contrast"),id:e}}();o&&i.push(o);return i.concat(s).map((e=>{const n=t.get(e.name),i=(n?n.is_dark:e.id.includes("dark"))||!1;return Bb(Bb({},e),{},{isDark:i})}))}),[e])}();return i.createElement(em.b,{className:"mx_ThemeChoicePanel_ThemeSelectors",onChange:async t=>{const n=new FormData(t.currentTarget).get("themeSelector");n&&e!==n&&(M.A.setValue("theme",null,O.p.DEVICE,n).catch((()=>{S.A.dispatch({action:W.r.RecheckTheme})})),S.A.dispatch({action:W.r.RecheckTheme,forceTheme:n}))}},n.map((n=>{const s=e===n.id;return i.createElement(Pb.I,{className:dt()("mx_ThemeChoicePanel_themeSelector",{mx_ThemeChoicePanel_themeSelector_enabled:!t&&e===n.id,mx_ThemeChoicePanel_themeSelector_disabled:t,"cpd-theme-light":!n.isDark,"cpd-theme-dark":n.isDark}),name:"themeSelector",key:n.id,control:i.createElement(Tb.b,{name:"themeSelector",checked:!t&&s,disabled:t,value:n.id})},i.createElement(Ib.J,{className:"mx_ThemeChoicePanel_themeSelector_Label"},n.name))})))}function Hb({theme:e}){const[t,n]=(0,i.useState)(""),[o,r]=(0,i.useState)(),a=(0,i.useCallback)((()=>{r(void 0),n("")}),[r,n]);return i.createElement("div",{className:"mx_ThemeChoicePanel_CustomTheme"},i.createElement(Sy.d,{className:"mx_ThemeChoicePanel_CustomTheme_EditInPlace",label:(0,l._t)("settings|appearance|custom_theme_add"),cancelButtonLabel:(0,l._t)("action|cancel"),saveButtonLabel:(0,l._t)("settings|appearance|custom_theme_add"),savingLabel:(0,l._t)("settings|appearance|custom_theme_downloading"),value:t,onChange:e=>{r(void 0),n(e.target.value)},onSave:async()=>{if(!t)return;const e=M.A.getValue("custom_themes").map((e=>e))||[];try{const n=await fetch(t),i=await n.json();if(!i||"string"!=typeof i.name||"object"!=typeof i.colors)return void r((0,l._t)("settings|appearance|custom_theme_invalid"));if(Boolean(e.find((e=>e.name===i.name))))return void a();e.push(i)}catch(e){return s.v.error(e),void r((0,l._t)("settings|appearance|custom_theme_error_downloading"))}a(),await M.A.setValue("custom_themes",null,O.p.ACCOUNT,e)},onCancel:a},i.createElement(Ay.po,null,(0,l._t)("settings|appearance|custom_theme_help")),o&&i.createElement(Ay.Kw,null,o)),i.createElement(Kb,{theme:e}))}function Kb({theme:e}){const t=(0,pt.ti)("custom_themes")||[];return i.createElement("ul",{className:"mx_ThemeChoicePanel_CustomThemeList"},t.map((t=>i.createElement("li",{key:t.name,className:"mx_ThemeChoicePanel_CustomThemeList_theme","aria-label":t.name},i.createElement("span",{className:"mx_ThemeChoicePanel_CustomThemeList_name"},t.name),i.createElement(hl.K,{destructive:!0,"aria-label":(0,l._t)("action|delete"),tooltip:(0,l._t)("action|delete"),onClick:async()=>{const n=(M.A.getValue("custom_themes").map((e=>e))||[]).filter((e=>e.name!==t.name));await M.A.setValue("custom_themes",null,O.p.ACCOUNT,n),e===`custom-${t.name}`&&(await M.A.setValue("theme",null,O.p.DEVICE,null),S.A.dispatch({action:W.r.RecheckTheme}))}},i.createElement(nn.A,null))))))}var Jb=n("./src/settings/enums/ImageSize.ts");class Gb extends i.Component{constructor(e){super(e),(0,v.A)(this,"onSizeChange",(e=>{const t=e.target.value;this.setState({size:t}),M.A.setValue("Images.size",null,O.p.ACCOUNT,t)})),this.state={size:M.A.getValue("Images.size")}}render(){return i.createElement(Vs.P,{heading:(0,l._t)("settings|appearance|timeline_image_size")},i.createElement("div",{className:"mx_ImageSizePanel_radios"},i.createElement("label",null,i.createElement("div",{className:"mx_ImageSizePanel_size mx_ImageSizePanel_sizeDefault"}),i.createElement(xs.A,{name:"image_size",value:Jb.h.Normal,checked:this.state.size===Jb.h.Normal,onChange:this.onSizeChange},(0,l._t)("settings|appearance|image_size_default"))),i.createElement("label",null,i.createElement("div",{className:"mx_ImageSizePanel_size mx_ImageSizePanel_sizeLarge"}),i.createElement(xs.A,{name:"image_size",value:Jb.h.Large,checked:this.state.size===Jb.h.Large,onChange:this.onSizeChange},(0,l._t)("settings|appearance|image_size_large")))))}}class $b extends i.Component{constructor(e){super(e),this.state={useBundledEmojiFont:M.A.getValue("useBundledEmojiFont"),useSystemFont:M.A.getValue("useSystemFont"),systemFont:M.A.getValue("systemFont"),showAdvanced:!1}}renderAdvancedSection(){if(!M.A.getValue(He.f.AdvancedSettings))return null;const e=c.Ay.get().brand,t=i.createElement(ie.A,{kind:"link",onClick:()=>this.setState({showAdvanced:!this.state.showAdvanced}),"aria-expanded":this.state.showAdvanced},this.state.showAdvanced?(0,l._t)("action|hide_advanced"):(0,l._t)("action|show_advanced"));let n;if(this.state.showAdvanced){const t=(0,l._t)("settings|appearance|custom_font_description",{brand:e});n=i.createElement(i.Fragment,null,i.createElement(Ab.A,{name:"useCompactLayout",level:O.p.DEVICE,useCheckbox:!0}),i.createElement(Ab.A,{name:"useBundledEmojiFont",level:O.p.DEVICE,useCheckbox:!0,onChange:e=>this.setState({useBundledEmojiFont:e})}),i.createElement(Ab.A,{name:"useSystemFont",level:O.p.DEVICE,useCheckbox:!0,onChange:e=>this.setState({useSystemFont:e})}),i.createElement(ks.A,{className:"mx_AppearanceUserSettingsTab_checkboxControlledField",label:M.A.getDisplayName("systemFont"),onChange:e=>{this.setState({systemFont:e.target.value}),M.A.setValue("systemFont",null,O.p.DEVICE,e.target.value)},tooltipContent:t,forceTooltipVisible:!0,disabled:!this.state.useSystemFont,value:this.state.systemFont}))}return i.createElement(Vs.P,null,t,n)}render(){return i.createElement(Us.A,null,i.createElement(Fs.X,null,i.createElement(jb,null),i.createElement(Mb,null),i.createElement(Fb,null),this.renderAdvancedSection(),i.createElement(Gb,null)))}}class qb extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,"unmounted",!1),(0,v.A)(this,"onKeyBackupSessionsRemaining",(e=>{this.setState({sessionsRemaining:e})})),(0,v.A)(this,"onKeyBackupStatus",(()=>{this.loadBackupStatus()})),(0,v.A)(this,"startNewBackup",(()=>{k.Ay.createDialog((0,i.lazy)((()=>n.e(5776).then(n.bind(n,"./src/async-components/views/dialogs/security/CreateKeyBackupDialog.tsx")))),{onFinished:()=>{this.loadBackupStatus()}},void 0,!1,!0)})),(0,v.A)(this,"deleteBackup",(()=>{k.Ay.createDialog(it.A,{title:(0,l._t)("settings|security|delete_backup"),description:(0,l._t)("settings|security|delete_backup_confirm_description"),button:(0,l._t)("settings|security|delete_backup"),danger:!0,onFinished:e=>{var t;if(!e)return;this.setState({loading:!0});const n=this.state.backupInfo.version;null===(t=_.J.safeGet().getCrypto())||void 0===t||t.deleteKeyBackupVersion(n)}})})),(0,v.A)(this,"restoreBackup",(async()=>{k.Ay.createDialog($a.A,void 0,void 0,!1,!0)})),(0,v.A)(this,"resetSecretStorage",(async()=>{this.setState({error:!1});try{await(0,Q.cb)((async()=>{}),{forceReset:!0})}catch(e){if(s.v.error("Error resetting secret storage",e),this.unmounted)return;this.setState({error:!0})}this.unmounted||this.loadBackupStatus()})),this.state={loading:!0,error:!1,backupKeyStored:null,backupKeyCached:null,backupKeyWellFormed:null,secretStorageKeyInAccount:null,secretStorageReady:null,backupInfo:null,backupTrustInfo:void 0,activeBackupVersion:null,sessionsRemaining:null}}componentDidMount(){this.unmounted=!1,this.loadBackupStatus(),_.J.safeGet().on(V.CryptoEvent.KeyBackupStatus,this.onKeyBackupStatus),_.J.safeGet().on(V.CryptoEvent.KeyBackupSessionsRemaining,this.onKeyBackupSessionsRemaining)}componentWillUnmount(){this.unmounted=!0,_.J.get()&&(_.J.get().removeListener(V.CryptoEvent.KeyBackupStatus,this.onKeyBackupStatus),_.J.get().removeListener(V.CryptoEvent.KeyBackupSessionsRemaining,this.onKeyBackupSessionsRemaining))}async loadBackupStatus(){this.setState({loading:!0}),this.getUpdatedDiagnostics();try{var e,t,n,i,o;const s=_.J.safeGet(),r=null!==(e=await(null===(t=s.getCrypto())||void 0===t?void 0:t.getKeyBackupInfo()))&&void 0!==e?e:null,a=r?await(null===(n=s.getCrypto())||void 0===n?void 0:n.isKeyBackupTrusted(r)):void 0,l=null!==(i=await(null===(o=s.getCrypto())||void 0===o?void 0:o.getActiveSessionBackupVersion()))&&void 0!==i?i:null;if(this.unmounted)return;this.setState({loading:!1,error:!1,backupInfo:r,backupTrustInfo:a,activeBackupVersion:l})}catch(e){if(s.v.log("Unable to fetch key backup status",e),this.unmounted)return;this.setState({loading:!1,error:!0,backupInfo:null,backupTrustInfo:void 0,activeBackupVersion:null})}}async getUpdatedDiagnostics(){const e=_.J.safeGet(),t=e.getCrypto();if(!t)return;const n=e.secretStorage,i=!!await e.isKeyBackupKeyStored(),s=await t.getSessionBackupPrivateKey(),o=!!s,r=s instanceof Uint8Array,a=await n.hasKey(),l=await t.isSecretStorageReady();this.unmounted||this.setState({backupKeyStored:i,backupKeyCached:o,backupKeyWellFormed:r,secretStorageKeyInAccount:a,secretStorageReady:l})}render(){const{loading:e,error:t,backupKeyStored:n,backupKeyCached:s,backupKeyWellFormed:o,secretStorageKeyInAccount:r,secretStorageReady:a,backupInfo:c,backupTrustInfo:d,sessionsRemaining:m}=this.state;let u,h,p;const g=[];if(t)u=i.createElement(Vs.s,{className:"error"},(0,l._t)("settings|security|error_loading_key_backup_status"));else if(e)u=i.createElement(se.A,null);else if(c){let e,t,n=(0,l._t)("settings|security|restore_key_backup");null!==this.state.activeBackupVersion?u=i.createElement(Vs.s,null,"✅ ",(0,l._t)("settings|security|key_backup_active")):(u=i.createElement(i.Fragment,null,i.createElement(Vs.s,null,(0,l._t)("settings|security|key_backup_inactive",{},{b:e=>i.createElement("strong",null,e)})),i.createElement(Vs.s,null,(0,l._t)("settings|security|key_backup_connect_prompt"))),n=(0,l._t)("settings|security|key_backup_connect")),e=null===m?"":m>0?i.createElement("div",null,(0,l._t)("settings|security|key_backup_in_progress",{sessionsRemaining:m})," ",i.createElement("br",null)):i.createElement("div",null,(0,l._t)("settings|security|key_backup_complete")," ",i.createElement("br",null)),null!=d&&d.matchesDecryptionKey&&(t=(0,l._t)("settings|security|key_backup_can_be_restored")),h=i.createElement(i.Fragment,null,i.createElement("tr",null,i.createElement("th",{scope:"row"},(0,l._t)("settings|security|key_backup_latest_version")),i.createElement("td",null,c.version," (",(0,l._t)("settings|security|key_backup_algorithm")," ",i.createElement("code",null,c.algorithm),")")),i.createElement("tr",null,i.createElement("th",{scope:"row"},(0,l._t)("settings|security|key_backup_active_version")),i.createElement("td",null,null===this.state.activeBackupVersion?(0,l._t)("settings|security|key_backup_active_version_none"):this.state.activeBackupVersion))),p=i.createElement(i.Fragment,null,e,i.createElement("div",null,t)),g.push(i.createElement(ie.A,{key:"restore",kind:"primary_outline",onClick:this.restoreBackup},n)),(0,Ue.R$)(_.J.safeGet())||g.push(i.createElement(ie.A,{key:"delete",kind:"danger_outline",onClick:this.deleteBackup},(0,l._t)("settings|security|delete_backup")))}else u=i.createElement(i.Fragment,null,i.createElement(Vs.s,null,(0,l._t)("settings|security|key_backup_inactive_warning",{},{b:e=>i.createElement("strong",null,e)})),i.createElement(Vs.s,null,(0,l._t)("encryption|setup_secure_backup|explainer"))),g.push(i.createElement(ie.A,{key:"setup",kind:"primary_outline",onClick:this.startNewBackup},(0,l._t)("encryption|setup_secure_backup|title")));r&&g.push(i.createElement(ie.A,{key:"reset",kind:"danger_outline",onClick:this.resetSecretStorage},(0,l._t)("action|reset")));let v,f="";return s&&(f=", ",f+=o?(0,l._t)("settings|security|backup_key_well_formed"):(0,l._t)("settings|security|backup_key_unexpected_type")),g.length&&(v=i.createElement("div",{className:"mx_SecureBackupPanel_buttonRow"},g)),i.createElement(i.Fragment,null,i.createElement(Vs.s,null,(0,l._t)("settings|security|backup_keys_description")),u,i.createElement("details",null,i.createElement("summary",{className:"mx_SecureBackupPanel_advanced"},(0,l._t)("common|advanced")),i.createElement("table",{className:"mx_SecureBackupPanel_statusList"},i.createElement("tr",null,i.createElement("th",{scope:"row"},(0,l._t)("settings|security|backup_key_stored_status")),i.createElement("td",null,!0===n?(0,l._t)("settings|security|cross_signing_in_4s"):(0,l._t)("settings|security|cross_signing_not_stored"))),i.createElement("tr",null,i.createElement("th",{scope:"row"},(0,l._t)("settings|security|backup_key_cached_status")),i.createElement("td",null,s?(0,l._t)("settings|security|cross_signing_cached"):(0,l._t)("settings|security|cross_signing_not_cached"),f)),i.createElement("tr",null,i.createElement("th",{scope:"row"},(0,l._t)("settings|security|4s_public_key_status")),i.createElement("td",null,r?(0,l._t)("settings|security|4s_public_key_in_account_data"):(0,l._t)("settings|security|cross_signing_not_found"))),i.createElement("tr",null,i.createElement("th",{scope:"row"},(0,l._t)("settings|security|secret_storage_status")),i.createElement("td",null,a?(0,l._t)("settings|security|secret_storage_ready"):(0,l._t)("settings|security|secret_storage_not_ready"))),h),p),v)}}class Yb extends i.Component{constructor(e,t){super(e),(0,v.A)(this,"onExportE2eKeysClicked",(()=>{k.Ay.createDialog((0,i.lazy)((()=>n.e(2959).then(n.bind(n,"./src/async-components/views/dialogs/security/ExportE2eKeysDialog.tsx")))),{matrixClient:this.context})})),(0,v.A)(this,"onImportE2eKeysClicked",(()=>{k.Ay.createDialog((0,i.lazy)((()=>n.e(8952).then(n.bind(n,"./src/async-components/views/dialogs/security/ImportE2eKeysDialog.tsx")))),{matrixClient:this.context})})),(0,v.A)(this,"updateBlacklistDevicesFlag",(e=>{const t=this.context.getCrypto();t&&(t.globalBlacklistUnverifiedDevices=e)})),t.getCrypto()?this.state={deviceIdentityKey:void 0}:this.state={deviceIdentityKey:null}}componentDidMount(){var e;void 0===this.state.deviceIdentityKey&&(null===(e=this.context.getCrypto())||void 0===e||e.getOwnDeviceKeys().then((e=>{this.setState({deviceIdentityKey:e.ed25519})})).catch((e=>{s.v.error(`CryptographyPanel: Error fetching own device keys: ${e}`),this.setState({deviceIdentityKey:null})})))}render(){const e=this.context,t=e.deviceId;let n,s,o=this.state.deviceIdentityKey;return o=void 0===o?"...":null===o?(0,l._t)("encryption|not_supported"):bt.y$(o),e.getCrypto()&&(n=i.createElement("div",{className:"mx_CryptographyPanel_importExportButtons"},i.createElement(ie.A,{kind:"primary_outline",onClick:this.onExportE2eKeysClicked},(0,l._t)("settings|security|export_megolm_keys")),i.createElement(ie.A,{kind:"primary_outline",onClick:this.onImportE2eKeysClicked},(0,l._t)("settings|security|import_megolm_keys")))),M.A.canSetValue("blacklistUnverifiedDevices",null,O.p.DEVICE)&&(s=i.createElement(Ab.A,{name:"blacklistUnverifiedDevices",level:O.p.DEVICE,onChange:this.updateBlacklistDevicesFlag})),i.createElement(Vs.P,{heading:(0,l._t)("settings|security|cryptography_section")},i.createElement(Vs.s,null,i.createElement("table",{className:"mx_CryptographyPanel_sessionInfo"},i.createElement("tbody",null,i.createElement("tr",null,i.createElement("th",{scope:"row"},(0,l._t)("settings|security|session_id")),i.createElement("td",null,i.createElement("code",null,t))),i.createElement("tr",null,i.createElement("th",{scope:"row"},(0,l._t)("settings|security|session_key")),i.createElement("td",null,i.createElement("code",null,i.createElement("strong",null,o))))))),n,s)}}(0,v.A)(Yb,"contextType",Hn.Ay);class Qb extends i.Component{constructor(...e){super(...e),(0,v.A)(this,"onConfirm",(()=>{this.props.onFinished(!0)})),(0,v.A)(this,"onDecline",(()=>{this.props.onFinished(!1)}))}render(){return i.createElement(J.A,{className:"mx_ConfirmDestroyCrossSigningDialog",hasCancel:!0,onFinished:this.props.onFinished,title:(0,l._t)("encryption|destroy_cross_signing_dialog|title")},i.createElement("div",{className:"mx_ConfirmDestroyCrossSigningDialog_content"},i.createElement("p",null,(0,l._t)("encryption|destroy_cross_signing_dialog|warning"))),i.createElement(ot.A,{primaryButton:(0,l._t)("encryption|destroy_cross_signing_dialog|primary_button_text"),onPrimaryButtonClick:this.onConfirm,primaryButtonClass:"danger",cancelButton:(0,l._t)("action|cancel"),onCancel:this.onDecline}))}}class Xb extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,"unmounted",!1),(0,v.A)(this,"onAccountData",(e=>{const t=e.getType();(t.startsWith("m.cross_signing")||t.startsWith("m.secret_storage"))&&this.getUpdatedStatus()})),(0,v.A)(this,"onBootstrapClick",(()=>{this.state.crossSigningPrivateKeysInStorage?k.Ay.createDialog(ae,{},void 0,!1,!0):(0,Q.cb)()})),(0,v.A)(this,"onStatusChanged",(()=>{this.getUpdatedStatus()})),(0,v.A)(this,"onResetCrossSigningClick",(()=>{k.Ay.createDialog(Qb,{onFinished:async e=>{e&&this.resetCrossSigning()}})})),this.state={error:!1}}componentDidMount(){this.unmounted=!1;const e=_.J.safeGet();e.on(o.ClientEvent.AccountData,this.onAccountData),e.on(V.CryptoEvent.UserTrustStatusChanged,this.onStatusChanged),e.on(V.CryptoEvent.KeysChanged,this.onStatusChanged),this.getUpdatedStatus()}componentWillUnmount(){this.unmounted=!0;const e=_.J.get();e&&(e.removeListener(o.ClientEvent.AccountData,this.onAccountData),e.removeListener(V.CryptoEvent.UserTrustStatusChanged,this.onStatusChanged),e.removeListener(V.CryptoEvent.KeysChanged,this.onStatusChanged))}async getUpdatedStatus(){const e=_.J.safeGet(),t=e.getCrypto();if(!t)return;const n=await t.getCrossSigningStatus(),i=n.publicKeysOnDevice,s=n.privateKeysInSecretStorage,o=n.privateKeysCachedLocally.masterKey,r=n.privateKeysCachedLocally.selfSigningKey,a=n.privateKeysCachedLocally.userSigningKey,l=await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"),c=await t.isCrossSigningReady();this.setState({crossSigningPublicKeysOnDevice:i,crossSigningPrivateKeysInStorage:s,masterPrivateKeyCached:o,selfSigningPrivateKeyCached:r,userSigningPrivateKeyCached:a,homeserverSupportsCrossSigning:l,crossSigningReady:c})}async resetCrossSigning(){this.setState({error:!1});try{const e=_.J.safeGet();await(0,Q.J6)((async()=>{await e.getCrypto().bootstrapCrossSigning({authUploadDeviceSigningKeys:async t=>{const{finished:n}=k.Ay.createDialog(ob.A,{title:(0,l._t)("encryption|bootstrap_title"),matrixClient:e,makeRequest:t}),[i]=await n;if(!i)throw new Error("Cross-signing key upload auth canceled")},setupNewCrossSigning:!0})}))}catch(e){this.setState({error:!0}),s.v.error("Error bootstrapping cross-signing",e)}this.unmounted||this.getUpdatedStatus()}render(){const{error:e,crossSigningPublicKeysOnDevice:t,crossSigningPrivateKeysInStorage:n,masterPrivateKeyCached:s,selfSigningPrivateKeyCached:o,userSigningPrivateKeyCached:r,homeserverSupportsCrossSigning:a,crossSigningReady:c}=this.state;let d,m;e&&(d=i.createElement("div",{className:"error"},e.toString())),m=void 0===a?i.createElement(se.A,null):a?c&&n?i.createElement(Vs.s,null,"✅ ",(0,l._t)("encryption|cross_signing_ready")):c&&!n?i.createElement(Vs.s,null,"⚠️ ",(0,l._t)("encryption|cross_signing_ready_no_backup")):n?i.createElement(Vs.s,null,(0,l._t)("encryption|cross_signing_untrusted")):i.createElement(Vs.s,null,(0,l._t)("encryption|cross_signing_not_ready")):i.createElement(Vs.s,null,(0,l._t)("encryption|cross_signing_unsupported"));const u=t||n||s||o||r,h=[];if(!(t&&n&&s&&o&&r)&&a){let e=(0,l._t)("encryption|set_up_toast_title");n&&(e=(0,l._t)("encryption|verify_toast_title")),h.push(i.createElement(ie.A,{key:"setup",kind:"primary_outline",onClick:this.onBootstrapClick},e))}let p;return u&&h.push(i.createElement(ie.A,{key:"reset",kind:"danger_outline",onClick:this.onResetCrossSigningClick},(0,l._t)("action|reset"))),h.length&&(p=i.createElement("div",{className:"mx_CrossSigningPanel_buttonRow"},h)),i.createElement(i.Fragment,null,m,i.createElement("details",null,i.createElement("summary",{className:"mx_CrossSigningPanel_advanced"},(0,l._t)("common|advanced")),i.createElement("table",{className:"mx_CrossSigningPanel_statusList"},i.createElement("tbody",null,i.createElement("tr",null,i.createElement("th",{scope:"row"},(0,l._t)("settings|security|cross_signing_public_keys")),i.createElement("td",null,t?(0,l._t)("settings|security|cross_signing_in_memory"):(0,l._t)("settings|security|cross_signing_not_found"))),i.createElement("tr",null,i.createElement("th",{scope:"row"},(0,l._t)("settings|security|cross_signing_private_keys")),i.createElement("td",null,n?(0,l._t)("settings|security|cross_signing_in_4s"):(0,l._t)("settings|security|cross_signing_not_in_4s"))),i.createElement("tr",null,i.createElement("th",{scope:"row"},(0,l._t)("settings|security|cross_signing_master_private_Key")),i.createElement("td",null,s?(0,l._t)("settings|security|cross_signing_cached"):(0,l._t)("settings|security|cross_signing_not_cached"))),i.createElement("tr",null,i.createElement("th",{scope:"row"},(0,l._t)("settings|security|cross_signing_self_signing_private_key")),i.createElement("td",null,o?(0,l._t)("settings|security|cross_signing_cached"):(0,l._t)("settings|security|cross_signing_not_cached"))),i.createElement("tr",null,i.createElement("th",{scope:"row"},(0,l._t)("settings|security|cross_signing_user_signing_private_key")),i.createElement("td",null,r?(0,l._t)("settings|security|cross_signing_cached"):(0,l._t)("settings|security|cross_signing_not_cached"))),i.createElement("tr",null,i.createElement("th",{scope:"row"},(0,l._t)("settings|security|cross_signing_homeserver_support")),i.createElement("td",null,a?(0,l._t)("settings|security|cross_signing_homeserver_support_exists"):(0,l._t)("settings|security|cross_signing_not_found")))))),d,p)}}class Zb extends i.PureComponent{render(){return i.createElement(J.A,{hasCancel:!0,onFinished:this.props.onFinished.bind(null,!1),title:(0,l._t)("seshat|reset_title")},i.createElement("div",null,i.createElement("p",null,(0,l._t)("seshat|reset_description"),i.createElement("br",null),(0,l._t)("seshat|reset_explainer"))),i.createElement(ot.A,{primaryButton:(0,l._t)("seshat|reset_button"),onPrimaryButtonClick:this.props.onFinished.bind(null,!0),primaryButtonClass:"danger",cancelButton:(0,l._t)("action|cancel"),onCancel:this.props.onFinished.bind(null,!1)}))}}class ew extends i.Component{constructor(e){super(e),(0,v.A)(this,"updateCurrentRoom",(async()=>{const e=E.A.get(),t=await(null==e?void 0:e.getStats().catch((()=>{})));t&&this.setState({eventIndexSize:t.size,roomCount:t.roomCount})})),(0,v.A)(this,"onManage",(async()=>{k.Ay.createDialog((0,i.lazy)((()=>n.e(2016).then(n.bind(n,"./src/async-components/views/dialogs/eventindex/ManageEventIndexDialog.tsx")))),{onFinished:()=>{}},void 0,!1,!0)})),(0,v.A)(this,"onEnable",(async()=>{var e,t;this.setState({enabling:!0}),await E.A.initEventIndex(),await(null===(e=E.A.get())||void 0===e?void 0:e.addInitialCheckpoints()),null===(t=E.A.get())||void 0===t||t.startCrawler(),await M.A.setValue("enableEventIndexing",null,O.p.DEVICE,!0),await this.updateState()})),(0,v.A)(this,"confirmEventStoreReset",(()=>{const{close:e}=k.Ay.createDialog(Zb,{onFinished:async t=>{t&&(await M.A.setValue("enableEventIndexing",null,O.p.DEVICE,!1),await E.A.deleteEventIndex(),await this.onEnable(),e())}})})),this.state={enabling:!1,eventIndexSize:0,roomCount:0,eventIndexingEnabled:M.A.getValueAt(O.p.DEVICE,"enableEventIndexing")}}componentWillUnmount(){const e=E.A.get();null!==e&&e.removeListener("changedCheckpoint",this.updateCurrentRoom)}componentDidMount(){this.updateState()}async updateState(){const e=E.A.get(),t=M.A.getValueAt(O.p.DEVICE,"enableEventIndexing");let n=0,i=0;if(null!==e){e.on("changedCheckpoint",this.updateCurrentRoom);const t=await e.getStats().catch((()=>{}));t&&(n=t.size,i=t.roomCount)}this.setState({enabling:!1,eventIndexSize:n,roomCount:i,eventIndexingEnabled:t})}render(){let e;const t=c.Ay.get().brand;if(null!==E.A.get())e=i.createElement(i.Fragment,null,i.createElement(Vs.s,null,(0,l._t)("settings|security|message_search_enabled",{size:(0,bt.z3)(this.state.eventIndexSize,0),count:this.state.roomCount,rooms:(0,bt.Zl)(this.state.roomCount)})),i.createElement(ie.A,{kind:"primary",onClick:this.onManage},(0,l._t)("action|manage")));else if(!this.state.eventIndexingEnabled&&E.A.supportIsInstalled())e=i.createElement(i.Fragment,null,i.createElement(Vs.s,null,(0,l._t)("settings|security|message_search_disabled")),i.createElement("div",null,i.createElement(ie.A,{kind:"primary",disabled:this.state.enabling,onClick:this.onEnable},(0,l._t)("action|enable")),this.state.enabling?i.createElement(oa.A,null):i.createElement("div",null)));else if(E.A.platformHasSupport()&&!E.A.supportIsInstalled()){const n="https://github.com/vector-im/element-desktop/blob/develop/docs/native-node-modules.md#adding-seshat-for-search-in-e2e-encrypted-rooms";e=i.createElement(Vs.s,null,(0,l._t)("settings|security|message_search_unsupported",{brand:t},{nativeLink:e=>i.createElement(Ja.A,{href:n,target:"_blank",rel:"noreferrer noopener"},e)}))}else e=E.A.platformHasSupport()?i.createElement(i.Fragment,null,i.createElement(Vs.s,null,this.state.enabling?i.createElement(oa.A,null):(0,l._t)("settings|security|message_search_failed")),E.A.error&&i.createElement(Vs.s,null,i.createElement("details",null,i.createElement("summary",null,(0,l._t)("common|advanced")),i.createElement("code",null,E.A.error instanceof Error?E.A.error.message:(0,l._t)("error|unknown")),i.createElement("p",null,i.createElement(ie.A,{key:"delete",kind:"danger",onClick:this.confirmEventStoreReset},(0,l._t)("action|reset")))))):i.createElement(Vs.s,null,(0,l._t)("settings|security|message_search_unsupported_web",{brand:t},{desktopLink:e=>i.createElement(Ja.A,{href:"https://element.io/get-started",target:"_blank",rel:"noreferrer noopener"},e)}));return e}}function tw(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function nw(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?tw(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):tw(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const iw=(e,t)=>{const{name:n,version:i,url:s}=ze(e,t.device_id);return{appName:n,appVersion:i,url:s}};let sw=function(e){return e.Unsupported="Unsupported",e.Default="Default",e}({});const ow=()=>{var e;const t=(0,i.useContext)(X.A).client,n=t.getDeviceId(),r=t.getSafeUserId(),[a,c]=(0,i.useState)({}),[d,m]=(0,i.useState)(void 0),[u,h]=(0,i.useState)([]),[p,g]=(0,i.useState)(new Map),[v,_]=(0,i.useState)(!0),[f,E]=(0,i.useState)(!0),[y,b]=(0,i.useState)();(0,i.useEffect)((()=>{t.doesServerSupportUnstableFeature("org.matrix.msc3881").then((e=>{E(e)}))}),[t]);const w=(0,i.useCallback)((async()=>{_(!0);try{var e,n;const s=await async function(e){const{devices:t}=await e.getDevices(),n={};for(const i of t)n[i.device_id]=nw(nw(nw({},i),{},{isVerified:await _e(e,i.device_id)},iw(e,i)),(0,Ee.y)(i[o.UNSTABLE_MSC3852_LAST_SEEN_UA.name]));return n}(t);c(s);const{pushers:r}=await t.getPushers();h(r);const a=new Map;Object.keys(s).forEach((e=>{const n=`${o.LOCAL_NOTIFICATION_SETTINGS_PREFIX.name}.${e}`,i=t.getAccountData(n);i&&a.set(e,i.getContent())})),g(a);const l=t.getUserId(),d=null===(e=await(null===(n=t.getCrypto())||void 0===n?void 0:n.getUserDeviceInfo([l])))||void 0===e?void 0:e.get(l),u=[];for(const e of null!==(i=null==d?void 0:d.values())&&void 0!==i?i:[]){var i;e.dehydrated&&u.push(e.deviceId)}m(1==u.length?u[0]:void 0),_(!1)}catch(e){404==e.httpStatus?b(sw.Unsupported):(s.v.error("Error loading sessions:",e),b(sw.Default)),_(!1)}}),[t]);(0,i.useEffect)((()=>{w()}),[w]),(0,i.useEffect)((()=>{const e=Object.keys(a);e.length&&((e,t)=>{Array.from(t.store.accountData.values()).forEach((n=>{if(!n.getType().startsWith(Ve))return;const[,i]=n.getType().split(Ve);i&&!e.includes(i)&&t.deleteAccountData(n.getType())}))})(e,t)}),[a,t]),(0,ci.ml)(t,V.CryptoEvent.DevicesUpdated,(e=>{e.includes(r)&&w()})),(0,ci.ml)(t,o.ClientEvent.AccountData,(e=>{const t=e.getType();if(t.startsWith(o.LOCAL_NOTIFICATION_SETTINGS_PREFIX.name)){const n=new Map(p),i=t.slice(t.lastIndexOf(".")+1);n.set(i,e.getContent()),g(n)}}));const S=!(null===(e=a[n])||void 0===e||!e.isVerified)&&r?async e=>await t.getCrypto().requestDeviceVerification(r,e):void 0,A=(0,i.useCallback)((async(e,n)=>{const i=a[e];if(n!==(null==i?void 0:i.display_name))try{await t.setDeviceDetails(e,{display_name:n}),await w()}catch(e){throw s.v.error("Error setting device name",e),new Error((0,l._t)("settings|sessions|error_set_name"))}}),[t,a,w]),C=(0,i.useCallback)((async(e,n)=>{try{const i=u.find((t=>t[o.PUSHER_DEVICE_ID.name]===e));i?await t.setPusher(nw(nw({},i),{},{[o.PUSHER_ENABLED.name]:n})):p.has(e)&&await t.setLocalNotificationSettings(e,{is_silenced:!n})}catch(e){throw s.v.error("Error setting pusher state",e),new Error((0,l._t)("settings|sessions|error_pusher_state"))}finally{await w()}}),[t,u,p,w]);return{devices:a,dehydratedDeviceId:d,pushers:u,localNotificationSettings:p,currentDeviceId:n,isLoadingDeviceList:v,error:y,requestDeviceVerification:S,refreshDevices:w,saveDeviceName:A,setPushNotifications:C,supportsMSC3881:f}};async function rw(e,t){const n=e.getUserId();let{threepids:i}=await e.getThreePids();if(t&&(i=i.filter((e=>e.medium===t))),i.length>0&&e.getIdentityServerUrl())try{const s=new dv.A,o=await s.getAccessToken({check:!1});if(!o)throw new Error("No identity access token found");const r=i.map((({medium:e,address:t})=>[e,t])),a=await e.bulkLookupThreePids(r,o);for(const[e,s,o]of a.threepids){if(o!==n)continue;if(t&&e!==t)continue;const r=i.find((t=>t.medium===e&&t.address===s));r&&(r.bound=!0)}}catch(e){if(!(e instanceof o.MatrixError)||"M_TERMS_NOT_SIGNED"!==e.errcode)throw e}return i}var aw=n("./src/utils/IdentityServerUtils.ts");class lw extends i.Component{constructor(e){super(e),(0,v.A)(this,"dispatcherRef",void 0),(0,v.A)(this,"onAction",(e=>{"id_server_changed"===e.action&&this.setState({currentClientIdServer:_.J.safeGet().getIdentityServerUrl()})})),(0,v.A)(this,"onIdentityServerChanged",(e=>{const t=e.target.value;this.setState({idServer:t})})),(0,v.A)(this,"getTooltip",(()=>this.state.checking?i.createElement("div",null,i.createElement(oa.A,null),(0,l._t)("identity_server|checking")):this.state.error?i.createElement("strong",{className:"warning"},this.state.error):void 0)),(0,v.A)(this,"idServerChangeEnabled",(()=>!!this.state.idServer&&!this.state.busy)),(0,v.A)(this,"saveIdServer",(e=>{_.J.safeGet().setAccountData("m.identity_server",{base_url:e}),this.setState({busy:!1,error:void 0,currentClientIdServer:e,idServer:""})})),(0,v.A)(this,"checkIdServer",(async e=>{var t;e.preventDefault();const{idServer:n,currentClientIdServer:o}=this.state;this.setState({busy:!0,checking:!0,error:void 0});const r=(0,lh.qe)(n);let a=await async function(e){if("https:"!==(0,lh.Dl)(e).protocol)return(0,l._t)("identity_server|url_not_https");try{const t=await fetch(e+"/_matrix/identity/v2");return t.ok?null:t.status<200||t.status>=300?(0,l._t)("identity_server|error_invalid",{code:t.status}):(0,l._t)("identity_server|error_connection")}catch{return(0,l._t)("identity_server|error_connection")}}(r);if(!a)try{this.setState({checking:!1});const e=new dv.A(r);await e.getAccessToken();let t=!0;if(!await(0,aw.mn)(_.J.safeGet(),r)){const[e]=await this.showNoTermsWarning(r);t=!!e}if(t&&o&&r!==o){const[e]=await this.showServerChangeWarning({title:(0,l._t)("identity_server|change"),unboundMessage:(0,l._t)("identity_server|change_prompt",{},{current:e=>i.createElement("strong",null,(0,lh.FO)(o)),new:e=>i.createElement("strong",null,(0,lh.FO)(n))}),button:(0,l._t)("action|continue")});t=!!e}t&&this.saveIdServer(r)}catch(e){s.v.error(e),a=(0,l._t)("identity_server|error_invalid_or_terms")}this.setState({busy:!1,checking:!1,error:null!==(t=a)&&void 0!==t?t:void 0,currentClientIdServer:_.J.safeGet().getIdentityServerUrl()})})),(0,v.A)(this,"onDisconnectClicked",(async()=>{this.setState({disconnectBusy:!0});try{const[e]=await this.showServerChangeWarning({title:(0,l._t)("identity_server|disconnect"),unboundMessage:(0,l._t)("identity_server|disconnect_server",{},{idserver:e=>i.createElement("strong",null,(0,lh.FO)(this.state.currentClientIdServer))}),button:(0,l._t)("action|disconnect")});e&&this.disconnectIdServer()}finally{this.setState({disconnectBusy:!1})}})),(0,v.A)(this,"disconnectIdServer",(()=>{_.J.safeGet().setAccountData("m.identity_server",{base_url:null});let e="";(0,aw.iR)()&&(e=(0,lh.FO)((0,aw.iR)())),this.setState({busy:!1,error:void 0,currentClientIdServer:_.J.safeGet().getIdentityServerUrl(),idServer:e})}));let t="";!_.J.safeGet().getIdentityServerUrl()&&(0,aw.iR)()&&(t=(0,lh.FO)((0,aw.iR)())),this.state={defaultIdServer:t,currentClientIdServer:_.J.safeGet().getIdentityServerUrl(),idServer:"",busy:!1,disconnectBusy:!1,checking:!1}}componentDidMount(){this.dispatcherRef=S.A.register(this.onAction)}componentWillUnmount(){S.A.unregister(this.dispatcherRef)}showNoTermsWarning(e){const{finished:t}=k.Ay.createDialog(it.A,{title:(0,l._t)("terms|identity_server_no_terms_title"),description:i.createElement("div",null,i.createElement("strong",{className:"warning"},(0,l._t)("identity_server|no_terms")),i.createElement("span",null," ",(0,l._t)("terms|identity_server_no_terms_description_2"))),button:(0,l._t)("action|continue")});return t}async showServerChangeWarning({title:e,unboundMessage:t,button:n}){const{currentClientIdServer:o}=this.state;let r=[],a=!0;try{r=await(0,ju.wR)(rw(_.J.safeGet()),Promise.reject(new Error("Timeout attempting to reach identity server")),1e4)}catch(e){a=!1,s.v.warn(`Unable to reach identity server at ${o} to check for 3PIDs during IS change flow`),s.v.warn(e)}const c=r.filter((e=>e.bound));let d,m=!1;const u={idserver:e=>i.createElement("strong",null,(0,lh.FO)(o)),b:e=>i.createElement("strong",null,e)};a?c.length?(d=i.createElement("div",null,i.createElement("p",null,(0,l._t)("identity_server|disconnect_personal_data_warning_1",{},u)),i.createElement("p",null,(0,l._t)("identity_server|disconnect_personal_data_warning_2"))),m=!0,n=(0,l._t)("identity_server|disconnect_anyway")):d=t:(d=i.createElement("div",null,i.createElement("p",null,(0,l._t)("identity_server|disconnect_offline_warning",{},u)),i.createElement("p",null,(0,l._t)("identity_server|suggestions")),i.createElement("ul",null,i.createElement("li",null,(0,l._t)("identity_server|suggestions_1")),i.createElement("li",null,(0,l._t)("identity_server|suggestions_2",{},{idserver:u.idserver})),i.createElement("li",null,(0,l._t)("identity_server|suggestions_3")))),m=!0,n=(0,l._t)("identity_server|disconnect_anyway"));const{finished:h}=k.Ay.createDialog(it.A,{title:e,description:d,button:n,cancelButton:(0,l._t)("action|go_back"),danger:m});return h}render(){const e=this.state.currentClientIdServer;let t,n,s;if(e?(t=(0,l._t)("identity_server|url",{server:(0,lh.FO)(e)}),n=(0,l._t)("identity_server|description_connected",{},{server:t=>i.createElement("strong",null,(0,lh.FO)(e))}),this.props.missingTerms&&(n=(0,l._t)("identity_server|change_server_prompt",{},{server:t=>i.createElement("strong",null,(0,lh.FO)(e))}))):(t=(0,l._t)("common|identity_server"),n=(0,l._t)("identity_server|description_disconnected")),e){let e=(0,l._t)("action|disconnect"),t=(0,l._t)("identity_server|disconnect_warning");this.props.missingTerms&&(t=(0,l._t)("identity_server|description_optional"),e=(0,l._t)("identity_server|do_not_use")),this.state.disconnectBusy&&(e=i.createElement(oa.A,null)),s=i.createElement(i.Fragment,null,i.createElement(Vs.s,null,t),i.createElement(ie.A,{onClick:this.onDisconnectClicked,kind:"danger_sm"},e))}return i.createElement(to.A,{legend:t,description:n},i.createElement("form",{className:"mx_SetIdServer",onSubmit:this.checkIdServer},i.createElement(ks.A,{label:(0,l._t)("identity_server|url_field_label"),type:"text",autoComplete:"off",placeholder:this.state.defaultIdServer,value:this.state.idServer,onChange:this.onIdentityServerChanged,tooltipContent:this.getTooltip(),tooltipClassName:"mx_SetIdServer_tooltip",disabled:this.state.busy,forceValidity:!this.state.error&&void 0}),i.createElement(ie.A,{type:"submit",kind:"primary_sm",onClick:this.checkIdServer,disabled:!this.idServerChangeEnabled()},(0,l._t)("action|change")),s))}}class cw extends i.Component{constructor(e){super(e),(0,v.A)(this,"togglePolicy",(e=>{const t=(0,$t.ZV)(this.state.policies);t[e].checked=!t[e].checked,this.setState({policies:t})})),(0,v.A)(this,"onContinue",(()=>{!!this.state.policies.some((e=>!e.checked))||(this.setState({busy:!0}),this.props.onFinished(this.state.policies.map((e=>e.url))))})),this.state={policies:[],busy:!1}}componentDidMount(){const e=[];for(const t of this.props.policiesAndServicePairs){const n=Object.values(t.policies);for(const t of n){const n=(0,l.CO)(Object.keys(t).filter((e=>"version"!==e))),i={checked:!1,url:t[n].url,name:t[n].name};e.push(i)}}this.setState({policies:e})}renderCheckboxes(){const e=[];for(let t=0;t<this.state.policies.length;t++){const n=this.state.policies[t],s=(0,l._t)("terms|inline_intro_text",{},{policyLink:()=>i.createElement("a",{href:n.url,rel:"noreferrer noopener",target:"_blank"},n.name,i.createElement("span",{className:"mx_InlineTermsAgreement_link"}))});e.push(i.createElement("div",{key:t,className:"mx_InlineTermsAgreement_cbContainer"},i.createElement("div",null,s),i.createElement("div",{className:"mx_InlineTermsAgreement_checkbox"},i.createElement(Ms.A,{onChange:()=>this.togglePolicy(t),checked:n.checked},(0,l._t)("action|accept")))))}return e}render(){const e=!!this.state.policies.some((e=>!e.checked));return i.createElement("div",null,this.props.introElement,this.renderCheckboxes(),i.createElement(ie.A,{onClick:this.onContinue,disabled:e||this.state.busy,kind:"primary_sm"},(0,l._t)("action|continue")))}}var dw=n("./src/Terms.ts");const mw=()=>{const e=(0,Hn.nH)(),[t,n]=(0,i.useState)(!0),[r,a]=(0,i.useState)([]),[c,d]=(0,i.useState)([]),[m,u]=(0,i.useState)((0,lh.FO)(e.getIdentityServerUrl())),[h,p]=(0,i.useState)({policiesAndServices:null,agreedUrls:null,resolve:null}),[g,v]=(0,i.useState)(!1),_=(0,i.useCallback)((async()=>{n(!0);const t=await rw(e);a(t.filter((e=>e.medium===o.ThreepidMedium.Email))),d(t.filter((e=>e.medium===o.ThreepidMedium.Phone))),n(!1)}),[e]);if((0,Ws.F)(S.A,(0,i.useCallback)((t=>{"id_server_changed"===t.action&&(u((0,lh.FO)(e.getIdentityServerUrl())),_().then())}),[e,_])),(0,i.useEffect)((()=>{(async()=>{try{await _();const t=e.getIdentityServerUrl();if(!t)return;const n=new dv.A;try{const i=await n.getAccessToken({check:!1});await(0,dw.gw)(e,[new dw.kl(o.SERVICE_TYPES.IS,t,i)],((e,n,i)=>new Promise((i=>{u((0,lh.FO)(t)),v(!0),p({policiesAndServices:e,agreedUrls:n,resolve:i})})))),v(!1)}catch(e){s.v.warn(`Unable to reach identity server at ${t} to check for terms in Settings`),s.v.warn(e)}}catch{}})()}),[e,_]),!M.A.getValue(He.f.ThirdPartyID))return null;if(g&&h.policiesAndServices){const e=i.createElement(Cy.F,{type:"info",title:(0,l._t)("settings|general|discovery_needs_terms_title")},(0,l._t)("settings|general|discovery_needs_terms",{serverName:m}));return i.createElement(i.Fragment,null,i.createElement(cw,{policiesAndServicePairs:h.policiesAndServices,agreedUrls:h.agreedUrls,onFinished:h.resolve,introElement:e}),i.createElement(lw,{missingTerms:!0}))}let f;return m&&(f=i.createElement(i.Fragment,null,i.createElement(Vs.P,{heading:(0,l._t)("settings|general|emails_heading"),description:0===r.length?(0,l._t)("settings|general|discovery_email_empty"):void 0,stretchContent:!0},i.createElement(fb,{mode:"is",medium:o.ThreepidMedium.Email,threepids:r,onChange:_,disabled:!g,isLoading:t})),i.createElement(Vs.P,{heading:(0,l._t)("settings|general|msisdns_heading"),description:0===c.length?(0,l._t)("settings|general|discovery_msisdn_empty"):void 0,stretchContent:!0},i.createElement(fb,{mode:"is",medium:o.ThreepidMedium.Phone,threepids:c,onChange:_,disabled:!g,isLoading:t})))),i.createElement(Vs.P,{heading:(0,l._t)("settings|discovery|title"),stretchContent:!0},f,i.createElement(lw,{missingTerms:!1}))};var uw=n("./src/components/views/elements/ToggleSwitch.tsx");class hw extends i.Component{constructor(e){super(e),(0,v.A)(this,"onProvisioningToggled",(()=>{const e=this.state.provisioningEnabled;M.A.setValue("integrationProvisioning",null,O.p.ACCOUNT,!e).catch((t=>{s.v.error("Error changing integration manager provisioning"),s.v.error(t),this.setState({provisioningEnabled:e})})),this.setState({provisioningEnabled:!e})}));const t=U.J.sharedInstance().getPrimaryManager();this.state={currentManager:t,provisioningEnabled:M.A.getValue("integrationProvisioning")}}render(){const e=this.state.currentManager;let t,n;return e?(t=`(${e.name})`,n=(0,l._t)("integration_manager|use_im_default",{serverName:e.name},{b:e=>i.createElement("strong",null,e)})):n=(0,l._t)("integration_manager|use_im"),M.A.getValue(He.f.Widgets)?i.createElement("label",{className:"mx_SetIntegrationManager",htmlFor:"toggle_integration"},i.createElement("div",{className:"mx_SettingsFlag"},i.createElement("div",{className:"mx_SetIntegrationManager_heading_manager"},i.createElement(Ql.A,{size:"3"},(0,l._t)("integration_manager|manage_title")),i.createElement(Ql.A,{size:"4"},t)),i.createElement(uw.A,{id:"toggle_integration",checked:this.state.provisioningEnabled,disabled:!1,onChange:this.onProvisioningToggled})),i.createElement(Vs.s,null,n),i.createElement(Vs.s,null,(0,l._t)("integration_manager|explainer"))):null}}const pw=()=>{const{dehydratedDeviceId:e}=ow();return e?i.createElement("div",{className:"mx_SettingsSubsection_content"},i.createElement("div",{className:"mx_SettingsFlag_label"},(0,l._t)("settings|security|dehydrated_device_enabled")),i.createElement("div",{className:"mx_SettingsSubsection_text"},(0,l._t)("settings|security|dehydrated_device_description"))):null};class gw extends i.Component{constructor(...e){super(...e),(0,v.A)(this,"onUnignoreClicked",(()=>{this.props.onUnignored(this.props.userId)}))}render(){const e=`mx_SecurityUserSettingsTab_ignoredUser_${this.props.userId}`;return i.createElement("div",{className:"mx_SecurityUserSettingsTab_ignoredUser"},i.createElement(ie.A,{onClick:this.onUnignoreClicked,kind:"primary_sm","aria-describedby":e,disabled:this.props.inProgress},(0,l._t)("action|unignore")),i.createElement("span",{id:e},this.props.userId))}}class vw extends i.Component{constructor(e){super(e),(0,v.A)(this,"dispatcherRef",void 0),(0,v.A)(this,"onAction",(({action:e})=>{if("ignore_state_changed"===e){const e=_.J.safeGet().getIgnoredUsers(),t=this.state.waitingUnignored.filter((t=>e.includes(t)));this.setState({ignoredUserIds:e,waitingUnignored:t})}})),(0,v.A)(this,"onMyMembership",((e,t)=>{e.isSpaceRoom()||(t===ut.O.Invite?this.addInvitedRoom(e):this.state.invitedRoomIds.has(e.roomId)&&this.removeInvitedRoom(e.roomId))})),(0,v.A)(this,"addInvitedRoom",(e=>{this.setState((({invitedRoomIds:t})=>({invitedRoomIds:new Set(t).add(e.roomId)})))})),(0,v.A)(this,"removeInvitedRoom",(e=>{this.setState((({invitedRoomIds:t})=>{const n=new Set(t);return n.delete(e),{invitedRoomIds:n}}))})),(0,v.A)(this,"onUserUnignored",(async e=>{const{ignoredUserIds:t,waitingUnignored:n}=this.state,i=t.filter((e=>!n.includes(e))),s=i.indexOf(e);-1!==s&&(i.splice(s,1),this.setState((({waitingUnignored:t})=>({waitingUnignored:[...t,e]}))),_.J.safeGet().setIgnoredUsers(i))})),(0,v.A)(this,"getInvitedRooms",(()=>_.J.safeGet().getRooms().filter((e=>e.hasMembershipState(_.J.safeGet().getUserId(),ut.O.Invite))))),(0,v.A)(this,"manageInvites",(async e=>{this.setState({managingInvites:!0});const t=Array.from(this.state.invitedRoomIds),n=_.J.safeGet(),i=e?n.joinRoom.bind(n):n.leave.bind(n);for(let e=0;e<t.length;e++){const n=t[e];await i(n).then((()=>{this.removeInvitedRoom(n)}),(async t=>{"M_LIMIT_EXCEEDED"===t.errcode?(await(0,ur.yy)(t.retry_after_ms||2500),e--):s.v.warn(t)}))}this.setState({managingInvites:!1})})),(0,v.A)(this,"onAcceptAllInvitesClicked",(()=>{this.manageInvites(!0)})),(0,v.A)(this,"onRejectAllInvitesClicked",(()=>{this.manageInvites(!1)}));const t=new Set(this.getInvitedRooms().map((e=>e.roomId)));this.state={ignoredUserIds:_.J.safeGet().getIgnoredUsers(),waitingUnignored:[],managingInvites:!1,invitedRoomIds:t}}componentDidMount(){this.dispatcherRef=S.A.register(this.onAction),_.J.safeGet().on(o.RoomEvent.MyMembership,this.onMyMembership),_.J.safeGet().getVersions().then((e=>this.setState({versions:e})))}componentWillUnmount(){S.A.unregister(this.dispatcherRef),_.J.safeGet().removeListener(o.RoomEvent.MyMembership,this.onMyMembership)}renderIgnoredUsers(){const{waitingUnignored:e,ignoredUserIds:t}=this.state,n=null!=t&&t.length?t.map((t=>i.createElement(gw,{userId:t,onUnignored:this.onUserUnignored,key:t,inProgress:e.includes(t)}))):(0,l._t)("settings|security|ignore_users_empty");return i.createElement(Vs.P,{heading:(0,l._t)("settings|security|ignore_users_section")},i.createElement(Vs.s,null,n))}renderManageInvites(){const{invitedRoomIds:e}=this.state;return 0===e.size?null:i.createElement(Vs.P,{heading:(0,l._t)("settings|security|bulk_options_section")},i.createElement("div",{className:"mx_SecurityUserSettingsTab_bulkOptions"},i.createElement(ie.A,{onClick:this.onAcceptAllInvitesClicked,kind:"primary_outline",disabled:this.state.managingInvites},(0,l._t)("settings|security|bulk_options_accept_all_invites",{invitedRooms:e.size})),i.createElement(ie.A,{onClick:this.onRejectAllInvitesClicked,kind:"danger_outline",disabled:this.state.managingInvites},(0,l._t)("settings|security|bulk_options_reject_all_invites",{invitedRooms:e.size})),this.state.managingInvites?i.createElement(oa.A,null):i.createElement("div",null)))}render(){const e=i.createElement(Vs.P,{heading:(0,l._t)("common|secure_backup")},i.createElement(qb,null),i.createElement(pw,null)),t=i.createElement(Vs.P,{heading:(0,l._t)("settings|security|message_search_section")},i.createElement(ew,null)),n=i.createElement(Vs.P,{heading:(0,l._t)("common|cross_signing")},i.createElement(Xb,null));let s,o,r;if((0,su.u)(_.J.safeGet())||(s=i.createElement("div",{className:"mx_SecurityUserSettingsTab_warning"},(0,l._t)("settings|security|e2ee_default_disabled_warning"))),B.Vo.instance.isEnabled()){const e=()=>{ey({primaryButton:(0,l._t)("action|ok"),hasCancel:!1})};o=i.createElement(Fs.X,{heading:(0,l._t)("common|privacy")},i.createElement(mw,null),i.createElement(Vs.P,{heading:(0,l._t)("common|analytics"),description:(0,l._t)("settings|security|analytics_description")},i.createElement(ie.A,{kind:"link",onClick:e},(0,l._t)("action|learn_more")),B.Vo.instance.isEnabled()&&i.createElement(Ab.A,{name:"pseudonymousAnalyticsOptIn",level:O.p.ACCOUNT})),i.createElement(Vs.P,{heading:(0,l._t)("settings|sessions|title")},i.createElement(Ab.A,{name:"deviceClientInformationOptIn",level:O.p.ACCOUNT})))}if(M.A.getValue(He.f.AdvancedSettings)){const e=this.renderIgnoredUsers(),t=this.renderManageInvites();(e||t)&&(r=i.createElement(Fs.X,{heading:(0,l._t)("common|advanced")},e,t))}return i.createElement(Us.A,null,s,i.createElement(hw,null),i.createElement(Fs.X,{heading:(0,l._t)("settings|security|encryption_section")},e,t,n,i.createElement(Yb,null)),o,r)}}const _w=["icon","label","onDeleteClick","disabled"],fw=e=>{let{icon:t,label:n,onDeleteClick:s,disabled:o=!1}=e,r=(0,g.A)(e,_w);return i.createElement("div",(0,_t.A)({className:"mx_Tag"},r),null==t?void 0:t(),n,s&&i.createElement(ie.A,{"aria-label":"Remove",className:"mx_Tag_delete",onClick:s,disabled:o},i.createElement(p_.A,null)))};class Ew extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,"onInputChange",(e=>{this.setState({newTag:e.target.value})})),(0,v.A)(this,"onAdd",(e=>{e.preventDefault(),this.state.newTag&&(this.props.onAdd(this.state.newTag),this.setState({newTag:""}))})),this.state={newTag:""}}onRemove(e){this.props.onRemove(e)}render(){return i.createElement("div",{className:dt()("mx_TagComposer",{mx_TagComposer_disabled:this.props.disabled})},i.createElement("form",{className:"mx_TagComposer_input",onSubmit:this.onAdd},i.createElement(ks.A,{id:this.props.id?this.props.id+"_field":void 0,value:this.state.newTag,onChange:this.onInputChange,label:this.props.label||(0,l._t)("notifications|keyword"),placeholder:this.props.placeholder||(0,l._t)("notifications|keyword_new"),disabled:this.props.disabled,autoComplete:"off"}),i.createElement(ie.A,{onClick:this.onAdd,kind:"primary",disabled:this.props.disabled},(0,l._t)("action|add"))),i.createElement("div",{className:"mx_TagComposer_tags",role:"list"},this.props.tags.map(((e,t)=>i.createElement(fw,{label:e,key:e,onDeleteClick:this.onRemove.bind(this,e),disabled:this.props.disabled,role:"listitem"})))))}}var yw=n("./src/components/views/typography/Caption.tsx"),bw=n("./src/components/views/settings/shared/SettingsSubsectionHeading.tsx");function ww(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Sw(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ww(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ww(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Aw=function(e){return e.Loading="loading",e.Ready="ready",e.Persisting="persisting",e.Error="error",e.SavingError="savingError",e}(Aw||{}),Cw=function(e){return e.Master="master",e.VectorGlobal="vector_global",e.VectorMentions="vector_mentions",e.VectorOther="vector_other",e.Other="other",e}(Cw||{});const xw="_keywords",kw=Cw.VectorMentions,Rw=[o.RuleId.DM,o.RuleId.EncryptedDM,o.RuleId.Message,o.RuleId.EncryptedMessage,o.RuleId.ContainsDisplayName,o.RuleId.ContainsUserName,o.RuleId.AtRoomNotification,o.RuleId.InviteToSelf,o.RuleId.IncomingCall,o.RuleId.SuppressNotices,o.RuleId.Tombstone],Iw=[OE.Off,OE.On,OE.Loud],Tw=(e,t,n)=>{var i;if(null===(i=n.syncedRuleIds)||void 0===i||!i.length)return;const s=n.syncedRuleIds.reduce(((t,i)=>{if(t===OE.Loud)return t;const s=((e,t)=>{for(const n in t){const i=t[n].find((t=>t.rule_id===e));if(i)return i}})(i,e);if(s){const e=n.ruleToVectorState(s);if(e&&Iw.indexOf(e)>Iw.indexOf(t))return e}return t}),n.ruleToVectorState(t));return s},Pw=()=>i.createElement("div",null,i.createElement(Ab.A,{name:"Notifications.showbold",level:O.p.DEVICE}),i.createElement(Ab.A,{name:"Notifications.tac_only_notifications",level:O.p.DEVICE}));class Nw extends i.PureComponent{constructor(e){var t;super(e),(0,v.A)(this,"settingWatchers",[]),(0,v.A)(this,"onMasterRuleChanged",(async e=>{this.setState({phase:Aw.Persisting});const t=this.state.masterPushRule;try{await _.J.safeGet().setPushRuleEnabled("global",t.kind,t.rule_id,!e),await this.refreshFromServer()}catch(e){this.setState({phase:Aw.Error}),s.v.error("Error updating master push rule:",e),this.showSaveError()}})),(0,v.A)(this,"setSavingError",(e=>{this.setState((({ruleIdsWithError:t})=>({phase:Aw.SavingError,ruleIdsWithError:Sw(Sw({},t),{},{[e]:!0})})))})),(0,v.A)(this,"updateDeviceNotifications",(async e=>{await M.A.setValue("deviceNotificationsEnabled",null,O.p.DEVICE,e)})),(0,v.A)(this,"onEmailNotificationsChanged",(async(e,t)=>{this.setState({phase:Aw.Persisting});try{if(t)await _.J.safeGet().setPusher({kind:"email",app_id:"m.email",pushkey:e,app_display_name:"Email Notifications",device_display_name:e,lang:navigator.language,data:{brand:c.Ay.get().brand},append:!0});else{var n;const t=null===(n=this.state.pushers)||void 0===n?void 0:n.find((t=>"email"===t.kind&&t.pushkey===e));t&&await _.J.safeGet().removePusher(t.pushkey,t.app_id)}await this.refreshFromServer()}catch(e){this.setState({phase:Aw.Error}),s.v.error("Error updating email pusher:",e),this.showSaveError()}})),(0,v.A)(this,"onDesktopNotificationsChanged",(async e=>{await M.A.setValue("notificationsEnabled",null,O.p.DEVICE,e)})),(0,v.A)(this,"onDesktopShowBodyChanged",(async e=>{await M.A.setValue("notificationBodyEnabled",null,O.p.DEVICE,e)})),(0,v.A)(this,"onAudioNotificationsChanged",(async e=>{await M.A.setValue("audioNotificationsEnabled",null,O.p.DEVICE,e)})),(0,v.A)(this,"onRadioChecked",(async(e,t)=>{this.setState((({ruleIdsWithError:t})=>({phase:Aw.Persisting,ruleIdsWithError:Sw(Sw({},t),{},{[e.ruleId]:!1})})));try{const n=_.J.safeGet();if(e.ruleId===xw){if(!this.state.vectorKeywordRuleInfo)throw new Error("Notification data is incomplete.");for(const e of this.state.vectorKeywordRuleInfo.rules){let i,s;t===OE.On?(1!==e.actions.length&&(s=LE.actionsFor(t)),this.state.vectorKeywordRuleInfo.vectorState===OE.Off&&(i=!0)):t===OE.Loud?(3!==e.actions.length&&(s=LE.actionsFor(t)),this.state.vectorKeywordRuleInfo.vectorState===OE.Off&&(i=!0)):i=!1,s&&await n.setPushRuleActions("global",e.kind,e.rule_id,s),void 0!==i&&await n.setPushRuleEnabled("global",e.kind,e.rule_id,i)}}else{const i=FE[e.ruleId],s=i.vectorStateToActions[t];if(!e.rule)throw new Error("Cannot update rule: push rule data is incomplete.");await BE(n,e.rule.rule_id,e.rule.kind,s),await jE(n,i.syncedRuleIds,s)}await this.refreshFromServer()}catch(t){this.setSavingError(e.ruleId),s.v.error("Error updating push rule:",t)}})),(0,v.A)(this,"onClearNotificationsClicked",(async()=>{try{this.setState({clearingNotifications:!0});const e=_.J.safeGet();await(0,mi.XC)(e)}finally{this.setState({clearingNotifications:!1})}})),(0,v.A)(this,"onKeywordAdd",(e=>{if(!this.state.vectorKeywordRuleInfo)throw new Error("Notification data is incomplete.");const t=(0,$t.ZV)(this.state.vectorKeywordRuleInfo.rules);this.setState({phase:Aw.Persisting,vectorKeywordRuleInfo:Sw(Sw({},this.state.vectorKeywordRuleInfo),{},{rules:[...this.state.vectorKeywordRuleInfo.rules,{pattern:e}]})},(async()=>{await this.setKeywords(this.state.vectorKeywordRuleInfo.rules.map((e=>e.pattern)),t)}))})),(0,v.A)(this,"onKeywordRemove",(e=>{if(!this.state.vectorKeywordRuleInfo)throw new Error("Notification data is incomplete.");const t=(0,$t.ZV)(this.state.vectorKeywordRuleInfo.rules);this.setState({phase:Aw.Persisting,vectorKeywordRuleInfo:Sw(Sw({},this.state.vectorKeywordRuleInfo),{},{rules:this.state.vectorKeywordRuleInfo.rules.filter((t=>t.pattern!==e))})},(async()=>{await this.setKeywords(this.state.vectorKeywordRuleInfo.rules.map((e=>e.pattern)),t)}))})),this.state={phase:Aw.Loading,deviceNotificationsEnabled:null===(t=M.A.getValue("deviceNotificationsEnabled"))||void 0===t||t,desktopNotifications:M.A.getValue("notificationsEnabled"),desktopShowBody:M.A.getValue("notificationBodyEnabled"),audioNotifications:M.A.getValue("audioNotificationsEnabled"),clearingNotifications:!1,ruleIdsWithError:{}}}get isInhibited(){var e;return!(null===(e=this.state.masterPushRule)||void 0===e||!e.enabled)}componentDidMount(){this.settingWatchers=[M.A.watchSetting("notificationsEnabled",null,((...[,,,,e])=>this.setState({desktopNotifications:e}))),M.A.watchSetting("deviceNotificationsEnabled",null,((...[,,,,e])=>{this.setState({deviceNotificationsEnabled:e})})),M.A.watchSetting("notificationBodyEnabled",null,((...[,,,,e])=>this.setState({desktopShowBody:e}))),M.A.watchSetting("audioNotificationsEnabled",null,((...[,,,,e])=>this.setState({audioNotifications:e})))],this.refreshFromServer(),this.refreshFromAccountData()}componentWillUnmount(){this.settingWatchers.forEach((e=>M.A.unwatchSetting(e)))}componentDidUpdate(e,t){this.state.deviceNotificationsEnabled!==t.deviceNotificationsEnabled&&this.persistLocalNotificationSettings(this.state.deviceNotificationsEnabled)}async refreshFromServer(){try{const e=(await Promise.all([this.refreshRules(),this.refreshPushers(),this.refreshThreepids()])).reduce(((e,t)=>Object.assign(t,e)),{});this.setState(Sw(Sw({},e),{},{phase:Aw.Ready}))}catch(e){s.v.error("Error setting up notifications for settings: ",e),this.setState({phase:Aw.Error})}}async refreshFromAccountData(){const e=_.J.safeGet(),t=e.getAccountData((0,mi.uG)(e.deviceId));if(t){const e=!t.getContent().is_silenced;await this.updateDeviceNotifications(e)}}persistLocalNotificationSettings(e){const t=_.J.safeGet();return t.setAccountData((0,mi.uG)(t.deviceId),{is_silenced:!e})}async refreshRules(){const e=await _.J.safeGet().getPushRules(),t={[o.RuleId.Master]:Cw.Master,[o.RuleId.DM]:Cw.VectorGlobal,[o.RuleId.EncryptedDM]:Cw.VectorGlobal,[o.RuleId.Message]:Cw.VectorGlobal,[o.RuleId.EncryptedMessage]:Cw.VectorGlobal,[o.RuleId.ContainsDisplayName]:Cw.VectorMentions,[o.RuleId.ContainsUserName]:Cw.VectorMentions,[o.RuleId.AtRoomNotification]:Cw.VectorMentions,[o.RuleId.InviteToSelf]:Cw.VectorOther,[o.RuleId.IncomingCall]:Cw.VectorOther,[o.RuleId.SuppressNotices]:Cw.VectorOther,[o.RuleId.Tombstone]:Cw.VectorOther},n={[Cw.Master]:[],[Cw.VectorGlobal]:[],[Cw.VectorMentions]:[],[Cw.VectorOther]:[],[Cw.Other]:[]};for(const s in e.global){const o=s;for(const s of e.global[o]){var i;const e=Object.assign(s,{kind:o}),r=null!==(i=t[e.rule_id])&&void 0!==i?i:Cw.Other;"."===e.rule_id[0]&&n[r].push(e)}}const s={};if(!(n.master.length>0))throw new Error("Failed to locate a master push rule");s.masterPushRule=n.master[0],s.vectorKeywordRuleInfo=VE.parseContentRules(e),s.vectorPushRules={};const r=[Cw.VectorGlobal,Cw.VectorMentions,Cw.VectorOther];for(const e of r){s.vectorPushRules[e]=[];for(const t of n[e]){const i=FE[t.rule_id],o=i.ruleToVectorState(t);s.vectorPushRules[e].push({ruleId:t.rule_id,rule:t,vectorState:o,syncedVectorState:Tw(n,t,i),description:(0,l._t)(i.description)})}s.vectorPushRules[e].sort(((e,t)=>{let n=Rw.indexOf(e.ruleId),i=Rw.indexOf(t.ruleId);return n<0&&(n=Rw.length),i<0&&(i=Rw.length),n-i})),e===kw&&s.vectorPushRules[e].push({ruleId:xw,description:(0,l._t)("settings|notifications|messages_containing_keywords"),vectorState:s.vectorKeywordRuleInfo.vectorState})}return s}refreshPushers(){return _.J.safeGet().getPushers()}refreshThreepids(){return _.J.safeGet().getThreePids()}showSaveError(){k.Ay.createDialog(nt.A,{title:(0,l._t)("settings|notifications|error_saving"),description:(0,l._t)("settings|notifications|error_saving_detail")})}async setKeywords(e,t){try{const n=(0,Z.Bo)(Array.from(new Set(e))),i=(0,Z.Bo)(Array.from(new Set(t.map((e=>e.pattern))))),s=(0,Z.ZQ)(i,n);for(const e of s.removed)for(const n of t.filter((t=>t.pattern===e)))await _.J.safeGet().deletePushRule("global",n.kind,n.rule_id);let r=this.state.vectorKeywordRuleInfo.vectorState;if(r===OE.Off){const e=t.length?LE.contentRuleVectorStateKind(t[0]):void 0;r=null!=e?e:OE.On}const a=o.PushRuleKind.ContentSpecific;for(const e of s.added)await _.J.safeGet().addPushRule("global",a,e,{actions:LE.actionsFor(r),pattern:e}),r===OE.Off&&await _.J.safeGet().setPushRuleEnabled("global",a,e,!1);await this.refreshFromServer()}catch(e){this.setState({phase:Aw.Error}),s.v.error("Error updating keyword push rules:",e),this.showSaveError()}}renderTopSection(){const e=i.createElement(Qs.A,{value:!this.isInhibited,label:(0,l._t)("settings|notifications|enable_notifications_account"),caption:(0,l._t)("settings|notifications|enable_notifications_account_detail"),onChange:this.onMasterRuleChanged,disabled:this.state.phase===Aw.Persisting});if(this.isInhibited)return e;const t=(this.state.threepids||[]).filter((e=>e.medium===o.ThreepidMedium.Email)).map((e=>{var t;return i.createElement(Qs.A,{key:e.address,value:!(null===(t=this.state.pushers)||void 0===t||!t.some((t=>"email"===t.kind&&t.pushkey===e.address))),label:(0,l._t)("settings|notifications|enable_email_notifications",{email:e.address}),onChange:this.onEmailNotificationsChanged.bind(this,e.address),disabled:this.state.phase===Aw.Persisting})}));return i.createElement(Vs.P,null,e,i.createElement(Qs.A,{value:this.state.deviceNotificationsEnabled,label:(0,l._t)("settings|notifications|enable_notifications_device"),onChange:e=>this.updateDeviceNotifications(e),disabled:this.state.phase===Aw.Persisting}),this.state.deviceNotificationsEnabled&&i.createElement(i.Fragment,null,i.createElement(Qs.A,{value:this.state.desktopNotifications,onChange:this.onDesktopNotificationsChanged,label:(0,l._t)("settings|notifications|enable_desktop_notifications_session"),disabled:this.state.phase===Aw.Persisting}),i.createElement(Qs.A,{value:this.state.desktopShowBody,onChange:this.onDesktopShowBodyChanged,label:(0,l._t)("settings|notifications|show_message_desktop_notification"),disabled:this.state.phase===Aw.Persisting}),i.createElement(Qs.A,{value:this.state.audioNotifications,onChange:this.onAudioNotificationsChanged,label:(0,l._t)("settings|notifications|enable_audible_notifications_session"),disabled:this.state.phase===Aw.Persisting})),t)}renderCategory(e){var t;if(this.isInhibited)return null;let n;if(e===Cw.VectorMentions){var s;const e=(0,Z.Bo)((null===(s=this.state.vectorKeywordRuleInfo)||void 0===s?void 0:s.rules.map((e=>e.pattern)))||[]);n=i.createElement(Ew,{tags:e,onAdd:this.onKeywordAdd,onRemove:this.onKeywordRemove,disabled:this.state.phase===Aw.Persisting,label:(0,l._t)("notifications|keyword"),placeholder:(0,l._t)("notifications|keyword_new")})}const o={[OE.On]:(0,l._t)("common|on"),[OE.Off]:(0,l._t)("common|off"),[OE.Loud]:(0,l._t)("settings|notifications|noisy")},r=(e,t)=>{var n;return i.createElement(xs.A,{key:e.ruleId+t,name:e.ruleId,checked:(null!==(n=e.syncedVectorState)&&void 0!==n?n:e.vectorState)===t,onChange:this.onRadioChecked.bind(this,e,t),disabled:this.state.phase===Aw.Persisting,"aria-label":o[t]})},a=null===(t=this.state.vectorPushRules)||void 0===t||null===(t=t[e])||void 0===t?void 0:t.map((t=>i.createElement("fieldset",{key:e+t.ruleId,className:"mx_UserNotifSettings_gridRowContainer"},i.createElement("legend",{className:"mx_UserNotifSettings_gridRowLabel"},t.description),r(t,OE.Off),r(t,OE.On),r(t,OE.Loud),this.state.ruleIdsWithError[t.ruleId]&&i.createElement("div",{className:"mx_UserNotifSettings_gridRowError"},i.createElement(yw.H,{isError:!0},(0,l._t)("settings|notifications|error_updating"))))));let c;switch(e){case Cw.VectorGlobal:c=(0,l._t)("notifications|class_global");break;case Cw.VectorMentions:c=(0,l._t)("notifications|mentions_keywords");break;case Cw.VectorOther:c=(0,l._t)("notifications|class_other");break;default:throw new Error("Developer error: Unnamed notifications section: "+e)}return i.createElement("div",null,i.createElement("div",{className:"mx_UserNotifSettings_grid"},i.createElement(bw.r,{heading:c}),i.createElement("span",{className:"mx_UserNotifSettings_gridColumnLabel"},o[OE.Off]),i.createElement("span",{className:"mx_UserNotifSettings_gridColumnLabel"},o[OE.On]),i.createElement("span",{className:"mx_UserNotifSettings_gridColumnLabel"},o[OE.Loud]),a),n)}renderTargets(){var e;if(this.isInhibited)return null;const t=null===(e=this.state.pushers)||void 0===e?void 0:e.map((e=>i.createElement("tr",{key:e.kind+e.pushkey},i.createElement("td",null,e.app_display_name),i.createElement("td",null,e.device_display_name))));return null!=t&&t.length?i.createElement("div",{className:"mx_UserNotifSettings_floatingSection"},i.createElement("div",null,(0,l._t)("settings|notifications|push_targets")),i.createElement("table",null,i.createElement("tbody",null,t))):null}render(){if(this.state.phase===Aw.Loading)return i.createElement(se.A,null);if(this.state.phase===Aw.Error)return i.createElement("p",null,(0,l._t)("settings|notifications|error_loading"));let e;return _.J.safeGet().getRooms().some((e=>(0,El.GN)(e,!0)))&&(e=i.createElement(ie.A,{onClick:this.onClearNotificationsClicked,disabled:this.state.clearingNotifications,kind:"danger",className:"mx_UserNotifSettings_clearNotifsButton"},(0,l._t)("notifications|mark_all_read"))),i.createElement(i.Fragment,null,this.renderTopSection(),this.renderCategory(Cw.VectorGlobal),this.renderCategory(Cw.VectorMentions),this.renderCategory(Cw.VectorOther),this.renderTargets(),i.createElement(Pw,null),e)}}var Dw=n("./src/RoomNotifs.ts");function Mw(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Ow(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Mw(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Mw(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Lw(e){const t=new Map;for(const i of Object.values(o.PushRuleKind))for(const s of null!==(n=e.global[i])&&void 0!==n?n:[]){var n;s.rule_id.startsWith(".")&&t.set(s.rule_id,Ow(Ow({},s),{},{kind:i}))}return t}function Uw(e,t,n){var i,s;const r={updated:[],added:[],deleted:[]},a=Lw(e),l=function(e,t){const n=new Map;n.set(o.RuleId.Master,{rule_id:o.RuleId.Master,kind:o.PushRuleKind.Override,enabled:e.globalMute}),n.set(o.RuleId.EncryptedMessage,{rule_id:o.RuleId.EncryptedMessage,kind:o.PushRuleKind.Underride,enabled:!0,actions:NE.encodeActions({notify:e.defaultLevels.room===Dw.dC.AllMessages,highlight:!1})}),n.set(o.RuleId.Message,{rule_id:o.RuleId.Message,kind:o.PushRuleKind.Underride,enabled:!0,actions:NE.encodeActions({notify:e.defaultLevels.room===Dw.dC.AllMessages,highlight:!1})}),n.set(o.RuleId.EncryptedDM,{rule_id:o.RuleId.EncryptedDM,kind:o.PushRuleKind.Underride,enabled:!0,actions:NE.encodeActions({notify:e.defaultLevels.dm===Dw.dC.AllMessages,highlight:!1,sound:e.sound.people})}),n.set(o.RuleId.DM,{rule_id:o.RuleId.DM,kind:o.PushRuleKind.Underride,enabled:!0,actions:NE.encodeActions({notify:e.defaultLevels.dm===Dw.dC.AllMessages,highlight:!1,sound:e.sound.people})}),n.set(o.RuleId.SuppressNotices,{rule_id:o.RuleId.SuppressNotices,kind:o.PushRuleKind.Override,enabled:!e.activity.bot_notices,actions:ME.ACTION_DONT_NOTIFY}),n.set(o.RuleId.InviteToSelf,{rule_id:o.RuleId.InviteToSelf,kind:o.PushRuleKind.Override,enabled:e.activity.invite,actions:NE.encodeActions({notify:!0,highlight:!1,sound:e.sound.people})}),n.set(o.RuleId.MemberEvent,{rule_id:o.RuleId.MemberEvent,kind:o.PushRuleKind.Override,enabled:!0,actions:e.activity.status_event?ME.ACTION_NOTIFY:ME.ACTION_DONT_NOTIFY});const i=NE.encodeActions({notify:!0,sound:e.sound.mentions,highlight:!0}),s=e.mentions.user?i:ME.ACTION_DONT_NOTIFY;t&&n.set(o.RuleId.IsUserMention,{rule_id:o.RuleId.IsUserMention,kind:o.PushRuleKind.Override,enabled:!0,actions:s}),n.set(o.RuleId.ContainsDisplayName,{rule_id:o.RuleId.ContainsDisplayName,kind:o.PushRuleKind.Override,enabled:!0,actions:s}),n.set(o.RuleId.ContainsUserName,{rule_id:o.RuleId.ContainsUserName,kind:o.PushRuleKind.ContentSpecific,enabled:!0,actions:s});const r=e.mentions.room?ME.ACTION_NOTIFY:ME.ACTION_DONT_NOTIFY;return t&&n.set(o.RuleId.IsRoomMention,{rule_id:o.RuleId.IsRoomMention,kind:o.PushRuleKind.Override,enabled:!0,actions:r}),n.set(o.RuleId.AtRoomNotification,{rule_id:o.RuleId.AtRoomNotification,kind:o.PushRuleKind.Override,enabled:!0,actions:r}),n.set(o.RuleId.Tombstone,{rule_id:o.RuleId.Tombstone,kind:o.PushRuleKind.Override,enabled:e.activity.status_event,actions:ME.ACTION_HIGHLIGHT}),n.set(o.RuleId.IncomingCall,{rule_id:o.RuleId.IncomingCall,kind:o.PushRuleKind.Underride,enabled:!0,actions:NE.encodeActions({notify:!0,sound:e.sound.calls})}),n}(t,n);for(const e of l.values()){const t=a.get(e.rule_id);let n=!1;if(void 0===t)n=!0;else if(void 0!==e.enabled&&e.enabled!==t.enabled)n=!0;else if(void 0!==e.actions){const i=NE.decodeActions(t.actions),s=NE.decodeActions(e.actions);null===i||null===s?n=!0:(0,ur.ky)(s,i)||(n=!0)}n&&r.updated.push(e)}const c=NE.encodeActions({notify:!0,sound:t.sound.mentions,highlight:!0}),d=null!==(i=null===(s=e.global.content)||void 0===s?void 0:s.filter((e=>!e.rule_id.startsWith("."))))&&void 0!==i?i:[],m=new Set(t.keywords);for(const e of d){if(m.has(e.pattern)){let n=!1;if(e.enabled!==t.mentions.keywords)n=!0;else if(void 0!==e.actions){const t=NE.decodeActions(e.actions),i=NE.decodeActions(c);null===t||null===i?n=!0:(0,ur.ky)(i,t)||(n=!0)}n&&r.updated.push({rule_id:e.rule_id,kind:o.PushRuleKind.ContentSpecific,enabled:t.mentions.keywords,actions:c})}else r.deleted.push({rule_id:e.rule_id,kind:o.PushRuleKind.ContentSpecific});m.delete(e.pattern)}for(const e of m)r.added.push({rule_id:e,kind:o.PushRuleKind.ContentSpecific,default:!1,enabled:t.mentions.keywords,pattern:e,actions:c});return r}function Fw(e){if(0===e.length)return!0;for(const t of e){if(null==t||!1===t||!t.enabled)continue;const e=NE.decodeActions(t.actions);if(null!==e&&e.notify)return!0}return!1}function Vw(e){if(0===e.length)return!1;for(const t of e){if(null==t||!1===t||!t.enabled)continue;const e=NE.decodeActions(t.actions);if(null!==e&&!e.notify&&!0!==e.highlight&&void 0===e.sound)return!0}return!1}function Bw(e){for(const t of e){if(null==t||!1===t||!t.enabled)continue;const e=NE.decodeActions(t.actions);if(null!==e&&e.notify&&void 0!==e.sound)return e.sound}}function jw(e){const t=function(){const e=(0,i.useRef)(null);return(0,i.useCallback)((t=>{let n;return n=null===e.current?t():e.current.then(t),e.current=n,n}),[])}(),n=(0,i.useMemo)((()=>e.supportsIntentionalMentions()),[e]),s=(0,i.useRef)(null),[r,a]=(0,i.useState)(null),[l,c]=(0,i.useState)(!1),d=(0,i.useCallback)((async()=>{const t=await e.getPushRules(),i=function(e,t){var n,i,s,r;const a=Lw(e),l=null!==(n=null===(i=e.global.content)||void 0===i?void 0:i.filter((e=>!e.rule_id.startsWith("."))))&&void 0!==n?n:[],c=[a.get(o.RuleId.DM),a.get(o.RuleId.EncryptedDM)],d=[a.get(o.RuleId.Message),a.get(o.RuleId.EncryptedMessage)];return{globalMute:null!==(s=null===(r=a.get(o.RuleId.Master))||void 0===r?void 0:r.enabled)&&void 0!==s&&s,defaultLevels:{room:Fw(d)?Dw.dC.AllMessages:Dw.dC.MentionsOnly,dm:Fw(c)?Dw.dC.AllMessages:Dw.dC.MentionsOnly},sound:{calls:Bw([a.get(o.RuleId.IncomingCall)]),mentions:Bw([t&&a.get(o.RuleId.IsUserMention),a.get(o.RuleId.ContainsUserName),a.get(o.RuleId.ContainsDisplayName),...l]),people:Bw(c)},activity:{bot_notices:!Vw([a.get(o.RuleId.SuppressNotices)]),invite:Fw([a.get(o.RuleId.InviteToSelf)]),status_event:Fw([a.get(o.RuleId.MemberEvent),a.get(o.RuleId.Tombstone)])},mentions:{user:Fw([t&&a.get(o.RuleId.IsUserMention),a.get(o.RuleId.ContainsUserName),a.get(o.RuleId.ContainsDisplayName)]),room:Fw([t&&a.get(o.RuleId.IsRoomMention),a.get(o.RuleId.AtRoomNotification)]),keywords:Fw(l)},keywords:l.map((e=>e.pattern))}}(t,n),r=Uw(t,i,n);s.current=t,c(r.updated.length>0||r.added.length>0||r.deleted.length>0),a(i)}),[e,n]);(0,i.useEffect)((()=>{t(d).catch((e=>console.error(e)))}),[e,t,d]);const m=(0,i.useCallback)((i=>{a(i),t((async()=>{if(null!==s.current){const t=Uw(s.current,i,n);await async function(e,t){await Promise.all(t.deleted.map((t=>e.deletePushRule("global",t.kind,t.rule_id)))),await Promise.all(t.added.map((t=>e.addPushRule("global",t.kind,t.rule_id,t)))),await Promise.all(t.updated.map((async t=>{void 0!==t.enabled&&await e.setPushRuleEnabled("global",t.kind,t.rule_id,t.enabled),void 0!==t.actions&&await e.setPushRuleActions("global",t.kind,t.rule_id,t.actions)})))}(e,t),await d()}})).catch((e=>console.error(e)))}),[t,n,e,d]);return{model:r,hasPendingChanges:l,reconcile:m}}const Ww={globalMute:!1,defaultLevels:{room:Dw.dC.AllMessages,dm:Dw.dC.AllMessages},sound:{people:"default",mentions:"default",calls:"ring"},activity:{invite:!0,status_event:!1,bot_notices:!0},mentions:{user:!0,room:!0,keywords:!0},keywords:[]};function zw({children:e,icon:t,action:n,onAction:s}){return i.createElement("div",{className:"mx_SettingsBanner"},t,i.createElement("div",{className:"mx_SettingsBanner_content"},e),n&&i.createElement(ie.A,{kind:"primary_outline",onClick:null!=s?s:null},n))}function Hw(e,t,n){const[s,o]=(0,i.useState)(n),r=(0,i.useCallback)((()=>{let t=!1;return e().then((e=>{t||o(e)})).catch((e=>console.error(e))),()=>{t=!0}}),t);return(0,i.useEffect)(r,[r]),[s,r]}const Kw=["children"],Jw=e=>{let{children:t}=e,n=(0,g.A)(e,Kw);return i.createElement("div",(0,_t.A)({},n,{className:"mx_SettingsIndent"}),t)};function Gw(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function $w(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Gw(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Gw(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function qw(e){return i.createElement(ie.A,{kind:"link_inline",onClick:()=>{S.A.dispatch({action:W.r.ViewUserSettings,initialTabId:Na.v.Account})}},e)}function Yw(){const e=(0,i.useMemo)((()=>({kind:"email",app_id:"m.email",app_display_name:(0,l._t)("notifications|email_pusher_app_display_name"),lang:navigator.language,data:{brand:c.Ay.get().brand}})),[]),t=(0,Hn.nH)(),[n,s]=function(e){return Hw((()=>e.getPushers().then((e=>e.pushers))),[e],[])}(t),[r,a]=function(e){return Hw((()=>e.getThreePids().then((e=>e.threepids))),[e],[])}(t),d=(0,i.useCallback)(((i,o)=>{if(o)t.setPusher($w($w({},e),{},{pushkey:i,device_display_name:i,append:!0})).catch((e=>console.error(e)));else{const e=n.find((e=>"email"===e.kind&&e.pushkey===i));e&&t.removePusher(e.pushkey,e.app_id).catch((e=>console.error(e)))}a(),s()}),[e,t,n,s,a]),m=n.filter((e=>"email"!==e.kind));return i.createElement(i.Fragment,null,i.createElement(Vs.P,{className:"mx_NotificationPusherSettings",heading:(0,l._t)("settings|notifications|email_section")},i.createElement(Vs.s,{className:"mx_NotificationPusherSettings_description"},(0,l._t)("settings|notifications|email_description")),i.createElement("div",{className:"mx_SettingsSubsection_description mx_NotificationPusherSettings_detail"},i.createElement(Vs.s,null,(0,l._t)("settings|notifications|email_select",{},{button:qw}))),i.createElement(Jw,null,r.filter((e=>e.medium===o.ThreepidMedium.Email)).map((e=>i.createElement(Rs.A,{key:e.address,label:e.address,value:void 0!==n.find((t=>t.pushkey===e.address)),onChange:t=>d(e.address,t)}))))),m.length>0&&i.createElement(Vs.P,{heading:(0,l._t)("settings|notifications|push_targets")},i.createElement("ul",null,n.filter((e=>"email"!==e.kind)).map((e=>i.createElement("li",{key:e.pushkey},e.device_display_name||e.app_display_name))))))}function Qw(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Xw(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Qw(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Qw(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Zw=function(e){return e.AllMessages="all_messages",e.PeopleMentionsKeywords="people_mentions_keywords",e.MentionsKeywords="mentions_keywords",e}(Zw||{});function eS(e){return i.createElement("strong",null,e)}function tS(e){return i.createElement(Ja.A,{href:"https://element.io/help#settings2"},e)}function nS(){var e;const t=(0,Hn.nH)(),n=(0,pt.ti)("notificationsEnabled"),s=(0,pt.ti)("notificationBodyEnabled"),o=(0,pt.ti)("audioNotificationsEnabled"),{model:r,hasPendingChanges:a,reconcile:c}=jw(t),d=null===r||a,m=null!=r?r:Ww,[u,h]=(0,i.useState)(!1),p=(0,Hn.nH)().getRooms().some((e=>e.getUnreadNotificationCount()>0)),g=[{value:Zw.AllMessages,label:(0,l._t)("notifications|all_messages")},{value:Zw.PeopleMentionsKeywords,label:(0,l._t)("settings|notifications|people_mentions_keywords")},{value:Zw.MentionsKeywords,label:(0,l._t)("settings|notifications|mentions_keywords_only")}];return i.createElement("div",{className:"mx_NotificationSettings2"},a&&null!==r&&i.createElement(zw,{icon:i.createElement("img",{src:"img/element-icons/new-and-improved.65a63c7.svg",alt:"",width:12}),action:(0,l._t)("action|proceed"),onAction:()=>c(r)},(0,l._t)("settings|notifications|labs_notice_prompt",{},{strong:eS,a:tS})),i.createElement(Fs.X,null,i.createElement("div",{className:"mx_SettingsSubsection_content mx_NotificationSettings2_flags"},i.createElement(Qs.A,{label:(0,l._t)("settings|notifications|enable_notifications_account"),value:!m.globalMute,disabled:d,onChange:e=>{c(Xw(Xw({},r),{},{globalMute:!e}))}}),i.createElement(Qs.A,{label:(0,l._t)("settings|notifications|enable_desktop_notifications_session"),value:n,onChange:e=>M.A.setValue("notificationsEnabled",null,O.p.DEVICE,e)}),i.createElement(Qs.A,{label:(0,l._t)("settings|notifications|desktop_notification_message_preview"),value:s,onChange:e=>M.A.setValue("notificationBodyEnabled",null,O.p.DEVICE,e)}),i.createElement(Qs.A,{label:(0,l._t)("settings|notifications|enable_audible_notifications_session"),value:o,onChange:e=>M.A.setValue("audioNotificationsEnabled",null,O.p.DEVICE,e)})),i.createElement(Vs.P,{heading:(0,l._t)("settings|notifications|default_setting_section"),description:(0,l._t)("settings|notifications|default_setting_description")},i.createElement(wm.A,{name:"defaultNotificationLevel",value:(v=m.defaultLevels,v.room===Dw.dC.AllMessages?Zw.AllMessages:v.dm===Dw.dC.AllMessages?Zw.PeopleMentionsKeywords:Zw.MentionsKeywords),disabled:d,definitions:g,onChange:e=>{c(Xw(Xw({},r),{},{defaultLevels:Xw(Xw({},r.defaultLevels),{},{dm:e!==Zw.MentionsKeywords?Dw.dC.AllMessages:Dw.dC.MentionsOnly,room:e===Zw.AllMessages?Dw.dC.AllMessages:Dw.dC.MentionsOnly})}))}})),i.createElement(Vs.P,{heading:(0,l._t)("settings|notifications|play_sound_for_section"),description:(0,l._t)("settings|notifications|play_sound_for_description")},i.createElement(Rs.A,{label:"People",value:void 0!==m.sound.people,disabled:d||m.defaultLevels.dm===Dw.dC.MentionsOnly,onChange:e=>{c(Xw(Xw({},r),{},{sound:Xw(Xw({},r.sound),{},{people:e?"default":void 0})}))}}),i.createElement(Rs.A,{label:(0,l._t)("settings|notifications|mentions_keywords"),value:void 0!==m.sound.mentions,disabled:d,onChange:e=>{c(Xw(Xw({},r),{},{sound:Xw(Xw({},r.sound),{},{mentions:e?"default":void 0})}))}}),i.createElement(Rs.A,{label:(0,l._t)("settings|notifications|voip"),value:void 0!==m.sound.calls,disabled:d,onChange:e=>{c(Xw(Xw({},r),{},{sound:Xw(Xw({},r.sound),{},{calls:e?"ring":void 0})}))}})),i.createElement(Vs.P,{heading:(0,l._t)("settings|notifications|other_section")},i.createElement(Rs.A,{label:(0,l._t)("settings|notifications|invites"),value:m.activity.invite,disabled:d,onChange:e=>{c(Xw(Xw({},r),{},{activity:Xw(Xw({},r.activity),{},{invite:e})}))}}),i.createElement(Rs.A,{label:(0,l._t)("settings|notifications|room_activity"),value:m.activity.status_event,disabled:d,onChange:e=>{c(Xw(Xw({},r),{},{activity:Xw(Xw({},r.activity),{},{status_event:e})}))}}),i.createElement(Rs.A,{label:(0,l._t)("settings|notifications|notices"),value:m.activity.bot_notices,disabled:d,onChange:e=>{c(Xw(Xw({},r),{},{activity:Xw(Xw({},r.activity),{},{bot_notices:e})}))}})),i.createElement(Vs.P,{heading:(0,l._t)("settings|notifications|mentions_keywords"),description:(0,l._t)("settings|notifications|keywords",{},{badge:i.createElement(Ni.V,{symbol:"1",count:1,level:da.S.Notification})})},i.createElement(Rs.A,{label:(0,l._t)("settings|notifications|notify_at_room"),value:m.mentions.room,disabled:d,onChange:e=>{c(Xw(Xw({},r),{},{mentions:Xw(Xw({},r.mentions),{},{room:e})}))}}),i.createElement(Rs.A,{label:(0,l._t)("settings|notifications|notify_mention",{mxid:t.getUserId()}),value:m.mentions.user,disabled:d,onChange:e=>{c(Xw(Xw({},r),{},{mentions:Xw(Xw({},r.mentions),{},{user:e})}))}}),i.createElement(Rs.A,{label:(0,l._t)("settings|notifications|notify_keyword"),byline:(0,l._t)("settings|notifications|keywords_prompt"),value:m.mentions.keywords,disabled:d,onChange:e=>{c(Xw(Xw({},r),{},{mentions:Xw(Xw({},r.mentions),{},{keywords:e})}))}}),i.createElement(Ew,{id:"mx_NotificationSettings2_Keywords",tags:null!==(e=null==r?void 0:r.keywords)&&void 0!==e?e:[],disabled:d,onAdd:e=>{c(Xw(Xw({},r),{},{keywords:[e,...r.keywords]}))},onRemove:e=>{c(Xw(Xw({},r),{},{keywords:r.keywords.filter((t=>t!==e))}))},label:(0,l._t)("notifications|keyword"),placeholder:(0,l._t)("notifications|keyword_new")}),i.createElement(Ab.A,{name:"Notifications.showbold",level:O.p.DEVICE}),i.createElement(Ab.A,{name:"Notifications.tac_only_notifications",level:O.p.DEVICE})),i.createElement(Yw,null),i.createElement(Vs.P,{heading:(0,l._t)("settings|notifications|quick_actions_section")},p&&i.createElement(ie.A,{kind:"primary_outline",disabled:u,onClick:async()=>{h(!0),await(0,mi.XC)(t),h(!1)}},(0,l._t)("settings|notifications|quick_actions_mark_all_read")),i.createElement(ie.A,{kind:"danger_outline",disabled:null===r,onClick:()=>{c(Ww)}},(0,l._t)("settings|notifications|quick_actions_reset")))));var v}class iS extends i.Component{render(){const e=M.A.getValue(Sl.O5.NotificationSettings2);return i.createElement(Us.A,null,e?i.createElement(nS,null):i.createElement(Fs.X,null,i.createElement(Nw,null)))}}class sS extends i.Component{constructor(e){super(e),(0,v.A)(this,"onSearchChange",(e=>{this.setState({searchQuery:e})})),this.state={searchQuery:"",langs:null}}componentDidMount(){if(l.om().then((e=>{e.sort((function(e,t){return e.labelInTargetLanguage<t.labelInTargetLanguage?-1:e.labelInTargetLanguage>t.labelInTargetLanguage?1:0})),this.setState({langs:e})})).catch((()=>{this.setState({langs:[{value:"en",label:"English",labelInTargetLanguage:"English"}]})})),!this.props.value){const e=l.mf();this.props.onOptionChange(e)}}render(){if(null===this.state.langs)return i.createElement(se.A,null);let e;e=this.state.searchQuery?this.state.langs.filter((e=>function(e,t){return!!t.labelInTargetLanguage.toUpperCase().includes(e.toUpperCase())||!!t.label.toUpperCase().includes(e.toUpperCase())||t.value.toUpperCase()===e.toUpperCase()}(this.state.searchQuery,e))):this.state.langs;const t=e.map((e=>i.createElement("div",{key:e.value},e.labelInTargetLanguage)));let n,s=M.A.getValue("language",null,!0);return s||(s=navigator.language||navigator.userLanguage),n=this.props.value||s,i.createElement(Ma.A,{id:"mx_LanguageDropdown",className:dt()("mx_LanguageDropdown",this.props.className),onOptionChange:this.props.onOptionChange,onSearchChange:this.onSearchChange,searchEnabled:!0,value:n,label:(0,l._t)("language_dropdown_label"),disabled:this.props.disabled},t)}}class oS extends i.Component{constructor(e){super(e),this.onSearchChange=this.onSearchChange.bind(this),this.state={searchQuery:""}}componentDidMount(){const e=a.A.get();if(e){var t;const n=new Intl.DisplayNames([(0,l.mf)()],{type:"language",style:"short"});null===(t=e.getAvailableSpellCheckLanguages())||void 0===t||t.then((e=>{e.sort((function(e,t){return e<t?-1:e>t?1:0}));const t=[];e.forEach((e=>{t.push({label:n.of(e),value:e})})),this.setState({languages:t})})).catch((e=>{this.setState({languages:[{value:"en",label:n.of("en")}]})}))}}onSearchChange(e){this.setState({searchQuery:e})}render(){if(!this.state.languages)return i.createElement(se.A,null);let e;e=this.state.searchQuery?this.state.languages.filter((e=>function(e,t){return!!t.label.toUpperCase().includes(e.toUpperCase())||t.value.toUpperCase()===e.toUpperCase()}(this.state.searchQuery,e))):this.state.languages;const t=e.map((e=>i.createElement("div",{key:e.value},e.label)));let n,s=M.A.getValue("language",null,!0);return s||(s=navigator.language||navigator.userLanguage),n=this.props.value||s,i.createElement(Ma.A,{id:"mx_LanguageDropdown",className:this.props.className,onOptionChange:this.props.onOptionChange,onSearchChange:this.onSearchChange,searchEnabled:!0,value:n,label:(0,l._t)("language_dropdown_label"),placeholder:(0,l._t)("settings|general|spell_check_locale_placeholder")},t)}}class rS extends i.Component{constructor(...e){super(...e),(0,v.A)(this,"onRemove",(e=>(e.stopPropagation(),e.preventDefault(),this.props.onRemoved(this.props.language))))}render(){var e;return i.createElement("div",{className:"mx_ExistingSpellCheckLanguage"},i.createElement("span",{className:"mx_ExistingSpellCheckLanguage_language"},null!==(e=this.props.label)&&void 0!==e?e:this.props.language),i.createElement(ie.A,{onClick:this.onRemove,kind:"danger_sm"},(0,l._t)("action|remove")))}}class aS extends i.Component{constructor(e){super(e),(0,v.A)(this,"onRemoved",(e=>{const t=this.props.languages.filter((t=>t!==e));this.props.onLanguagesChange(t)})),(0,v.A)(this,"onAddClick",(e=>{e.stopPropagation(),e.preventDefault();const t=this.state.newLanguage;this.setState({newLanguage:""}),t&&(this.props.languages.includes(t)||(this.props.languages.push(t),this.props.onLanguagesChange(this.props.languages)))})),(0,v.A)(this,"onNewLanguageChange",(e=>{this.state.newLanguage!==e&&this.setState({newLanguage:e})})),this.state={newLanguage:""}}render(){const e=new Intl.DisplayNames([(0,l.mf)()],{type:"language",style:"short"}),t=this.props.languages.map((t=>i.createElement(rS,{language:t,label:e.of(t),onRemoved:this.onRemoved,key:t}))),n=i.createElement(ie.A,{onClick:this.onAddClick,kind:"primary"},(0,l._t)("action|add"));return i.createElement(i.Fragment,null,t,i.createElement("form",{onSubmit:this.onAddClick,noValidate:!0},i.createElement(oS,{className:"mx_GeneralUserSettingsTab_spellCheckLanguageInput",value:this.state.newLanguage,onOptionChange:this.onNewLanguageChange}),n))}}const lS=()=>{const[e,t]=(0,i.useState)((0,l.UK)()),n=(0,i.useCallback)((n=>{if(e===n)return;M.A.setValue("language",null,O.p.DEVICE,n),t(n);const i=a.A.get();i&&(i.setLanguage([n]),i.reload())}),[e]);return i.createElement("div",{className:"mx_SettingsSubsection_dropdown"},(0,l._t)("settings|general|application_language"),i.createElement(sS,{onOptionChange:n,value:e}),i.createElement("div",{className:"mx_PreferencesUserSettingsTab_section_hint"},(0,l._t)("settings|general|application_language_reload_hint")))},cS=()=>{var e;const[t,n]=(0,i.useState)(),[s,o]=(0,i.useState)();(0,i.useEffect)((()=>{(async()=>{const e=a.A.get(),[t,i]=await Promise.all([null==e?void 0:e.getSpellCheckEnabled(),null==e?void 0:e.getSpellCheckLanguages()]);n(t),o(i||void 0)})()}),[]);const r=(0,i.useCallback)((e=>{var t;n(e),null===(t=a.A.get())||void 0===t||t.setSpellCheckEnabled(e)}),[]),c=(0,i.useCallback)((e=>{var t;o(e),null===(t=a.A.get())||void 0===t||t.setSpellCheckLanguages(e)}),[]);return null!==(e=a.A.get())&&void 0!==e&&e.supportsSpellCheckSettings()?i.createElement(i.Fragment,null,i.createElement(Qs.A,{label:(0,l._t)("settings|general|allow_spellcheck"),value:Boolean(t),onChange:r}),t&&void 0!==s&&!Tn.vL&&i.createElement(aS,{languages:s,onLanguagesChange:c})):null};class dS extends i.Component{constructor(e){super(e),(0,v.A)(this,"onTimezoneChange",(e=>{this.setState({timezone:e}),Gd.nY(e)})),(0,v.A)(this,"onTimezoneSearchChange",(e=>{const t=e.toLowerCase(),n=t?Gd.QG().filter((e=>e.toLowerCase().includes(t))):Gd.QG();this.setState({timezones:n,timezoneSearch:t})})),(0,v.A)(this,"onAutocompleteDelayChange",(e=>{this.setState({autocompleteDelay:e.target.value}),M.A.setValue("autocompleteDelay",null,O.p.DEVICE,e.target.value)})),(0,v.A)(this,"onReadMarkerInViewThresholdMs",(e=>{this.setState({readMarkerInViewThresholdMs:e.target.value}),M.A.setValue("readMarkerInViewThresholdMs",null,O.p.DEVICE,e.target.value)})),(0,v.A)(this,"onReadMarkerOutOfViewThresholdMs",(e=>{this.setState({readMarkerOutOfViewThresholdMs:e.target.value}),M.A.setValue("readMarkerOutOfViewThresholdMs",null,O.p.DEVICE,e.target.value)})),(0,v.A)(this,"onKeyboardShortcutsClicked",(()=>{S.A.dispatch({action:W.r.ViewUserSettings,initialTabId:Na.v.Keyboard})})),this.state={timezone:Gd.dB(),timezones:Gd.QG(),timezoneSearch:void 0,autocompleteDelay:M.A.getValueAt(O.p.DEVICE,"autocompleteDelay").toString(10),readMarkerInViewThresholdMs:M.A.getValueAt(O.p.DEVICE,"readMarkerInViewThresholdMs").toString(10),readMarkerOutOfViewThresholdMs:M.A.getValueAt(O.p.DEVICE,"readMarkerOutOfViewThresholdMs").toString(10)}}renderGroup(e,t=O.p.ACCOUNT){return e.map((e=>i.createElement(Ab.A,{key:e,name:e,level:t})))}render(){const e=M.A.getValue("FTUE.useCaseSelection"),t=dS.ROOM_LIST_SETTINGS.filter((t=>"FTUE.userOnboardingButton"!==t||Od(e))),n=(0,l._t)("settings|preferences|default_timezone",{timezone:Gd.cf()}),s=this.state.timezones.map((e=>i.createElement("div",{key:e},e)));return s.unshift(i.createElement("div",{key:""},n)),i.createElement(Us.A,null,i.createElement(Fs.X,null,i.createElement(Vs.P,{heading:(0,l._t)("settings|general|language_section")},i.createElement(lS,null),i.createElement(cS,null)),t.length>0&&i.createElement(Vs.P,{heading:(0,l._t)("settings|preferences|room_list_heading")},this.renderGroup(t)),i.createElement(Vs.P,{heading:(0,l._t)("common|spaces")},this.renderGroup(dS.SPACES_SETTINGS,O.p.ACCOUNT)),i.createElement(Vs.P,{heading:(0,l._t)("settings|preferences|keyboard_heading"),description:(0,l._t)("settings|preferences|keyboard_view_shortcuts_button",{},{a:e=>i.createElement(ie.A,{kind:"link_inline",onClick:this.onKeyboardShortcutsClicked},e)})},this.renderGroup(dS.KEYBINDINGS_SETTINGS)),i.createElement(Vs.P,{heading:(0,l._t)("settings|preferences|time_heading")},i.createElement("div",{className:"mx_SettingsSubsection_dropdown"},(0,l._t)("settings|preferences|user_timezone"),i.createElement(Ma.A,{id:"mx_dropdownUserTimezone",className:"mx_dropdownUserTimezone",searchEnabled:!0,value:this.state.timezone,label:(0,l._t)("settings|preferences|user_timezone"),placeholder:n,onOptionChange:this.onTimezoneChange,onSearchChange:this.onTimezoneSearchChange},s)),this.renderGroup(dS.TIME_SETTINGS),i.createElement(Ab.A,{name:"userTimezonePublish",level:O.p.DEVICE})),i.createElement(Vs.P,{heading:(0,l._t)("common|presence"),description:(0,l._t)("settings|preferences|presence_description")},this.renderGroup(dS.PRESENCE_SETTINGS)),i.createElement(Vs.P,{heading:(0,l._t)("settings|preferences|composer_heading")},this.renderGroup(dS.COMPOSER_SETTINGS)),i.createElement(Vs.P,{heading:(0,l._t)("settings|preferences|code_blocks_heading")},this.renderGroup(dS.CODE_BLOCKS_SETTINGS)),i.createElement(Vs.P,{heading:(0,l._t)("settings|preferences|media_heading")},this.renderGroup(dS.IMAGES_AND_VIDEOS_SETTINGS)),i.createElement(Vs.P,{heading:(0,l._t)("common|timeline")},this.renderGroup(dS.TIMELINE_SETTINGS)),i.createElement(Vs.P,{heading:(0,l._t)("settings|preferences|room_directory_heading")},this.renderGroup(dS.ROOM_DIRECTORY_SETTINGS)),i.createElement(Vs.P,{heading:(0,l._t)("common|general"),stretchContent:!0},this.renderGroup(dS.GENERAL_SETTINGS),i.createElement(Ab.A,{name:"Electron.showTrayIcon",level:O.p.PLATFORM,hideIfCannotSet:!0}),i.createElement(Ab.A,{name:"Electron.enableHardwareAcceleration",level:O.p.PLATFORM,hideIfCannotSet:!0,label:(0,l._t)("settings|preferences|Electron.enableHardwareAcceleration",{appName:c.Ay.get().brand})}),i.createElement(Ab.A,{name:"Electron.alwaysShowMenuBar",level:O.p.PLATFORM,hideIfCannotSet:!0}),i.createElement(Ab.A,{name:"Electron.autoLaunch",level:O.p.PLATFORM,hideIfCannotSet:!0}),i.createElement(Ab.A,{name:"Electron.warnBeforeExit",level:O.p.PLATFORM,hideIfCannotSet:!0}),i.createElement(ks.A,{label:(0,l._t)("settings|preferences|autocomplete_delay"),type:"number",value:this.state.autocompleteDelay,onChange:this.onAutocompleteDelayChange}),i.createElement(ks.A,{label:(0,l._t)("settings|preferences|rm_lifetime"),type:"number",value:this.state.readMarkerInViewThresholdMs,onChange:this.onReadMarkerInViewThresholdMs}),i.createElement(ks.A,{label:(0,l._t)("settings|preferences|rm_lifetime_offscreen"),type:"number",value:this.state.readMarkerOutOfViewThresholdMs,onChange:this.onReadMarkerOutOfViewThresholdMs}))))}}(0,v.A)(dS,"ROOM_LIST_SETTINGS",["breadcrumbs","FTUE.userOnboardingButton"]),(0,v.A)(dS,"SPACES_SETTINGS",["Spaces.allRoomsInHome"]),(0,v.A)(dS,"KEYBINDINGS_SETTINGS",["ctrlFForSearch"]),(0,v.A)(dS,"PRESENCE_SETTINGS",["sendReadReceipts","sendTypingNotifications"]),(0,v.A)(dS,"COMPOSER_SETTINGS",["MessageComposerInput.autoReplaceEmoji","MessageComposerInput.useMarkdown","MessageComposerInput.suggestEmoji","MessageComposerInput.ctrlEnterToSend","MessageComposerInput.surroundWith","MessageComposerInput.showStickersButton","MessageComposerInput.insertTrailingColon"]),(0,v.A)(dS,"TIME_SETTINGS",["showTwelveHourTimestamps","alwaysShowTimestamps"]),(0,v.A)(dS,"CODE_BLOCKS_SETTINGS",["enableSyntaxHighlightLanguageDetection","expandCodeByDefault","showCodeLineNumbers"]),(0,v.A)(dS,"IMAGES_AND_VIDEOS_SETTINGS",["urlPreviewsEnabled","autoplayGifs","autoplayVideo","showImages"]),(0,v.A)(dS,"TIMELINE_SETTINGS",["showTypingNotifications","showRedactions","showReadReceipts","showJoinLeaves","showDisplaynameChanges","showChatEffects","showAvatarChanges","Pill.shouldShowPillAvatar","TextualBody.enableBigEmoji","scrollToBottomOnMessageSent","useOnlyCurrentProfiles"]),(0,v.A)(dS,"ROOM_DIRECTORY_SETTINGS",["SpotlightSearch.showNsfwPublicRooms"]),(0,v.A)(dS,"GENERAL_SETTINGS",["promptBeforeInviteUnknownUsers"]);var mS=n("./src/utils/media/requestMediaPermissions.tsx");const uS=e=>{switch(e){case Lr.cm.AudioOutput:return Lr.Ay.getAudioOutput();case Lr.cm.AudioInput:return Lr.Ay.getAudioInput();case Lr.cm.VideoInput:return Lr.Ay.getVideoInput()}};class hS extends i.Component{constructor(e,t){super(e,t),(0,v.A)(this,"refreshMediaDevices",(async e=>{var t;this.setState({mediaDevices:null!==(t=await Lr.Ay.getDevices())&&void 0!==t?t:null,[Lr.cm.AudioOutput]:uS(Lr.cm.AudioOutput),[Lr.cm.AudioInput]:uS(Lr.cm.AudioInput),[Lr.cm.VideoInput]:uS(Lr.cm.VideoInput)}),e&&e.getTracks().forEach((e=>e.stop()))})),(0,v.A)(this,"requestMediaPermissions",(async()=>{const e=await(0,mS.y)();e&&await this.refreshMediaDevices(e)})),(0,v.A)(this,"setDevice",(async(e,t)=>{this.setState({[t]:e});try{await Lr.Ay.instance.setDevice(e,t)}catch{s.v.error(`Failed to set device ${t}: ${e}`),this.setState({[t]:uS(t)})}})),(0,v.A)(this,"changeWebRtcMethod",(e=>{this.context.setForceTURN(!e)})),this.state={mediaDevices:null,[Lr.cm.AudioOutput]:null,[Lr.cm.AudioInput]:null,[Lr.cm.VideoInput]:null,audioAutoGainControl:Lr.Ay.getAudioAutoGainControl(),audioEchoCancellation:Lr.Ay.getAudioEchoCancellation(),audioNoiseSuppression:Lr.Ay.getAudioNoiseSuppression()}}async componentDidMount(){await Lr.Ay.hasAnyLabeledDevices()&&await this.refreshMediaDevices()}renderDeviceOptions(e,t){return e.map((e=>i.createElement("option",{key:`${t}-${e.deviceId}`,value:e.deviceId},e.label)))}renderDropdown(e,t){var n;const s=null===(n=this.state.mediaDevices)||void 0===n?void 0:n[e].slice(0);if(null==s||!s.length)return null;const o=Lr.Ay.getDefaultDevice(s);return i.createElement(ks.A,{element:"select",label:t,value:this.state[e]||o,onChange:t=>this.setDevice(t.target.value,e)},this.renderDeviceOptions(s,e))}render(){let e,t,n,s;return this.state.mediaDevices?this.state.mediaDevices&&(t=this.renderDropdown(Lr.cm.AudioOutput,(0,l._t)("settings|voip|audio_output"))||i.createElement("p",null,(0,l._t)("settings|voip|audio_output_empty")),n=this.renderDropdown(Lr.cm.AudioInput,(0,l._t)("common|microphone"))||i.createElement("p",null,(0,l._t)("settings|voip|audio_input_empty")),s=this.renderDropdown(Lr.cm.VideoInput,(0,l._t)("common|camera"))||i.createElement("p",null,(0,l._t)("settings|voip|video_input_empty"))):e=i.createElement("div",null,i.createElement("p",null,(0,l._t)("settings|voip|missing_permissions_prompt")),i.createElement(ie.A,{onClick:this.requestMediaPermissions,kind:"primary"},(0,l._t)("settings|voip|request_permissions"))),i.createElement(Us.A,null,i.createElement(Fs.X,null,e,i.createElement(Vs.P,{heading:(0,l._t)("settings|voip|voice_section"),stretchContent:!0},t,n,i.createElement(Qs.A,{value:this.state.audioAutoGainControl,onChange:async e=>{await Lr.Ay.setAudioAutoGainControl(e),this.setState({audioAutoGainControl:Lr.Ay.getAudioAutoGainControl()})},label:(0,l._t)("settings|voip|voice_agc")})),i.createElement(Vs.P,{heading:(0,l._t)("settings|voip|video_section"),stretchContent:!0},s,i.createElement(Ab.A,{name:"VideoView.flipVideoHorizontally",level:O.p.ACCOUNT}))),i.createElement(Fs.X,{heading:(0,l._t)("common|advanced")},i.createElement(Vs.P,{heading:(0,l._t)("settings|voip|voice_processing")},i.createElement(Qs.A,{value:this.state.audioNoiseSuppression,onChange:async e=>{await Lr.Ay.setAudioNoiseSuppression(e),this.setState({audioNoiseSuppression:Lr.Ay.getAudioNoiseSuppression()})},label:(0,l._t)("settings|voip|noise_suppression")}),i.createElement(Qs.A,{value:this.state.audioEchoCancellation,onChange:async e=>{await Lr.Ay.setAudioEchoCancellation(e),this.setState({audioEchoCancellation:Lr.Ay.getAudioEchoCancellation()})},label:(0,l._t)("settings|voip|echo_cancellation")})),i.createElement(Vs.P,{heading:(0,l._t)("settings|voip|connection_section")},i.createElement(Ab.A,{name:"webRtcAllowPeerToPeer",level:O.p.DEVICE,onChange:this.changeWebRtcMethod}),i.createElement(Ab.A,{name:"fallbackICEServerAllowed",label:(0,l._t)("settings|voip|enable_fallback_ice_server",{server:new URL(ft.ZB).pathname}),level:O.p.DEVICE,hideIfCannotSet:!0}))))}}(0,v.A)(hS,"contextType",Hn.Ay);const pS=["action"];function gS(){var e;null===(e=a.A.get())||void 0===e||e.installUpdate()}const vS=[$e.Kn.Ready,$e.Kn.Error,$e.Kn.NotAvailable],_S=()=>{const[e,t]=(0,i.useState)(null);(0,Ws.F)(S.A,(e=>{let{action:n}=e,i=(0,g.A)(e,pS);n===W.r.CheckUpdates&&t(i)}));const n=!!e&&!vS.includes(e.status);let s;return e&&(s=i.createElement("span",{className:"mx_UpdateCheckButton_summary"},function(e,t){switch(e){case $e.Kn.Error:return(0,l._t)("update|error_encountered",{errorDetail:t});case $e.Kn.Checking:return(0,l._t)("update|checking");case $e.Kn.NotAvailable:return(0,l._t)("update|no_update");case $e.Kn.Downloading:return(0,l._t)("update|downloading");case $e.Kn.Ready:return(0,l._t)("update|new_version_available",{},{a:e=>i.createElement(ie.A,{kind:"link_inline",onClick:gS},e)})}}(e.status,e.detail),n&&i.createElement(oa.A,null))),i.createElement(i.Fragment,null,i.createElement(ie.A,{onClick:()=>{var e;t(null),null===(e=a.A.get())||void 0===e||e.startUpdateCheck()},kind:"primary_outline",disabled:n},(0,l._t)("update|check_action")),s)};class fS extends i.Component{constructor(e,t){super(e,t),(0,v.A)(this,"onClearCacheAndReload",(()=>{a.A.get()&&(s.v.log("Clear cache & reload clicked"),this.context.stopClient(),this.context.store.deleteAllData().then((()=>{var e;null===(e=a.A.get())||void 0===e||e.reload()})))})),(0,v.A)(this,"onBugReport",(()=>{k.Ay.createDialog(st.A,{})})),(0,v.A)(this,"getVersionTextToCopy",(()=>{const{appVersion:e,cryptoVersion:t}=this.getVersionInfo();return`${e}\n${t}`})),this.state={appVersion:null,canUpdate:!1}}componentDidMount(){var e,t;null===(e=a.A.get())||void 0===e||e.getAppVersion().then((e=>this.setState({appVersion:e}))).catch((e=>{s.v.error("Error getting vector version: ",e)})),null===(t=a.A.get())||void 0===t||t.canSelfUpdate().then((e=>this.setState({canUpdate:e}))).catch((e=>{s.v.error("Error getting self updatability: ",e)}))}getVersionInfo(){var e,t;const n=c.Ay.get().brand,i=this.state.appVersion||"unknown",s=null!==(e=null===(t=this.context.getCrypto())||void 0===t?void 0:t.getVersion())&&void 0!==e?e:"<not-enabled>";return{appVersion:`${(0,l._t)("setting|help_about|brand_version",{brand:n})} ${i}`,cryptoVersion:`${(0,l._t)("setting|help_about|crypto_version")} ${s}`}}renderLegal(){const e=c.Ay.get().terms_and_conditions_links;if(!e)return null;const t=[];for(const n of e)t.push(i.createElement("div",{key:n.url},i.createElement(Ja.A,{href:n.url},n.text)));return i.createElement(Vs.P,{heading:(0,l._t)("common|legal")},i.createElement(Vs.s,null,t))}renderCredits(){return i.createElement(Vs.P,{heading:(0,l._t)("common|credits")},i.createElement(Vs.s,null,i.createElement("ul",null,i.createElement("li",null,(0,l._t)("credits|default_cover_photo",{},{photo:e=>i.createElement(Ja.A,{href:"themes/element/img/backgrounds/lake.jpg",rel:"noreferrer noopener",target:"_blank"},e),author:e=>i.createElement(Ja.A,{href:"https://www.flickr.com/golan"},e),terms:e=>i.createElement(Ja.A,{href:"https://creativecommons.org/licenses/by-sa/4.0/",rel:"noreferrer noopener",target:"_blank"},e)})),i.createElement("li",null,(0,l._t)("credits|twemoji_colr",{},{colr:e=>i.createElement(Ja.A,{href:"https://github.com/matrix-org/twemoji-colr",rel:"noreferrer noopener",target:"_blank"},e),author:e=>i.createElement(Ja.A,{href:"https://mozilla.org"},e),terms:e=>i.createElement(Ja.A,{href:"https://www.apache.org/licenses/LICENSE-2.0",rel:"noreferrer noopener",target:"_blank"},e)})),i.createElement("li",null,(0,l._t)("credits|twemoji",{},{twemoji:e=>i.createElement(Ja.A,{href:"https://twemoji.twitter.com/"},e),author:e=>i.createElement(Ja.A,{href:"https://twemoji.twitter.com/"},e),terms:e=>i.createElement(Ja.A,{href:"https://creativecommons.org/licenses/by/4.0/",rel:"noreferrer noopener",target:"_blank"},e)})))))}render(){const e=c.Ay.get().brand,t=(0,l._t)("setting|help_about|help_link",{brand:e},{a:e=>i.createElement(Ja.A,{href:c.Ay.get("help_url")},e)});let n,s;this.state.canUpdate&&(n=i.createElement(_S,null)),c.Ay.get().bug_report_endpoint_url&&(s=i.createElement(Vs.P,{heading:(0,l._t)("bug_reporting|title"),description:i.createElement(i.Fragment,null,i.createElement(Vs.s,null,(0,l._t)("bug_reporting|introduction")),(0,l._t)("bug_reporting|description"))},i.createElement(ie.A,{onClick:this.onBugReport,kind:"primary_outline"},(0,l._t)("bug_reporting|submit_debug_logs")),i.createElement(Vs.s,null,(0,l._t)("bug_reporting|matrix_security_issue",{},{a:e=>i.createElement(Ja.A,{href:"https://matrix.org/security-disclosure-policy/"},e)}))));const{appVersion:o,cryptoVersion:r}=this.getVersionInfo();return i.createElement(Us.A,null,i.createElement(Fs.X,null,s,i.createElement(Vs.P,{heading:(0,l._t)("common|faq"),description:t}),i.createElement(Vs.P,{heading:(0,l._t)("setting|help_about|versions")},i.createElement(Vs.s,null,i.createElement(Py.A,{getTextToCopy:this.getVersionTextToCopy},o,i.createElement("br",null),r,i.createElement("br",null)),n)),this.renderLegal(),this.renderCredits(),i.createElement(Vs.P,{heading:(0,l._t)("common|advanced")},i.createElement(Vs.s,null,(0,l._t)("setting|help_about|homeserver",{homeserverUrl:this.context.getHomeserverUrl()},{code:e=>i.createElement("code",null,e)})),this.context.getIdentityServerUrl()&&i.createElement(Vs.s,null,(0,l._t)("setting|help_about|identity_server",{identityServerUrl:this.context.getIdentityServerUrl()},{code:e=>i.createElement("code",null,e)})),i.createElement(Vs.s,null,i.createElement("details",null,i.createElement("summary",{className:"mx_HelpUserSettingsTab_accessTokenDetails"},(0,l._t)("common|access_token")),i.createElement("strong",null,(0,l._t)("setting|help_about|access_token_detail")),i.createElement(Py.A,{getTextToCopy:()=>this.context.getAccessToken()},this.context.getAccessToken()))),i.createElement(ie.A,{onClick:this.onClearCacheAndReload,kind:"danger_outline"},(0,l._t)("setting|help_about|clear_cache_reload")))))}}(0,v.A)(fS,"contextType",Hn.Ay);var ES=n("./src/mjolnir/BanList.ts");class yS extends i.Component{constructor(e){super(e),(0,v.A)(this,"onPersonalRuleChanged",(e=>{this.setState({newPersonalRule:e.target.value})})),(0,v.A)(this,"onNewListChanged",(e=>{this.setState({newList:e.target.value})})),(0,v.A)(this,"onAddPersonalRule",(async e=>{e.preventDefault(),e.stopPropagation();let t=ES.fy;this.state.newPersonalRule.startsWith("@")&&(t=ES.ZZ),this.setState({busy:!0});try{const e=await F.u.sharedInstance().getOrCreatePersonalList();await e.banEntity(t,this.state.newPersonalRule,(0,l._t)("labs_mjolnir|ban_reason")),this.setState({newPersonalRule:""})}catch(e){s.v.error(e),k.Ay.createDialog(nt.A,{title:(0,l._t)("labs_mjolnir|error_adding_ignore"),description:(0,l._t)("labs_mjolnir|something_went_wrong")})}finally{this.setState({busy:!1})}})),(0,v.A)(this,"onSubscribeList",(async e=>{e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});try{const e=await _.J.safeGet().joinRoom(this.state.newList);await F.u.sharedInstance().subscribeToList(e.roomId),this.setState({newList:""})}catch(e){s.v.error(e),k.Ay.createDialog(nt.A,{title:(0,l._t)("labs_mjolnir|error_adding_list_title"),description:(0,l._t)("labs_mjolnir|error_adding_list_description")})}finally{this.setState({busy:!1})}})),this.state={busy:!1,newPersonalRule:"",newList:""}}async removePersonalRule(e){this.setState({busy:!0});try{const t=F.u.sharedInstance().getPersonalList();await t.unbanEntity(e.kind,e.entity)}catch(e){s.v.error(e),k.Ay.createDialog(nt.A,{title:(0,l._t)("labs_mjolnir|error_removing_ignore"),description:(0,l._t)("labs_mjolnir|something_went_wrong")})}finally{this.setState({busy:!1})}}async unsubscribeFromList(e){this.setState({busy:!0});try{await F.u.sharedInstance().unsubscribeFromList(e.roomId),await _.J.safeGet().leave(e.roomId)}catch(e){s.v.error(e),k.Ay.createDialog(nt.A,{title:(0,l._t)("labs_mjolnir|error_removing_list_title"),description:(0,l._t)("labs_mjolnir|error_removing_list_description")})}finally{this.setState({busy:!1})}}viewListRules(e){const t=_.J.safeGet().getRoom(e.roomId),n=t?t.name:e.roomId,s=e=>{if(0===e.length)return i.createElement("i",null,(0,l._t)("labs_mjolnir|rules_empty"));const t=[];for(const n of e)t.push(i.createElement("li",{key:n.kind+n.entity},i.createElement("code",null,n.entity)));return i.createElement("ul",null,t)};k.Ay.createDialog(it.A,{title:(0,l._t)("labs_mjolnir|rules_title",{roomName:n}),description:i.createElement("div",null,i.createElement("h3",null,(0,l._t)("labs_mjolnir|rules_server")),s(e.serverRules),i.createElement("h3",null,(0,l._t)("labs_mjolnir|rules_user")),s(e.userRules)),button:(0,l._t)("action|close"),hasCancelButton:!1})}renderPersonalBanListRules(){const e=F.u.sharedInstance().getPersonalList(),t=e?[...e.userRules,...e.serverRules]:[];if(!e||t.length<=0)return i.createElement("i",null,(0,l._t)("labs_mjolnir|personal_empty"));const n=[];for(const e of t)n.push(i.createElement("li",{key:e.entity,className:"mx_MjolnirUserSettingsTab_listItem"},i.createElement(ie.A,{kind:"danger_sm",onClick:()=>this.removePersonalRule(e),disabled:this.state.busy},(0,l._t)("action|remove"))," ",i.createElement("code",null,e.entity)));return i.createElement("div",null,i.createElement("p",null,(0,l._t)("labs_mjolnir|personal_section")),i.createElement("ul",null,n))}renderSubscribedBanLists(){const e=F.u.sharedInstance().getPersonalList(),t=F.u.sharedInstance().lists.filter((t=>!e||e.roomId!==t.roomId));if(!t||t.length<=0)return i.createElement("i",null,(0,l._t)("labs_mjolnir|no_lists"));const n=[];for(const e of t){const t=_.J.safeGet().getRoom(e.roomId),s=t?i.createElement("span",null,t.name," (",i.createElement("code",null,e.roomId),")"):i.createElement("code",null,"list.roomId");n.push(i.createElement("li",{key:e.roomId,className:"mx_MjolnirUserSettingsTab_listItem"},i.createElement(ie.A,{kind:"danger_sm",onClick:()=>this.unsubscribeFromList(e),disabled:this.state.busy},(0,l._t)("action|unsubscribe"))," ",i.createElement(ie.A,{kind:"primary_sm",onClick:()=>this.viewListRules(e),disabled:this.state.busy},(0,l._t)("labs_mjolnir|view_rules"))," ",s))}return i.createElement("div",null,i.createElement("p",null,(0,l._t)("labs_mjolnir|lists")),i.createElement("ul",null,n))}render(){const e=c.Ay.get().brand;return i.createElement(Us.A,null,i.createElement(Fs.X,null,i.createElement(Vs.s,null,i.createElement("strong",{className:"warning"},(0,l._t)("labs_mjolnir|advanced_warning")),i.createElement("p",null,(0,l._t)("labs_mjolnir|explainer_1",{brand:e},{code:e=>i.createElement("code",null,e)})),i.createElement("p",null,(0,l._t)("labs_mjolnir|explainer_2"))),i.createElement(Vs.P,{heading:(0,l._t)("labs_mjolnir|personal_heading"),description:(0,l._t)("labs_mjolnir|personal_description",{myBanList:(0,l._t)("labs_mjolnir|room_name")})},this.renderPersonalBanListRules(),i.createElement("form",{onSubmit:this.onAddPersonalRule,autoComplete:"off"},i.createElement(ks.A,{type:"text",label:(0,l._t)("labs_mjolnir|personal_new_label"),placeholder:(0,l._t)("labs_mjolnir|personal_new_placeholder"),value:this.state.newPersonalRule,onChange:this.onPersonalRuleChanged}),i.createElement(ie.A,{type:"submit",kind:"primary",onClick:this.onAddPersonalRule,disabled:this.state.busy},(0,l._t)("action|ignore")))),i.createElement(Vs.P,{heading:(0,l._t)("labs_mjolnir|lists_heading"),description:i.createElement(i.Fragment,null,i.createElement("strong",{className:"warning"},(0,l._t)("labs_mjolnir|lists_description_1"))," ",i.createElement("span",null,(0,l._t)("labs_mjolnir|lists_description_2")))},this.renderSubscribedBanLists(),i.createElement("form",{onSubmit:this.onSubscribeList,autoComplete:"off"},i.createElement(ks.A,{type:"text",label:(0,l._t)("labs_mjolnir|lists_new_label"),value:this.state.newList,onChange:this.onNewListChanged}),i.createElement(ie.A,{type:"submit",kind:"primary",onClick:this.onSubscribeList,disabled:this.state.busy},(0,l._t)("action|subscribe"))))))}}var bS=n("./src/accessibility/KeyboardShortcutUtils.ts");const wS=Object.entries(Pn.R6).filter((([e])=>e!==Pn.md.LABS||xb())),SS=({name:e})=>{const t=(0,bS.Lt)(e),n=(0,bS.Tz)(e);return t&&n?i.createElement("li",{className:"mx_KeyboardShortcut_shortcutRow"},t,i.createElement(Nl.S,{value:n})):null},AS=({categoryName:e,category:t})=>t.categoryLabel?i.createElement(Vs.P,{heading:(0,l._t)(t.categoryLabel),key:e},i.createElement("ul",{className:"mx_KeyboardShortcut_shortcutList"},t.settingNames.map((e=>i.createElement(SS,{key:e,name:e}))))):null,CS=()=>i.createElement(Us.A,null,i.createElement(Fs.X,null,wS.map((([e,t])=>i.createElement(AS,{key:e,categoryName:e,category:t}))))),xS=["value","options","selectedLabel","className"],kS=(e,t)=>n=>{const i=e.find((({id:e})=>e===n));return i?t?`${t}: ${i.label}`:i.label:null},RS=e=>{let{value:t,options:n,selectedLabel:s,className:o}=e,r=(0,g.A)(e,xS);return i.createElement(Ma.A,(0,_t.A)({},r,{value:t,className:dt()("mx_FilterDropdown",o),getShortOption:kS(n,s)}),n.map((({id:e,label:n,description:s})=>i.createElement("div",{className:"mx_FilterDropdown_option",key:e},e===t&&i.createElement(T_.A,{className:"mx_FilterDropdown_optionSelectedIcon"}),i.createElement("span",{className:"mx_FilterDropdown_optionLabel"},n),!!s&&i.createElement("span",{className:"mx_FilterDropdown_optionDescription"},s)))))},IS=["title","description"],TS=e=>{let{title:t,description:n}=e,s=(0,g.A)(e,IS);return i.createElement(ie.A,(0,_t.A)({},s,{kind:"link_inline",onClick:()=>{k.Ay.createDialog(Ka.A,{title:t,description:n,button:(0,l._t)("action|got_it"),hasCloseButton:!0})},className:"mx_LearnMore_button"}),(0,l._t)("action|learn_more"))},PS=({device:e,saveDeviceName:t,stopEditing:n})=>{const[s,o]=(0,i.useState)(e.display_name||""),[r,a]=(0,i.useState)(!1),[c,d]=(0,i.useState)(null);(0,i.useEffect)((()=>{o(e.display_name||"")}),[e.display_name]);const m=async e=>{a(!0),d(null),e.preventDefault();try{await t(s),n()}catch{d((0,l._t)("settings|sessions|error_set_name")),a(!1)}},u=`device-rename-${e.device_id}`,h=`device-rename-description-${e.device_id}`;return i.createElement("form",{"aria-disabled":r,className:"mx_DeviceDetailHeading_renameForm",onSubmit:m,method:"post"},i.createElement("p",{id:u,className:"mx_DeviceDetailHeading_renameFormHeading"},(0,l._t)("settings|sessions|rename_form_heading")),i.createElement("div",null,i.createElement(ks.A,{type:"text",value:s,autoComplete:"off",onChange:e=>o(e.target.value),autoFocus:!0,disabled:r,"aria-labelledby":u,"aria-describedby":h,className:"mx_DeviceDetailHeading_renameFormInput",maxLength:100}),i.createElement(yw.H,{id:h},(0,l._t)("settings|sessions|rename_form_caption"),i.createElement(TS,{title:(0,l._t)("settings|sessions|rename_form_learn_more"),description:i.createElement(i.Fragment,null,i.createElement("p",null,(0,l._t)("settings|sessions|rename_form_learn_more_description_1")),i.createElement("p",null,(0,l._t)("settings|sessions|rename_form_learn_more_description_2")))}),!!c&&i.createElement("span",{className:"mx_DeviceDetailHeading_renameFormError"},c))),i.createElement("div",{className:"mx_DeviceDetailHeading_renameFormButtons"},i.createElement(ie.A,{onClick:m,kind:"primary",disabled:r},(0,l._t)("action|save")),i.createElement(ie.A,{onClick:n,kind:"secondary",disabled:r},(0,l._t)("action|cancel")),r&&i.createElement(se.A,{w:16,h:16})))},NS=({device:e,saveDeviceName:t})=>{const[n,s]=(0,i.useState)(!1);return n?i.createElement(PS,{device:e,saveDeviceName:t,stopEditing:()=>s(!1)}):i.createElement("div",{className:"mx_DeviceDetailHeading"},i.createElement(Ql.A,{size:"4"},e.display_name||e.device_id),i.createElement(ie.A,{kind:"link_inline",onClick:()=>s(!0),className:"mx_DeviceDetailHeading_renameCta"},(0,l._t)("action|rename")))};var DS;function MS(){return MS=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},MS.apply(null,arguments)}var OS=function(e,t){return i.createElement("svg",MS({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0,ref:t},e),DS||(DS=i.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M2 3.05v6.22C2 15.63 9 17 9 17s7-1.37 7-7.73V3.05L9 1zm9.94 2.47c.19-.18.49-.17.67.02.16.18.16.45.02.63l-4.22 5.11-.03.04c-.28.34-.79.39-1.13.11a.3.3 0 0 1-.077-.067l-.023-.023-1.81-2.08c-.2-.24-.18-.6.06-.8.2-.18.49-.18.7-.04l1.57 1.1z",clipRule:"evenodd"})))},LS=(0,i.forwardRef)(OS);var US=n("./res/img/e2e/warning.svg");const FS={[Se.Inactive]:we,[Se.Verified]:LS,[Se.Unverified]:US.I,[Se.Unverifiable]:US.I},VS=({variation:e})=>{const t=FS[e];return i.createElement("div",{className:dt()("mx_DeviceSecurityCard_icon",e)},i.createElement(t,{height:16,width:16}))},BS=({variation:e,heading:t,description:n,children:s})=>i.createElement("div",{className:"mx_DeviceSecurityCard"},i.createElement(VS,{variation:e}),i.createElement("div",{className:"mx_DeviceSecurityCard_content"},i.createElement("p",{className:"mx_DeviceSecurityCard_heading"},t),i.createElement("p",{className:"mx_DeviceSecurityCard_description"},n),!!s&&i.createElement("div",{className:"mx_DeviceSecurityCard_actions"},s))),jS={[Se.Verified]:{title:(0,l._t)("settings|sessions|verified_sessions"),description:i.createElement(i.Fragment,null,i.createElement("p",null,(0,l._t)("settings|sessions|verified_sessions_explainer_1")),i.createElement("p",null,(0,l._t)("settings|sessions|verified_sessions_explainer_2")))},[Se.Unverified]:{title:(0,l._t)("settings|sessions|unverified_sessions"),description:i.createElement(i.Fragment,null,i.createElement("p",null,(0,l._t)("settings|sessions|unverified_sessions_explainer_1")),i.createElement("p",null,(0,l._t)("settings|sessions|unverified_sessions_explainer_2")))},[Se.Unverifiable]:{title:(0,l._t)("settings|sessions|unverified_session"),description:i.createElement(i.Fragment,null,i.createElement("p",null,(0,l._t)("settings|sessions|unverified_session_explainer_1")),i.createElement("p",null,(0,l._t)("settings|sessions|unverified_session_explainer_2")),i.createElement("p",null,(0,l._t)("settings|sessions|unverified_session_explainer_3")))},[Se.Inactive]:{title:(0,l._t)("settings|sessions|inactive_sessions"),description:i.createElement(i.Fragment,null,i.createElement("p",null,(0,l._t)("settings|sessions|inactive_sessions_explainer_1")),i.createElement("p",null,(0,l._t)("settings|sessions|inactive_sessions_explainer_2")))}},WS=({variation:e})=>{const{title:t,description:n}=jS[e];return i.createElement(TS,{title:t,description:n})},zS=({device:e,isCurrentDevice:t,onVerifyDevice:n})=>{const s=((e,t)=>{if(e.isVerified){const e=t?(0,l._t)("settings|sessions|device_verified_description_current"):(0,l._t)("settings|sessions|device_verified_description");return{variation:Se.Verified,heading:(0,l._t)("settings|sessions|verified_session"),description:i.createElement(i.Fragment,null,e,i.createElement(WS,{variation:Se.Verified}))}}if(null===e.isVerified)return{variation:Se.Unverified,heading:(0,l._t)("settings|sessions|unverified_session"),description:i.createElement(i.Fragment,null,(0,l._t)("settings|sessions|unverified_session_explainer_1"),i.createElement(WS,{variation:Se.Unverifiable}))};const n=t?(0,l._t)("settings|sessions|device_unverified_description_current"):(0,l._t)("settings|sessions|device_unverified_description");return{variation:Se.Unverified,heading:(0,l._t)("settings|sessions|unverified_session"),description:i.createElement(i.Fragment,null,n,i.createElement(WS,{variation:Se.Unverified}))}})(e,t);return i.createElement(BS,s,!1===e.isVerified&&!!n&&i.createElement(ie.A,{kind:"primary",onClick:n},(0,l._t)("settings|sessions|verify_session")))};function HS(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function KS(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?HS(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):HS(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const JS=({device:e,pusher:t,localNotificationSettings:n,isSigningOut:s,onVerifyDevice:r,onSignOutDevice:a,saveDeviceName:c,setPushNotifications:d,supportsMSC3881:m,className:u,isCurrentDevice:h})=>{const p=[{id:"session",values:[{label:(0,l._t)("settings|sessions|session_id"),value:e.device_id},{label:(0,l._t)("settings|sessions|last_activity"),value:e.last_seen_ts&&(0,Re.Yq)(new Date(e.last_seen_ts))}]},{id:"application",heading:(0,l._t)("common|application"),values:[{label:(0,l._t)("common|name"),value:e.appName},{label:(0,l._t)("common|version"),value:e.appVersion},{label:(0,l._t)("settings|sessions|url"),value:e.url}]},{id:"device",heading:(0,l._t)("common|device"),values:[{label:(0,l._t)("common|model"),value:e.deviceModel},{label:(0,l._t)("settings|sessions|os"),value:e.deviceOperatingSystem},{label:(0,l._t)("settings|sessions|browser"),value:e.client},{label:(0,l._t)("settings|sessions|ip"),value:e.last_seen_ip}]}].map((e=>KS(KS({},e),{},{values:e.values.filter((e=>!!e.value))}))).filter((e=>e.values.length)),g=!!t||!!n;return i.createElement("div",{className:dt()("mx_DeviceDetails",u)},i.createElement("section",{className:"mx_DeviceDetails_section"},i.createElement(NS,{device:e,saveDeviceName:c}),i.createElement(zS,{device:e,onVerifyDevice:r,isCurrentDevice:h})),i.createElement("section",{className:"mx_DeviceDetails_section"},i.createElement("p",{className:"mx_DeviceDetails_sectionHeading"},(0,l._t)("settings|sessions|details_heading")),p.map((({heading:e,values:t,id:n},s)=>i.createElement("table",{className:"mx_DeviceDetails_metadataTable",key:s},e&&i.createElement("thead",null,i.createElement("tr",null,i.createElement("th",null,e))),i.createElement("tbody",null,t.map((({label:e,value:t})=>i.createElement("tr",{key:e},i.createElement("td",{className:"mxDeviceDetails_metadataLabel"},e),i.createElement("td",{className:"mxDeviceDetails_metadataValue"},t))))))))),g&&i.createElement("section",{className:"mx_DeviceDetails_section mx_DeviceDetails_pushNotifications"},i.createElement(uw.A,{checked:function(e){return e?!!e[o.PUSHER_ENABLED.name]:!n||!n.is_silenced}(t),disabled:function(e){return!n&&!(!e||m)}(t),onChange:t=>null==d?void 0:d(e.device_id,t),title:(0,l._t)("settings|sessions|push_toggle")}),i.createElement("p",{className:"mx_DeviceDetails_sectionHeading"},(0,l._t)("settings|sessions|push_heading"),i.createElement("small",{className:"mx_DeviceDetails_sectionSubheading"},(0,l._t)("settings|sessions|push_subheading")))),i.createElement("section",{className:"mx_DeviceDetails_section"},i.createElement(ie.A,{onClick:a,kind:"danger_inline",disabled:s},i.createElement("span",{className:"mx_DeviceDetails_signOutButtonContent"},(0,l._t)("settings|sessions|sign_out"),s&&i.createElement(se.A,{w:16,h:16})))))},GS=["isExpanded","onClick"],$S=e=>{let{isExpanded:t,onClick:n}=e,s=(0,g.A)(e,GS);const o=t?(0,l._t)("settings|sessions|hide_details"):(0,l._t)("settings|sessions|show_details");return i.createElement(ie.A,(0,_t.A)({},s,{"aria-label":o,title:o,kind:"icon",className:dt()("mx_DeviceExpandDetailsButton",{mx_DeviceExpandDetailsButton_expanded:t}),onClick:n}),i.createElement(_m.A,{className:"mx_DeviceExpandDetailsButton_icon"}))};var qS;function YS(){return YS=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},YS.apply(null,arguments)}var QS=function(e,t){return i.createElement("svg",YS({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 22 23",role:"presentation","aria-hidden":!0,ref:t},e),qS||(qS=i.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M11 22.5c6.075 0 11-4.925 11-11S17.075.5 11 .5 0 5.425 0 11.5s4.925 11 11 11m0-4.24a1.375 1.375 0 1 0 0-2.75 1.375 1.375 0 0 0 0 2.75M9.09 9.429A1.91 1.91 0 0 1 11 7.518c1.048 0 1.91.862 1.91 1.91 0 .485-.208.659-1.026 1.224-.363.25-.86.598-1.246 1.108-.415.546-.67 1.227-.67 2.093h2.063c0-.424.113-.666.25-.846.164-.217.402-.4.775-.659l.124-.084c.676-.46 1.792-1.219 1.792-2.836A3.98 3.98 0 0 0 11 5.456a3.97 3.97 0 0 0-3.973 3.972z",clipRule:"evenodd"})))},XS=(0,i.forwardRef)(QS);var ZS;function eA(){return eA=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},eA.apply(null,arguments)}var tA=function(e,t){return i.createElement("svg",eA({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 22 19",role:"presentation","aria-hidden":!0,ref:t},e),ZS||(ZS=i.createElement("path",{fill:"currentColor",d:"M3 15.5q-.824 0-1.412-.587A1.93 1.93 0 0 1 1 13.5v-11q0-.825.588-1.413A1.93 1.93 0 0 1 3 .5h16q.825 0 1.413.587Q21 1.675 21 2.5v11q0 .825-.587 1.413A1.93 1.93 0 0 1 19 15.5zm0-2h16v-11H3zm-2 5a.97.97 0 0 1-.712-.288A.97.97 0 0 1 0 17.5q0-.424.288-.712A.97.97 0 0 1 1 16.5h20q.424 0 .712.288A.97.97 0 0 1 22 17.5q0 .424-.288.712A.97.97 0 0 1 21 18.5zm2-5v-11z"})))},nA=(0,i.forwardRef)(tA);var iA;function sA(){return sA=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},sA.apply(null,arguments)}var oA=function(e,t){return i.createElement("svg",sA({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 20 17",role:"presentation","aria-hidden":!0,ref:t},e),iA||(iA=i.createElement("path",{fill:"currentColor",d:"M18 16.5H2q-.824 0-1.412-.587A1.93 1.93 0 0 1 0 14.5v-12q0-.825.588-1.412A1.92 1.92 0 0 1 2 .5h16q.825 0 1.413.588Q20 1.675 20 2.5v12q0 .825-.587 1.413A1.93 1.93 0 0 1 18 16.5M2 4.5v10h16v-10z"})))},rA=(0,i.forwardRef)(oA);var aA;function lA(){return lA=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},lA.apply(null,arguments)}var cA=function(e,t){return i.createElement("svg",lA({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 14 23",role:"presentation","aria-hidden":!0,ref:t},e),aA||(aA=i.createElement("path",{fill:"currentColor",d:"M12 .51 2 .5c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2v-18c0-1.1-.9-1.99-2-1.99m0 17.99H2v-14h10z"})))},dA=(0,i.forwardRef)(cA);const mA={[Ee.b.Desktop]:nA,[Ee.b.Mobile]:dA,[Ee.b.Web]:rA,[Ee.b.Unknown]:XS},uA={[Ee.b.Desktop]:(0,l.AO)("settings|sessions|desktop_session"),[Ee.b.Mobile]:(0,l.AO)("settings|sessions|mobile_session"),[Ee.b.Web]:(0,l.AO)("settings|sessions|web_session"),[Ee.b.Unknown]:(0,l.AO)("settings|sessions|unknown_session")},hA=({isVerified:e,isSelected:t,deviceType:n})=>{const s=mA[n]||mA[Ee.b.Unknown],o=(0,l._t)(uA[n]||uA[Ee.b.Unknown]);return i.createElement("div",{className:dt()("mx_DeviceTypeIcon",{mx_DeviceTypeIcon_selected:t})},i.createElement("div",{className:"mx_DeviceTypeIcon_deviceIconWrapper"},i.createElement(s,{className:"mx_DeviceTypeIcon_deviceIcon",role:"img","aria-label":o})),e?i.createElement(LS,{className:dt()("mx_DeviceTypeIcon_verificationIcon","verified"),role:"img","aria-label":(0,l._t)("common|verified")}):i.createElement(US.I,{className:dt()("mx_DeviceTypeIcon_verificationIcon","unverified"),role:"img","aria-label":(0,l._t)("common|unverified")}))};var pA=n("./src/utils/NativeEventUtils.ts");const gA=({device:e})=>i.createElement(Ql.A,{size:"4"},e.display_name||e.device_id),vA=({device:e,children:t,isSelected:n,onClick:s})=>i.createElement("div",{className:dt()("mx_DeviceTile",{mx_DeviceTile_interactive:!!s}),onClick:s},i.createElement(hA,{isVerified:e.isVerified,isSelected:n,deviceType:e.deviceType}),i.createElement("div",{className:"mx_DeviceTile_info"},i.createElement(gA,{device:e}),i.createElement("div",{className:"mx_DeviceTile_metadata"},i.createElement(Pe,{device:e}))),i.createElement("div",{className:"mx_DeviceTile_actions",onClick:(0,pA.Z)((()=>{}))},t)),_A=({children:e,device:t,isSelected:n,onSelect:s,onClick:o})=>i.createElement("div",{className:"mx_SelectableDeviceTile"},i.createElement(Ms.A,{kind:Ms.x.Solid,checked:n,onChange:s,className:"mx_SelectableDeviceTile_checkbox",id:`device-tile-checkbox-${t.device_id}`},i.createElement(vA,{device:t,onClick:o,isSelected:n},e))),fA=["selectedDeviceCount","isAllSelected","isSelectDisabled","toggleSelectAll","children"],EA=e=>{let{selectedDeviceCount:t,isAllSelected:n,isSelectDisabled:s,toggleSelectAll:o,children:r}=e,a=(0,g.A)(e,fA);const c=n?(0,l._t)("common|deselect_all"):(0,l._t)("common|select_all");return i.createElement("div",(0,_t.A)({className:"mx_FilteredDeviceListHeader"},a),!s&&i.createElement(Et.m,{label:c,placement:"top",isTriggerInteractive:!1},i.createElement(Ms.A,{kind:Ms.x.Solid,checked:n,onChange:o,id:"device-select-all-checkbox","aria-label":c})),i.createElement("span",{className:"mx_FilteredDeviceListHeader_label"},t>0?(0,l._t)("settings|sessions|n_sessions_selected",{count:t}):(0,l._t)("settings|sessions|title")),r)},yA=(e,t)=>t.includes(e),bA=(e,t)=>(t.last_seen_ts||0)-(e.last_seen_ts||0)||(e.display_name||e.device_id).localeCompare(t.display_name||t.device_id),wA="ALL",SA=({filter:e})=>{if((e=>!!e&&[Se.Inactive,Se.Unverified,Se.Verified].includes(e))(e)){const t={[Se.Verified]:{title:(0,l._t)("settings|sessions|verified_sessions"),description:(0,l._t)("settings|sessions|verified_sessions_list_description")},[Se.Unverified]:{title:(0,l._t)("settings|sessions|unverified_sessions"),description:(0,l._t)("settings|sessions|unverified_sessions_list_description")},[Se.Unverifiable]:{title:(0,l._t)("settings|sessions|unverified_session"),description:(0,l._t)("settings|sessions|unverified_session_explainer_1")},[Se.Inactive]:{title:(0,l._t)("settings|sessions|inactive_sessions"),description:(0,l._t)("settings|sessions|inactive_sessions_list_description",{inactiveAgeDays:90})}},{title:n,description:s}=t[e];return i.createElement("div",{className:"mx_FilteredDeviceList_securityCard"},i.createElement(BS,{variation:e,heading:n,description:i.createElement("span",null,s,i.createElement(WS,{variation:e}))}))}return null},AA=({filter:e,clearFilter:t})=>i.createElement("div",{className:"mx_FilteredDeviceList_noResults"},(e=>{switch(e){case Se.Verified:return(0,l._t)("settings|sessions|no_verified_sessions");case Se.Unverified:return(0,l._t)("settings|sessions|no_unverified_sessions");case Se.Inactive:return(0,l._t)("settings|sessions|no_inactive_sessions");default:return(0,l._t)("settings|sessions|no_sessions")}})(e),!!e&&i.createElement(i.Fragment,null," ",i.createElement(ie.A,{kind:"link_inline",onClick:t},(0,l._t)("action|show_all")))),CA=({device:e,pusher:t,localNotificationSettings:n,isExpanded:s,isSigningOut:o,isSelected:r,onDeviceExpandToggle:a,onSignOutDevice:l,saveDeviceName:c,onRequestDeviceVerification:d,setPushNotifications:m,toggleSelected:u,supportsMSC3881:h,isSelectDisabled:p})=>{const g=i.createElement(i.Fragment,null,o&&i.createElement(se.A,{w:16,h:16}),i.createElement($S,{isExpanded:s,onClick:a}));return i.createElement("li",{className:"mx_FilteredDeviceList_listItem"},p?i.createElement(vA,{device:e,onClick:a},g):i.createElement(_A,{isSelected:r,onSelect:u,onClick:a,device:e},g),s&&i.createElement(JS,{device:e,pusher:t,localNotificationSettings:n,isSigningOut:o,onVerifyDevice:d,onSignOutDevice:l,saveDeviceName:c,setPushNotifications:m,supportsMSC3881:h,className:"mx_FilteredDeviceList_deviceDetails"}))},xA=(0,i.forwardRef)((({devices:e,pushers:t,localNotificationSettings:n,filter:s,expandedDeviceIds:r,signingOutDeviceIds:a,selectedDeviceIds:c,onFilterChange:d,onDeviceExpandToggle:m,saveDeviceName:u,onSignOutDevices:h,onRequestDeviceVerification:p,setPushNotifications:g,setSelectedDeviceIds:v,supportsMSC3881:_,disableMultipleSignout:f},E)=>{const y=((e,t)=>ke(Object.values(e),t?[t]:[]).sort(bA))(e,s);function b(e){return t.find((t=>t[o.PUSHER_DEVICE_ID.name]===e.device_id))}const w=[{id:wA,label:(0,l._t)("settings|sessions|filter_all")},{id:Se.Verified,label:(0,l._t)("common|verified"),description:(0,l._t)("settings|sessions|filter_verified_description")},{id:Se.Unverified,label:(0,l._t)("common|unverified"),description:(0,l._t)("settings|sessions|filter_unverified_description")},{id:Se.Inactive,label:(0,l._t)("settings|sessions|filter_inactive"),description:(0,l._t)("settings|sessions|filter_inactive_description",{inactiveAgeDays:90})}],S=c.length>=y.length,A=!!a.length;return i.createElement("div",{className:"mx_FilteredDeviceList",ref:E},i.createElement(EA,{selectedDeviceCount:c.length,isAllSelected:S,toggleSelectAll:()=>{v(S?[]:y.map((e=>e.device_id)))},isSelectDisabled:f},c.length?i.createElement(i.Fragment,null,i.createElement(ie.A,{kind:"danger_inline",disabled:A,onClick:()=>h(c),className:"mx_FilteredDeviceList_headerButton"},A&&i.createElement(se.A,{w:16,h:16}),(0,l._t)("action|sign_out")),i.createElement(ie.A,{kind:"content_inline",disabled:A,onClick:()=>v([]),className:"mx_FilteredDeviceList_headerButton"},(0,l._t)("action|cancel"))):i.createElement(RS,{id:"device-list-filter",label:(0,l._t)("settings|sessions|filter_label"),value:s||wA,onOptionChange:e=>{d(e===wA?void 0:e)},options:w,selectedLabel:(0,l._t)("action|show")})),y.length?i.createElement(SA,{filter:s}):i.createElement(AA,{filter:s,clearFilter:()=>d(void 0)}),i.createElement("ol",{className:"mx_FilteredDeviceList_list"},y.map((e=>i.createElement(CA,{key:e.device_id,device:e,pusher:b(e),localNotificationSettings:n.get(e.device_id),isExpanded:r.includes(e.device_id),isSigningOut:a.includes(e.device_id),isSelected:yA(e.device_id,c),isSelectDisabled:f,onDeviceExpandToggle:()=>m(e.device_id),onSignOutDevice:()=>h([e.device_id]),saveDeviceName:t=>u(e.device_id,t),onRequestDeviceVerification:p?()=>p(e.device_id):void 0,setPushNotifications:g,toggleSelected:()=>{return t=e.device_id,void(yA(t,c)?v(c.filter((e=>e!==t))):v([...c,t]));var t},supportsMSC3881:_})))))})),kA=["options","title"],RA=e=>{let{options:t,title:n}=e,s=(0,g.A)(e,kA);const[o,r,a,l]=(0,Gt.EF)();return i.createElement(i.Fragment,null,i.createElement(Gt.VJ,(0,_t.A)({},s,{onClick:a,title:n,isExpanded:o,ref:r}),i.createElement(Xt.A,{className:"mx_KebabContextMenu_icon"})),o&&i.createElement(na.Ay,(0,_t.A)({onFinished:l,compact:!0,rightAligned:!0,closeOnInteraction:!0},{left:(c=r.current.getBoundingClientRect()).left+window.scrollX+c.width,top:c.bottom+window.scrollY,chevronFace:Gt.t4.None}),i.createElement(na.tx,null,t)));var c},IA=({onSignOutCurrentDevice:e,signOutAllOtherSessions:t,otherSessionsCount:n,disabled:s})=>{const o=[i.createElement(na.R$,{key:"sign-out",label:(0,l._t)("action|sign_out"),onClick:e,isDestructive:!0}),...t?[i.createElement(na.R$,{key:"sign-out-all-others",label:(0,l._t)("settings|sessions|sign_out_all_other_sessions",{otherSessionsCount:n}),onClick:t,isDestructive:!0})]:[]];return i.createElement(bw.r,{heading:(0,l._t)("settings|sessions|current_session")},i.createElement(RA,{disabled:s,title:(0,l._t)("common|options"),options:o}))},TA=({device:e,isLoading:t,isSigningOut:n,localNotificationSettings:s,otherSessionsCount:o,setPushNotifications:r,onVerifyCurrentDevice:a,onSignOutCurrentDevice:l,signOutAllOtherSessions:c,saveDeviceName:d})=>{const[m,u]=(0,i.useState)(!1);return i.createElement(Vs.P,{heading:i.createElement(IA,{onSignOutCurrentDevice:l,signOutAllOtherSessions:c,otherSessionsCount:o,disabled:t||!e||n})},t&&!e&&i.createElement(se.A,null),!!e&&i.createElement(i.Fragment,null,i.createElement(vA,{device:e,onClick:()=>u(!m)},i.createElement($S,{isExpanded:m,onClick:()=>u(!m)})),m?i.createElement(JS,{device:e,localNotificationSettings:s,setPushNotifications:r,isSigningOut:n,onVerifyDevice:a,onSignOutDevice:l,saveDeviceName:d,className:"mx_CurrentDeviceSection_deviceDetails"}):i.createElement(i.Fragment,null,i.createElement("br",null),i.createElement(zS,{device:e,onVerifyDevice:a,isCurrentDevice:!0}))))},PA=({devices:e,currentDeviceId:t,goToFilteredList:n})=>{const s=Object.values(e),o=ke(s,[Se.Unverified]).filter((e=>e.device_id!==t)).length,r=ke(s,[Se.Inactive]).length;if(!(o|r))return null;return i.createElement(Vs.P,{heading:(0,l._t)("settings|sessions|security_recommendations"),description:(0,l._t)("settings|sessions|security_recommendations_description")},!!o&&i.createElement(BS,{variation:Se.Unverified,heading:(0,l._t)("settings|sessions|unverified_sessions"),description:i.createElement(i.Fragment,null,(0,l._t)("settings|sessions|unverified_sessions_list_description"),i.createElement(WS,{variation:Se.Unverified}))},i.createElement(ie.A,{kind:"link_inline",onClick:()=>n(Se.Unverified)},(0,l._t)("action|view_all")+` (${o})`)),!!r&&i.createElement(i.Fragment,null,!!o&&i.createElement("div",{className:"mx_SecurityRecommendations_spacing"}),i.createElement(BS,{variation:Se.Inactive,heading:(0,l._t)("settings|sessions|inactive_sessions"),description:i.createElement(i.Fragment,null,(0,l._t)("settings|sessions|inactive_sessions_list_description",{inactiveAgeDays:90}),i.createElement(WS,{variation:Se.Inactive}))},i.createElement(ie.A,{kind:"link_inline",onClick:()=>n(Se.Inactive)},(0,l._t)("action|view_all")+` (${r})`))))},NA=(e,t)=>async n=>e.deleteMultipleDevices(t,null!=n?n:void 0);var DA=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/qr-code.js");const MA=({onShowQr:e,versions:t,wellKnown:n,oidcClientConfig:s,isCrossSigningReady:r})=>{const a=function(e,t,n,i,s){var r,a,l,c;const d=!(null==i||null===(r=i.unstable_features)||void 0===r||!r["org.matrix.msc4108"])||!(null==s||null===(a=s["io.element.rendezvous"])||void 0===a||!a.server);return!!(null==n||null===(l=n.metadata)||void 0===l?void 0:l.grant_types_supported.includes(o.DEVICE_CODE_SCOPE))&&d&&!(null===(c=e.getCrypto())||void 0===c||!c.exportSecretsBundle)&&t}((0,Hn.nH)(),!!r,s,t,n);return i.createElement(Vs.P,{heading:(0,l._t)("settings|sessions|sign_in_with_qr")},i.createElement("div",{className:"mx_LoginWithQRSection"},i.createElement("p",{className:"mx_SettingsTab_subsectionText"},(0,l._t)("settings|sessions|sign_in_with_qr_description")),i.createElement(ie.A,{onClick:e,kind:"primary",disabled:!a},i.createElement(DA.A,{height:20,width:20}),(0,l._t)("settings|sessions|sign_in_with_qr_button")),!a&&i.createElement(pl.E,{size:"sm"},(0,l._t)("settings|sessions|sign_in_with_qr_unsupported"))))};var OA=n("./src/components/views/auth/LoginWithQR-types.ts");const LA=({otherSessionsCount:e,disabled:t,signOutAllOtherSessions:n})=>{const s=(0,Z.Bo)([n?i.createElement(na.R$,{key:"sign-out-all-others",label:(0,l._t)("settings|sessions|sign_out_n_sessions",{count:e}),onClick:n,isDestructive:!0}):null]);return i.createElement(bw.r,{heading:(0,l._t)("settings|sessions|other_sessions_heading")},!!s.length&&i.createElement(RA,{disabled:t,title:(0,l._t)("common|options"),options:s}))},UA=({delegatedAuthAccountUrl:e,deviceId:t,onFinished:n})=>{const[s,o]=(0,i.useState)(!1),r=((e,t)=>{const n=new URL(e);return n.searchParams.set("action","session_end"),n.searchParams.set("device_id",t),n.toString()})(e,t);return i.createElement(J.A,{onFinished:n,title:(0,l._t)("action|sign_out"),contentId:"mx_Dialog_content"},i.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},(0,l._t)("auth|oidc|logout_redirect_warning")),i.createElement("div",{className:"mx_Dialog_buttons"},s?i.createElement(ie.A,{kind:"primary",onClick:()=>n(!0)},(0,l._t)("action|close")):i.createElement(i.Fragment,null,i.createElement(ie.A,{kind:"secondary",onClick:()=>n(!1)},(0,l._t)("action|cancel")),i.createElement(ie.A,{element:"a",onClick:()=>o(!0),kind:"primary",href:r,target:"_blank"},(0,l._t)("action|continue")))))};function FA(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}const VA=(0,i.lazy)((()=>Promise.all([n.e(7490),n.e(6080),n.e(7020)]).then(n.bind(n,"./src/components/views/auth/LoginWithQR.tsx")))),BA=(e,t,n)=>{const[r,a]=(0,i.useState)([]);return{onSignOutCurrentDevice:()=>{k.Ay.createDialog(Qa,{},void 0,!1,!0)},onSignOutOtherDevices:async r=>{if(!r.length)return;if(n&&1!==r.length)return void s.v.warn("Unexpectedly tried to sign out multiple OIDC-aware devices.");if(!n){if(!await(async e=>{const{finished:t}=k.Ay.createDialog(it.A,{title:(0,l._t)("action|sign_out"),description:i.createElement("div",null,i.createElement("p",null,(0,l._t)("settings|sessions|sign_out_confirm_description",{count:e}))),cancelButton:(0,l._t)("action|cancel"),button:(0,l._t)("action|sign_out")}),[n]=await t;return!!n})(r.length))return}let c=!1;try{if(a((e=>[...e,...r])),n){const[e]=r;try{c=await(async(e,t)=>{const{finished:n}=k.Ay.createDialog(UA,{deviceId:t,delegatedAuthAccountUrl:e}),[i]=await n;return!!i})(n,e)}catch(e){s.v.error("Error deleting OIDC-aware sessions",e)}}else{const t=(0,ur.v6)();await(async(e,t,n)=>{if(t.length)try{await NA(e,t)(null),await n(!0,void 0)}catch(s){var i;if(!(s instanceof o.MatrixError&&401===s.httpStatus&&null!==(i=s.data)&&void 0!==i&&i.flows))throw s;const r=t.length,a={[Fy.av.PHASE_PREAUTH]:{title:(0,l._t)("auth|uia|sso_title"),body:(0,l._t)("settings|sessions|confirm_sign_out_sso",{count:r}),continueText:(0,l._t)("auth|sso"),continueKind:"primary"},[Fy.av.PHASE_POSTAUTH]:{title:(0,l._t)("settings|sessions|confirm_sign_out",{count:r}),body:(0,l._t)("settings|sessions|confirm_sign_out_body",{count:r}),continueText:(0,l._t)("settings|sessions|confirm_sign_out_continue",{count:r}),continueKind:"danger"}};k.Ay.createDialog(ob.A,{title:(0,l._t)("common|authentication"),matrixClient:e,authData:s.data,onFinished:n,makeRequest:NA(e,t),aestheticsForStagePhases:{[Fy.av.LOGIN_TYPE]:a,[Fy.av.UNSTABLE_LOGIN_TYPE]:a}})}})(e,r,(async e=>{t.resolve(e)})),c=await t.promise}}catch(e){s.v.error("Error deleting sessions",e)}finally{c&&await t(),a((e=>e.filter((e=>!r.includes(e)))))}},signingOutDeviceIds:r}},jA=({showMsc4108QrCode:e})=>{var t;const{devices:n,dehydratedDeviceId:r,pushers:a,localNotificationSettings:c,currentDeviceId:d,isLoadingDeviceList:m,requestDeviceVerification:u,refreshDevices:h,saveDeviceName:p,setPushNotifications:v,supportsMSC3881:_}=ow(),[f,E]=(0,i.useState)(),[y,b]=(0,i.useState)([]),[w,S]=(0,i.useState)([]),A=(0,i.useRef)(null),C=(0,i.useRef)(),x=(0,i.useContext)(X.A),R=x.client,I=(0,hi.e)((async()=>(await x.oidcClientStore.readyPromise,x.oidcClientStore.accountManagementEndpoint)),[x.oidcClientStore]),T=!!I,P=null==R?void 0:R.getUserId(),N=P&&(null==R?void 0:R.getUser(P))||void 0,D=(0,hi.e)((()=>R.getVersions()),[R]),M=(0,i.useMemo)((()=>null==R?void 0:R.getClientWellKnown()),[R]),O=(0,hi.e)((async()=>{try{const e=await(null==R?void 0:R.getAuthIssuer());if(e)return(0,o.discoverAndValidateOIDCIssuerWellKnown)(e.issuer)}catch(e){s.v.error("Failed to discover OIDC metadata",e)}}),[R]),L=(0,hi.e)((async()=>{var e,t;return null!==(e=null===(t=R.getCrypto())||void 0===t?void 0:t.isCrossSigningReady())&&void 0!==e&&e}),[R]),{[d]:U}=n,F=(0,g.A)(n,[d].map(FA));r&&null!==(t=F[r])&&void 0!==t&&t.isVerified&&delete F[r];const V=Object.keys(F).length,B=V>0,j=(0,i.useCallback)((e=>{if(!u)return;const t=u(e);k.Ay.createDialog($,{verificationRequestPromise:t,member:N,onFinished:async()=>{(await t).cancel(),await h()}})}),[u,h,N]),{onSignOutCurrentDevice:W,onSignOutOtherDevices:z,signingOutDeviceIds:H}=BA(R,(async()=>{await h(),S([])}),I);(0,i.useEffect)((()=>()=>{clearTimeout(C.current)}),[C]),(0,i.useEffect)((()=>{S([])}),[f,S]);const K=B&&!T?()=>{z(Object.keys(F))}:void 0,[J,G]=(0,i.useState)(e?OA.Kt.Show:null),q=(0,i.useCallback)((()=>{G(null)}),[G]),Y=(0,i.useCallback)((()=>{G(OA.Kt.Show)}),[G]);return J?i.createElement(i.Suspense,{fallback:i.createElement(se.A,null)},i.createElement(VA,{mode:J,onFinished:q,client:R})):i.createElement(Us.A,null,i.createElement(Fs.X,null,i.createElement(MA,{onShowQr:Y,versions:D,wellKnown:M,oidcClientConfig:O,isCrossSigningReady:L}),i.createElement(PA,{devices:n,goToFilteredList:e=>{E(e),clearTimeout(C.current),C.current=window.setTimeout((()=>{var e;return null===(e=A.current)||void 0===e?void 0:e.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}))},currentDeviceId:d}),i.createElement(TA,{device:U,localNotificationSettings:c.get(d),setPushNotifications:v,isSigningOut:H.includes(d),isLoading:m,saveDeviceName:e=>p(d,e),onVerifyCurrentDevice:()=>{k.Ay.createDialog(ae,{onFinished:h})},onSignOutCurrentDevice:W,signOutAllOtherSessions:K,otherSessionsCount:V}),B&&i.createElement(Vs.P,{heading:i.createElement(LA,{otherSessionsCount:V,signOutAllOtherSessions:K,disabled:!!H.length}),description:(0,l._t)("settings|sessions|best_security_note"),stretchContent:!0},i.createElement(xA,{devices:F,pushers:a,localNotificationSettings:c,filter:f,expandedDeviceIds:y,signingOutDeviceIds:H,selectedDeviceIds:w,setSelectedDeviceIds:S,onFilterChange:E,onDeviceExpandToggle:e=>{y.includes(e)?b(y.filter((t=>t!==e))):b([...y,e])},onRequestDeviceVerification:u?j:void 0,onSignOutDevices:z,saveDeviceName:p,setPushNotifications:v,ref:A,supportsMSC3881:_,disableMultipleSignout:T}))))};function WA(e){const t={strong:e=>i.createElement("span",{className:"mx_UserSettingsDialog_title_strong"},e)};switch(e){case Na.v.Account:return(0,l._t)("settings|account|dialog_title",void 0,t);case Na.v.SessionManager:return(0,l._t)("settings|sessions|dialog_title",void 0,t);case Na.v.Appearance:return(0,l._t)("settings|appearance|dialog_title",void 0,t);case Na.v.Notifications:return(0,l._t)("settings|notifications|dialog_title",void 0,t);case Na.v.Preferences:return(0,l._t)("settings|preferences|dialog_title",void 0,t);case Na.v.Keyboard:return(0,l._t)("settings|keyboard|dialog_title",void 0,t);case Na.v.Sidebar:return(0,l._t)("settings|sidebar|dialog_title",void 0,t);case Na.v.Voice:return(0,l._t)("settings|voip|dialog_title",void 0,t);case Na.v.Security:return(0,l._t)("settings|security|dialog_title",void 0,t);case Na.v.Labs:return(0,l._t)("settings|labs|dialog_title",void 0,t);case Na.v.Mjolnir:return(0,l._t)("settings|labs_mjolnir|dialog_title",void 0,t);case Na.v.Help:return(0,l._t)("setting|help_about|dialog_title",void 0,t)}}function zA(e){const t=(0,pt.ti)(He.f.Voip),n=(0,pt.ti)("feature_mjolnir"),[s,o]=(0,i.useState)(e.showMsc4108QrCode),r=()=>{const o=[];return o.push(new Ds.oz(Na.v.Account,(0,l.AO)("settings|account|title"),i.createElement(mm.A,null),i.createElement(Sb,{closeSettingsFn:e.onFinished}),"UserSettingsGeneral")),o.push(new Ds.oz(Na.v.SessionManager,(0,l.AO)("settings|sessions|title"),i.createElement(gy.A,null),i.createElement(jA,{showMsc4108QrCode:s}),void 0)),o.push(new Ds.oz(Na.v.Appearance,(0,l.AO)("common|appearance"),i.createElement(Vg.A,null),i.createElement($b,null),"UserSettingsAppearance")),o.push(new Ds.oz(Na.v.Notifications,(0,l.AO)("notifications|enable_prompt_toast_title"),i.createElement(Og.A,null),i.createElement(iS,null),"UserSettingsNotifications")),o.push(new Ds.oz(Na.v.Preferences,(0,l.AO)("common|preferences"),i.createElement(vy.A,null),i.createElement(dS,{closeSettingsFn:e.onFinished}),"UserSettingsPreferences")),o.push(new Ds.oz(Na.v.Keyboard,(0,l.AO)("settings|keyboard|title"),i.createElement(_y.A,null),i.createElement(CS,null),"UserSettingsKeyboard")),o.push(new Ds.oz(Na.v.Sidebar,(0,l.AO)("settings|sidebar|title"),i.createElement(fy.A,null),i.createElement(Pa,null),"UserSettingsSidebar")),t&&o.push(new Ds.oz(Na.v.Voice,(0,l.AO)("settings|voip|title"),i.createElement(Ey.A,null),i.createElement(hS,null),"UserSettingsVoiceVideo")),o.push(new Ds.oz(Na.v.Security,(0,l.AO)("room_settings|security|title"),i.createElement(yy.A,null),i.createElement(vw,{closeSettingsFn:e.onFinished}),"UserSettingsSecurityPrivacy")),(xb()||M.A.getFeatureSettingNames().some((e=>M.A.getBetaInfo(e))))&&o.push(new Ds.oz(Na.v.Labs,(0,l.AO)("common|labs"),i.createElement(by.A,null),i.createElement(kb,null),"UserSettingsLabs")),n&&o.push(new Ds.oz(Na.v.Mjolnir,(0,l.AO)("labs_mjolnir|title"),i.createElement(wy.A,null),i.createElement(yS,null),"UserSettingMjolnir")),o.push(new Ds.oz(Na.v.Help,(0,l.AO)("setting|help_about|title"),i.createElement(ah.A,null),i.createElement(fS,null),"UserSettingsHelpAbout")),o},[a,c]=(0,Ds.yz)(r(),Na.v.Account,e.initialTabId),[d,m]=function(){const e=(0,i.useRef)(new Iy),[t,n]=(0,i.useState)(e.current.getActiveToast()),s=(0,i.useCallback)((()=>{n(e.current.getActiveToast())}),[n,e]);return(0,i.useEffect)((()=>{e.current.setCallback(s)}),[e,s]),[t,e.current]}();return i.createElement(X.A.Provider,{value:e.sdkContext},i.createElement(Ry.Provider,{value:m},i.createElement(J.A,{className:"mx_UserSettingsDialog",hasCancel:!0,onFinished:e.onFinished,title:WA(a),titleClass:"mx_UserSettingsDialog_title"},i.createElement("div",{className:"mx_SettingsDialog_content"},i.createElement(Ds.Ay,{tabs:r(),activeTabId:a,screenName:"UserSettings",onChange:e=>{c(e),o(!1)},responsive:!0})),i.createElement("div",{className:"mx_SettingsDialog_toastContainer"},d&&i.createElement(py.y,null,d)))))}var HA=n("./src/components/views/dialogs/CreateRoomDialog.tsx");class KA extends i.Component{render(){return i.createElement("div",null,i.createElement("h2",null,(0,l._t)("encryption|verification|complete_title")),i.createElement("p",null,(0,l._t)("encryption|verification|complete_description")),i.createElement("p",null,(0,l._t)("encryption|verification|explainer")),i.createElement(ot.A,{onPrimaryButtonClick:this.props.onDone,primaryButton:(0,l._t)("encryption|verification|complete_action"),hasCancel:!1}))}}class JA extends i.Component{render(){return i.createElement("div",null,i.createElement("p",null,(0,l._t)("encryption|verification|other_party_cancelled")),i.createElement(ot.A,{primaryButton:(0,l._t)("action|ok"),hasCancel:!1,onPrimaryButtonClick:this.props.onDone}))}}var GA=n("./src/components/views/verification/VerificationShowSas.tsx");class $A extends i.Component{constructor(e){super(e),(0,v.A)(this,"showSasEvent",void 0),(0,v.A)(this,"onFinished",(()=>{this.props.onFinished(3===this.state.phase)})),(0,v.A)(this,"onCancelClick",(()=>{this.props.onFinished(3===this.state.phase)})),(0,v.A)(this,"onContinueClick",(()=>{this.setState({phase:2}),this.props.verifier.verify().then((()=>{this.setState({phase:3})})).catch((e=>{s.v.log("Verification failed",e)}))})),(0,v.A)(this,"onVerifierShowSas",(e=>{this.showSasEvent=e,this.setState({phase:1,sas:e.sas})})),(0,v.A)(this,"onVerifierCancel",(()=>{this.setState({phase:4})})),(0,v.A)(this,"onSasMatchesClick",(()=>{var e;null===(e=this.showSasEvent)||void 0===e||e.confirm(),this.setState({phase:2})})),(0,v.A)(this,"onVerifiedDoneClick",(()=>{this.props.onFinished(!0)}));let t=0;this.props.verifier.hasBeenCancelled&&(s.v.log("Verifier was cancelled in the background."),t=4),this.showSasEvent=null,this.state={phase:t,sasVerified:!1,opponentProfile:null,opponentProfileError:null,sas:null}}componentDidMount(){this.props.verifier.on(V.VerifierEvent.ShowSas,this.onVerifierShowSas),this.props.verifier.on(V.VerifierEvent.Cancel,this.onVerifierCancel),this.fetchOpponentProfile()}componentWillUnmount(){4!==this.state.phase&&3!==this.state.phase&&this.props.verifier.cancel(new Error("User cancel")),this.props.verifier.removeListener(V.VerifierEvent.ShowSas,this.onVerifierShowSas)}async fetchOpponentProfile(){try{const e=await _.J.safeGet().getProfileInfo(this.props.verifier.userId);this.setState({opponentProfile:e})}catch(e){this.setState({opponentProfileError:e})}}renderPhaseStart(){const e=this.props.verifier.userId===_.J.safeGet().getUserId();let t;const n=this.state.opponentProfile;if(n){const e=n.avatar_url?(0,Wn.lH)(n.avatar_url).getSquareThumbnailHttp(48):null;t=i.createElement("div",{className:"mx_IncomingSasDialog_opponentProfile"},i.createElement(os.A,{name:n.displayname,idName:this.props.verifier.userId,url:e,size:"48px"}),i.createElement("h2",null,n.displayname))}else t=this.state.opponentProfileError?i.createElement("div",null,i.createElement(os.A,{name:this.props.verifier.userId.slice(1),idName:this.props.verifier.userId,size:"48px"}),i.createElement("h2",null,this.props.verifier.userId)):i.createElement(se.A,null);const s=[i.createElement("p",{key:"p1"},(0,l._t)("encryption|verification|incoming_sas_user_dialog_text_1")),i.createElement("p",{key:"p2"},(0,l._t)("encryption|verification|incoming_sas_user_dialog_text_2"))],o=[i.createElement("p",{key:"p1"},(0,l._t)("encryption|verification|incoming_sas_device_dialog_text_1")),i.createElement("p",{key:"p2"},(0,l._t)("encryption|verification|incoming_sas_device_dialog_text_2"))];return i.createElement("div",null,t,e?o:s,i.createElement(ot.A,{primaryButton:(0,l._t)("action|continue"),hasCancel:!0,onPrimaryButtonClick:this.onContinueClick,onCancel:this.onCancelClick}))}renderPhaseShowSas(){return this.showSasEvent?i.createElement(GA.A,{sas:this.showSasEvent.sas,onCancel:this.onCancelClick,onDone:this.onSasMatchesClick,isSelf:this.props.verifier.userId===_.J.safeGet().getUserId(),inDialog:!0}):null}renderPhaseWaitForPartnerToConfirm(){return i.createElement("div",null,i.createElement(se.A,null),i.createElement("p",null,(0,l._t)("encryption|verification|incoming_sas_dialog_waiting")))}renderPhaseVerified(){return i.createElement(KA,{onDone:this.onVerifiedDoneClick})}renderPhaseCancelled(){return i.createElement(JA,{onDone:this.onCancelClick})}render(){let e;switch(this.state.phase){case 0:e=this.renderPhaseStart();break;case 1:e=this.renderPhaseShowSas();break;case 2:e=this.renderPhaseWaitForPartnerToConfirm();break;case 3:e=this.renderPhaseVerified();break;case 4:e=this.renderPhaseCancelled()}return i.createElement(J.A,{title:(0,l._t)("encryption|verification|incoming_sas_dialog_title"),onFinished:this.onFinished,fixedWidth:!1},e)}}class qA extends i.PureComponent{render(){return i.createElement("div",{className:"mx_CompleteSecurityBody"},this.props.children)}}const YA=()=>{var e;const t=c.Ay.getObject("branding"),n=null!==(e=null==t?void 0:t.get("auth_footer_links"))&&void 0!==e?e:[{text:"Blog",url:"https://element.io/blog"},{text:"Mastodon",url:"https://mastodon.matrix.org/@Element"},{text:"GitHub",url:"https://github.com/element-hq/element-web"}],s=[];for(const e of n)s.push(i.createElement("a",{href:e.url,key:e.text,target:"_blank",rel:"noreferrer noopener"},e.text));return i.createElement("footer",{className:"mx_AuthFooter",role:"contentinfo"},s,i.createElement("a",{href:"https://matrix.org",target:"_blank",rel:"noreferrer noopener"},(0,l._t)("powered_by_matrix")))};class QA extends i.PureComponent{static getWelcomeBackgroundUrl(){if(QA.welcomeBackgroundUrl)return QA.welcomeBackgroundUrl;const e=c.Ay.getObject("branding");QA.welcomeBackgroundUrl="themes/element/img/backgrounds/lake.jpg";const t=null==e?void 0:e.get("welcome_background_url");if(t)if(Array.isArray(t)){const e=Math.floor(Math.random()*t.length);QA.welcomeBackgroundUrl=t[e]}else QA.welcomeBackgroundUrl=t;return QA.welcomeBackgroundUrl}render(){const e={background:`center/cover fixed url(${QA.getWelcomeBackgroundUrl()})`},t={position:"absolute",top:0,right:0,bottom:0,left:0,filter:"blur(40px)",background:e.background};return i.createElement("div",{className:"mx_AuthPage",style:e},i.createElement("div",{className:"mx_AuthPage_modal",style:{position:"relative",background:"initial"}},i.createElement("div",{className:"mx_AuthPage_modalBlur",style:t}),i.createElement("div",{className:"mx_AuthPage_modalContent",style:{display:"flex",zIndex:1,background:"rgba(255, 255, 255, 0.59)",borderRadius:"8px"}},this.props.children)),i.createElement(YA,null))}}(0,v.A)(QA,"welcomeBackgroundUrl",void 0);class XA extends i.Component{constructor(e){super(e),(0,v.A)(this,"onStoreUpdate",(()=>{const e=ne.sharedInstance();this.setState({phase:e.phase,lostKeys:e.lostKeys()})})),(0,v.A)(this,"onSkipClick",(()=>{ne.sharedInstance().skip()}));const t=ne.sharedInstance();t.start(),this.state={phase:t.phase,lostKeys:t.lostKeys()}}componentDidMount(){ne.sharedInstance().on("update",this.onStoreUpdate)}componentWillUnmount(){const e=ne.sharedInstance();e.off("update",this.onStoreUpdate),e.stop()}render(){const{phase:e,lostKeys:t}=this.state;let n,s;if(e===te.Loading)return null;if(e===te.Intro)t?(n=i.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),s=(0,l._t)("encryption|verification|after_new_login|unable_to_verify")):(n=i.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),s=(0,l._t)("encryption|verification|after_new_login|verify_this_device"));else if(e===te.Done)n=i.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_verified"}),s=(0,l._t)("encryption|verification|after_new_login|device_verified");else if(e===te.ConfirmSkip)n=i.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),s=(0,l._t)("common|are_you_sure");else if(e===te.Busy)n=i.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),s=(0,l._t)("encryption|verification|after_new_login|verify_this_device");else if(e===te.ConfirmReset)n=i.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),s=(0,l._t)("encryption|verification|after_new_login|reset_confirmation");else if(e!==te.Finished)throw new Error(`Unknown phase ${e}`);let o;return c.Ay.get("force_verification")||e!==te.Intro&&e!==te.ConfirmReset||(o=i.createElement(ie.A,{onClick:this.onSkipClick,className:"mx_CompleteSecurity_skip","aria-label":(0,l._t)("encryption|verification|after_new_login|skip_verification")})),i.createElement(QA,null,i.createElement(qA,null,i.createElement("h1",{className:"mx_CompleteSecurity_header"},n,s,o),i.createElement("div",{className:"mx_CompleteSecurity_body"},i.createElement(oe,{onFinished:this.props.onFinished}))))}}function ZA(e){var t;(0,l.UK)()!==e&&(M.A.setValue("language",null,O.p.DEVICE,e),null===(t=a.A.get())||void 0===t||t.reload())}function eC({disabled:e}){return c.Ay.get("disable_login_language_selector")?i.createElement("div",null):i.createElement(sS,{className:"mx_AuthBody_language",onOptionChange:ZA,value:(0,l.UK)(),disabled:e})}const tC=`<a href="https://matrix.org" target="_blank" rel="noreferrer noopener">\n    <img width="79" height="34" alt="Matrix" style="padding-left: 1px;vertical-align: middle" src="${n("./res/img/matrix.svg").A}"/>\n</a>`;class nC extends i.PureComponent{render(){const e=c.Ay.getObject("embedded_pages");let t;e&&(t=e.get("welcome_url"));const n={"$riot:ssoUrl":"#/start_sso","$riot:casUrl":"#/start_cas",$matrixLogo:tC,"[matrix]":tC};if(!t){var s;const e=c.Ay.getObject("branding"),i=null!==(s=null==e?void 0:e.get("auth_header_logo_url"))&&void 0!==s?s:"themes/element/img/logos/element-logo.svg";n.$logoUrl=i,t="welcome.html"}return i.createElement(QA,null,i.createElement("div",{className:dt()("mx_Welcome",{mx_WelcomePage_registrationDisabled:!M.A.getValue(He.f.Registration)})},i.createElement(_d,{className:"mx_WelcomePage",url:t,replaceMap:n}),i.createElement(eC,null)))}}class iC{constructor(e,t){(0,v.A)(this,"client",void 0),(0,v.A)(this,"clientSecret",void 0),(0,v.A)(this,"password",""),(0,v.A)(this,"sessionId",""),(0,v.A)(this,"logoutDevices",!1),(0,v.A)(this,"sendAttempt",0),this.client=(0,o.createClient)({baseUrl:e,idBaseUrl:t}),this.clientSecret=this.client.generateClientSecret()}requestResetToken(e){return this.sendAttempt++,this.client.requestPasswordEmailToken(e,this.clientSecret,this.sendAttempt).then((e=>(this.sessionId=e.sid,e)),(function(e){throw"M_THREEPID_NOT_FOUND"===e.errcode?e.message=(0,l._t)("auth|reset_password_email_not_found_title"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}setLogoutDevices(e){this.logoutDevices=e}async setNewPassword(e){this.password=e,await this.checkEmailLinkClicked()}async checkEmailLinkClicked(){const e={sid:this.sessionId,client_secret:this.clientSecret};try{await this.client.setPassword({type:"m.login.email.identity",threepid_creds:e},this.password,this.logoutDevices)}catch(e){throw 401===e.httpStatus?e.message=(0,l._t)("settings|general|add_email_failed_verification"):404===e.httpStatus?e.message=(0,l._t)("auth|reset_password_email_not_associated"):e.httpStatus&&(e.message+=` (Status ${e.httpStatus})`),e}}}class sC extends i.PureComponent{render(){var e;const t=c.Ay.getObject("branding"),n=null!==(e=null==t?void 0:t.get("auth_header_logo_url"))&&void 0!==e?e:"themes/element/img/logos/element-logo.svg";return i.createElement("aside",{className:"mx_AuthHeaderLogo"},i.createElement("img",{src:n,alt:"Element"}))}}class oC extends i.Component{render(){return i.createElement("div",{className:"mx_AuthHeader"},i.createElement(sC,null),i.createElement(eC,{disabled:this.props.disableLanguageSelector}))}}function rC({flex:e,className:t,children:n}){return i.createElement("main",{className:dt()("mx_AuthBody",t,{mx_AuthBody_flex:e})},n)}var aC=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/email-solid.js"),lC=n("./src/components/structures/ErrorMessage.tsx");const cC=({email:e,errorText:t,homeserver:n,loading:s,onInputChanged:o,onLoginClick:r,onSubmitForm:a})=>{const c=s?i.createElement(se.A,{w:16,h:16}):(0,l._t)("auth|forgot_password_send_email"),d=(0,i.useRef)(null);return i.createElement(i.Fragment,null,i.createElement(aC.A,{className:"mx_AuthBody_icon"}),i.createElement("h1",null,(0,l._t)("auth|enter_email_heading")),i.createElement("p",{className:"mx_AuthBody_text"},(0,l._t)("auth|enter_email_explainer",{homeserver:n},{b:e=>i.createElement("strong",null,e)})),i.createElement("form",{onSubmit:async e=>{var t,n,i;await(null===(t=d.current)||void 0===t?void 0:t.validate({allowEmpty:!1}))?a(e):(null===(n=d.current)||void 0===n||n.focus(),null===(i=d.current)||void 0===i||i.validate({allowEmpty:!1,focused:!0}))}},i.createElement("fieldset",{disabled:s},i.createElement("div",{className:"mx_AuthBody_fieldRow"},i.createElement(Jy,{name:"reset_email",label:(0,l.AO)("common|email_address"),labelRequired:(0,l.AO)("auth|forgot_password_email_required"),labelInvalid:(0,l.AO)("auth|forgot_password_email_invalid"),value:e,autoFocus:!0,onChange:e=>o("email",e),fieldRef:d})),t&&i.createElement(lC.K,{message:t}),i.createElement("button",{type:"submit",className:"mx_Login_submit"},c),i.createElement("div",{className:"mx_AuthBody_button-container"},i.createElement(ie.A,{className:"mx_AuthBody_sign-in-instead-button",element:"button",kind:"link",onClick:e=>{e.preventDefault(),r()}},(0,l._t)("auth|sign_in_instead"))))))};var dC=n("./res/img/element-icons/email-prompt.svg");const mC=(e,t)=>{const n=(0,i.useRef)(),[s,o]=(0,i.useState)(e);return(0,i.useEffect)((()=>()=>{clearTimeout(n.current)})),{toggle:()=>{o(!e),n.current=window.setTimeout((()=>o(e)),t)},value:s}},uC=({email:e,errorText:t,onReEnterEmailClick:n,onSubmitForm:s,onResendClick:o})=>{const{toggle:r,value:a}=mC(!1,2500);return i.createElement(i.Fragment,null,i.createElement(dC.I,{className:"mx_AuthBody_emailPromptIcon--shifted"}),i.createElement("h1",null,(0,l._t)("auth|uia|email_auth_header")),i.createElement("div",{className:"mx_AuthBody_text"},i.createElement("p",null,(0,l._t)("auth|check_email_explainer",{email:e},{b:e=>i.createElement("strong",null,e)})),i.createElement("div",{className:"mx_AuthBody_did-not-receive"},i.createElement("span",{className:"mx_VerifyEMailDialog_text-light"},(0,l._t)("auth|check_email_wrong_email_prompt")),i.createElement(ie.A,{className:"mx_AuthBody_resend-button",kind:"link",onClick:n},(0,l._t)("auth|check_email_wrong_email_button")))),t&&i.createElement(lC.K,{message:t}),i.createElement("input",{onClick:s,type:"button",className:"mx_Login_submit",value:(0,l._t)("action|next")}),i.createElement("div",{className:"mx_AuthBody_did-not-receive"},i.createElement("span",{className:"mx_VerifyEMailDialog_text-light"},(0,l._t)("auth|check_email_resend_prompt")),i.createElement(Et.m,{description:(0,l._t)("auth|check_email_resend_tooltip"),placement:"top",open:a},i.createElement(ie.A,{className:"mx_AuthBody_resend-button",kind:"link",onClick:async()=>{await o(),r()}},i.createElement(sn.A,{className:"mx_Icon mx_Icon_16"}),(0,l._t)("action|resend")))))},hC=({email:e,errorText:t,onCloseClick:n,onReEnterEmailClick:s,onResendClick:o})=>{const{toggle:r,value:a}=mC(!1,2500);return i.createElement(i.Fragment,null,i.createElement(dC.I,{className:"mx_AuthBody_emailPromptIcon"}),i.createElement("h1",null,(0,l._t)("auth|verify_email_heading")),i.createElement("p",null,(0,l._t)("auth|verify_email_explainer",{email:e},{b:e=>i.createElement("strong",null,e)})),i.createElement("div",{className:"mx_AuthBody_did-not-receive"},i.createElement("span",{className:"mx_VerifyEMailDialog_text-light"},(0,l._t)("auth|check_email_resend_prompt")),i.createElement(Et.m,{description:(0,l._t)("auth|check_email_resend_tooltip"),placement:"top",open:a},i.createElement(ie.A,{className:"mx_AuthBody_resend-button",kind:"link",onClick:async()=>{await o(),r()}},i.createElement(sn.A,{className:"mx_Icon mx_Icon_16"}),(0,l._t)("action|resend"))),t&&i.createElement(lC.K,{message:t})),i.createElement("div",{className:"mx_AuthBody_did-not-receive"},i.createElement("span",{className:"mx_VerifyEMailDialog_text-light"},(0,l._t)("auth|check_email_wrong_email_prompt")),i.createElement(ie.A,{className:"mx_AuthBody_resend-button",kind:"link",onClick:s},(0,l._t)("auth|check_email_wrong_email_button"))),i.createElement(ie.A,{onClick:n,className:"mx_Dialog_cancelButton","aria-label":(0,l._t)("dialog_close_label")}))};var pC=function(e){return e[e.EnterEmail=1]="EnterEmail",e[e.SendingEmail=2]="SendingEmail",e[e.EmailSent=3]="EmailSent",e[e.PasswordInput=4]="PasswordInput",e[e.ResettingPassword=5]="ResettingPassword",e[e.Done=6]="Done",e}(pC||{});class gC extends i.Component{constructor(e){super(e),(0,v.A)(this,"unmounted",!1),(0,v.A)(this,"reset",void 0),(0,v.A)(this,"fieldPassword",null),(0,v.A)(this,"fieldPasswordConfirm",null),(0,v.A)(this,"sendVerificationMail",(async()=>{try{return await this.reset.requestResetToken(this.state.email),!0}catch(e){this.handleError(e)}return!1})),(0,v.A)(this,"onSubmitForm",(async e=>{if(e.preventDefault(),[pC.SendingEmail,pC.ResettingPassword].includes(this.state.phase))return;this.setState({errorText:""});if(await this.checkServerLiveliness(this.props.serverConfig))switch(this.state.phase){case pC.EnterEmail:this.onPhaseEmailInputSubmit();break;case pC.EmailSent:this.onPhaseEmailSentSubmit();break;case pC.PasswordInput:this.onPhasePasswordInputSubmit()}})),(0,v.A)(this,"onInputChanged",((e,t)=>{let n=t.currentTarget.value;"email"===e&&(n=n.trim()),this.setState({[e]:n})})),this.state={phase:pC.EnterEmail,email:"",password:"",password2:"",errorText:null,serverIsAlive:!0,serverDeadError:"",logoutDevices:!1},this.reset=new iC(this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl)}componentDidUpdate(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl||this.checkServerLiveliness(this.props.serverConfig)}componentWillUnmount(){this.unmounted=!0}async checkServerLiveliness(e){try{if(await p.validateServerConfigWithStaticUrls(e.hsUrl,e.isUrl),this.unmounted)return!1;this.setState({serverIsAlive:!0})}catch(e){if(this.unmounted)return!1;const{serverIsAlive:t,serverDeadError:n}=p.authComponentStateForError(e,"forgot_password");return this.setState({serverIsAlive:t,errorText:n}),t}return!0}async onPhaseEmailInputSubmit(){this.phase=pC.SendingEmail,await this.sendVerificationMail()?this.phase=pC.EmailSent:this.phase=pC.EnterEmail}handleError(e){if(429!==(null==e?void 0:e.httpStatus))"ConnectionError"!==(null==e?void 0:e.name)?this.setState({errorText:e.message}):this.setState({errorText:(0,l._t)("cannot_reach_homeserver")+": "+(0,l._t)("cannot_reach_homeserver_detail")});else{var t;const n=parseInt(null==e||null===(t=e.data)||void 0===t?void 0:t.retry_after_ms,10),i=isNaN(n)?(0,l._t)("auth|reset_password|rate_limit_error"):(0,l._t)("auth|reset_password|rate_limit_error_with_time",{timeout:(0,Re.Xo)(n/1e3)});this.setState({errorText:i})}}async onPhaseEmailSentSubmit(){this.setState({phase:pC.PasswordInput})}set phase(e){this.setState({phase:e})}async verifyFieldsBeforeSubmit(){const e=[this.fieldPassword,this.fieldPasswordConfirm],t=[];for(const n of e){if(!n)continue;await n.validate({allowEmpty:!1})||t.push(n)}return 0===t.length||(t[0].focus(),t[0].validate({allowEmpty:!1,focused:!0}),!1)}async onPhasePasswordInputSubmit(){if(!await this.verifyFieldsBeforeSubmit())return;if(this.state.logoutDevices){if(!await this.renderConfirmLogoutDevicesDialog())return}this.phase=pC.ResettingPassword,this.reset.setLogoutDevices(this.state.logoutDevices);try{return await this.reset.setNewPassword(this.state.password),void this.setState({phase:pC.Done})}catch(e){if(401!==e.httpStatus)return void this.handleError(e)}const e=k.Ay.createDialog(hC,{email:this.state.email,errorText:this.state.errorText,onCloseClick:()=>{e.close(),this.setState({phase:pC.PasswordInput})},onReEnterEmailClick:()=>{e.close(),this.setState({phase:pC.EnterEmail})},onResendClick:this.sendVerificationMail},"mx_VerifyEMailDialog",!1,!1,{onBeforeClose:async e=>("backgroundClick"===e&&this.setState({phase:pC.PasswordInput}),!0)});for(;this.state.phase===pC.ResettingPassword;)try{await this.reset.setNewPassword(this.state.password),this.setState({phase:pC.Done}),e.close()}catch{await(0,ur.yy)(2e3)}}renderEnterEmail(){return i.createElement(cC,{email:this.state.email,errorText:this.state.errorText,homeserver:this.props.serverConfig.hsName,loading:this.state.phase===pC.SendingEmail,onInputChanged:this.onInputChanged,onLoginClick:this.props.onLoginClick,onSubmitForm:this.onSubmitForm})}async renderConfirmLogoutDevicesDialog(){const{finished:e}=k.Ay.createDialog(it.A,{title:(0,l._t)("common|warning"),description:i.createElement("div",null,i.createElement("p",null,(0,l._t)("auth|reset_password|other_devices_logout_warning_1")),i.createElement("p",null,(0,l._t)("auth|reset_password|other_devices_logout_warning_2"))),button:(0,l._t)("action|continue")}),[t]=await e;return!!t}renderCheckEmail(){return i.createElement(uC,{email:this.state.email,errorText:this.state.errorText,onReEnterEmailClick:()=>this.setState({phase:pC.EnterEmail}),onResendClick:this.sendVerificationMail,onSubmitForm:this.onSubmitForm})}renderSetPassword(){const e=this.state.phase===pC.ResettingPassword?i.createElement(se.A,{w:16,h:16}):(0,l._t)("auth|reset_password_action");return i.createElement(i.Fragment,null,i.createElement(hm.A,{className:"mx_AuthBody_lockIcon"}),i.createElement("h1",null,(0,l._t)("auth|reset_password_title")),i.createElement("form",{onSubmit:this.onSubmitForm},i.createElement("fieldset",{disabled:this.state.phase===pC.ResettingPassword},i.createElement("div",{className:"mx_AuthBody_fieldRow"},i.createElement(By.A,{name:"reset_password",type:"password",label:(0,l.AO)("auth|change_password_new_label"),value:this.state.password,minScore:3,fieldRef:e=>this.fieldPassword=e,onChange:this.onInputChanged.bind(this,"password"),autoComplete:"new-password"}),i.createElement(Yy.A,{name:"reset_password_confirm",label:(0,l.AO)("auth|reset_password|confirm_new_password"),labelRequired:(0,l.AO)("auth|reset_password|password_not_entered"),labelInvalid:(0,l.AO)("auth|reset_password|passwords_mismatch"),value:this.state.password2,password:this.state.password,fieldRef:e=>this.fieldPasswordConfirm=e,onChange:this.onInputChanged.bind(this,"password2"),autoComplete:"new-password"})),i.createElement("div",{className:"mx_AuthBody_fieldRow"},i.createElement(Ms.A,{onChange:()=>this.setState({logoutDevices:!this.state.logoutDevices}),checked:this.state.logoutDevices},(0,l._t)("auth|reset_password|sign_out_other_devices"))),this.state.errorText&&i.createElement(lC.K,{message:this.state.errorText}),i.createElement("button",{type:"submit",className:"mx_Login_submit"},e))))}renderDone(){return i.createElement(i.Fragment,null,i.createElement(T_.A,{className:"mx_Icon mx_Icon_32 mx_Icon_accent"}),i.createElement("h1",null,(0,l._t)("auth|reset_password|reset_successful")),this.state.logoutDevices?i.createElement("p",null,(0,l._t)("auth|reset_password|devices_logout_success")):null,i.createElement("input",{className:"mx_Login_submit",type:"button",onClick:this.props.onComplete,value:(0,l._t)("auth|reset_password|return_to_login")}))}render(){let e;switch(this.state.phase){case pC.EnterEmail:case pC.SendingEmail:e=this.renderEnterEmail();break;case pC.EmailSent:e=this.renderCheckEmail();break;case pC.PasswordInput:case pC.ResettingPassword:e=this.renderSetPassword();break;case pC.Done:e=this.renderDone();break;default:return s.v.warn(`unknown forgot password phase ${this.state.phase}`),void this.setState({phase:pC.EnterEmail})}return i.createElement(QA,null,i.createElement(oC,null),i.createElement(rC,{className:"mx_AuthBody_forgot-password"},e))}}async function vC(e,t,n){const i=e.getCrypto();if(!i)throw new Error("No crypto API found!");await i.bootstrapCrossSigning({authUploadDeviceSigningKeys:async i=>{if(n&&await async function(e){try{return await e.uploadDeviceSigningKeys(void 0,{}),s.v.log("uploadDeviceSigningKeys unexpectedly succeeded without UI auth!"),!1}catch(e){return e instanceof o.MatrixError&&e.data&&e.data.flows?e.data.flows.some((e=>1===e.stages.length&&"m.login.password"===e.stages[0])):(s.v.log("uploadDeviceSigningKeys advertised no flows!"),!1)}}(e))await i({type:"m.login.password",identifier:{type:"m.id.user",user:e.getUserId()},password:n});else if(t)await i({});else{const t={[Fy.av.PHASE_PREAUTH]:{title:(0,l._t)("auth|uia|sso_title"),body:(0,l._t)("auth|uia|sso_preauth_body"),continueText:(0,l._t)("auth|sso"),continueKind:"primary"},[Fy.av.PHASE_POSTAUTH]:{title:(0,l._t)("encryption|confirm_encryption_setup_title"),body:(0,l._t)("encryption|confirm_encryption_setup_body"),continueText:(0,l._t)("action|confirm"),continueKind:"primary"}},{finished:n}=k.Ay.createDialog(ob.A,{title:(0,l._t)("encryption|bootstrap_title"),matrixClient:e,makeRequest:i,aestheticsForStagePhases:{[Fy.av.LOGIN_TYPE]:t,[Fy.av.UNSTABLE_LOGIN_TYPE]:t}}),[s]=await n;if(!s)throw new Error("Cross-signing key upload auth canceled")}}})}const _C=({matrixClient:e,accountPassword:t,tokenLogin:n,onFinished:o})=>{const[r,a]=(0,i.useState)(!1),c=(0,i.useCallback)((async()=>{if(e.getCrypto()){a(!1);try{await vC(e,n,t),o(!0)}catch(e){if(n)return void o(!1);a(!0),s.v.error("Error bootstrapping cross-signing",e)}}}),[e,n,t,o]),d=(0,i.useCallback)((()=>{o(!1)}),[o]);let m;return(0,i.useEffect)((()=>{c()}),[c]),m=r?i.createElement("div",null,i.createElement("p",null,(0,l._t)("encryption|unable_to_setup_keys_error")),i.createElement("div",{className:"mx_Dialog_buttons"},i.createElement(ot.A,{primaryButton:(0,l._t)("action|retry"),onPrimaryButtonClick:c,onCancel:d}))):i.createElement("div",null,i.createElement(se.A,null)),i.createElement(J.A,{className:"mx_CreateCrossSigningDialog",onFinished:o,title:(0,l._t)("encryption|bootstrap_title"),hasCancel:!1,fixedWidth:!1},i.createElement("div",null,m))};class fC extends i.Component{render(){return i.createElement(QA,null,i.createElement(qA,null,i.createElement(_C,{matrixClient:this.props.matrixClient,onFinished:this.props.onFinished,accountPassword:this.props.accountPassword,tokenLogin:this.props.tokenLogin})))}}const EC=["matrixClient","loginType","fragmentAfterLogin","idp","primary","mini","action","flow"],yC=e=>{let t,{matrixClient:s,loginType:r,fragmentAfterLogin:c,idp:d,primary:m,mini:u,action:h,flow:p}=e,v=(0,g.A)(e,EC);t=d?(0,l._t)("auth|continue_with_idp",{provider:d.name}):o.DELEGATED_OIDC_COMPATIBILITY.findIn(p)?(0,l._t)("action|continue"):(0,l._t)("auth|sign_in_with_sso");const _=()=>{var e,t;const n=(e=>{switch(e){case o.IdentityProviderBrand.Apple:return"Apple";case o.IdentityProviderBrand.Facebook:return"Facebook";case o.IdentityProviderBrand.Github:return"GitHub";case o.IdentityProviderBrand.Gitlab:return"GitLab";case o.IdentityProviderBrand.Google:return"Google";default:return"SSO"}})(null!==(e=null==d?void 0:d.brand)&&void 0!==e?e:"");B.Vo.instance.setAuthenticationType(n),null===(t=a.A.get())||void 0===t||t.startSingleSignOn(s,r,c,null==d?void 0:d.id,h)};let f,E;const y=null!=d&&d.brand?(e=>{switch(e){case o.IdentityProviderBrand.Apple:return n("./res/img/element-icons/brands/apple.svg").A;case o.IdentityProviderBrand.Facebook:return n("./res/img/element-icons/brands/facebook.svg").A;case o.IdentityProviderBrand.Github:return n("./res/img/element-icons/brands/github.svg").A;case o.IdentityProviderBrand.Gitlab:return n("./res/img/element-icons/brands/gitlab.svg").A;case o.IdentityProviderBrand.Google:return n("./res/img/element-icons/brands/google.svg").A;case o.IdentityProviderBrand.Twitter:return n("./res/img/element-icons/brands/twitter.svg").A;default:return null}})(d.brand):null;if(null!=d&&d.brand&&y){const e=d.brand.split(".").pop();E=`mx_SSOButton_brand_${e}`,f=i.createElement("img",{src:y,height:"24",width:"24",alt:e})}else if("string"==typeof(null==d?void 0:d.icon)&&d.icon.startsWith("mxc://")){var b;const e=null!==(b=(0,Wn.lH)(d.icon,s).getSquareThumbnailHttp(24))&&void 0!==b?b:void 0;f=i.createElement("img",{src:e,height:"24",width:"24",alt:d.name})}const w=E?{[E]:E}:void 0,S=dt()("mx_SSOButton",{mx_SSOButton_mini:u,mx_SSOButton_default:!d,mx_SSOButton_primary:m},w);return u?i.createElement(ie.A,(0,_t.A)({},v,{title:t,className:S,onClick:_}),f):i.createElement(ie.A,(0,_t.A)({},v,{className:S,onClick:_}),f,t)},bC=({matrixClient:e,flow:t,loginType:n,fragmentAfterLogin:s,primary:o,action:r,disabled:a})=>{const l=t.identity_providers||[];if(l.length<2)return i.createElement("div",{className:"mx_SSOButtons"},i.createElement(yC,{matrixClient:e,loginType:n,fragmentAfterLogin:s,idp:l[0],primary:o,action:r,flow:t,disabled:a}));const c=Math.ceil(l.length/6),d=Math.ceil(l.length/c);return i.createElement("div",{className:"mx_SSOButtons"},(0,Vn.chunk)(l,d).map((a=>i.createElement("div",{key:a[0].id,className:"mx_SSOButtons_row"},a.map((a=>i.createElement(yC,{key:a.id,matrixClient:e,loginType:n,fragmentAfterLogin:s,idp:a,mini:!0,primary:o,action:r,flow:t})))))))};class wC extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,"defaultServer",void 0),(0,v.A)(this,"fieldRef",(0,i.createRef)()),(0,v.A)(this,"validatedConf",void 0),(0,v.A)(this,"onDefaultChosen",(()=>{this.setState({defaultChosen:!0})})),(0,v.A)(this,"onOtherChosen",(()=>{this.setState({defaultChosen:!1})})),(0,v.A)(this,"onHomeserverChange",(e=>{this.setState({otherHomeserver:e.target.value})})),(0,v.A)(this,"validate",(0,xm.A)({deriveData:async({value:e})=>{let t=(null!=e?e:"").trim();if(!t.includes("://"))try{const e=await o.AutoDiscovery.findClientConfig(t);return this.validatedConf=await p.buildValidatedConfigFromDiscovery(t,e),{}}catch(e){s.v.error(`Attempted ${t} as a server_name but it failed`,e)}t.includes("://")||(t="https://"+t);try{return this.validatedConf=await p.validateServerConfigWithStaticUrls(t),{}}catch(e){s.v.error(e);if(p.authComponentStateForError(e).serverErrorIsFatal){let t=(0,l._t)("auth|server_picker_failed_validate_homeserver");return e instanceof l.P7&&e.translatedMessage&&(t=e.translatedMessage),{error:t}}try{return this.validatedConf=await p.validateServerConfigWithStaticUrls(t,void 0,!0),{}}catch(e){return s.v.error(e),{error:(0,l._t)("auth|server_picker_invalid_url")}}}},rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,l._t)("auth|server_picker_required")},{key:"valid",test:async function({value:e},{error:t}){return!e||!t},invalid:function({error:e}){return null!=e?e:null}}]})),(0,v.A)(this,"onHomeserverValidate",(e=>this.validate(e))),(0,v.A)(this,"onSubmit",(async e=>{var t;if(e.preventDefault(),this.state.defaultChosen)return void this.props.onFinished(this.defaultServer);var n,i;if(!await(null===(t=this.fieldRef.current)||void 0===t?void 0:t.validate({allowEmpty:!1})))return null===(n=this.fieldRef.current)||void 0===n||n.focus(),void(null===(i=this.fieldRef.current)||void 0===i||i.validate({allowEmpty:!1,focused:!0}));this.props.onFinished(this.validatedConf)}));const t=c.Ay.get();this.defaultServer=t.validated_server_config;const{serverConfig:n}=this.props;let r="";n.isDefault||(r=n.isNameResolvable&&n.hsName?n.hsName:n.hsUrl),this.state={defaultChosen:n.isDefault,otherHomeserver:r}}render(){let e;"matrix.org"===this.defaultServer.hsName&&(e=(0,l._t)("auth|server_picker_matrix.org"));let t=this.defaultServer.hsName;return this.defaultServer.hsNameIsDifferent&&(t=i.createElement(Eh.A,{className:"mx_Login_underlinedServerName",tooltip:this.defaultServer.hsUrl},this.defaultServer.hsName)),i.createElement(J.A,{title:this.props.title||(0,l._t)("auth|server_picker_title"),className:"mx_ServerPickerDialog",contentId:"mx_ServerPickerDialog",onFinished:this.props.onFinished,fixedWidth:!1,hasCancel:!0},i.createElement("form",{className:"mx_Dialog_content",id:"mx_ServerPickerDialog",onSubmit:this.onSubmit},i.createElement("p",null,(0,l._t)("auth|server_picker_intro")," ",e),i.createElement(xs.A,{name:"defaultChosen",value:"true",checked:this.state.defaultChosen,onChange:this.onDefaultChosen},t),i.createElement(xs.A,{name:"defaultChosen",value:"false",className:"mx_ServerPickerDialog_otherHomeserverRadio",checked:!this.state.defaultChosen,onChange:this.onOtherChosen,childrenInLabel:!1,"aria-label":(0,l._t)("auth|server_picker_custom")},i.createElement(ks.A,{type:"text",className:"mx_ServerPickerDialog_otherHomeserver",label:(0,l._t)("auth|server_picker_custom"),onChange:this.onHomeserverChange,onFocus:this.onOtherChosen,ref:this.fieldRef,onValidate:this.onHomeserverValidate,value:this.state.otherHomeserver,validateOnChange:!1,validateOnFocus:!1,autoFocus:!0,id:"mx_homeserverInput"})),i.createElement("p",null,(0,l._t)("auth|server_picker_explainer")),i.createElement(ie.A,{className:"mx_ServerPickerDialog_continue",kind:"primary",onClick:this.onSubmit},(0,l._t)("action|continue")),i.createElement("h2",null,(0,l._t)("action|learn_more")),i.createElement(Ja.A,{href:"https://matrix.org/docs/matrix-concepts/elements-of-matrix/#homeserver",target:"_blank",rel:"noreferrer noopener"},(0,l._t)("auth|server_picker_learn_more"))))}}const SC=()=>{const e=c.Ay.get().brand;k.Ay.createDialog(Ka.A,{title:(0,l._t)("auth|server_picker_title_default"),description:(0,l._t)("auth|server_picker_description",{brand:e}),button:(0,l._t)("action|dismiss"),hasCloseButton:!1,fixedWidth:!1},"mx_ServerPicker_helpDialog")},AC=({title:e,dialogTitle:t,serverConfig:n,onServerConfigChange:s,disabled:o})=>{const r=c.Ay.get("disable_custom_urls");let a;if(!r&&s){const e=()=>{((e,t,n)=>{k.Ay.createDialog(wC,{title:e,serverConfig:t,onFinished:n})})(t,n,(e=>{e&&s(e)}))};a=i.createElement(ie.A,{className:"mx_ServerPicker_change",kind:"link",onClick:e,disabled:o},(0,l._t)("action|edit"))}let d,m=n.isNameResolvable?n.hsName:n.hsUrl;return n.hsNameIsDifferent&&(m=i.createElement(Eh.A,{className:"mx_Login_underlinedServerName",tooltip:n.hsUrl},n.hsName)),"matrix.org"===n.hsName&&(d=i.createElement("span",{className:"mx_ServerPicker_desc"},(0,l._t)("auth|server_picker_description_matrix.org"))),i.createElement("div",{className:"mx_ServerPicker"},i.createElement("h2",null,e||(0,l._t)("common|homeserver")),r?null:i.createElement(ie.A,{className:"mx_ServerPicker_help",onClick:SC,"aria-label":(0,l._t)("common|help")}),i.createElement("span",{className:"mx_ServerPicker_server",title:"string"==typeof m?m:void 0},m),a,d)};var CC=n("./src/components/structures/auth/header/AuthHeaderContext.tsx");function xC({title:e,icon:t,serverPicker:n,children:s}){var o,r,a;const l=(0,i.useContext)(CC.h);if(!l)return i.createElement(i.Fragment,null);const c=null!==(o=l.state[0])&&void 0!==o?o:null;return i.createElement(i.Fragment,null,null!==(r=null==c?void 0:c.icon)&&void 0!==r?r:t,i.createElement("h1",null,null!==(a=null==c?void 0:c.title)&&void 0!==a?a:e),s,!0!==(null==c?void 0:c.hideServerPicker)&&n)}var kC=n("./src/components/structures/auth/header/AuthHeaderProvider.tsx");function RC(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}const IC=(...e)=>{M.A.getValue("debug_registration")&&s.v.log.call(console,"Registration debuglog:",...e)};class TC extends i.Component{constructor(e){super(e),(0,v.A)(this,"loginLogic",void 0),(0,v.A)(this,"latestServerConfig",void 0),(0,v.A)(this,"oidcNativeFlowEnabled",!1),(0,v.A)(this,"unloadCallback",(e=>{if(this.state.doingUIAuth)return e.preventDefault(),e.returnValue="",""})),(0,v.A)(this,"onFormSubmit",(async e=>{this.setState({errorText:"",busy:!0,formVals:e,doingUIAuth:!0})})),(0,v.A)(this,"requestEmailToken",((e,t,n,i)=>{if(!this.state.matrixClient)throw new Error("Matrix client has not yet been loaded");return this.state.matrixClient.requestRegisterEmailToken(e,t,n)})),(0,v.A)(this,"onUIAuthFinished",(async(e,t)=>{if(!this.state.matrixClient)throw new Error("Matrix client has not yet been loaded");if(IC("Registration: ui authentication finished: ",{success:e,response:t}),!e){var n;let e=t.message||t.toString();if(t instanceof o.MatrixError&&"M_RESOURCE_LIMIT_EXCEEDED"===t.errcode){const n=(0,ho.AB)(t.data.limit_type,t.data.admin_contact,ho.Ch),s=(0,ho.AB)(t.data.limit_type,t.data.admin_contact,ho.aZ);e=i.createElement("div",null,i.createElement("p",null,n),i.createElement("p",null,s))}else if(null!==(n=t.flows)&&void 0!==n&&n.some((e=>e.stages.includes(o.AuthType.Msisdn)))){var r;(null!==(r=t.flows)&&void 0!==r?r:[]).some((e=>e.stages.includes(o.AuthType.Msisdn)))||(e=(0,l._t)("auth|unsupported_auth_msisdn"))}else t instanceof o.MatrixError&&"M_USER_IN_USE"===t.errcode?e=(0,l._t)("auth|username_in_use"):t instanceof o.MatrixError&&"M_THREEPID_IN_USE"===t.errcode&&(e=(0,l._t)("auth|3pid_in_use"));return void this.setState({busy:!1,doingUIAuth:!1,errorText:e})}const a=t.user_id,c=t.access_token;if(!a||!c)throw new Error("Registration failed");_.J.setJustRegisteredUserId(a);const d={doingUIAuth:!1,registeredUsername:a,differentLoggedInUserId:void 0,completedNoSignin:!1,busy:!0},[m,u]=await Ko();m&&!u&&m!==a&&(s.v.log(`Found a session for ${m} but ${a} has just registered.`),d.differentLoggedInUserId=m);const h=Boolean(this.state.formVals.email),p=Boolean(c);if(IC("Registration: ui auth finished:",{hasEmail:h,hasAccessToken:p}),p&&!d.differentLoggedInUserId)if(this.props.mobileRegister){const e={user_id:a,home_server:this.state.matrixClient.getHomeserverUrl(),access_token:c,device_id:t.device_id},n=new CustomEvent("mobileregistrationresponse",{detail:e});window.dispatchEvent(n),d.busy=!1,d.completedNoSignin=!0}else await this.props.onLoggedIn({userId:a,deviceId:t.device_id,homeserverUrl:this.state.matrixClient.getHomeserverUrl(),identityServerUrl:this.state.matrixClient.getIdentityServerUrl(),accessToken:c},this.state.formVals.password),this.setupPushers();else d.busy=!1,d.completedNoSignin=!0;this.setState(d)})),(0,v.A)(this,"onLoginClick",(e=>{e.preventDefault(),e.stopPropagation(),this.props.onLoginClick()})),(0,v.A)(this,"onGoToFormClicked",(e=>{e.preventDefault(),e.stopPropagation(),this.replaceClient(this.props.serverConfig),this.setState({busy:!1,doingUIAuth:!1})})),(0,v.A)(this,"makeRegisterRequest",(e=>{if(!this.state.matrixClient)throw new Error("Matrix client has not yet been loaded");const t={username:this.state.formVals.username,password:this.state.formVals.password,initial_device_display_name:this.props.defaultDeviceDisplayName,auth:void 0,inhibit_login:void 0};return e&&(t.auth=e),IC("Registration: sending registration request:",e),this.state.matrixClient.registerRequest(t)})),(0,v.A)(this,"onLoginClickWithCheck",(async e=>{e.preventDefault();const t=await Ho({ignoreGuest:!0});return t||this.props.onLoginClick(),t})),this.state={busy:!1,errorText:null,formVals:{email:this.props.email},doingUIAuth:Boolean(this.props.sessionId),flows:null,completedNoSignin:!1,serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""},this.oidcNativeFlowEnabled=M.A.getValue(Sl.O5.OidcNativeFlow);const{hsUrl:t,isUrl:n,delegatedAuthentication:r}=this.props.serverConfig;this.loginLogic=new I(t,n,null,{defaultDeviceDisplayName:"Element login check",delegatedAuthentication:this.oidcNativeFlowEnabled?r:void 0})}componentDidMount(){this.replaceClient(this.props.serverConfig),window.addEventListener("beforeunload",this.unloadCallback)}componentWillUnmount(){window.removeEventListener("beforeunload",this.unloadCallback)}componentDidUpdate(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl||this.replaceClient(this.props.serverConfig)}async replaceClient(e){this.latestServerConfig=e;const{hsUrl:t,isUrl:n}=e;this.setState({errorText:null,serverDeadError:null,serverErrorIsFatal:!1,busy:!0});try{if(await p.validateServerConfigWithStaticUrls(t,n),e!==this.latestServerConfig)return;this.setState({serverIsAlive:!0,serverErrorIsFatal:!1})}catch(t){if(e!==this.latestServerConfig)return;if(this.setState(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?RC(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):RC(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({busy:!1},p.authComponentStateForError(t,"register"))),this.state.serverErrorIsFatal)return}const i=(0,o.createClient)({baseUrl:t,idBaseUrl:n});this.loginLogic.setHomeserverUrl(t),this.loginLogic.setIdentityServerUrl(n);const r=this.oidcNativeFlowEnabled?e.delegatedAuthentication:void 0;let a,c;this.loginLogic.setDelegatedAuthentication(r);try{const t=await this.loginLogic.getFlows(!0);if(e!==this.latestServerConfig)return;a=t.find((e=>"m.login.sso"===e.type||"m.login.cas"===e.type)),c=t.find((e=>"oidcNativeFlow"===e.type))}catch(t){if(e!==this.latestServerConfig)return;s.v.error("Failed to get login flows to check for SSO support",t)}if(await new Promise((e=>{this.setState((({flows:e})=>({matrixClient:i,ssoFlow:a,oidcNativeFlow:c,flows:c?[]:e,busy:!1})),e)})),!c)try{if(!this.state.doingUIAuth){if(await this.makeRegisterRequest(null),e!==this.latestServerConfig)return;s.v.log("Expecting 401 from register request but got success!")}}catch(t){if(e!==this.latestServerConfig)return;t instanceof o.MatrixError&&401===t.httpStatus?this.setState({flows:t.data.flows}):t instanceof o.MatrixError&&(403===t.httpStatus||"M_FORBIDDEN"===t.errcode)?a?S.A.dispatch({action:"start_login"}):this.setState({serverErrorIsFatal:!0,errorText:(0,l._t)("auth|registration_disabled"),flows:[]}):(s.v.log("Unable to query for supported registration methods.",t),this.setState({errorText:(0,l._t)("auth|failed_query_registration_methods"),flows:[]}))}}setupPushers(){if(!this.props.brand)return Promise.resolve();const e=_.J.safeGet();return e.getPushers().then((t=>{const n=t.pushers;for(let t=0;t<n.length;++t)if("email"===n[t].kind){const i=n[t];i.data={brand:this.props.brand},e.setPusher(i).then((()=>{s.v.log("Set email branding to "+this.props.brand)}),(e=>{s.v.error("Couldn't set email branding: "+e)}))}}),(e=>{s.v.error("Couldn't get pushers: "+e)}))}getUIAuthInputs(){return{emailAddress:this.state.formVals.email,phoneCountry:this.state.formVals.phoneCountry,phoneNumber:this.state.formVals.phoneNumber}}renderRegisterComponent(){if(this.state.matrixClient&&this.state.doingUIAuth)return i.createElement(Uy.A,{matrixClient:this.state.matrixClient,makeRequest:this.makeRegisterRequest,onAuthFinished:this.onUIAuthFinished,inputs:this.getUIAuthInputs(),requestEmailToken:this.requestEmailToken,sessionId:this.props.sessionId,clientSecret:this.props.clientSecret,emailSid:this.props.idSid,poll:!0});if(!this.state.matrixClient&&!this.state.busy)return null;if(this.state.busy||!this.state.flows)return i.createElement("div",{className:"mx_AuthBody_spinner"},i.createElement(se.A,null));if(this.state.matrixClient&&this.state.oidcNativeFlow)return i.createElement(ie.A,{className:"mx_Login_fullWidthButton",kind:"primary",onClick:async()=>{await fo(this.props.serverConfig.delegatedAuthentication,this.state.oidcNativeFlow.clientId,this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl,!0)}},(0,l._t)("action|continue"));if(this.state.matrixClient&&this.state.flows.length){let e;if(!this.props.mobileRegister&&this.state.ssoFlow){let t;(this.state.ssoFlow.identity_providers||[]).length>1&&(t=i.createElement("h2",{className:"mx_AuthBody_centered"},(0,l._t)("auth|continue_with_sso",{ssoButtons:""}).trim())),e=i.createElement(i.Fragment,null,t,i.createElement(bC,{matrixClient:this.loginLogic.createTemporaryClient(),flow:this.state.ssoFlow,loginType:"m.login.sso"===this.state.ssoFlow.type?"sso":"cas",fragmentAfterLogin:this.props.fragmentAfterLogin,action:o.SSOAction.REGISTER}),i.createElement("h2",{className:"mx_AuthBody_centered"},(0,l._t)("auth|sso_or_username_password",{ssoButtons:"",usernamePassword:""}).trim()))}return i.createElement(i.Fragment,null,e,i.createElement(sb,{defaultUsername:this.state.formVals.username,defaultEmail:this.state.formVals.email,defaultPhoneCountry:this.state.formVals.phoneCountry,defaultPhoneNumber:this.state.formVals.phoneNumber,defaultPassword:this.state.formVals.password,onRegisterClick:this.onFormSubmit,flows:this.state.flows,serverConfig:this.props.serverConfig,canSubmit:!this.state.serverErrorIsFatal,matrixClient:this.state.matrixClient,mobileRegister:this.props.mobileRegister}))}return null}render(){let e;const t=this.state.errorText;let n;if(t&&(e=i.createElement("div",{className:"mx_Login_error"},t)),!this.state.serverIsAlive){const e=dt()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});n=i.createElement("div",{className:e},this.state.serverDeadError)}const s=i.createElement("span",{className:"mx_AuthBody_changeFlow"},(0,l._t)("auth|sign_in_instead_prompt",{},{a:e=>i.createElement(ie.A,{kind:"link_inline",onClick:this.onLoginClick},e)}));let o,r;if(this.state.doingUIAuth&&(o=i.createElement(ie.A,{kind:"link",className:"mx_AuthBody_changeFlow",onClick:this.onGoToFormClicked},(0,l._t)("action|go_back"))),this.state.completedNoSignin){let e;e=this.props.mobileRegister?void 0:this.state.differentLoggedInUserId?i.createElement("div",null,i.createElement("p",null,(0,l._t)("auth|account_clash",{newAccountId:this.state.registeredUsername,loggedInUserId:this.state.differentLoggedInUserId})),i.createElement("p",null,i.createElement(ie.A,{kind:"link_inline",onClick:async e=>{await this.onLoginClickWithCheck(e)&&S.A.dispatch({action:"view_welcome_page"})}},(0,l._t)("auth|account_clash_previous_account")))):i.createElement("h2",null,(0,l._t)("auth|log_in_new_account",{},{a:e=>i.createElement(ie.A,{kind:"link_inline",onClick:async e=>{await this.onLoginClickWithCheck(e)&&S.A.dispatch({action:"view_home_page"})}},e)})),r=i.createElement("div",null,i.createElement("h1",null,(0,l._t)("auth|registration_successful")),e)}else r=this.props.mobileRegister?i.createElement(i.Fragment,null,i.createElement("h1",null,(0,l._t)("auth|mobile_create_account_title",{hsName:this.props.serverConfig.hsName})),e,n,this.renderRegisterComponent()):i.createElement(i.Fragment,null,i.createElement("div",{className:"mx_Register_mainContent"},i.createElement(xC,{title:(0,l._t)("auth|create_account_title"),serverPicker:i.createElement(AC,{title:(0,l._t)("auth|server_picker_title_registration"),dialogTitle:(0,l._t)("auth|server_picker_dialog_title"),serverConfig:this.props.serverConfig,onServerConfigChange:this.state.doingUIAuth?void 0:this.props.onServerConfigChange})},e,n),this.renderRegisterComponent()),i.createElement("div",{className:"mx_Register_footerActions"},o,s));return this.props.mobileRegister?i.createElement("div",{className:"mx_MobileRegister_body"},r):i.createElement(QA,null,i.createElement(oC,null),i.createElement(kC.T,null,i.createElement(rC,{flex:!0},r)))}}let PC,NC,DC,MC;const OC=/^[0-9()\-\s]*$/;var LC=function(e){return e.Email="login_field_email",e.MatrixId="login_field_mxid",e.Phone="login_field_phone",e.Password="login_field_password",e}(LC||{});PC=LC.Email,NC=LC.Phone,DC=LC.MatrixId,MC=LC.Password;class UC extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,PC,null),(0,v.A)(this,NC,null),(0,v.A)(this,DC,null),(0,v.A)(this,MC,null),(0,v.A)(this,"onForgotPasswordClick",(e=>{var t,n;e.preventDefault(),e.stopPropagation(),null===(t=(n=this.props).onForgotPasswordClick)||void 0===t||t.call(n)})),(0,v.A)(this,"onSubmitForm",(async e=>{e.preventDefault();if(await this.verifyFieldsBeforeSubmit())switch(this.state.loginType){case LC.Email:case LC.MatrixId:this.props.onSubmit(this.props.username,void 0,void 0,this.state.password);break;case LC.Phone:this.props.onSubmit(void 0,this.props.phoneCountry,this.props.phoneNumber,this.state.password)}})),(0,v.A)(this,"onUsernameChanged",(e=>{var t,n;null===(t=(n=this.props).onUsernameChanged)||void 0===t||t.call(n,e.target.value)})),(0,v.A)(this,"onUsernameBlur",(e=>{var t,n;null===(t=(n=this.props).onUsernameBlur)||void 0===t||t.call(n,e.target.value)})),(0,v.A)(this,"onLoginTypeChange",(e=>{var t,n;const i=e.target.value;this.setState({loginType:i}),null===(t=(n=this.props).onUsernameChanged)||void 0===t||t.call(n,"")})),(0,v.A)(this,"onPhoneCountryChanged",(e=>{var t,n;null===(t=(n=this.props).onPhoneCountryChanged)||void 0===t||t.call(n,e.iso2)})),(0,v.A)(this,"onPhoneNumberChanged",(e=>{var t,n;null===(t=(n=this.props).onPhoneNumberChanged)||void 0===t||t.call(n,e.target.value)})),(0,v.A)(this,"onPasswordChanged",(e=>{this.setState({password:e.target.value})})),(0,v.A)(this,"validateUsernameRules",(0,xm.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,l._t)("auth|username_field_required_invalid")}]})),(0,v.A)(this,"onUsernameValidate",(async e=>{const t=await this.validateUsernameRules(e);return this.markFieldValid(LC.MatrixId,t.valid),t})),(0,v.A)(this,"onEmailValidate",(e=>{this.markFieldValid(LC.Email,e.valid)})),(0,v.A)(this,"validatePhoneNumberRules",(0,xm.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,l._t)("auth|msisdn_field_required_invalid")},{key:"number",test:({value:e})=>!e||OC.test(e),invalid:()=>(0,l._t)("auth|msisdn_field_number_invalid")}]})),(0,v.A)(this,"onPhoneNumberValidate",(async e=>{const t=await this.validatePhoneNumberRules(e);return this.markFieldValid(LC.Password,t.valid),t})),(0,v.A)(this,"validatePasswordRules",(0,xm.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,l._t)("auth|password_field_label")}]})),(0,v.A)(this,"onPasswordValidate",(async e=>{const t=await this.validatePasswordRules(e);return this.markFieldValid(LC.Password,t.valid),t})),this.state={fieldValid:{},loginType:LC.MatrixId,password:""}}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[this.state.loginType,LC.Password];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise((e=>this.setState({},e))),this.allFieldsValid())return!0;const n=this.findFirstInvalidField(t);return!n||(n.focus(),n.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){return Object.values(this.state.fieldValid).every(Boolean)}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}markFieldValid(e,t){const{fieldValid:n}=this.state;n[e]=t,this.setState({fieldValid:n})}renderLoginField(e,t){const n={error:!1};switch(e){case LC.Email:return n.error=this.props.loginIncorrect&&!this.props.username,i.createElement(Jy,{id:"mx_LoginForm_email",className:dt()(n),name:"username",autoComplete:"email",type:"email",key:"email_input",placeholder:"joe@example.com",value:this.props.username,onChange:this.onUsernameChanged,onBlur:this.onUsernameBlur,disabled:this.props.busy,autoFocus:t,onValidate:this.onEmailValidate,fieldRef:e=>{this[LC.Email]=e}});case LC.MatrixId:return n.error=this.props.loginIncorrect&&!this.props.username,i.createElement(ks.A,{id:"mx_LoginForm_username",className:dt()(n),name:"username",autoComplete:"username",key:"username_input",type:"text",label:(0,l._t)("common|username"),placeholder:(0,l._t)("common|username"),value:this.props.username,onChange:this.onUsernameChanged,onBlur:this.onUsernameBlur,disabled:this.props.busy,autoFocus:t,onValidate:this.onUsernameValidate,ref:e=>{this[LC.MatrixId]=e}});case LC.Phone:{n.error=this.props.loginIncorrect&&!this.props.phoneNumber;const e=i.createElement(qy,{value:this.props.phoneCountry,isSmall:!0,showPrefix:!0,onOptionChange:this.onPhoneCountryChanged});return i.createElement(ks.A,{id:"mx_LoginForm_phone",className:dt()(n),name:"phoneNumber",autoComplete:"tel-national",key:"phone_input",type:"text",label:(0,l._t)("auth|msisdn_field_label"),value:this.props.phoneNumber,prefixComponent:e,onChange:this.onPhoneNumberChanged,disabled:this.props.busy,autoFocus:t,onValidate:this.onPhoneNumberValidate,ref:e=>{this[LC.Password]=e}})}}}isLoginEmpty(){switch(this.state.loginType){case LC.Email:case LC.MatrixId:return!this.props.username;case LC.Phone:return!this.props.phoneCountry||!this.props.phoneNumber}}render(){let e;this.props.onForgotPasswordClick&&(e=i.createElement(ie.A,{className:"mx_Login_forgot",disabled:this.props.busy,kind:"link",onClick:this.onForgotPasswordClick},(0,l._t)("auth|reset_password_button")));const t=dt()({error:this.props.loginIncorrect&&!this.isLoginEmpty()}),n=!this.isLoginEmpty(),s=this.renderLoginField(this.state.loginType,!n);let o;return c.Ay.get().disable_3pid_login||(o=i.createElement("div",{className:"mx_Login_type_container"},i.createElement("label",{className:"mx_Login_type_label"},(0,l._t)("auth|identifier_label")),i.createElement(ks.A,{element:"select",value:this.state.loginType,onChange:this.onLoginTypeChange,disabled:this.props.busy},i.createElement("option",{key:LC.MatrixId,value:LC.MatrixId},(0,l._t)("common|username")),i.createElement("option",{key:LC.Email,value:LC.Email},(0,l._t)("common|email_address")),i.createElement("option",{key:LC.Password,value:LC.Password},(0,l._t)("auth|msisdn_field_label"))))),i.createElement("div",null,i.createElement("form",{onSubmit:this.onSubmitForm},o,s,i.createElement(ks.A,{id:"mx_LoginForm_password",className:t,autoComplete:"current-password",type:"password",name:"password",label:(0,l._t)("common|password"),value:this.state.password,onChange:this.onPasswordChanged,disabled:this.props.busy,autoFocus:n,onValidate:this.onPasswordValidate,ref:e=>this[LC.Password]=e}),e,!this.props.busy&&i.createElement("input",{className:"mx_Login_submit",type:"submit",value:(0,l._t)("action|sign_in"),disabled:this.props.disableSubmit})))}}function FC(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function VC(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?FC(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):FC(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}(0,v.A)(UC,"defaultProps",{onUsernameChanged:function(){},onUsernameBlur:function(){},onPhoneCountryChanged:function(){},onPhoneNumberChanged:function(){},loginIncorrect:!1,disableSubmit:!1});class BC extends i.PureComponent{constructor(e){super(e),(0,v.A)(this,"unmounted",!1),(0,v.A)(this,"oidcNativeFlowEnabled",!1),(0,v.A)(this,"loginLogic",void 0),(0,v.A)(this,"stepRendererMap",void 0),(0,v.A)(this,"isBusy",(()=>!!this.state.busy||!!this.props.busy)),(0,v.A)(this,"onPasswordLogin",(async(e,t,n,i)=>{if(!this.state.serverIsAlive){this.setState({busy:!0});let e=!0;try{await p.validateServerConfigWithStaticUrls(this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl),this.setState({serverIsAlive:!0,errorText:""})}catch(t){const n=p.authComponentStateForError(t);this.setState(VC({busy:!1,busyLoggingIn:!1},n)),e=!n.serverErrorIsFatal}if(!e)return}this.setState({busy:!0,busyLoggingIn:!0,errorText:null,loginIncorrect:!1}),this.loginLogic.loginViaPassword(e,t,n,i).then((e=>{this.setState({serverIsAlive:!0}),this.props.onLoggedIn(e,i)}),(t=>{if(this.unmounted)return;let n;n=400===t.httpStatus&&e&&e.indexOf("@")>0?(0,l._t)("auth|unsupported_auth_email"):(0,ho.Y0)(t,this.props.serverConfig),this.setState({busy:!1,busyLoggingIn:!1,errorText:n,loginIncorrect:401===t.httpStatus||403===t.httpStatus})}))})),(0,v.A)(this,"onUsernameChanged",(e=>{this.setState({username:e})})),(0,v.A)(this,"onUsernameBlur",(async e=>{const t="@"===e[0];if(this.setState({username:e,busy:t,errorText:null,canTryLogin:!0}),t){const t=e.split(":").slice(1).join(":");try{const e=await p.validateServerName(t);this.props.onServerConfigChange(e),this.setState({busy:!1})}catch(e){s.v.error("Problem parsing URL or unhandled error doing .well-known discovery:",e);let t=(0,l._t)("auth|failed_homeserver_discovery");e instanceof l.P7&&e.translatedMessage&&(t=e.translatedMessage);let n=t,i={};p.isLivelinessError(e)&&(n=this.state.errorText,i=p.authComponentStateForError(e)),this.setState(VC({busy:!1,errorText:n},i))}}})),(0,v.A)(this,"onPhoneCountryChanged",(e=>{this.setState({phoneCountry:e})})),(0,v.A)(this,"onPhoneNumberChanged",(e=>{this.setState({phoneNumber:e})})),(0,v.A)(this,"onRegisterClick",(e=>{e.preventDefault(),e.stopPropagation(),this.props.onRegisterClick()})),(0,v.A)(this,"onTryRegisterClick",(e=>{var t,n;const i=null===(t=this.state.flows)||void 0===t?void 0:t.find((e=>"m.login.password"===e.type)),s=null===(n=this.state.flows)||void 0===n?void 0:n.find((e=>"m.login.sso"===e.type||"m.login.cas"===e.type));if(s&&!i){var r;e.preventDefault(),e.stopPropagation();const t="m.login.sso"===s.type?"sso":"cas";null===(r=a.A.get())||void 0===r||r.startSingleSignOn(this.loginLogic.createTemporaryClient(),t,this.props.fragmentAfterLogin,void 0,o.SSOAction.REGISTER)}else this.onRegisterClick(e)})),(0,v.A)(this,"isSupportedFlow",(e=>!!this.stepRendererMap[e.type]||(s.v.log("Skipping flow",e,"due to unsupported login type",e.type),!1))),(0,v.A)(this,"renderPasswordStep",(()=>i.createElement(UC,{onSubmit:this.onPasswordLogin,username:this.state.username,phoneCountry:this.state.phoneCountry,phoneNumber:this.state.phoneNumber,onUsernameChanged:this.onUsernameChanged,onUsernameBlur:this.onUsernameBlur,onPhoneCountryChanged:this.onPhoneCountryChanged,onPhoneNumberChanged:this.onPhoneNumberChanged,onForgotPasswordClick:this.props.onForgotPasswordClick,loginIncorrect:this.state.loginIncorrect,serverConfig:this.props.serverConfig,disableSubmit:this.isBusy(),busy:this.props.isSyncing||this.state.busyLoggingIn}))),(0,v.A)(this,"renderOidcNativeStep",(()=>{const e=this.state.flows.find((e=>"oidcNativeFlow"===e.type));return i.createElement(ie.A,{className:"mx_Login_fullWidthButton",kind:"primary",onClick:async()=>{await fo(this.props.serverConfig.delegatedAuthentication,e.clientId,this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl)}},(0,l._t)("action|continue"))})),(0,v.A)(this,"renderSsoStep",(e=>{var t,n;const s=null===(t=this.state.flows)||void 0===t?void 0:t.find((t=>t.type==="m.login."+e));return i.createElement(bC,{matrixClient:this.loginLogic.createTemporaryClient(),flow:s,loginType:e,fragmentAfterLogin:this.props.fragmentAfterLogin,primary:!(null!==(n=this.state.flows)&&void 0!==n&&n.find((e=>"m.login.password"===e.type))),action:o.SSOAction.LOGIN,disabled:this.isBusy()})})),this.oidcNativeFlowEnabled=M.A.getValue(Sl.O5.OidcNativeFlow),this.state={busy:!1,errorText:null,loginIncorrect:!1,canTryLogin:!0,username:e.defaultUsername?e.defaultUsername:"",phoneCountry:"",phoneNumber:"",serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""},this.stepRendererMap={"m.login.password":this.renderPasswordStep,"m.login.cas":()=>this.renderSsoStep("cas"),"m.login.sso":()=>this.renderSsoStep("sso"),oidcNativeFlow:()=>this.renderOidcNativeStep()}}componentDidMount(){this.unmounted=!1,this.initLoginLogic(this.props.serverConfig)}componentWillUnmount(){this.unmounted=!0}componentDidUpdate(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl&&e.serverConfig.delegatedAuthentication===this.props.serverConfig.delegatedAuthentication||this.initLoginLogic(this.props.serverConfig)}async checkServerLiveliness({hsUrl:e,isUrl:t}){try{const{warning:n}=await p.validateServerConfigWithStaticUrls(e,t);n?this.setState(VC(VC({},p.authComponentStateForError(n)),{},{errorText:""})):this.setState({serverIsAlive:!0,errorText:""})}catch(e){this.setState(VC({busy:!1},p.authComponentStateForError(e)))}}async initLoginLogic({hsUrl:e,isUrl:t}){let n=!1;this.props.serverConfig.isDefault&&e===this.props.serverConfig.hsUrl&&t===this.props.serverConfig.isUrl&&(n=!0);const i=n?this.props.fallbackHsUrl:null;this.setState({busy:!0,loginIncorrect:!1}),await this.checkServerLiveliness({hsUrl:e,isUrl:t});const s=new I(e,t,i,{defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,delegatedAuthentication:this.oidcNativeFlowEnabled?this.props.serverConfig.delegatedAuthentication:void 0});this.loginLogic=s,s.getFlows().then((e=>{const t=e.filter(this.isSupportedFlow);this.setState({flows:t}),0===t.length&&this.setState({errorText:(0,l._t)("auth|unsupported_auth")})}),(e=>{this.setState({errorText:(0,ho.Vp)(e,this.props.serverConfig),loginIncorrect:!1,canTryLogin:!1})})).finally((()=>{this.setState({busy:!1})}))}renderLoginComponentForFlows(){if(!this.state.flows)return null;const e=(0,Z.Bo)(["oidcNativeFlow","m.login.password","m.login.sso"].map((e=>{var t;return null===(t=this.state.flows)||void 0===t?void 0:t.find((t=>t.type===e))})));return i.createElement(i.Fragment,null,e.map((e=>{const t=this.stepRendererMap[e.type];return i.createElement(i.Fragment,{key:e.type},t())})))}render(){const e=this.isBusy()&&!this.state.busyLoggingIn?i.createElement("div",{className:"mx_Login_loader"},i.createElement(se.A,null)):null,t=this.state.errorText;let n,s,o;if(t&&(n=i.createElement("div",{className:"mx_Login_error"},t)),!this.state.serverIsAlive){const e=dt()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});s=i.createElement("div",{className:e},this.state.serverDeadError)}return this.props.isSyncing||this.state.busyLoggingIn?o=i.createElement("div",{className:"mx_AuthBody_paddedFooter"},i.createElement("div",{className:"mx_AuthBody_paddedFooter_title"},i.createElement(oa.A,{w:20,h:20}),this.props.isSyncing?(0,l._t)("auth|syncing"):(0,l._t)("auth|signing_in")),this.props.isSyncing&&i.createElement("div",{className:"mx_AuthBody_paddedFooter_subtitle"},(0,l._t)("auth|sync_footer_subtitle"))):M.A.getValue(He.f.Registration)&&(o=i.createElement("span",{className:"mx_AuthBody_changeFlow"},(0,l._t)("auth|create_account_prompt",{},{a:e=>i.createElement(ie.A,{kind:"link_inline",onClick:this.onTryRegisterClick},e)}))),i.createElement(QA,null,i.createElement(oC,{disableLanguageSelector:this.props.isSyncing||this.state.busyLoggingIn}),i.createElement(rC,null,i.createElement("h1",null,(0,l._t)("action|sign_in"),e),n,s,i.createElement(AC,{serverConfig:this.props.serverConfig,onServerConfigChange:this.props.onServerConfigChange,disabled:this.isBusy()}),this.renderLoginComponentForFlows(),o))}}var jC=n("./src/utils/KeyVerificationStateObserver.ts");class WC extends i.PureComponent{constructor(e){var t;super(e),(0,v.A)(this,"intervalHandle",void 0),(0,v.A)(this,"checkRequestIsPending",(()=>{const{request:e}=this.props;(0,V.canAcceptVerificationRequest)(e)||L.A.sharedInstance().dismissToast(this.props.toastKey)})),(0,v.A)(this,"cancel",(()=>{L.A.sharedInstance().dismissToast(this.props.toastKey);try{this.props.request.cancel()}catch(e){s.v.error("Error while cancelling verification request",e)}})),(0,v.A)(this,"accept",(async()=>{L.A.sharedInstance().dismissToast(this.props.toastKey);const{request:e}=this.props,t=_.J.safeGet();try{if(e.roomId){var n;S.A.dispatch({action:W.r.ViewRoom,room_id:e.roomId,should_peek:!1,metricsTrigger:"VerificationRequest"});const i=null!==(n=t.getUser(e.otherUserId))&&void 0!==n?n:void 0;_l.A.instance.setCards([{phase:fl.n.RoomSummary},{phase:fl.n.RoomMemberInfo,state:{member:i}},{phase:fl.n.EncryptionPanel,state:{verificationRequest:e,member:i}}],void 0,e.roomId)}else k.Ay.createDialog($,{verificationRequest:e,onFinished:()=>{e.cancel()}},void 0,!1,!0);await e.accept()}catch(e){s.v.error("Failed to accept verification request",e)}})),this.state={counter:Math.ceil((null!==(t=e.request.timeout)&&void 0!==t?t:0)/1e3)}}async componentDidMount(){const{request:e}=this.props;e.timeout&&e.timeout>0&&(this.intervalHandle=window.setInterval((()=>{let{counter:e}=this.state;e=Math.max(0,e-1),this.setState({counter:e})}),1e3)),e.on(V.VerificationRequestEvent.Change,this.checkRequestIsPending),this.checkRequestIsPending();const t=e.otherDeviceId;if(e.isSelfVerification&&t){const e=_.J.safeGet(),n=await e.getDevice(t);this.setState({ip:n.last_seen_ip,device:await(0,Ke.G)(e,e.getSafeUserId(),t)})}}componentWillUnmount(){clearInterval(this.intervalHandle);const{request:e}=this.props;e.off(V.VerificationRequestEvent.Change,this.checkRequestIsPending)}render(){const{request:e}=this.props;let t,n;if(e.isSelfVerification)this.state.device&&(t=this.state.device.displayName,n=(0,l._t)("encryption|verification|request_toast_detail",{deviceId:this.state.device.deviceId,ip:this.state.ip}));else{const n=_.J.safeGet(),i=e.otherUserId,s=e.roomId;if(t=s?(0,jC.M)(n,i,s):i,t===i){const e=n.getUser(i);e&&e.displayName&&(t=(0,l._t)("name_and_id",{name:e.displayName,userId:i}))}}const s=0===this.state.counter?(0,l._t)("action|ignore"):(0,l._t)("encryption|verification|request_toast_decline_counter",{counter:this.state.counter});return i.createElement(j.A,{description:t,detail:n,primaryLabel:e.isSelfVerification||!e.roomId?(0,l._t)("encryption|verification|request_toast_accept"):(0,l._t)("encryption|verification|request_toast_accept_user"),onPrimaryClick:this.accept,secondaryLabel:s,onSecondaryClick:this.cancel})}}let zC=function(e){return e.PAGE_CHANGE="mx_PageChange",e.LOGIN="mx_Login",e.REGISTER="mx_Register",e}({});class HC{constructor(){(0,v.A)(this,"START_PREFIX","start:"),(0,v.A)(this,"STOP_PREFIX","stop:"),(0,v.A)(this,"listeners",[]),(0,v.A)(this,"entries",[])}static get instance(){return HC._instance||(HC._instance=new HC),HC._instance}start(e,t){if(!this.supportsPerformanceApi())return;const n=this.buildKey(e,t);performance.getEntriesByName(this.START_PREFIX+n).length>0?s.v.warn(`Recording already started for: ${e}`):performance.mark(this.START_PREFIX+n)}stop(e,t){if(!this.supportsPerformanceApi())return;const n=this.buildKey(e,t);if(0===performance.getEntriesByName(this.START_PREFIX+n).length)return void s.v.warn(`No recording started for: ${e}`);performance.mark(this.STOP_PREFIX+n),performance.measure(n,this.START_PREFIX+n,this.STOP_PREFIX+n),this.clear(e,t);const i=performance.getEntriesByName(n).pop();return this.entries.push(i),this.listeners.forEach((e=>{this.shouldEmit(e,i)&&e.callback([i])})),i}clear(e,t){if(!this.supportsPerformanceApi())return;const n=this.buildKey(e,t);performance.clearMarks(this.START_PREFIX+n),performance.clearMarks(this.STOP_PREFIX+n)}getEntries({name:e,type:t}={}){return this.entries.filter((n=>{const i=!e||n.name===e,s=!t||n.entryType===t;return i&&s}))}addPerformanceDataCallback(e,t=!1){if(this.listeners.push(e),t){const t=this.entries.filter((t=>this.shouldEmit(e,t)));t.length>0&&e.callback(t)}}removePerformanceDataCallback(e){e?this.listeners.splice(this.listeners.findIndex((t=>t.callback===e)),1):this.listeners=[]}supportsPerformanceApi(){return void 0!==performance&&void 0!==performance.mark}shouldEmit(e,t){return!e.entryNames||e.entryNames.includes(t.name)}buildKey(e,t){return`${e}${t?`:${t}`:""}`}}(0,v.A)(HC,"_instance",void 0),window.mxPerformanceMonitor=HC.instance,window.mxPerformanceEntryNames=zC;class KC extends i.Component{constructor(...e){super(...e),(0,v.A)(this,"onConfirm",(()=>{this.props.onFinished(!0)})),(0,v.A)(this,"onDecline",(()=>{this.props.onFinished(!1)}))}render(){return i.createElement(J.A,{className:"mx_ConfirmWipeDeviceDialog",hasCancel:!0,onFinished:this.props.onFinished,title:(0,l._t)("auth|soft_logout|clear_data_title")},i.createElement("div",{className:"mx_ConfirmWipeDeviceDialog_content"},i.createElement("p",null,(0,l._t)("auth|soft_logout|clear_data_description"))),i.createElement(ot.A,{primaryButton:(0,l._t)("auth|soft_logout|clear_data_button"),onPrimaryButtonClick:this.onConfirm,primaryButtonClass:"danger",cancelButton:(0,l._t)("action|cancel"),onCancel:this.onDecline}))}}var JC=function(e){return e[e.Loading=0]="Loading",e[e.Password=1]="Password",e[e.CAS=2]="CAS",e[e.SSO=3]="SSO",e[e.PasswordWithSocialSignOn=4]="PasswordWithSocialSignOn",e[e.Unsupported=5]="Unsupported",e}(JC||{});const GC={"m.login.password":JC.Password,"m.login.cas":JC.CAS,"m.login.sso":JC.SSO};class $C extends i.Component{constructor(e,t){super(e,t),(0,v.A)(this,"onClearAll",(()=>{k.Ay.createDialog(KC,{onFinished:e=>{e&&(s.v.log("Clearing data from soft-logged-out session"),sr(this.context.oidcClientStore))}})})),(0,v.A)(this,"onPasswordChange",(e=>{this.setState({password:e.target.value})})),(0,v.A)(this,"onForgotPassword",(()=>{S.A.dispatch({action:"start_password_recovery"})})),(0,v.A)(this,"onPasswordLogin",(async e=>{var t;e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});const n=_.J.safeGet(),i=n.getHomeserverUrl(),r=n.getIdentityServerUrl(),a={identifier:{type:"m.id.user",user:n.getUserId()},password:this.state.password,device_id:null!==(t=n.getDeviceId())&&void 0!==t?t:void 0};let c;try{c=await P(i,r,"m.login.password",a)}catch(e){let t=(0,l._t)("auth|failed_soft_logout_homeserver");return e instanceof o.MatrixError&&"M_FORBIDDEN"===e.errcode&&(401===e.httpStatus||403===e.httpStatus)&&(t=(0,l._t)("auth|incorrect_password")),void this.setState({busy:!1,errorText:t})}Zo(c).catch((e=>{s.v.error(e),this.setState({busy:!1,errorText:(0,l._t)("auth|failed_soft_logout_auth")})}))})),this.state={loginView:JC.Loading,busy:!1,password:"",errorText:"",flows:[]}}componentDidMount(){rr()?this.initLogin():S.A.dispatch({action:"start_login"})}async initLogin(){const e=this.props.realQueryParams;if(null==e?void 0:e.loginToken){this.setState({loginView:JC.Loading});if(await this.trySsoLogin())return}const t=_.J.safeGet(),n=(await t.loginFlows()).flows,i=n.map((e=>GC[e.type])),s=i.includes(JC.Password)&&i.includes(JC.SSO),o=i.filter((e=>!!e))[0]||JC.Unsupported,r=s?JC.PasswordWithSocialSignOn:o;this.setState({flows:n,loginView:r})}async trySsoLogin(){var e;this.setState({busy:!0});const t=localStorage.getItem($e.FL);if(!t)return s.v.error("Homeserver URL unknown for SSO login callback"),this.setState({busy:!1,loginView:JC.Unsupported}),!1;const n=localStorage.getItem($e.U7)||_.J.safeGet().getIdentityServerUrl(),i={token:this.props.realQueryParams.loginToken,device_id:null!==(e=_.J.safeGet().getDeviceId())&&void 0!==e?e:void 0};let o;try{o=await P(t,n,"m.login.token",i)}catch(e){return s.v.error(e),this.setState({busy:!1,loginView:JC.Unsupported}),!1}return Zo(o).then((()=>(this.props.onTokenLoginCompleted&&this.props.onTokenLoginCompleted(),!0))).catch((e=>(s.v.error(e),this.setState({busy:!1,loginView:JC.Unsupported}),!1)))}renderPasswordForm(e){let t;return this.state.errorText&&(t=i.createElement("span",{className:"mx_Login_error"},this.state.errorText)),i.createElement("form",{onSubmit:this.onPasswordLogin},e?i.createElement("p",null,e):null,t,i.createElement(ks.A,{type:"password",label:(0,l._t)("common|password"),onChange:this.onPasswordChange,value:this.state.password,disabled:this.state.busy}),i.createElement(ie.A,{onClick:this.onPasswordLogin,kind:"primary",type:"submit",disabled:this.state.busy},(0,l._t)("action|sign_in")),i.createElement(ie.A,{onClick:this.onForgotPassword,kind:"link"},(0,l._t)("auth|forgot_password_prompt")))}renderSsoForm(e){const t=this.state.loginView===JC.CAS?"cas":"sso",n=this.state.flows.find((e=>e.type==="m.login."+t));return i.createElement("div",null,e?i.createElement("p",null,e):null,i.createElement(bC,{matrixClient:_.J.safeGet(),flow:n,loginType:t,fragmentAfterLogin:this.props.fragmentAfterLogin,primary:!this.state.flows.find((e=>"m.login.password"===e.type)),action:o.SSOAction.LOGIN}))}renderSignInSection(){return this.state.loginView===JC.Loading?i.createElement(se.A,null):this.state.loginView===JC.Password?this.renderPasswordForm((0,l._t)("auth|soft_logout_intro_password")):this.state.loginView===JC.SSO||this.state.loginView===JC.CAS?this.renderSsoForm((0,l._t)("auth|soft_logout_intro_sso")):this.state.loginView===JC.PasswordWithSocialSignOn?i.createElement(i.Fragment,null,i.createElement("p",null,(0,l._t)("auth|soft_logout_intro_sso")),this.renderSsoForm(null),i.createElement("h2",{className:"mx_AuthBody_centered"},(0,l._t)("auth|sso_or_username_password",{ssoButtons:"",usernamePassword:""}).trim()),this.renderPasswordForm(null)):i.createElement("p",null,(0,l._t)("auth|soft_logout_intro_unsupported_auth"))}render(){return i.createElement(QA,null,i.createElement(oC,null),i.createElement(rC,null,i.createElement("h1",null,(0,l._t)("auth|soft_logout_heading")),i.createElement("h2",null,(0,l._t)("action|sign_in")),i.createElement("div",null,this.renderSignInSection()),i.createElement("h2",null,(0,l._t)("auth|soft_logout_subheading")),i.createElement("p",null,(0,l._t)("auth|soft_logout_warning")),i.createElement("div",null,i.createElement(ie.A,{onClick:this.onClearAll,kind:"danger"},(0,l._t)("auth|soft_logout|clear_data_button")))))}}(0,v.A)($C,"contextType",X.A);const qC=["children","className"];function YC(e){let{children:t,className:n}=e,s=(0,g.A)(e,qC);const o=dt()(n,"mx_SplashPage");return i.createElement("main",(0,_t.A)({},s,{className:o}),t)}function QC({useCase:e,onClick:t,selected:n}){let s;switch(e){case cd.PersonalMessaging:s=(0,l._t)("onboarding|use_case_personal_messaging");break;case cd.WorkMessaging:s=(0,l._t)("onboarding|use_case_work_messaging");break;case cd.CommunityMessaging:s=(0,l._t)("onboarding|use_case_community_messaging")}return i.createElement(ie.A,{className:dt()("mx_UseCaseSelectionButton",{mx_UseCaseSelectionButton_selected:n}),onClick:async()=>t(e)},i.createElement("div",{className:dt()("mx_UseCaseSelectionButton_icon",{mx_UseCaseSelectionButton_messaging:e===cd.PersonalMessaging,mx_UseCaseSelectionButton_work:e===cd.WorkMessaging,mx_UseCaseSelectionButton_community:e===cd.CommunityMessaging})}),i.createElement("span",null,s),i.createElement("div",{className:"mx_UseCaseSelectionButton_selectedIcon"}))}function XC({onFinished:e}){const[t,n]=(0,i.useState)(null);return(0,i.useEffect)((()=>{if(t){let n=window.setTimeout((()=>{n=null,e(t)}),1500);return()=>{null!==n&&clearTimeout(n),n=null}}}),[t,e]),i.createElement(YC,{className:dt()("mx_UseCaseSelection",{mx_UseCaseSelection_selected:null!==t})},i.createElement("div",{className:"mx_UseCaseSelection_title mx_UseCaseSelection_slideIn"},i.createElement("h1",null,(0,l._t)("onboarding|use_case_heading1"))),i.createElement("div",{className:"mx_UseCaseSelection_info mx_UseCaseSelection_slideInDelayed"},i.createElement("h2",null,(0,l._t)("onboarding|use_case_heading2")),i.createElement("h3",null,(0,l._t)("onboarding|use_case_heading3"))),i.createElement("div",{className:"mx_UseCaseSelection_options mx_UseCaseSelection_slideInDelayed"},i.createElement(QC,{useCase:cd.PersonalMessaging,selected:t===cd.PersonalMessaging,onClick:n}),i.createElement(QC,{useCase:cd.WorkMessaging,selected:t===cd.WorkMessaging,onClick:n}),i.createElement(QC,{useCase:cd.CommunityMessaging,selected:t===cd.CommunityMessaging,onClick:n})),i.createElement("div",{className:"mx_UseCaseSelection_skip mx_UseCaseSelection_slideInDelayed"},i.createElement(ie.A,{kind:"link",onClick:async()=>n(cd.Skip)},(0,l._t)("action|skip"))))}function ZC(e,t,n){(0,i.useEffect)((()=>{let i=null;const s=()=>{i=null,t(...n)};if(!1!==e)return i=window.setTimeout(s,100),()=>{i&&clearTimeout(i)}}),[e,t,n])}const ex=e=>{const t=(0,i.useRef)(null);return[(0,i.useCallback)((e=>{t.current=e}),[]),(0,i.useCallback)(((n,i)=>{t.current===n&&e(i)}),[e])]},tx="ALL_ROOMS",nx="mx_last_room_directory_server",ix="mx_last_room_directory_instance";let sx;const ox="nsfw",rx=e=>{var t,n;return!(null!==(t=e.name)&&void 0!==t&&t.toLocaleLowerCase().includes(ox)||null!==(n=e.topic)&&void 0!==n&&n.toLocaleLowerCase().includes(ox))},ax=()=>{const[e,t]=(0,i.useState)([]),[n,s]=(0,i.useState)(void 0),[o,r]=(0,i.useState)(null),[a,l]=(0,i.useState)(!1),[d,m]=(0,i.useState)(!1),[u,h]=(0,i.useState)(),[p,g]=ex(t),v=(0,pt.ti)("SpotlightSearch.showNsfwPublicRooms");const f=(0,i.useCallback)((async({limit:e=20,query:t,roomTypes:i})=>{const s={limit:e};(null==n?void 0:n.roomServer)!=_.J.safeGet().getDomain()&&(s.server=null==n?void 0:n.roomServer),(null==n?void 0:n.instanceId)===tx?s.include_all_networks=!0:null!=n&&n.instanceId&&(s.third_party_instance_id=n.instanceId),(t||i)&&(s.filter={generic_search_term:t,room_types:i&&await _.J.safeGet().doesServerSupportUnstableFeature("org.matrix.msc3827.stable")?Array.from(i):void 0}),p(s),m(!0),h(void 0);try{const{chunk:e}=await _.J.safeGet().publicRooms(s);return g(s,v?e:e.filter(rx)),!0}catch(e){return h(!(e instanceof Error)||e),console.error("Could not fetch public rooms for params",s,e),g(s,[]),!1}finally{m(!1)}}),[n,p,g,v]);return(0,i.useEffect)((()=>{!async function(){if(_.J.get())if(sx)r(sx);else{const e=await _.J.safeGet().getThirdpartyProtocols();sx=e,r(e)}else l(!0)}()}),[]),(0,i.useEffect)((()=>{var e,t,n;if(null===o)return;const i=_.J.safeGet().getDomain(),r=localStorage.getItem(nx),a=null!==(e=localStorage.getItem(ix))&&void 0!==e?e:void 0;let d,m=i;r&&(null!==(t=c.Ay.getObject("room_directory"))&&void 0!==t&&null!==(t=t.get("servers"))&&void 0!==t&&t.includes(r)||null!==(n=M.A.getValue("room_directory_servers"))&&void 0!==n&&n.includes(r))&&(m=r),m!==i||a!==tx&&!Object.values(o).some((e=>{e.instances.some((e=>e.instance_id===a))}))||(d=a),l(!0),s({roomServer:m,instanceId:d})}),[o]),(0,i.useEffect)((()=>{n&&(localStorage.setItem(nx,n.roomServer),n.instanceId?localStorage.setItem(ix,n.instanceId):localStorage.removeItem(ix))}),[n]),{ready:a,loading:d,publicRooms:e,protocols:o,config:n,search:f,setConfig:function(e){if(!a)throw new Error("public room configuration not initialised yet");s(e)},error:u}};var lx=n("./src/utils/SortMembers.ts"),cx=n("./src/components/views/avatars/SearchResultAvatar.tsx"),dx=n("./src/accessibility/context_menu/MenuItemRadio.tsx");function mx({label:e,description:t,onClick:n,isSelected:s,adornment:o}){return i.createElement(dx.s,{active:s,className:"mx_GenericDropdownMenu_Option mx_GenericDropdownMenu_Option--item",onClick:n},i.createElement("div",{className:"mx_GenericDropdownMenu_Option--label"},i.createElement("span",null,e),i.createElement("span",null,t)),o)}function ux({label:e,description:t,adornment:n,children:s}){return i.createElement(i.Fragment,null,i.createElement("div",{className:"mx_GenericDropdownMenu_Option mx_GenericDropdownMenu_Option--header"},i.createElement("div",{className:"mx_GenericDropdownMenu_Option--label"},i.createElement("span",null,e),i.createElement("span",null,t)),n),s)}function hx(e){return"options"in e}function px(e,t){return t?t(e):e}function gx({value:e,onChange:t,options:n,selectedLabel:s,onOpen:o,onClose:r,toKey:a,className:l,AdditionalOptions:c}){const[d,m,u,h]=(0,Gt.EF)(),p=px(e,a),g=n.flatMap((e=>hx(e)?[e,...e.options]:[e])).find((e=>px(e.key,a)===p));let v;v=n&&hx(n[0])?i.createElement(i.Fragment,null,n.map((e=>i.createElement(ux,{key:px(e.key,a),label:e.label,description:e.description,adornment:e.adornment},e.options.map((e=>i.createElement(mx,{key:px(e.key,a),label:e.label,description:e.description,onClick:n=>{t(e.key),h(),null==r||r(n)},adornment:e.adornment,isSelected:px(e.key,a)===p}))))))):i.createElement(i.Fragment,null,n.map((e=>i.createElement(mx,{key:px(e.key,a),label:e.label,description:e.description,onClick:n=>{t(e.key),h(),null==r||r(n)},adornment:e.adornment,isSelected:px(e.key,a)===p}))));const _=d&&m.current?i.createElement(Gt.Ay,(0,_t.A)({onFinished:h,chevronFace:Gt.t4.Top,wrapperClassName:dt()("mx_GenericDropdownMenu_wrapper",l)},(0,Gt.qv)(m.current.getBoundingClientRect())),v,c&&i.createElement(c,{menuDisplayed:d,openMenu:u,closeMenu:h})):null;return i.createElement(i.Fragment,null,i.createElement(Gt.VJ,{className:"mx_GenericDropdownMenu_button",ref:m,isExpanded:d,onClick:e=>{u(),null==o||o(e)}},s(g)),_)}var vx=n("./src/components/views/dialogs/TextInputDialog.tsx");function _x(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}const fx=(0,xm.A)({deriveData:async({value:e})=>{try{return await _.J.safeGet().publicRooms({limit:1,server:null!=e?e:void 0}),{}}catch(e){return{error:e}}},rules:[{key:"required",test:async({value:e})=>!!e,invalid:()=>(0,l._t)("spotlight|public_rooms|network_dropdown_required_invalid")},{key:"available",final:!0,test:async(e,{error:t})=>!t,valid:()=>(0,l._t)("spotlight|public_rooms|network_dropdown_available_valid"),invalid:({error:e})=>e instanceof o.MatrixError&&"M_FORBIDDEN"===e.errcode?(0,l._t)("spotlight|public_rooms|network_dropdown_available_invalid_forbidden"):(0,l._t)("spotlight|public_rooms|network_dropdown_available_invalid")}],memoize:!0});function Ex(e,...t){for(const n of t)e.delete(n)}function yx(){var e,t;const[n,s]=function(e,t,n=null,s=!1){const[o,r]=(0,i.useState)(M.A.getValue(e,null!=n?n:void 0,s)),a=(0,i.useCallback)((async i=>{r(i),M.A.setValue(e,n,t,i)}),[t,n,e]);return(0,i.useEffect)((()=>{const t=M.A.watchSetting(e,n,(()=>{r(M.A.getValue(e,n,s))}));return()=>{M.A.unwatchSetting(t)}}),[e,n,s]),[o,a]}("room_directory_servers",O.p.ACCOUNT),o=_.J.safeGet().getDomain(),r=new Set(null!==(e=null===(t=c.Ay.getObject("room_directory"))||void 0===t?void 0:t.get("servers"))&&void 0!==e?e:[]);Ex(r,o);const a=new Set(n);return Ex(a,o),Ex(a,...r),{allServers:[o,...Array.from(r).sort(),...Array.from(a).sort()],homeServer:o,userDefinedServers:Array.from(a).sort(),setUserDefinedServers:s}}const bx=({protocols:e,config:t,setConfig:n})=>{const{allServers:s,homeServer:o,userDefinedServers:r,setUserDefinedServers:a}=yx(),c=s.map((t=>function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?_x(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):_x(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({key:{roomServer:t,instanceId:void 0},label:t,description:t===o?(0,l._t)("spotlight|public_rooms|network_dropdown_your_server_description"):null,options:[{key:{roomServer:t,instanceId:void 0},label:(0,l._t)("common|matrix")},...t===o&&e?Object.values(e).flatMap((e=>e.instances)).map((e=>({key:{roomServer:t,instanceId:e.instance_id},label:e.desc}))):[]]},r.includes(t)?{adornment:i.createElement(ie.A,{className:"mx_NetworkDropdown_removeServer",alt:(0,l._t)("spotlight|public_rooms|network_dropdown_remove_server_adornment",{roomServer:t}),onClick:()=>a((0,Vn.without)(r,t))})}:{}))),d=(0,i.useCallback)((({closeMenu:e})=>i.createElement(i.Fragment,null,i.createElement("span",{className:"mx_GenericDropdownMenu_divider"}),i.createElement(dx.s,{active:!1,className:"mx_GenericDropdownMenu_Option mx_GenericDropdownMenu_Option--item",onClick:async()=>{e();const{finished:t}=k.Ay.createDialog(vx.A,{title:(0,l._t)("spotlight|public_rooms|network_dropdown_add_dialog_title"),description:(0,l._t)("spotlight|public_rooms|network_dropdown_add_dialog_description"),button:(0,l._t)("action|add"),hasCancel:!1,placeholder:(0,l._t)("spotlight|public_rooms|network_dropdown_add_dialog_placeholder"),validator:fx,fixedWidth:!1},"mx_NetworkDropdown_dialog"),[i,o]=await t;i&&(s.includes(o)||(a([...r,o]),n({roomServer:o})))}},i.createElement("div",{className:"mx_GenericDropdownMenu_Option--label"},i.createElement("span",{className:"mx_NetworkDropdown_addServer"},(0,l._t)("spotlight|public_rooms|network_dropdown_add_server_option")))))),[s,n,a,r]);return i.createElement(gx,{className:"mx_NetworkDropdown_wrapper",value:t,toKey:e=>e?`${e.roomServer}-${e.instanceId}`:"null",options:c,onChange:e=>n(e),selectedLabel:e=>null!=e&&e.key?(0,l._t)("spotlight|public_rooms|network_dropdown_selected_label_instance",{server:e.key.roomServer,instance:e.key.instanceId?e.label:"Matrix"}):(0,l._t)("spotlight|public_rooms|network_dropdown_selected_label"),AdditionalOptions:d})},wx=["children","endAdornment","className"],Sx=e=>{let{children:t,endAdornment:n,className:s}=e,o=(0,g.A)(e,wx);const[r,a,l]=(0,wn.A9)();return i.createElement(ie.A,(0,_t.A)({},o,{className:dt()(s,"mx_SpotlightDialog_option"),onFocus:r,ref:l,tabIndex:-1,"aria-selected":a,role:"option",element:"li"}),t,i.createElement("div",{className:"mx_SpotlightDialog_option--endAdornment"},i.createElement("kbd",{className:"mx_SpotlightDialog_enterPrompt","aria-hidden":!0},"↵"),n))};function Ax({room:e,labelId:t,descriptionId:n,detailsId:s}){var o,r,a;let c=e.name||(0,gr.iW)(null!==(o=e.canonical_alias)&&void 0!==o?o:"",null!==(r=e.aliases)&&void 0!==r?r:[])||(0,l._t)("common|unnamed_room");c.length>80&&(c=`${c.substring(0,80)}...`);let d=e.topic||"";return d.length>800&&(d=`${d.substring(0,800)}...`),i.createElement("div",{className:"mx_SpotlightDialog_result_publicRoomDetails"},i.createElement("div",{className:"mx_SpotlightDialog_result_publicRoomHeader"},i.createElement("span",{id:t,className:"mx_SpotlightDialog_result_publicRoomName"},c),i.createElement("span",{id:n,className:"mx_SpotlightDialog_result_publicRoomAlias"},null!==(a=e.canonical_alias)&&void 0!==a?a:e.room_id)),i.createElement("div",{id:s,className:"mx_SpotlightDialog_result_publicRoomDescription"},i.createElement("span",{className:"mx_SpotlightDialog_result_publicRoomMemberCount"},(0,l._t)("spotlight_dialog|count_of_members",{count:e.num_joined_members})),d&&i.createElement(i.Fragment,null," · ",i.createElement("span",{className:"mx_SpotlightDialog_result_publicRoomTopic",dangerouslySetInnerHTML:{__html:(0,zn.kz)(d)}}))))}var Cx=n("./src/hooks/useRoomNotificationState.ts"),xx=n("./src/components/views/context_menus/RoomGeneralContextMenu.tsx"),kx=n("./src/components/views/context_menus/RoomNotificationContextMenu.tsx"),Rx=n("./src/components/views/rooms/RoomTile.tsx");function Ix({room:e}){const[t]=(0,Cx.I)(e),[n,s]=(0,i.useState)(null),[o,r]=(0,i.useState)(null);let a,c;null!==n&&(a=e.isSpaceRoom()?i.createElement(sa,(0,_t.A)({},(0,Rx._E)(n),{space:e,onFinished:()=>s(null)})):i.createElement(xx.e,(0,_t.A)({},(0,Rx._E)(n),{room:e,onFinished:()=>s(null)}))),null!==o&&(c=i.createElement(kx.f,(0,_t.A)({},(0,Rx._E)(o),{room:e,onFinished:()=>r(null)})));const d=dt()("mx_SpotlightDialog_option--notifications",{mx_RoomNotificationContextMenu_iconBell:t===Dw.dC.AllMessages,mx_RoomNotificationContextMenu_iconBellDot:t===Dw.dC.AllMessagesLoud,mx_RoomNotificationContextMenu_iconBellMentions:t===Dw.dC.MentionsOnly,mx_RoomNotificationContextMenu_iconBellCrossed:t===Dw.dC.Mute});return i.createElement(i.Fragment,null,(0,ea.g)(He.C.RoomOptionsMenu)&&i.createElement(jn.o,{className:"mx_SpotlightDialog_option--menu",onClick:e=>{e.preventDefault(),e.stopPropagation();const t=e.target;s(t.getBoundingClientRect())},title:e.isSpaceRoom()?(0,l._t)("space|context_menu|options"):(0,l._t)("room|context_menu|title"),isExpanded:null!==n}),!e.isSpaceRoom()&&i.createElement(jn.o,{className:d,onClick:e=>{e.preventDefault(),e.stopPropagation();const t=e.target;r(t.getBoundingClientRect())},title:(0,l._t)("room_list|notification_options"),isExpanded:null!==o}),a,c)}const Tx=["inputRef","className","element"],Px=e=>{let{inputRef:t,className:n,element:s}=e,o=(0,g.A)(e,Tx);const[r,a,l]=(0,wn.A9)(t);return i.createElement(ie.A,(0,_t.A)({},o,{className:dt()(n,"mx_SpotlightDialog_option"),onFocus:r,ref:l,tabIndex:-1,"aria-selected":a,role:"option",element:s}))};var Nx=n("./src/components/views/dialogs/spotlight/Filter.ts");const Dx=50,Mx="24px";function Ox(e){var t;return!0===(null==e||null===(t=e.id)||void 0===t?void 0:t.startsWith("mx_SpotlightDialog_button_recentlyViewed_"))}function Lx(e){const t=new Set;return e===Nx.d.PublicRooms&&t.add(null),e===Nx.d.PublicSpaces&&t.add(o.RoomType.Space),t}var Ux=function(e){return e[e.People=0]="People",e[e.Rooms=1]="Rooms",e[e.Spaces=2]="Spaces",e[e.Suggestions=3]="Suggestions",e[e.PublicRoomsAndSpaces=4]="PublicRoomsAndSpaces",e}(Ux||{});function Fx(e){switch(e){case Nx.d.People:return(0,l._t)("common|people");case Nx.d.PublicRooms:return(0,l._t)("spotlight_dialog|public_rooms_label");case Nx.d.PublicSpaces:return(0,l._t)("spotlight_dialog|public_spaces_label")}}const Vx=e=>!(null==e||!e.room),Bx=e=>!(null==e||!e.publicRoom),jx=e=>!(null==e||!e.member),Wx=e=>{var t,n,i,s,o;return{publicRoom:e,section:Ux.PublicRoomsAndSpaces,filter:[Nx.d.PublicRooms,Nx.d.PublicSpaces],query:(0,Z.Bo)([e.room_id.toLowerCase(),null===(t=e.canonical_alias)||void 0===t?void 0:t.toLowerCase(),null===(n=e.name)||void 0===n?void 0:n.toLowerCase(),vd()(null!==(i=null===(s=e.topic)||void 0===s?void 0:s.toLowerCase())&&void 0!==i?i:"",{allowedTags:[]}),...(null===(o=e.aliases)||void 0===o?void 0:o.map((e=>e.toLowerCase())))||[]])}},zx=e=>{const t=_.J.safeGet().getUserId();if(x.A.shared().getUserIdForRoomId(e.roomId)){const n=e.getMembers().filter((e=>e.userId!==t)),i=[...n.map((e=>e.name.toLowerCase())),...n.map((e=>e.userId.toLowerCase()))].filter(Boolean);return{room:e,section:Ux.People,filter:[Nx.d.People],query:i}}return e.isSpaceRoom()?{room:e,section:Ux.Spaces,filter:[]}:{room:e,section:Ux.Rooms,filter:[]}},Hx=(e,t)=>({alreadyFiltered:t,member:e,section:Ux.Suggestions,filter:[Nx.d.People],query:[e.userId.toLowerCase(),e.name.toLowerCase()].filter(Boolean)}),Kx=new ts.V7,Jx=(e,t)=>t.hasMentions?(0,l._t)("a11y|n_unread_messages_mentions",{count:t.count}):t.hasUnreadCount?(0,l._t)("a11y|n_unread_messages",{count:t.count}):t.isUnread?(0,l._t)("a11y|unread_messages"):void 0,Gx=e=>M.A.getValue("feature_ask_to_join")&&o.JoinRule.Knock===e,$x=({initialText:e="",initialFilter:t=null,onFinished:n})=>{var s;const r=(0,i.useRef)(null),a=(0,i.useRef)(null),c=_.J.safeGet(),d=(0,i.useContext)(wn.ui),[m,u]=(0,i.useState)(e),[h,p]=(()=>{const[e,t]=(0,i.useState)((()=>{const e=_.J.safeGet(),t=M.A.getValue("SpotlightSearch.recentSearches",null);return(0,Z.Bo)(t.map((t=>e.getRoom(t))))}));return[e,()=>{M.A.setValue("SpotlightSearch.recentSearches",null,O.p.ACCOUNT,[]),t([])}]})(),[g,v]=(0,i.useState)(t),f=(0,i.useCallback)((e=>{var t,n,i;v(e),null===(t=r.current)||void 0===t||t.focus(),null===(n=a.current)||void 0===n||null===(i=n.scrollTo)||void 0===i||i.call(n,{top:0})}),[]),E=(0,i.useMemo)((()=>{const e=(0,lx.nf)(c),t=(0,lx._5)(c);return(0,lx.j2)(e,t)}),[c]),y=(0,pt.ny)("feature_dynamic_room_predecessors"),b=(0,yt.Ne)(c.getUserId()),[w,A]=(0,i.useState)(!1),C=(0,i.useMemo)((()=>m.trim()),[m]),[k,R]=(0,i.useState)(!0);(0,i.useEffect)((()=>{c.isVersionSupported("v1.4").then((e=>e||c.doesServerSupportUnstableFeature("org.matrix.msc3827.stable"))).then((e=>{R(e)}))}),[c]);const{loading:I,publicRooms:T,protocols:P,config:N,setConfig:D,search:L,error:U}=ax(),{loading:F,users:V,search:j}=(()=>{const[e,t]=(0,i.useState)([]),[n,s]=(0,i.useState)(!1),[o,r]=ex(t);return{ready:!0,loading:n,users:e,search:(0,i.useCallback)((async({limit:e=20,query:n})=>{const i={limit:e,term:n};if(o(i),null==n||!n.length)return t([]),!0;try{s(!0);const{results:e}=await _.J.safeGet().searchUserDirectory(i);return r(i,e.map((e=>new bf.qv(e)))),!0}catch(t){return console.error("Could not fetch user in user directory for params",{limit:e,term:n},t),r(i,[]),!1}finally{s(!1)}}),[o,r])}})(),{loading:z,profile:H,search:K}=(()=>{const[e,t]=(0,i.useState)(null),[n,s]=(0,i.useState)(!1),[o,r]=ex(t);return{ready:!0,loading:n,profile:e,search:(0,i.useCallback)((async({query:e})=>{if(o(e),null==e||!e.length||!e.startsWith("@")||!e.includes(":"))return t(null),!0;s(!0);try{const t=await _.J.safeGet().getProfileInfo(e);return r(e,{user_id:e,avatar_url:t.avatar_url,display_name:t.displayname}),!0}catch(t){return console.error("Could not fetch profile info for params",{term:e},t),r(e,null),!1}finally{s(!1)}}),[o,r])}})(),G=(0,i.useMemo)((()=>[{query:C,roomTypes:Lx(g),limit:Dx}]),[C,g]);ZC(g===Nx.d.PublicRooms||g===Nx.d.PublicSpaces,L,G),ZC(g===Nx.d.People,j,G),ZC(g===Nx.d.People,K,G);const $=(0,i.useMemo)((()=>{const e=((e,t)=>e.getVisibleRooms(t).filter((e=>!(0,Pi.F)(e)&&(e.getMyMembership()===ut.O.Join||e.getMyMembership()==ut.O.Invite))))(c,y),t=e.map(zx),n=[],s=t.reduce(((e,t)=>{const n=x.A.shared().getUserIdForRoomId(t.room.roomId);return n?(t.room.getJoinedMemberCount()>2||e.set(n,t),e):e}),new Map);function o(e,t){for(const i of e){if(s.has(i.userId)){const e=s.get(i.userId);t&&jx(e)&&!e.alreadyFiltered&&(e.alreadyFiltered=!0);continue}const e=Hx(i,t);s.set(i.userId,e),n.push(e)}}return o(((e,t,n=!0)=>Object.values(e.filter((e=>!n||!x.A.shared().getUserIdForRoomId(e.roomId))).reduce(((e,t)=>{for(const n of t.getJoinedMembers())e[n.userId]=n;return e}),{})).filter((e=>e.userId!==t.getUserId())))(e,c),!1),o(V,!0),H&&o([new bf.qv(H)],!0),[...us.Ay.instance.enabledMetaSpaces.map((e=>({section:Ux.Spaces,filter:[],avatar:i.createElement("div",{className:dt()("mx_SpotlightDialog_metaspaceResult",`mx_SpotlightDialog_metaspaceResult_${e}`)}),name:(0,Xr.Ff)(e,us.Ay.instance.allRoomsInHome),onClick(){us.Ay.instance.setActiveSpace(e)}}))),...t,...n,...T.map(Wx)].filter((e=>null===g||e.filter.includes(g)))}),[c,V,H,T,g,y]),q=(0,i.useMemo)((()=>{const e={[Ux.People]:[],[Ux.Rooms]:[],[Ux.Spaces]:[],[Ux.Suggestions]:[],[Ux.PublicRoomsAndSpaces]:[]};if(C){const t=C.toLowerCase(),n=(0,ur.S8)(C);$.forEach((i=>{if(Vx(i)){const e=x.A.shared().getUserIdForRoomId(i.room.roomId);var s,o,r;if(!V.some((t=>t.userId===e)))if(!(null!==(s=i.room.normalizedName)&&void 0!==s&&s.includes(n)||null!==(o=i.room.getCanonicalAlias())&&void 0!==o&&o.toLowerCase().includes(t)||null!==(r=i.query)&&void 0!==r&&r.some((e=>e.includes(t)))))return}else if(jx(i)){var a;if(!(i.alreadyFiltered||null!==(a=i.query)&&void 0!==a&&a.some((e=>e.includes(t)))))return}else if(Bx(i)){var l;if(null===(l=i.query)||void 0===l||!l.some((e=>e.includes(t))))return}else{var c;if(!(i.name.toLowerCase().includes(t)||null!==(c=i.query)&&void 0!==c&&c.some((e=>e.includes(t)))))return}e[i.section].push(i)}))}else g===Nx.d.PublicRooms||g===Nx.d.PublicSpaces?$.forEach((t=>{Bx(t)&&e[t.section].push(t)})):g===Nx.d.People&&$.forEach((t=>{jx(t)&&e[t.section].push(t)}));const t=c.getSafeUserId();for(const n of Object.values(e))n.sort(((e,n)=>Vx(e)||Vx(n)?Vx(n)&&Vx(e)?Kx.getLastTs(n.room,t)-Kx.getLastTs(e.room,t):-1:jx(e)||jx(n)?jx(n)&&jx(e)?E(e.member,n.member):-1:0));return e}),[C,g,c,$,V,E]);((e,t,n)=>{(0,i.useEffect)((()=>{if(!t)return;const i=window.setTimeout((()=>{B.Vo.instance.trackEvent({eventName:"WebSearch",viaSpotlight:n,numResults:e,queryLength:t})}),1e3);return()=>{clearTimeout(i)}}),[e,t,n])})((0,Vn.sum)(Object.values(q).map((e=>e.length))),m.length,!0);const Y=us.Ay.instance.activeSpaceRoom,[Q,ee]=((e,t)=>{var n;const[s,r]=(0,i.useState)([]),[a,l]=(0,i.useState)(),c=(0,i.useCallback)((()=>{l(e?new Q_.B(e,50):void 0)}),[e]);return(0,i.useEffect)(c,[c]),(0,i.useEffect)((()=>{if(!e||!a)return;let t=!1;return(async()=>{for(;null!=a&&a.canLoadMore&&!t&&e===a.root;)await a.load(),a.canLoadMore&&a.load(),r(a.rooms)})(),()=>{t=!0}}),[e,a]),[(0,i.useMemo)((()=>{const e=t.trim(),n=e.toLowerCase(),i=(0,ur.S8)(e),r=_.J.safeGet();return null==s?void 0:s.filter((e=>{var t;return e.room_type!==o.RoomType.Space&&(null===(t=r.getRoom(e.room_id))||void 0===t?void 0:t.getMyMembership())!==ut.O.Join&&((0,ur.S8)(e.name||"").includes(i)||(e.canonical_alias||"").includes(n))}))}),[s,t]),null!==(n=null==a?void 0:a.loading)&&void 0!==n&&n]})(null!=Y?Y:void 0,m);(0,i.useEffect)((()=>{setTimeout((()=>{const e=d.state.nodes[0];var t;e&&(d.dispatch({type:wn.ZU.SetFocus,payload:{node:e}}),null==e||null===(t=e.scrollIntoView)||void 0===t||t.call(e,{block:"nearest"}))}))}),[q,g]);const te=(e,t=!1,i=!1)=>{if(t){const t=new Set(M.A.getValue("SpotlightSearch.recentSearches",null).reverse());t.delete(e.roomId),t.add(e.roomId),M.A.setValue("SpotlightSearch.recentSearches",null,O.p.ACCOUNT,Array.from(t).reverse().slice(0,10))}S.A.dispatch({action:W.r.ViewRoom,metricsTrigger:"WebUnifiedSearch",metricsViaKeyboard:i,room_id:e.roomId,room_alias:e.roomAlias,auto_join:e.autoJoin&&!Gx(e.joinRule),should_peek:e.shouldPeek,via_servers:e.viaServers}),Gx(e.joinRule)&&S.A.dispatch({action:W.r.PromptAskToJoin}),n()};let ne,oe;if((C||g!==Nx.d.PublicRooms&&g!==Nx.d.PublicSpaces)&&(ne=i.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group","aria-labelledby":"mx_SpotlightDialog_section_otherSearches"},i.createElement("h4",{id:"mx_SpotlightDialog_section_otherSearches"},C?(0,l._t)("spotlight_dialog|heading_with_query",{query:m}):(0,l._t)("spotlight_dialog|heading_without_query")),i.createElement("div",null,g!==Nx.d.PublicSpaces&&k&&i.createElement(Sx,{id:"mx_SpotlightDialog_button_explorePublicSpaces",className:"mx_SpotlightDialog_explorePublicSpaces",onClick:()=>f(Nx.d.PublicSpaces)},Fx(Nx.d.PublicSpaces)),g!==Nx.d.PublicRooms&&i.createElement(Sx,{id:"mx_SpotlightDialog_button_explorePublicRooms",className:"mx_SpotlightDialog_explorePublicRooms",onClick:()=>f(Nx.d.PublicRooms)},Fx(Nx.d.PublicRooms)),g!==Nx.d.People&&i.createElement(Sx,{id:"mx_SpotlightDialog_button_startChat",className:"mx_SpotlightDialog_startChat",onClick:()=>f(Nx.d.People)},Fx(Nx.d.People))))),C||null!==g){const e=e=>{var t;if(Vx(e)){const t=ya.n.instance.getRoomState(e.room),n=Jx(e.room,t),s={"aria-label":n?`${e.room.name} ${n}`:e.room.name,"aria-describedby":`mx_SpotlightDialog_button_result_${e.room.roomId}_details`};return i.createElement(Sx,(0,_t.A)({id:`mx_SpotlightDialog_button_result_${e.room.roomId}`,key:`${Ux[e.section]}-${e.room.roomId}`,onClick:t=>{te({roomId:e.room.roomId},!0,"click"!==(null==t?void 0:t.type))},endAdornment:i.createElement(Ix,{room:e.room})},s),i.createElement(es.A,{room:e.room,size:Mx,tooltipProps:{tabIndex:-1}}),e.room.name,i.createElement(Yt.A,{notification:t}),i.createElement(vs,{id:`mx_SpotlightDialog_button_result_${e.room.roomId}_details`,className:"mx_SpotlightDialog_result_details",room:e.room}))}if(jx(e))return i.createElement(Sx,{id:`mx_SpotlightDialog_button_result_${e.member.userId}`,key:`${Ux[e.section]}-${e.member.userId}`,onClick:()=>{(0,bf.UZ)(c,[e.member]),n()},"aria-label":e.member instanceof o.RoomMember?e.member.rawDisplayName:e.member.name,"aria-describedby":`mx_SpotlightDialog_button_result_${e.member.userId}_details`},i.createElement(cx.N,{user:e.member,size:Mx}),e.member instanceof o.RoomMember?e.member.rawDisplayName:e.member.name,i.createElement("div",{id:`mx_SpotlightDialog_button_result_${e.member.userId}_details`,className:"mx_SpotlightDialog_result_details"},e.member.userId));if(Bx(e)){const t=c.getRoom(e.publicRoom.room_id),n=e.publicRoom.join_rule,s=(null==t?void 0:t.getMyMembership())===ut.O.Join||e.publicRoom.world_readable&&!Gx(n)||c.isGuest(),o=t=>{var i;t.stopPropagation();const{publicRoom:s}=e;te({roomAlias:s.canonical_alias||(null===(i=s.aliases)||void 0===i?void 0:i[0]),roomId:s.room_id,autoJoin:!e.publicRoom.world_readable&&!c.isGuest(),shouldPeek:e.publicRoom.world_readable||c.isGuest(),viaServers:N?[N.roomServer]:void 0,joinRule:n},!0,"click"!==t.type)};let r;return r=s?(0,l._t)("action|view"):Gx(n)?(0,l._t)("action|ask_to_join"):(0,l._t)("action|join"),i.createElement(Sx,{id:`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}`,className:"mx_SpotlightDialog_result_multiline",key:`${Ux[e.section]}-${e.publicRoom.room_id}`,onClick:o,endAdornment:i.createElement(ie.A,{kind:s?"primary_outline":"primary",onClick:o,tabIndex:-1},r),"aria-labelledby":`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_name`,"aria-describedby":`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_alias`,"aria-details":`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_details`},i.createElement(Kt.A,{className:"mx_SearchResultAvatar",oobData:{roomId:e.publicRoom.room_id,name:e.publicRoom.name,avatarUrl:e.publicRoom.avatar_url,roomType:e.publicRoom.room_type},size:Mx}),i.createElement(Ax,{room:e.publicRoom,labelId:`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_name`,descriptionId:`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_alias`,detailsId:`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_details`}))}return i.createElement(Sx,{id:`mx_SpotlightDialog_button_result_${e.name}`,key:`${Ux[e.section]}-${e.name}`,onClick:null!==(t=e.onClick)&&void 0!==t?t:null},e.avatar,e.name,e.description)};let t,s,r,a,d,m,u,h,p,v;if(q[Ux.People].length&&(t=i.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_people"},i.createElement("h4",{id:"mx_SpotlightDialog_section_people"},(0,l._t)("invite|recents_section")),i.createElement("div",null,q[Ux.People].slice(0,Dx).map(e)))),q[Ux.Suggestions].length&&g===Nx.d.People&&(s=i.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_suggestions"},i.createElement("h4",{id:"mx_SpotlightDialog_section_suggestions"},(0,l._t)("common|suggestions")),i.createElement("div",null,q[Ux.Suggestions].slice(0,Dx).map(e)))),q[Ux.Rooms].length&&(r=i.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_rooms"},i.createElement("h4",{id:"mx_SpotlightDialog_section_rooms"},(0,l._t)("common|rooms")),i.createElement("div",null,q[Ux.Rooms].slice(0,Dx).map(e)))),q[Ux.Spaces].length&&(a=i.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_spaces"},i.createElement("h4",{id:"mx_SpotlightDialog_section_spaces"},(0,l._t)("spotlight_dialog|spaces_title")),i.createElement("div",null,q[Ux.Spaces].slice(0,Dx).map(e)))),g===Nx.d.PublicRooms||g===Nx.d.PublicSpaces){let t;t=U?i.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchText"},g===Nx.d.PublicRooms?(0,l._t)("spotlight_dialog|failed_querying_public_rooms"):(0,l._t)("spotlight_dialog|failed_querying_public_spaces")):q[Ux.PublicRoomsAndSpaces].slice(0,Dx).map(e),d=i.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_publicRooms"},i.createElement("div",{className:"mx_SpotlightDialog_sectionHeader"},i.createElement("h4",{id:"mx_SpotlightDialog_section_publicRooms"},(0,l._t)("common|suggestions")),i.createElement("div",{className:"mx_SpotlightDialog_options"},i.createElement(bx,{protocols:P,config:null!=N?N:null,setConfig:D}))),i.createElement("div",null,t))}Q.length&&Y&&null===g&&(m=i.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_spaceRooms"},i.createElement("h4",{id:"mx_SpotlightDialog_section_spaceRooms"},(0,l._t)("spotlight_dialog|other_rooms_in_space",{spaceName:Y.name})),i.createElement("div",null,Q.slice(0,Dx).map((e=>i.createElement(Sx,{id:`mx_SpotlightDialog_button_result_${e.room_id}`,key:e.room_id,onClick:t=>{te({roomId:e.room_id},!0,"click"!==(null==t?void 0:t.type))}},i.createElement(os.A,{name:e.name,idName:e.room_id,url:e.avatar_url?(0,Wn.lH)(e.avatar_url).getSquareThumbnailHttp(parseInt(Mx,10)):null,size:Mx}),e.name||e.canonical_alias,e.name&&e.canonical_alias&&i.createElement("div",{className:"mx_SpotlightDialog_result_details"},e.canonical_alias)))),ee&&i.createElement(se.A,null)))),!C.startsWith("#")||!C.includes(":")||(0,Or.M)(C)&&c.getRoom((0,Or.M)(C))||(u=i.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group"},i.createElement("div",null,i.createElement(Sx,{id:"mx_SpotlightDialog_button_joinRoomAlias",className:"mx_SpotlightDialog_joinRoomAlias",onClick:e=>{S.A.dispatch({action:W.r.ViewRoom,room_alias:C,auto_join:!0,metricsTrigger:"WebUnifiedSearch",metricsViaKeyboard:"click"!==(null==e?void 0:e.type)}),n()}},(0,l._t)("spotlight_dialog|join_button_text",{roomAddress:C}))))),g===Nx.d.People?h=i.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_hiddenResults",role:"group"},i.createElement("h4",null,(0,l._t)("spotlight_dialog|result_may_be_hidden_privacy_warning")),i.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchText"},(0,l._t)("spotlight_dialog|cant_find_person_helpful_hint")),i.createElement(Px,{id:"mx_SpotlightDialog_button_inviteLink",className:"mx_SpotlightDialog_inviteLink",onClick:()=>{A(!0),(0,Qn.nC)(b)},onTooltipOpenChange:e=>{e||A(!1)},title:w?(0,l._t)("common|copied"):(0,l._t)("action|copy")},i.createElement("span",{className:"mx_AccessibleButton mx_AccessibleButton_hasKind mx_AccessibleButton_kind_primary_outline"},(0,l._t)("spotlight_dialog|copy_link_text")))):!C||g!==Nx.d.PublicRooms&&g!==Nx.d.PublicSpaces||(h=i.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_hiddenResults",role:"group"},i.createElement("h4",null,(0,l._t)("spotlight_dialog|result_may_be_hidden_warning")),i.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchText"},(0,l._t)("spotlight_dialog|cant_find_room_helpful_hint")),i.createElement(Sx,{id:"mx_SpotlightDialog_button_createNewRoom",className:"mx_SpotlightDialog_createRoom",onClick:()=>S.A.dispatch({action:"view_create_room",public:!0,defaultName:(0,Vn.capitalize)(C)})},i.createElement("span",{className:"mx_AccessibleButton mx_AccessibleButton_hasKind mx_AccessibleButton_kind_primary_outline"},(0,l._t)("spotlight_dialog|create_new_room_button"))))),g===Nx.d.People&&(p=i.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group","aria-labelledby":"mx_SpotlightDialog_section_groupChat"},i.createElement("h4",{id:"mx_SpotlightDialog_section_groupChat"},(0,l._t)("spotlight_dialog|group_chat_section_title")),i.createElement(Sx,{id:"mx_SpotlightDialog_button_startGroupChat",className:"mx_SpotlightDialog_startGroupChat",onClick:()=>(0,pr.xZ)(C)},(0,l._t)("spotlight_dialog|start_group_chat_button")))),null===g&&(v=i.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group","aria-labelledby":"mx_SpotlightDialog_section_messageSearch"},i.createElement("h4",{id:"mx_SpotlightDialog_section_messageSearch"},(0,l._t)("spotlight_dialog|message_search_section_title")),i.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchText"},(0,l._t)("spotlight_dialog|search_messages_hint",{},{icon:()=>i.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchIcon"})})))),oe=i.createElement(i.Fragment,null,t,s,r,a,m,d,u,h,ne,p,v)}else{let e;h.length&&(e=i.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_recentSearches",role:"group",tabIndex:-1,"aria-labelledby":"mx_SpotlightDialog_section_recentSearches"},i.createElement("h4",null,i.createElement("span",{id:"mx_SpotlightDialog_section_recentSearches"},(0,l._t)("spotlight_dialog|recent_searches_section_title")),i.createElement(ie.A,{kind:"link",onClick:p},(0,l._t)("action|clear"))),i.createElement("div",null,h.map((e=>{const t=ya.n.instance.getRoomState(e),n=Jx(0,t),s={"aria-label":n?`${e.name} ${n}`:e.name,"aria-describedby":`mx_SpotlightDialog_button_recentSearch_${e.roomId}_details`};return i.createElement(Sx,(0,_t.A)({id:`mx_SpotlightDialog_button_recentSearch_${e.roomId}`,key:e.roomId,onClick:t=>{te({roomId:e.roomId},!0,"click"!==(null==t?void 0:t.type))},endAdornment:i.createElement(Ix,{room:e})},s),i.createElement(es.A,{room:e,size:Mx,tooltipProps:{tabIndex:-1}}),e.name,i.createElement(Yt.A,{notification:t}),i.createElement(vs,{id:`mx_SpotlightDialog_button_recentSearch_${e.roomId}_details`,className:"mx_SpotlightDialog_result_details",room:e}))}))))),oe=i.createElement(i.Fragment,null,i.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_recentlyViewed",role:"group","aria-labelledby":"mx_SpotlightDialog_section_recentlyViewed"},i.createElement("h4",{id:"mx_SpotlightDialog_section_recentlyViewed"},(0,l._t)("spotlight_dialog|recently_viewed_section_title")),i.createElement("div",null,Jl.Y.instance.rooms.filter((e=>e.roomId!==X.M.instance.roomViewStore.getRoomId())).map((e=>i.createElement(Px,{id:`mx_SpotlightDialog_button_recentlyViewed_${e.roomId}`,title:e.name,key:e.roomId,onClick:t=>{te({roomId:e.roomId},!1,"click"!==t.type)}},i.createElement(es.A,{room:e,size:"32px",tooltipProps:{tabIndex:-1}}),e.name))))),e,ne)}const re=null===(s=d.state.activeNode)||void 0===s?void 0:s.id;return i.createElement(i.Fragment,null,i.createElement("div",{id:"mx_SpotlightDialog_keyboardPrompt"},(0,l._t)("spotlight_dialog|keyboard_scroll_hint",{},{arrows:()=>i.createElement(i.Fragment,null,i.createElement("kbd",null,"↓"),i.createElement("kbd",null,"↑"),null!==!g&&!m&&i.createElement("kbd",null,"←"),null!==!g&&!m&&i.createElement("kbd",null,"→"))})),i.createElement(J.A,{className:"mx_SpotlightDialog",onFinished:n,hasCancel:!1,onKeyDown:e=>{if((0,_s.zM)().getNavigationAction(e)===Pn.bY.FilterRooms)e.stopPropagation(),e.preventDefault(),n();let t;const i=(0,_s.zM)().getAccessibilityAction(e);switch(i){case Pn.bY.Escape:e.stopPropagation(),e.preventDefault(),n();break;case Pn.bY.ArrowUp:case Pn.bY.ArrowDown:if(e.stopPropagation(),e.preventDefault(),d.state.activeNode&&d.state.nodes.length>0){let e=d.state.nodes;if(!m&&null!==!g){const t=Ox(d.state.activeNode)?d.state.activeNode:e.find(Ox);e=e.filter((e=>e===t||!Ox(e)))}const n=e.indexOf(d.state.activeNode);t=(0,wn.Ed)(e,n+(i===Pn.bY.ArrowUp?-1:1))}break;case Pn.bY.ArrowLeft:case Pn.bY.ArrowRight:if(!m&&null!==!g&&d.state.activeNode&&d.state.nodes.length>0&&Ox(d.state.activeNode)){e.stopPropagation(),e.preventDefault();const n=d.state.nodes.filter(Ox),s=n.indexOf(d.state.activeNode);t=(0,wn.Ed)(n,s+(i===Pn.bY.ArrowLeft?-1:1))}}var s;t&&(d.dispatch({type:wn.ZU.SetFocus,payload:{node:t}}),null===(s=t)||void 0===s||s.scrollIntoView({block:"nearest"}))},screenName:"UnifiedSearch","aria-label":(0,l._t)("spotlight_dialog|search_dialog")},i.createElement("div",{className:"mx_SpotlightDialog_searchBox mx_textinput"},null!==g&&i.createElement("div",{className:dt()("mx_SpotlightDialog_filter",{mx_SpotlightDialog_filterPeople:g===Nx.d.People,mx_SpotlightDialog_filterPublicRooms:g===Nx.d.PublicRooms,mx_SpotlightDialog_filterPublicSpaces:g===Nx.d.PublicSpaces})},i.createElement("span",null,Fx(g)),i.createElement(ie.A,{tabIndex:-1,alt:(0,l._t)("spotlight_dialog|remove_filter",{filter:Fx(g)}),className:"mx_SpotlightDialog_filter--close",onClick:()=>f(null)})),i.createElement("input",{ref:r,autoFocus:!0,type:"text",autoComplete:"off",autoCapitalize:"off",autoCorrect:"off",spellCheck:"false",placeholder:(0,l._t)("action|search"),value:m,onChange:e=>{const t=function(e){var t;const n=(0,yt.$N)(e);return null!==(t=null==n?void 0:n.primaryEntityId)&&void 0!==t?t:e}(e.currentTarget.value);u(t)},onKeyDown:e=>{var t;switch((0,_s.zM)().getAccessibilityAction(e)){case Pn.bY.Backspace:m||null===g||(e.stopPropagation(),e.preventDefault(),f(null));break;case Pn.bY.Enter:e.stopPropagation(),e.preventDefault(),null===(t=d.state.activeNode)||void 0===t||t.click()}},"aria-owns":"mx_SpotlightDialog_content","aria-activedescendant":re,"aria-label":(0,l._t)("action|search"),"aria-describedby":"mx_SpotlightDialog_keyboardPrompt"}),(I||F||z)&&i.createElement(se.A,{w:24,h:24})),i.createElement("div",{ref:a,id:"mx_SpotlightDialog_content",role:"listbox","aria-activedescendant":re,"aria-describedby":"mx_SpotlightDialog_keyboardPrompt"},oe)))},qx=e=>i.createElement(wn.Se,null,(()=>i.createElement($x,e)));var Yx=n("./src/utils/dm/findDMForUser.ts"),Qx=n("./src/utils/crypto/shouldForceDisableEncryption.ts");const Xx="react_sdk_session_lock_ping",Zx="react_sdk_session_lock_owner",ek="react_sdk_session_lock_claimant",tk=3e4;async function nk(e){const t=(0,wr.A)(),n=s.v.getChild(`getSessionLock[${t}]`);let i=null;function o(){const e=window.localStorage.getItem(ek);if(e!==t)return n.warn(`Lock was claimed by ${e} while we were waiting for it: aborting startup`),-1;const i=window.localStorage.getItem(Xx),s=window.localStorage.getItem(Zx);if(null===i)return n.info("No other session has the lock: proceeding with startup"),0;const o=Date.now()-parseInt(i),r=tk-o;return r<=0?(n.info(`Last ping (from ${s}) was ${o}ms ago: proceeding with startup`),0):(n.info(`Last ping (from ${s}) was ${o}ms ago, waiting ${r}ms`),r)}function r(){window.localStorage.setItem(Zx,t),window.localStorage.setItem(Xx,Date.now().toString())}function a(){null!==i&&(n.debug("page hide: clearing our claim"),window.clearInterval(i),window.localStorage.removeItem(Xx),window.localStorage.removeItem(Zx),i=null)}for(window.localStorage.setItem(ek,t);;){const t=o();if(0==t)break;if(t<0)return await e(),!1;let n;const i=new Promise((e=>{n=t=>{t.key!==Xx&&t.key!==ek||e(t)}})),s=new Promise((e=>{setTimeout(e,t,void 0)}));window.addEventListener("storage",n),await Promise.race([s,i]),window.removeEventListener("storage",n)}return r(),i=window.setInterval(r,5e3),window.addEventListener("storage",(function s(o){if(o.key===ek){const o=window.localStorage.getItem(ek);if(o===t)return;n.info(`Session ${o} is waiting for the lock`),window.removeEventListener("storage",s),async function(){await e(),null!==i&&window.clearInterval(i);window.localStorage.removeItem(Xx),window.localStorage.removeItem(Zx),i=null}().catch((e=>{n.error("Error releasing session lock",e)}))}})),window.addEventListener("pagehide",a),window.addEventListener("unload",a),!0}function ik(){const e=c.Ay.get().brand;return i.createElement(YC,{className:"mx_SessionLockStolenView"},i.createElement("h1",null,(0,l._t)("error_app_open_in_another_tab_title",{brand:e})),i.createElement("h2",null,(0,l._t)("error_app_open_in_another_tab",{brand:e})))}function sk(e){const t=c.Ay.get().brand;return i.createElement("div",{className:"mx_ConfirmSessionLockTheftView"},i.createElement("div",{className:"mx_ConfirmSessionLockTheftView_body"},i.createElement("p",null,(0,l._t)("error_app_opened_in_another_window",{brand:t,label:(0,l._t)("action|continue")})),i.createElement(ie.A,{kind:"primary",onClick:e.onConfirm},(0,l._t)("action|continue"))))}function ok(e){const t=(0,ci.DY)(e.matrixClient,V.CryptoEvent.LegacyCryptoStoreMigrationProgress,((e,t)=>({progress:null!=e?e:-1,totalSteps:null!=t?t:-1})));let n,s;return e.syncError&&(n=i.createElement("div",{className:"mx_LoginSplashView_syncError"},(0,ho.cQ)(e.syncError))),s=-1!==t.totalSteps?i.createElement("div",{className:"mx_LoginSplashView_migrationProgress"},i.createElement("p",null,(0,l._t)("migrating_crypto",{brand:c.Ay.get().brand})),i.createElement(Pd.A,{value:t.progress,max:t.totalSteps})):i.createElement(se.A,null),i.createElement("div",{className:"mx_MatrixChat_splash"},n,s,i.createElement("div",{className:"mx_LoginSplashView_splashButtons"},i.createElement(ie.A,{kind:"link_inline",onClick:e.onLogoutClick},(0,l._t)("action|logout"))))}const rk="mx_draft_cleanup",ak=2592e6;function lk(){if(function(){try{const e=localStorage.getItem(rk);if(!e)return!0;const t=Number.parseInt(e||"",10);return!Number.isInteger(t)||Date.now()>t+ak}catch{return!0}}()){s.v.debug("Cleaning up editor drafts..."),function(){for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);if(!t)continue;let n;if(t.startsWith(ig.hE)&&(n=t.slice(ig.hE.length).split("_$")[0]),t.startsWith(lg)&&(n=t.slice(17).split("_$")[0]),!n)continue;_.J.safeGet().getRoom(n)||(s.v.debug(`Removing draft for unknown room with key ${t}`),localStorage.removeItem(t))}}();try{localStorage.setItem(rk,String(Date.now()))}catch(e){s.v.error("Failed to persist draft cleanup key",e)}}}function ck(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function dk(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ck(Object(n),!0).forEach((function(t){(0,v.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ck(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const mk=["register","mobile_register","login","forgot_password","start_sso","start_cas","welcome"],uk=[W.r.ViewUserSettings,"view_create_chat","view_create_room"];class hk extends i.PureComponent{constructor(e){if(super(e),(0,v.A)(this,"firstSyncComplete",!1),(0,v.A)(this,"firstSyncPromise",void 0),(0,v.A)(this,"screenAfterLogin",void 0),(0,v.A)(this,"tokenLogin",void 0),(0,v.A)(this,"focusNext",void 0),(0,v.A)(this,"subTitleStatus",void 0),(0,v.A)(this,"prevWindowWidth",void 0),(0,v.A)(this,"voiceBroadcastResumer",void 0),(0,v.A)(this,"loggedInView",(0,i.createRef)()),(0,v.A)(this,"dispatcherRef",void 0),(0,v.A)(this,"themeWatcher",void 0),(0,v.A)(this,"fontWatcher",void 0),(0,v.A)(this,"stores",void 0),(0,v.A)(this,"startInitSession",(()=>{const e=this.initSession();this.props.initPromiseCallback&&this.props.initPromiseCallback(e),e.catch((e=>{s.v.error("Error initialising Matrix session",e)}))})),(0,v.A)(this,"onWindowResized",(()=>{this.warnInConsole()})),(0,v.A)(this,"warnInConsole",(0,Vn.throttle)((()=>{const e="15px",t=(0,l._t)("console_wait"),i=(0,l._t)("console_scam_warning"),s=(0,l._t)("console_dev_note");n.g.mx_rage_logger.bypassRageshake("log",`%c${t}\n%c${i}\n%c${s}`,"font-size:50px; color:blue;",`font-size:${e}; color:red;`,`font-size:${e};`)}),1e3)),(0,v.A)(this,"onAction",(e=>{var t;if(this.state.view!==Fe.A.LOCK_STOLEN){if(null!==(t=_.J.get())&&void 0!==t&&t.isGuest()&&uk.includes(e.action))return S.A.dispatch({action:W.r.DoAfterSyncPrepared,deferred_action:e}),void S.A.dispatch({action:"require_registration"});switch(e.action){case"MatrixActions.accountData":if("m.identity_server"===e.event_type){const t=e.event_content?e.event_content.base_url:null;t?(_.J.safeGet().setIdentityServerUrl(t),localStorage.removeItem("mx_is_access_token"),localStorage.setItem("mx_is_url",t)):(_.J.safeGet().setIdentityServerUrl(void 0),localStorage.removeItem("mx_is_access_token"),localStorage.removeItem("mx_is_url")),S.A.dispatch({action:"id_server_changed"})}break;case"logout":et.Ay.instance.hangupAllCalls(),Promise.all([...[...w_.e.instance.connectedCalls].map((e=>e.disconnect())),(0,Pt.yn)(this.stores)]).finally((()=>sr(this.stores.oidcClientStore)));break;case"require_registration":!async function(e={}){const t=k.Ay.createDialog(it.A,{hasCancelButton:!0,quitOnly:!0,title:M.A.getValue(He.f.Registration)?(0,l._t)("auth|sign_in_or_register"):(0,l._t)("action|sign_in"),description:M.A.getValue(He.f.Registration)?(0,l._t)("auth|sign_in_or_register_description"):(0,l._t)("auth|sign_in_description"),button:(0,l._t)("action|sign_in"),extraButtons:M.A.getValue(He.f.Registration)?[i.createElement("button",{key:"register",onClick:()=>{t.close(),S.A.dispatch({action:"start_registration",screenAfterLogin:e.screen_after})}},(0,l._t)("auth|register_action"))]:[],onFinished:t=>{t?S.A.dispatch({action:"start_login",screenAfterLogin:e.screen_after}):e.go_home_on_cancel?S.A.dispatch({action:W.r.ViewHomePage}):e.go_welcome_on_cancel&&S.A.dispatch({action:"view_welcome_page"})}})}(e);break;case"start_mobile_registration":this.startRegistration(e.params||{},!0);break;case"start_registration":if(rr()){this.onSoftLogout();break}e.screenAfterLogin&&(this.screenAfterLogin=e.screenAfterLogin),this.startRegistration(e.params||{});break;case"start_login":if(rr()){this.onSoftLogout();break}e.screenAfterLogin&&(this.screenAfterLogin=e.screenAfterLogin),this.viewLogin();break;case"start_password_recovery":this.setStateForNewView({view:Fe.A.FORGOT_PASSWORD}),this.notifyNewScreen("forgot_password");break;case"start_chat":(0,As.Ay)(_.J.safeGet(),{dmUserId:e.user_id});break;case"leave_room":this.leaveRoom(e.room_id);break;case"forget_room":this.forgetRoom(e.room_id);break;case"copy_room":this.copyRoom(e.room_id);break;case"reject_invite":k.Ay.createDialog(it.A,{title:(0,l._t)("reject_invitation_dialog|title"),description:(0,l._t)("reject_invitation_dialog|confirmation"),onFinished:t=>{if(t){const t=k.Ay.createDialog(se.A,void 0,"mx_Dialog_spinner");_.J.safeGet().leave(e.room_id).then((()=>{t.close(),this.state.currentRoomId===e.room_id&&S.A.dispatch({action:W.r.ViewHomePage})}),(e=>{t.close(),k.Ay.createDialog(nt.A,{title:(0,l._t)("reject_invitation_dialog|failed"),description:e.toString()})}))}}});break;case"view_user_info":this.viewUser(e.userId,e.subAction);break;case"MatrixActions.RoomState.events":{const t=e.event;t.getType()===o.EventType.RoomCanonicalAlias&&t.getRoomId()===this.state.currentRoomId&&this.viewRoom({action:W.r.ViewRoom,room_id:this.state.currentRoomId,metricsTrigger:void 0});break}case W.r.ViewRoom:{const t=this.viewRoom(e);e.deferred_action&&t.then((()=>{S.A.dispatch(e.deferred_action)}));break}case W.r.ViewUserDeviceSettings:S.A.dispatch({action:W.r.ViewUserSettings,initialTabId:Na.v.SessionManager});break;case W.r.ViewUserSettings:{const t=e;k.Ay.createDialog(zA,dk(dk({},e.props),{},{initialTabId:t.initialTabId,sdkContext:this.stores}),void 0,!1,!0),this.viewSomethingBehindModal();break}case"view_create_room":this.createRoom(e.public,e.defaultName,e.type),this.viewSomethingBehindModal();break;case W.r.ViewRoomDirectory:k.Ay.createDialog(qx,{initialText:e.initialText,initialFilter:Nx.d.PublicRooms},"mx_SpotlightDialog_wrapper",!1,!0),this.viewSomethingBehindModal();break;case"view_welcome_page":this.viewWelcome();break;case W.r.ViewHomePage:this.viewHome(e.justRegistered);break;case W.r.ViewStartChatOrReuse:this.chatCreateOrReuse(e.user_id);break;case"view_create_chat":(0,pr.xZ)(e.initialText||""),this.viewSomethingBehindModal();break;case"view_invite":{const t=_.J.safeGet().getRoom(e.roomId);null!=t&&t.isSpaceRoom()?(0,mo.Lo)(t):(0,pr._7)(e.roomId);break}case"view_last_screen":this.showScreenAfterLogin();break;case"hide_left_panel":this.setState({collapseLhs:!0},(()=>{this.state.resizeNotifier.notifyLeftHandleResized()}));break;case"show_left_panel":this.setState({collapseLhs:!1},(()=>{this.state.resizeNotifier.notifyLeftHandleResized()}));break;case W.r.OpenDialPad:k.Ay.createDialog(cy,{},"mx_Dialog_dialPadWrapper");break;case W.r.OnLoggedIn:this.stores.client=_.J.safeGet(),this.tokenLogin||rr()||this.state.view===Fe.A.LOGIN||this.state.view===Fe.A.REGISTER||this.state.view===Fe.A.COMPLETE_SECURITY||this.state.view===Fe.A.E2E_SETUP||this.state.view===Fe.A.USE_CASE_SELECTION||this.onLoggedIn();break;case"on_client_not_viable":this.onSoftLogout();break;case W.r.OnLoggedOut:this.onLoggedOut();break;case"will_start_client":this.setState({ready:!1},(()=>{this.onWillStartClient()}));break;case"client_started":this.onClientStarted().catch((e=>{s.v.error("Exception in onClientStarted",e)}));break;case"send_event":this.onSendEvent(e.room_id,e.event);break;case"aria_hide_main_app":this.setState({hideToSRUsers:!0});break;case"aria_unhide_main_app":this.setState({hideToSRUsers:!1});break;case W.r.PseudonymousAnalyticsAccept:ay(),M.A.setValue("pseudonymousAnalyticsOptIn",null,O.p.ACCOUNT,!0);break;case W.r.PseudonymousAnalyticsReject:ay(),M.A.setValue("pseudonymousAnalyticsOptIn",null,O.p.ACCOUNT,!1);break;case W.r.ShowThread:{const{rootEvent:t,initialEvent:n,highlighted:i,scrollIntoView:s,push:o}=e,r={phase:fl.n.ThreadView,state:{threadHeadEvent:t,initialEvent:n,isInitialEventHighlighted:i,initialEventScrollIntoView:s}};null!=o&&o?_l.A.instance.pushCard(r):_l.A.instance.setCards([{phase:fl.n.ThreadPanel},r]),S.A.dispatch({action:W.r.FocusSendMessageComposer,context:jt.Ae.Thread});break}case W.r.OpenSpotlight:k.Ay.createDialog(qx,{initialText:e.initialText,initialFilter:e.initialFilter},"mx_SpotlightDialog_wrapper",!1,!0)}}})),(0,v.A)(this,"handleResize",(()=>{const e=1e3,t=Zr.A.instance.windowWidth;this.prevWindowWidth<e&&t>=e&&S.A.dispatch({action:"show_left_panel"}),this.prevWindowWidth>=e&&t<e&&S.A.dispatch({action:"hide_left_panel"}),this.prevWindowWidth=t,this.state.resizeNotifier.notifyWindowResized()})),(0,v.A)(this,"onRegisterClick",(()=>{this.showScreen("register")})),(0,v.A)(this,"onLoginClick",(()=>{this.showScreen("login")})),(0,v.A)(this,"onForgotPasswordClick",(()=>{this.showScreen("forgot_password")})),(0,v.A)(this,"onRegisterFlowComplete",((e,t)=>this.onUserCompletedLoginFlow(e,t))),(0,v.A)(this,"onUpdateStatusIndicator",((e,t)=>{const n=e.numUnreadStates;a.A.get()&&(a.A.get().setErrorStatus(t===o.SyncState.Error),a.A.get().setNotificationCount(n)),this.subTitleStatus="",t===o.SyncState.Error&&(this.subTitleStatus+=`[${(0,l._t)("common|offline")}] `),n>0?this.subTitleStatus+=`[${n}]`:e.level>=da.S.Activity&&(this.subTitleStatus+="*"),this.setPageSubtitle()})),(0,v.A)(this,"onServerConfigChange",(e=>{this.setState({serverConfig:e})})),(0,v.A)(this,"onUserCompletedLoginFlow",(async(e,t)=>{this.stores.accountPasswordStore.setPassword(t),await Zo(e),await this.postLoginSetup(),HC.instance.stop(zC.LOGIN),HC.instance.stop(zC.REGISTER)})),(0,v.A)(this,"onCompleteSecurityE2eSetupFinished",(()=>{_.J.currentUserIsJustRegistered()&&null===M.A.getValue("FTUE.useCaseSelection")?(this.setStateForNewView({view:Fe.A.USE_CASE_SELECTION}),M.A.watchSetting("FTUE.useCaseSelection",null,((e,t,n,i,s)=>{null!==s&&this.state.view===Fe.A.USE_CASE_SELECTION&&this.onShowPostLoginScreen()}))):this.onShowPostLoginScreen().catch((e=>{s.v.error("Exception showing post-login screen",e)}))})),this.stores=X.M.instance,this.stores.constructEagerStores(),this.state={view:Fe.A.LOADING,collapseLhs:!1,currentRoomId:null,currentUserId:null,hideToSRUsers:!1,isMobileRegistration:!1,syncError:null,resizeNotifier:new Nr,ready:!1},c.Ay.put(this.props.config),this.firstSyncComplete=!1,this.firstSyncPromise=(0,ur.v6)(),this.props.config.sync_timeline_limit&&(_.J.opts.initialSyncLimit=this.props.config.sync_timeline_limit),this.screenAfterLogin=this.props.initialScreenAfterLogin,this.screenAfterLogin){const e=this.screenAfterLogin.params||{};if(this.screenAfterLogin.screen.startsWith("room/")&&e.signurl&&e.email){const t=this.screenAfterLogin.screen.substring(5);Ze.instance.storeInvite(t,e)}}this.prevWindowWidth=Zr.A.instance.windowWidth||1e3,this.subTitleStatus=""}async initSession(){var e,t,n;if(!await nk((()=>this.onSessionLockStolen())))return;if(rr())return void Ho();const i=await Jo(this.props.realQueryParams,this.props.defaultDeviceDisplayName,this.getFragmentAfterLogin());if((null!==(e=this.props.realQueryParams)&&void 0!==e&&e.loginToken||null!==(t=this.props.realQueryParams)&&void 0!==t&&t.code||null!==(n=this.props.realQueryParams)&&void 0!==n&&n.state)&&this.props.onTokenLoginCompleted(),i)return this.tokenLogin=!0,await Xo({ignoreGuest:!0}),void await this.postLoginSetup();const s=this.screenAfterLogin?this.screenAfterLogin.screen:null;await this.loadSession()||null!==s&&mk.includes(s)&&this.showScreenAfterLogin()}async onSessionLockStolen(){await new Promise((e=>{this.setState({view:Fe.A.LOCK_STOLEN},e)})),await async function(){jo=!0,dr()}()}async postLoginSetup(){const e=_.J.safeGet(),t=Boolean(e.getCrypto());t||this.onLoggedIn();const n=[this.firstSyncPromise.promise];let i=!1;if(t&&n.push((async t=>{i=Boolean(await(null===(t=e.getCrypto())||void 0===t?void 0:t.userHasCrossSigningKeys()))})()),this.setState({pendingInitialSync:!0}),await Promise.all(n),t){if(i){0==f.r.instance.extensions.cryptoSetup.SHOW_ENCRYPTION_SETUP_UI?this.onLoggedIn():this.setStateForNewView({view:Fe.A.COMPLETE_SECURITY})}else await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing")&&!await(async e=>{const t=(0,Qx.I)(e),n=e.getCrypto();return!n||t&&!await(0,Z.qM)(e.getRooms(),(({roomId:e})=>n.isEncryptionEnabledInRoom(e)))})(e)?this.setStateForNewView({view:Fe.A.E2E_SETUP}):this.onLoggedIn();this.setState({pendingInitialSync:!1})}else this.setState({pendingInitialSync:!1})}setState(e,t){this.shouldTrackPageChange(this.state,dk(dk({},this.state),e))&&this.startPageChangeTimer(),super.setState(e,t)}componentDidMount(){Zr.A.instance.on(Zr.x.Resize,this.handleResize),this.state.resizeNotifier.on("middlePanelResized",this.dispatchTimelineResize),ya.n.instance.on(ya.N,this.onUpdateStatusIndicator),this.dispatcherRef=S.A.register(this.onAction),this.themeWatcher=new Dr.A,this.fontWatcher=new Mr.g,this.themeWatcher.start(),this.fontWatcher.start(),(0,lt.ig)(c.Ay.get("sentry")),!function(){const e=s.v.getChild("checkSessionLockFree"),t=window.localStorage.getItem(Xx);if(null===t)return e.info("No other session has the lock"),!0;const n=window.localStorage.getItem(Zx),i=Date.now()-parseInt(t);return tk-i<=0?(e.info(`Last ping (from ${n}) was ${i}ms ago: lock is free`),!0):(e.info(`Last ping (from ${n}) was ${i}ms ago: lock is taken`),!1)}()?setTimeout((()=>this.setState({view:Fe.A.CONFIRM_LOCK_THEFT})),0):this.startInitSession(),window.addEventListener("resize",this.onWindowResized)}componentDidUpdate(e,t){if(this.shouldTrackPageChange(t,this.state)){const e=this.stopPageChangeTimer();null!=e&&Mn.A.instance.trackPageChange(this.state.view,this.state.page_type,e)}"composer"===this.focusNext?(S.A.fire(W.r.FocusSendMessageComposer),this.focusNext=void 0):"threadsPanel"===this.focusNext&&S.A.fire(W.r.FocusThreadsPanel)}componentWillUnmount(){var e,t,n;dr(),S.A.unregister(this.dispatcherRef),null===(e=this.themeWatcher)||void 0===e||e.stop(),null===(t=this.fontWatcher)||void 0===t||t.stop(),Zr.A.destroy(),this.state.resizeNotifier.removeListener("middlePanelResized",this.dispatchTimelineResize),window.removeEventListener("resize",this.onWindowResized),this.stores.accountPasswordStore.clearPassword(),null===(n=this.voiceBroadcastResumer)||void 0===n||n.destroy()}getFallbackHsUrl(){var e;if(null!==(e=this.getServerProperties().serverConfig)&&void 0!==e&&e.isDefault)return this.props.config.fallback_hs_url}getServerProperties(){return{serverConfig:this.state.serverConfig||c.Ay.get("validated_server_config")}}loadSession(){return Promise.resolve().then((()=>Ho({fragmentQueryParams:this.props.startingFragmentQueryParams,enableGuest:this.props.enableGuest,guestHsUrl:this.getServerProperties().serverConfig.hsUrl,guestIsUrl:this.getServerProperties().serverConfig.isUrl,defaultDeviceDisplayName:this.props.defaultDeviceDisplayName}))).then((e=>(e||(Ze.instance.pickBestInvite()&&M.A.getValue(He.f.Registration)?S.A.dispatch({action:"start_registration"}):S.A.dispatch({action:"view_welcome_page"})),e)))}startPageChangeTimer(){HC.instance.start(zC.PAGE_CHANGE)}stopPageChangeTimer(){const e=HC.instance;e.stop(zC.PAGE_CHANGE);const t=e.getEntries({name:zC.PAGE_CHANGE}).pop();return t?t.duration:null}shouldTrackPageChange(e,t){return e.currentRoomId!==t.currentRoomId||e.view!==t.view||e.page_type!==t.page_type}setStateForNewView(e){if(void 0===e.view)throw new Error("setStateForNewView with no view!");this.setState(dk({currentUserId:void 0,justRegistered:!1},e))}setPage(e){this.setState({page_type:e})}async startRegistration(e,t){var n;if(!M.A.getValue(He.f.Registration)||t&&!M.A.getValue("Registration.mobileRegistrationHelper"))return void this.showScreen("welcome");const i={view:Fe.A.REGISTER};if(t&&e.hs_url)try{const t=await p.validateServerConfigWithStaticUrls(e.hs_url);i.serverConfig=t}catch{s.v.warn("Failed to load hs_url param:",e.hs_url)}else if(e.client_secret&&e.session_id&&e.hs_url&&e.is_url&&e.sid){i.serverConfig=await p.validateServerConfigWithStaticUrls(e.hs_url,e.is_url);const t=c.Ay.get("validated_server_config");t&&t.hsUrl===i.serverConfig.hsUrl&&(i.serverConfig.hsName=t.hsName,i.serverConfig.hsNameIsDifferent=t.hsNameIsDifferent,i.serverConfig.isDefault=t.isDefault,i.serverConfig.isNameResolvable=t.isNameResolvable),i.register_client_secret=e.client_secret,i.register_session_id=e.session_id,i.register_id_sid=e.sid}i.isMobileRegistration=t,this.setStateForNewView(i),Tr.A.isLogin=!0,null===(n=this.themeWatcher)||void 0===n||n.recheck(),this.notifyNewScreen(t?"mobile_register":"register")}async viewRoom(e){var t,n;if(this.focusNext=null!==(t=e.focusNext)&&void 0!==t?t:"composer",e.room_alias?s.v.log(`Switching to room alias ${e.room_alias} at event ${e.event_id}`):s.v.log(`Switching to room id ${e.room_id} at event ${e.event_id}`),!this.firstSyncComplete){if(!this.firstSyncPromise)return void s.v.warn("Cannot view a room before first sync. room_id:",e.room_id);await this.firstSyncPromise.promise}let i=e.room_alias||e.room_id;const o=_.J.safeGet().getRoom(e.room_id);if(o){var r;o.decryptAllEvents();const e=gr.zQ(o);e&&(i=e,(0,Or.i)(e,o.roomId)),null===(r=localStorage)||void 0===r||r.setItem("mx_last_room_id",o.roomId)}let a="#"===i[0]&&e.room_id===this.state.currentRoomId;var l,c,d,m;((0,Pi.F)(this.state.currentRoomId)&&(a=!0),e.room_id===this.state.currentRoomId)&&(e.threepid_invite=null!==(l=e.threepid_invite)&&void 0!==l?l:this.state.threepidInvite,e.oob_data=null!==(c=e.oob_data)&&void 0!==c?c:this.state.roomOobData,e.forceTimeline=null!==(d=e.forceTimeline)&&void 0!==d?d:this.state.forceTimeline,e.justCreatedOpts=null!==(m=e.justCreatedOpts)&&void 0!==m?m:this.state.roomJustCreatedOpts);e.event_id&&e.highlighted&&(i+="/"+e.event_id),this.setState({view:Fe.A.LOGGED_IN,currentRoomId:null!==(n=e.room_id)&&void 0!==n?n:null,page_type:Ir.A.RoomView,threepidInvite:e.threepid_invite,roomOobData:e.oob_data,forceTimeline:e.forceTimeline,ready:!0,roomJustCreatedOpts:e.justCreatedOpts},(()=>{var e;Tr.A.isLogin=!1,null===(e=this.themeWatcher)||void 0===e||e.recheck(),this.notifyNewScreen("room/"+i,a)}))}viewSomethingBehindModal(){this.state.view===Fe.A.LOGGED_IN?this.state.currentRoomId||this.state.currentUserId||this.viewHome():this.viewWelcome()}viewWelcome(){var e;if(function(e){const t=new mr.Q(e).get("embedded_pages");return!!t&&!0===new mr.Q(t).get("login_for_welcome")}(c.Ay.get()))return this.viewLogin();this.setStateForNewView({view:Fe.A.WELCOME}),this.notifyNewScreen("welcome"),Tr.A.isLogin=!0,null===(e=this.themeWatcher)||void 0===e||e.recheck()}viewLogin(e){var t;this.setStateForNewView(dk({view:Fe.A.LOGIN},e)),this.notifyNewScreen("login"),Tr.A.isLogin=!0,null===(t=this.themeWatcher)||void 0===t||t.recheck()}viewHome(e=!1){var t;this.setStateForNewView({view:Fe.A.LOGGED_IN,justRegistered:e,currentRoomId:null}),this.setPage(Ir.A.HomePage),this.notifyNewScreen("home"),Tr.A.isLogin=!1,null===(t=this.themeWatcher)||void 0===t||t.recheck()}viewUser(e,t){(this.firstSyncPromise?this.firstSyncPromise.promise:Promise.resolve()).then((()=>{"chat"!==t?(this.notifyNewScreen("user/"+e),this.setState({currentUserId:e}),this.setPage(Ir.A.UserView)):this.chatCreateOrReuse(e)}))}async createRoom(e=!1,t,n){const i=k.Ay.createDialog(HA.A,{type:n,defaultPublic:e,defaultName:t}),[s,o]=await i.finished;s&&(0,As.Ay)(_.J.safeGet(),o)}chatCreateOrReuse(e){if(_.J.safeGet().isGuest())return void S.A.dispatch({action:W.r.DoAfterSyncPrepared,deferred_action:{action:W.r.ViewStartChatOrReuse,user_id:e}});const t=_.J.safeGet(),n=(0,Yx.D)(t,e);n?S.A.dispatch({action:W.r.ViewRoom,room_id:n.roomId,metricsTrigger:"MessageUser"}):S.A.dispatch({action:"start_chat",user_id:e})}leaveRoomWarnings(e){const t=_.J.safeGet().getRoom(e),n=null==t?void 0:t.isSpaceRoom(),s=[];if(1===(null==t?void 0:t.currentState.getJoinedMemberCount()))return s.push(i.createElement("strong",{className:"warning",key:"only_member_warning"}," ",(0,l._t)("leave_room_dialog|last_person_warning"))),s;const r=null==t?void 0:t.currentState.getStateEvents("m.room.join_rules","");if(r){"public"!==r.getContent().join_rule&&s.push(i.createElement("strong",{className:"warning",key:"non_public_warning"}," ",n?(0,l._t)("leave_room_dialog|space_rejoin_warning"):(0,l._t)("leave_room_dialog|room_rejoin_warning")))}const a=_.J.get();if(a&&t){const e=t.currentState.getStateEvents(o.EventType.RoomPowerLevels,""),n=(e?e.getContent():{}).users||{},r=n[a.getUserId()],c=Object.values(n);if(c.every((e=>"number"==typeof e))){const e=Math.max(...c);if(e===r&&c.lastIndexOf(e)==c.indexOf(e)){const t=e>=100?(0,l._t)("leave_room_dialog|room_leave_admin_warning"):(0,l._t)("leave_room_dialog|room_leave_mod_warning");s.push(i.createElement("strong",{className:"warning",key:"last_admin_warning"}," ",t))}}}return s}leaveRoom(e){var t,n;const s=_.J.safeGet(),o=s.getRoom(e),r=this.leaveRoomWarnings(e),a=null==o?void 0:o.isSpaceRoom();k.Ay.createDialog(it.A,{title:a?(0,l._t)("space|leave_dialog_action"):(0,l._t)("action|leave_room"),description:i.createElement("span",null,a?(0,l._t)("leave_room_dialog|leave_space_question",{spaceName:null!==(t=null==o?void 0:o.name)&&void 0!==t?t:(0,l._t)("common|unnamed_space")}):(0,l._t)("leave_room_dialog|leave_room_question",{roomName:null!==(n=null==o?void 0:o.name)&&void 0!==n?n:(0,l._t)("common|unnamed_room")}),r),button:(0,l._t)("action|leave"),danger:r.length>0,onFinished:async t=>{t&&(await(0,Ks.U)(s,e),S.A.dispatch({action:W.r.AfterLeaveRoom,room_id:e}))}})}forgetRoom(e){const t=_.J.safeGet().getRoom(e);_.J.safeGet().forget(e).then((()=>{this.state.currentRoomId===e&&S.A.dispatch({action:W.r.ViewHomePage}),t&&Gl.Ay.instance.manualRoomUpdate(t,Jr.w4.RoomRemoved)})).catch((e=>{var t;const n=e.errcode||(0,l.AO)("error|unknown_error_code");k.Ay.createDialog(nt.A,{title:(0,l._t)("error_dialog|forget_room_failed",{errCode:n}),description:null!==(t=null==e?void 0:e.message)&&void 0!==t?t:(0,l._t)("invite|failed_generic")})}))}async copyRoom(e){const t=(0,yt.B4)(_.J.safeGet(),e);await(0,Qn.nC)(t)||k.Ay.createDialog(nt.A,{title:(0,l._t)("error_dialog|copy_room_link_failed|title"),description:(0,l._t)("error_dialog|copy_room_link_failed|description")})}async shouldForceVerification(){if(!c.Ay.get("force_verification"))return!1;if(!localStorage.getItem("must_verify_device"))return!1;const e=_.J.safeGet();if(e.isGuest())return!1;const t=e.getCrypto();return!await(null==t?void 0:t.isCrossSigningReady())}async onLoggedIn(){var e;Tr.A.isLogin=!1,null===(e=this.themeWatcher)||void 0===e||e.recheck(),N.ng(),await this.onShowPostLoginScreen()}async onShowPostLoginScreen(e){var t;if(e&&(B.Vo.instance.setProperty("ftueUseCaseSelection",e),M.A.setValue("FTUE.useCaseSelection",null,O.p.ACCOUNT,e)),this.setStateForNewView({view:Fe.A.LOGGED_IN}),null!==(t=this.screenAfterLogin)&&void 0!==t&&t.screen)this.showScreen(this.screenAfterLogin.screen,this.screenAfterLogin.params),this.screenAfterLogin=void 0;else if(_.J.currentUserIsJustRegistered())if(_.J.setJustRegisteredUserId(null),Ze.instance.pickBestInvite()){const e=Ze.instance.pickBestInvite(),t=Ze.instance.translateToWireFormat(e);this.showScreen(`room/${e.roomId}`,t)}else S.A.dispatch({action:W.r.ViewHomePage,justRegistered:!0});else this.showScreenAfterLogin();c.Ay.get("mobile_guide_toast")&&(()=>{const e=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,t=/Android/.test(navigator.userAgent),n=c.Ay.get().brand;(e||t)&&(document.cookie.includes("element_mobile_redirect_to_guide=false")||L.A.sharedInstance().addOrReplaceToast({key:uy,title:(0,l._t)("mobile_guide|toast_title"),props:{description:(0,l._t)("mobile_guide|toast_description",{brand:n}),primaryLabel:(0,l._t)("mobile_guide|toast_accept"),onPrimaryClick:dy,secondaryLabel:(0,l._t)("action|dismiss"),onSecondaryClick:my},component:j.A,priority:99}))})();const n=c.Ay.get("user_notice");if(n){const e="user_notice_"+n.title;n.show_once&&localStorage.getItem(e)||L.A.sharedInstance().addOrReplaceToast({key:e,title:n.title,props:{description:i.createElement(zn.XZ,null,n.description),primaryLabel:(0,l._t)("action|ok"),onPrimaryClick:()=>{L.A.sharedInstance().dismissToast(e),localStorage.setItem(e,"1")}},component:j.A,className:"mx_AnalyticsToast",priority:100})}}initPosthogAnalyticsToast(){null===M.A.getValue("pseudonymousAnalyticsOptIn")&&ry(),M.A.watchSetting("pseudonymousAnalyticsOptIn",null,((e,t,n,i,s)=>{null===s?ry():ay()}))}showScreenAfterLogin(){this.screenAfterLogin&&this.screenAfterLogin.screen?(this.showScreen(this.screenAfterLogin.screen,this.screenAfterLogin.params),this.screenAfterLogin=void 0):localStorage&&localStorage.getItem("mx_last_room_id")?this.viewLastRoom():_.J.safeGet().isGuest()?S.A.dispatch({action:"view_welcome_page"}):S.A.dispatch({action:W.r.ViewHomePage})}viewLastRoom(){var e;S.A.dispatch({action:W.r.ViewRoom,room_id:null!==(e=localStorage.getItem("mx_last_room_id"))&&void 0!==e?e:void 0,metricsTrigger:void 0})}onLoggedOut(){this.viewLogin({ready:!1,collapseLhs:!1,currentRoomId:null}),this.subTitleStatus="",this.setPageSubtitle(),this.stores.onLoggedOut()}onSoftLogout(){this.notifyNewScreen("soft_logout"),this.setStateForNewView({view:Fe.A.SOFT_LOGOUT,ready:!1,collapseLhs:!1,currentRoomId:null}),this.subTitleStatus="",this.setPageSubtitle()}onWillStartClient(){this.firstSyncComplete=!1,this.firstSyncPromise=(0,ur.v6)();const e=_.J.safeGet();e.setCanResetTimelineCallback((e=>(s.v.log("Request to reset timeline in room ",e," viewing:",this.state.currentRoomId),e!==this.state.currentRoomId||(!this.loggedInView.current||this.loggedInView.current.canResetTimelineInRoom(e))))),e.on(o.ClientEvent.Sync,((e,t,n)=>{var i;e===o.SyncState.Error||e===o.SyncState.Reconnecting?this.setState({syncError:null!==(i=null==n?void 0:n.error)&&void 0!==i?i:null}):this.state.syncError&&this.setState({syncError:null});e!==o.SyncState.Syncing||t!==o.SyncState.Syncing?(s.v.debug(`MatrixClient sync state => ${e}`),e===o.SyncState.Prepared&&(this.firstSyncComplete=!0,this.firstSyncPromise.resolve(),b.default.shouldShowPrompt()&&!_.J.userRegisteredWithinLastHours(24)&&(0,G_.P)(!1),S.A.fire(W.r.FocusSendMessageComposer))):lk()})),e.on(o.HttpApiEvent.SessionLoggedOut,(function(e){if(!ir){if(k.Ay.forceCloseAllModals(),401===e.httpStatus&&e.data&&e.data.soft_logout)return s.v.warn("Soft logout issued by server - avoiding data deletion"),void or();k.Ay.createDialog(nt.A,{title:(0,l._t)("auth|session_logged_out_title"),description:(0,l._t)("auth|session_logged_out_description")}),S.A.dispatch({action:"logout"})}})),e.on(o.HttpApiEvent.NoConsent,(function(t,n){k.Ay.createDialog(it.A,{title:(0,l._t)("terms|tac_title"),description:i.createElement("div",null,i.createElement("p",null," ",(0,l._t)("terms|tac_description",{homeserverDomain:e.getDomain()}))),button:(0,l._t)("terms|tac_button"),cancelButton:(0,l._t)("action|dismiss"),onFinished:e=>{if(e){window.open(n,"_blank").opener=null}}},void 0,!0)})),ii.instance.start(e).catch((e=>s.v.error("Unable to start DecryptionFailureTracker",e))),e.on(o.ClientEvent.Room,(t=>{if(e.getCrypto()){const e=M.A.getValueAt(O.p.ROOM_DEVICE,"blacklistUnverifiedDevices",t.roomId,!0);t.setBlacklistUnverifiedDevices(e)}})),e.on(V.CryptoEvent.KeyBackupFailed,(async t=>{var o;let r,a=null;if(Boolean(e.getCrypto()&&null!==await(null===(o=e.getCrypto())||void 0===o?void 0:o.getActiveSessionBackupVersion())))r=!0;else try{var l,c;a=null!==(l=await(null===(c=e.getCrypto())||void 0===c?void 0:c.getKeyBackupInfo()))&&void 0!==l?l:null,null!==a&&(r=!0)}catch(e){return void s.v.error("Saw key backup error but failed to check backup version!",e)}r?k.Ay.createDialog((0,i.lazy)((()=>n.e(8859).then(n.bind(n,"./src/async-components/views/dialogs/security/NewRecoveryMethodDialog.tsx"))))):k.Ay.createDialog((0,i.lazy)((()=>n.e(8213).then(n.bind(n,"./src/async-components/views/dialogs/security/RecoveryMethodRemovedDialog.tsx")))))})),e.on(V.CryptoEvent.VerificationRequestReceived,(e=>{e.verifier?k.Ay.createDialog($A,{verifier:e.verifier},void 0,!1,!0):e.pending&&L.A.sharedInstance().addOrReplaceToast({key:"verifreq_"+e.transactionId,title:(0,l._t)("encryption|verification_requested_toast_title"),icon:"verification",props:{request:e},component:WC,priority:90})})),this.voiceBroadcastResumer=new Pt.FJ(e)}async onClientStarted(){const e=_.J.safeGet(),t=await this.shouldForceVerification();[Fe.A.COMPLETE_SECURITY,Fe.A.E2E_SETUP].includes(this.state.view)||t&&this.setStateForNewView({view:Fe.A.COMPLETE_SECURITY});const n=e.getCrypto();if(n){const t=M.A.getValueAt(O.p.DEVICE,"blacklistUnverifiedDevices");n.globalBlacklistUnverifiedDevices=t,e.setGlobalErrorOnUnknownDevices(!1)}B.Vo.instance.isEnabled()&&M.A.isLevelSupported(O.p.ACCOUNT)&&this.initPosthogAnalyticsToast(),this.setState({ready:!0})}showScreen(e,t){const n=_.J.get();if(!n||n.isGuest()||!mk.includes(e))if("register"===e)S.A.dispatch({action:"start_registration",params:t}),HC.instance.start(zC.REGISTER);else if("mobile_register"===e)S.A.dispatch({action:"start_mobile_registration",params:t});else if("login"===e)S.A.dispatch({action:"start_login",params:t}),HC.instance.start(zC.LOGIN);else if("forgot_password"===e)S.A.dispatch({action:"start_password_recovery",params:t});else if("soft_logout"===e)null!=n&&n.getUserId()&&!rr()?this.viewLastRoom():S.A.dispatch({action:"start_login",params:t});else if("new"===e)S.A.dispatch({action:"view_create_room"});else if("dm"===e)S.A.dispatch({action:"view_create_chat"});else if("settings"===e)S.A.fire(W.r.ViewUserSettings);else if("welcome"===e)S.A.dispatch({action:"view_welcome_page"});else if("home"===e)S.A.dispatch({action:W.r.ViewHomePage});else if("directory"===e)S.A.fire(W.r.ViewRoomDirectory);else if("start_sso"===e||"start_cas"===e){var i;let t=_.J.get();if(!t){const{hsUrl:e,isUrl:n}=this.getServerProperties().serverConfig;t=(0,o.createClient)({baseUrl:e,idBaseUrl:n})}const n="start_sso"===e?"sso":"cas";null===(i=a.A.get())||void 0===i||i.startSingleSignOn(t,n,this.getFragmentAfterLogin())}else if(0===e.indexOf("room/")){var r,l,c;const n=e.substring(5),i=n.indexOf(":")+1;let s=n.length;n.substring(i).indexOf("/")>-1&&(s=i+n.substring(i).indexOf("/"));const o=n.substring(0,s);let a,d=n.substring(s+1);if(d||(d=void 0),null!=t&&t.signurl&&null!=t&&t.email&&(a=Ze.instance.storeInvite(o,t)),!a){a=Ze.instance.getInvites().find((e=>e.roomId===o))}let m=[];null!=t&&t.via&&(m="string"==typeof t.via?[t.via]:t.via);const u={action:W.r.ViewRoom,event_id:d,via_servers:m,highlighted:Boolean(d),threepid_invite:a,oob_data:{name:null===(r=a)||void 0===r?void 0:r.roomName,avatarUrl:null===(l=a)||void 0===l?void 0:l.roomAvatarUrl,inviterName:null===(c=a)||void 0===c?void 0:c.inviterName},room_alias:void 0,room_id:void 0,metricsTrigger:void 0};"#"===o[0]?u.room_alias=o:u.room_id=o,S.A.dispatch(u)}else if(0===e.indexOf("user/")){const n=e.substring(5);S.A.dispatch({action:"view_user_info",userId:n,subAction:null==t?void 0:t.action})}else s.v.info(`Ignoring showScreen for '${e}'`);else S.A.dispatch({action:W.r.ViewHomePage})}notifyNewScreen(e,t=!1){this.props.onNewScreen&&this.props.onNewScreen(e,t),this.setPageSubtitle()}onLogoutClick(e){S.A.dispatch({action:"logout"}),e.stopPropagation(),e.preventDefault()}dispatchTimelineResize(){S.A.dispatch({action:"timeline_resize"})}onRegistered(e){return Zo(e)}onSendEvent(e,t){const n=_.J.get();n&&n.sendEvent(e,t.getType(),t.getContent()).then((()=>{S.A.dispatch({action:"message_sent"})}))}setPageSubtitle(e=""){if(this.state.currentRoomId){const t=_.J.get(),n=null==t?void 0:t.getRoom(this.state.currentRoomId);n&&(e=`${this.subTitleStatus} | ${n.name} ${e}`)}else e=`${this.subTitleStatus} ${e}`;const t=`${c.Ay.get().brand} ${e}`;document.title!==t&&(document.title=t)}getFragmentAfterLogin(){let e="";const t=this.props.initialScreenAfterLogin;return t&&!["welcome","login","register","start_sso","start_cas"].includes(t.screen)&&(e=`/${t.screen}`),e}render(){const e=this.getFragmentAfterLogin();let t;if(this.state.view===Fe.A.LOADING)t=i.createElement("div",{className:"mx_MatrixChat_splash"},i.createElement(se.A,null));else if(this.state.view===Fe.A.CONFIRM_LOCK_THEFT)t=i.createElement(sk,{onConfirm:()=>{this.setState({view:Fe.A.LOADING}),this.startInitSession()}});else if(this.state.view===Fe.A.COMPLETE_SECURITY)t=i.createElement(XA,{onFinished:this.onCompleteSecurityE2eSetupFinished});else if(this.state.view===Fe.A.E2E_SETUP)t=i.createElement(fC,{matrixClient:_.J.safeGet(),onFinished:this.onCompleteSecurityE2eSetupFinished,accountPassword:this.stores.accountPasswordStore.getPassword(),tokenLogin:!!this.tokenLogin});else if(this.state.view===Fe.A.LOGGED_IN)t=this.state.ready&&this.state.page_type?i.createElement(YE,(0,_t.A)({},this.props,this.state,{ref:this.loggedInView,matrixClient:_.J.safeGet(),onRegistered:this.onRegistered,currentRoomId:this.state.currentRoomId})):i.createElement(ok,{matrixClient:_.J.safeGet(),onLogoutClick:this.onLogoutClick,syncError:this.state.syncError});else if(this.state.view===Fe.A.WELCOME)t=i.createElement(nC,null);else if(this.state.view===Fe.A.REGISTER&&M.A.getValue(He.f.Registration)){var n;const s=null===(n=Ze.instance.pickBestInvite())||void 0===n?void 0:n.toEmail;t=i.createElement(TC,(0,_t.A)({clientSecret:this.state.register_client_secret,sessionId:this.state.register_session_id,idSid:this.state.register_id_sid,email:s,brand:this.props.config.brand,onLoggedIn:this.onRegisterFlowComplete,onLoginClick:this.onLoginClick,onServerConfigChange:this.onServerConfigChange,defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,fragmentAfterLogin:e,mobileRegister:this.state.isMobileRegistration},this.getServerProperties()))}else if(this.state.view===Fe.A.FORGOT_PASSWORD&&M.A.getValue(He.f.PasswordReset))t=i.createElement(gC,(0,_t.A)({onComplete:this.onLoginClick,onLoginClick:this.onLoginClick},this.getServerProperties()));else if(this.state.view===Fe.A.LOGIN){var o;const n=M.A.getValue(He.f.PasswordReset);t=i.createElement(BC,(0,_t.A)({isSyncing:this.state.pendingInitialSync,onLoggedIn:this.onUserCompletedLoginFlow,onRegisterClick:this.onRegisterClick,fallbackHsUrl:this.getFallbackHsUrl(),defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,onForgotPasswordClick:n?this.onForgotPasswordClick:void 0,onServerConfigChange:this.onServerConfigChange,fragmentAfterLogin:e,defaultUsername:null===(o=this.props.startingFragmentQueryParams)||void 0===o?void 0:o.defaultUsername},this.getServerProperties()))}else if(this.state.view===Fe.A.SOFT_LOGOUT)t=i.createElement($C,{realQueryParams:this.props.realQueryParams,onTokenLoginCompleted:this.props.onTokenLoginCompleted,fragmentAfterLogin:e});else if(this.state.view===Fe.A.USE_CASE_SELECTION)t=i.createElement(XC,{onFinished:e=>this.onShowPostLoginScreen(e)});else{if(this.state.view!==Fe.A.LOCK_STOLEN)return s.v.error(`Unknown view ${this.state.view}`),null;t=i.createElement(ik,null)}return i.createElement(Hm.A,null,i.createElement(X.A.Provider,{value:this.stores},i.createElement(hr.B,null,t)))}}(0,v.A)(hk,"displayName","MatrixChat"),(0,v.A)(hk,"defaultProps",{realQueryParams:{},startingFragmentQueryParams:{},config:{},onTokenLoginCompleted:()=>{}});var pk=n("./src/vector/url_utils.ts");let gk=null;function vk(e){const t=(0,pk._)(e);return{screen:t.location.substring(1),params:t.params}}function _k(){decodeURIComponent(window.location.hash)!==gk&&function(e){if(!window.matrixChat)return;s.v.log("Routing URL ",e.href);const t=vk(e);window.matrixChat.showScreen(t.screen,t.params)}(window.location)}function fk(e,t=!1){s.v.log("newscreen "+e);const n="#/"+e;gk=n,e.startsWith("room/")&&window.location.hash.includes("/$")===n.includes("/$")&&window.location.hash.startsWith(n)&&(t=!0),t?window.location.replace(n):window.location.assign(n)}const Ek="mx_screen_after_login";function yk(e){const t=vk(e);(t.screen||t.params)&&function(e){null!=e&&e.screen&&sessionStorage.setItem(Ek,JSON.stringify(e))}(t);const n=function(){const e=sessionStorage.getItem(Ek);return e?JSON.parse(e):void 0}();return n}function bk(){const e=new URL(window.location.href);e.searchParams.delete("loginToken"),e.searchParams.delete("state"),e.searchParams.delete("code"),s.v.log(`Redirecting to ${e.href} to drop delegated authentication params from queryparams`),window.history.replaceState(null,"",e.href)}async function wk(e,t){var n;window.addEventListener("hashchange",_k);const d=a.A.get(),m=(0,pk.u)(window.location),u=window.location.protocol+"//"+window.location.host+window.location.pathname;s.v.log("Vector starting at "+u),null==d||d.startUpdater();const h=await async function(){let e;try{s.v.log("Verifying homeserver configuration");const t=c.Ay.get();let n=t.default_server_config;const i=t.default_server_name,r=t.default_hs_url,a=t.default_is_url,d=[n,i,r].filter((e=>!!e));if(r&&(n||i))throw new l.P7("error|invalid_configuration_mixed_server");if(d.length<1)throw new l.P7("error|invalid_configuration_no_server");let m;r&&(s.v.log("Config uses a default_hs_url - constructing a default_server_config using this information"),s.v.warn("DEPRECATED CONFIG OPTION: In the future, default_hs_url will not be accepted. Please use default_server_config instead."),n={"m.homeserver":{base_url:r}},a&&(n["m.identity_server"]={base_url:a})),!i&&n&&(s.v.log("Config uses a default_server_config - validating object"),m=await o.AutoDiscovery.fromDiscoveryConfig(n)),i&&(s.v.log("Config uses a default_server_name - doing .well-known lookup"),s.v.warn("DEPRECATED CONFIG OPTION: In the future, default_server_name will not be accepted. Please use default_server_config instead."),m=await o.AutoDiscovery.findClientConfig(i),null===m["m.homeserver"].base_url&&n&&(s.v.log("Finding base_url failed but a default_server_config was found - using it as a fallback"),m=await o.AutoDiscovery.fromDiscoveryConfig(n))),e=await p.buildValidatedConfigFromDiscovery(i,m,!0)}catch(t){const{hsUrl:n,isUrl:i,userId:o}=await Yo();if(!n||!o)throw t;s.v.error(t),s.v.warn("A session was found - suppressing config error and using the session's homeserver"),s.v.log("Using pre-existing hsUrl and isUrl: ",{hsUrl:n,isUrl:i}),e=await p.validateServerConfigWithStaticUrls(n,i,!0)}return e.isDefault=!0,s.v.log("Using homeserver config:",e),s.v.log("Updating SdkConfig with validated discovery information"),c.Ay.add({validated_server_config:e}),c.Ay.get()}(),g=new mr.Q(h),[v]=await Ko(),_=!!v,E=!!m.loginToken,y=(0,c.Hy)(h);let b=!0===y.immediate;const w="#/welcome"===window.location.hash||"#"===window.location.hash||""===window.location.hash,S="#/login"===window.location.hash;if(!b&&y.on_welcome_page&&w&&(b=!0),!b&&y.on_login_page&&S&&(b=!0),!_&&!E&&b){s.v.log("Bypassing app load to redirect to SSO");const e=(0,o.createClient)({baseUrl:h.validated_server_config.hsUrl,idBaseUrl:h.validated_server_config.isUrl});return a.A.get().startSingleSignOn(e,"sso",`/${vk(window.location).screen}`),i.createElement(i.Fragment,null)}const A=null!==(n=g.get("default_device_display_name"))&&void 0!==n?n:null==d?void 0:d.getDefaultDeviceDisplayName(),C=yk(window.location),x={Wrapper:i.Fragment};return f.r.instance.invoke(r.m.Wrapper,x),i.createElement(x.Wrapper,null,i.createElement(i.StrictMode,null,i.createElement(hk,{ref:t,onNewScreen:fk,config:h,realQueryParams:m,startingFragmentQueryParams:e,enableGuest:!h.disable_guests,onTokenLoginCompleted:bk,initialScreenAfterLogin:C,defaultDeviceDisplayName:A})))}window.React=i,s.v.log("Application is running in production mode"),window.matrixLogger=s.v},"./res/img/stickerpack-placeholder.png":e=>{e.exports="img/stickerpack-placeholder.877b5d0.png"},"./res/img/user-onboarding/CommunityMessaging.png":e=>{e.exports="img/user-onboarding/CommunityMessaging.0e6a083.png"},"./res/img/user-onboarding/PersonalMessaging.png":e=>{e.exports="img/user-onboarding/PersonalMessaging.12f2bc3.png"},"./res/img/user-onboarding/WorkMessaging.png":e=>{e.exports="img/user-onboarding/WorkMessaging.2643669.png"},"./src/effects lazy recursive ^\\.\\/.*$ referencedExports: default":(e,t,n)=>{var i={"./":["./src/effects/index.ts",9],"./ICanvasEffect":["./src/effects/ICanvasEffect.ts",7,6746],"./ICanvasEffect.ts":["./src/effects/ICanvasEffect.ts",7,6746],"./confetti":["./src/effects/confetti/index.ts",9,5549],"./confetti/":["./src/effects/confetti/index.ts",9,5549],"./confetti/index":["./src/effects/confetti/index.ts",9,5549],"./confetti/index.ts":["./src/effects/confetti/index.ts",9,5549],"./effect":["./src/effects/effect.ts",9,4667],"./effect.ts":["./src/effects/effect.ts",9,4667],"./fireworks":["./src/effects/fireworks/index.ts",9,9621],"./fireworks/":["./src/effects/fireworks/index.ts",9,9621],"./fireworks/index":["./src/effects/fireworks/index.ts",9,9621],"./fireworks/index.ts":["./src/effects/fireworks/index.ts",9,9621],"./hearts":["./src/effects/hearts/index.ts",9,9660],"./hearts/":["./src/effects/hearts/index.ts",9,9660],"./hearts/index":["./src/effects/hearts/index.ts",9,9660],"./hearts/index.ts":["./src/effects/hearts/index.ts",9,9660],"./index":["./src/effects/index.ts",9],"./index.ts":["./src/effects/index.ts",9],"./rainfall":["./src/effects/rainfall/index.ts",9,8698],"./rainfall/":["./src/effects/rainfall/index.ts",9,8698],"./rainfall/index":["./src/effects/rainfall/index.ts",9,8698],"./rainfall/index.ts":["./src/effects/rainfall/index.ts",9,8698],"./snowfall":["./src/effects/snowfall/index.ts",9,955],"./snowfall/":["./src/effects/snowfall/index.ts",9,955],"./snowfall/index":["./src/effects/snowfall/index.ts",9,955],"./snowfall/index.ts":["./src/effects/snowfall/index.ts",9,955],"./spaceinvaders":["./src/effects/spaceinvaders/index.ts",9,9123],"./spaceinvaders/":["./src/effects/spaceinvaders/index.ts",9,9123],"./spaceinvaders/index":["./src/effects/spaceinvaders/index.ts",9,9123],"./spaceinvaders/index.ts":["./src/effects/spaceinvaders/index.ts",9,9123],"./utils":["./src/effects/utils.ts",9],"./utils.ts":["./src/effects/utils.ts",9]};function s(e){if(!n.o(i,e))return Promise.resolve().then((()=>{var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}));var t=i[e],s=t[0];return Promise.all(t.slice(2).map(n.e)).then((()=>n.t(s,16|t[1])))}s.keys=()=>Object.keys(i),s.id="./src/effects lazy recursive ^\\.\\/.*$ referencedExports: default",e.exports=s},"?d4c0":()=>{}}]);
//# sourceMappingURL=element-web-app.js.map