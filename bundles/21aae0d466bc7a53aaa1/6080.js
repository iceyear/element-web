"use strict";(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[6080],{"./node_modules/matrix-js-sdk/src/rendezvous/index.ts":(e,t,i)=>{i.d(t,{fF:()=>w,n$:()=>p,_T:()=>y,NF:()=>m,G_:()=>u,Qd:()=>v,E$:()=>g});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=i("./node_modules/@matrix-org/matrix-sdk-crypto-wasm/pkg/index.js"),r=i("./node_modules/matrix-js-sdk/src/logger.ts"),o=i("./node_modules/matrix-js-sdk/src/http-api/index.ts"),a=i("./node_modules/matrix-js-sdk/src/utils.ts"),c=i("./node_modules/matrix-js-sdk/src/oidc/index.ts");function d(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function l(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?d(Object(i),!0).forEach((function(t){(0,n.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):d(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let h=function(e){return e.Protocols="m.login.protocols",e.Protocol="m.login.protocol",e.Failure="m.login.failure",e.Success="m.login.success",e.Secrets="m.login.secrets",e.ProtocolAccepted="m.login.protocol_accepted",e.Declined="m.login.declined",e}({});class u{get checkCode(){var e;return null===(e=this.channel)||void 0===e?void 0:e.getCheckCode()}constructor(e,t,i,r){(0,n.A)(this,"ourIntent",void 0),(0,n.A)(this,"_code",void 0),(0,n.A)(this,"expectingNewDeviceId",void 0),this.channel=e,this.didScanCode=t,this.client=i,this.onFailure=r,this.ourIntent=i?s.QrCodeMode.Reciprocate:s.QrCodeMode.Login}get code(){return this._code}async generateCode(){this._code||(this.ourIntent===s.QrCodeMode.Reciprocate&&this.client?this._code=await this.channel.generateCode(this.ourIntent,this.client.getDomain()):this.ourIntent===s.QrCodeMode.Login&&(this._code=await this.channel.generateCode(this.ourIntent)))}get isExistingDevice(){return this.ourIntent===s.QrCodeMode.Reciprocate}get isNewDevice(){return!this.isExistingDevice}async negotiateProtocols(){if(r.v.info(`negotiateProtocols(isNewDevice=${this.isNewDevice} didScanCode=${this.didScanCode})`),await this.channel.connect(),this.didScanCode)if(this.isNewDevice);else{var e;let t;try{const{issuer:e}=await this.client.getAuthIssuer();t=await(0,c.k8)(e)}catch(e){r.v.error("Failed to discover OIDC metadata",e)}if(null===(e=t)||void 0===e||!e.metadata.grant_types_supported.includes(c.AO))throw await this.send({type:h.Failure,reason:p.UnsupportedProtocol}),new v("Device code grant unsupported",p.UnsupportedProtocol);await this.send({type:h.Protocols,protocols:["device_authorization_grant"],homeserver:this.client.getDomain()})}else if(this.isNewDevice){r.v.info("Waiting for protocols message");const e=await this.receive();if((null==e?void 0:e.type)===h.Failure)throw new v("Failed",e.reason);if((null==e?void 0:e.type)!==h.Protocols)throw await this.send({type:h.Failure,reason:p.UnexpectedMessageReceived}),new v("Unexpected message received",p.UnexpectedMessageReceived);return{serverName:e.homeserver}}return{}}async deviceAuthorizationGrant(){if(this.isNewDevice)throw new Error("New device flows around OIDC are not yet implemented");{r.v.info("Waiting for protocol message");const t=await this.receive();if((null==t?void 0:t.type)===h.Failure)throw new v("Failed",t.reason);if((null==t?void 0:t.type)!==h.Protocol)throw await this.send({type:h.Failure,reason:p.UnexpectedMessageReceived}),new v("Unexpected message received",p.UnexpectedMessageReceived);if(function(e){return"device_authorization_grant"===e.protocol}(t)){const{device_authorization_grant:i,device_id:n}=t,{verification_uri:s,verification_uri_complete:r}=i;let a=!0;try{var e;await(null===(e=this.client)||void 0===e?void 0:e.getDevice(n))}catch(e){e instanceof o.up&&404===e.httpStatus&&(a=!1)}if(a)throw await this.send({type:h.Failure,reason:p.DeviceAlreadyExists}),new v("Specified device ID already exists",p.DeviceAlreadyExists);return this.expectingNewDeviceId=n,{verificationUri:null!=r?r:s}}throw await this.send({type:h.Failure,reason:p.UnsupportedProtocol}),new v("Received a request for an unsupported protocol",p.UnsupportedProtocol)}}async shareSecrets(){if(this.isNewDevice){await this.send({type:h.Success}),r.v.info("Waiting for secrets message");const e=await this.receive();if((null==e?void 0:e.type)===h.Failure)throw new v("Failed",e.reason);if((null==e?void 0:e.type)!==h.Secrets)throw await this.send({type:h.Failure,reason:p.UnexpectedMessageReceived}),new v("Unexpected message received",p.UnexpectedMessageReceived);return{secrets:e}}{if(!this.expectingNewDeviceId)throw new Error("No new device ID expected");await this.send({type:h.ProtocolAccepted}),r.v.info("Waiting for outcome message");const t=await this.receive();if((null==t?void 0:t.type)===h.Failure)throw new v("Failed",t.reason);if((null==t?void 0:t.type)===h.Declined)throw new v("User declined",w.UserDeclined);if((null==t?void 0:t.type)!==h.Success)throw await this.send({type:h.Failure,reason:p.UnexpectedMessageReceived}),new v("Unexpected message",p.UnexpectedMessageReceived);const i=Date.now()+1e4;do{try{var e;if(await(null===(e=this.client)||void 0===e?void 0:e.getDevice(this.expectingNewDeviceId))){const e=await this.client.getCrypto().exportSecretsBundle();if(this.channel.cancelled)throw new v("User cancelled",p.UserCancelled);return await this.send(l({type:h.Secrets},e)),{secrets:e}}}catch(e){if(!(e instanceof o.up&&404===e.httpStatus))throw e}await(0,a.yy)(1e3)}while(Date.now()<i);throw await this.send({type:h.Failure,reason:p.DeviceNotFound}),new v("New device not found",p.DeviceNotFound)}}async receive(){return await this.channel.secureReceive()}async send(e){await this.channel.secureSend(e)}async declineLoginOnExistingDevice(){if(!this.isExistingDevice)throw new Error("Can only decline login on existing device");await this.send({type:h.Failure,reason:p.UserCancelled})}async cancel(e){var t;null===(t=this.onFailure)||void 0===t||t.call(this,e),await this.channel.cancel(e)}async close(){await this.channel.close()}}class v extends Error{constructor(e,t){super(e),this.code=t}}let p=function(e){return e.AuthorizationExpired="authorization_expired",e.DeviceAlreadyExists="device_already_exists",e.DeviceNotFound="device_not_found",e.UnexpectedMessageReceived="unexpected_message_received",e.UnsupportedProtocol="unsupported_protocol",e.UserCancelled="user_cancelled",e}({}),w=function(e){return e.Expired="expired",e.HomeserverLacksSupport="homeserver_lacks_support",e.InsecureChannelDetected="insecure_channel_detected",e.InvalidCode="invalid_code",e.OtherDeviceNotSignedIn="other_device_not_signed_in",e.OtherDeviceAlreadySignedIn="other_device_already_signed_in",e.Unknown="unknown",e.UserDeclined="user_declined",e.ETagMissing="etag_missing",e}({}),g=function(e){return e.LOGIN_ON_NEW_DEVICE="login.start",e.RECIPROCATE_LOGIN_ON_EXISTING_DEVICE="login.reciprocate",e}({});var f=i("./node_modules/matrix-js-sdk/src/matrix.ts");class y{constructor({fetchFn:e,onFailure:t,url:i,client:s,fallbackRzServer:r}){(0,n.A)(this,"url",void 0),(0,n.A)(this,"client",void 0),(0,n.A)(this,"fallbackRzServer",void 0),(0,n.A)(this,"fetchFn",void 0),(0,n.A)(this,"onFailure",void 0),(0,n.A)(this,"etag",void 0),(0,n.A)(this,"expiresAt",void 0),(0,n.A)(this,"expiresTimer",void 0),(0,n.A)(this,"_cancelled",!1),(0,n.A)(this,"_ready",!1),this.fetchFn=e,this.onFailure=t,this.client=s,this.fallbackRzServer=r,this.url=i}get ready(){return this._ready}get cancelled(){return this._cancelled}fetch(e,t){return this.fetchFn?this.fetchFn(e,t):globalThis.fetch(e,t)}async getPostEndpoint(){if(this.client)try{if(await this.client.doesServerSupportUnstableFeature("org.matrix.msc4108"))return this.client.http.getUrl("/org.matrix.msc4108/rendezvous",void 0,o.iD.Unstable).toString()}catch(e){r.v.warn("Failed to get unstable features",e)}return this.fallbackRzServer}async send(e){var t,i;if(this._cancelled)return;const n=this.url?f.Method.Put:f.Method.Post,s=null!==(t=this.url)&&void 0!==t?t:await this.getPostEndpoint();if(!s)throw new Error("Invalid rendezvous URI");const o={"content-type":"text/plain"};!this.etag&&this.url&&await this.receive(),this.etag&&(o["if-match"]=this.etag),r.v.info(`=> ${n} ${s} with ${e} if-match: ${this.etag}`);const a=await this.fetch(s,{method:n,headers:o,body:e,redirect:"follow"});if(404===a.status)return this.cancel(w.Unknown);if(this.etag=null!==(i=a.headers.get("etag"))&&void 0!==i?i:void 0,r.v.info(`Received etag: ${this.etag}`),n===f.Method.Post){const e=a.headers.get("expires");e&&(this.expiresTimer&&(clearTimeout(this.expiresTimer),this.expiresTimer=void 0),this.expiresAt=new Date(e),this.expiresTimer=setTimeout((()=>{this.expiresTimer=void 0,this.cancel(w.Expired)}),this.expiresAt.getTime()-Date.now()));const t=await a.json();if("string"!=typeof t.url)throw new Error("No rendezvous URL given");this.url=t.url,this._ready=!0}}async receive(){if(!this.url)throw new Error("Rendezvous not set up");for(;;){var e;if(this._cancelled)return;const t={};this.etag&&(t["if-none-match"]=this.etag),r.v.info(`=> GET ${this.url} if-none-match: ${this.etag}`);const i=await this.fetch(this.url,{method:f.Method.Get,headers:t});if(404===i.status)return void await this.cancel(w.Unknown);const n=null!==(e=i.headers.get("etag"))&&void 0!==e?e:void 0;if("text/plain"!==i.headers.get("content-type"))this.etag=n;else if(200===i.status){if(!n)return void await this.cancel(w.ETagMissing);this.etag=n;const e=await i.text();return r.v.info(`Received: ${e} with etag ${this.etag}`),e}await(0,a.yy)(1e3)}}async cancel(e){var t;this._cancelled||(this.expiresTimer&&(clearTimeout(this.expiresTimer),this.expiresTimer=void 0),e===w.Unknown&&this.expiresAt&&this.expiresAt.getTime()<Date.now()&&(e=w.Expired),this._cancelled=!0,this._ready=!1,null===(t=this.onFailure)||void 0===t||t.call(this,e),e!==w.UserDeclined&&e!==p.UserCancelled||await this.close())}async close(){if(this.expiresTimer&&(clearTimeout(this.expiresTimer),this.expiresTimer=void 0),this.url)try{await this.fetch(this.url,{method:f.Method.Delete})}catch(e){r.v.warn(e)}}}class m{constructor(e,t,i){(0,n.A)(this,"secureChannel",void 0),(0,n.A)(this,"establishedChannel",void 0),(0,n.A)(this,"connected",!1),this.rendezvousSession=e,this.theirPublicKey=t,this.onFailure=i,this.secureChannel=new s.Ecies}async generateCode(e,t){const{url:i}=this.rendezvousSession;if(!i)throw new Error("No rendezvous session URL");return new s.QrCodeData(this.secureChannel.public_key(),i,e===s.QrCodeMode.Reciprocate?t:void 0).toBytes()}getCheckCode(){var e;const t=null===(e=this.establishedChannel)||void 0===e?void 0:e.check_code();if(t)return Array.from(t.as_bytes()).map((e=>""+e%10)).join("")}async connect(){if(this.connected)throw new Error("Channel already connected");if(this.theirPublicKey){const e=this.secureChannel.establish_outbound_channel(this.theirPublicKey,"MATRIX_QR_CODE_LOGIN_INITIATE");this.establishedChannel=e.channel,r.v.info("Sending LoginInitiateMessage"),await this.rendezvousSession.send(e.initial_message);{r.v.info("Waiting for LoginOkMessage");const e=await this.rendezvousSession.receive();if(!e)throw new v("No response from other device",p.UnexpectedMessageReceived);if("MATRIX_QR_CODE_LOGIN_OK"!==await this.decrypt(e))throw new v("Invalid response from other device",w.InsecureChannelDetected)}}else{r.v.info("Waiting for LoginInitiateMessage");const e=await this.rendezvousSession.receive();if(!e)throw new Error("No response from other device");const{channel:t,message:i}=this.secureChannel.establish_inbound_channel(e);if(this.establishedChannel=t,"MATRIX_QR_CODE_LOGIN_INITIATE"!==i)throw new v("Invalid response from other device",w.InsecureChannelDetected);r.v.info("LoginInitiateMessage received"),r.v.info("Sending LoginOkMessage");const n=await this.encrypt("MATRIX_QR_CODE_LOGIN_OK");await this.rendezvousSession.send(n)}this.connected=!0}async decrypt(e){if(!this.establishedChannel)throw new Error("Channel closed");return this.establishedChannel.decrypt(e)}async encrypt(e){if(!this.establishedChannel)throw new Error("Channel closed");return this.establishedChannel.encrypt(e)}async secureSend(e){if(!this.connected)throw new Error("Channel closed");const t=JSON.stringify(e);r.v.debug(`=> {"type": ${JSON.stringify(e.type)}, ...}`),await this.rendezvousSession.send(await this.encrypt(t))}async secureReceive(){if(!this.establishedChannel)throw new Error("Channel closed");const e=await this.rendezvousSession.receive();if(!e)return;const t=await this.decrypt(e),i=JSON.parse(t);return r.v.debug(`<= {"type": ${JSON.stringify(i.type)}, ...}`),i}async close(){await this.rendezvousSession.close()}async cancel(e){try{var t;await this.rendezvousSession.cancel(e),null===(t=this.onFailure)||void 0===t||t.call(this,e)}finally{await this.close()}}get cancelled(){return this.rendezvousSession.cancelled}}},"./node_modules/@vector-im/compound-web/dist/components/Form/Controls/MFA/MFA.js":(e,t,i)=>{i.d(t,{f:()=>w});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=i("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),r=i("./node_modules/react/jsx-runtime.js"),o=i("./node_modules/react/index.js");const a="_container_9zyti_18",c="_control_9zyti_33",d="_digit_9zyti_57";var l=i("./node_modules/classnames/index.js");const h=["className","length"];function u(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function v(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?u(Object(i),!0).forEach((function(t){(0,n.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):u(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const p=({filled:e,selected:t})=>(0,r.jsx)("div",{className:d,"aria-hidden":"true","data-filled":e?"":void 0,"data-selected":t?"":void 0}),w=(0,o.forwardRef)((function(e,t){let{className:i,length:n=6}=e,d=(0,s.A)(e,h);const u=l(a,i),[w,g]=o.useState(0),[f,y]=o.useState(null),m=e=>{var t;const i=e.currentTarget;g(null===(t=i.value)||void 0===t?void 0:t.length),document.activeElement!==i||null===i.selectionStart||null===i.selectionEnd?y(null):y([i.selectionStart,i.selectionEnd])};return(0,r.jsxs)("div",{className:u,children:[(0,r.jsx)("input",v(v({},d),{},{inputMode:"numeric",type:"text",minLength:0,maxLength:n,className:c,pattern:`\\d{${n}}`,autoComplete:"one-time-code",onSelect:m,onFocus:m,onBlur:m,onMouseDown:m,onMouseMove:m,onMouseUp:m,onChange:m,ref:t})),Array.from(Array(n).keys()).map((e=>(0,r.jsx)(p,{filled:e<w,selected:!!f&&e>=f[0]&&e<f[1]},e)))]})}))}}]);
//# sourceMappingURL=6080.js.map