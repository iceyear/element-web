"use strict";(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[8304],{"./node_modules/matrix-react-sdk/src/components/views/auth/LoginWithQR.tsx":(e,t,i)=>{i.r(t),i.d(t,{LoginWithQRFailureReason:()=>me,default:()=>we});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=i("./node_modules/react/index.js"),r=i("./node_modules/matrix-events-sdk/lib/index.js"),o=i("./node_modules/matrix-js-sdk/src/client.ts"),a=i("./node_modules/matrix-js-sdk/src/feature.ts"),c=i("./node_modules/matrix-js-sdk/src/logger.ts"),l=i("./node_modules/matrix-js-sdk/src/utils.ts"),d=i("./node_modules/matrix-js-sdk/src/crypto-api/index.ts"),h=function(e){return e.Start="m.login.start",e.Finish="m.login.finish",e.Progress="m.login.progress",e}(h||{}),u=function(e){return e.Success="success",e.Failure="failure",e.Verified="verified",e.Declined="declined",e.Unsupported="unsupported",e}(u||{});const p=new r.UnstableValue("login_token","org.matrix.msc3906.login_token");class v{constructor(e,t,i){(0,n.A)(this,"newDeviceId",void 0),(0,n.A)(this,"newDeviceKey",void 0),(0,n.A)(this,"ourIntent",S.RECIPROCATE_LOGIN_ON_EXISTING_DEVICE),(0,n.A)(this,"_code",void 0),this.channel=e,this.client=t,this.onFailure=i}get code(){return this._code}async generateCode(){this._code||(this._code=JSON.stringify(await this.channel.generateCode(this.ourIntent)))}async startAfterShowingCode(){const e=await this.channel.connect();c.v.info(`Connected to secure channel with checksum: ${e} our intent is ${this.ourIntent}`);let t={};try{t=await this.client.getCapabilities()}catch(e){}const i=await(0,a.yk)(await this.client.getVersions()),n=o.hx.findIn(t);if((null==n||!n.enabled)&&i.get(a.Xj.LoginTokenRequest)===a.Tj.Unsupported)return c.v.info("Server doesn't support get_login_token"),await this.send({type:h.Finish,outcome:u.Unsupported}),void await this.cancel(C.HomeserverLacksSupport);await this.send({type:h.Progress,protocols:[p.name]}),c.v.info("Waiting for other device to choose protocol");const{type:s,protocol:r,outcome:l}=await this.receive();if(s!==h.Finish)if(s===h.Progress){if(r&&p.matches(r))return e;await this.cancel(C.UnsupportedAlgorithm)}else await this.cancel(C.Unknown);else if("unsupported"===(null!=l?l:""))await this.cancel(C.UnsupportedAlgorithm);else await this.cancel(C.Unknown)}async receive(){return await this.channel.receive()}async send(e){await this.channel.send(e)}async declineLoginOnExistingDevice(){c.v.info("User declined sign in"),await this.send({type:h.Finish,outcome:u.Declined})}async approveLoginOnExistingDevice(e){await this.send({type:h.Progress,login_token:e,homeserver:this.client.baseUrl}),c.v.info("Waiting for outcome");const t=await this.receive();if(!t)return;const{outcome:i,device_id:n,device_key:s}=t;if("success"!==i)throw new Error("Linking failed");return this.newDeviceId=n,this.newDeviceKey=s,n}async verifyAndCrossSignDevice(e){var t;const i=this.client.getCrypto();if(!this.newDeviceId)throw new Error("No new device ID set");if(e.getFingerprint()!==this.newDeviceKey)throw new Error(`New device has different keys than expected: ${this.newDeviceKey} vs ${e.getFingerprint()}`);const n=this.client.getSafeUserId();c.v.info(`Marking device ${this.newDeviceId} as verified`),await i.setDeviceVerified(n,this.newDeviceId,!0),await i.crossSignDevice(this.newDeviceId);const s=null!==(t=await i.getCrossSigningKeyId(d.CrossSigningKey.Master))&&void 0!==t?t:void 0,r=this.client.getDeviceId(),o=(await i.getOwnDeviceKeys()).ed25519;await this.send({type:h.Finish,outcome:u.Verified,verifying_device_id:r,verifying_device_key:o,master_key:s})}async verifyNewDeviceOnExistingDevice(e=1e4){if(!this.newDeviceId)throw new Error("No new device to sign");if(!this.newDeviceKey)return void c.v.info("No new device key to sign");if(!this.client.getCrypto())throw new Error("Crypto not available on client");let t=await this.getOwnDevice(this.newDeviceId);if(t||(c.v.info("Going to wait for new device to be online"),await(0,l.yy)(e),t=await this.getOwnDevice(this.newDeviceId)),!t)throw new Error("Device not online within timeout");await this.verifyAndCrossSignDevice(t)}async getOwnDevice(e){var t;const i=this.client.getSafeUserId();return null===(t=(await this.client.getCrypto().getUserDeviceInfo([i])).get(i))||void 0===t?void 0:t.get(e)}async cancel(e){var t;null===(t=this.onFailure)||void 0===t||t.call(this,e),await this.channel.cancel(e)}async close(){await this.channel.close()}}var g=i("./node_modules/@matrix-org/matrix-sdk-crypto-wasm/pkg/index.js"),_=i("./node_modules/matrix-js-sdk/src/http-api/index.ts"),m=i("./node_modules/matrix-js-sdk/src/oidc/index.ts");function w(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function f(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?w(Object(i),!0).forEach((function(t){(0,n.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):w(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let y=function(e){return e.Protocols="m.login.protocols",e.Protocol="m.login.protocol",e.Failure="m.login.failure",e.Success="m.login.success",e.Secrets="m.login.secrets",e.ProtocolAccepted="m.login.protocol_accepted",e.Declined="m.login.declined",e}({});class E{get checkCode(){var e;return null===(e=this.channel)||void 0===e?void 0:e.getCheckCode()}constructor(e,t,i,s){(0,n.A)(this,"ourIntent",void 0),(0,n.A)(this,"_code",void 0),(0,n.A)(this,"expectingNewDeviceId",void 0),this.channel=e,this.didScanCode=t,this.client=i,this.onFailure=s,this.ourIntent=i?g.QrCodeMode.Reciprocate:g.QrCodeMode.Login}get code(){return this._code}async generateCode(){this._code||(this.ourIntent===g.QrCodeMode.Reciprocate&&this.client?this._code=await this.channel.generateCode(this.ourIntent,this.client.getDomain()):this.ourIntent===g.QrCodeMode.Login&&(this._code=await this.channel.generateCode(this.ourIntent)))}get isExistingDevice(){return this.ourIntent===g.QrCodeMode.Reciprocate}get isNewDevice(){return!this.isExistingDevice}async negotiateProtocols(){if(c.v.info(`negotiateProtocols(isNewDevice=${this.isNewDevice} didScanCode=${this.didScanCode})`),await this.channel.connect(),this.didScanCode)if(this.isNewDevice);else{var e;let t;try{const{issuer:e}=await this.client.getAuthIssuer();t=await(0,m.k8)(e)}catch(e){c.v.error("Failed to discover OIDC metadata",e)}if(null===(e=t)||void 0===e||!e.metadata.grant_types_supported.includes(m.AO))throw await this.send({type:y.Failure,reason:x.UnsupportedProtocol}),new b("Device code grant unsupported",x.UnsupportedProtocol);await this.send({type:y.Protocols,protocols:["device_authorization_grant"],homeserver:this.client.getDomain()})}else if(this.isNewDevice){c.v.info("Waiting for protocols message");const e=await this.receive();if((null==e?void 0:e.type)===y.Failure)throw new b("Failed",e.reason);if((null==e?void 0:e.type)!==y.Protocols)throw await this.send({type:y.Failure,reason:x.UnexpectedMessageReceived}),new b("Unexpected message received",x.UnexpectedMessageReceived);return{serverName:e.homeserver}}return{}}async deviceAuthorizationGrant(){if(this.isNewDevice)throw new Error("New device flows around OIDC are not yet implemented");{c.v.info("Waiting for protocol message");const t=await this.receive();if((null==t?void 0:t.type)===y.Failure)throw new b("Failed",t.reason);if((null==t?void 0:t.type)!==y.Protocol)throw await this.send({type:y.Failure,reason:x.UnexpectedMessageReceived}),new b("Unexpected message received",x.UnexpectedMessageReceived);if(function(e){return"device_authorization_grant"===e.protocol}(t)){const{device_authorization_grant:i,device_id:n}=t,{verification_uri:s,verification_uri_complete:r}=i;let o=!0;try{var e;await(null===(e=this.client)||void 0===e?void 0:e.getDevice(n))}catch(e){e instanceof _.up&&404===e.httpStatus&&(o=!1)}if(o)throw await this.send({type:y.Failure,reason:x.DeviceAlreadyExists}),new b("Specified device ID already exists",x.DeviceAlreadyExists);return this.expectingNewDeviceId=n,{verificationUri:null!=r?r:s}}throw await this.send({type:y.Failure,reason:x.UnsupportedProtocol}),new b("Received a request for an unsupported protocol",x.UnsupportedProtocol)}}async shareSecrets(){if(this.isNewDevice){await this.send({type:y.Success}),c.v.info("Waiting for secrets message");const e=await this.receive();if((null==e?void 0:e.type)===y.Failure)throw new b("Failed",e.reason);if((null==e?void 0:e.type)!==y.Secrets)throw await this.send({type:y.Failure,reason:x.UnexpectedMessageReceived}),new b("Unexpected message received",x.UnexpectedMessageReceived);return{secrets:e}}{if(!this.expectingNewDeviceId)throw new Error("No new device ID expected");await this.send({type:y.ProtocolAccepted}),c.v.info("Waiting for outcome message");const t=await this.receive();if((null==t?void 0:t.type)===y.Failure)throw new b("Failed",t.reason);if((null==t?void 0:t.type)===y.Declined)throw new b("User declined",k.UserDeclined);if((null==t?void 0:t.type)!==y.Success)throw await this.send({type:y.Failure,reason:x.UnexpectedMessageReceived}),new b("Unexpected message",x.UnexpectedMessageReceived);const i=Date.now()+1e4;do{try{var e;if(await(null===(e=this.client)||void 0===e?void 0:e.getDevice(this.expectingNewDeviceId))){const e=await this.client.getCrypto().exportSecretsBundle();if(this.channel.cancelled)throw new b("User cancelled",x.UserCancelled);return await this.send(f({type:y.Secrets},e)),{secrets:e}}}catch(e){if(!(e instanceof _.up&&404===e.httpStatus))throw e}await(0,l.yy)(1e3)}while(Date.now()<i);throw await this.send({type:y.Failure,reason:x.DeviceNotFound}),new b("New device not found",x.DeviceNotFound)}}async receive(){return await this.channel.secureReceive()}async send(e){await this.channel.secureSend(e)}async declineLoginOnExistingDevice(){if(!this.isExistingDevice)throw new Error("Can only decline login on existing device");await this.send({type:y.Failure,reason:x.UserCancelled})}async cancel(e){var t;null===(t=this.onFailure)||void 0===t||t.call(this,e),await this.channel.cancel(e)}async close(){await this.channel.close()}}class b extends Error{constructor(e,t){super(e),this.code=t}}let C=function(e){return e.UserDeclined="user_declined",e.Unknown="unknown",e.Expired="expired",e.UserCancelled="user_cancelled",e.UnsupportedAlgorithm="unsupported_algorithm",e.UnsupportedProtocol="unsupported_protocol",e.HomeserverLacksSupport="homeserver_lacks_support",e}({}),x=function(e){return e.AuthorizationExpired="authorization_expired",e.DeviceAlreadyExists="device_already_exists",e.DeviceNotFound="device_not_found",e.UnexpectedMessageReceived="unexpected_message_received",e.UnsupportedProtocol="unsupported_protocol",e.UserCancelled="user_cancelled",e}({}),k=function(e){return e.Expired="expired",e.HomeserverLacksSupport="homeserver_lacks_support",e.InsecureChannelDetected="insecure_channel_detected",e.InvalidCode="invalid_code",e.OtherDeviceNotSignedIn="other_device_not_signed_in",e.OtherDeviceAlreadySignedIn="other_device_already_signed_in",e.Unknown="unknown",e.UserDeclined="user_declined",e.ETagMissing="etag_missing",e}({}),S=function(e){return e.LOGIN_ON_NEW_DEVICE="login.start",e.RECIPROCATE_LOGIN_ON_EXISTING_DEVICE="login.reciprocate",e}({});const D=new r.UnstableValue("http.v1","org.matrix.msc3886.http.v1");class A{constructor({onFailure:e,client:t,fallbackRzServer:i,fetchFn:s}){(0,n.A)(this,"uri",void 0),(0,n.A)(this,"etag",void 0),(0,n.A)(this,"expiresAt",void 0),(0,n.A)(this,"client",void 0),(0,n.A)(this,"fallbackRzServer",void 0),(0,n.A)(this,"fetchFn",void 0),(0,n.A)(this,"cancelled",!1),(0,n.A)(this,"_ready",!1),(0,n.A)(this,"onFailure",void 0),this.fetchFn=s,this.onFailure=e,this.client=t,this.fallbackRzServer=i}get ready(){return this._ready}async details(){if(!this.uri)throw new Error("Rendezvous not set up");return{type:D.name,uri:this.uri}}fetch(e,t){return this.fetchFn?this.fetchFn(e,t):i.g.fetch(e,t)}async getPostEndpoint(){try{if(await this.client.doesServerSupportUnstableFeature("org.matrix.msc3886"))return`${this.client.baseUrl}${_.iD.Unstable}/org.matrix.msc3886/rendezvous`}catch(e){c.v.warn("Failed to get unstable features",e)}return this.fallbackRzServer}async send(e){var t,i;if(this.cancelled)return;const n=this.uri?"PUT":"POST",s=null!==(t=this.uri)&&void 0!==t?t:await this.getPostEndpoint();if(!s)throw new Error("Invalid rendezvous URI");const r={"content-type":"application/json"};this.etag&&(r["if-match"]=this.etag);const o=await this.fetch(s,{method:n,headers:r,body:JSON.stringify(e)});if(404===o.status)return this.cancel(C.Unknown);if(this.etag=null!==(i=o.headers.get("etag"))&&void 0!==i?i:void 0,"POST"===n){var a;const e=o.headers.get("location");if(!e)throw new Error("No rendezvous URI given");const t=o.headers.get("expires");t&&(this.expiresAt=new Date(t));const i=null!==(a=o.url)&&void 0!==a?a:s;this.uri=new URL(e,`${i}${i.endsWith("/")?"":"/"}`).href,this._ready=!0}}async receive(){if(!this.uri)throw new Error("Rendezvous not set up");for(;;){if(this.cancelled)return;const i={};this.etag&&(i["if-none-match"]=this.etag);const n=await this.fetch(this.uri,{method:"GET",headers:i});if(404===n.status)return void this.cancel(C.Unknown);var e;if("application/json"!==n.headers.get("content-type"))this.etag=null!==(e=n.headers.get("etag"))&&void 0!==e?e:void 0;else if(200===n.status){var t;return this.etag=null!==(t=n.headers.get("etag"))&&void 0!==t?t:void 0,n.json()}await(0,l.yy)(1e3)}}async cancel(e){var t;if(e===C.Unknown&&this.expiresAt&&this.expiresAt.getTime()<Date.now()&&(e=C.Expired),this.cancelled=!0,this._ready=!1,null===(t=this.onFailure)||void 0===t||t.call(this,e),this.uri&&e===C.UserDeclined)try{await this.fetch(this.uri,{method:"DELETE"})}catch(e){c.v.warn(e)}}}var R=i("./node_modules/matrix-js-sdk/src/matrix.ts");class O{constructor({fetchFn:e,onFailure:t,url:i,client:s,fallbackRzServer:r}){(0,n.A)(this,"url",void 0),(0,n.A)(this,"client",void 0),(0,n.A)(this,"fallbackRzServer",void 0),(0,n.A)(this,"fetchFn",void 0),(0,n.A)(this,"onFailure",void 0),(0,n.A)(this,"etag",void 0),(0,n.A)(this,"expiresAt",void 0),(0,n.A)(this,"expiresTimer",void 0),(0,n.A)(this,"_cancelled",!1),(0,n.A)(this,"_ready",!1),this.fetchFn=e,this.onFailure=t,this.client=s,this.fallbackRzServer=r,this.url=i}get ready(){return this._ready}get cancelled(){return this._cancelled}fetch(e,t){return this.fetchFn?this.fetchFn(e,t):i.g.fetch(e,t)}async getPostEndpoint(){if(this.client)try{if(await this.client.doesServerSupportUnstableFeature("org.matrix.msc4108"))return this.client.http.getUrl("/org.matrix.msc4108/rendezvous",void 0,_.iD.Unstable).toString()}catch(e){c.v.warn("Failed to get unstable features",e)}return this.fallbackRzServer}async send(e){var t,i;if(this._cancelled)return;const n=this.url?R.Method.Put:R.Method.Post,s=null!==(t=this.url)&&void 0!==t?t:await this.getPostEndpoint();if(!s)throw new Error("Invalid rendezvous URI");const r={"content-type":"text/plain"};!this.etag&&this.url&&await this.receive(),this.etag&&(r["if-match"]=this.etag),c.v.info(`=> ${n} ${s} with ${e} if-match: ${this.etag}`);const o=await this.fetch(s,{method:n,headers:r,body:e,redirect:"follow"});if(404===o.status)return this.cancel(k.Unknown);if(this.etag=null!==(i=o.headers.get("etag"))&&void 0!==i?i:void 0,c.v.info(`Received etag: ${this.etag}`),n===R.Method.Post){const e=o.headers.get("expires");e&&(this.expiresTimer&&(clearTimeout(this.expiresTimer),this.expiresTimer=void 0),this.expiresAt=new Date(e),this.expiresTimer=setTimeout((()=>{this.expiresTimer=void 0,this.cancel(k.Expired)}),this.expiresAt.getTime()-Date.now()));const t=await o.json();if("string"!=typeof t.url)throw new Error("No rendezvous URL given");this.url=t.url,this._ready=!0}}async receive(){if(!this.url)throw new Error("Rendezvous not set up");for(;;){var e;if(this._cancelled)return;const t={};this.etag&&(t["if-none-match"]=this.etag),c.v.info(`=> GET ${this.url} if-none-match: ${this.etag}`);const i=await this.fetch(this.url,{method:R.Method.Get,headers:t});if(404===i.status)return void await this.cancel(k.Unknown);const n=null!==(e=i.headers.get("etag"))&&void 0!==e?e:void 0;if("text/plain"!==i.headers.get("content-type"))this.etag=n;else if(200===i.status){if(!n)return void await this.cancel(k.ETagMissing);this.etag=n;const e=await i.text();return c.v.info(`Received: ${e} with etag ${this.etag}`),e}await(0,l.yy)(1e3)}}async cancel(e){var t;this._cancelled||(this.expiresTimer&&(clearTimeout(this.expiresTimer),this.expiresTimer=void 0),e===k.Unknown&&this.expiresAt&&this.expiresAt.getTime()<Date.now()&&(e=k.Expired),this._cancelled=!0,this._ready=!1,null===(t=this.onFailure)||void 0===t||t.call(this,e),e!==k.UserDeclined&&e!==x.UserCancelled||await this.close())}async close(){if(this.expiresTimer&&(clearTimeout(this.expiresTimer),this.expiresTimer=void 0),this.url)try{await this.fetch(this.url,{method:R.Method.Delete})}catch(e){c.v.warn(e)}}}var I=i("./node_modules/matrix-js-sdk/src/base64.ts"),U=i("./node_modules/matrix-js-sdk/src/crypto/verification/SASDecimal.ts");const P=new(i("./node_modules/matrix-js-sdk/src/NamespacedValue.ts").qr)("m.rendezvous.v2.curve25519-aes-sha256","org.matrix.msc3903.rendezvous.v2.curve25519-aes-sha256");class F{constructor(e,t,s){(0,n.A)(this,"olmSAS",void 0),(0,n.A)(this,"ourPublicKey",void 0),(0,n.A)(this,"aesKey",void 0),(0,n.A)(this,"connected",!1),this.transport=e,this.theirPublicKey=t,this.onFailure=s,this.olmSAS=new i.g.Olm.SAS,this.ourPublicKey=(0,I.y4)(this.olmSAS.get_pubkey())}async generateCode(e){if(this.transport.ready)throw new Error("Code already generated");await this.transport.send({algorithm:P.name});return{rendezvous:{algorithm:P.name,key:(0,I.PP)(this.ourPublicKey),transport:await this.transport.details()},intent:e}}async connect(){if(this.connected)throw new Error("Channel already connected");if(!this.olmSAS)throw new Error("Channel closed");const e=!this.theirPublicKey;if(e){const e=await this.transport.receive();if(!e)throw new Error("No response from other device");const t=e,{key:i,algorithm:n}=t;if(!n||!P.matches(n)||!i)throw new b("Unsupported algorithm: "+n,C.UnsupportedAlgorithm);this.theirPublicKey=(0,I.y4)(i)}else await this.transport.send({algorithm:P.name,key:(0,I.PP)(this.ourPublicKey)});this.connected=!0,this.olmSAS.set_their_key((0,I.PP)(this.theirPublicKey));const t=e?this.ourPublicKey:this.theirPublicKey,i=e?this.theirPublicKey:this.ourPublicKey;let n=P.name;n+=`|${(0,I.PP)(t)}`,n+=`|${(0,I.PP)(i)}`;const s=this.olmSAS.generate_bytes(n,32);this.aesKey=await async function(e){if(!globalThis.crypto.subtle)throw new Error("Web Crypto is not available");return globalThis.crypto.subtle.importKey("raw",e,{name:"AES-GCM"},!1,["encrypt","decrypt"])}(s),s.fill(0);const r=this.olmSAS.generate_bytes(n,5);return(0,U.c)(Array.from(r)).join("-")}async encrypt(e){if(!globalThis.crypto.subtle)throw new Error("Web Crypto is not available");const t=new Uint8Array(32);globalThis.crypto.getRandomValues(t);const i=(new TextEncoder).encode(JSON.stringify(e)),n=await globalThis.crypto.subtle.encrypt({name:"AES-GCM",iv:t,tagLength:128},this.aesKey,i);return{iv:(0,I.PP)(t),ciphertext:(0,I.PP)(n)}}async send(e){if(!this.olmSAS)throw new Error("Channel closed");if(!this.aesKey)throw new Error("Shared secret not set up");return this.transport.send(await this.encrypt(e))}async decrypt({iv:e,ciphertext:t}){if(!t||!e)throw new Error("Missing ciphertext and/or iv");const i=(0,I.y4)(t);if(!globalThis.crypto.subtle)throw new Error("Web Crypto is not available");const n=await globalThis.crypto.subtle.decrypt({name:"AES-GCM",iv:(0,I.y4)(e),tagLength:128},this.aesKey,i);return JSON.parse((new TextDecoder).decode(new Uint8Array(n)))}async receive(){if(!this.olmSAS)throw new Error("Channel closed");if(!this.aesKey)throw new Error("Shared secret not set up");const e=await this.transport.receive();if(!e)return;const t=e;if(t.ciphertext&&t.iv)return this.decrypt(t);throw new Error("Data received but no ciphertext")}async close(){this.olmSAS&&(this.olmSAS.free(),this.olmSAS=void 0)}async cancel(e){try{await this.transport.cancel(e)}finally{await this.close()}}}class N{constructor(e,t,i){(0,n.A)(this,"secureChannel",void 0),(0,n.A)(this,"establishedChannel",void 0),(0,n.A)(this,"connected",!1),this.rendezvousSession=e,this.theirPublicKey=t,this.onFailure=i,this.secureChannel=new g.Ecies}async generateCode(e,t){const{url:i}=this.rendezvousSession;if(!i)throw new Error("No rendezvous session URL");return new g.QrCodeData(this.secureChannel.public_key(),i,e===g.QrCodeMode.Reciprocate?t:void 0).toBytes()}getCheckCode(){var e;const t=null===(e=this.establishedChannel)||void 0===e?void 0:e.check_code();if(t)return Array.from(t.as_bytes()).map((e=>""+e%10)).join("")}async connect(){if(this.connected)throw new Error("Channel already connected");if(this.theirPublicKey){const e=this.secureChannel.establish_outbound_channel(this.theirPublicKey,"MATRIX_QR_CODE_LOGIN_INITIATE");this.establishedChannel=e.channel,c.v.info("Sending LoginInitiateMessage"),await this.rendezvousSession.send(e.initial_message);{c.v.info("Waiting for LoginOkMessage");const e=await this.rendezvousSession.receive();if(!e)throw new b("No response from other device",x.UnexpectedMessageReceived);if("MATRIX_QR_CODE_LOGIN_OK"!==await this.decrypt(e))throw new b("Invalid response from other device",k.InsecureChannelDetected)}}else{c.v.info("Waiting for LoginInitiateMessage");const e=await this.rendezvousSession.receive();if(!e)throw new Error("No response from other device");const{channel:t,message:i}=this.secureChannel.establish_inbound_channel(e);if(this.establishedChannel=t,"MATRIX_QR_CODE_LOGIN_INITIATE"!==i)throw new b("Invalid response from other device",k.InsecureChannelDetected);c.v.info("LoginInitiateMessage received"),c.v.info("Sending LoginOkMessage");const n=await this.encrypt("MATRIX_QR_CODE_LOGIN_OK");await this.rendezvousSession.send(n)}this.connected=!0}async decrypt(e){if(!this.establishedChannel)throw new Error("Channel closed");return this.establishedChannel.decrypt(e)}async encrypt(e){if(!this.establishedChannel)throw new Error("Channel closed");return this.establishedChannel.encrypt(e)}async secureSend(e){if(!this.connected)throw new Error("Channel closed");const t=JSON.stringify(e);c.v.debug(`=> {"type": ${JSON.stringify(e.type)}, ...}`),await this.rendezvousSession.send(await this.encrypt(t))}async secureReceive(){if(!this.establishedChannel)throw new Error("Channel closed");const e=await this.rendezvousSession.receive();if(!e)return;const t=await this.decrypt(e),i=JSON.parse(t);return c.v.debug(`<= {"type": ${JSON.stringify(i.type)}, ...}`),i}async close(){await this.rendezvousSession.close()}async cancel(e){try{var t;await this.rendezvousSession.cancel(e),null===(t=this.onFailure)||void 0===t||t.call(this,e)}finally{await this.close()}}get cancelled(){return this.rendezvousSession.cancelled}}var z=i("./node_modules/matrix-react-sdk/src/components/views/auth/LoginWithQR-types.ts"),j=i("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/chevron-left.js"),L=i("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/check-circle-solid.js"),T=i("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/error.js"),M=i("./node_modules/@vector-im/compound-web/dist/components/Typography/Text.js"),q=i("./node_modules/@vector-im/compound-web/dist/components/Typography/Heading.js"),Q=i("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),W=i("./node_modules/react/jsx-runtime.js");const K="_container_9zyti_18",$="_control_9zyti_33",G="_digit_9zyti_57";var H=i("./node_modules/classnames/index.js"),V=i.n(H);const B=["className","length"];function Y(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function X(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Y(Object(i),!0).forEach((function(t){(0,n.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Y(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const J=({filled:e,selected:t})=>(0,W.jsx)("div",{className:G,"aria-hidden":"true","data-filled":e?"":void 0,"data-selected":t?"":void 0}),Z=(0,s.forwardRef)((function(e,t){let{className:i,length:n=6}=e,r=(0,Q.A)(e,B);const o=H(K,i),[a,c]=s.useState(0),[l,d]=s.useState(null),h=e=>{var t;const i=e.currentTarget;c(null===(t=i.value)||void 0===t?void 0:t.length),document.activeElement!==i||null===i.selectionStart||null===i.selectionEnd?d(null):d([i.selectionStart,i.selectionEnd])};return(0,W.jsxs)("div",{className:o,children:[(0,W.jsx)("input",X(X({},r),{},{inputMode:"numeric",type:"text",minLength:0,maxLength:n,className:$,pattern:`\\d{${n}}`,autoComplete:"one-time-code",onSelect:h,onFocus:h,onBlur:h,onMouseDown:h,onMouseMove:h,onMouseUp:h,onChange:h,ref:t})),Array.from(Array(n).keys()).map((e=>(0,W.jsx)(J,{filled:e<a,selected:!!l&&e>=l[0]&&e<l[1]},e)))]})}));var ee,te=i("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/qr-code.js"),ie=i("./node_modules/matrix-react-sdk/src/languageHandler.tsx"),ne=i("./node_modules/matrix-react-sdk/src/components/views/elements/AccessibleButton.tsx"),se=i("./node_modules/matrix-react-sdk/src/components/views/elements/QRCode.tsx"),re=i("./node_modules/matrix-react-sdk/src/components/views/elements/Spinner.tsx");function oe(){return oe=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)({}).hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},oe.apply(null,arguments)}var ae=function(e,t){return s.createElement("svg",oe({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0,ref:t},e),ee||(ee=s.createElement("path",{fill:"#000",fillRule:"evenodd",d:"M12 10a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3m-1 3a1 1 0 1 1 0-2h1a1 1 0 0 1 1 1v3.5h.5a1 1 0 1 1 0 2H12a1 1 0 0 1-1-1z",clipRule:"evenodd"})))},ce=(0,s.forwardRef)(ae);var le=i("./node_modules/matrix-react-sdk/src/SdkConfig.ts"),de=i("./node_modules/matrix-react-sdk/src/components/structures/ErrorMessage.tsx"),he=i("./node_modules/buffer/index.js").hp;class ue extends s.Component{constructor(e){super(e),(0,n.A)(this,"checkCodeInput",(0,s.createRef)()),(0,n.A)(this,"handleClick",(e=>async t=>{var i;t.preventDefault(),await this.props.onClick(e,e===z.HY.Approve?null===(i=this.checkCodeInput.current)||void 0===i?void 0:i.value:void 0)})),(0,n.A)(this,"cancelButton",(()=>s.createElement(ne.A,{kind:"primary_outline",onClick:this.handleClick(z.HY.Cancel)},(0,ie._t)("action|cancel")))),(0,n.A)(this,"simpleSpinner",(e=>s.createElement("div",{className:"mx_LoginWithQR_spinner"},s.createElement("div",null,s.createElement(re.A,null),e&&s.createElement("p",null,e)))))}render(){let e,t,i=!0,n="";switch(this.props.phase){case z.a0.Error:{i=!1;let t,r,o=T.A,a=!1;switch(this.props.failureReason){case x.UnsupportedProtocol:case C.UnsupportedProtocol:t=(0,ie._t)("auth|qr_code_login|error_unsupported_protocol_title"),r=(0,ie._t)("auth|qr_code_login|error_unsupported_protocol");break;case x.UserCancelled:case C.UserCancelled:t=(0,ie._t)("auth|qr_code_login|error_user_cancelled_title"),r=(0,ie._t)("auth|qr_code_login|error_user_cancelled");break;case x.AuthorizationExpired:case k.Expired:case C.Expired:t=(0,ie._t)("auth|qr_code_login|error_expired_title"),r=(0,ie._t)("auth|qr_code_login|error_expired");break;case k.InsecureChannelDetected:t=(0,ie._t)("auth|qr_code_login|error_insecure_channel_detected_title"),r=s.createElement(s.Fragment,null,(0,ie._t)("auth|qr_code_login|error_insecure_channel_detected"),s.createElement(M.E,{as:"h2",size:"lg",weight:"semibold"},(0,ie._t)("auth|qr_code_login|error_insecure_channel_detected_instructions")),s.createElement("ol",null,s.createElement("li",null,(0,ie._t)("auth|qr_code_login|error_insecure_channel_detected_instructions_1")),s.createElement("li",null,(0,ie._t)("auth|qr_code_login|error_insecure_channel_detected_instructions_2")),s.createElement("li",null,(0,ie._t)("auth|qr_code_login|error_insecure_channel_detected_instructions_3"))));break;case k.OtherDeviceAlreadySignedIn:a=!0,o=L.A,t=(0,ie._t)("auth|qr_code_login|error_other_device_already_signed_in_title"),r=(0,ie._t)("auth|qr_code_login|error_other_device_already_signed_in");break;case k.UserDeclined:t=(0,ie._t)("auth|qr_code_login|error_user_declined_title"),r=(0,ie._t)("auth|qr_code_login|error_user_declined");break;case me.RateLimited:t=(0,ie._t)("error|something_went_wrong"),r=(0,ie._t)("auth|qr_code_login|error_rate_limited");break;case k.ETagMissing:t=(0,ie._t)("error|something_went_wrong"),r=(0,ie._t)("auth|qr_code_login|error_etag_missing");break;case C.HomeserverLacksSupport:case k.HomeserverLacksSupport:a=null,o=te.A,i=!0,t=(0,ie._t)("auth|qr_code_login|unsupported_heading"),r=(0,ie._t)("auth|qr_code_login|unsupported_explainer");break;case x.DeviceAlreadyExists:case x.DeviceNotFound:case x.UnexpectedMessageReceived:case k.OtherDeviceNotSignedIn:case k.Unknown:default:t=(0,ie._t)("error|something_went_wrong"),r=(0,ie._t)("auth|qr_code_login|error_unexpected")}n="mx_LoginWithQR_error",e=s.createElement(s.Fragment,null,s.createElement("div",{className:V()("mx_LoginWithQR_icon",{"mx_LoginWithQR_icon--critical":!1===a,"mx_LoginWithQR_icon--success":!0===a})},s.createElement(o,{width:"32px",height:"32px"})),s.createElement(q.D,{as:"h1",size:"sm",weight:"semibold"},t),"object"==typeof r?r:s.createElement("p",null,r));break}case z.a0.LegacyConnected:i=!1,e=s.createElement(s.Fragment,null,s.createElement("p",null,(0,ie._t)("auth|qr_code_login|confirm_code_match")),s.createElement("div",{className:"mx_LoginWithQR_confirmationDigits"},this.props.confirmationDigits),s.createElement("div",{className:"mx_LoginWithQR_confirmationAlert"},s.createElement("div",null,s.createElement(ce,null)),s.createElement("div",null,(0,ie._t)("auth|qr_code_login|approve_access_warning")))),t=s.createElement(s.Fragment,null,s.createElement(ne.A,{kind:"primary",onClick:this.handleClick(z.HY.Approve)},(0,ie._t)("action|approve")),s.createElement(ne.A,{kind:"primary_outline",onClick:this.handleClick(z.HY.Decline)},(0,ie._t)("action|cancel")));break;case z.a0.OutOfBandConfirmation:i=!1,e=s.createElement(s.Fragment,null,s.createElement(q.D,{as:"h1",size:"sm",weight:"semibold"},(0,ie._t)("auth|qr_code_login|check_code_heading")),s.createElement(M.E,{size:"md"},(0,ie._t)("auth|qr_code_login|check_code_explainer")),s.createElement("label",{htmlFor:"mx_LoginWithQR_checkCode"},(0,ie._t)("auth|qr_code_login|check_code_input_label")),s.createElement(Z,{className:"mx_LoginWithQR_checkCode_input mx_no_textinput",ref:this.checkCodeInput,length:2,autoFocus:!0,id:"mx_LoginWithQR_checkCode","data-invalid":this.props.failureReason===me.CheckCodeMismatch||void 0}),s.createElement(de.K,{message:this.props.failureReason===me.CheckCodeMismatch?(0,ie._t)("auth|qr_code_login|check_code_mismatch"):null})),t=s.createElement(s.Fragment,null,s.createElement(ne.A,{kind:"primary",onClick:this.handleClick(z.HY.Approve)},(0,ie._t)("action|continue")),s.createElement(ne.A,{kind:"primary_outline",onClick:this.handleClick(z.HY.Decline)},(0,ie._t)("action|cancel")));break;case z.a0.ShowingQR:if(this.props.code){var r;const t="string"!=typeof this.props.code?this.props.code:he.from(null!==(r=this.props.code)&&void 0!==r?r:"");e=s.createElement(s.Fragment,null,s.createElement(q.D,{as:"h1",size:"sm",weight:"semibold"},(0,ie._t)("auth|qr_code_login|scan_code_instruction")),s.createElement("div",{className:"mx_LoginWithQR_qrWrapper"},s.createElement(se.A,{data:[{data:t,mode:"byte"}],className:"mx_QRCode"})),s.createElement("ol",null,s.createElement("li",null,(0,ie._t)("auth|qr_code_login|open_element_other_device",{brand:le.Ay.get().brand})),s.createElement("li",null,(0,ie._t)("auth|qr_code_login|select_qr_code",{scanQRCode:s.createElement("strong",null,(0,ie._t)("auth|qr_code_login|scan_qr_code"))})),s.createElement("li",null,(0,ie._t)("auth|qr_code_login|point_the_camera")),s.createElement("li",null,(0,ie._t)("auth|qr_code_login|follow_remaining_instructions"))))}else e=this.simpleSpinner(),t=this.cancelButton();break;case z.a0.Loading:e=this.simpleSpinner();break;case z.a0.WaitingForDevice:e=s.createElement(s.Fragment,null,this.simpleSpinner((0,ie._t)("auth|qr_code_login|waiting_for_device")),this.props.userCode?s.createElement("div",null,s.createElement("p",null,(0,ie._t)("auth|qr_code_login|security_code")),s.createElement("p",null,(0,ie._t)("auth|qr_code_login|security_code_prompt")),s.createElement("p",null,this.props.userCode)):null),t=this.cancelButton();break;case z.a0.Verifying:e=this.simpleSpinner((0,ie._t)("auth|qr_code_login|completing_setup"))}return s.createElement("div",{className:V()("mx_LoginWithQR",n)},i?s.createElement("div",{className:"mx_LoginWithQR_heading"},s.createElement(ne.A,{className:"mx_LoginWithQR_BackButton",onClick:this.handleClick(z.HY.Back),title:"Back"},s.createElement(j.A,null)),s.createElement("div",{className:"mx_LoginWithQR_breadcrumbs"},(0,ie._t)("settings|sessions|title")," / ",(0,ie._t)("settings|sessions|sign_in_with_qr"))):null,s.createElement("div",{className:"mx_LoginWithQR_main"},e),s.createElement("div",{className:"mx_LoginWithQR_buttons"},t))}}var pe=i("./node_modules/matrix-react-sdk/src/Modal.tsx"),ve=i("./node_modules/matrix-react-sdk/src/components/views/dialogs/InteractiveAuthDialog.tsx");function ge(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function _e(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ge(Object(i),!0).forEach((function(t){(0,n.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ge(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let me=function(e){return e.RateLimited="rate_limited",e.CheckCodeMismatch="check_code_mismatch",e}({});class we extends s.Component{constructor(e){super(e),(0,n.A)(this,"finished",!1),(0,n.A)(this,"generateAndShowCode",(async()=>{let e;try{var t;const i=null===(t=this.props.client)||void 0===t||null===(t=t.getClientWellKnown())||void 0===t||null===(t=t["io.element.rendezvous"])||void 0===t?void 0:t.server;if(this.props.legacy){const t=new A({onFailure:this.onFailure,client:this.props.client,fallbackRzServer:i}),n=new F(t,void 0,this.onFailure);e=new v(n,this.props.client,this.onFailure)}else{const t=new O({onFailure:this.onFailure,client:this.props.client,fallbackRzServer:i});await t.send("");const n=new N(t,void 0,this.onFailure);e=new E(n,!1,this.props.client,this.onFailure)}await e.generateCode(),this.setState({phase:z.a0.ShowingQR,rendezvous:e,failureReason:void 0})}catch(e){return c.v.error("Error whilst generating QR code",e),void this.setState({phase:z.a0.Error,failureReason:k.HomeserverLacksSupport})}try{if(e instanceof v){const t=await e.startAfterShowingCode();this.setState({phase:z.a0.LegacyConnected,confirmationDigits:t})}else if(this.ourIntent===S.RECIPROCATE_LOGIN_ON_EXISTING_DEVICE){await e.negotiateProtocols();const{verificationUri:t}=await e.deviceAuthorizationGrant();this.setState({phase:z.a0.OutOfBandConfirmation,verificationUri:t})}}catch(t){var i;if(c.v.error("Error whilst approving login",t),e instanceof v)this.state.phase!==z.a0.Error&&this.setState({phase:z.a0.Error,failureReason:C.Unknown});else await(null===(i=e)||void 0===i?void 0:i.cancel(t instanceof b?t.code:k.Unknown))}})),(0,n.A)(this,"approveLogin",(async e=>{var t;if(!(this.state.rendezvous instanceof E))throw this.setState({phase:z.a0.Error,failureReason:k.Unknown}),new Error("Rendezvous not found");if(this.state.lastScannedCode||(null===(t=this.state.rendezvous)||void 0===t?void 0:t.checkCode)===e)try{if(this.ourIntent!==S.RECIPROCATE_LOGIN_ON_EXISTING_DEVICE)throw this.setState({phase:z.a0.Error,failureReason:k.Unknown}),new Error("New device flows around OIDC are not yet implemented");this.setState({phase:z.a0.Loading}),this.state.verificationUri&&window.open(this.state.verificationUri,"_blank"),this.setState({phase:z.a0.WaitingForDevice}),await this.state.rendezvous.shareSecrets(),this.onFinished(!0)}catch(e){c.v.error("Error whilst approving sign in",e),this.setState({phase:z.a0.Error,failureReason:e instanceof b?e.code:k.Unknown})}else this.setState({failureReason:me.CheckCodeMismatch})})),(0,n.A)(this,"onFailure",(e=>{this.state.phase!==z.a0.Error&&(c.v.info(`Rendezvous failed: ${e}`),this.setState({phase:z.a0.Error,failureReason:e}))})),(0,n.A)(this,"onClick",(async(e,t)=>{var i;switch(e){case z.HY.Cancel:var n,s;if(this.state.rendezvous instanceof v)await(null===(n=this.state.rendezvous)||void 0===n?void 0:n.cancel(C.UserCancelled));else await(null===(s=this.state.rendezvous)||void 0===s?void 0:s.cancel(x.UserCancelled));this.reset(),this.onFinished(!1);break;case z.HY.Approve:await(this.props.legacy?this.legacyApproveLogin():this.approveLogin(t));break;case z.HY.Decline:await(null===(i=this.state.rendezvous)||void 0===i?void 0:i.declineLoginOnExistingDevice()),this.reset(),this.onFinished(!1);break;case z.HY.Back:var r,o;if(this.state.rendezvous instanceof v)await(null===(r=this.state.rendezvous)||void 0===r?void 0:r.cancel(C.UserCancelled));else await(null===(o=this.state.rendezvous)||void 0===o?void 0:o.cancel(x.UserCancelled));this.onFinished(!1);break;case z.HY.ShowQr:await this.updateMode(z.Kt.Show)}})),this.state={phase:z.a0.Loading}}get ourIntent(){return S.RECIPROCATE_LOGIN_ON_EXISTING_DEVICE}componentDidMount(){this.updateMode(this.props.mode).then((()=>{}))}componentDidUpdate(e){e.mode!==this.props.mode&&this.updateMode(this.props.mode).then((()=>{}))}async updateMode(e){if(this.setState({phase:z.a0.Loading}),this.state.rendezvous){const e=this.state.rendezvous;e.onFailure=void 0,e instanceof v&&await e.cancel(C.UserCancelled),this.setState({rendezvous:void 0})}e===z.Kt.Show&&await this.generateAndShowCode()}componentWillUnmount(){this.state.rendezvous&&!this.finished&&(this.state.rendezvous.onFailure=void 0,this.state.rendezvous instanceof v?this.state.rendezvous.cancel(C.UserCancelled):this.state.rendezvous.cancel(x.UserCancelled))}async legacyApproveLogin(){if(!(this.state.rendezvous instanceof v))throw new Error("Rendezvous not found");if(!this.props.client)throw new Error("No client to approve login with");this.setState({phase:z.a0.Loading});try{c.v.info("Requesting login token");const{login_token:i}=await(e=this.props.client.requestLoginToken,t={matrixClient:this.props.client,title:(0,ie._t)("auth|qr_code_login|sign_in_new_device")},async function(...i){return new Promise(((n,s)=>{const r=e.bind(t.matrixClient);r(void 0,...i).then((e=>n(e))).catch((e=>{var o;if(401!==e.httpStatus||null===(o=e.data)||void 0===o||!o.flows)return s(e);pe.Ay.createDialog(ve.A,_e(_e({},t),{},{authData:e.data,makeRequest:e=>r(e,...i),onFinished:(e,t)=>{e?n(t):s(t)}}))}))}))})();this.setState({phase:z.a0.WaitingForDevice});if(!await this.state.rendezvous.approveLoginOnExistingDevice(i))return;if(!this.props.client.getCrypto())return void this.onFinished(!0);this.setState({phase:z.a0.Verifying}),await this.state.rendezvous.verifyNewDeviceOnExistingDevice();try{await this.state.rendezvous.close()}finally{this.setState({rendezvous:void 0})}this.onFinished(!0)}catch(e){if(c.v.error("Error whilst approving sign in",e),e instanceof R.HTTPError&&429===e.httpStatus)return void this.setState({phase:z.a0.Error,failureReason:me.RateLimited});this.setState({phase:z.a0.Error,failureReason:k.Unknown})}var e,t}onFinished(e){this.finished=!0,this.props.onFinished(e)}reset(){this.setState({rendezvous:void 0,confirmationDigits:void 0,verificationUri:void 0,failureReason:void 0,userCode:void 0,checkCode:void 0,lastScannedCode:void 0,mediaPermissionError:!1})}render(){var e,t;return this.state.rendezvous instanceof v?s.createElement(ue,{onClick:this.onClick,phase:this.state.phase,code:this.state.phase===z.a0.ShowingQR?null===(t=this.state.rendezvous)||void 0===t?void 0:t.code:void 0,confirmationDigits:this.state.phase===z.a0.LegacyConnected?this.state.confirmationDigits:void 0,failureReason:this.state.failureReason}):s.createElement(ue,{onClick:this.onClick,phase:this.state.phase,code:this.state.phase===z.a0.ShowingQR?null===(e=this.state.rendezvous)||void 0===e?void 0:e.code:void 0,failureReason:this.state.failureReason,userCode:this.state.userCode,checkCode:this.state.checkCode})}}}}]);
//# sourceMappingURL=8304.js.map