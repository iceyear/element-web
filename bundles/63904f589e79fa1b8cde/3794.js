"use strict";(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[3794,8823],{"./src/components/views/location/LocationButton.tsx":(e,t,o)=>{o.r(t),o.d(t,{LocationButton:()=>B,default:()=>I});var n=o("./node_modules/react/index.js"),s=o("./node_modules/classnames/index.js"),a=o.n(s),i=o("./src/languageHandler.tsx"),r=o("./src/components/views/rooms/CollapsibleButton.tsx"),l=o("./src/components/structures/ContextMenu.tsx"),c=o("./src/components/views/rooms/MessageComposerButtons.tsx"),m=o("./node_modules/@babel/runtime/helpers/esm/extends.js"),d=o("./src/contexts/MatrixClientContext.tsx"),u=o("./src/components/views/location/LocationPicker.tsx"),p=o("./src/components/views/location/shareLocation.ts"),h=o("./src/settings/SettingsStore.ts"),_=o("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/close.js"),v=o("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/chevron-left.js"),g=o("./src/components/views/elements/AccessibleButton.tsx");const x=({onBack:e,onCancel:t,displayBack:o})=>n.createElement("div",{className:"mx_ShareDialogButtons"},o&&n.createElement(g.A,{className:"mx_ShareDialogButtons_button left","aria-label":(0,i._t)("action|back"),onClick:e,element:"button"},n.createElement(v.A,{className:"mx_ShareDialogButtons_button-icon"})),n.createElement(g.A,{className:"mx_ShareDialogButtons_button right","aria-label":(0,i._t)("action|close"),onClick:t,element:"button"},n.createElement(_.A,{className:"mx_ShareDialogButtons_button-icon"})));var L=o("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),b=o("./src/stores/OwnProfileStore.ts"),k=o("./src/components/views/avatars/BaseAvatar.tsx"),y=o("./src/components/views/typography/Heading.tsx"),E=o("./res/img/element-icons/location.svg"),C=o("./src/components/views/beacon/StyledLiveBeaconIcon.tsx");const w=["onClick","label","shareType"],S=()=>{var e,t;const o=(0,n.useContext)(d.Ay).getSafeUserId(),s=null!==(e=b.V.instance.displayName)&&void 0!==e?e:void 0,a="36px",i=null!==(t=b.V.instance.getHttpAvatarUrl(parseInt(a,10)))&&void 0!==t?t:void 0;return n.createElement("div",{className:`mx_ShareType_option-icon ${p.L$.Own}`},n.createElement(k.A,{idName:o,name:s,url:i,size:a,className:"mx_UserMenu_userAvatar_BaseAvatar"}))},A=e=>{let{onClick:t,label:o,shareType:s}=e,a=(0,L.A)(e,w);return n.createElement(g.A,(0,m.A)({element:"button",className:"mx_ShareType_option",onClick:null!=t?t:null},a),s===p.L$.Own&&n.createElement(S,null),s===p.L$.Pin&&n.createElement(E.I,{className:`mx_ShareType_option-icon ${p.L$.Pin}`}),s===p.L$.Live&&n.createElement(C.A,{className:`mx_ShareType_option-icon ${p.L$.Live}`}),o)},f=({setShareType:e,enabledShareTypes:t})=>{const o={[p.L$.Own]:(0,i._t)("location_sharing|share_type_own"),[p.L$.Live]:(0,i._t)("location_sharing|share_type_live"),[p.L$.Pin]:(0,i._t)("location_sharing|share_type_pin")};return n.createElement("div",{className:"mx_ShareType"},n.createElement(E.I,{className:"mx_ShareType_badge"}),n.createElement(y.A,{className:"mx_ShareType_heading",size:"3"},(0,i._t)("location_sharing|share_type_prompt")),n.createElement("div",{className:"mx_ShareType_wrapper_options"},t.map((t=>n.createElement(A,{key:t,onClick:()=>e(t),label:o[t],shareType:t})))))};var M=o("./src/components/views/elements/LabelledToggleSwitch.tsx");const N=({onSubmit:e})=>{const[t,o]=(0,n.useState)(!1);return n.createElement("div",{className:"mx_EnableLiveShare"},n.createElement(C.A,{className:"mx_EnableLiveShare_icon"}),n.createElement(y.A,{className:"mx_EnableLiveShare_heading",size:"3"},(0,i._t)("location_sharing|live_enable_heading")),n.createElement("p",{className:"mx_EnableLiveShare_description"},(0,i._t)("location_sharing|live_enable_description")),n.createElement(M.A,{value:t,onChange:o,label:(0,i._t)("location_sharing|live_toggle_label")}),n.createElement(g.A,{className:"mx_EnableLiveShare_button",element:"button",kind:"primary",onClick:e,disabled:!t},(0,i._t)("action|ok")))};var T=o("./src/hooks/useSettings.ts"),P=o("./src/settings/SettingLevel.ts");const $=({menuPosition:e,onFinished:t,sender:o,roomId:s,openMenu:a,relation:i})=>{const r=(0,n.useContext)(d.Ay),c=(e=>{const t=[p.L$.Own];return e||t.push(p.L$.Live),t.push(p.L$.Pin),t})(i),_=(0,T.ny)("feature_location_share_live"),v=c.length>1,[g,L]=(0,n.useState)(v?void 0:p.L$.Own),k=b.V.instance.displayName,y=r.getSafeUserId(),E=g===p.L$.Live?(0,p.tS)(r,s,k||y,a):(0,p.$e)(r,s,null!=g?g:p.L$.Own,i,a),C=g===p.L$.Live&&!_;return n.createElement(l.Ay,(0,m.A)({},e,{onFinished:t,managed:!1}),n.createElement("div",{className:"mx_LocationShareMenu"},C&&n.createElement(N,{onSubmit:()=>{h.A.setValue("feature_location_share_live",null,P.p.DEVICE,!0)}}),!C&&!!g&&n.createElement(u.default,{sender:o,shareType:g,onChoose:E,onFinished:t}),!g&&n.createElement(f,{setShareType:L,enabledShareTypes:c}),n.createElement(x,{displayBack:!!g&&v,onBack:()=>L(void 0),onCancel:t})))},B=({roomId:e,sender:t,menuPosition:o,relation:s})=>{const m=(0,n.useContext)(c.ZF),[d,u,p,h]=(0,l.EF)(),_=e=>{h(e),null==m||m()};let v=null;if(d){var g;const a=null!==(g=null!=o?o:u.current&&(0,l.qv)(u.current.getBoundingClientRect()))&&void 0!==g?g:{};v=n.createElement($,{menuPosition:a,onFinished:_,sender:t,roomId:e,openMenu:p,relation:s})}const x=a()("mx_MessageComposer_button",{mx_MessageComposer_button_highlight:d});return n.createElement(n.Fragment,null,n.createElement(r.J,{className:x,iconClassName:"mx_MessageComposer_location",onClick:p,title:(0,i._t)("common|location"),inputRef:u}),v)},I=B},"./src/components/views/location/LocationPicker.tsx":(e,t,o)=>{o.r(t),o.d(t,{default:()=>f});var n=o("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=o("./node_modules/react/index.js"),a=o("./node_modules/maplibre-gl/dist/maplibre-gl.js"),i=o.n(a),r=o("./node_modules/matrix-js-sdk/src/logger.ts"),l=o("./node_modules/matrix-js-sdk/src/matrix.ts"),c=o("./src/languageHandler.tsx"),m=o("./src/contexts/MatrixClientContext.tsx"),d=o("./src/Modal.tsx"),u=o("./src/utils/WellKnownUtils.ts"),p=o("./src/utils/beacon/index.ts"),h=o("./src/utils/location/index.ts"),_=o("./src/components/views/dialogs/ErrorDialog.tsx"),v=o("./src/components/views/elements/AccessibleButton.tsx"),g=o("./src/components/views/location/MapError.tsx"),x=o("./src/DateUtils.ts"),L=o("./src/components/views/elements/Dropdown.tsx");const b={fifteenMins:9e5,oneHour:36e5,eightHours:288e5},k=b.fifteenMins,y=e=>(0,c._t)("location_sharing|live_share_button",{duration:(0,x.a3)(e)}),E=({timeout:e,onChange:t})=>{const o=Object.values(b).map((e=>({key:e.toString(),duration:e,label:y(e)})));Object.values(b).includes(e)||o.push({key:e.toString(),duration:e,label:y(e)});return s.createElement(L.A,{id:"live-duration",label:y(e),value:e.toString(),onOptionChange:e=>{t(+e)},className:"mx_LiveDurationDropdown"},o.map((({key:e,label:t})=>s.createElement("div",{key:e},t))))};var C=o("./src/components/views/location/shareLocation.ts"),w=o("./src/components/views/location/Marker.tsx");const S=e=>e===C.L$.Own||e===C.L$.Live;class A extends s.Component{constructor(e,t){super(e,t),(0,n.A)(this,"map",void 0),(0,n.A)(this,"geolocate",void 0),(0,n.A)(this,"marker",void 0),(0,n.A)(this,"getMarkerId",(()=>"mx_MLocationPicker_marker")),(0,n.A)(this,"addMarkerToMap",(()=>{var e;this.marker=new(i().Marker)({element:null!==(e=document.getElementById(this.getMarkerId()))&&void 0!==e?e:void 0,anchor:"bottom",offset:[0,-1]}).setLngLat(new(i().LngLat)(0,0)).addTo(this.map)})),(0,n.A)(this,"updateStyleUrl",(e=>{var t;const o=null===(t=(0,u.XP)(e))||void 0===t?void 0:t.map_style_url;var n;o&&(null===(n=this.map)||void 0===n||n.setStyle(o))})),(0,n.A)(this,"onGeolocate",(e=>{var t;this.marker||this.addMarkerToMap(),this.setState({position:(0,p.v9)(e)}),null===(t=this.marker)||void 0===t||t.setLngLat(new(i().LngLat)(e.coords.longitude,e.coords.latitude))})),(0,n.A)(this,"onClick",(e=>{var t;this.marker||this.addMarkerToMap(),null===(t=this.marker)||void 0===t||t.setLngLat(e.lngLat),this.setState({position:{timestamp:Date.now(),latitude:e.lngLat.lat,longitude:e.lngLat.lng}})})),(0,n.A)(this,"onGeolocateError",(e=>{var t;(r.v.error("Could not fetch location",e),S(this.props.shareType)&&(this.props.onFinished(),d.Ay.createDialog(_.A,{title:(0,c._t)("location_sharing|error_fetch_location"),description:(0,h.Ff)(e.code)})),this.geolocate)&&(null===(t=this.map)||void 0===t||t.removeControl(this.geolocate))})),(0,n.A)(this,"onTimeoutChange",(e=>{this.setState({timeout:e})})),(0,n.A)(this,"onOk",(()=>{const{timeout:e,position:t}=this.state;this.props.onChoose(t?{uri:(0,p.mt)(t),timestamp:t.timestamp,timeout:e}:{timeout:e}),this.props.onFinished()})),this.state={position:void 0,timeout:k,error:void 0}}componentDidMount(){this.context.on(l.ClientEvent.ClientWellKnown,this.updateStyleUrl);try{if(this.map=new(i().Map)({container:"mx_LocationPicker_map",style:(0,h.M0)(this.context),center:[0,0],zoom:1}),this.geolocate=new(i().GeolocateControl)({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!1}),this.map.addControl(this.geolocate),this.map.on("error",(e=>{r.v.error("Failed to load map: check map_style_url in config.json has a valid URL and API key",e.error),this.setState({error:h.$X.MapStyleUrlNotReachable})})),this.map.on("load",(()=>{var e;null===(e=this.geolocate)||void 0===e||e.trigger()})),this.geolocate.on("error",this.onGeolocateError),S(this.props.shareType)&&this.geolocate.on("geolocate",this.onGeolocate),this.props.shareType===C.L$.Pin){const e=new(i().NavigationControl)({showCompass:!1,showZoom:!0});this.map.addControl(e,"bottom-right"),this.map.on("click",this.onClick)}}catch(e){r.v.error("Failed to render map",e);const t=null==e?void 0:e.message;let o;o=t===h.$X.MapStyleUrlNotConfigured?h.$X.MapStyleUrlNotConfigured:t.includes("Failed to initialize WebGL")?h.$X.WebGLNotEnabled:h.$X.Default,this.setState({error:o})}}componentWillUnmount(){var e,t,o;null===(e=this.geolocate)||void 0===e||e.off("error",this.onGeolocateError),null===(t=this.geolocate)||void 0===t||t.off("geolocate",this.onGeolocate),null===(o=this.map)||void 0===o||o.off("click",this.onClick),this.context.off(l.ClientEvent.ClientWellKnown,this.updateStyleUrl)}render(){return this.state.error?s.createElement("div",{className:"mx_LocationPicker mx_LocationPicker_hasError"},s.createElement(g.p,{error:this.state.error,onFinished:this.props.onFinished})):s.createElement("div",{className:"mx_LocationPicker"},s.createElement("div",{id:"mx_LocationPicker_map"}),this.props.shareType===C.L$.Pin&&s.createElement("div",{className:"mx_LocationPicker_pinText"},s.createElement("span",null,this.state.position?(0,c._t)("location_sharing|click_move_pin"):(0,c._t)("location_sharing|click_drop_pin"))),s.createElement("div",{className:"mx_LocationPicker_footer"},s.createElement("form",{onSubmit:this.onOk},this.props.shareType===C.L$.Live&&s.createElement(E,{onChange:this.onTimeoutChange,timeout:this.state.timeout}),s.createElement(v.A,{type:"submit",element:"button",kind:"primary",className:"mx_LocationPicker_submitButton",disabled:!this.state.position,onClick:this.onOk},(0,c._t)("location_sharing|share_button")))),s.createElement("div",{id:this.getMarkerId()},!!this.marker&&s.createElement(w.A,{roomMember:S(this.props.shareType)?this.props.sender:void 0,useMemberColor:this.props.shareType===C.L$.Live})))}}(0,n.A)(A,"contextType",m.Ay);const f=A},"./src/components/views/location/Marker.tsx":(e,t,o)=>{o.d(t,{A:()=>m});var n=o("./node_modules/react/index.js"),s=o("./node_modules/classnames/index.js"),a=o.n(s),i=o("./res/img/element-icons/location.svg"),r=o("./src/utils/FormattingUtils.ts"),l=o("./src/components/views/avatars/MemberAvatar.tsx");const c=({tooltip:e,children:t})=>{const[o,s]=(0,n.useState)(!1);if(!e)return n.createElement(n.Fragment,null,t);return n.createElement("div",{onMouseEnter:()=>s(!0),onClick:e=>{e.stopPropagation(),s(!o)},onMouseLeave:()=>s(!1)},t,o&&e)},m=n.forwardRef((({id:e,roomMember:t,useMemberColor:o,tooltip:s},m)=>{const d=o&&t?(0,r.yJ)(t.userId):"";return n.createElement("div",{ref:m,id:e,className:a()("mx_Marker",d,{mx_Marker_defaultColor:!d})},n.createElement(c,{tooltip:s},n.createElement("div",{className:"mx_Marker_border"},t?n.createElement(l.A,{member:t,size:"36px",viewUserOnClick:!1,hideTitle:!!s}):n.createElement(i.I,{className:"mx_Marker_icon"}))))}))},"./src/components/views/location/shareLocation.ts":(e,t,o)=>{o.d(t,{$e:()=>h,L$:()=>d,tS:()=>p});var n=o("./node_modules/matrix-js-sdk/src/matrix.ts"),s=o("./node_modules/matrix-js-sdk/src/logger.ts"),a=o("./src/languageHandler.tsx"),i=o("./src/Modal.tsx"),r=o("./src/components/views/dialogs/QuestionDialog.tsx"),l=o("./src/SdkConfig.ts"),c=o("./src/stores/OwnBeaconStore.ts"),m=o("./src/utils/local-room.ts");let d=function(e){return e.Own="Own",e.Pin="Pin",e.Live="Live",e}({});const u=(e,t,o)=>{const{modalParams:n,errorMessage:c}="M_FORBIDDEN"===e.errcode?(e=>{const t=e===d.Live?"Insufficient permissions to start sharing your live location":"Insufficient permissions to send your location";return{modalParams:{title:(0,a._t)("location_sharing|error_no_perms_title"),description:(0,a._t)("location_sharing|error_no_perms_description"),button:(0,a._t)("action|ok"),hasCancelButton:!1,onFinished:()=>{}},errorMessage:t}})(o):((e,t)=>{const o=e===d.Live?"We couldn't start sharing your live location":"We couldn't send your location";return{modalParams:{title:(0,a._t)("location_sharing|error_send_title"),description:(0,a._t)("location_sharing|error_send_description",{brand:l.Ay.get().brand}),button:(0,a._t)("action|try_again"),cancelButton:(0,a._t)("action|cancel"),onFinished:e=>{e&&t()}},errorMessage:o}})(o,t);s.v.error(c,e),i.Ay.createDialog(r.A,n)},p=(e,t,o,s)=>async({timeout:e})=>{const i=(0,a._t)("location_sharing|live_description",{displayName:o});try{await c.g.instance.createLiveBeacon(t,n.ContentHelpers.makeBeaconInfoContent(null!=e?e:3e5,!0,i,n.LocationAssetType.Self))}catch(e){u(e,s,d.Live)}},h=(e,t,o,s,a)=>async({uri:i,timestamp:r})=>{if(i)try{const a=(null==s?void 0:s.rel_type)===n.THREAD_RELATION_TYPE.name&&(null==s?void 0:s.event_id)||null,l=o===d.Pin?n.LocationAssetType.Pin:n.LocationAssetType.Self,c=n.ContentHelpers.makeLocationContent(void 0,i,r,void 0,l);await(0,m.Y)(t,(t=>e.sendMessage(t,a,c)),e)}catch(e){u(e,a,o)}}}}]);
//# sourceMappingURL=3794.js.map